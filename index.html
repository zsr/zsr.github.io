<!doctype html><html class="theme-next pisces use-motion"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css"><meta name="keywords" content="Hexo, NexT"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1"><meta name="description" content="Develop Notes"><meta property="og:type" content="website"><meta property="og:title" content="Hello Coder"><meta property="og:url" content="http://zsr.github.io/index.html"><meta property="og:site_name" content="Hello Coder"><meta property="og:description" content="Develop Notes"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Hello Coder"><meta name="twitter:description" content="Develop Notes"><script type="text/javascript" id="hexo.configuration">var NexT=window.NexT||{},CONFIG={scheme:"Pisces",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:0,author:"åšä¸»"}}</script><link rel="canonical" href="http://zsr.github.io/"><title> Hello Coder</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-81477846-1","auto"),ga("send","pageview")</script><div class="container one-collumn sidebar-position-left page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Hello Coder</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> é¦–é¡µ</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> å½’æ¡£</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> æ ‡ç­¾</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> æœç´¢</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div> <span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2019/03/22/çº¿ä¸Šé¢‘ç¹Full-GCåˆ†æ/" itemprop="url">çº¿ä¸Šé¢‘ç¹Full GCåˆ†æ</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time itemprop="dateCreated" datetime="2019-03-22T14:48:02+08:00" content="2019-03-22">2019-03-22</time></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>åŒäº‹çš„é¡¹ç›®<code>voice-analyzer-web</code>çº¿ä¸Šç¯å¢ƒï¼Œç›‘æ§ç³»ç»Ÿé¢‘ç¹æŠ¥è­¦<strong>å‘ç”ŸJVMFullGCå¡é¡¿æ¬¡æ•°é¢‘ç¹</strong>(4å°æœåŠ¡å™¨éƒ½æŠ¥è­¦)ï¼Œç›‘æ§æ¯10åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡ï¼Œè¯¥æ—¶é—´æ®µå†…<code>Full GC</code>è¶…è¿‡10æ¬¡å°±ä¼šæŠ¥è­¦ã€‚</p><h3 id="çº¿ä¸ŠJVMå‚æ•°-æœ‰çœç•¥"><a href="#çº¿ä¸ŠJVMå‚æ•°-æœ‰çœç•¥" class="headerlink" title="çº¿ä¸ŠJVMå‚æ•°(æœ‰çœç•¥)"></a>çº¿ä¸ŠJVMå‚æ•°(æœ‰çœç•¥)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">XX:MaxMetaspaceSize=256M, -Xms4g, -Xmx4g, -Xmn1g, -Xss256k, -XX:SurvivorRatio=8, -XX:MaxTenuringThreshold=8, -XX:ParallelGCThreads=8, -XX:+UseConcMarkSweepGC, -XX:+UseParNewGC, -XX:+DisableExplicitGC, -XX:+CMSParallelRemarkEnabled, -XX:+CMSClassUnloadingEnabled, -XX:CMSInitiatingOccupancyFraction=70, -XX:CMSFullGCsBeforeCompaction=5, -XX:+UseCMSCompactAtFullCollection, -XX:+CMSScavengeBeforeRemark, -XX:+HeapDumpOnOutOfMemoryError, -Xloggc:/usr/local/webserver/voice-analyzer-web/logs/gc.log, -XX:+UseGCLogFileRotation, -XX:NumberOfGCLogFiles=10, -XX:GCLogFileSize=10M, -XX:+PrintGCDetails, -XX:+PrintGCDateStamps, -XX:+PrintGCApplicationStoppedTime, -XX:+PrintGCApplicationConcurrentTime, -, -XX:HeapDumpPath=/usr/local/webserver/voice-analyzer-web/logs/voice-analyzer-web.hprof</div></pre></td></tr></table></figure><p>åˆ†é…äº†4GBå †å†…å­˜ï¼Œå¹´è½»ä»£1GBï¼Œè€å¹´ä»£3GBï¼Œ<code>eden</code>åŒº800Mï¼Œæ¯ä¸ª<code>Survivor</code>åŒº100Mï¼Œè€å¹´ä»£å ç”¨ç‡è¾¾åˆ°70%(2.1Gå·¦å³)æ‰§è¡Œ<code>CMS GC</code></p><h3 id="æ—¥å¿—åˆ†æ"><a href="#æ—¥å¿—åˆ†æ" class="headerlink" title="æ—¥å¿—åˆ†æ"></a>æ—¥å¿—åˆ†æ</h3><h4 id="åˆæ­¥åˆ†ægc-log"><a href="#åˆæ­¥åˆ†ægc-log" class="headerlink" title="åˆæ­¥åˆ†ægc.log"></a>åˆæ­¥åˆ†æ<code>gc.log</code></h4><p>æ‰¾ä¸€å°çº¿ä¸Šæœºå™¨ä¸‹è½½<code>gc.log</code>(5Må¤§å°)åˆ°æœ¬åœ°ï¼Œæ¨èåœ¨çº¿å›¾åƒåŒ–åˆ†æ<code>gc</code>åœ°å€<a href="[https://www.gceasy.io](https://www.gceasy.io/">geceasy</a>)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">2019-03-21T11:19:41.609+0800: 1086345.976: [GC (Allocation Failure) 2019-03-21T11:19:41.609+0800: 1086345.976: [ParNew: 873168K-&gt;36622K(943744K), 0.0312849 secs] 3074543K-&gt;2238776K(4089472K), 0.0316707 secs] [Times: user=0.14 sys=0.00, real=0.04 secs] </div><div class="line">2019-03-21T11:19:41.641+0800: 1086346.008: Total time for which application threads were stopped: 0.0339016 seconds, Stopping threads took: 0.0002451 seconds</div><div class="line">2019-03-21T11:19:41.641+0800: 1086346.008: Application time: 0.0000710 seconds</div><div class="line">2019-03-21T11:19:41.643+0800: 1086346.010: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2202154K(3145728K)] 2238847K(4089472K), 0.0057407 secs] [Times: user=0.02 sys=0.00, real=0.00 secs] </div><div class="line">2019-03-21T11:19:41.649+0800: 1086346.015: Total time for which application threads were stopped: 0.0076999 seconds, Stopping threads took: 0.0002899 seconds</div><div class="line">2019-03-21T11:19:41.649+0800: 1086346.016: [CMS-concurrent-mark-start]</div><div class="line">2019-03-21T11:19:41.915+0800: 1086346.282: [CMS-concurrent-mark: 0.266/0.266 secs] [Times: user=0.64 sys=0.01, real=0.27 secs] </div><div class="line">2019-03-21T11:19:41.915+0800: 1086346.282: [CMS-concurrent-preclean-start]</div><div class="line">2019-03-21T11:19:41.968+0800: 1086346.335: [CMS-concurrent-preclean: 0.049/0.053 secs] [Times: user=0.06 sys=0.00, real=0.05 secs] </div><div class="line">2019-03-21T11:19:41.968+0800: 1086346.335: [CMS-concurrent-abortable-preclean-start]</div><div class="line">2019-03-21T11:19:45.263+0800: 1086349.630: Application time: 3.6144054 seconds</div><div class="line">2019-03-21T11:19:45.268+0800: 1086349.635: Total time for which application threads were stopped: 0.0049627 seconds, Stopping threads took: 0.0002311 seconds</div><div class="line">2019-03-21T11:19:45.268+0800: 1086349.635: Application time: 0.0000508 seconds</div><div class="line">2019-03-21T11:19:45.269+0800: 1086349.636: Total time for which application threads were stopped: 0.0010917 seconds, Stopping threads took: 0.0001300 seconds</div><div class="line"> CMS: abort preclean due to time 2019-03-21T11:19:47.067+0800: 1086351.434: [CMS-concurrent-abortable-preclean: 4.876/5.099 secs] [Times: user=6.58 sys=0.02, real=5.10 secs] </div><div class="line">2019-03-21T11:19:47.067+0800: 1086351.434: Application time: 1.7978130 seconds</div><div class="line">2019-03-21T11:19:47.069+0800: 1086351.436: [GC (CMS Final Remark) [YG occupancy: 51879 K (943744 K)]2019-03-21T11:19:47.069+0800: 1086351.436: [GC (CMS Final Remark) 2019-03-21T11:19:47.069+0800: 1086351.436: [ParNew: 51879K-&gt;23393K(943744K), 0.0156467 secs] 2254034K-&gt;2226423K(4089472K), 0.0159200 secs] [Times: user=0.12 sys=0.00, real=0.02 secs] </div><div class="line">2019-03-21T11:19:47.085+0800: 1086351.452: [Rescan (parallel) , 0.0106023 secs]2019-03-21T11:19:47.096+0800: 1086351.462: [weak refs processing, 0.0000353 secs]2019-03-21T11:19:47.096+0800: 1086351.462: [class unloading, 0.0421021 secs]2019-03-21T11:19:47.138+0800: 1086351.505: [scrub symbol table, 0.0157111 secs]2019-03-21T11:19:47.153+0800: 1086351.520: [scrub string table, 0.0014866 secs][1 CMS-remark: 2203030K(3145728K)] 2226423K(4089472K), 0.0887818 secs] [Times: user=0.26 sys=0.01, real=0.09 secs] </div><div class="line">2019-03-21T11:19:47.158+0800: 1086351.525: Total time for which application threads were stopped: 0.0908702 seconds, Stopping threads took: 0.0002256 seconds</div><div class="line">2019-03-21T11:19:47.158+0800: 1086351.525: [CMS-concurrent-sweep-start]</div><div class="line">2019-03-21T11:19:47.350+0800: 1086351.717: [CMS-concurrent-sweep: 0.192/0.192 secs] [Times: user=0.31 sys=0.00, real=0.20 secs] </div><div class="line">2019-03-21T11:19:47.351+0800: 1086351.717: [CMS-concurrent-reset-start]</div><div class="line">2019-03-21T11:19:47.356+0800: 1086351.723: [CMS-concurrent-reset: 0.005/0.005 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] </div><div class="line">2019-03-21T11:19:48.158+0800: 1086352.525: Application time: 1.0000965 seconds</div><div class="line">2019-03-21T11:19:48.160+0800: 1086352.527: Total time for which application threads were stopped: 0.0019235 seconds, Stopping threads took: 0.0002317 seconds</div><div class="line">2019-03-21T11:19:49.356+0800: 1086353.723: Application time: 1.1961818 seconds</div><div class="line">2019-03-21T11:19:49.358+0800: 1086353.725: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2202654K(3145728K)] 2234684K(4089472K), 0.0023390 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] </div><div class="line">2019-03-21T11:19:49.360+0800: 1086353.727: Total time for which application threads were stopped: 0.0043086 seconds, Stopping threads took: 0.0002062 seconds</div><div class="line">2019-03-21T11:19:49.360+0800: 1086353.727: [CMS-concurrent-mark-start]</div><div class="line">2019-03-21T11:19:49.623+0800: 1086353.990: [CMS-concurrent-mark: 0.262/0.262 secs] [Times: user=0.55 sys=0.00, real=0.27 secs] </div><div class="line">2019-03-21T11:19:49.623+0800: 1086353.990: [CMS-concurrent-preclean-start]</div><div class="line">2019-03-21T11:19:49.689+0800: 1086354.056: [CMS-concurrent-preclean: 0.062/0.066 secs] [Times: user=0.10 sys=0.00, real=0.06 secs]</div></pre></td></tr></table></figure><p>è§‚å¯Ÿé¢‘ç¹<code>CMS GC</code>ç›¸é‚»é—´éš”æ—¶é—´8ç§’å·¦å³ï¼Œæ£€æŸ¥<code>CMS GC</code>å›æ”¶å‰åè€å¹´ä»£å†…å­˜ä½¿ç”¨æƒ…å†µï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2019-03-21T11:19:41.643+0800: 1086346.010: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2202154K(3145728K)] 2238847K(4089472K), 0.0057407 secs] [Times: user=0.02 sys=0.00, real=0.00 secs] </div><div class="line">2019-03-21T11:19:49.358+0800: 1086353.725: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2202654K(3145728K)] 2234684K(4089472K), 0.0023390 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]</div></pre></td></tr></table></figure><p>è€å¹´ä»£å®¹é‡ä¸º3145728Kï¼Œç¬¬ä¸€æ¬¡åœ¨ä½¿ç”¨äº†2202154Kæ—¶è§¦å‘äº†<code>CMS GC</code>åˆå§‹æ ‡è®°æ“ä½œï¼Œç¬¬äºŒæ¬¡åœ¨ä½¿ç”¨äº†2202654Kåè§¦å‘<code>CMS GC</code>åˆå§‹æ ‡è®°æ“ä½œï¼›2æ¬¡<code>CMS GC</code>ä¹‹é—´è€å¹´ä»£åè€Œå¢åŠ äº†0.5Må¤§å°ï¼Œåˆæ­¥æ€€ç–‘æ–¹å‘ï¼š</p><ul><li><code>CMSInitiatingOccupancyFraction</code>æ¯”ä¾‹å¤§å°ï¼Œå¯¼è‡´é¢‘ç¹è§¦å‘</li><li>è¯¥æ®µæ—¶é—´æœ‰å¤§é‡å†…å­˜è½¬ç§»åˆ°è€å¹´ä»£</li><li>å †å†…å­˜æ³„æ¼</li></ul><p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1g1ea5brnq0j317o0ke411.jpg" alt=""></p><p>è¿™å¼ å›¾æ¯”è¾ƒç›´è§‚å±•ç¤ºè€å¹´ä»£å†…å­˜ä¸€ç›´ç»´æŒåœ¨2.1Gå·¦å³ï¼Œ<code>GC</code>å‰åå¹¶æ²¡æœ‰é™ä½è€å¹´ä»£å¤§å°ï¼Œè€Œä¸”è¿™æ®µæ—¶é—´å¹¶æ²¡æœ‰å¤§é‡å¹¶å‘è¯·æ±‚ï¼Œæ€€ç–‘å †å†…å­˜æ³„æ¼ã€‚</p><h4 id="åˆ†æheap-dump"><a href="#åˆ†æheap-dump" class="headerlink" title="åˆ†æheap dump"></a>åˆ†æ<code>heap dump</code></h4><p>é€‰æ‹©ä¸€å°æœåŠ¡å™¨ï¼Œè”ç³»è¿ç»´<code>dump heap</code>(2.4G)ï¼Œé‡å¯å…¨éƒ¨æœåŠ¡å™¨(å†…å­˜ç›´çº¿æ‰ä¸‹æ¥ï¼Œè€å¹´ä»£200Mã€‚ã€‚ã€‚)</p><p>ä½¿ç”¨å·¥å…·<code>VisualVm</code>æˆ–è€…<code>Eclipse MAT</code>åˆ†æ<code>dump</code>æ—¥å¿—</p><h4 id="ä½¿ç”¨VisualVM"><a href="#ä½¿ç”¨VisualVM" class="headerlink" title="ä½¿ç”¨VisualVM"></a>ä½¿ç”¨<code>VisualVM</code></h4><ul><li>æ£€æŸ¥å †å†…å­˜å¤§å¯¹è±¡ï¼š</li></ul><p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1g1f0vdxwdqj31jc0hwwka.jpg" alt=""></p><p>å¯è§å…±æœ‰377094ä¸ª<code>double[]</code>æ•°ç»„å æœ‰å†…å­˜2Gå·¦å³ï¼Œ<code>retained size</code>æ˜¯è¯¥å¯¹è±¡è¢«GCä¹‹åæ‰€èƒ½å›æ”¶åˆ°å†…å­˜çš„æ€»å’Œï¼›æ€€ç–‘<code>double[]</code>å¯¹è±¡æ³„æ¼ï¼Œæ²¡æœ‰è¢«å›æ”¶</p><ul><li>æŸ¥çœ‹è¯¥å¯¹è±¡çš„<code>GC Root</code>ï¼š</li></ul><p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1g1f1ip6yf2j31gh0u0n4r.jpg" alt=""></p><p>ä¸Šå›¾å¯ä»¥çœ‹å‡ºè¯¥<code>double[]</code>è¢«<code>DataBuffer</code>ç›´æ¥å¼•ç”¨ï¼Œæœ€åè¢«ç¼“å­˜åœ¨<code>Guava LocalCache</code>ä¸­ï¼›ä»<code>GC Root</code>å¯ä»¥çœ‹å‡ºï¼Œæœ‰<code>ScheudleTask</code>(<code>DataPublisher</code>ä¸­åˆ›å»º)å¼•ç”¨äº†è¯¥å¯¹è±¡</p><h3 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h3><ul><li>è¿›å…¥<code>DataPublisher</code>ç±»ä¸­ï¼Œæ£€æŸ¥<code>ScheudleTask</code>åˆ›å»ºè¿‡ç¨‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (future == <span class="keyword">null</span>) &#123;</div><div class="line">           Runnable task = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                                   <span class="keyword">try</span> &#123;</div><div class="line">                                     <span class="comment">// ä¸»è¦åšè®¡ç®—ç»Ÿè®¡æ•°æ®</span></div><div class="line">                                      accumulator.publish();</div><div class="line">                                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                                       handleException(e);</div><div class="line">                                   &#125;</div><div class="line">                               &#125;</div><div class="line">                           &#125;;</div><div class="line">           <span class="comment">// ä»ä¸Šä¸‹æ–‡çœ‹ï¼Œå»¶è¿Ÿ1ç§’å®šæœŸæ‰§è¡Œä¸€æ¬¡</span></div><div class="line">           future = getExecutor().scheduleWithFixedDelay(task,</div><div class="line">                                                         delayMillis, delayMillis,</div><div class="line">                                                         TimeUnit.MILLISECONDS);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> ScheduledExecutorService <span class="title">getExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (sharedExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">           sharedExecutor = Executors.newScheduledThreadPool(<span class="number">1</span>, <span class="keyword">new</span> PublishThreadFactory());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> sharedExecutor;</div><div class="line">   &#125;</div></pre></td></tr></table></figure><ul><li>é€†å‘æ£€æŸ¥<code>start()</code>è°ƒç”¨</li></ul><p>ç”±<code>ServerStats</code>ç±»<code>initialize</code>æ–¹æ³•è§¦å‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">       serverFailureCounts = <span class="keyword">new</span> MeasuredRate(failureCountSlidingWindowInterval);</div><div class="line">       requestCountInWindow = <span class="keyword">new</span> MeasuredRate(<span class="number">300000L</span>);</div><div class="line">       <span class="keyword">if</span> (publisher == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">// DataBufferå®é™…å­˜åœ¨äºDataDistributionä¸­ï¼ŒbufferSize=1000</span></div><div class="line">           dataDist = <span class="keyword">new</span> DataDistribution(getBufferSize(), PERCENTS);</div><div class="line">           <span class="comment">// DataPublisheré—´æ¥å¼•ç”¨äº†DataBuffer</span></div><div class="line">           publisher = <span class="keyword">new</span> DataPublisher(dataDist, getPublishIntervalMillis());</div><div class="line">           <span class="comment">// è§¦å‘è°ƒç”¨</span></div><div class="line">           publisher.start();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">this</span>.server = server;</div><div class="line">   &#125;</div></pre></td></tr></table></figure><ul><li>é€†å‘æ£€æŸ¥<code>initialize()</code>è°ƒç”¨</li></ul><p>è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1g1f27thkyjj30vm042jsn.jpg" alt=""></p><p>ç”±<code>LoadBalancerStats</code>ç±»<code>createServerStats</code>æ–¹æ³•è§¦å‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ServerStats <span class="title">createServerStats</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">        <span class="comment">// åˆ›å»ºServerStatså¹¶åˆå§‹åŒ–</span></div><div class="line">        ServerStats ss = <span class="keyword">new</span> ServerStats(<span class="keyword">this</span>);</div><div class="line">        ss.setBufferSize(<span class="number">1000</span>);</div><div class="line">        ss.setPublishInterval(<span class="number">1000</span>);                   </div><div class="line">        ss.initialize(server);</div><div class="line">        <span class="keyword">return</span> ss;        </div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> ServerStats <span class="title">getServerStats</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// ä»localcacheç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœæ²¡æœ‰</span></div><div class="line">            <span class="comment">// åˆ™è°ƒç”¨createServerStatsåˆ›å»ºServerStatså¹¶ç¼“å­˜</span></div><div class="line">            <span class="keyword">return</span> serverStatsCache.get(server);</div><div class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">            ServerStats stats = createServerStats(server);</div><div class="line">            serverStatsCache.asMap().putIfAbsent(server, stats);</div><div class="line">            <span class="keyword">return</span> serverStatsCache.asMap().get(server);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"> <span class="comment">// localcacheåœ¨è¿™é‡Œã€‚ã€‚ã€‚ï¼Œkeyæ˜¯Server, valueæ˜¯ServerStats</span></div><div class="line"> <span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;Server, ServerStats&gt; serverStatsCache = </div><div class="line">        CacheBuilder.newBuilder()</div><div class="line">            .expireAfterAccess(SERVERSTATS_EXPIRE_MINUTES.get(), TimeUnit.MINUTES)</div><div class="line">            .removalListener(<span class="keyword">new</span> RemovalListener&lt;Server, ServerStats&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;Server, ServerStats&gt; notification)</span> </span>&#123;</div><div class="line">                    notification.getValue().close();</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            .build(</div><div class="line">                <span class="keyword">new</span> CacheLoader&lt;Server, ServerStats&gt;() &#123;</div><div class="line">                    <span class="comment">// ç¼“å­˜æ²¡æœ‰åˆ™åˆ›å»ºServerStats</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> ServerStats <span class="title">load</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> createServerStats(server);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡º<code>bufferSize=1000</code>ï¼Œ<code>Heap dump</code>ä¸­æ¯ä¸ª<code>double[]</code>å…ƒç´ ä¹Ÿæ˜¯1000ï¼›è€Œä¸”ï¼Œå®šæ—¶ä»»åŠ¡æ—¶é—´é—´éš”ä¸º1ç§’</p><p><strong>ä»ç¼“å­˜<code>localcache</code>çš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœå…ƒç´ ä¸€ç›´å¢åŠ ï¼Œè¯´æ˜ä¸€ç›´æœ‰æ–°çš„<code>Server</code>è¢«åˆ›å»ºå¹¶æ·»åŠ åˆ°ç¼“å­˜ä¸­ï¼›ä½†æ˜¯æ®åŒäº‹äº†è§£æˆ‘ä»¬çš„<code>Server</code>åªæœ‰10æ¥ä¸ªï¼Œç¼“å­˜æ­£å¸¸ä¸ä¼šä¸€ç›´å¢é•¿ï¼›æ€€ç–‘æ˜¯å¦ä»£ç é—®é¢˜å¯¼è‡´ä¸åœåˆ›å»ºæ–°çš„<code>Server</code>?</strong></p><ul><li>æ£€æŸ¥<code>getServerStats</code>è°ƒç”¨å…³ç³»</li></ul><p>å…¥å£è°ƒç”¨ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">(<span class="keyword">final</span> String path, Map&lt;String, Object&gt; param, Integer uploadType)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> LoadBalancerCommand.&lt;String&gt; builder().withLoadBalancer(loadBalancer).build()</div><div class="line">          .submit(<span class="keyword">new</span> ServerOperation&lt;String&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;String&gt; <span class="title">call</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">              URL url;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                String s = HttpClientUtil.post(<span class="string">"http://"</span> + server.getHost() + <span class="string">":"</span> + server.getPort() + path, param);</div><div class="line">                <span class="keyword">return</span> Observable.just(s);</div><div class="line">              &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                logger.info(<span class="string">"python identify voice failed! host &#123;&#125;"</span>, server.getHost());</div><div class="line">                <span class="keyword">return</span> Observable.error(e);</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;).toBlocking().first();</div><div class="line">  &#125;</div></pre></td></tr></table></figure><p>é‡ç‚¹è§‚å¯Ÿ<code>LoadBalancerCommand.submit()</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> Observable&lt;T&gt; <span class="title">submit</span><span class="params">(<span class="keyword">final</span> ServerOperation&lt;T&gt; operation)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// Use the load balancer</span></div><div class="line">        Observable&lt;T&gt; o = </div><div class="line">                (server == <span class="keyword">null</span> ? selectServer() : Observable.just(server))</div><div class="line">                .concatMap(<span class="keyword">new</span> Func1&lt;Server, Observable&lt;T&gt;&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="comment">// Called for each server being selected</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> Observable&lt;T&gt; <span class="title">call</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">                        context.setServer(server);</div><div class="line">                        <span class="comment">// getServerStatsçš„å…¥å£åœ¨è¿™é‡Œã€‚ã€‚ã€‚</span></div><div class="line">                        <span class="keyword">final</span> ServerStats stats = loadBalancerContext.getServerStats(server);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>è§‚å¯Ÿ<code>LoadBalancerContext.getServerStats()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ServerStats <span class="title">getServerStats</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">       ServerStats serverStats = <span class="keyword">null</span>;</div><div class="line">       <span class="comment">// LoadBalancerContextæŒæœ‰LoadBalancerå¯¹è±¡</span></div><div class="line">       ILoadBalancer lb = <span class="keyword">this</span>.getLoadBalancer();</div><div class="line">       <span class="keyword">if</span> (lb <span class="keyword">instanceof</span> AbstractLoadBalancer)&#123;</div><div class="line">           <span class="comment">// LoadBalanceræŒæœ‰LoadBalancerStatså¯¹è±¡</span></div><div class="line">           LoadBalancerStats lbStats = ((AbstractLoadBalancer) lb).getLoadBalancerStats();</div><div class="line">           serverStats = lbStats.getSingleServerStat(server);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> serverStats;</div><div class="line">   &#125;</div></pre></td></tr></table></figure><ul><li>æ£€æŸ¥<code>LoadBalancer</code>åˆ›å»ºè¿‡ç¨‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    initLoadbalance();</div><div class="line">    <span class="comment">// æ¯éš”3åˆ†é’Ÿé‡æ–°åˆ›å»ºLoadbalance</span></div><div class="line">    service.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        initLoadbalance();</div><div class="line">      &#125;</div><div class="line">    &#125;, <span class="number">3</span>, <span class="number">3</span>, TimeUnit.MINUTES);</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">   * åˆå§‹åŒ–æ™®é€šæœºå™¨è´Ÿè½½å‡è¡¡ç­–ç•¥</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initLoadbalance</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      List&lt;Server&gt; serverList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">      String machine = footballConfigFamilyService.getConfigMap().get(<span class="string">"voice-analyze"</span>);</div><div class="line">      List&lt;Weight&gt; list = JSON.parseObject(machine, <span class="keyword">new</span> TypeReference&lt;List&lt;Weight&gt;&gt;() &#123;</div><div class="line">      &#125;);</div><div class="line">      <span class="comment">// serverListåªæœ‰10æ¥ä¸ª</span></div><div class="line">      <span class="keyword">for</span> (Weight weight : list) &#123;</div><div class="line">        serverList.add(<span class="keyword">new</span> WeightServer(weight.getHost(), weight.getPort(), weight.getWeight()));</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// åˆ›å»ºloadBalancer</span></div><div class="line">      loadBalancer = LoadBalancerBuilder.newBuilder().withRule(<span class="keyword">new</span> WeightedRule())</div><div class="line">          .buildFixedServerListLoadBalancer(serverList);</div><div class="line">      </div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure><p>è§‚å¯Ÿ<code>LoadBalancerBuilder.buildFixedServerListLoadBalancer()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> BaseLoadBalancer <span class="title">buildFixedServerListLoadBalancer</span><span class="params">(List&lt;T&gt; servers)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (rule == <span class="keyword">null</span>) &#123;</div><div class="line">            rule = createRuleFromConfig(config);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// åˆ›å»ºBaseLoadBalancer</span></div><div class="line">        BaseLoadBalancer lb = <span class="keyword">new</span> BaseLoadBalancer(config, rule, ping);</div><div class="line">        <span class="comment">// è®¾ç½®è´Ÿè½½å‡è¡¡æœåŠ¡å™¨åˆ—è¡¨</span></div><div class="line">        lb.setServersList(servers);</div><div class="line">        <span class="keyword">return</span> lb;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">BaseLoadBalancer</span><span class="params">(IClientConfig config, IRule rule, IPing ping)</span> </span>&#123;</div><div class="line">        initWithConfig(config, rule, ping);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">initWithConfig</span><span class="params">(IClientConfig clientConfig, IRule rule, IPing ping)</span> </span>&#123;</div><div class="line">        setLoadBalancerStats(<span class="keyword">new</span> LoadBalancerStats(clientName));</div><div class="line">        rule.setLoadBalancer(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (ping <span class="keyword">instanceof</span> AbstractLoadBalancerPing) &#123;</div><div class="line">            ((AbstractLoadBalancerPing) ping).setLoadBalancer(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>ä»ä¸Šé¢ä»£ç çœ‹ï¼Œæ¯éš”3åˆ†é’Ÿå°±ä¼šé‡æ–°åˆ›å»ºæ–°çš„<code>LoadBalancer</code>ï¼Œæ¯åˆ›å»ºä¸€ä¸ª<code>LoadBalancer</code>ï¼Œéƒ½ä¼šåˆ›å»º<code>LoadBalancerStats</code>ä½œä¸º<code>LoadBalancer</code>å±æ€§</p><p>éš¾é“æ¯éš”3åˆ†é’Ÿæ—¶é—´åˆ›å»ºçš„<code>Server</code>å¯¹<code>Guava LocalCache</code>æ¥è¯´éƒ½æ˜¯ä¸åŒçš„å—ï¼Ÿçªƒå–œï¼Œæ„Ÿè§‰é—®é¢˜å·²ç»æ‰¾åˆ°ğŸ˜„</p><p>ç°åœ¨éœ€è¦ç¡®å®š2ä¸ª<code>WeightServer</code>å¯¹è±¡ï¼Œå…·æœ‰ç›¸åŒçš„<code>ip</code>å’Œ<code>port</code>, åœ¨<code>LocalCache</code>ä¸­æ˜¯ä¸€ä¸ªå—ï¼Ÿ</p><ul><li>æ£€æŸ¥<code>WeightServer</code></li></ul><p>å…·ä½“çš„<code>guava cache</code> æºç ä¸å†å™è¿°ï¼Œæ•´ä½“é€»è¾‘è®¾è®¡å‚è€ƒ<code>CurrentHashMap</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.host = host;</div><div class="line">        <span class="keyword">this</span>.port = port;</div><div class="line">        <span class="keyword">this</span>.id = host + <span class="string">":"</span> + port;</div><div class="line">        isAliveFlag = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == obj)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Server))</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        Server svc = (Server) obj;</div><div class="line">        <span class="keyword">return</span> svc.getId().equals(<span class="keyword">this</span>.getId());</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> hash = <span class="number">7</span>;</div><div class="line">        hash = <span class="number">31</span> * hash + (<span class="keyword">null</span> == <span class="keyword">this</span>.getId() ? <span class="number">0</span> : <span class="keyword">this</span>.getId().hashCode());</div><div class="line">        <span class="keyword">return</span> hash;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>ä»ä¸Šé¢çœ‹ï¼Œ2ä¸ª<code>WeightServer</code>å¦‚æœ<code>ip</code>å’Œ<code>port</code>ç›¸åŒï¼Œç»æµ‹è¯•<code>cache</code>å…ƒç´ åªæœ‰ä¸€ä¸ªï¼Œ<code>guava cache</code>è®¤ä¸ºæ˜¯åŒä¸€ä¸ªå…ƒç´ ã€‚å°´å°¬ï¼ŒçŒœé”™äº†ğŸ˜…ã€‚ã€‚ã€‚</p><h4 id="é‡æ–°æ£€æŸ¥ä»£ç "><a href="#é‡æ–°æ£€æŸ¥ä»£ç " class="headerlink" title="é‡æ–°æ£€æŸ¥ä»£ç "></a>é‡æ–°æ£€æŸ¥ä»£ç </h4><p>æ—¢ç„¶<code>heap dump</code>æ˜¾ç¤º<code>cache</code>ä¸­çš„<code>Server</code>åœ¨ä¸åœå¢åŠ ï¼Œå®é™…æƒ…å†µå´æ˜¯ä¸€ä¸ª<code>cache</code>ä¸­åªä¼šæœ‰10æ¥ä¸ª<code>Server</code>ï¼›çªç„¶æƒ³èµ·æ¥ï¼Œ<strong>æ¯ä¸ª<code>LoadBalancerStats</code>å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª<code>cache</code>å¯¹è±¡</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">BaseLoadBalancer</span><span class="params">(IClientConfig config, IRule rule, IPing ping)</span> </span>&#123;</div><div class="line">        initWithConfig(config, rule, ping);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">initWithConfig</span><span class="params">(IClientConfig clientConfig, IRule rule, IPing ping)</span> </span>&#123;</div><div class="line">        setLoadBalancerStats(<span class="keyword">new</span> LoadBalancerStats(clientName));</div><div class="line">        rule.setLoadBalancer(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (ping <span class="keyword">instanceof</span> AbstractLoadBalancerPing) &#123;</div><div class="line">            ((AbstractLoadBalancerPing) ping).setLoadBalancer(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p><strong>åŸå› ï¼šå®šæ—¶ä»»åŠ¡æ‰§è¡Œ<code>initLoadbalance()</code>ï¼Œå¯¼è‡´ä¸åœåˆ›å»ºæ–°çš„<code>LoadBalancer</code>ï¼Œå³<code>LoadBalancerStats</code>ä¸€ç›´å¢åŠ ï¼Œå…¨éƒ¨<code>cache</code>ç¼“å­˜çš„<code>Server</code>ä¹Ÿä¼šå¢åŠ </strong></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ—§çš„<code>cache</code>ä¸ºä»€ä¹ˆä¸è¢«<code>GC</code>å›æ”¶å‘¢ï¼Ÿå›è¿‡å¤´æ¥çœ‹<code>DataPublisher.start()</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (future == <span class="keyword">null</span>) &#123;</div><div class="line">           Runnable task = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                                   <span class="keyword">try</span> &#123;</div><div class="line">                                      accumulator.publish();</div><div class="line">                                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                                       handleException(e);</div><div class="line">                                   &#125;</div><div class="line">                               &#125;</div><div class="line">                           &#125;;</div><div class="line">           future = getExecutor().scheduleWithFixedDelay(task,</div><div class="line">                                                         delayMillis, delayMillis,</div><div class="line">                                                         TimeUnit.MILLISECONDS);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> ScheduledExecutorService <span class="title">getExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (sharedExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">           sharedExecutor = Executors.newScheduledThreadPool(<span class="number">1</span>, <span class="keyword">new</span> PublishThreadFactory());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> sharedExecutor;</div><div class="line">   &#125;</div></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç çœ‹å‡ºï¼Œ<strong>æ¯ä¸ª<code>Server</code>éƒ½å…³è”äº†ä¸€ä¸ªçº¿ç¨‹æ± æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œå¯¼è‡´<code>cache</code>ä¸­<code>Server</code>å¯¹è±¡ä¸€ç›´è¢«å¼•ç”¨ï¼Œ<code>GC</code>ä¸ä¼šå›æ”¶è¿™ç±»å¯¹è±¡ã€‚</strong></p><h4 id="æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼š"><a href="#æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼š" class="headerlink" title="æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼š"></a>æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è¿‡æœŸæ—¶é—´é»˜è®¤30åˆ†é’Ÿ</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;Server, ServerStats&gt; serverStatsCache = </div><div class="line">        CacheBuilder.newBuilder()</div><div class="line">            .expireAfterAccess(SERVERSTATS_EXPIRE_MINUTES.get(), TimeUnit.MINUTES)</div><div class="line">            .removalListener(<span class="keyword">new</span> RemovalListener&lt;Server, ServerStats&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;Server, ServerStats&gt; notification)</span> </span>&#123;</div><div class="line">                    notification.getValue().close();</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            .build(</div><div class="line">                <span class="keyword">new</span> CacheLoader&lt;Server, ServerStats&gt;() &#123;</div><div class="line">                    <span class="comment">// ç¼“å­˜æ²¡æœ‰åˆ™åˆ›å»ºServerStats</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> ServerStats <span class="title">load</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> createServerStats(server);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>guava cache</code>ä½¿ç”¨äº†<code>expireAfterAccess</code>å’Œ<code>removalListener</code>, æˆ‘çŒœ<a href="[https://github.com/Netflix/ribbon](https://github.com/Netflix/ribbon"><code>robbin</code>æ¡†æ¶</a>)ä½œè€…æœ¬æ„æ˜¯ä½¿ç”¨è¿‡æœŸå‡½æ•°ä»¥åŠç›‘å¬å™¨åœ¨<code>Server</code>å¤±æ•ˆåå…³é—­çº¿ç¨‹æ± è¿è¡Œï¼Œé˜²æ­¢çº¿ç¨‹ä¸€ç›´è¿è¡Œï¼›ä½†æ˜¯<code>guava cache</code>çš„è¿‡æœŸåˆ é™¤æ˜¯è¢«åŠ¨çš„ï¼Œå°±æ˜¯è¯´å¦‚æœå…ƒç´ è¿‡æœŸåå†æ¬¡è¢«è®¿é—®ï¼Œä¼šè§¦å‘åˆ é™¤å¹¶é‡æ–°åŠ è½½</p><p><strong>ä»¥è¯¥é¡¹ç›®ä»£ç æ‰§è¡Œæ¥çœ‹ï¼Œåªä¼šä¸€ç›´æ·»åŠ æ–°çš„<code>cache</code>ï¼Œæ—§çš„<code>cache</code>ä¸èƒ½è¢«è®¿é—®ï¼Œå¯¼è‡´ç¼“å­˜å¯¹è±¡ä¸èƒ½é‡Šæ”¾</strong></p><h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><ul><li>é¿å…<code>LoadBalancer</code>ä¸åœçš„åˆ›å»ºï¼Œè¦†ç›–<code>ServerList</code>å³å¯</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initLoadbalance</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      List&lt;Server&gt; serverList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">      String machine = footballConfigFamilyService.getConfigMap().get(<span class="string">"voice-analyze"</span>);</div><div class="line">      List&lt;Weight&gt; list = JSON.parseObject(machine, <span class="keyword">new</span> TypeReference&lt;List&lt;Weight&gt;&gt;() &#123;</div><div class="line">      &#125;);</div><div class="line">      <span class="comment">// serverListåªæœ‰10æ¥ä¸ª</span></div><div class="line">      <span class="keyword">for</span> (Weight weight : list) &#123;</div><div class="line">        serverList.add(<span class="keyword">new</span> WeightServer(weight.getHost(), weight.getPort(), weight.getWeight()));</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// **********ä»£ç ä¿®å¤å¤„************</span></div><div class="line">      <span class="keyword">if</span>(loadBalancer == <span class="keyword">null</span>)&#123;</div><div class="line">        loadBalancer = LoadBalancerBuilder.newBuilder().withRule(<span class="keyword">new</span> WeightedRule())</div><div class="line">          .buildFixedServerListLoadBalancer(serverList);</div><div class="line">      &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="comment">// è¦†ç›–æ—§çš„server list</span></div><div class="line">        loadBalancer.setServersList(serverList);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>ä½¿ç”¨ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œä¸€å®šè¦äº†è§£åº•å±‚è¿è¡Œæœºåˆ¶ã€‚ğŸ˜„</p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2019/02/13/Netty-æœåŠ¡ç«¯å¯åŠ¨/" itemprop="url">Netty æœåŠ¡ç«¯å¯åŠ¨</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time itemprop="dateCreated" datetime="2019-02-13T14:17:51+08:00" content="2019-02-13">2019-02-13</time></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="æœåŠ¡ç«¯å¯åŠ¨ä»£ç "><a href="#æœåŠ¡ç«¯å¯åŠ¨ä»£ç " class="headerlink" title="æœåŠ¡ç«¯å¯åŠ¨ä»£ç "></a>æœåŠ¡ç«¯å¯åŠ¨ä»£ç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</div><div class="line">EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</div><div class="line">ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</div><div class="line">bootstrap.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)</div><div class="line">          .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">              <span class="comment">// ...</span></div><div class="line">            &#125;</div><div class="line">          &#125;).option(ChannelOption.SO_BACKLOG, <span class="number">128</span>).childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">ChannelFuture channelFuture = bootstrap.bind(<span class="keyword">new</span> InetSocketAddress(port)).sync();</div></pre></td></tr></table></figure><h3 id="å¯åŠ¨è¿‡ç¨‹åˆ†æ"><a href="#å¯åŠ¨è¿‡ç¨‹åˆ†æ" class="headerlink" title="å¯åŠ¨è¿‡ç¨‹åˆ†æ"></a>å¯åŠ¨è¿‡ç¨‹åˆ†æ</h3><p>è·Ÿè¸ª<code>ServerBootstrap.bind()</code>æ–¹æ³•ï¼Œè¿½åˆ°<code>AbstractBootstrap.doBind()</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ChannelFuture <span class="title">doBind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress)</span> </span>&#123;</div><div class="line">         <span class="comment">// åˆ›å»ºchannelå¹¶ä¸”æ³¨å†Œselector</span></div><div class="line">        <span class="keyword">final</span> ChannelFuture regFuture = initAndRegister();</div><div class="line">        <span class="keyword">final</span> Channel channel = regFuture.channel();</div><div class="line">        <span class="keyword">if</span> (regFuture.cause() != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> regFuture;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (regFuture.isDone()) &#123;</div><div class="line">            <span class="comment">// At this point we know that the registration was complete and successful.</span></div><div class="line">            ChannelPromise promise = channel.newPromise();</div><div class="line">            <span class="comment">// å°†ServerSocketChannelç»‘å®šåˆ°æœ¬åœ°çš„ç«¯å£</span></div><div class="line">            doBind0(regFuture, channel, localAddress, promise);</div><div class="line">            <span class="keyword">return</span> promise;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">// ...</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>è·Ÿè¸ª<code>initAndRegister()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Channel channel = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// åˆ›å»ºchannel</span></div><div class="line">    channel = channelFactory.newChannel();</div><div class="line">    <span class="comment">// åˆå§‹åŒ–channel</span></div><div class="line">    init(channel);</div><div class="line">&#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">    <span class="keyword">if</span> (channel != <span class="keyword">null</span>) &#123;</div><div class="line">        channel.unsafe().closeForcibly();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultChannelPromise(channel, GlobalEventExecutor.INSTANCE).setFailure(t);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultChannelPromise(<span class="keyword">new</span> FailedChannel(), GlobalEventExecutor.INSTANCE).setFailure(t);</div><div class="line">&#125;</div><div class="line"><span class="comment">// æ³¨å†Œchannelåˆ°selector</span></div><div class="line">ChannelFuture regFuture = config().group().register(channel);</div></pre></td></tr></table></figure><p>è¿™é‡Œå…ˆé€šè¿‡å·¥å‚åˆ›å»ºäº†ä¸€ä¸ª<code>Channel</code>(è¿™é‡ŒæœåŠ¡ç«¯æŒ‡å®šç±»å‹<code>NioServerSocketChannel</code>)ï¼Œç„¶ååˆå§‹åŒ–è¿™ä¸ª<code>Channel</code>ã€‚æœ€åæŠŠè¿™ä¸ª<code>Channel</code>æ³¨å†Œåˆ°<code>EventLoopGroup</code>ä¸Šï¼ˆ<code>config().group()</code>è¿”å›çš„æ˜¯æˆ‘ä»¬è®¾ç½®çš„<code>Boss Group</code>ï¼‰</p><h4 id="åˆ›å»ºchannel"><a href="#åˆ›å»ºchannel" class="headerlink" title="åˆ›å»ºchannel"></a>åˆ›å»º<code>channel</code></h4><p>æŸ¥çœ‹<code>NioServerSocketChannel</code>æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioServerSocketChannel</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//è°ƒç”¨ä¸‹é¢è¿™ä¸ªæ–¹æ³•</span></div><div class="line">    <span class="keyword">this</span>(newSocket(DEFAULT_SELECTOR_PROVIDER));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioServerSocketChannel</span><span class="params">(ServerSocketChannel channel)</span> </span>&#123;</div><div class="line">    <span class="comment">//æ³¨æ„ï¼Œè¿™é‡Œæ˜¯åˆå§‹åŒ–äº†ä¸€ä¸ªå¯¹SelectionKey.OP_ACCEPTæ„Ÿå…´è¶£çš„ç®¡é“</span></div><div class="line">    <span class="comment">//Bossçš„Reactorçº¿ç¨‹è½®è¯¢åˆ°éƒ½æ˜¯ACCEPTäº‹ä»¶</span></div><div class="line">    <span class="keyword">super</span>(<span class="keyword">null</span>, channel, SelectionKey.OP_ACCEPT);</div><div class="line">    config = <span class="keyword">new</span> NioServerSocketChannelConfig(<span class="keyword">this</span>, javaChannel().socket());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SelectorProvider DEFAULT_SELECTOR_PROVIDER = SelectorProvider.provider();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ServerSocketChannel <span class="title">newSocket</span><span class="params">(SelectorProvider provider)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> provider.openServerSocketChannel();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><code>newSocket</code>ä½¿ç”¨<code>SelectorProvider</code>çš„<code>openServerSocketChannel</code>æ‰“å¼€æœåŠ¡å™¨å¥—æ¥å­—é€šé“ã€‚<code>SelectorProvider</code>ä¸»è¦å·¥ä½œæ˜¯æ ¹æ®æ“ä½œç³»ç»Ÿç±»å‹å’Œç‰ˆæœ¬é€‰æ‹©åˆé€‚çš„<code>Provider</code>ï¼šå¦‚æœ<code>Linux</code>å†…æ ¸ç‰ˆæœ¬&gt;=2.6åˆ™ï¼Œå…·ä½“çš„<code>SelectorProvider</code>ä¸º<code>EPollSelectorProvider</code>ï¼Œå¦åˆ™ä¸ºé»˜è®¤çš„<code>PollSelectorProvider</code></p><p>ç»§ç»­è¿½æº¯<code>super</code>æ–¹æ³•åˆ°<code>AbstractChannel</code>ï¼Œå¦‚ä¸‹æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractChannel</span><span class="params">(Channel parent)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.parent = parent;</div><div class="line">    <span class="comment">// ChannelIdæ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„å€¼</span></div><div class="line">    id = newId();</div><div class="line">    unsafe = newUnsafe();</div><div class="line">    pipeline = newChannelPipeline();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦åšäº†2ä»¶äº‹ï¼š</p><ul><li><p>åˆ›å»º<code>NioMessageUnsafe</code>å®ä¾‹ï¼ˆå®¢æˆ·ç«¯åˆ›å»º<code>NioByteUnsafe</code>ï¼‰ï¼Œè¯¥ç±»ä¸º<code>Channel</code>æä¾›äº†ç”¨äºå®Œæˆç½‘ç»œé€šè®¯ç›¸å…³çš„åº•å±‚æ“ä½œï¼Œå¦‚<code>connect(),read(),register(),bind(),close()</code>ç­‰ï¼›</p></li><li><p>ç»™è¯¥<code>Channel</code>åˆ›å»º<code>DefaultChannelPipeline</code>å¹¶åˆå§‹åŒ–ï¼Œè¿™é‡Œç”¨çš„æ˜¯é»˜è®¤<code>Pipeline</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">DefaultChannelPipeline</span><span class="params">(Channel channel)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.channel = ObjectUtil.checkNotNull(channel, <span class="string">"channel"</span>);</div><div class="line">        succeededFuture = <span class="keyword">new</span> SucceededChannelFuture(channel, <span class="keyword">null</span>);</div><div class="line">        voidPromise =  <span class="keyword">new</span> VoidChannelPromise(channel, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// åˆ›å»ºtail</span></div><div class="line">        tail = <span class="keyword">new</span> TailContext(<span class="keyword">this</span>);</div><div class="line">        <span class="comment">// åˆ›å»ºhead </span></div><div class="line">        head = <span class="keyword">new</span> HeadContext(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        head.next = tail;</div><div class="line">        tail.prev = head;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>å…·ä½“çš„<code>ChannelPipeline</code>æ‰§è¡Œæµç¨‹çœ‹<a href="https://zsr.github.io/2018/12/15/Netty-æ ¸å¿ƒç»„ä»¶/">å‰ç¯‡æ–‡ç« </a></p></li></ul><p>åˆ°è¿™é‡Œæ•´ä¸ª<code>Channel</code>åˆ›å»ºå°±ç»“æŸäº†ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼š</p><ol><li>é€šè¿‡å·¥å‚åˆ›å»ºä¸€ä¸ª<code>Channel</code>ï¼Œè¿™é‡Œçš„<code>Channel</code>ç”±äºæ˜¯åœ¨æœåŠ¡ç«¯ï¼Œä½¿ç”¨çš„æ˜¯<code>NioServerSocketChannel</code>ï¼Œ</li><li>è¿™ä¸ªç®¡é“çš„æ„é€ æ–¹æ³•ä¸­ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ªåŸç”Ÿçš„<code>ServerSocketChannel</code>ï¼Œæœ€ååˆå§‹åŒ–<code>pipeline</code>å’Œ<code>unsafe</code>ã€‚</li><li>åˆå§‹åŒ–<code>pipeline</code>çš„æ—¶å€™ï¼Œåˆä¼šåˆå§‹åŒ–<code>pipeline</code>ä¸­çš„<code>Head</code>å’Œ<code>Tail</code>ã€‚</li></ol><h4 id="åˆå§‹åŒ–channel"><a href="#åˆå§‹åŒ–channel" class="headerlink" title="åˆå§‹åŒ–channel"></a>åˆå§‹åŒ–<code>channel</code></h4><p>æœåŠ¡ç«¯<code>init()</code>å®ç°æ–¹æ³•åœ¨<code>ServerBootstrap</code>ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ªhandleï¼ChannelInitializer</span></div><div class="line">        p.addLast(<span class="keyword">new</span> ChannelInitializer&lt;Channel&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="comment">// è¿™é‡Œè¿˜å¹¶æœªæ‰§è¡ŒinitChannelæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯åœ¨æ‰§è¡Œå›è°ƒæ–¹æ³•handlerAddedåè°ƒç”¨çš„</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(<span class="keyword">final</span> Channel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                <span class="keyword">final</span> ChannelPipeline pipeline = ch.pipeline();</div><div class="line">                ChannelHandler handler = config.handler();</div><div class="line">                <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</div><div class="line">                    pipeline.addLast(handler);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                ch.eventLoop().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        pipeline.addLast(<span class="keyword">new</span> ServerBootstrapAcceptor(</div><div class="line">                                ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>æœåŠ¡ç«¯çš„<code>init()</code>åˆ†ä¸º2ä¸ªæ­¥éª¤ï¼š</p><ul><li>å°†<code>bootstrap</code>é…ç½®çš„å±æ€§è®¾ç½®åˆ°<code>Channel</code>ä¸Šé¢</li><li>ç»™<code>NioServerSocketChannel</code>çš„<code>pipeline</code>é‡Œï¼Œæ·»åŠ äº†ä¸€ä¸ª<code>ChannelHandle</code>-<code>ChannelInitializer</code>ï¼Œä¾›æ³¨å†Œåä½¿ç”¨</li></ul><p>åˆå§‹åŒ–ç»“æŸï¼Œæ­¤æ—¶<code>NioServerSocketChannel</code>çš„<code>pipeline</code>é“¾è¡¨ç»“æ„ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Head &lt;--&gt;  ChannelInitializer &lt;--&gt; Tail</div></pre></td></tr></table></figure><h4 id="æ³¨å†Œchannel"><a href="#æ³¨å†Œchannel" class="headerlink" title="æ³¨å†Œchannel"></a>æ³¨å†Œ<code>channel</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ChannelFuture regFuture = config().group().register(channel);</div></pre></td></tr></table></figure><p>ä¸»è¦å°†åˆ›å»ºå¹¶åˆå§‹åŒ–åçš„<code>Channel</code>æ³¨å†Œåˆ°<code>selector</code>ä¸Šé¢ï¼š</p><ul><li>å°†<code>Channel</code>æ³¨å†Œåˆ°<code>EventLoop</code>çš„<code>selector</code>ä¸Šï¼›</li><li>è§¦å‘<code>Pipeline</code>ä¸Šé¢<code>ChannelHandler</code>çš„<code>channelRegistered</code></li></ul><p>è¿™é‡Œçš„<code>config().group()</code>ç»“æœæ˜¯<code>NioEventLoopGroup</code>ï¼Œçˆ¶ç±»æ˜¯<code>MultithreadEventLoopGroup</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">register</span><span class="params">(Channel channel)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> next().register(channel);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>next()</code>æ–¹æ³•æœ€åæ‰§è¡Œåˆ°<code>chooser.next()</code>ï¼Œ<code>chooser</code>æœ‰ä¸¤ç§ï¼š<code>PowerOfTwoEventExecutorChooser</code>å’Œ<code>GenericEventExecutorChooser</code>ã€‚å¦‚æœè¯¥<code>EventLoopGroup</code>ä¸­<code>EventLoop</code>æ˜¯2çš„å€æ•°åˆ™é€‰æ‹©<code>PowerOfTwoEventExecutorChooser</code>(2çš„å€æ•°æ–¹ä¾¿ä½æ“ä½œ)ï¼›å› ä¸ºè¿™é‡Œçš„<code>Group</code>æ˜¯<code>NioEventLoopGroup</code>ï¼Œæ‰€ä»¥<code>next()</code>è¿”å›çš„æ˜¯<code>NioEventLoop</code></p><p>ç»§ç»­çœ‹<code>NioEventLoop.register()</code>ï¼Œå…·ä½“æ–¹æ³•å®ç°åœ¨<code>SingleThreadEventLoop</code>ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">promise.channel().unsafe().register(<span class="keyword">this</span>, promise);</div><div class="line"><span class="keyword">return</span> promise;</div></pre></td></tr></table></figure><p>æœ€ç»ˆä½¿ç”¨<code>channel</code>ä¸­çš„<code>unsafe()</code>æ³¨å†Œï¼Œå…·ä½“æ–¹æ³•å®ç°åœ¨<code>AbstractUnsafe</code>ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register0</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">boolean</span> firstRegistration = neverRegistered;<span class="comment">// æ˜¯å¦ä¸ºé¦–æ¬¡æ³¨å†Œ</span></div><div class="line">                <span class="comment">// å®é™…çš„æ³¨å†ŒåŠ¨ä½œ, æŠŠChannelæ„Ÿå…´è¶£çš„äº‹ä»¶æ³¨å†Œåˆ°Eventloop.selectorä¸Šé¢</span></div><div class="line">                doRegister();</div><div class="line">                neverRegistered = <span class="keyword">false</span>;</div><div class="line">                registered = <span class="keyword">true</span>;</div><div class="line">                pipeline.invokeHandlerAddedIfNeeded();<span class="comment">// å°†æ³¨å†Œä¹‹å‰åŠ å…¥çš„handleråŠ å…¥è¿›æ¥</span></div><div class="line">                safeSetSuccess(promise); <span class="comment">// æ³¨å†ŒæˆåŠŸï¼Œé€šçŸ¥promise</span></div><div class="line">                pipeline.fireChannelRegistered();<span class="comment">// pipelineé€šçŸ¥è§¦å‘æ³¨å†ŒæˆåŠŸ</span></div><div class="line">      </div><div class="line">                <span class="keyword">if</span> (isActive()) &#123; <span class="comment">// æ˜¯å¦å·²ç»ç»‘å®š å› ä¸ºregisterå’Œbindé˜¶æ®µæ˜¯å¼‚æ­¥çš„</span></div><div class="line">                    <span class="keyword">if</span> (firstRegistration) &#123; </div><div class="line">                        pipeline.fireChannelActive(); <span class="comment">// é¦–æ¬¡æ³¨å†Œï¼Œé€šçŸ¥</span></div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config().isAutoRead()) &#123;</div><div class="line">                        beginRead();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                closeForcibly();</div><div class="line">                closeFuture.setClosed();</div><div class="line">                safeSetFailure(promise, t);</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure><p><code>invokeHandlerAddedIfNeeded</code>: æ³¨å†ŒæˆåŠŸåï¼Œæ‰¾åˆ°åˆå§‹åŒ–é˜¶æ®µé€šè¿‡<code>pipeline.addLast()</code>åŠ å…¥çš„<code>ChannelInitializer</code>ï¼Œæ‰§è¡Œå…¶<code>ChannelInitializer</code>çš„<code>initChannel</code>æ–¹æ³•(æ·»åŠ <code>ChannelHandle</code>-<code>ServerBootstrapAcceptor</code>)ï¼Œä¹‹åå°†<code>ChannelInitializer</code> åœ¨<code>pipeline</code>ä¸­åˆ é™¤</p><p>æ³¨å†Œç»“æŸï¼Œæ­¤æ—¶<code>NioServerSocketChannel</code>çš„<code>pipeline</code>é“¾è¡¨ç»“æ„ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Head   &lt;--&gt; ServerBootstrapAcceptor &lt;--&gt; Tail</div></pre></td></tr></table></figure><p><code>fireChannelRegistered</code>æ²¿ç€<code>pipeline</code>çš„<code>head</code>åˆ°<code>tail</code>ï¼Œè°ƒç”¨<code>ChannelHandler.channelRegistered</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireChannelRegistered</span><span class="params">()</span> </span>&#123;</div><div class="line">        AbstractChannelHandlerContext.invokeChannelRegistered(head);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeChannelRegistered</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (invokeHandler()) &#123; <span class="comment">// çŠ¶æ€æ˜¯å¦æ­£ç¡®</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                ((ChannelInboundHandler) handler()).channelRegistered(<span class="keyword">this</span>); <span class="comment">// è§¦å‘</span></div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                notifyHandlerException(t);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            fireChannelRegistered();<span class="comment">// çŠ¶æ€ä¸æ­£ç¡®ï¼Œé€šçŸ¥ä¸‹ä¸€ä¸ªHandler</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p><code>fireChannelActive</code> ç”±äºæ³¨å†Œé˜¶æ®µå’Œç»‘å®š<code>bind</code>é˜¶æ®µéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚æœæ­¤æ—¶æ³¨å†Œå®Œæˆæ—¶<code>bind</code>é˜¶æ®µå·²ç»ç»‘å®šäº†æœ¬åœ°ç«¯å£ï¼Œä¼šæ²¿ç€<code>pipeline</code>çš„<code>head</code>åˆ°<code>tail</code>ï¼Œè°ƒç”¨å„ä¸ª<code>ChannelHandler</code>çš„<code>channelActive</code>æ–¹æ³•</p><h4 id="bindæœ¬åœ°åœ°å€"><a href="#bindæœ¬åœ°åœ°å€" class="headerlink" title="bindæœ¬åœ°åœ°å€"></a><code>bind</code>æœ¬åœ°åœ°å€</h4><p>å°†<code>NioServerSocketChannel</code>å†…éƒ¨<code>ServerSocketChannel</code>ç»‘å®šåˆ°æœ¬åœ°çš„ç«¯å£ä¸Šé¢ï¼Œç„¶åè°ƒç”¨<code>fireChannelActive</code>é€šçŸ¥<code>pipeline</code>é‡Œçš„<code>ChannelHandle</code>ï¼Œæ‰§è¡Œå…¶<code>channelActive</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doBind0</span><span class="params">(</span></span></div><div class="line">           <span class="keyword">final</span> ChannelFuture regFuture, <span class="keyword">final</span> Channel channel,</div><div class="line">           <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise) &#123;</div><div class="line"></div><div class="line">       <span class="comment">// This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up</span></div><div class="line">       <span class="comment">// the pipeline in its channelRegistered() implementation.</span></div><div class="line">       channel.eventLoop().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">               <span class="keyword">if</span> (regFuture.isSuccess()) &#123;</div><div class="line">                   channel.bind(localAddress, promise).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   promise.setFailure(regFuture.cause());</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure><p><code>AbstractBootstrap</code>çš„<code>doBind0()</code>ï¼Œå†…éƒ¨ä¼šè°ƒç”¨<code>pipeline</code>ä¸­çš„<code>bind</code>æ–¹æ³•ï¼Œé€»è¾‘ä¸ºä»<code>tail</code>å‡ºå‘è°ƒç”¨<code>outbound</code>çš„<code>ChannelHandler</code>çš„<code>bind</code>æ–¹æ³•ã€‚å½“å‰<code>pipeline</code>é“¾è¡¨ç»“æ„ä¸­åªæœ‰<code>Head</code>æ˜¯ç»§æ‰¿äº†<code>outbound</code>æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> tail.bind(localAddress, promise);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">        <span class="comment">// æ‰¾å‡ºä¸‹ä¸€ä¸ªoutbound,è¿™é‡Œæ‰¾å‡ºæ¥çš„æ˜¯HeadContext</span></div><div class="line">        <span class="keyword">final</span> AbstractChannelHandlerContext next = findContextOutbound();</div><div class="line">        EventExecutor executor = next.executor();</div><div class="line">        <span class="keyword">if</span> (executor.inEventLoop()) &#123;</div><div class="line">            next.invokeBind(localAddress, promise);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            safeExecute(executor, <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    next.invokeBind(localAddress, promise);</div><div class="line">                &#125;</div><div class="line">            &#125;, promise, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> promise;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p><code>Head</code>çš„<code>bind</code>æ–¹æ³•ç”±<code>NioServerSocketChannel</code>åˆ›å»ºè¿‡ç¨‹ä¸­ç”Ÿæˆçš„<code>unsafe</code>çš„å®ä¾‹<code>NioMessageUnsafe</code>æ¥æ‰§è¡Œï¼Œè¯¥å®ä¾‹çš„<code>bind</code>æ–¹æ³•ç»§æ‰¿äº<code>AbstractUnsafe.bind()</code>ï¼Œç„¶åè§¦å‘<code>fireChannelActive</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractUnsafe.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line"></div><div class="line">            <span class="keyword">boolean</span> wasActive = isActive();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">              <span class="comment">// æŠŠchannel bindåˆ°æœ¬åœ°åœ°å€</span></div><div class="line">                doBind(localAddress);</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                safeSetFailure(promise, t);</div><div class="line">                closeIfClosed();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// bindä¹‹åï¼Œè¿™é‡Œçš„isActiveä¼šè¿”å›true</span></div><div class="line">            <span class="keyword">if</span> (!wasActive &amp;&amp; isActive()) &#123;</div><div class="line">                invokeLater(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                    <span class="meta">@Overridem</span>   </div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        <span class="comment">//åœ¨è¿™é‡Œè§¦å‘çš„æ˜¯NioServerSocketChannelå¯¹åº”çš„pipelineçš„channelActive</span></div><div class="line">                        pipeline.fireChannelActive();</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            safeSetSuccess(promise);</div><div class="line">        &#125;</div></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>doBind(localAddress)</code>æ–¹æ³•ç”±åˆ›å»ºçš„<code>NioServerSocketChannel</code>æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBind</span><span class="params">(SocketAddress localAddress)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">if</span> (PlatformDependent.javaVersion() &gt;= <span class="number">7</span>) &#123;</div><div class="line">            javaChannel().bind(localAddress, config.getBacklog());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            javaChannel().socket().bind(localAddress, config.getBacklog());</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>è¿™é‡ŒæŠŠ<code>java</code>åŸç”Ÿçš„<code>ServerSocketChannel</code>ç»‘å®šåˆ°æœ¬åœ°åœ°å€ä¸Š</p><p>ç»‘å®šåˆ°æœ¬åœ°åœ°å€åä¼šæ‰§è¡Œ<code>pipeline.fireChannelActive()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultChannelPipeline.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireChannelActive</span><span class="params">()</span> </span>&#123;</div><div class="line">        AbstractChannelHandlerContext.invokeChannelActive(head);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeChannelActive</span><span class="params">(<span class="keyword">final</span> AbstractChannelHandlerContext next)</span> </span>&#123;</div><div class="line">        EventExecutor executor = next.executor();</div><div class="line">        <span class="keyword">if</span> (executor.inEventLoop()) &#123;</div><div class="line">            next.invokeChannelActive();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            executor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    next.invokeChannelActive();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeChannelActive</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (invokeHandler()) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">              <span class="comment">// è¿™é‡Œhandler()è¿”å›HeadContext</span></div><div class="line">                ((ChannelInboundHandler) handler()).channelActive(<span class="keyword">this</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                notifyHandlerException(t);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            fireChannelActive();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>channelInactive</code>ä¼šè°ƒç”¨<code>HeadContext</code>ç±»çš„<code>channelInactive</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            ctx.fireChannelActive();</div><div class="line">            readIfIsAutoRead();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>è¿™é‡Œé¦–å…ˆæ‰§è¡Œ<code>fireChannelActive</code>æ–¹æ³•ï¼Œæ²¿ç€<code>pipeline</code>ä¼ æ’­ç»™åç»­<code>ChannelInboundHandler</code>ï¼Œæ‰§è¡Œ<code>hannelActive()</code>æ–¹æ³•ï¼›æ¥ç€æ‰§è¡Œ<code>readIfIsAutoRead()</code>ï¼Œå¯ä»¥å‘ç°è¿™ä¸ªæ–¹æ³•ä½œç”¨åœ¨<code>pipeline</code>ä¸Šï¼Œä»<code>tail</code>åˆ°<code>head</code>éå†<code>ChannelOutboundHandler</code>æ‰§è¡Œ<code>read()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬è¿™é‡Œåªæœ‰<code>head</code>æ˜¯<code>outBound</code>ï¼Œ<code>read()</code>æ–¹æ³•æœ€åè¿›å…¥<code>AbstractNioChannel.doBeginRead()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBeginRead</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">final</span> SelectionKey selectionKey = <span class="keyword">this</span>.selectionKey;</div><div class="line">    <span class="keyword">if</span> (!selectionKey.isValid()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    readPending = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> interestOps = selectionKey.interestOps();</div><div class="line">    <span class="keyword">if</span> ((interestOps &amp; readInterestOp) == <span class="number">0</span>) &#123; </div><div class="line">        <span class="comment">// interestOpsæ˜¯0ï¼ŒæŒ‰ä½ä¸ç»“æœè‚¯å®šæ˜¯0</span></div><div class="line">        selectionKey.interestOps(interestOps | readInterestOp);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°åœ¨æ‰§è¡Œ<code>doRegister()</code>æ³¨å†Œè¿™ä¸ª<code>Channel</code>åˆ°<code>selector</code>çš„æ—¶å€™ï¼Œ<code>selectKey</code>èµ‹äºˆäº†0</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> selected = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">              <span class="comment">// selectKeyèµ‹äºˆäº†0</span></div><div class="line">        selectionKey = javaChannel().register(eventLoop().unwrappedSelector(), <span class="number">0</span>, <span class="keyword">this</span>);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123; </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>è¿™é‡Œ<code>readInterestOp</code>è¿™ä¸ªå“ªæ¥çš„ï¼šåœ¨åˆ›å»º<code>NioServerSocketChannel</code>çš„æ—¶å€™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioServerSocketChannel</span><span class="params">(ServerSocketChannel channel)</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>(<span class="keyword">null</span>, channel, SelectionKey.OP_ACCEPT);</div><div class="line">       config = <span class="keyword">new</span> NioServerSocketChannelConfig(<span class="keyword">this</span>, javaChannel().socket());</div><div class="line">   &#125;</div></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œé‡æ–°æ³¨å†Œäº†<code>accept</code>äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ä»æ­¤å¼€å§‹ï¼Œ<code>selector</code>å†è½®è¯¢åˆ°æ–°çš„è¿æ¥æ¥å…¥äº‹ä»¶ï¼Œå°±å¯ä»¥äº¤ç»™è¿™ä¸ª<code>NioServerSocketChannel</code>æ¥å¤„ç†äº†</p><p>è‡³æ­¤ï¼Œ<code>Netty</code>æœåŠ¡å™¨æ®µå·²ç»å¯åŠ¨ï¼Œ<code>Channel</code>å’Œ<code>ChannelPipeline</code>å·²ç»å»ºç«‹ï¼Œ<code>EventLoop</code>ä¹Ÿåœ¨ä¸æ–­çš„<code>select()</code>æŸ¥æ‰¾å‡†å¤‡å¥½çš„I/Oã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol><li>é€šè¿‡å·¥å‚ç”Ÿæˆ<code>NioServerSocketChannel</code>ã€‚</li><li>è®¾ç½®<code>NioServerSocketChannel</code>å¯¹<code>accept</code>äº‹ä»¶æ„Ÿå…´è¶£ã€‚æ­¤æ—¶<code>Channel</code>å·²ç»ç»‘å®šäº†<code>unsafe</code>å’Œ<code>pipeline</code></li><li>åˆå§‹åŒ–<code>Channel</code>ï¼Œè¿™é‡Œä¸»è¦æ˜¯è®¾ç½®<code>Channel</code>çš„<code>pipeline</code>ä¸­çš„<code>handler</code>ã€<code>attr</code>å’Œ<code>option</code>ã€‚è¿™é‡Œçš„<code>handler</code>æ˜¯ç‰¹æ®Šç±»å‹<code>ChannelInitializer</code>ï¼Œç­‰å¾…æ³¨å†Œåå›è°ƒã€‚</li><li>æ³¨å†Œåˆ°<code>EventLoopGroup</code>é‡Œï¼Œæœ€ç»ˆæ˜¯æ³¨å†Œåˆ°æŸä¸€ä¸ª<code>NioEventLoop</code>ä¸Šé¢</li><li>åœ¨æ³¨å†Œæ—¶å®é™…ä¸Šçš„<code>register0</code>æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œ<code>register0</code>çš„ä¸»è¦ä½œç”¨æ˜¯æŠŠåŸç”Ÿ<code>Channel</code>æ³¨å†Œåˆ°åŸç”Ÿ<code>selector</code>ä¸Šã€‚</li><li>æ‰§è¡Œ<code>doBind0</code>ä¹Ÿæ˜¯å¼‚æ­¥åªæƒ³ï¼Œè¿™é‡Œå…¶å®æ˜¯å’Œ<code>register0</code>ä¸€èµ·åœ¨æ‰§è¡Œçš„ã€‚<code>doBind0</code>æ˜¯æŠŠ<code>channel</code>æ³¨å†Œåˆ°æœ¬åœ°ç«¯å£ä¸Š</li><li>æ‰§è¡Œ<code>pipeline.readï¼ˆï¼‰</code>æ–¹æ³•ï¼Œæœ€ç»ˆä¼ é€’åˆ°<code>AbstractNioChannel</code>ï¼Œé‡æ–°å‘<code>selector</code>æ³¨å†Œ<code>OP_ACCEPT</code>äº‹ä»¶</li></ol></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/12/19/Netty-é›¶æ‹·è´/" itemprop="url">Netty é›¶æ‹·è´</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time itemprop="dateCreated" datetime="2018-12-19T21:00:32+08:00" content="2018-12-19">2018-12-19</time></span></div></header><div class="post-body" itemprop="articleBody"><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Zero-Copy describes computer operations in which the CPU does not perform the task of copying data from one memory area to another.</div></pre></td></tr></table></figure><h3 id="ç£ç›˜æ•°æ®é€šè¿‡ç½‘ç»œå‘é€"><a href="#ç£ç›˜æ•°æ®é€šè¿‡ç½‘ç»œå‘é€" class="headerlink" title="ç£ç›˜æ•°æ®é€šè¿‡ç½‘ç»œå‘é€"></a>ç£ç›˜æ•°æ®é€šè¿‡ç½‘ç»œå‘é€</h3><h4 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h4><ol><li>å½“åº”ç”¨ç¨‹åºå‘èµ·<code>read</code>ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œé€šè¿‡<code>DMAï¼ˆDirect Memory Accessï¼‰</code>å°†æ•°æ®<code>copy</code>åˆ°å†…æ ¸ç©ºé—´<code>buffer</code></li><li>ç„¶åç”±<code>CPU</code>æ§åˆ¶å°†å†…æ ¸ç©ºé—´æ•°æ®<code>copy</code>åˆ°ç”¨æˆ·ç©ºé—´ä¸‹çš„ <code>buffer</code>ä¸­</li><li><code>read</code>è°ƒç”¨å®Œæˆåï¼Œ<code>write</code>è°ƒç”¨é¦–å…ˆå°†ç”¨æˆ·ç©ºé—´ä¸‹ <code>buffer</code>ä¸­çš„æ•°æ®<code>copy</code>åˆ°å†…æ ¸æ¨¡å¼ä¸‹çš„<code>socket buffer</code>ä¸­</li><li>æœ€åé€šè¿‡<code>DMA</code>å°†å†…æ ¸æ¨¡å¼ä¸‹çš„<code>socket buffer</code>ä¸­çš„æ•°æ®<code>copy</code>åˆ°ç½‘å¡<code>buffer</code>ä¸­</li></ol><h4 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><p>æ•°æ®ä»å†…æ ¸æ¨¡å¼åˆ°ç”¨æˆ·æ¨¡å¼èµ°äº†ä¸€åœˆï¼Œæµªè´¹äº†ä¸¤æ¬¡<code>copy</code>ï¼Œè€Œè¿™ä¸¤æ¬¡<code>copy</code>éƒ½æ˜¯<code>CPU copy</code>(å ç”¨<code>CPU</code>èµ„æº)</p><h3 id="æ“ä½œç³»ç»Ÿ-é›¶æ‹·è´"><a href="#æ“ä½œç³»ç»Ÿ-é›¶æ‹·è´" class="headerlink" title="æ“ä½œç³»ç»Ÿ é›¶æ‹·è´"></a>æ“ä½œç³»ç»Ÿ é›¶æ‹·è´</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">OS-level zero copy involves avoiding copying memory blocks from one location to another (typically from user space to kernel space) before sending data to the hardware driver (network card or disk drive) or vice versa.</div></pre></td></tr></table></figure><p>å…¸å‹åœºæ™¯ï¼šå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„æ•°æ®æ‹·è´</p><h4 id="Linux-sendfile"><a href="#Linux-sendfile" class="headerlink" title="Linux sendfile"></a><code>Linux sendfile</code></h4><p><strong>os &gt;= Linux 2.4å†…æ ¸</strong></p><h5 id="æ­¥éª¤-1"><a href="#æ­¥éª¤-1" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h5><ol><li><code>DMA copy</code>å°†ç£ç›˜æ•°æ®<code>copy</code>åˆ°<code>kernel buffer</code>ä¸­</li><li>å‘<code>socket buffer</code>ä¸­è¿½åŠ å½“å‰è¦å‘é€çš„æ•°æ®åœ¨<code>kernel buffer</code>ä¸­çš„ä½ç½®å’Œåç§»é‡</li><li><code>DMA gather copy</code>ï¼ˆéœ€è¦ç½‘å¡æ”¯æŒæ•°æ®æ”¶é›†æ¨¡å¼ï¼‰æ ¹æ®<code>socket buffer</code>ä¸­çš„ä½ç½®å’Œåç§»é‡ç›´æ¥å°†<code>kernel buffer</code>ä¸­çš„æ•°æ®<code>copy</code>åˆ°ç½‘å¡ä¸Š</li></ol><h5 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h5><p>ç¨‹åºåªéœ€å‘å‡ºä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨<code>sendfile()</code>ï¼Œæ•°æ®åªç»è¿‡äº†2æ¬¡<code>copy</code>å°±ä»ç£ç›˜ä¼ é€å‡ºå»äº†ï¼Œæ²¡æœ‰<code>CPU copy</code></p><p><code>nginx</code>ï¼Œ<code>java FileChannel.transferTo()</code>ç­‰åœ¨<code>Linux</code>ç³»ç»Ÿä¸­éƒ½å¼•ç”¨äº†<code>sendfile</code>æœºåˆ¶</p><h3 id="FileChannel-transferTo-Javaä¸­çš„é›¶æ‹·è´"><a href="#FileChannel-transferTo-Javaä¸­çš„é›¶æ‹·è´" class="headerlink" title="FileChannel.transferTo(Javaä¸­çš„é›¶æ‹·è´)"></a><code>FileChannel.transferTo</code>(<code>Javaä¸­çš„é›¶æ‹·è´</code>)</h3><p><code>Java NIO</code>ä¸­<code>FileChannel.transferTo(long position, long count, WriteableByteChannel target)</code>æ–¹æ³•å°†å½“å‰é€šé“ä¸­çš„æ•°æ®ä¼ é€åˆ°ç›®æ ‡é€šé“ä¸­ï¼Œåœ¨æ”¯æŒ<code>Zero-Copy</code>çš„<code>linux</code>ç³»ç»Ÿä¸­ï¼Œ<code>transferTo()</code>çš„å®ç°ä¾èµ–äº<code>sendfile()</code>è°ƒç”¨</p><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fymbp5iat5j30uo0imjsz.jpg" alt=""></p><h3 id="Nettyé›¶æ‹·è´"><a href="#Nettyé›¶æ‹·è´" class="headerlink" title="Nettyé›¶æ‹·è´"></a><code>Netty</code>é›¶æ‹·è´</h3><ol><li><code>Netty</code>çš„æ¥æ”¶å’Œå‘é€<code>ByteBuffer</code>é‡‡ç”¨<code>DIRECT BUFFERS</code>ï¼Œä½¿ç”¨å †å¤–å†…å­˜è¿›è¡Œ<code>Socket</code>è¯»å†™ï¼Œä¸éœ€è¦è¿›è¡Œå­—èŠ‚ç¼“å†²åŒºçš„äºŒæ¬¡æ‹·è´ã€‚å¦‚æœä½¿ç”¨ä¼ ç»Ÿçš„å †å†…å­˜ï¼ˆ<code>HEAP BUFFERS</code>ï¼‰è¿›è¡Œ<code>Socket</code>è¯»å†™ï¼Œ<code>JVM</code>ä¼šå°†å †å†…å­˜<code>Buffer</code>æ‹·è´ä¸€ä»½åˆ°ç›´æ¥å†…å­˜ä¸­ï¼Œç„¶åæ‰å†™å…¥<code>Socket</code>ä¸­ã€‚ç›¸æ¯”äºå †å¤–ç›´æ¥å†…å­˜ï¼Œæ¶ˆæ¯åœ¨å‘é€è¿‡ç¨‹ä¸­å¤šäº†ä¸€æ¬¡ç¼“å†²åŒºçš„å†…å­˜æ‹·è´ã€‚</li><li><p><code>Netty</code>æä¾›äº†<code>CompositeByteBuf</code>å¯¹è±¡ï¼Œå¯ä»¥èšåˆå¤šä¸ª<code>ByteBuffer</code>å¯¹è±¡ï¼Œç”¨æˆ·å¯ä»¥åƒæ“ä½œä¸€ä¸ª<code>Buffer</code>é‚£æ ·æ–¹ä¾¿çš„å¯¹ç»„åˆ<code>Buffer</code>è¿›è¡Œæ“ä½œï¼Œé¿å…äº†ä¼ ç»Ÿé€šè¿‡å†…å­˜æ‹·è´çš„æ–¹å¼å°†å‡ ä¸ªå°<code>Buffer</code>åˆå¹¶æˆä¸€ä¸ªå¤§çš„<code>Buffer</code>ã€‚</p></li><li><p><code>Netty</code>çš„æ–‡ä»¶ä¼ è¾“é‡‡ç”¨äº†<code>java nio transferTo</code>æ–¹æ³•ï¼Œå®ƒå¯ä»¥ç›´æ¥å°†æ–‡ä»¶ç¼“å†²åŒºçš„æ•°æ®å‘é€åˆ°ç›®æ ‡<code>Channel</code>ï¼ˆä¼ ç»Ÿçš„åšæ³•: æ‹·è´æ–‡ä»¶å†…å®¹åˆ°ä¸´æ—¶ <code>buffer</code>, ç„¶åå†å°† <code>buffer</code> å†™å…¥<code>Channel</code>ï¼‰ï¼Œä½¿ç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„é›¶æ‹·è´ï¼Œé¿å…äº†ä¼ ç»Ÿé€šè¿‡å¾ªç¯<code>write</code>æ–¹å¼å¯¼è‡´çš„å†…å­˜æ‹·è´é—®é¢˜</p></li></ol><h4 id="CompositeByteBuf"><a href="#CompositeByteBuf" class="headerlink" title="CompositeByteBuf"></a><code>CompositeByteBuf</code></h4><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fynh0n2p3wj30l40bwmxi.jpg" alt=""></p><p><strong>æ³¨æ„ï¼š <code>CompositeByteBuf</code> æ˜¯ç”±å¤šä¸ª <code>ByteBuf</code> ç»„åˆè€Œæˆçš„, ä¸è¿‡åœ¨ <code>CompositeByteBuf</code> å†…éƒ¨, è¿™äº› <code>ByteBuf</code> éƒ½æ˜¯å•ç‹¬å­˜åœ¨çš„, <code>CompositeByteBuf</code> ä¿å­˜äº†å®ƒä»¬çš„å¼•ç”¨ï¼Œåªæ˜¯åœ¨é€»è¾‘ä¸Šæ˜¯ä¸€ä¸ªæ•´ä½“</strong></p><h4 id="java-ByteBuffer-vs-netty-ByteBuf"><a href="#java-ByteBuffer-vs-netty-ByteBuf" class="headerlink" title="java ByteBuffer vs netty ByteBuf"></a><code>java ByteBuffer</code> vs <code>netty ByteBuf</code></h4><p><code>java</code> æœ¬èº«å°±æœ‰ <code>ByteBuffer</code>ï¼Œä¸ºä»€ä¹ˆè¦é¢å¤–è®¾è®¡ä¸€ä¸ª <code>ByteBuf</code>?</p><ul><li><code>ByteBuffer</code> åªç”¨ä¸€ä¸ª <code>position</code> å˜é‡è¡¨ç¤ºå½“å‰ä½ç½®ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œè¯»å†™åˆ‡æ¢çš„æ—¶å€™éƒ½éœ€è¦è°ƒç”¨<code>flip()</code>å’Œ<code>clear()</code>ç­‰æ–¹æ³•ï¼Œå¦åˆ™åŠŸèƒ½å°†å‡ºé”™</li><li><code>ByteBuf</code> ä½¿ç”¨ <code>readerIndex</code> å’Œ <code>writerIndex</code> åˆ†åˆ«è¡¨ç¤ºè¯»å†™ä½ç½®ï¼Œä¸éœ€è¦è°ƒç”¨å‡½æ•°åˆ‡æ¢ï¼Œä½“éªŒæ›´å¥½ã€‚</li></ul><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://segmentfault.com/a/1190000007692223" target="_blank" rel="external">ç£ç›˜åŠç½‘ç»œIOå·¥ä½œæ–¹å¼è§£æ</a></p><p><a href="https://stackoverflow.com/questions/20727615/is-nettys-zero-copy-different-from-os-level-zero-copy" target="_blank" rel="external">Is Nettyâ€™s Zero Copy different from OS level Zero Copy?</a></p><p><a href="https://caorong.github.io/2017/01/16/head-first-netty-3/" target="_blank" rel="external">æ·±å…¥æµ…å‡ºNetty - ByteBuf å’Œ ByteBufPool</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/12/15/Netty-æ ¸å¿ƒç»„ä»¶/" itemprop="url">Netty æ ¸å¿ƒç»„ä»¶</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time itemprop="dateCreated" datetime="2018-12-15T18:47:35+08:00" content="2018-12-15">2018-12-15</time></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="Nettyå·¥ä½œæ¶æ„å›¾"><a href="#Nettyå·¥ä½œæ¶æ„å›¾" class="headerlink" title="Nettyå·¥ä½œæ¶æ„å›¾"></a><code>Netty</code>å·¥ä½œæ¶æ„å›¾</h3><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fycc2uem9sj313i0p643a.jpg" alt=""></p><h3 id="æ¨¡å—ç»„ä»¶"><a href="#æ¨¡å—ç»„ä»¶" class="headerlink" title="æ¨¡å—ç»„ä»¶"></a>æ¨¡å—ç»„ä»¶</h3><h4 id="Bootstrap"><a href="#Bootstrap" class="headerlink" title="Bootstrap"></a><code>Bootstrap</code></h4><p><code>Bootstrap</code>æ˜¯å¯åŠ¨å¼•å¯¼ç±»ï¼Œä¸€ä¸ª <code>Netty</code> åº”ç”¨é€šå¸¸ç”±ä¸€ä¸ª <code>Bootstrap</code> å¼€å§‹ï¼Œä¸»è¦ä½œç”¨æ˜¯é…ç½®æ•´ä¸ª <code>Netty</code> ç¨‹åºï¼Œä¸²è”å„ä¸ªç»„ä»¶</p><ul><li><code>Bootstrap</code> ç±»æ˜¯å®¢æˆ·ç«¯ç¨‹åºçš„å¯åŠ¨å¼•å¯¼ç±»</li><li><code>ServerBootstrap</code> ç±»æ˜¯æœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼ç±»</li></ul><h4 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a><code>Channel</code></h4><p><code>Channel</code>çš„æœ¬è´¨æ˜¯å¯¹æ“ä½œç³»ç»Ÿäº§ç”Ÿçš„FDï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰çš„æ˜ å°„ï¼Œå¹¶ä¸”æä¾›ç»‘å®šåˆ°<code>Selector</code>å¤šè·¯é€‰æ‹©å™¨ä¸Šçš„èƒ½åŠ›</p><h4 id="ChannelFuture"><a href="#ChannelFuture" class="headerlink" title="ChannelFuture"></a><code>ChannelFuture</code></h4><p>åœ¨ <code>Netty</code> ä¸­æ‰€æœ‰çš„IOæ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸èƒ½ç«‹åˆ»å¾—çŸ¥æ¶ˆæ¯æ˜¯å¦è¢«æ­£ç¡®å¤„ç†ã€‚ <code>Future</code> å¯¹è±¡å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œç»“æœçš„å ä½ç¬¦ï¼›å®ƒå°†åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»å®Œæˆï¼Œå¹¶æä¾›å¯¹å…¶ç»“æœçš„è®¿é—®ã€‚</p><p><code>Netty</code> æä¾›äº†<code>ChannelFuture</code>ï¼Œç”¨äºåœ¨æ‰§è¡Œå¼‚æ­¥æ“ä½œçš„æ—¶å€™ä½¿ç”¨ã€‚æ¯ä¸ª<code>Netty</code>çš„å‡ºç«™IOæ“ä½œéƒ½ä¼šè¿”å›ä¸€ä¸ª<code>ChannelFuture</code>ã€‚<code>ChannelFuture</code>å¯ä»¥æ³¨å†Œ<code>ChannelFutureListener</code> å®ä¾‹ï¼Œå…¶ä¸­çš„å›è°ƒæ–¹æ³•<code>operationComplete()</code>,å°†ä¼šåœ¨å¯¹åº”çš„æ“ä½œå®Œæˆæ—¶è¢«è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">ChannelFuture <span class="title">write</span><span class="params">(Object msg, ChannelPromise promise)</span></span>;</div></pre></td></tr></table></figure><h4 id="ChannelHandler"><a href="#ChannelHandler" class="headerlink" title="ChannelHandler"></a><code>ChannelHandler</code></h4><p><code>ChannelHandler</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒå……å½“äº†æ‰€æœ‰å¤„ç†å…¥ç«™å’Œå‡ºç«™æ•°æ®çš„åº”ç”¨ç¨‹åºé€»è¾‘çš„å®¹å™¨ï¼Œå¹¶å°†å…¶è½¬å‘åˆ°å…¶ <code>ChannelPipeline</code>ä¸­çš„ä¸‹ä¸€ä¸ª<code>ChannelHandler</code>ï¼›è¯¥ç±»æ˜¯åŸºäºäº‹ä»¶é©±åŠ¨çš„ï¼Œå®ƒä¼šå“åº”ç›¸å…³çš„äº‹ä»¶ç„¶åå»è°ƒç”¨å…¶å…³è”çš„å›è°ƒå‡½æ•°ï¼Œä¾‹å¦‚ï¼šå½“ä¸€ä¸ªæ–°çš„è¿æ¥è¢«å»ºç«‹æ—¶ï¼Œ<code>ChannelHandler</code>çš„<code>channelActive()</code>æ–¹æ³•å°†ä¼šè¢«è°ƒç”¨</p><p><code>ChannelHandler</code>å­ç±»ï¼Œä¾‹å¦‚ï¼š</p><ul><li><code>ChannelInboundHandler</code>ï¼šç”¨äºå¤„ç†å…¥ç«™IOäº‹ä»¶ã€‚</li><li><code>ChannelOutboundHandler</code>ï¼šç”¨äºå¤„ç†å‡ºç«™IOæ“ä½œã€‚</li></ul><h4 id="ChannelPipline"><a href="#ChannelPipline" class="headerlink" title="ChannelPipline"></a><code>ChannelPipline</code></h4><p><code>ChannelPipeline</code> æ˜¯èšåˆäº† <code>ChannelHandler</code> çš„ç®¡é“ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªèŒè´£é“¾è·¯ï¼ˆç”¨äºå¤„ç†<code>Channel</code>çš„å…¥ç«™äº‹ä»¶å’Œå‡ºç«™æ“ä½œï¼‰ï¼Œåœ¨<code>Worker</code>çº¿ç¨‹ä¸­ä¼šå¯¹æ¯ä¸€ä¸ª<code>Channel</code>æ‰§è¡Œå…¶æ‰€å¯¹åº”çš„<code>pipeline</code>é“¾ï¼Œå®Œæˆæ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fy8rq2caj7j30uw08k76d.jpg" alt=""></p><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fy8tkgaop2j31jo0mcac9.jpg" alt=""></p><p>è“è‰²è¡¨ç¤º <code>ChannelInboundHandler</code> ï¼Œç»¿è‰²è¡¨ç¤º <code>ChannelOutboundHandler</code>ï¼Œé»„è‰²åˆ™æ‰¿æ‹…ä¸¤ä¸ªè§’è‰²ï¼Œè€Œæ¯ä¸ª<code>Handler</code>åˆä¼šä½¿ç”¨ <code>ChannelHandlerContext</code> å°è£…èµ·æ¥ï¼Œåœ¨ <code>ChannelPipeline</code> ä¸­ç»„è£…æˆåŒå‘é“¾è¡¨ã€‚</p><p><strong>ChannelPipeline handler æ‰§è¡Œé¡ºåº</strong>ï¼š</p><ul><li><strong>å…¥ç«™äº‹ä»¶æµä»å¤´åˆ°å°¾æ‰§è¡Œæ‰€æœ‰çš„<code>handler</code>(å…¥ç«™çš„æ—¶å€™ä¹Ÿä¼šç»è¿‡<code>OutboundChannelHandler</code>ï¼Œåªä¸è¿‡ç•¥è¿‡äº†è¿™ä¸ª<code>ChannelHandler</code>)</strong></li><li><strong>å‡ºç«™äº‹ä»¶æµä»å°¾åˆ°å¤´æ‰§è¡Œæ‰€æœ‰çš„<code>handler</code>(å‡ºç«™çš„æ—¶å€™ä¹Ÿä¼šç»è¿‡<code>InboundChannelHandler</code>ï¼Œåªä¸è¿‡ç•¥è¿‡äº†è¿™ä¸ª<code>ChannelHandler</code>)</strong></li></ul><p><strong>æ³¨æ„ï¼š åœ¨å…·ä½“ä¸šåŠ¡å¤„ç†ç±»<code>ProcessingHandler</code>ä¸­å°†å“åº”æ•°æ®å‘å‡ºæœ‰2ç§æ–¹å¼</strong>ï¼š</p><ol><li><code>ChannelHandlerContext.writeAndFlush(msg)</code>ï¼šä¸ç”¨ç»è¿‡<code>TailConext</code>, ä»è¯¥<code>handler</code>å¼€å§‹å¾€å‰æ‰§è¡Œ<code>OutboundChannelHandler</code>ï¼Œæ€§èƒ½æ›´å¥½ä¸€äº›</li><li><code>ChannelHandlerContext.pipeline().writeAndFlush(msg)</code>ï¼šä»<code>TailConext</code>å¼€å§‹æ‰§è¡Œï¼Œ å¾€å‰æ‰§è¡Œ<code>OutboundChannelHandler</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> AbstractChannelHandlerContext <span class="title">findContextOutbound</span><span class="params">()</span> </span>&#123;</div><div class="line">        AbstractChannelHandlerContext ctx = <span class="keyword">this</span>;</div><div class="line">        do &#123;</div><div class="line">            <span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œæ˜¯å¾€å‰æ‰¾</span></div><div class="line">            ctx = ctx.prev;</div><div class="line">        &#125; <span class="keyword">while</span> (!ctx.outbound);</div><div class="line">        <span class="keyword">return</span> ctx;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><h4 id="EventLoop"><a href="#EventLoop" class="headerlink" title="EventLoop"></a><code>EventLoop</code></h4><p><code>EventLoop</code> æ˜¯äº‹ä»¶å¾ªç¯ï¼Œå¯¹åº”<code>Reactor</code>çº¿ç¨‹ï¼Œä»¥ <code>NioEventLoop</code> ä¸ºä¾‹ï¼Œå®ç°åŸç†æ˜¯ï¼šç»´æŠ¤äº†ä¸€ä¸ªçº¿ç¨‹å’Œä»»åŠ¡é˜Ÿåˆ—ï¼Œæ”¯æŒå¼‚æ­¥æäº¤ä»»åŠ¡ï¼Œçº¿ç¨‹å¯åŠ¨æ—¶ä¼šè°ƒç”¨<code>NioEventLoop</code> çš„ <code>run</code> æ–¹æ³•ï¼Œæ‰§è¡ŒIOä»»åŠ¡å’ŒéIOä»»åŠ¡ï¼Œç”±äº <code>EventLoop</code> æ˜¯å•çº¿ç¨‹ï¼Œå› æ­¤åœ¨ä½¿ç”¨æ—¶è¦æ³¨æ„è€—æ—¶æ“ä½œï¼Œé˜»å¡æ“ä½œéƒ½ä¸è¦æ”¾åˆ° <code>EventLoop</code> ä¸­ï¼Œå…¶é€‚åˆå¤„ç†è€—æ—¶çŸ­å¹¶ä¸”ç®€å•çš„ä»»åŠ¡</p><ul><li><strong>IOä»»åŠ¡</strong>ï¼šå³ <code>selectionKey</code> ä¸­äº‹ä»¶ï¼Œå¦‚ <code>accept</code>ã€<code>connect</code>ã€<code>read</code>ã€<code>write</code>ç­‰ï¼Œç”±<code>processSelectedKeys</code>æ–¹æ³•è§¦å‘ã€‚</li><li><strong>éIOä»»åŠ¡</strong>ï¼šæ·»åŠ åˆ° <code>taskQueue</code> ä¸­çš„ä»»åŠ¡ï¼Œå¦‚å»¶è¿Ÿä»»åŠ¡ï¼Œç”± <code>runAllTasks</code> æ–¹æ³•è§¦å‘ã€‚</li></ul><p>ä¸¤ç§ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æ¯”ç”±å˜é‡ <code>ioRatio</code> æ§åˆ¶ï¼Œé»˜è®¤ä¸º50%ï¼Œåˆ™è¡¨ç¤ºå…è®¸<strong>éIOä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´ä¸IOä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ç›¸ç­‰</strong></p><h4 id="EventLoopGroup"><a href="#EventLoopGroup" class="headerlink" title="EventLoopGroup"></a><code>EventLoopGroup</code></h4><p><code>EventLoopGroup</code>åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ª<code>EventLoop</code>ï¼Œä¸»è¦ç®¡ç†<code>EventLoop</code>çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ç»„çº¿ç¨‹ï¼Œ<strong>æ¯ä¸ªçº¿ç¨‹(<code>EventLoop</code>)å¯ä»¥è´Ÿè´£å¤„ç†å¤šä¸ª<code>Channel</code>ä¸Šçš„äº‹ä»¶ï¼Œè€Œä¸€ä¸ª<code>Channel</code>åªèƒ½æ³¨å†Œäºä¸€ä¸ª<code>EventLoop</code>(é˜²æ­¢çº¿ç¨‹å¹¶å‘é—®é¢˜)</strong></p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://www.lmlphp.com/user/95/article/item/12624/" target="_blank" rel="external">æœ€é€å½»çš„NettyåŸç†æ¶æ„è§£æ</a></p><p><a href="http://www.liuhaihua.cn/archives/530938.html" target="_blank" rel="external">Nettyâ€“Reactoræ¨¡å‹çš„åº”ç”¨</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/12/15/Netty-fix-epoll-bug/" itemprop="url">Netty fix epoll bug</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time itemprop="dateCreated" datetime="2018-12-15T11:52:13+08:00" content="2018-12-15">2018-12-15</time></span></div></header><div class="post-body" itemprop="articleBody"><p><code>JDK NIO</code>çš„<code>epoll bug</code>ï¼Œä¼šå¯¼è‡´<code>Selector</code>ç©ºè½®è¯¢ï¼Œæœ€ç»ˆå¯¼è‡´CPU 100%</p><h3 id="Bugå‡ºç°çš„åŸå› "><a href="#Bugå‡ºç°çš„åŸå› " class="headerlink" title="Bugå‡ºç°çš„åŸå› "></a><strong><code>Bug</code>å‡ºç°çš„åŸå› </strong></h3><p>è‹¥<code>Selector</code>çš„è½®è¯¢ç»“æœä¸€ç›´ä¸ºç©ºï¼Œæ²¡æœ‰æ–°æ¶ˆæ¯å¤„ç†ï¼Œåˆ™å‘ç”Ÿç©ºè½®è¯¢ï¼ŒCPUä½¿ç”¨ç‡100%ï¼ˆåœ¨<code>selector</code>ä¸­ï¼Œå³ä½¿æ˜¯<code>select</code>è½®è¯¢äº‹ä»¶ä¸º0çš„è¯ï¼Œç…§æ ·ä¸æ–­çš„ä»<code>select</code>æœ¬åº”è¯¥é˜»å¡çŠ¶æ€ä¸‹<code>wake up</code>å‡ºæ¥ï¼‰</p><h3 id="Nettyçš„è§£å†³æ–¹æ¡ˆ"><a href="#Nettyçš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="Nettyçš„è§£å†³æ–¹æ¡ˆ"></a><strong><code>Netty</code>çš„è§£å†³æ–¹æ¡ˆ</strong></h3><ul><li>å¯¹<code>Selector</code>çš„<code>select</code>æ“ä½œå‘¨æœŸè¿›è¡Œç»Ÿè®¡ï¼Œæ¯å®Œæˆä¸€æ¬¡ç©ºçš„<code>select</code>æ“ä½œè¿›è¡Œä¸€æ¬¡è®¡æ•°</li><li>è‹¥åœ¨æŸä¸ªå‘¨æœŸå†…è¿ç»­å‘ç”ŸNæ¬¡ç©ºè½®è¯¢ï¼Œåˆ™è§¦å‘äº†<code>epoll</code>æ­»å¾ªç¯bugã€‚</li><li>é‡å»º<code>Selector</code>ï¼Œå°†å‡ºç°bugçš„<code>Selector</code>ä¸Šçš„<code>channel</code>é‡æ–°æ³¨å†Œåˆ°æ–°çš„<code>Selector</code>ä¸Šï¼Œå¹¶å°†åŸæ¥çš„<code>Selector</code>å…³é—­ï¼Œä½¿ç”¨æ–°çš„<code>Selector</code>è¿›è¡Œæ›¿æ¢ã€‚</li></ul><h3 id="JDKæºç åˆ†æï¼š"><a href="#JDKæºç åˆ†æï¼š" class="headerlink" title="JDKæºç åˆ†æï¼š"></a><code>JDK</code>æºç åˆ†æï¼š</h3><p><code>JDK NIO</code>æ‰§è¡Œä»£ç å¦‚ä¸‹ï¼š</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy7ija4ukgj311e0j2q7v.jpg" alt=""></p><p>æ‰§è¡Œ<code>selector.select()</code>æ–¹æ³•è¿”å›keysæ˜¯0ï¼Œæ‰€ä»¥æœ¬åº”è¯¥å¯¹keyå€¼è¿›è¡Œéå†çš„äº‹ä»¶å¤„ç†æ ¹æœ¬æ²¡æœ‰æ‰§è¡Œï¼Œåˆå›åˆ°æœ€ä¸Šé¢çš„<code>while(true)</code>å¾ªç¯ï¼Œå¾ªç¯å¾€å¤ï¼Œä¸æ–­çš„è½®è¯¢ï¼Œç›´åˆ°ç³»ç»Ÿå‡ºç°100%çš„CPUæƒ…å†µï¼Œæœ€ç»ˆå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p><h3 id="Nettyæºç åˆ†æ"><a href="#Nettyæºç åˆ†æ" class="headerlink" title="Nettyæºç åˆ†æ"></a><code>Netty</code>æºç åˆ†æ</h3><p>å…·ä½“ä½ç½®åœ¨å®ç°ç±»<code>NioEventLoop</code>ä¸­ï¼š</p><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fy7jey5qmkj315c0nigso.jpg" alt=""></p><p><code>netty</code>ä¼šåœ¨æ¯æ¬¡è¿›è¡Œ <code>selector.select(timeoutMillis)</code> ä¹‹å‰è®°å½•ä¸€ä¸‹å¼€å§‹æ—¶é—´<code>currentTimeNanos</code>ï¼Œåœ¨<code>select</code>ä¹‹åè®°å½•ä¸€ä¸‹ç»“æŸæ—¶é—´ï¼Œåˆ¤æ–­<code>select</code>æ“ä½œæ˜¯å¦è‡³å°‘æŒç»­äº†<code>timeoutMillis</code>æ—¶é—´ï¼›<code>selectCnt</code>è®°å½•ç©ºè½®è¯¢æ¬¡æ•°</p><h4 id="é‡å»ºselector"><a href="#é‡å»ºselector" class="headerlink" title="é‡å»ºselector"></a>é‡å»º<code>selector</code></h4><p>å½“å‘ç”Ÿ<code>epoll bug</code>ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„<code>Selector</code>ï¼Œå°†å‡ºç°bugçš„<code>Selector</code>ä¸Šçš„<code>channel</code>é‡æ–°æ³¨å†Œåˆ°æ–°çš„<code>Selector</code>ä¸Šï¼Œå…³é—­bugçš„<code>Selector</code>ï¼Œä½¿ç”¨æ–°çš„<code>Selector</code>è¿›è¡Œæ›¿æ¢ :</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy7k5ilf63j31h40u0ahl.jpg" alt=""></p><p><code>Netty</code>çš„è§£å†³ç­–ç•¥ï¼š</p><ul><li>æ ¹æ®è¯¥<code>bug</code>çš„ç‰¹å¾ï¼Œé¦–å…ˆä¾¦æµ‹è¯¥<code>bug</code>æ˜¯å¦å‘ç”Ÿ</li><li>å°†é—®é¢˜<code>Selector</code>ä¸Šæ³¨å†Œçš„<code>Channel</code>è½¬ç§»åˆ°æ–°å»ºçš„<code>Selector</code>ä¸Š</li><li>è€çš„é—®é¢˜<code>Selector</code>å…³é—­ï¼Œä½¿ç”¨æ–°å»ºçš„<code>Selector</code>æ›¿æ¢</li></ul><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://www.cnblogs.com/JAYIT/p/8241634.html" target="_blank" rel="external">NIOçš„epollç©ºè½®è¯¢bug</a></p><p><a href="http://blogxin.cn/2017/03/20/Netty-epollbug/" target="_blank" rel="external">Nettyæºç åˆ†æ è§£å†³NIOçš„epollæ­»å¾ªç¯bug</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article></section><nav class="pagination"> <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a></nav></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview sidebar-panel sidebar-panel-active"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="David"><p class="site-author-name" itemprop="name">David</p><p class="site-description motion-element" itemprop="description">Develop Notes</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">154</span> <span class="site-state-item-name">æ—¥å¿—</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags"><span class="site-state-item-count">37</span> <span class="site-state-item-name">æ ‡ç­¾</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/zsr" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/u/2214956781" target="_blank" title="Weibo"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2019</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">David</span></div><div class="powered-by"> ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div><div class="theme-info"> ä¸»é¢˜ - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),s=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!0,s=r.title.trim().toLowerCase(),n=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),i=r.url,o=-1,l=-1,p=-1;if(""!=s&&""!=n&&a.forEach(function(e,t){o=s.indexOf(e),l=n.indexOf(e),o<0&&l<0?c=!1:(l<0&&(l=0),0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+i+"' class='search-result-title'>"+s+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;u<0&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),s.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script></body></html>