<!doctype html><html class="theme-next pisces use-motion"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css"><meta name="keywords" content="JVM,"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1"><meta name="description" content="èƒŒæ™¯åŒäº‹çš„é¡¹ç›®voice-analyzer-webçº¿ä¸Šç¯å¢ƒï¼Œç›‘æ§ç³»ç»Ÿé¢‘ç¹æŠ¥è­¦å‘ç”ŸJVMFullGCå¡é¡¿æ¬¡æ•°é¢‘ç¹(4å°æœåŠ¡å™¨éƒ½æŠ¥è­¦)ï¼Œç›‘æ§æ¯10åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡ï¼Œè¯¥æ—¶é—´æ®µå†…Full GCè¶…è¿‡10æ¬¡å°±ä¼šæŠ¥è­¦ã€‚
çº¿ä¸ŠJVMå‚æ•°(æœ‰çœç•¥)1XX:MaxMetaspaceSize=256M, -Xms4g, -Xmx4g, -Xmn1g, -Xss256k, -XX:SurvivorRatio=8, -XX:M"><meta property="og:type" content="article"><meta property="og:title" content="çº¿ä¸Šé¢‘ç¹Full GCåˆ†æ"><meta property="og:url" content="http://zsr.github.io/2019/03/22/çº¿ä¸Šé¢‘ç¹Full-GCåˆ†æ/index.html"><meta property="og:site_name" content="Hello Coder"><meta property="og:description" content="èƒŒæ™¯åŒäº‹çš„é¡¹ç›®voice-analyzer-webçº¿ä¸Šç¯å¢ƒï¼Œç›‘æ§ç³»ç»Ÿé¢‘ç¹æŠ¥è­¦å‘ç”ŸJVMFullGCå¡é¡¿æ¬¡æ•°é¢‘ç¹(4å°æœåŠ¡å™¨éƒ½æŠ¥è­¦)ï¼Œç›‘æ§æ¯10åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡ï¼Œè¯¥æ—¶é—´æ®µå†…Full GCè¶…è¿‡10æ¬¡å°±ä¼šæŠ¥è­¦ã€‚
çº¿ä¸ŠJVMå‚æ•°(æœ‰çœç•¥)1XX:MaxMetaspaceSize=256M, -Xms4g, -Xmx4g, -Xmn1g, -Xss256k, -XX:SurvivorRatio=8, -XX:M"><meta property="og:image" content="https://ws4.sinaimg.cn/large/006tKfTcgy1g1ea5brnq0j317o0ke411.jpg"><meta property="og:image" content="https://ws3.sinaimg.cn/large/006tKfTcgy1g1f0vdxwdqj31jc0hwwka.jpg"><meta property="og:image" content="https://ws4.sinaimg.cn/large/006tKfTcgy1g1f1ip6yf2j31gh0u0n4r.jpg"><meta property="og:image" content="https://ws4.sinaimg.cn/large/006tKfTcgy1g1f27thkyjj30vm042jsn.jpg"><meta property="og:updated_time" content="2019-03-25T10:02:25.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="çº¿ä¸Šé¢‘ç¹Full GCåˆ†æ"><meta name="twitter:description" content="èƒŒæ™¯åŒäº‹çš„é¡¹ç›®voice-analyzer-webçº¿ä¸Šç¯å¢ƒï¼Œç›‘æ§ç³»ç»Ÿé¢‘ç¹æŠ¥è­¦å‘ç”ŸJVMFullGCå¡é¡¿æ¬¡æ•°é¢‘ç¹(4å°æœåŠ¡å™¨éƒ½æŠ¥è­¦)ï¼Œç›‘æ§æ¯10åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡ï¼Œè¯¥æ—¶é—´æ®µå†…Full GCè¶…è¿‡10æ¬¡å°±ä¼šæŠ¥è­¦ã€‚
çº¿ä¸ŠJVMå‚æ•°(æœ‰çœç•¥)1XX:MaxMetaspaceSize=256M, -Xms4g, -Xmx4g, -Xmn1g, -Xss256k, -XX:SurvivorRatio=8, -XX:M"><meta name="twitter:image" content="https://ws4.sinaimg.cn/large/006tKfTcgy1g1ea5brnq0j317o0ke411.jpg"><script type="text/javascript" id="hexo.configuration">var NexT=window.NexT||{},CONFIG={scheme:"Pisces",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:0,author:"åšä¸»"}}</script><link rel="canonical" href="http://zsr.github.io/2019/03/22/çº¿ä¸Šé¢‘ç¹Full-GCåˆ†æ/"><title> çº¿ä¸Šé¢‘ç¹Full GCåˆ†æ | Hello Coder</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-81477846-1","auto"),ga("send","pageview")</script><div class="container one-collumn sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Hello Coder</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> é¦–é¡µ</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> å½’æ¡£</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> æ ‡ç­¾</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> æœç´¢</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div> <span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> çº¿ä¸Šé¢‘ç¹Full GCåˆ†æ</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time itemprop="dateCreated" datetime="2019-03-22T14:48:02+08:00" content="2019-03-22">2019-03-22</time></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>åŒäº‹çš„é¡¹ç›®<code>voice-analyzer-web</code>çº¿ä¸Šç¯å¢ƒï¼Œç›‘æ§ç³»ç»Ÿé¢‘ç¹æŠ¥è­¦<strong>å‘ç”ŸJVMFullGCå¡é¡¿æ¬¡æ•°é¢‘ç¹</strong>(4å°æœåŠ¡å™¨éƒ½æŠ¥è­¦)ï¼Œç›‘æ§æ¯10åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡ï¼Œè¯¥æ—¶é—´æ®µå†…<code>Full GC</code>è¶…è¿‡10æ¬¡å°±ä¼šæŠ¥è­¦ã€‚</p><h3 id="çº¿ä¸ŠJVMå‚æ•°-æœ‰çœç•¥"><a href="#çº¿ä¸ŠJVMå‚æ•°-æœ‰çœç•¥" class="headerlink" title="çº¿ä¸ŠJVMå‚æ•°(æœ‰çœç•¥)"></a>çº¿ä¸ŠJVMå‚æ•°(æœ‰çœç•¥)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">XX:MaxMetaspaceSize=256M, -Xms4g, -Xmx4g, -Xmn1g, -Xss256k, -XX:SurvivorRatio=8, -XX:MaxTenuringThreshold=8, -XX:ParallelGCThreads=8, -XX:+UseConcMarkSweepGC, -XX:+UseParNewGC, -XX:+DisableExplicitGC, -XX:+CMSParallelRemarkEnabled, -XX:+CMSClassUnloadingEnabled, -XX:CMSInitiatingOccupancyFraction=70, -XX:CMSFullGCsBeforeCompaction=5, -XX:+UseCMSCompactAtFullCollection, -XX:+CMSScavengeBeforeRemark, -XX:+HeapDumpOnOutOfMemoryError, -Xloggc:/usr/local/webserver/voice-analyzer-web/logs/gc.log, -XX:+UseGCLogFileRotation, -XX:NumberOfGCLogFiles=10, -XX:GCLogFileSize=10M, -XX:+PrintGCDetails, -XX:+PrintGCDateStamps, -XX:+PrintGCApplicationStoppedTime, -XX:+PrintGCApplicationConcurrentTime, -, -XX:HeapDumpPath=/usr/local/webserver/voice-analyzer-web/logs/voice-analyzer-web.hprof</div></pre></td></tr></table></figure><p>åˆ†é…äº†4GBå †å†…å­˜ï¼Œå¹´è½»ä»£1GBï¼Œè€å¹´ä»£3GBï¼Œ<code>eden</code>åŒº800Mï¼Œæ¯ä¸ª<code>Survivor</code>åŒº100Mï¼Œè€å¹´ä»£å ç”¨ç‡è¾¾åˆ°70%(2.1Gå·¦å³)æ‰§è¡Œ<code>CMS GC</code></p><h3 id="æ—¥å¿—åˆ†æ"><a href="#æ—¥å¿—åˆ†æ" class="headerlink" title="æ—¥å¿—åˆ†æ"></a>æ—¥å¿—åˆ†æ</h3><h4 id="åˆæ­¥åˆ†ægc-log"><a href="#åˆæ­¥åˆ†ægc-log" class="headerlink" title="åˆæ­¥åˆ†ægc.log"></a>åˆæ­¥åˆ†æ<code>gc.log</code></h4><p>æ‰¾ä¸€å°çº¿ä¸Šæœºå™¨ä¸‹è½½<code>gc.log</code>(5Må¤§å°)åˆ°æœ¬åœ°ï¼Œæ¨èåœ¨çº¿å›¾åƒåŒ–åˆ†æ<code>gc</code>åœ°å€<a href="[https://www.gceasy.io](https://www.gceasy.io/">geceasy</a>)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">2019-03-21T11:19:41.609+0800: 1086345.976: [GC (Allocation Failure) 2019-03-21T11:19:41.609+0800: 1086345.976: [ParNew: 873168K-&gt;36622K(943744K), 0.0312849 secs] 3074543K-&gt;2238776K(4089472K), 0.0316707 secs] [Times: user=0.14 sys=0.00, real=0.04 secs] </div><div class="line">2019-03-21T11:19:41.641+0800: 1086346.008: Total time for which application threads were stopped: 0.0339016 seconds, Stopping threads took: 0.0002451 seconds</div><div class="line">2019-03-21T11:19:41.641+0800: 1086346.008: Application time: 0.0000710 seconds</div><div class="line">2019-03-21T11:19:41.643+0800: 1086346.010: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2202154K(3145728K)] 2238847K(4089472K), 0.0057407 secs] [Times: user=0.02 sys=0.00, real=0.00 secs] </div><div class="line">2019-03-21T11:19:41.649+0800: 1086346.015: Total time for which application threads were stopped: 0.0076999 seconds, Stopping threads took: 0.0002899 seconds</div><div class="line">2019-03-21T11:19:41.649+0800: 1086346.016: [CMS-concurrent-mark-start]</div><div class="line">2019-03-21T11:19:41.915+0800: 1086346.282: [CMS-concurrent-mark: 0.266/0.266 secs] [Times: user=0.64 sys=0.01, real=0.27 secs] </div><div class="line">2019-03-21T11:19:41.915+0800: 1086346.282: [CMS-concurrent-preclean-start]</div><div class="line">2019-03-21T11:19:41.968+0800: 1086346.335: [CMS-concurrent-preclean: 0.049/0.053 secs] [Times: user=0.06 sys=0.00, real=0.05 secs] </div><div class="line">2019-03-21T11:19:41.968+0800: 1086346.335: [CMS-concurrent-abortable-preclean-start]</div><div class="line">2019-03-21T11:19:45.263+0800: 1086349.630: Application time: 3.6144054 seconds</div><div class="line">2019-03-21T11:19:45.268+0800: 1086349.635: Total time for which application threads were stopped: 0.0049627 seconds, Stopping threads took: 0.0002311 seconds</div><div class="line">2019-03-21T11:19:45.268+0800: 1086349.635: Application time: 0.0000508 seconds</div><div class="line">2019-03-21T11:19:45.269+0800: 1086349.636: Total time for which application threads were stopped: 0.0010917 seconds, Stopping threads took: 0.0001300 seconds</div><div class="line"> CMS: abort preclean due to time 2019-03-21T11:19:47.067+0800: 1086351.434: [CMS-concurrent-abortable-preclean: 4.876/5.099 secs] [Times: user=6.58 sys=0.02, real=5.10 secs] </div><div class="line">2019-03-21T11:19:47.067+0800: 1086351.434: Application time: 1.7978130 seconds</div><div class="line">2019-03-21T11:19:47.069+0800: 1086351.436: [GC (CMS Final Remark) [YG occupancy: 51879 K (943744 K)]2019-03-21T11:19:47.069+0800: 1086351.436: [GC (CMS Final Remark) 2019-03-21T11:19:47.069+0800: 1086351.436: [ParNew: 51879K-&gt;23393K(943744K), 0.0156467 secs] 2254034K-&gt;2226423K(4089472K), 0.0159200 secs] [Times: user=0.12 sys=0.00, real=0.02 secs] </div><div class="line">2019-03-21T11:19:47.085+0800: 1086351.452: [Rescan (parallel) , 0.0106023 secs]2019-03-21T11:19:47.096+0800: 1086351.462: [weak refs processing, 0.0000353 secs]2019-03-21T11:19:47.096+0800: 1086351.462: [class unloading, 0.0421021 secs]2019-03-21T11:19:47.138+0800: 1086351.505: [scrub symbol table, 0.0157111 secs]2019-03-21T11:19:47.153+0800: 1086351.520: [scrub string table, 0.0014866 secs][1 CMS-remark: 2203030K(3145728K)] 2226423K(4089472K), 0.0887818 secs] [Times: user=0.26 sys=0.01, real=0.09 secs] </div><div class="line">2019-03-21T11:19:47.158+0800: 1086351.525: Total time for which application threads were stopped: 0.0908702 seconds, Stopping threads took: 0.0002256 seconds</div><div class="line">2019-03-21T11:19:47.158+0800: 1086351.525: [CMS-concurrent-sweep-start]</div><div class="line">2019-03-21T11:19:47.350+0800: 1086351.717: [CMS-concurrent-sweep: 0.192/0.192 secs] [Times: user=0.31 sys=0.00, real=0.20 secs] </div><div class="line">2019-03-21T11:19:47.351+0800: 1086351.717: [CMS-concurrent-reset-start]</div><div class="line">2019-03-21T11:19:47.356+0800: 1086351.723: [CMS-concurrent-reset: 0.005/0.005 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] </div><div class="line">2019-03-21T11:19:48.158+0800: 1086352.525: Application time: 1.0000965 seconds</div><div class="line">2019-03-21T11:19:48.160+0800: 1086352.527: Total time for which application threads were stopped: 0.0019235 seconds, Stopping threads took: 0.0002317 seconds</div><div class="line">2019-03-21T11:19:49.356+0800: 1086353.723: Application time: 1.1961818 seconds</div><div class="line">2019-03-21T11:19:49.358+0800: 1086353.725: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2202654K(3145728K)] 2234684K(4089472K), 0.0023390 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] </div><div class="line">2019-03-21T11:19:49.360+0800: 1086353.727: Total time for which application threads were stopped: 0.0043086 seconds, Stopping threads took: 0.0002062 seconds</div><div class="line">2019-03-21T11:19:49.360+0800: 1086353.727: [CMS-concurrent-mark-start]</div><div class="line">2019-03-21T11:19:49.623+0800: 1086353.990: [CMS-concurrent-mark: 0.262/0.262 secs] [Times: user=0.55 sys=0.00, real=0.27 secs] </div><div class="line">2019-03-21T11:19:49.623+0800: 1086353.990: [CMS-concurrent-preclean-start]</div><div class="line">2019-03-21T11:19:49.689+0800: 1086354.056: [CMS-concurrent-preclean: 0.062/0.066 secs] [Times: user=0.10 sys=0.00, real=0.06 secs]</div></pre></td></tr></table></figure><p>è§‚å¯Ÿé¢‘ç¹<code>CMS GC</code>ç›¸é‚»é—´éš”æ—¶é—´8ç§’å·¦å³ï¼Œæ£€æŸ¥<code>CMS GC</code>å›æ”¶å‰åè€å¹´ä»£å†…å­˜ä½¿ç”¨æƒ…å†µï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2019-03-21T11:19:41.643+0800: 1086346.010: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2202154K(3145728K)] 2238847K(4089472K), 0.0057407 secs] [Times: user=0.02 sys=0.00, real=0.00 secs] </div><div class="line">2019-03-21T11:19:49.358+0800: 1086353.725: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2202654K(3145728K)] 2234684K(4089472K), 0.0023390 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]</div></pre></td></tr></table></figure><p>è€å¹´ä»£å®¹é‡ä¸º3145728Kï¼Œç¬¬ä¸€æ¬¡åœ¨ä½¿ç”¨äº†2202154Kæ—¶è§¦å‘äº†<code>CMS GC</code>åˆå§‹æ ‡è®°æ“ä½œï¼Œç¬¬äºŒæ¬¡åœ¨ä½¿ç”¨äº†2202654Kåè§¦å‘<code>CMS GC</code>åˆå§‹æ ‡è®°æ“ä½œï¼›2æ¬¡<code>CMS GC</code>ä¹‹é—´è€å¹´ä»£åè€Œå¢åŠ äº†0.5Må¤§å°ï¼Œåˆæ­¥æ€€ç–‘æ–¹å‘ï¼š</p><ul><li><code>CMSInitiatingOccupancyFraction</code>æ¯”ä¾‹å¤§å°ï¼Œå¯¼è‡´é¢‘ç¹è§¦å‘</li><li>è¯¥æ®µæ—¶é—´æœ‰å¤§é‡å†…å­˜è½¬ç§»åˆ°è€å¹´ä»£</li><li>å †å†…å­˜æ³„æ¼</li></ul><p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1g1ea5brnq0j317o0ke411.jpg" alt=""></p><p>è¿™å¼ å›¾æ¯”è¾ƒç›´è§‚å±•ç¤ºè€å¹´ä»£å†…å­˜ä¸€ç›´ç»´æŒåœ¨2.1Gå·¦å³ï¼Œ<code>GC</code>å‰åå¹¶æ²¡æœ‰é™ä½è€å¹´ä»£å¤§å°ï¼Œè€Œä¸”è¿™æ®µæ—¶é—´å¹¶æ²¡æœ‰å¤§é‡å¹¶å‘è¯·æ±‚ï¼Œæ€€ç–‘å †å†…å­˜æ³„æ¼ã€‚</p><h4 id="åˆ†æheap-dump"><a href="#åˆ†æheap-dump" class="headerlink" title="åˆ†æheap dump"></a>åˆ†æ<code>heap dump</code></h4><p>é€‰æ‹©ä¸€å°æœåŠ¡å™¨ï¼Œè”ç³»è¿ç»´<code>dump heap</code>(2.4G)ï¼Œé‡å¯å…¨éƒ¨æœåŠ¡å™¨(å†…å­˜ç›´çº¿æ‰ä¸‹æ¥ï¼Œè€å¹´ä»£200Mã€‚ã€‚ã€‚)</p><p>ä½¿ç”¨å·¥å…·<code>VisualVm</code>æˆ–è€…<code>Eclipse MAT</code>åˆ†æ<code>dump</code>æ—¥å¿—</p><h4 id="ä½¿ç”¨VisualVM"><a href="#ä½¿ç”¨VisualVM" class="headerlink" title="ä½¿ç”¨VisualVM"></a>ä½¿ç”¨<code>VisualVM</code></h4><ul><li>æ£€æŸ¥å †å†…å­˜å¤§å¯¹è±¡ï¼š</li></ul><p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1g1f0vdxwdqj31jc0hwwka.jpg" alt=""></p><p>å¯è§å…±æœ‰377094ä¸ª<code>double[]</code>æ•°ç»„å æœ‰å†…å­˜2Gå·¦å³ï¼Œ<code>retained size</code>æ˜¯è¯¥å¯¹è±¡è¢«GCä¹‹åæ‰€èƒ½å›æ”¶åˆ°å†…å­˜çš„æ€»å’Œï¼›æ€€ç–‘<code>double[]</code>å¯¹è±¡æ³„æ¼ï¼Œæ²¡æœ‰è¢«å›æ”¶</p><ul><li>æŸ¥çœ‹è¯¥å¯¹è±¡çš„<code>GC Root</code>ï¼š</li></ul><p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1g1f1ip6yf2j31gh0u0n4r.jpg" alt=""></p><p>ä¸Šå›¾å¯ä»¥çœ‹å‡ºè¯¥<code>double[]</code>è¢«<code>DataBuffer</code>ç›´æ¥å¼•ç”¨ï¼Œæœ€åè¢«ç¼“å­˜åœ¨<code>Guava LocalCache</code>ä¸­ï¼›ä»<code>GC Root</code>å¯ä»¥çœ‹å‡ºï¼Œæœ‰<code>ScheudleTask</code>(<code>DataPublisher</code>ä¸­åˆ›å»º)å¼•ç”¨äº†è¯¥å¯¹è±¡</p><h3 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h3><ul><li>è¿›å…¥<code>DataPublisher</code>ç±»ä¸­ï¼Œæ£€æŸ¥<code>ScheudleTask</code>åˆ›å»ºè¿‡ç¨‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (future == <span class="keyword">null</span>) &#123;</div><div class="line">           Runnable task = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                                   <span class="keyword">try</span> &#123;</div><div class="line">                                     <span class="comment">// ä¸»è¦åšè®¡ç®—ç»Ÿè®¡æ•°æ®</span></div><div class="line">                                      accumulator.publish();</div><div class="line">                                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                                       handleException(e);</div><div class="line">                                   &#125;</div><div class="line">                               &#125;</div><div class="line">                           &#125;;</div><div class="line">           <span class="comment">// ä»ä¸Šä¸‹æ–‡çœ‹ï¼Œå»¶è¿Ÿ1ç§’å®šæœŸæ‰§è¡Œä¸€æ¬¡</span></div><div class="line">           future = getExecutor().scheduleWithFixedDelay(task,</div><div class="line">                                                         delayMillis, delayMillis,</div><div class="line">                                                         TimeUnit.MILLISECONDS);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> ScheduledExecutorService <span class="title">getExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (sharedExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">           sharedExecutor = Executors.newScheduledThreadPool(<span class="number">1</span>, <span class="keyword">new</span> PublishThreadFactory());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> sharedExecutor;</div><div class="line">   &#125;</div></pre></td></tr></table></figure><ul><li>é€†å‘æ£€æŸ¥<code>start()</code>è°ƒç”¨</li></ul><p>ç”±<code>ServerStats</code>ç±»<code>initialize</code>æ–¹æ³•è§¦å‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">       serverFailureCounts = <span class="keyword">new</span> MeasuredRate(failureCountSlidingWindowInterval);</div><div class="line">       requestCountInWindow = <span class="keyword">new</span> MeasuredRate(<span class="number">300000L</span>);</div><div class="line">       <span class="keyword">if</span> (publisher == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">// DataBufferå®é™…å­˜åœ¨äºDataDistributionä¸­ï¼ŒbufferSize=1000</span></div><div class="line">           dataDist = <span class="keyword">new</span> DataDistribution(getBufferSize(), PERCENTS);</div><div class="line">           <span class="comment">// DataPublisheré—´æ¥å¼•ç”¨äº†DataBuffer</span></div><div class="line">           publisher = <span class="keyword">new</span> DataPublisher(dataDist, getPublishIntervalMillis());</div><div class="line">           <span class="comment">// è§¦å‘è°ƒç”¨</span></div><div class="line">           publisher.start();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">this</span>.server = server;</div><div class="line">   &#125;</div></pre></td></tr></table></figure><ul><li>é€†å‘æ£€æŸ¥<code>initialize()</code>è°ƒç”¨</li></ul><p>è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1g1f27thkyjj30vm042jsn.jpg" alt=""></p><p>ç”±<code>LoadBalancerStats</code>ç±»<code>createServerStats</code>æ–¹æ³•è§¦å‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ServerStats <span class="title">createServerStats</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">        <span class="comment">// åˆ›å»ºServerStatså¹¶åˆå§‹åŒ–</span></div><div class="line">        ServerStats ss = <span class="keyword">new</span> ServerStats(<span class="keyword">this</span>);</div><div class="line">        ss.setBufferSize(<span class="number">1000</span>);</div><div class="line">        ss.setPublishInterval(<span class="number">1000</span>);                   </div><div class="line">        ss.initialize(server);</div><div class="line">        <span class="keyword">return</span> ss;        </div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> ServerStats <span class="title">getServerStats</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// ä»localcacheç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœæ²¡æœ‰</span></div><div class="line">            <span class="comment">// åˆ™è°ƒç”¨createServerStatsåˆ›å»ºServerStatså¹¶ç¼“å­˜</span></div><div class="line">            <span class="keyword">return</span> serverStatsCache.get(server);</div><div class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">            ServerStats stats = createServerStats(server);</div><div class="line">            serverStatsCache.asMap().putIfAbsent(server, stats);</div><div class="line">            <span class="keyword">return</span> serverStatsCache.asMap().get(server);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"> <span class="comment">// localcacheåœ¨è¿™é‡Œã€‚ã€‚ã€‚ï¼Œkeyæ˜¯Server, valueæ˜¯ServerStats</span></div><div class="line"> <span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;Server, ServerStats&gt; serverStatsCache = </div><div class="line">        CacheBuilder.newBuilder()</div><div class="line">            .expireAfterAccess(SERVERSTATS_EXPIRE_MINUTES.get(), TimeUnit.MINUTES)</div><div class="line">            .removalListener(<span class="keyword">new</span> RemovalListener&lt;Server, ServerStats&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;Server, ServerStats&gt; notification)</span> </span>&#123;</div><div class="line">                    notification.getValue().close();</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            .build(</div><div class="line">                <span class="keyword">new</span> CacheLoader&lt;Server, ServerStats&gt;() &#123;</div><div class="line">                    <span class="comment">// ç¼“å­˜æ²¡æœ‰åˆ™åˆ›å»ºServerStats</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> ServerStats <span class="title">load</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> createServerStats(server);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡º<code>bufferSize=1000</code>ï¼Œ<code>Heap dump</code>ä¸­æ¯ä¸ª<code>double[]</code>å…ƒç´ ä¹Ÿæ˜¯1000ï¼›è€Œä¸”ï¼Œå®šæ—¶ä»»åŠ¡æ—¶é—´é—´éš”ä¸º1ç§’</p><p><strong>ä»ç¼“å­˜<code>localcache</code>çš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœå…ƒç´ ä¸€ç›´å¢åŠ ï¼Œè¯´æ˜ä¸€ç›´æœ‰æ–°çš„<code>Server</code>è¢«åˆ›å»ºå¹¶æ·»åŠ åˆ°ç¼“å­˜ä¸­ï¼›ä½†æ˜¯æ®åŒäº‹äº†è§£æˆ‘ä»¬çš„<code>Server</code>åªæœ‰10æ¥ä¸ªï¼Œç¼“å­˜æ­£å¸¸ä¸ä¼šä¸€ç›´å¢é•¿ï¼›æ€€ç–‘æ˜¯å¦ä»£ç é—®é¢˜å¯¼è‡´ä¸åœåˆ›å»ºæ–°çš„<code>Server</code>?</strong></p><ul><li>æ£€æŸ¥<code>getServerStats</code>è°ƒç”¨å…³ç³»</li></ul><p>å…¥å£è°ƒç”¨ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">(<span class="keyword">final</span> String path, Map&lt;String, Object&gt; param, Integer uploadType)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> LoadBalancerCommand.&lt;String&gt; builder().withLoadBalancer(loadBalancer).build()</div><div class="line">          .submit(<span class="keyword">new</span> ServerOperation&lt;String&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;String&gt; <span class="title">call</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">              URL url;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                String s = HttpClientUtil.post(<span class="string">"http://"</span> + server.getHost() + <span class="string">":"</span> + server.getPort() + path, param);</div><div class="line">                <span class="keyword">return</span> Observable.just(s);</div><div class="line">              &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                logger.info(<span class="string">"python identify voice failed! host &#123;&#125;"</span>, server.getHost());</div><div class="line">                <span class="keyword">return</span> Observable.error(e);</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;).toBlocking().first();</div><div class="line">  &#125;</div></pre></td></tr></table></figure><p>é‡ç‚¹è§‚å¯Ÿ<code>LoadBalancerCommand.submit()</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> Observable&lt;T&gt; <span class="title">submit</span><span class="params">(<span class="keyword">final</span> ServerOperation&lt;T&gt; operation)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// Use the load balancer</span></div><div class="line">        Observable&lt;T&gt; o = </div><div class="line">                (server == <span class="keyword">null</span> ? selectServer() : Observable.just(server))</div><div class="line">                .concatMap(<span class="keyword">new</span> Func1&lt;Server, Observable&lt;T&gt;&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="comment">// Called for each server being selected</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> Observable&lt;T&gt; <span class="title">call</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">                        context.setServer(server);</div><div class="line">                        <span class="comment">// getServerStatsçš„å…¥å£åœ¨è¿™é‡Œã€‚ã€‚ã€‚</span></div><div class="line">                        <span class="keyword">final</span> ServerStats stats = loadBalancerContext.getServerStats(server);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>è§‚å¯Ÿ<code>LoadBalancerContext.getServerStats()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ServerStats <span class="title">getServerStats</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">       ServerStats serverStats = <span class="keyword">null</span>;</div><div class="line">       <span class="comment">// LoadBalancerContextæŒæœ‰LoadBalancerå¯¹è±¡</span></div><div class="line">       ILoadBalancer lb = <span class="keyword">this</span>.getLoadBalancer();</div><div class="line">       <span class="keyword">if</span> (lb <span class="keyword">instanceof</span> AbstractLoadBalancer)&#123;</div><div class="line">           <span class="comment">// LoadBalanceræŒæœ‰LoadBalancerStatså¯¹è±¡</span></div><div class="line">           LoadBalancerStats lbStats = ((AbstractLoadBalancer) lb).getLoadBalancerStats();</div><div class="line">           serverStats = lbStats.getSingleServerStat(server);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> serverStats;</div><div class="line">   &#125;</div></pre></td></tr></table></figure><ul><li>æ£€æŸ¥<code>LoadBalancer</code>åˆ›å»ºè¿‡ç¨‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    initLoadbalance();</div><div class="line">    <span class="comment">// æ¯éš”3åˆ†é’Ÿé‡æ–°åˆ›å»ºLoadbalance</span></div><div class="line">    service.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        initLoadbalance();</div><div class="line">      &#125;</div><div class="line">    &#125;, <span class="number">3</span>, <span class="number">3</span>, TimeUnit.MINUTES);</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">   * åˆå§‹åŒ–æ™®é€šæœºå™¨è´Ÿè½½å‡è¡¡ç­–ç•¥</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initLoadbalance</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      List&lt;Server&gt; serverList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">      String machine = footballConfigFamilyService.getConfigMap().get(<span class="string">"voice-analyze"</span>);</div><div class="line">      List&lt;Weight&gt; list = JSON.parseObject(machine, <span class="keyword">new</span> TypeReference&lt;List&lt;Weight&gt;&gt;() &#123;</div><div class="line">      &#125;);</div><div class="line">      <span class="comment">// serverListåªæœ‰10æ¥ä¸ª</span></div><div class="line">      <span class="keyword">for</span> (Weight weight : list) &#123;</div><div class="line">        serverList.add(<span class="keyword">new</span> WeightServer(weight.getHost(), weight.getPort(), weight.getWeight()));</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// åˆ›å»ºloadBalancer</span></div><div class="line">      loadBalancer = LoadBalancerBuilder.newBuilder().withRule(<span class="keyword">new</span> WeightedRule())</div><div class="line">          .buildFixedServerListLoadBalancer(serverList);</div><div class="line">      </div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure><p>è§‚å¯Ÿ<code>LoadBalancerBuilder.buildFixedServerListLoadBalancer()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> BaseLoadBalancer <span class="title">buildFixedServerListLoadBalancer</span><span class="params">(List&lt;T&gt; servers)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (rule == <span class="keyword">null</span>) &#123;</div><div class="line">            rule = createRuleFromConfig(config);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// åˆ›å»ºBaseLoadBalancer</span></div><div class="line">        BaseLoadBalancer lb = <span class="keyword">new</span> BaseLoadBalancer(config, rule, ping);</div><div class="line">        <span class="comment">// è®¾ç½®è´Ÿè½½å‡è¡¡æœåŠ¡å™¨åˆ—è¡¨</span></div><div class="line">        lb.setServersList(servers);</div><div class="line">        <span class="keyword">return</span> lb;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">BaseLoadBalancer</span><span class="params">(IClientConfig config, IRule rule, IPing ping)</span> </span>&#123;</div><div class="line">        initWithConfig(config, rule, ping);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">initWithConfig</span><span class="params">(IClientConfig clientConfig, IRule rule, IPing ping)</span> </span>&#123;</div><div class="line">        setLoadBalancerStats(<span class="keyword">new</span> LoadBalancerStats(clientName));</div><div class="line">        rule.setLoadBalancer(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (ping <span class="keyword">instanceof</span> AbstractLoadBalancerPing) &#123;</div><div class="line">            ((AbstractLoadBalancerPing) ping).setLoadBalancer(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>ä»ä¸Šé¢ä»£ç çœ‹ï¼Œæ¯éš”3åˆ†é’Ÿå°±ä¼šé‡æ–°åˆ›å»ºæ–°çš„<code>LoadBalancer</code>ï¼Œæ¯åˆ›å»ºä¸€ä¸ª<code>LoadBalancer</code>ï¼Œéƒ½ä¼šåˆ›å»º<code>LoadBalancerStats</code>ä½œä¸º<code>LoadBalancer</code>å±æ€§</p><p>éš¾é“æ¯éš”3åˆ†é’Ÿæ—¶é—´åˆ›å»ºçš„<code>Server</code>å¯¹<code>Guava LocalCache</code>æ¥è¯´éƒ½æ˜¯ä¸åŒçš„å—ï¼Ÿçªƒå–œï¼Œæ„Ÿè§‰é—®é¢˜å·²ç»æ‰¾åˆ°ğŸ˜„</p><p>ç°åœ¨éœ€è¦ç¡®å®š2ä¸ª<code>WeightServer</code>å¯¹è±¡ï¼Œå…·æœ‰ç›¸åŒçš„<code>ip</code>å’Œ<code>port</code>, åœ¨<code>LocalCache</code>ä¸­æ˜¯ä¸€ä¸ªå—ï¼Ÿ</p><ul><li>æ£€æŸ¥<code>WeightServer</code></li></ul><p>å…·ä½“çš„<code>guava cache</code> æºç ä¸å†å™è¿°ï¼Œæ•´ä½“é€»è¾‘è®¾è®¡å‚è€ƒ<code>CurrentHashMap</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.host = host;</div><div class="line">        <span class="keyword">this</span>.port = port;</div><div class="line">        <span class="keyword">this</span>.id = host + <span class="string">":"</span> + port;</div><div class="line">        isAliveFlag = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == obj)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Server))</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        Server svc = (Server) obj;</div><div class="line">        <span class="keyword">return</span> svc.getId().equals(<span class="keyword">this</span>.getId());</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> hash = <span class="number">7</span>;</div><div class="line">        hash = <span class="number">31</span> * hash + (<span class="keyword">null</span> == <span class="keyword">this</span>.getId() ? <span class="number">0</span> : <span class="keyword">this</span>.getId().hashCode());</div><div class="line">        <span class="keyword">return</span> hash;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>ä»ä¸Šé¢çœ‹ï¼Œ2ä¸ª<code>WeightServer</code>å¦‚æœ<code>ip</code>å’Œ<code>port</code>ç›¸åŒï¼Œç»æµ‹è¯•<code>cache</code>å…ƒç´ åªæœ‰ä¸€ä¸ªï¼Œ<code>guava cache</code>è®¤ä¸ºæ˜¯åŒä¸€ä¸ªå…ƒç´ ã€‚å°´å°¬ï¼ŒçŒœé”™äº†ğŸ˜…ã€‚ã€‚ã€‚</p><h4 id="é‡æ–°æ£€æŸ¥ä»£ç "><a href="#é‡æ–°æ£€æŸ¥ä»£ç " class="headerlink" title="é‡æ–°æ£€æŸ¥ä»£ç "></a>é‡æ–°æ£€æŸ¥ä»£ç </h4><p>æ—¢ç„¶<code>heap dump</code>æ˜¾ç¤º<code>cache</code>ä¸­çš„<code>Server</code>åœ¨ä¸åœå¢åŠ ï¼Œå®é™…æƒ…å†µå´æ˜¯ä¸€ä¸ª<code>cache</code>ä¸­åªä¼šæœ‰10æ¥ä¸ª<code>Server</code>ï¼›çªç„¶æƒ³èµ·æ¥ï¼Œ<strong>æ¯ä¸ª<code>LoadBalancerStats</code>å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª<code>cache</code>å¯¹è±¡</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">BaseLoadBalancer</span><span class="params">(IClientConfig config, IRule rule, IPing ping)</span> </span>&#123;</div><div class="line">        initWithConfig(config, rule, ping);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">initWithConfig</span><span class="params">(IClientConfig clientConfig, IRule rule, IPing ping)</span> </span>&#123;</div><div class="line">        setLoadBalancerStats(<span class="keyword">new</span> LoadBalancerStats(clientName));</div><div class="line">        rule.setLoadBalancer(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (ping <span class="keyword">instanceof</span> AbstractLoadBalancerPing) &#123;</div><div class="line">            ((AbstractLoadBalancerPing) ping).setLoadBalancer(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p><strong>åŸå› ï¼šå®šæ—¶ä»»åŠ¡æ‰§è¡Œ<code>initLoadbalance()</code>ï¼Œå¯¼è‡´ä¸åœåˆ›å»ºæ–°çš„<code>LoadBalancer</code>ï¼Œå³<code>LoadBalancerStats</code>ä¸€ç›´å¢åŠ ï¼Œå…¨éƒ¨<code>cache</code>ç¼“å­˜çš„<code>Server</code>ä¹Ÿä¼šå¢åŠ </strong></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ—§çš„<code>cache</code>ä¸ºä»€ä¹ˆä¸è¢«<code>GC</code>å›æ”¶å‘¢ï¼Ÿå›è¿‡å¤´æ¥çœ‹<code>DataPublisher.start()</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (future == <span class="keyword">null</span>) &#123;</div><div class="line">           Runnable task = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                                   <span class="keyword">try</span> &#123;</div><div class="line">                                      accumulator.publish();</div><div class="line">                                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                                       handleException(e);</div><div class="line">                                   &#125;</div><div class="line">                               &#125;</div><div class="line">                           &#125;;</div><div class="line">           future = getExecutor().scheduleWithFixedDelay(task,</div><div class="line">                                                         delayMillis, delayMillis,</div><div class="line">                                                         TimeUnit.MILLISECONDS);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> ScheduledExecutorService <span class="title">getExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (sharedExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">           sharedExecutor = Executors.newScheduledThreadPool(<span class="number">1</span>, <span class="keyword">new</span> PublishThreadFactory());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> sharedExecutor;</div><div class="line">   &#125;</div></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç çœ‹å‡ºï¼Œ<strong>æ¯ä¸ª<code>Server</code>éƒ½å…³è”äº†ä¸€ä¸ªçº¿ç¨‹æ± æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œå¯¼è‡´<code>cache</code>ä¸­<code>Server</code>å¯¹è±¡ä¸€ç›´è¢«å¼•ç”¨ï¼Œ<code>GC</code>ä¸ä¼šå›æ”¶è¿™ç±»å¯¹è±¡ã€‚</strong></p><h4 id="æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼š"><a href="#æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼š" class="headerlink" title="æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼š"></a>æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è¿‡æœŸæ—¶é—´é»˜è®¤30åˆ†é’Ÿ</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;Server, ServerStats&gt; serverStatsCache = </div><div class="line">        CacheBuilder.newBuilder()</div><div class="line">            .expireAfterAccess(SERVERSTATS_EXPIRE_MINUTES.get(), TimeUnit.MINUTES)</div><div class="line">            .removalListener(<span class="keyword">new</span> RemovalListener&lt;Server, ServerStats&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;Server, ServerStats&gt; notification)</span> </span>&#123;</div><div class="line">                    notification.getValue().close();</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            .build(</div><div class="line">                <span class="keyword">new</span> CacheLoader&lt;Server, ServerStats&gt;() &#123;</div><div class="line">                    <span class="comment">// ç¼“å­˜æ²¡æœ‰åˆ™åˆ›å»ºServerStats</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> ServerStats <span class="title">load</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> createServerStats(server);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>guava cache</code>ä½¿ç”¨äº†<code>expireAfterAccess</code>å’Œ<code>removalListener</code>, æˆ‘çŒœ<a href="[https://github.com/Netflix/ribbon](https://github.com/Netflix/ribbon"><code>robbin</code>æ¡†æ¶</a>)ä½œè€…æœ¬æ„æ˜¯ä½¿ç”¨è¿‡æœŸå‡½æ•°ä»¥åŠç›‘å¬å™¨åœ¨<code>Server</code>å¤±æ•ˆåå…³é—­çº¿ç¨‹æ± è¿è¡Œï¼Œé˜²æ­¢çº¿ç¨‹ä¸€ç›´è¿è¡Œï¼›ä½†æ˜¯<code>guava cache</code>çš„è¿‡æœŸåˆ é™¤æ˜¯è¢«åŠ¨çš„ï¼Œå°±æ˜¯è¯´å¦‚æœå…ƒç´ è¿‡æœŸåå†æ¬¡è¢«è®¿é—®ï¼Œä¼šè§¦å‘åˆ é™¤å¹¶é‡æ–°åŠ è½½</p><p><strong>ä»¥è¯¥é¡¹ç›®ä»£ç æ‰§è¡Œæ¥çœ‹ï¼Œåªä¼šä¸€ç›´æ·»åŠ æ–°çš„<code>cache</code>ï¼Œæ—§çš„<code>cache</code>ä¸èƒ½è¢«è®¿é—®ï¼Œå¯¼è‡´ç¼“å­˜å¯¹è±¡ä¸èƒ½é‡Šæ”¾</strong></p><h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><ul><li>é¿å…<code>LoadBalancer</code>ä¸åœçš„åˆ›å»ºï¼Œè¦†ç›–<code>ServerList</code>å³å¯</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initLoadbalance</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      List&lt;Server&gt; serverList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">      String machine = footballConfigFamilyService.getConfigMap().get(<span class="string">"voice-analyze"</span>);</div><div class="line">      List&lt;Weight&gt; list = JSON.parseObject(machine, <span class="keyword">new</span> TypeReference&lt;List&lt;Weight&gt;&gt;() &#123;</div><div class="line">      &#125;);</div><div class="line">      <span class="comment">// serverListåªæœ‰10æ¥ä¸ª</span></div><div class="line">      <span class="keyword">for</span> (Weight weight : list) &#123;</div><div class="line">        serverList.add(<span class="keyword">new</span> WeightServer(weight.getHost(), weight.getPort(), weight.getWeight()));</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// **********ä»£ç ä¿®å¤å¤„************</span></div><div class="line">      <span class="keyword">if</span>(loadBalancer == <span class="keyword">null</span>)&#123;</div><div class="line">        loadBalancer = LoadBalancerBuilder.newBuilder().withRule(<span class="keyword">new</span> WeightedRule())</div><div class="line">          .buildFixedServerListLoadBalancer(serverList);</div><div class="line">      &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="comment">// è¦†ç›–æ—§çš„server list</span></div><div class="line">        loadBalancer.setServersList(serverList);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>ä½¿ç”¨ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œä¸€å®šè¦äº†è§£åº•å±‚è¿è¡Œæœºåˆ¶ã€‚ğŸ˜„</p></div><div></div><div></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/JVM/" rel="tag">#JVM</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/02/13/Netty-æœåŠ¡ç«¯å¯åŠ¨/" rel="next" title="Netty æœåŠ¡ç«¯å¯åŠ¨"><i class="fa fa-chevron-left"></i> Netty æœåŠ¡ç«¯å¯åŠ¨</a></div><div class="post-nav-prev post-nav-item"></div></div></footer></article><div class="post-spread"><div class="jiathis_style"><a class="jiathis_button_tsina"></a><a class="jiathis_button_tqq"></a><a class="jiathis_button_weixin"></a><a class="jiathis_button_cqq"></a><a class="jiathis_button_douban"></a><a class="jiathis_button_renren"></a><a class="jiathis_button_qzone"></a><a class="jiathis_button_kaixin001"></a><a class="jiathis_button_copy"></a><a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script></div></div></div><p>çƒ­è¯„æ–‡ç« </p><div class="ds-top-threads" data-range="weekly" data-num-items="4"></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> æ–‡ç« ç›®å½•</li><li class="sidebar-nav-overview" data-target="site-overview"> ç«™ç‚¹æ¦‚è§ˆ</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="David"><p class="site-author-name" itemprop="name">David</p><p class="site-description motion-element" itemprop="description">Develop Notes</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">154</span> <span class="site-state-item-name">æ—¥å¿—</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags"><span class="site-state-item-count">37</span> <span class="site-state-item-name">æ ‡ç­¾</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/zsr" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/u/2214956781" target="_blank" title="Weibo"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#èƒŒæ™¯"><span class="nav-number">1.</span> <span class="nav-text">èƒŒæ™¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#çº¿ä¸ŠJVMå‚æ•°-æœ‰çœç•¥"><span class="nav-number">2.</span> <span class="nav-text">çº¿ä¸ŠJVMå‚æ•°(æœ‰çœç•¥)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ—¥å¿—åˆ†æ"><span class="nav-number">3.</span> <span class="nav-text">æ—¥å¿—åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#åˆæ­¥åˆ†ægc-log"><span class="nav-number">3.1.</span> <span class="nav-text">åˆæ­¥åˆ†ægc.log</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#åˆ†æheap-dump"><span class="nav-number">3.2.</span> <span class="nav-text">åˆ†æheap dump</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä½¿ç”¨VisualVM"><span class="nav-number">3.3.</span> <span class="nav-text">ä½¿ç”¨VisualVM</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä»£ç åˆ†æ"><span class="nav-number">4.</span> <span class="nav-text">ä»£ç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#é‡æ–°æ£€æŸ¥ä»£ç "><span class="nav-number">4.1.</span> <span class="nav-text">é‡æ–°æ£€æŸ¥ä»£ç </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼š"><span class="nav-number">4.2.</span> <span class="nav-text">æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼š</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è§£å†³æ–¹æ¡ˆ"><span class="nav-number">5.</span> <span class="nav-text">è§£å†³æ–¹æ¡ˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç»“è®º"><span class="nav-number">6.</span> <span class="nav-text">ç»“è®º</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2019</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">David</span></div><div class="powered-by"> ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div><div class="theme-info"> ä¸»é¢˜ - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),s=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!0,s=r.title.trim().toLowerCase(),n=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),i=r.url,o=-1,l=-1,p=-1;if(""!=s&&""!=n&&a.forEach(function(e,t){o=s.indexOf(e),l=n.indexOf(e),o<0&&l<0?c=!1:(l<0&&(l=0),0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+i+"' class='search-result-title'>"+s+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;u<0&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),s.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script></body></html>