<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[çº¿ä¸Šé¢‘ç¹Full GCåˆ†æ]]></title>
      <url>http://zsr.github.io/2019/03/22/%E7%BA%BF%E4%B8%8A%E9%A2%91%E7%B9%81Full-GC%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>åŒäº‹çš„é¡¹ç›®<code>voice-analyzer-web</code>çº¿ä¸Šç¯å¢ƒï¼Œç›‘æ§ç³»ç»Ÿé¢‘ç¹æŠ¥è­¦<strong>å‘ç”ŸJVMFullGCå¡é¡¿æ¬¡æ•°é¢‘ç¹</strong>(4å°æœåŠ¡å™¨éƒ½æŠ¥è­¦)ï¼Œç›‘æ§æ¯10åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡ï¼Œè¯¥æ—¶é—´æ®µå†…<code>Full GC</code>è¶…è¿‡10æ¬¡å°±ä¼šæŠ¥è­¦ã€‚</p>
<h3 id="çº¿ä¸ŠJVMå‚æ•°-æœ‰çœç•¥"><a href="#çº¿ä¸ŠJVMå‚æ•°-æœ‰çœç•¥" class="headerlink" title="çº¿ä¸ŠJVMå‚æ•°(æœ‰çœç•¥)"></a>çº¿ä¸ŠJVMå‚æ•°(æœ‰çœç•¥)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">XX:MaxMetaspaceSize=256M, -Xms4g, -Xmx4g, -Xmn1g, -Xss256k, -XX:SurvivorRatio=8, -XX:MaxTenuringThreshold=8, -XX:ParallelGCThreads=8, -XX:+UseConcMarkSweepGC, -XX:+UseParNewGC, -XX:+DisableExplicitGC, -XX:+CMSParallelRemarkEnabled, -XX:+CMSClassUnloadingEnabled, -XX:CMSInitiatingOccupancyFraction=70, -XX:CMSFullGCsBeforeCompaction=5, -XX:+UseCMSCompactAtFullCollection, -XX:+CMSScavengeBeforeRemark, -XX:+HeapDumpOnOutOfMemoryError, -Xloggc:/usr/local/webserver/voice-analyzer-web/logs/gc.log, -XX:+UseGCLogFileRotation, -XX:NumberOfGCLogFiles=10, -XX:GCLogFileSize=10M, -XX:+PrintGCDetails, -XX:+PrintGCDateStamps, -XX:+PrintGCApplicationStoppedTime, -XX:+PrintGCApplicationConcurrentTime, -, -XX:HeapDumpPath=/usr/local/webserver/voice-analyzer-web/logs/voice-analyzer-web.hprof</div></pre></td></tr></table></figure>
<p>åˆ†é…äº†4GBå †å†…å­˜ï¼Œå¹´è½»ä»£1GBï¼Œè€å¹´ä»£3GBï¼Œ<code>eden</code>åŒº800Mï¼Œæ¯ä¸ª<code>Survivor</code>åŒº100Mï¼Œè€å¹´ä»£å ç”¨ç‡è¾¾åˆ°70%(2.1Gå·¦å³)æ‰§è¡Œ<code>CMS GC</code></p>
<h3 id="æ—¥å¿—åˆ†æ"><a href="#æ—¥å¿—åˆ†æ" class="headerlink" title="æ—¥å¿—åˆ†æ"></a>æ—¥å¿—åˆ†æ</h3><h4 id="åˆæ­¥åˆ†ægc-log"><a href="#åˆæ­¥åˆ†ægc-log" class="headerlink" title="åˆæ­¥åˆ†ægc.log"></a>åˆæ­¥åˆ†æ<code>gc.log</code></h4><p>æ‰¾ä¸€å°çº¿ä¸Šæœºå™¨ä¸‹è½½<code>gc.log</code>(5Må¤§å°)åˆ°æœ¬åœ°ï¼Œæ¨èåœ¨çº¿å›¾åƒåŒ–åˆ†æ<code>gc</code>åœ°å€<a href="[https://www.gceasy.io](https://www.gceasy.io/">geceasy</a>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">2019-03-21T11:19:41.609+0800: 1086345.976: [GC (Allocation Failure) 2019-03-21T11:19:41.609+0800: 1086345.976: [ParNew: 873168K-&gt;36622K(943744K), 0.0312849 secs] 3074543K-&gt;2238776K(4089472K), 0.0316707 secs] [Times: user=0.14 sys=0.00, real=0.04 secs] </div><div class="line">2019-03-21T11:19:41.641+0800: 1086346.008: Total time for which application threads were stopped: 0.0339016 seconds, Stopping threads took: 0.0002451 seconds</div><div class="line">2019-03-21T11:19:41.641+0800: 1086346.008: Application time: 0.0000710 seconds</div><div class="line">2019-03-21T11:19:41.643+0800: 1086346.010: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2202154K(3145728K)] 2238847K(4089472K), 0.0057407 secs] [Times: user=0.02 sys=0.00, real=0.00 secs] </div><div class="line">2019-03-21T11:19:41.649+0800: 1086346.015: Total time for which application threads were stopped: 0.0076999 seconds, Stopping threads took: 0.0002899 seconds</div><div class="line">2019-03-21T11:19:41.649+0800: 1086346.016: [CMS-concurrent-mark-start]</div><div class="line">2019-03-21T11:19:41.915+0800: 1086346.282: [CMS-concurrent-mark: 0.266/0.266 secs] [Times: user=0.64 sys=0.01, real=0.27 secs] </div><div class="line">2019-03-21T11:19:41.915+0800: 1086346.282: [CMS-concurrent-preclean-start]</div><div class="line">2019-03-21T11:19:41.968+0800: 1086346.335: [CMS-concurrent-preclean: 0.049/0.053 secs] [Times: user=0.06 sys=0.00, real=0.05 secs] </div><div class="line">2019-03-21T11:19:41.968+0800: 1086346.335: [CMS-concurrent-abortable-preclean-start]</div><div class="line">2019-03-21T11:19:45.263+0800: 1086349.630: Application time: 3.6144054 seconds</div><div class="line">2019-03-21T11:19:45.268+0800: 1086349.635: Total time for which application threads were stopped: 0.0049627 seconds, Stopping threads took: 0.0002311 seconds</div><div class="line">2019-03-21T11:19:45.268+0800: 1086349.635: Application time: 0.0000508 seconds</div><div class="line">2019-03-21T11:19:45.269+0800: 1086349.636: Total time for which application threads were stopped: 0.0010917 seconds, Stopping threads took: 0.0001300 seconds</div><div class="line"> CMS: abort preclean due to time 2019-03-21T11:19:47.067+0800: 1086351.434: [CMS-concurrent-abortable-preclean: 4.876/5.099 secs] [Times: user=6.58 sys=0.02, real=5.10 secs] </div><div class="line">2019-03-21T11:19:47.067+0800: 1086351.434: Application time: 1.7978130 seconds</div><div class="line">2019-03-21T11:19:47.069+0800: 1086351.436: [GC (CMS Final Remark) [YG occupancy: 51879 K (943744 K)]2019-03-21T11:19:47.069+0800: 1086351.436: [GC (CMS Final Remark) 2019-03-21T11:19:47.069+0800: 1086351.436: [ParNew: 51879K-&gt;23393K(943744K), 0.0156467 secs] 2254034K-&gt;2226423K(4089472K), 0.0159200 secs] [Times: user=0.12 sys=0.00, real=0.02 secs] </div><div class="line">2019-03-21T11:19:47.085+0800: 1086351.452: [Rescan (parallel) , 0.0106023 secs]2019-03-21T11:19:47.096+0800: 1086351.462: [weak refs processing, 0.0000353 secs]2019-03-21T11:19:47.096+0800: 1086351.462: [class unloading, 0.0421021 secs]2019-03-21T11:19:47.138+0800: 1086351.505: [scrub symbol table, 0.0157111 secs]2019-03-21T11:19:47.153+0800: 1086351.520: [scrub string table, 0.0014866 secs][1 CMS-remark: 2203030K(3145728K)] 2226423K(4089472K), 0.0887818 secs] [Times: user=0.26 sys=0.01, real=0.09 secs] </div><div class="line">2019-03-21T11:19:47.158+0800: 1086351.525: Total time for which application threads were stopped: 0.0908702 seconds, Stopping threads took: 0.0002256 seconds</div><div class="line">2019-03-21T11:19:47.158+0800: 1086351.525: [CMS-concurrent-sweep-start]</div><div class="line">2019-03-21T11:19:47.350+0800: 1086351.717: [CMS-concurrent-sweep: 0.192/0.192 secs] [Times: user=0.31 sys=0.00, real=0.20 secs] </div><div class="line">2019-03-21T11:19:47.351+0800: 1086351.717: [CMS-concurrent-reset-start]</div><div class="line">2019-03-21T11:19:47.356+0800: 1086351.723: [CMS-concurrent-reset: 0.005/0.005 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] </div><div class="line">2019-03-21T11:19:48.158+0800: 1086352.525: Application time: 1.0000965 seconds</div><div class="line">2019-03-21T11:19:48.160+0800: 1086352.527: Total time for which application threads were stopped: 0.0019235 seconds, Stopping threads took: 0.0002317 seconds</div><div class="line">2019-03-21T11:19:49.356+0800: 1086353.723: Application time: 1.1961818 seconds</div><div class="line">2019-03-21T11:19:49.358+0800: 1086353.725: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2202654K(3145728K)] 2234684K(4089472K), 0.0023390 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] </div><div class="line">2019-03-21T11:19:49.360+0800: 1086353.727: Total time for which application threads were stopped: 0.0043086 seconds, Stopping threads took: 0.0002062 seconds</div><div class="line">2019-03-21T11:19:49.360+0800: 1086353.727: [CMS-concurrent-mark-start]</div><div class="line">2019-03-21T11:19:49.623+0800: 1086353.990: [CMS-concurrent-mark: 0.262/0.262 secs] [Times: user=0.55 sys=0.00, real=0.27 secs] </div><div class="line">2019-03-21T11:19:49.623+0800: 1086353.990: [CMS-concurrent-preclean-start]</div><div class="line">2019-03-21T11:19:49.689+0800: 1086354.056: [CMS-concurrent-preclean: 0.062/0.066 secs] [Times: user=0.10 sys=0.00, real=0.06 secs]</div></pre></td></tr></table></figure>
<p>è§‚å¯Ÿé¢‘ç¹<code>CMS GC</code>ç›¸é‚»é—´éš”æ—¶é—´8ç§’å·¦å³ï¼Œæ£€æŸ¥<code>CMS GC</code>å›æ”¶å‰åè€å¹´ä»£å†…å­˜ä½¿ç”¨æƒ…å†µï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2019-03-21T11:19:41.643+0800: 1086346.010: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2202154K(3145728K)] 2238847K(4089472K), 0.0057407 secs] [Times: user=0.02 sys=0.00, real=0.00 secs] </div><div class="line">2019-03-21T11:19:49.358+0800: 1086353.725: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2202654K(3145728K)] 2234684K(4089472K), 0.0023390 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]</div></pre></td></tr></table></figure>
<p>è€å¹´ä»£å®¹é‡ä¸º3145728Kï¼Œç¬¬ä¸€æ¬¡åœ¨ä½¿ç”¨äº†2202154Kæ—¶è§¦å‘äº†<code>CMS GC</code>åˆå§‹æ ‡è®°æ“ä½œï¼Œç¬¬äºŒæ¬¡åœ¨ä½¿ç”¨äº†2202654Kåè§¦å‘<code>CMS GC</code>åˆå§‹æ ‡è®°æ“ä½œï¼›2æ¬¡<code>CMS GC</code>ä¹‹é—´è€å¹´ä»£åè€Œå¢åŠ äº†0.5Må¤§å°ï¼Œåˆæ­¥æ€€ç–‘æ–¹å‘ï¼š</p>
<ul>
<li><code>CMSInitiatingOccupancyFraction</code>æ¯”ä¾‹å¤§å°ï¼Œå¯¼è‡´é¢‘ç¹è§¦å‘</li>
<li>è¯¥æ®µæ—¶é—´æœ‰å¤§é‡å†…å­˜è½¬ç§»åˆ°è€å¹´ä»£</li>
<li>å †å†…å­˜æ³„æ¼</li>
</ul>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1g1ea5brnq0j317o0ke411.jpg" alt=""></p>
<p>è¿™å¼ å›¾æ¯”è¾ƒç›´è§‚å±•ç¤ºè€å¹´ä»£å†…å­˜ä¸€ç›´ç»´æŒåœ¨2.1Gå·¦å³ï¼Œ<code>GC</code>å‰åå¹¶æ²¡æœ‰é™ä½è€å¹´ä»£å¤§å°ï¼Œè€Œä¸”è¿™æ®µæ—¶é—´å¹¶æ²¡æœ‰å¤§é‡å¹¶å‘è¯·æ±‚ï¼Œæ€€ç–‘å †å†…å­˜æ³„æ¼ã€‚</p>
<h4 id="åˆ†æheap-dump"><a href="#åˆ†æheap-dump" class="headerlink" title="åˆ†æheap dump"></a>åˆ†æ<code>heap dump</code></h4><p>é€‰æ‹©ä¸€å°æœåŠ¡å™¨ï¼Œè”ç³»è¿ç»´<code>dump heap</code>(2.4G)ï¼Œé‡å¯å…¨éƒ¨æœåŠ¡å™¨(å†…å­˜ç›´çº¿æ‰ä¸‹æ¥ï¼Œè€å¹´ä»£200Mã€‚ã€‚ã€‚)</p>
<p>ä½¿ç”¨å·¥å…·<code>VisualVm</code>æˆ–è€…<code>Eclipse MAT</code>åˆ†æ<code>dump</code>æ—¥å¿—</p>
<h4 id="ä½¿ç”¨VisualVM"><a href="#ä½¿ç”¨VisualVM" class="headerlink" title="ä½¿ç”¨VisualVM"></a>ä½¿ç”¨<code>VisualVM</code></h4><ul>
<li>æ£€æŸ¥å †å†…å­˜å¤§å¯¹è±¡ï¼š</li>
</ul>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1g1f0vdxwdqj31jc0hwwka.jpg" alt=""></p>
<p>å¯è§å…±æœ‰377094ä¸ª<code>double[]</code>æ•°ç»„å æœ‰å†…å­˜2Gå·¦å³ï¼Œ<code>retained size</code>æ˜¯è¯¥å¯¹è±¡è¢«GCä¹‹åæ‰€èƒ½å›æ”¶åˆ°å†…å­˜çš„æ€»å’Œï¼›æ€€ç–‘<code>double[]</code>å¯¹è±¡æ³„æ¼ï¼Œæ²¡æœ‰è¢«å›æ”¶</p>
<ul>
<li>æŸ¥çœ‹è¯¥å¯¹è±¡çš„<code>GC Root</code>ï¼š</li>
</ul>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1g1f1ip6yf2j31gh0u0n4r.jpg" alt=""></p>
<p>ä¸Šå›¾å¯ä»¥çœ‹å‡ºè¯¥<code>double[]</code>è¢«<code>DataBuffer</code>ç›´æ¥å¼•ç”¨ï¼Œæœ€åè¢«ç¼“å­˜åœ¨<code>Guava LocalCache</code>ä¸­ï¼›ä»<code>GC Root</code>å¯ä»¥çœ‹å‡ºï¼Œæœ‰<code>ScheudleTask</code>(<code>DataPublisher</code>ä¸­åˆ›å»º)å¼•ç”¨äº†è¯¥å¯¹è±¡</p>
<h3 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h3><ul>
<li>è¿›å…¥<code>DataPublisher</code>ç±»ä¸­ï¼Œæ£€æŸ¥<code>ScheudleTask</code>åˆ›å»ºè¿‡ç¨‹ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (future == <span class="keyword">null</span>) &#123;</div><div class="line">           Runnable task = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                                   <span class="keyword">try</span> &#123;</div><div class="line">                                     <span class="comment">// ä¸»è¦åšè®¡ç®—ç»Ÿè®¡æ•°æ®</span></div><div class="line">                                      accumulator.publish();</div><div class="line">                                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                                       handleException(e);</div><div class="line">                                   &#125;</div><div class="line">                               &#125;</div><div class="line">                           &#125;;</div><div class="line">           <span class="comment">// ä»ä¸Šä¸‹æ–‡çœ‹ï¼Œå»¶è¿Ÿ1ç§’å®šæœŸæ‰§è¡Œä¸€æ¬¡</span></div><div class="line">           future = getExecutor().scheduleWithFixedDelay(task,</div><div class="line">                                                         delayMillis, delayMillis,</div><div class="line">                                                         TimeUnit.MILLISECONDS);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> ScheduledExecutorService <span class="title">getExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (sharedExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">           sharedExecutor = Executors.newScheduledThreadPool(<span class="number">1</span>, <span class="keyword">new</span> PublishThreadFactory());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> sharedExecutor;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ul>
<li>é€†å‘æ£€æŸ¥<code>start()</code>è°ƒç”¨</li>
</ul>
<p>ç”±<code>ServerStats</code>ç±»<code>initialize</code>æ–¹æ³•è§¦å‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">       serverFailureCounts = <span class="keyword">new</span> MeasuredRate(failureCountSlidingWindowInterval);</div><div class="line">       requestCountInWindow = <span class="keyword">new</span> MeasuredRate(<span class="number">300000L</span>);</div><div class="line">       <span class="keyword">if</span> (publisher == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">// DataBufferå®é™…å­˜åœ¨äºDataDistributionä¸­ï¼ŒbufferSize=1000</span></div><div class="line">           dataDist = <span class="keyword">new</span> DataDistribution(getBufferSize(), PERCENTS);</div><div class="line">           <span class="comment">// DataPublisheré—´æ¥å¼•ç”¨äº†DataBuffer</span></div><div class="line">           publisher = <span class="keyword">new</span> DataPublisher(dataDist, getPublishIntervalMillis());</div><div class="line">           <span class="comment">// è§¦å‘è°ƒç”¨</span></div><div class="line">           publisher.start();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">this</span>.server = server;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ul>
<li>é€†å‘æ£€æŸ¥<code>initialize()</code>è°ƒç”¨</li>
</ul>
<p>è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1g1f27thkyjj30vm042jsn.jpg" alt=""></p>
<p>ç”±<code>LoadBalancerStats</code>ç±»<code>createServerStats</code>æ–¹æ³•è§¦å‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ServerStats <span class="title">createServerStats</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">        <span class="comment">// åˆ›å»ºServerStatså¹¶åˆå§‹åŒ–</span></div><div class="line">        ServerStats ss = <span class="keyword">new</span> ServerStats(<span class="keyword">this</span>);</div><div class="line">        ss.setBufferSize(<span class="number">1000</span>);</div><div class="line">        ss.setPublishInterval(<span class="number">1000</span>);                   </div><div class="line">        ss.initialize(server);</div><div class="line">        <span class="keyword">return</span> ss;        </div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> ServerStats <span class="title">getServerStats</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// ä»localcacheç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœæ²¡æœ‰</span></div><div class="line">            <span class="comment">// åˆ™è°ƒç”¨createServerStatsåˆ›å»ºServerStatså¹¶ç¼“å­˜</span></div><div class="line">            <span class="keyword">return</span> serverStatsCache.get(server);</div><div class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">            ServerStats stats = createServerStats(server);</div><div class="line">            serverStatsCache.asMap().putIfAbsent(server, stats);</div><div class="line">            <span class="keyword">return</span> serverStatsCache.asMap().get(server);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"> <span class="comment">// localcacheåœ¨è¿™é‡Œã€‚ã€‚ã€‚ï¼Œkeyæ˜¯Server, valueæ˜¯ServerStats</span></div><div class="line"> <span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;Server, ServerStats&gt; serverStatsCache = </div><div class="line">        CacheBuilder.newBuilder()</div><div class="line">            .expireAfterAccess(SERVERSTATS_EXPIRE_MINUTES.get(), TimeUnit.MINUTES)</div><div class="line">            .removalListener(<span class="keyword">new</span> RemovalListener&lt;Server, ServerStats&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;Server, ServerStats&gt; notification)</span> </span>&#123;</div><div class="line">                    notification.getValue().close();</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            .build(</div><div class="line">                <span class="keyword">new</span> CacheLoader&lt;Server, ServerStats&gt;() &#123;</div><div class="line">                    <span class="comment">// ç¼“å­˜æ²¡æœ‰åˆ™åˆ›å»ºServerStats</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> ServerStats <span class="title">load</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> createServerStats(server);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡º<code>bufferSize=1000</code>ï¼Œ<code>Heap dump</code>ä¸­æ¯ä¸ª<code>double[]</code>å…ƒç´ ä¹Ÿæ˜¯1000ï¼›è€Œä¸”ï¼Œå®šæ—¶ä»»åŠ¡æ—¶é—´é—´éš”ä¸º1ç§’</p>
<p><strong>ä»ç¼“å­˜<code>localcache</code>çš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœå…ƒç´ ä¸€ç›´å¢åŠ ï¼Œè¯´æ˜ä¸€ç›´æœ‰æ–°çš„<code>Server</code>è¢«åˆ›å»ºå¹¶æ·»åŠ åˆ°ç¼“å­˜ä¸­ï¼›ä½†æ˜¯æ®åŒäº‹äº†è§£æˆ‘ä»¬çš„<code>Server</code>åªæœ‰10æ¥ä¸ªï¼Œç¼“å­˜æ­£å¸¸ä¸ä¼šä¸€ç›´å¢é•¿ï¼›æ€€ç–‘æ˜¯å¦ä»£ç é—®é¢˜å¯¼è‡´ä¸åœåˆ›å»ºæ–°çš„<code>Server</code>?</strong></p>
<ul>
<li>æ£€æŸ¥<code>getServerStats</code>è°ƒç”¨å…³ç³»</li>
</ul>
<p>å…¥å£è°ƒç”¨ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">(<span class="keyword">final</span> String path, Map&lt;String, Object&gt; param, Integer uploadType)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> LoadBalancerCommand.&lt;String&gt; builder().withLoadBalancer(loadBalancer).build()</div><div class="line">          .submit(<span class="keyword">new</span> ServerOperation&lt;String&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Observable&lt;String&gt; <span class="title">call</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">              URL url;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                String s = HttpClientUtil.post(<span class="string">"http://"</span> + server.getHost() + <span class="string">":"</span> + server.getPort() + path, param);</div><div class="line">                <span class="keyword">return</span> Observable.just(s);</div><div class="line">              &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                logger.info(<span class="string">"python identify voice failed! host &#123;&#125;"</span>, server.getHost());</div><div class="line">                <span class="keyword">return</span> Observable.error(e);</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;).toBlocking().first();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>é‡ç‚¹è§‚å¯Ÿ<code>LoadBalancerCommand.submit()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> Observable&lt;T&gt; <span class="title">submit</span><span class="params">(<span class="keyword">final</span> ServerOperation&lt;T&gt; operation)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// Use the load balancer</span></div><div class="line">        Observable&lt;T&gt; o = </div><div class="line">                (server == <span class="keyword">null</span> ? selectServer() : Observable.just(server))</div><div class="line">                .concatMap(<span class="keyword">new</span> Func1&lt;Server, Observable&lt;T&gt;&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="comment">// Called for each server being selected</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> Observable&lt;T&gt; <span class="title">call</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">                        context.setServer(server);</div><div class="line">                        <span class="comment">// getServerStatsçš„å…¥å£åœ¨è¿™é‡Œã€‚ã€‚ã€‚</span></div><div class="line">                        <span class="keyword">final</span> ServerStats stats = loadBalancerContext.getServerStats(server);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è§‚å¯Ÿ<code>LoadBalancerContext.getServerStats()</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ServerStats <span class="title">getServerStats</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">       ServerStats serverStats = <span class="keyword">null</span>;</div><div class="line">       <span class="comment">// LoadBalancerContextæŒæœ‰LoadBalancerå¯¹è±¡</span></div><div class="line">       ILoadBalancer lb = <span class="keyword">this</span>.getLoadBalancer();</div><div class="line">       <span class="keyword">if</span> (lb <span class="keyword">instanceof</span> AbstractLoadBalancer)&#123;</div><div class="line">           <span class="comment">// LoadBalanceræŒæœ‰LoadBalancerStatså¯¹è±¡</span></div><div class="line">           LoadBalancerStats lbStats = ((AbstractLoadBalancer) lb).getLoadBalancerStats();</div><div class="line">           serverStats = lbStats.getSingleServerStat(server);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> serverStats;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ£€æŸ¥<code>LoadBalancer</code>åˆ›å»ºè¿‡ç¨‹</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    initLoadbalance();</div><div class="line">    <span class="comment">// æ¯éš”3åˆ†é’Ÿé‡æ–°åˆ›å»ºLoadbalance</span></div><div class="line">    service.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        initLoadbalance();</div><div class="line">      &#125;</div><div class="line">    &#125;, <span class="number">3</span>, <span class="number">3</span>, TimeUnit.MINUTES);</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">   * åˆå§‹åŒ–æ™®é€šæœºå™¨è´Ÿè½½å‡è¡¡ç­–ç•¥</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initLoadbalance</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      List&lt;Server&gt; serverList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">      String machine = footballConfigFamilyService.getConfigMap().get(<span class="string">"voice-analyze"</span>);</div><div class="line">      List&lt;Weight&gt; list = JSON.parseObject(machine, <span class="keyword">new</span> TypeReference&lt;List&lt;Weight&gt;&gt;() &#123;</div><div class="line">      &#125;);</div><div class="line">      <span class="comment">// serverListåªæœ‰10æ¥ä¸ª</span></div><div class="line">      <span class="keyword">for</span> (Weight weight : list) &#123;</div><div class="line">        serverList.add(<span class="keyword">new</span> WeightServer(weight.getHost(), weight.getPort(), weight.getWeight()));</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// åˆ›å»ºloadBalancer</span></div><div class="line">      loadBalancer = LoadBalancerBuilder.newBuilder().withRule(<span class="keyword">new</span> WeightedRule())</div><div class="line">          .buildFixedServerListLoadBalancer(serverList);</div><div class="line">      </div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>è§‚å¯Ÿ<code>LoadBalancerBuilder.buildFixedServerListLoadBalancer()</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> BaseLoadBalancer <span class="title">buildFixedServerListLoadBalancer</span><span class="params">(List&lt;T&gt; servers)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (rule == <span class="keyword">null</span>) &#123;</div><div class="line">            rule = createRuleFromConfig(config);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// åˆ›å»ºBaseLoadBalancer</span></div><div class="line">        BaseLoadBalancer lb = <span class="keyword">new</span> BaseLoadBalancer(config, rule, ping);</div><div class="line">        <span class="comment">// è®¾ç½®è´Ÿè½½å‡è¡¡æœåŠ¡å™¨åˆ—è¡¨</span></div><div class="line">        lb.setServersList(servers);</div><div class="line">        <span class="keyword">return</span> lb;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">BaseLoadBalancer</span><span class="params">(IClientConfig config, IRule rule, IPing ping)</span> </span>&#123;</div><div class="line">        initWithConfig(config, rule, ping);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">initWithConfig</span><span class="params">(IClientConfig clientConfig, IRule rule, IPing ping)</span> </span>&#123;</div><div class="line">        setLoadBalancerStats(<span class="keyword">new</span> LoadBalancerStats(clientName));</div><div class="line">        rule.setLoadBalancer(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (ping <span class="keyword">instanceof</span> AbstractLoadBalancerPing) &#123;</div><div class="line">            ((AbstractLoadBalancerPing) ping).setLoadBalancer(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢ä»£ç çœ‹ï¼Œæ¯éš”3åˆ†é’Ÿå°±ä¼šé‡æ–°åˆ›å»ºæ–°çš„<code>LoadBalancer</code>ï¼Œæ¯åˆ›å»ºä¸€ä¸ª<code>LoadBalancer</code>ï¼Œéƒ½ä¼šåˆ›å»º<code>LoadBalancerStats</code>ä½œä¸º<code>LoadBalancer</code>å±æ€§</p>
<p>éš¾é“æ¯éš”3åˆ†é’Ÿæ—¶é—´åˆ›å»ºçš„<code>Server</code>å¯¹<code>Guava LocalCache</code>æ¥è¯´éƒ½æ˜¯ä¸åŒçš„å—ï¼Ÿçªƒå–œï¼Œæ„Ÿè§‰é—®é¢˜å·²ç»æ‰¾åˆ°ğŸ˜„</p>
<p>ç°åœ¨éœ€è¦ç¡®å®š2ä¸ª<code>WeightServer</code>å¯¹è±¡ï¼Œå…·æœ‰ç›¸åŒçš„<code>ip</code>å’Œ<code>port</code>, åœ¨<code>LocalCache</code>ä¸­æ˜¯ä¸€ä¸ªå—ï¼Ÿ</p>
<ul>
<li>æ£€æŸ¥<code>WeightServer</code></li>
</ul>
<p>å…·ä½“çš„<code>guava cache</code> æºç ä¸å†å™è¿°ï¼Œæ•´ä½“é€»è¾‘è®¾è®¡å‚è€ƒ<code>CurrentHashMap</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.host = host;</div><div class="line">        <span class="keyword">this</span>.port = port;</div><div class="line">        <span class="keyword">this</span>.id = host + <span class="string">":"</span> + port;</div><div class="line">        isAliveFlag = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == obj)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Server))</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        Server svc = (Server) obj;</div><div class="line">        <span class="keyword">return</span> svc.getId().equals(<span class="keyword">this</span>.getId());</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> hash = <span class="number">7</span>;</div><div class="line">        hash = <span class="number">31</span> * hash + (<span class="keyword">null</span> == <span class="keyword">this</span>.getId() ? <span class="number">0</span> : <span class="keyword">this</span>.getId().hashCode());</div><div class="line">        <span class="keyword">return</span> hash;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çœ‹ï¼Œ2ä¸ª<code>WeightServer</code>å¦‚æœ<code>ip</code>å’Œ<code>port</code>ç›¸åŒï¼Œç»æµ‹è¯•<code>cache</code>å…ƒç´ åªæœ‰ä¸€ä¸ªï¼Œ<code>guava cache</code>è®¤ä¸ºæ˜¯åŒä¸€ä¸ªå…ƒç´ ã€‚å°´å°¬ï¼ŒçŒœé”™äº†ğŸ˜…ã€‚ã€‚ã€‚</p>
<h4 id="é‡æ–°æ£€æŸ¥ä»£ç "><a href="#é‡æ–°æ£€æŸ¥ä»£ç " class="headerlink" title="é‡æ–°æ£€æŸ¥ä»£ç "></a>é‡æ–°æ£€æŸ¥ä»£ç </h4><p>æ—¢ç„¶<code>heap dump</code>æ˜¾ç¤º<code>cache</code>ä¸­çš„<code>Server</code>åœ¨ä¸åœå¢åŠ ï¼Œå®é™…æƒ…å†µå´æ˜¯ä¸€ä¸ª<code>cache</code>ä¸­åªä¼šæœ‰10æ¥ä¸ª<code>Server</code>ï¼›çªç„¶æƒ³èµ·æ¥ï¼Œ<strong>æ¯ä¸ª<code>LoadBalancerStats</code>å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª<code>cache</code>å¯¹è±¡</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">BaseLoadBalancer</span><span class="params">(IClientConfig config, IRule rule, IPing ping)</span> </span>&#123;</div><div class="line">        initWithConfig(config, rule, ping);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">initWithConfig</span><span class="params">(IClientConfig clientConfig, IRule rule, IPing ping)</span> </span>&#123;</div><div class="line">        setLoadBalancerStats(<span class="keyword">new</span> LoadBalancerStats(clientName));</div><div class="line">        rule.setLoadBalancer(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (ping <span class="keyword">instanceof</span> AbstractLoadBalancerPing) &#123;</div><div class="line">            ((AbstractLoadBalancerPing) ping).setLoadBalancer(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><strong>åŸå› ï¼šå®šæ—¶ä»»åŠ¡æ‰§è¡Œ<code>initLoadbalance()</code>ï¼Œå¯¼è‡´ä¸åœåˆ›å»ºæ–°çš„<code>LoadBalancer</code>ï¼Œå³<code>LoadBalancerStats</code>ä¸€ç›´å¢åŠ ï¼Œå…¨éƒ¨<code>cache</code>ç¼“å­˜çš„<code>Server</code>ä¹Ÿä¼šå¢åŠ </strong></p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ—§çš„<code>cache</code>ä¸ºä»€ä¹ˆä¸è¢«<code>GC</code>å›æ”¶å‘¢ï¼Ÿå›è¿‡å¤´æ¥çœ‹<code>DataPublisher.start()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (future == <span class="keyword">null</span>) &#123;</div><div class="line">           Runnable task = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                                   <span class="keyword">try</span> &#123;</div><div class="line">                                      accumulator.publish();</div><div class="line">                                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                                       handleException(e);</div><div class="line">                                   &#125;</div><div class="line">                               &#125;</div><div class="line">                           &#125;;</div><div class="line">           future = getExecutor().scheduleWithFixedDelay(task,</div><div class="line">                                                         delayMillis, delayMillis,</div><div class="line">                                                         TimeUnit.MILLISECONDS);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> ScheduledExecutorService <span class="title">getExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (sharedExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">           sharedExecutor = Executors.newScheduledThreadPool(<span class="number">1</span>, <span class="keyword">new</span> PublishThreadFactory());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> sharedExecutor;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„ä»£ç çœ‹å‡ºï¼Œ<strong>æ¯ä¸ª<code>Server</code>éƒ½å…³è”äº†ä¸€ä¸ªçº¿ç¨‹æ± æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œå¯¼è‡´<code>cache</code>ä¸­<code>Server</code>å¯¹è±¡ä¸€ç›´è¢«å¼•ç”¨ï¼Œ<code>GC</code>ä¸ä¼šå›æ”¶è¿™ç±»å¯¹è±¡ã€‚</strong></p>
<h4 id="æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼š"><a href="#æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼š" class="headerlink" title="æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼š"></a>æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è¿‡æœŸæ—¶é—´é»˜è®¤30åˆ†é’Ÿ</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;Server, ServerStats&gt; serverStatsCache = </div><div class="line">        CacheBuilder.newBuilder()</div><div class="line">            .expireAfterAccess(SERVERSTATS_EXPIRE_MINUTES.get(), TimeUnit.MINUTES)</div><div class="line">            .removalListener(<span class="keyword">new</span> RemovalListener&lt;Server, ServerStats&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;Server, ServerStats&gt; notification)</span> </span>&#123;</div><div class="line">                    notification.getValue().close();</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            .build(</div><div class="line">                <span class="keyword">new</span> CacheLoader&lt;Server, ServerStats&gt;() &#123;</div><div class="line">                    <span class="comment">// ç¼“å­˜æ²¡æœ‰åˆ™åˆ›å»ºServerStats</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> ServerStats <span class="title">load</span><span class="params">(Server server)</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> createServerStats(server);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>guava cache</code>ä½¿ç”¨äº†<code>expireAfterAccess</code>å’Œ<code>removalListener</code>, æˆ‘çŒœ<a href="[https://github.com/Netflix/ribbon](https://github.com/Netflix/ribbon"><code>robbin</code>æ¡†æ¶</a>)ä½œè€…æœ¬æ„æ˜¯ä½¿ç”¨è¿‡æœŸå‡½æ•°ä»¥åŠç›‘å¬å™¨åœ¨<code>Server</code>å¤±æ•ˆåå…³é—­çº¿ç¨‹æ± è¿è¡Œï¼Œé˜²æ­¢çº¿ç¨‹ä¸€ç›´è¿è¡Œï¼›ä½†æ˜¯<code>guava cache</code>çš„è¿‡æœŸåˆ é™¤æ˜¯è¢«åŠ¨çš„ï¼Œå°±æ˜¯è¯´å¦‚æœå…ƒç´ è¿‡æœŸåå†æ¬¡è¢«è®¿é—®ï¼Œä¼šè§¦å‘åˆ é™¤å¹¶é‡æ–°åŠ è½½</p>
<p><strong>ä»¥è¯¥é¡¹ç›®ä»£ç æ‰§è¡Œæ¥çœ‹ï¼Œåªä¼šä¸€ç›´æ·»åŠ æ–°çš„<code>cache</code>ï¼Œæ—§çš„<code>cache</code>ä¸èƒ½è¢«è®¿é—®ï¼Œå¯¼è‡´ç¼“å­˜å¯¹è±¡ä¸èƒ½é‡Šæ”¾</strong></p>
<h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><ul>
<li>é¿å…<code>LoadBalancer</code>ä¸åœçš„åˆ›å»ºï¼Œè¦†ç›–<code>ServerList</code>å³å¯</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initLoadbalance</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      List&lt;Server&gt; serverList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">      String machine = footballConfigFamilyService.getConfigMap().get(<span class="string">"voice-analyze"</span>);</div><div class="line">      List&lt;Weight&gt; list = JSON.parseObject(machine, <span class="keyword">new</span> TypeReference&lt;List&lt;Weight&gt;&gt;() &#123;</div><div class="line">      &#125;);</div><div class="line">      <span class="comment">// serverListåªæœ‰10æ¥ä¸ª</span></div><div class="line">      <span class="keyword">for</span> (Weight weight : list) &#123;</div><div class="line">        serverList.add(<span class="keyword">new</span> WeightServer(weight.getHost(), weight.getPort(), weight.getWeight()));</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// **********ä»£ç ä¿®å¤å¤„************</span></div><div class="line">      <span class="keyword">if</span>(loadBalancer == <span class="keyword">null</span>)&#123;</div><div class="line">        loadBalancer = LoadBalancerBuilder.newBuilder().withRule(<span class="keyword">new</span> WeightedRule())</div><div class="line">          .buildFixedServerListLoadBalancer(serverList);</div><div class="line">      &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="comment">// è¦†ç›–æ—§çš„server list</span></div><div class="line">        loadBalancer.setServersList(serverList);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>ä½¿ç”¨ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œä¸€å®šè¦äº†è§£åº•å±‚è¿è¡Œæœºåˆ¶ã€‚ğŸ˜„</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Netty æœåŠ¡ç«¯å¯åŠ¨]]></title>
      <url>http://zsr.github.io/2019/02/13/Netty-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8/</url>
      <content type="html"><![CDATA[<h3 id="æœåŠ¡ç«¯å¯åŠ¨ä»£ç "><a href="#æœåŠ¡ç«¯å¯åŠ¨ä»£ç " class="headerlink" title="æœåŠ¡ç«¯å¯åŠ¨ä»£ç "></a>æœåŠ¡ç«¯å¯åŠ¨ä»£ç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</div><div class="line">EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</div><div class="line">ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</div><div class="line">bootstrap.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)</div><div class="line">          .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">              <span class="comment">// ...</span></div><div class="line">            &#125;</div><div class="line">          &#125;).option(ChannelOption.SO_BACKLOG, <span class="number">128</span>).childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">ChannelFuture channelFuture = bootstrap.bind(<span class="keyword">new</span> InetSocketAddress(port)).sync();</div></pre></td></tr></table></figure>
<h3 id="å¯åŠ¨è¿‡ç¨‹åˆ†æ"><a href="#å¯åŠ¨è¿‡ç¨‹åˆ†æ" class="headerlink" title="å¯åŠ¨è¿‡ç¨‹åˆ†æ"></a>å¯åŠ¨è¿‡ç¨‹åˆ†æ</h3><p>è·Ÿè¸ª<code>ServerBootstrap.bind()</code>æ–¹æ³•ï¼Œè¿½åˆ°<code>AbstractBootstrap.doBind()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ChannelFuture <span class="title">doBind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress)</span> </span>&#123;</div><div class="line">         <span class="comment">// åˆ›å»ºchannelå¹¶ä¸”æ³¨å†Œselector</span></div><div class="line">        <span class="keyword">final</span> ChannelFuture regFuture = initAndRegister();</div><div class="line">        <span class="keyword">final</span> Channel channel = regFuture.channel();</div><div class="line">        <span class="keyword">if</span> (regFuture.cause() != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> regFuture;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (regFuture.isDone()) &#123;</div><div class="line">            <span class="comment">// At this point we know that the registration was complete and successful.</span></div><div class="line">            ChannelPromise promise = channel.newPromise();</div><div class="line">            <span class="comment">// å°†ServerSocketChannelç»‘å®šåˆ°æœ¬åœ°çš„ç«¯å£</span></div><div class="line">            doBind0(regFuture, channel, localAddress, promise);</div><div class="line">            <span class="keyword">return</span> promise;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">// ...</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è·Ÿè¸ª<code>initAndRegister()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Channel channel = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// åˆ›å»ºchannel</span></div><div class="line">    channel = channelFactory.newChannel();</div><div class="line">    <span class="comment">// åˆå§‹åŒ–channel</span></div><div class="line">    init(channel);</div><div class="line">&#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">    <span class="keyword">if</span> (channel != <span class="keyword">null</span>) &#123;</div><div class="line">        channel.unsafe().closeForcibly();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultChannelPromise(channel, GlobalEventExecutor.INSTANCE).setFailure(t);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultChannelPromise(<span class="keyword">new</span> FailedChannel(), GlobalEventExecutor.INSTANCE).setFailure(t);</div><div class="line">&#125;</div><div class="line"><span class="comment">// æ³¨å†Œchannelåˆ°selector</span></div><div class="line">ChannelFuture regFuture = config().group().register(channel);</div></pre></td></tr></table></figure>
<p>è¿™é‡Œå…ˆé€šè¿‡å·¥å‚åˆ›å»ºäº†ä¸€ä¸ª<code>Channel</code>(è¿™é‡ŒæœåŠ¡ç«¯æŒ‡å®šç±»å‹<code>NioServerSocketChannel</code>)ï¼Œç„¶ååˆå§‹åŒ–è¿™ä¸ª<code>Channel</code>ã€‚æœ€åæŠŠè¿™ä¸ª<code>Channel</code>æ³¨å†Œåˆ°<code>EventLoopGroup</code>ä¸Šï¼ˆ<code>config().group()</code>è¿”å›çš„æ˜¯æˆ‘ä»¬è®¾ç½®çš„<code>Boss Group</code>ï¼‰</p>
<h4 id="åˆ›å»ºchannel"><a href="#åˆ›å»ºchannel" class="headerlink" title="åˆ›å»ºchannel"></a>åˆ›å»º<code>channel</code></h4><p>æŸ¥çœ‹<code>NioServerSocketChannel</code>æ„é€ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioServerSocketChannel</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//è°ƒç”¨ä¸‹é¢è¿™ä¸ªæ–¹æ³•</span></div><div class="line">    <span class="keyword">this</span>(newSocket(DEFAULT_SELECTOR_PROVIDER));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioServerSocketChannel</span><span class="params">(ServerSocketChannel channel)</span> </span>&#123;</div><div class="line">    <span class="comment">//æ³¨æ„ï¼Œè¿™é‡Œæ˜¯åˆå§‹åŒ–äº†ä¸€ä¸ªå¯¹SelectionKey.OP_ACCEPTæ„Ÿå…´è¶£çš„ç®¡é“</span></div><div class="line">    <span class="comment">//Bossçš„Reactorçº¿ç¨‹è½®è¯¢åˆ°éƒ½æ˜¯ACCEPTäº‹ä»¶</span></div><div class="line">    <span class="keyword">super</span>(<span class="keyword">null</span>, channel, SelectionKey.OP_ACCEPT);</div><div class="line">    config = <span class="keyword">new</span> NioServerSocketChannelConfig(<span class="keyword">this</span>, javaChannel().socket());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SelectorProvider DEFAULT_SELECTOR_PROVIDER = SelectorProvider.provider();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ServerSocketChannel <span class="title">newSocket</span><span class="params">(SelectorProvider provider)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> provider.openServerSocketChannel();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>newSocket</code>ä½¿ç”¨<code>SelectorProvider</code>çš„<code>openServerSocketChannel</code>æ‰“å¼€æœåŠ¡å™¨å¥—æ¥å­—é€šé“ã€‚<code>SelectorProvider</code>ä¸»è¦å·¥ä½œæ˜¯æ ¹æ®æ“ä½œç³»ç»Ÿç±»å‹å’Œç‰ˆæœ¬é€‰æ‹©åˆé€‚çš„<code>Provider</code>ï¼šå¦‚æœ<code>Linux</code>å†…æ ¸ç‰ˆæœ¬&gt;=2.6åˆ™ï¼Œå…·ä½“çš„<code>SelectorProvider</code>ä¸º<code>EPollSelectorProvider</code>ï¼Œå¦åˆ™ä¸ºé»˜è®¤çš„<code>PollSelectorProvider</code></p>
<p>ç»§ç»­è¿½æº¯<code>super</code>æ–¹æ³•åˆ°<code>AbstractChannel</code>ï¼Œå¦‚ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractChannel</span><span class="params">(Channel parent)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.parent = parent;</div><div class="line">    <span class="comment">// ChannelIdæ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„å€¼</span></div><div class="line">    id = newId();</div><div class="line">    unsafe = newUnsafe();</div><div class="line">    pipeline = newChannelPipeline();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸»è¦åšäº†2ä»¶äº‹ï¼š</p>
<ul>
<li><p>åˆ›å»º<code>NioMessageUnsafe</code>å®ä¾‹ï¼ˆå®¢æˆ·ç«¯åˆ›å»º<code>NioByteUnsafe</code>ï¼‰ï¼Œè¯¥ç±»ä¸º<code>Channel</code>æä¾›äº†ç”¨äºå®Œæˆç½‘ç»œé€šè®¯ç›¸å…³çš„åº•å±‚æ“ä½œï¼Œå¦‚<code>connect(),read(),register(),bind(),close()</code>ç­‰ï¼›</p>
</li>
<li><p>ç»™è¯¥<code>Channel</code>åˆ›å»º<code>DefaultChannelPipeline</code>å¹¶åˆå§‹åŒ–ï¼Œè¿™é‡Œç”¨çš„æ˜¯é»˜è®¤<code>Pipeline</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">DefaultChannelPipeline</span><span class="params">(Channel channel)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.channel = ObjectUtil.checkNotNull(channel, <span class="string">"channel"</span>);</div><div class="line">        succeededFuture = <span class="keyword">new</span> SucceededChannelFuture(channel, <span class="keyword">null</span>);</div><div class="line">        voidPromise =  <span class="keyword">new</span> VoidChannelPromise(channel, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// åˆ›å»ºtail</span></div><div class="line">        tail = <span class="keyword">new</span> TailContext(<span class="keyword">this</span>);</div><div class="line">        <span class="comment">// åˆ›å»ºhead </span></div><div class="line">        head = <span class="keyword">new</span> HeadContext(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        head.next = tail;</div><div class="line">        tail.prev = head;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å…·ä½“çš„<code>ChannelPipeline</code>æ‰§è¡Œæµç¨‹çœ‹<a href="https://zsr.github.io/2018/12/15/Netty-æ ¸å¿ƒç»„ä»¶/">å‰ç¯‡æ–‡ç« </a></p>
</li>
</ul>
<p>åˆ°è¿™é‡Œæ•´ä¸ª<code>Channel</code>åˆ›å»ºå°±ç»“æŸäº†ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ol>
<li>é€šè¿‡å·¥å‚åˆ›å»ºä¸€ä¸ª<code>Channel</code>ï¼Œè¿™é‡Œçš„<code>Channel</code>ç”±äºæ˜¯åœ¨æœåŠ¡ç«¯ï¼Œä½¿ç”¨çš„æ˜¯<code>NioServerSocketChannel</code>ï¼Œ</li>
<li>è¿™ä¸ªç®¡é“çš„æ„é€ æ–¹æ³•ä¸­ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ªåŸç”Ÿçš„<code>ServerSocketChannel</code>ï¼Œæœ€ååˆå§‹åŒ–<code>pipeline</code>å’Œ<code>unsafe</code>ã€‚</li>
<li>åˆå§‹åŒ–<code>pipeline</code>çš„æ—¶å€™ï¼Œåˆä¼šåˆå§‹åŒ–<code>pipeline</code>ä¸­çš„<code>Head</code>å’Œ<code>Tail</code>ã€‚</li>
</ol>
<h4 id="åˆå§‹åŒ–channel"><a href="#åˆå§‹åŒ–channel" class="headerlink" title="åˆå§‹åŒ–channel"></a>åˆå§‹åŒ–<code>channel</code></h4><p>æœåŠ¡ç«¯<code>init()</code>å®ç°æ–¹æ³•åœ¨<code>ServerBootstrap</code>ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ªhandleï¼ChannelInitializer</span></div><div class="line">        p.addLast(<span class="keyword">new</span> ChannelInitializer&lt;Channel&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="comment">// è¿™é‡Œè¿˜å¹¶æœªæ‰§è¡ŒinitChannelæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯åœ¨æ‰§è¡Œå›è°ƒæ–¹æ³•handlerAddedåè°ƒç”¨çš„</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(<span class="keyword">final</span> Channel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                <span class="keyword">final</span> ChannelPipeline pipeline = ch.pipeline();</div><div class="line">                ChannelHandler handler = config.handler();</div><div class="line">                <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</div><div class="line">                    pipeline.addLast(handler);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                ch.eventLoop().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        pipeline.addLast(<span class="keyword">new</span> ServerBootstrapAcceptor(</div><div class="line">                                ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æœåŠ¡ç«¯çš„<code>init()</code>åˆ†ä¸º2ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>å°†<code>bootstrap</code>é…ç½®çš„å±æ€§è®¾ç½®åˆ°<code>Channel</code>ä¸Šé¢</li>
<li>ç»™<code>NioServerSocketChannel</code>çš„<code>pipeline</code>é‡Œï¼Œæ·»åŠ äº†ä¸€ä¸ª<code>ChannelHandle</code>-<code>ChannelInitializer</code>ï¼Œä¾›æ³¨å†Œåä½¿ç”¨</li>
</ul>
<p>åˆå§‹åŒ–ç»“æŸï¼Œæ­¤æ—¶<code>NioServerSocketChannel</code>çš„<code>pipeline</code>é“¾è¡¨ç»“æ„ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Head &lt;--&gt;  ChannelInitializer &lt;--&gt; Tail</div></pre></td></tr></table></figure>
<h4 id="æ³¨å†Œchannel"><a href="#æ³¨å†Œchannel" class="headerlink" title="æ³¨å†Œchannel"></a>æ³¨å†Œ<code>channel</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ChannelFuture regFuture = config().group().register(channel);</div></pre></td></tr></table></figure>
<p>ä¸»è¦å°†åˆ›å»ºå¹¶åˆå§‹åŒ–åçš„<code>Channel</code>æ³¨å†Œåˆ°<code>selector</code>ä¸Šé¢ï¼š</p>
<ul>
<li>å°†<code>Channel</code>æ³¨å†Œåˆ°<code>EventLoop</code>çš„<code>selector</code>ä¸Šï¼›</li>
<li>è§¦å‘<code>Pipeline</code>ä¸Šé¢<code>ChannelHandler</code>çš„<code>channelRegistered</code></li>
</ul>
<p>è¿™é‡Œçš„<code>config().group()</code>ç»“æœæ˜¯<code>NioEventLoopGroup</code>ï¼Œçˆ¶ç±»æ˜¯<code>MultithreadEventLoopGroup</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">register</span><span class="params">(Channel channel)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> next().register(channel);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>next()</code>æ–¹æ³•æœ€åæ‰§è¡Œåˆ°<code>chooser.next()</code>ï¼Œ<code>chooser</code>æœ‰ä¸¤ç§ï¼š<code>PowerOfTwoEventExecutorChooser</code>å’Œ<code>GenericEventExecutorChooser</code>ã€‚å¦‚æœè¯¥<code>EventLoopGroup</code>ä¸­<code>EventLoop</code>æ˜¯2çš„å€æ•°åˆ™é€‰æ‹©<code>PowerOfTwoEventExecutorChooser</code>(2çš„å€æ•°æ–¹ä¾¿ä½æ“ä½œ)ï¼›å› ä¸ºè¿™é‡Œçš„<code>Group</code>æ˜¯<code>NioEventLoopGroup</code>ï¼Œæ‰€ä»¥<code>next()</code>è¿”å›çš„æ˜¯<code>NioEventLoop</code></p>
<p>ç»§ç»­çœ‹<code>NioEventLoop.register()</code>ï¼Œå…·ä½“æ–¹æ³•å®ç°åœ¨<code>SingleThreadEventLoop</code>ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">promise.channel().unsafe().register(<span class="keyword">this</span>, promise);</div><div class="line"><span class="keyword">return</span> promise;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆä½¿ç”¨<code>channel</code>ä¸­çš„<code>unsafe()</code>æ³¨å†Œï¼Œå…·ä½“æ–¹æ³•å®ç°åœ¨<code>AbstractUnsafe</code>ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register0</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">boolean</span> firstRegistration = neverRegistered;<span class="comment">// æ˜¯å¦ä¸ºé¦–æ¬¡æ³¨å†Œ</span></div><div class="line">                <span class="comment">// å®é™…çš„æ³¨å†ŒåŠ¨ä½œ, æŠŠChannelæ„Ÿå…´è¶£çš„äº‹ä»¶æ³¨å†Œåˆ°Eventloop.selectorä¸Šé¢</span></div><div class="line">                doRegister();</div><div class="line">                neverRegistered = <span class="keyword">false</span>;</div><div class="line">                registered = <span class="keyword">true</span>;</div><div class="line">                pipeline.invokeHandlerAddedIfNeeded();<span class="comment">// å°†æ³¨å†Œä¹‹å‰åŠ å…¥çš„handleråŠ å…¥è¿›æ¥</span></div><div class="line">                safeSetSuccess(promise); <span class="comment">// æ³¨å†ŒæˆåŠŸï¼Œé€šçŸ¥promise</span></div><div class="line">                pipeline.fireChannelRegistered();<span class="comment">// pipelineé€šçŸ¥è§¦å‘æ³¨å†ŒæˆåŠŸ</span></div><div class="line">      </div><div class="line">                <span class="keyword">if</span> (isActive()) &#123; <span class="comment">// æ˜¯å¦å·²ç»ç»‘å®š å› ä¸ºregisterå’Œbindé˜¶æ®µæ˜¯å¼‚æ­¥çš„</span></div><div class="line">                    <span class="keyword">if</span> (firstRegistration) &#123; </div><div class="line">                        pipeline.fireChannelActive(); <span class="comment">// é¦–æ¬¡æ³¨å†Œï¼Œé€šçŸ¥</span></div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config().isAutoRead()) &#123;</div><div class="line">                        beginRead();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                closeForcibly();</div><div class="line">                closeFuture.setClosed();</div><div class="line">                safeSetFailure(promise, t);</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p><code>invokeHandlerAddedIfNeeded</code>: æ³¨å†ŒæˆåŠŸåï¼Œæ‰¾åˆ°åˆå§‹åŒ–é˜¶æ®µé€šè¿‡<code>pipeline.addLast()</code>åŠ å…¥çš„<code>ChannelInitializer</code>ï¼Œæ‰§è¡Œå…¶<code>ChannelInitializer</code>çš„<code>initChannel</code>æ–¹æ³•(æ·»åŠ <code>ChannelHandle</code>-<code>ServerBootstrapAcceptor</code>)ï¼Œä¹‹åå°†<code>ChannelInitializer</code> åœ¨<code>pipeline</code>ä¸­åˆ é™¤</p>
<p>æ³¨å†Œç»“æŸï¼Œæ­¤æ—¶<code>NioServerSocketChannel</code>çš„<code>pipeline</code>é“¾è¡¨ç»“æ„ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Head   &lt;--&gt; ServerBootstrapAcceptor &lt;--&gt; Tail</div></pre></td></tr></table></figure>
<p><code>fireChannelRegistered</code>æ²¿ç€<code>pipeline</code>çš„<code>head</code>åˆ°<code>tail</code>ï¼Œè°ƒç”¨<code>ChannelHandler.channelRegistered</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireChannelRegistered</span><span class="params">()</span> </span>&#123;</div><div class="line">        AbstractChannelHandlerContext.invokeChannelRegistered(head);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeChannelRegistered</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (invokeHandler()) &#123; <span class="comment">// çŠ¶æ€æ˜¯å¦æ­£ç¡®</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                ((ChannelInboundHandler) handler()).channelRegistered(<span class="keyword">this</span>); <span class="comment">// è§¦å‘</span></div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                notifyHandlerException(t);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            fireChannelRegistered();<span class="comment">// çŠ¶æ€ä¸æ­£ç¡®ï¼Œé€šçŸ¥ä¸‹ä¸€ä¸ªHandler</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><code>fireChannelActive</code> ç”±äºæ³¨å†Œé˜¶æ®µå’Œç»‘å®š<code>bind</code>é˜¶æ®µéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚æœæ­¤æ—¶æ³¨å†Œå®Œæˆæ—¶<code>bind</code>é˜¶æ®µå·²ç»ç»‘å®šäº†æœ¬åœ°ç«¯å£ï¼Œä¼šæ²¿ç€<code>pipeline</code>çš„<code>head</code>åˆ°<code>tail</code>ï¼Œè°ƒç”¨å„ä¸ª<code>ChannelHandler</code>çš„<code>channelActive</code>æ–¹æ³•</p>
<h4 id="bindæœ¬åœ°åœ°å€"><a href="#bindæœ¬åœ°åœ°å€" class="headerlink" title="bindæœ¬åœ°åœ°å€"></a><code>bind</code>æœ¬åœ°åœ°å€</h4><p>å°†<code>NioServerSocketChannel</code>å†…éƒ¨<code>ServerSocketChannel</code>ç»‘å®šåˆ°æœ¬åœ°çš„ç«¯å£ä¸Šé¢ï¼Œç„¶åè°ƒç”¨<code>fireChannelActive</code>é€šçŸ¥<code>pipeline</code>é‡Œçš„<code>ChannelHandle</code>ï¼Œæ‰§è¡Œå…¶<code>channelActive</code>æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doBind0</span><span class="params">(</span></span></div><div class="line">           <span class="keyword">final</span> ChannelFuture regFuture, <span class="keyword">final</span> Channel channel,</div><div class="line">           <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise) &#123;</div><div class="line"></div><div class="line">       <span class="comment">// This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up</span></div><div class="line">       <span class="comment">// the pipeline in its channelRegistered() implementation.</span></div><div class="line">       channel.eventLoop().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">               <span class="keyword">if</span> (regFuture.isSuccess()) &#123;</div><div class="line">                   channel.bind(localAddress, promise).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   promise.setFailure(regFuture.cause());</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p><code>AbstractBootstrap</code>çš„<code>doBind0()</code>ï¼Œå†…éƒ¨ä¼šè°ƒç”¨<code>pipeline</code>ä¸­çš„<code>bind</code>æ–¹æ³•ï¼Œé€»è¾‘ä¸ºä»<code>tail</code>å‡ºå‘è°ƒç”¨<code>outbound</code>çš„<code>ChannelHandler</code>çš„<code>bind</code>æ–¹æ³•ã€‚å½“å‰<code>pipeline</code>é“¾è¡¨ç»“æ„ä¸­åªæœ‰<code>Head</code>æ˜¯ç»§æ‰¿äº†<code>outbound</code>æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> tail.bind(localAddress, promise);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">        <span class="comment">// æ‰¾å‡ºä¸‹ä¸€ä¸ªoutbound,è¿™é‡Œæ‰¾å‡ºæ¥çš„æ˜¯HeadContext</span></div><div class="line">        <span class="keyword">final</span> AbstractChannelHandlerContext next = findContextOutbound();</div><div class="line">        EventExecutor executor = next.executor();</div><div class="line">        <span class="keyword">if</span> (executor.inEventLoop()) &#123;</div><div class="line">            next.invokeBind(localAddress, promise);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            safeExecute(executor, <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    next.invokeBind(localAddress, promise);</div><div class="line">                &#125;</div><div class="line">            &#125;, promise, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> promise;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><code>Head</code>çš„<code>bind</code>æ–¹æ³•ç”±<code>NioServerSocketChannel</code>åˆ›å»ºè¿‡ç¨‹ä¸­ç”Ÿæˆçš„<code>unsafe</code>çš„å®ä¾‹<code>NioMessageUnsafe</code>æ¥æ‰§è¡Œï¼Œè¯¥å®ä¾‹çš„<code>bind</code>æ–¹æ³•ç»§æ‰¿äº<code>AbstractUnsafe.bind()</code>ï¼Œç„¶åè§¦å‘<code>fireChannelActive</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractUnsafe.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line"></div><div class="line">            <span class="keyword">boolean</span> wasActive = isActive();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">              <span class="comment">// æŠŠchannel bindåˆ°æœ¬åœ°åœ°å€</span></div><div class="line">                doBind(localAddress);</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                safeSetFailure(promise, t);</div><div class="line">                closeIfClosed();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// bindä¹‹åï¼Œè¿™é‡Œçš„isActiveä¼šè¿”å›true</span></div><div class="line">            <span class="keyword">if</span> (!wasActive &amp;&amp; isActive()) &#123;</div><div class="line">                invokeLater(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                    <span class="meta">@Overridem</span>   </div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        <span class="comment">//åœ¨è¿™é‡Œè§¦å‘çš„æ˜¯NioServerSocketChannelå¯¹åº”çš„pipelineçš„channelActive</span></div><div class="line">                        pipeline.fireChannelActive();</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            safeSetSuccess(promise);</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>doBind(localAddress)</code>æ–¹æ³•ç”±åˆ›å»ºçš„<code>NioServerSocketChannel</code>æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBind</span><span class="params">(SocketAddress localAddress)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">if</span> (PlatformDependent.javaVersion() &gt;= <span class="number">7</span>) &#123;</div><div class="line">            javaChannel().bind(localAddress, config.getBacklog());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            javaChannel().socket().bind(localAddress, config.getBacklog());</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡ŒæŠŠ<code>java</code>åŸç”Ÿçš„<code>ServerSocketChannel</code>ç»‘å®šåˆ°æœ¬åœ°åœ°å€ä¸Š</p>
<p>ç»‘å®šåˆ°æœ¬åœ°åœ°å€åä¼šæ‰§è¡Œ<code>pipeline.fireChannelActive()</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultChannelPipeline.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireChannelActive</span><span class="params">()</span> </span>&#123;</div><div class="line">        AbstractChannelHandlerContext.invokeChannelActive(head);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeChannelActive</span><span class="params">(<span class="keyword">final</span> AbstractChannelHandlerContext next)</span> </span>&#123;</div><div class="line">        EventExecutor executor = next.executor();</div><div class="line">        <span class="keyword">if</span> (executor.inEventLoop()) &#123;</div><div class="line">            next.invokeChannelActive();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            executor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    next.invokeChannelActive();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeChannelActive</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (invokeHandler()) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">              <span class="comment">// è¿™é‡Œhandler()è¿”å›HeadContext</span></div><div class="line">                ((ChannelInboundHandler) handler()).channelActive(<span class="keyword">this</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                notifyHandlerException(t);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            fireChannelActive();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>channelInactive</code>ä¼šè°ƒç”¨<code>HeadContext</code>ç±»çš„<code>channelInactive</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            ctx.fireChannelActive();</div><div class="line">            readIfIsAutoRead();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œé¦–å…ˆæ‰§è¡Œ<code>fireChannelActive</code>æ–¹æ³•ï¼Œæ²¿ç€<code>pipeline</code>ä¼ æ’­ç»™åç»­<code>ChannelInboundHandler</code>ï¼Œæ‰§è¡Œ<code>hannelActive()</code>æ–¹æ³•ï¼›æ¥ç€æ‰§è¡Œ<code>readIfIsAutoRead()</code>ï¼Œå¯ä»¥å‘ç°è¿™ä¸ªæ–¹æ³•ä½œç”¨åœ¨<code>pipeline</code>ä¸Šï¼Œä»<code>tail</code>åˆ°<code>head</code>éå†<code>ChannelOutboundHandler</code>æ‰§è¡Œ<code>read()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬è¿™é‡Œåªæœ‰<code>head</code>æ˜¯<code>outBound</code>ï¼Œ<code>read()</code>æ–¹æ³•æœ€åè¿›å…¥<code>AbstractNioChannel.doBeginRead()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBeginRead</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">final</span> SelectionKey selectionKey = <span class="keyword">this</span>.selectionKey;</div><div class="line">    <span class="keyword">if</span> (!selectionKey.isValid()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    readPending = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> interestOps = selectionKey.interestOps();</div><div class="line">    <span class="keyword">if</span> ((interestOps &amp; readInterestOp) == <span class="number">0</span>) &#123; </div><div class="line">        <span class="comment">// interestOpsæ˜¯0ï¼ŒæŒ‰ä½ä¸ç»“æœè‚¯å®šæ˜¯0</span></div><div class="line">        selectionKey.interestOps(interestOps | readInterestOp);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥å‘ç°åœ¨æ‰§è¡Œ<code>doRegister()</code>æ³¨å†Œè¿™ä¸ª<code>Channel</code>åˆ°<code>selector</code>çš„æ—¶å€™ï¼Œ<code>selectKey</code>èµ‹äºˆäº†0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> selected = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">              <span class="comment">// selectKeyèµ‹äºˆäº†0</span></div><div class="line">        selectionKey = javaChannel().register(eventLoop().unwrappedSelector(), <span class="number">0</span>, <span class="keyword">this</span>);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123; </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œ<code>readInterestOp</code>è¿™ä¸ªå“ªæ¥çš„ï¼šåœ¨åˆ›å»º<code>NioServerSocketChannel</code>çš„æ—¶å€™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioServerSocketChannel</span><span class="params">(ServerSocketChannel channel)</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>(<span class="keyword">null</span>, channel, SelectionKey.OP_ACCEPT);</div><div class="line">       config = <span class="keyword">new</span> NioServerSocketChannelConfig(<span class="keyword">this</span>, javaChannel().socket());</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œé‡æ–°æ³¨å†Œäº†<code>accept</code>äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ä»æ­¤å¼€å§‹ï¼Œ<code>selector</code>å†è½®è¯¢åˆ°æ–°çš„è¿æ¥æ¥å…¥äº‹ä»¶ï¼Œå°±å¯ä»¥äº¤ç»™è¿™ä¸ª<code>NioServerSocketChannel</code>æ¥å¤„ç†äº†</p>
<p>è‡³æ­¤ï¼Œ<code>Netty</code>æœåŠ¡å™¨æ®µå·²ç»å¯åŠ¨ï¼Œ<code>Channel</code>å’Œ<code>ChannelPipeline</code>å·²ç»å»ºç«‹ï¼Œ<code>EventLoop</code>ä¹Ÿåœ¨ä¸æ–­çš„<code>select()</code>æŸ¥æ‰¾å‡†å¤‡å¥½çš„I/Oã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol>
<li>é€šè¿‡å·¥å‚ç”Ÿæˆ<code>NioServerSocketChannel</code>ã€‚</li>
<li>è®¾ç½®<code>NioServerSocketChannel</code>å¯¹<code>accept</code>äº‹ä»¶æ„Ÿå…´è¶£ã€‚æ­¤æ—¶<code>Channel</code>å·²ç»ç»‘å®šäº†<code>unsafe</code>å’Œ<code>pipeline</code></li>
<li>åˆå§‹åŒ–<code>Channel</code>ï¼Œè¿™é‡Œä¸»è¦æ˜¯è®¾ç½®<code>Channel</code>çš„<code>pipeline</code>ä¸­çš„<code>handler</code>ã€<code>attr</code>å’Œ<code>option</code>ã€‚è¿™é‡Œçš„<code>handler</code>æ˜¯ç‰¹æ®Šç±»å‹<code>ChannelInitializer</code>ï¼Œç­‰å¾…æ³¨å†Œåå›è°ƒã€‚</li>
<li>æ³¨å†Œåˆ°<code>EventLoopGroup</code>é‡Œï¼Œæœ€ç»ˆæ˜¯æ³¨å†Œåˆ°æŸä¸€ä¸ª<code>NioEventLoop</code>ä¸Šé¢</li>
<li>åœ¨æ³¨å†Œæ—¶å®é™…ä¸Šçš„<code>register0</code>æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œ<code>register0</code>çš„ä¸»è¦ä½œç”¨æ˜¯æŠŠåŸç”Ÿ<code>Channel</code>æ³¨å†Œåˆ°åŸç”Ÿ<code>selector</code>ä¸Šã€‚</li>
<li>æ‰§è¡Œ<code>doBind0</code>ä¹Ÿæ˜¯å¼‚æ­¥åªæƒ³ï¼Œè¿™é‡Œå…¶å®æ˜¯å’Œ<code>register0</code>ä¸€èµ·åœ¨æ‰§è¡Œçš„ã€‚<code>doBind0</code>æ˜¯æŠŠ<code>channel</code>æ³¨å†Œåˆ°æœ¬åœ°ç«¯å£ä¸Š</li>
<li>æ‰§è¡Œ<code>pipeline.readï¼ˆï¼‰</code>æ–¹æ³•ï¼Œæœ€ç»ˆä¼ é€’åˆ°<code>AbstractNioChannel</code>ï¼Œé‡æ–°å‘<code>selector</code>æ³¨å†Œ<code>OP_ACCEPT</code>äº‹ä»¶</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Netty é›¶æ‹·è´]]></title>
      <url>http://zsr.github.io/2018/12/19/Netty-%E9%9B%B6%E6%8B%B7%E8%B4%9D/</url>
      <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Zero-Copy describes computer operations in which the CPU does not perform the task of copying data from one memory area to another.</div></pre></td></tr></table></figure>
<h3 id="ç£ç›˜æ•°æ®é€šè¿‡ç½‘ç»œå‘é€"><a href="#ç£ç›˜æ•°æ®é€šè¿‡ç½‘ç»œå‘é€" class="headerlink" title="ç£ç›˜æ•°æ®é€šè¿‡ç½‘ç»œå‘é€"></a>ç£ç›˜æ•°æ®é€šè¿‡ç½‘ç»œå‘é€</h3><h4 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h4><ol>
<li>å½“åº”ç”¨ç¨‹åºå‘èµ·<code>read</code>ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œé€šè¿‡<code>DMAï¼ˆDirect Memory Accessï¼‰</code>å°†æ•°æ®<code>copy</code>åˆ°å†…æ ¸ç©ºé—´<code>buffer</code></li>
<li>ç„¶åç”±<code>CPU</code>æ§åˆ¶å°†å†…æ ¸ç©ºé—´æ•°æ®<code>copy</code>åˆ°ç”¨æˆ·ç©ºé—´ä¸‹çš„ <code>buffer</code>ä¸­</li>
<li><code>read</code>è°ƒç”¨å®Œæˆåï¼Œ<code>write</code>è°ƒç”¨é¦–å…ˆå°†ç”¨æˆ·ç©ºé—´ä¸‹ <code>buffer</code>ä¸­çš„æ•°æ®<code>copy</code>åˆ°å†…æ ¸æ¨¡å¼ä¸‹çš„<code>socket buffer</code>ä¸­</li>
<li>æœ€åé€šè¿‡<code>DMA</code>å°†å†…æ ¸æ¨¡å¼ä¸‹çš„<code>socket buffer</code>ä¸­çš„æ•°æ®<code>copy</code>åˆ°ç½‘å¡<code>buffer</code>ä¸­</li>
</ol>
<h4 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><p>æ•°æ®ä»å†…æ ¸æ¨¡å¼åˆ°ç”¨æˆ·æ¨¡å¼èµ°äº†ä¸€åœˆï¼Œæµªè´¹äº†ä¸¤æ¬¡<code>copy</code>ï¼Œè€Œè¿™ä¸¤æ¬¡<code>copy</code>éƒ½æ˜¯<code>CPU copy</code>(å ç”¨<code>CPU</code>èµ„æº)</p>
<h3 id="æ“ä½œç³»ç»Ÿ-é›¶æ‹·è´"><a href="#æ“ä½œç³»ç»Ÿ-é›¶æ‹·è´" class="headerlink" title="æ“ä½œç³»ç»Ÿ é›¶æ‹·è´"></a>æ“ä½œç³»ç»Ÿ é›¶æ‹·è´</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">OS-level zero copy involves avoiding copying memory blocks from one location to another (typically from user space to kernel space) before sending data to the hardware driver (network card or disk drive) or vice versa.</div></pre></td></tr></table></figure>
<p>å…¸å‹åœºæ™¯ï¼šå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„æ•°æ®æ‹·è´</p>
<h4 id="Linux-sendfile"><a href="#Linux-sendfile" class="headerlink" title="Linux sendfile"></a><code>Linux sendfile</code></h4><p><strong>os &gt;= Linux 2.4å†…æ ¸</strong></p>
<h5 id="æ­¥éª¤-1"><a href="#æ­¥éª¤-1" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h5><ol>
<li><code>DMA copy</code>å°†ç£ç›˜æ•°æ®<code>copy</code>åˆ°<code>kernel buffer</code>ä¸­</li>
<li>å‘<code>socket buffer</code>ä¸­è¿½åŠ å½“å‰è¦å‘é€çš„æ•°æ®åœ¨<code>kernel buffer</code>ä¸­çš„ä½ç½®å’Œåç§»é‡</li>
<li><code>DMA gather copy</code>ï¼ˆéœ€è¦ç½‘å¡æ”¯æŒæ•°æ®æ”¶é›†æ¨¡å¼ï¼‰æ ¹æ®<code>socket buffer</code>ä¸­çš„ä½ç½®å’Œåç§»é‡ç›´æ¥å°†<code>kernel buffer</code>ä¸­çš„æ•°æ®<code>copy</code>åˆ°ç½‘å¡ä¸Š</li>
</ol>
<h5 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h5><p>ç¨‹åºåªéœ€å‘å‡ºä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨<code>sendfile()</code>ï¼Œæ•°æ®åªç»è¿‡äº†2æ¬¡<code>copy</code>å°±ä»ç£ç›˜ä¼ é€å‡ºå»äº†ï¼Œæ²¡æœ‰<code>CPU copy</code></p>
<p><code>nginx</code>ï¼Œ<code>java FileChannel.transferTo()</code>ç­‰åœ¨<code>Linux</code>ç³»ç»Ÿä¸­éƒ½å¼•ç”¨äº†<code>sendfile</code>æœºåˆ¶</p>
<h3 id="FileChannel-transferTo-Javaä¸­çš„é›¶æ‹·è´"><a href="#FileChannel-transferTo-Javaä¸­çš„é›¶æ‹·è´" class="headerlink" title="FileChannel.transferTo(Javaä¸­çš„é›¶æ‹·è´)"></a><code>FileChannel.transferTo</code>(<code>Javaä¸­çš„é›¶æ‹·è´</code>)</h3><p><code>Java NIO</code>ä¸­<code>FileChannel.transferTo(long position, long count, WriteableByteChannel target)</code>æ–¹æ³•å°†å½“å‰é€šé“ä¸­çš„æ•°æ®ä¼ é€åˆ°ç›®æ ‡é€šé“ä¸­ï¼Œåœ¨æ”¯æŒ<code>Zero-Copy</code>çš„<code>linux</code>ç³»ç»Ÿä¸­ï¼Œ<code>transferTo()</code>çš„å®ç°ä¾èµ–äº<code>sendfile()</code>è°ƒç”¨</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fymbp5iat5j30uo0imjsz.jpg" alt=""></p>
<h3 id="Nettyé›¶æ‹·è´"><a href="#Nettyé›¶æ‹·è´" class="headerlink" title="Nettyé›¶æ‹·è´"></a><code>Netty</code>é›¶æ‹·è´</h3><ol>
<li><code>Netty</code>çš„æ¥æ”¶å’Œå‘é€<code>ByteBuffer</code>é‡‡ç”¨<code>DIRECT BUFFERS</code>ï¼Œä½¿ç”¨å †å¤–å†…å­˜è¿›è¡Œ<code>Socket</code>è¯»å†™ï¼Œä¸éœ€è¦è¿›è¡Œå­—èŠ‚ç¼“å†²åŒºçš„äºŒæ¬¡æ‹·è´ã€‚å¦‚æœä½¿ç”¨ä¼ ç»Ÿçš„å †å†…å­˜ï¼ˆ<code>HEAP BUFFERS</code>ï¼‰è¿›è¡Œ<code>Socket</code>è¯»å†™ï¼Œ<code>JVM</code>ä¼šå°†å †å†…å­˜<code>Buffer</code>æ‹·è´ä¸€ä»½åˆ°ç›´æ¥å†…å­˜ä¸­ï¼Œç„¶åæ‰å†™å…¥<code>Socket</code>ä¸­ã€‚ç›¸æ¯”äºå †å¤–ç›´æ¥å†…å­˜ï¼Œæ¶ˆæ¯åœ¨å‘é€è¿‡ç¨‹ä¸­å¤šäº†ä¸€æ¬¡ç¼“å†²åŒºçš„å†…å­˜æ‹·è´ã€‚</li>
<li><p><code>Netty</code>æä¾›äº†<code>CompositeByteBuf</code>å¯¹è±¡ï¼Œå¯ä»¥èšåˆå¤šä¸ª<code>ByteBuffer</code>å¯¹è±¡ï¼Œç”¨æˆ·å¯ä»¥åƒæ“ä½œä¸€ä¸ª<code>Buffer</code>é‚£æ ·æ–¹ä¾¿çš„å¯¹ç»„åˆ<code>Buffer</code>è¿›è¡Œæ“ä½œï¼Œé¿å…äº†ä¼ ç»Ÿé€šè¿‡å†…å­˜æ‹·è´çš„æ–¹å¼å°†å‡ ä¸ªå°<code>Buffer</code>åˆå¹¶æˆä¸€ä¸ªå¤§çš„<code>Buffer</code>ã€‚</p>
</li>
<li><p><code>Netty</code>çš„æ–‡ä»¶ä¼ è¾“é‡‡ç”¨äº†<code>java nio transferTo</code>æ–¹æ³•ï¼Œå®ƒå¯ä»¥ç›´æ¥å°†æ–‡ä»¶ç¼“å†²åŒºçš„æ•°æ®å‘é€åˆ°ç›®æ ‡<code>Channel</code>ï¼ˆä¼ ç»Ÿçš„åšæ³•: æ‹·è´æ–‡ä»¶å†…å®¹åˆ°ä¸´æ—¶ <code>buffer</code>, ç„¶åå†å°† <code>buffer</code> å†™å…¥<code>Channel</code>ï¼‰ï¼Œä½¿ç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„é›¶æ‹·è´ï¼Œé¿å…äº†ä¼ ç»Ÿé€šè¿‡å¾ªç¯<code>write</code>æ–¹å¼å¯¼è‡´çš„å†…å­˜æ‹·è´é—®é¢˜</p>
</li>
</ol>
<h4 id="CompositeByteBuf"><a href="#CompositeByteBuf" class="headerlink" title="CompositeByteBuf"></a><code>CompositeByteBuf</code></h4><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fynh0n2p3wj30l40bwmxi.jpg" alt=""></p>
<p><strong>æ³¨æ„ï¼š <code>CompositeByteBuf</code> æ˜¯ç”±å¤šä¸ª <code>ByteBuf</code> ç»„åˆè€Œæˆçš„, ä¸è¿‡åœ¨ <code>CompositeByteBuf</code> å†…éƒ¨, è¿™äº› <code>ByteBuf</code> éƒ½æ˜¯å•ç‹¬å­˜åœ¨çš„, <code>CompositeByteBuf</code> ä¿å­˜äº†å®ƒä»¬çš„å¼•ç”¨ï¼Œåªæ˜¯åœ¨é€»è¾‘ä¸Šæ˜¯ä¸€ä¸ªæ•´ä½“</strong></p>
<h4 id="java-ByteBuffer-vs-netty-ByteBuf"><a href="#java-ByteBuffer-vs-netty-ByteBuf" class="headerlink" title="java ByteBuffer vs netty ByteBuf"></a><code>java ByteBuffer</code> vs <code>netty ByteBuf</code></h4><p><code>java</code> æœ¬èº«å°±æœ‰ <code>ByteBuffer</code>ï¼Œä¸ºä»€ä¹ˆè¦é¢å¤–è®¾è®¡ä¸€ä¸ª <code>ByteBuf</code>?</p>
<ul>
<li><code>ByteBuffer</code> åªç”¨ä¸€ä¸ª <code>position</code> å˜é‡è¡¨ç¤ºå½“å‰ä½ç½®ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œè¯»å†™åˆ‡æ¢çš„æ—¶å€™éƒ½éœ€è¦è°ƒç”¨<code>flip()</code>å’Œ<code>clear()</code>ç­‰æ–¹æ³•ï¼Œå¦åˆ™åŠŸèƒ½å°†å‡ºé”™</li>
<li><code>ByteBuf</code> ä½¿ç”¨ <code>readerIndex</code> å’Œ <code>writerIndex</code> åˆ†åˆ«è¡¨ç¤ºè¯»å†™ä½ç½®ï¼Œä¸éœ€è¦è°ƒç”¨å‡½æ•°åˆ‡æ¢ï¼Œä½“éªŒæ›´å¥½ã€‚</li>
</ul>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://segmentfault.com/a/1190000007692223" target="_blank" rel="external">ç£ç›˜åŠç½‘ç»œIOå·¥ä½œæ–¹å¼è§£æ</a></p>
<p><a href="https://stackoverflow.com/questions/20727615/is-nettys-zero-copy-different-from-os-level-zero-copy" target="_blank" rel="external">Is Nettyâ€™s Zero Copy different from OS level Zero Copy?</a></p>
<p><a href="https://caorong.github.io/2017/01/16/head-first-netty-3/" target="_blank" rel="external">æ·±å…¥æµ…å‡ºNetty - ByteBuf å’Œ ByteBufPool</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Netty æ ¸å¿ƒç»„ä»¶]]></title>
      <url>http://zsr.github.io/2018/12/15/Netty-%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/</url>
      <content type="html"><![CDATA[<h3 id="Nettyå·¥ä½œæ¶æ„å›¾"><a href="#Nettyå·¥ä½œæ¶æ„å›¾" class="headerlink" title="Nettyå·¥ä½œæ¶æ„å›¾"></a><code>Netty</code>å·¥ä½œæ¶æ„å›¾</h3><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fycc2uem9sj313i0p643a.jpg" alt=""></p>
<h3 id="æ¨¡å—ç»„ä»¶"><a href="#æ¨¡å—ç»„ä»¶" class="headerlink" title="æ¨¡å—ç»„ä»¶"></a>æ¨¡å—ç»„ä»¶</h3><h4 id="Bootstrap"><a href="#Bootstrap" class="headerlink" title="Bootstrap"></a><code>Bootstrap</code></h4><p><code>Bootstrap</code>æ˜¯å¯åŠ¨å¼•å¯¼ç±»ï¼Œä¸€ä¸ª <code>Netty</code> åº”ç”¨é€šå¸¸ç”±ä¸€ä¸ª <code>Bootstrap</code> å¼€å§‹ï¼Œä¸»è¦ä½œç”¨æ˜¯é…ç½®æ•´ä¸ª <code>Netty</code> ç¨‹åºï¼Œä¸²è”å„ä¸ªç»„ä»¶</p>
<ul>
<li><code>Bootstrap</code> ç±»æ˜¯å®¢æˆ·ç«¯ç¨‹åºçš„å¯åŠ¨å¼•å¯¼ç±»</li>
<li><code>ServerBootstrap</code> ç±»æ˜¯æœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼ç±»</li>
</ul>
<h4 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a><code>Channel</code></h4><p><code>Channel</code>çš„æœ¬è´¨æ˜¯å¯¹æ“ä½œç³»ç»Ÿäº§ç”Ÿçš„FDï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰çš„æ˜ å°„ï¼Œå¹¶ä¸”æä¾›ç»‘å®šåˆ°<code>Selector</code>å¤šè·¯é€‰æ‹©å™¨ä¸Šçš„èƒ½åŠ›</p>
<h4 id="ChannelFuture"><a href="#ChannelFuture" class="headerlink" title="ChannelFuture"></a><code>ChannelFuture</code></h4><p>åœ¨ <code>Netty</code> ä¸­æ‰€æœ‰çš„IOæ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸èƒ½ç«‹åˆ»å¾—çŸ¥æ¶ˆæ¯æ˜¯å¦è¢«æ­£ç¡®å¤„ç†ã€‚ <code>Future</code> å¯¹è±¡å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œç»“æœçš„å ä½ç¬¦ï¼›å®ƒå°†åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»å®Œæˆï¼Œå¹¶æä¾›å¯¹å…¶ç»“æœçš„è®¿é—®ã€‚</p>
<p><code>Netty</code> æä¾›äº†<code>ChannelFuture</code>ï¼Œç”¨äºåœ¨æ‰§è¡Œå¼‚æ­¥æ“ä½œçš„æ—¶å€™ä½¿ç”¨ã€‚æ¯ä¸ª<code>Netty</code>çš„å‡ºç«™IOæ“ä½œéƒ½ä¼šè¿”å›ä¸€ä¸ª<code>ChannelFuture</code>ã€‚<code>ChannelFuture</code>å¯ä»¥æ³¨å†Œ<code>ChannelFutureListener</code> å®ä¾‹ï¼Œå…¶ä¸­çš„å›è°ƒæ–¹æ³•<code>operationComplete()</code>,å°†ä¼šåœ¨å¯¹åº”çš„æ“ä½œå®Œæˆæ—¶è¢«è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">ChannelFuture <span class="title">write</span><span class="params">(Object msg, ChannelPromise promise)</span></span>;</div></pre></td></tr></table></figure>
<h4 id="ChannelHandler"><a href="#ChannelHandler" class="headerlink" title="ChannelHandler"></a><code>ChannelHandler</code></h4><p><code>ChannelHandler</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒå……å½“äº†æ‰€æœ‰å¤„ç†å…¥ç«™å’Œå‡ºç«™æ•°æ®çš„åº”ç”¨ç¨‹åºé€»è¾‘çš„å®¹å™¨ï¼Œå¹¶å°†å…¶è½¬å‘åˆ°å…¶ <code>ChannelPipeline</code>ä¸­çš„ä¸‹ä¸€ä¸ª<code>ChannelHandler</code>ï¼›è¯¥ç±»æ˜¯åŸºäºäº‹ä»¶é©±åŠ¨çš„ï¼Œå®ƒä¼šå“åº”ç›¸å…³çš„äº‹ä»¶ç„¶åå»è°ƒç”¨å…¶å…³è”çš„å›è°ƒå‡½æ•°ï¼Œä¾‹å¦‚ï¼šå½“ä¸€ä¸ªæ–°çš„è¿æ¥è¢«å»ºç«‹æ—¶ï¼Œ<code>ChannelHandler</code>çš„<code>channelActive()</code>æ–¹æ³•å°†ä¼šè¢«è°ƒç”¨</p>
<p><code>ChannelHandler</code>å­ç±»ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li><code>ChannelInboundHandler</code>ï¼šç”¨äºå¤„ç†å…¥ç«™IOäº‹ä»¶ã€‚</li>
<li><code>ChannelOutboundHandler</code>ï¼šç”¨äºå¤„ç†å‡ºç«™IOæ“ä½œã€‚</li>
</ul>
<h4 id="ChannelPipline"><a href="#ChannelPipline" class="headerlink" title="ChannelPipline"></a><code>ChannelPipline</code></h4><p><code>ChannelPipeline</code> æ˜¯èšåˆäº† <code>ChannelHandler</code> çš„ç®¡é“ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªèŒè´£é“¾è·¯ï¼ˆç”¨äºå¤„ç†<code>Channel</code>çš„å…¥ç«™äº‹ä»¶å’Œå‡ºç«™æ“ä½œï¼‰ï¼Œåœ¨<code>Worker</code>çº¿ç¨‹ä¸­ä¼šå¯¹æ¯ä¸€ä¸ª<code>Channel</code>æ‰§è¡Œå…¶æ‰€å¯¹åº”çš„<code>pipeline</code>é“¾ï¼Œå®Œæˆæ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fy8rq2caj7j30uw08k76d.jpg" alt=""></p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fy8tkgaop2j31jo0mcac9.jpg" alt=""></p>
<p>è“è‰²è¡¨ç¤º <code>ChannelInboundHandler</code> ï¼Œç»¿è‰²è¡¨ç¤º <code>ChannelOutboundHandler</code>ï¼Œé»„è‰²åˆ™æ‰¿æ‹…ä¸¤ä¸ªè§’è‰²ï¼Œè€Œæ¯ä¸ª<code>Handler</code>åˆä¼šä½¿ç”¨ <code>ChannelHandlerContext</code> å°è£…èµ·æ¥ï¼Œåœ¨ <code>ChannelPipeline</code> ä¸­ç»„è£…æˆåŒå‘é“¾è¡¨ã€‚</p>
<p><strong>ChannelPipeline handler æ‰§è¡Œé¡ºåº</strong>ï¼š</p>
<ul>
<li><strong>å…¥ç«™äº‹ä»¶æµä»å¤´åˆ°å°¾æ‰§è¡Œæ‰€æœ‰çš„<code>handler</code>(å…¥ç«™çš„æ—¶å€™ä¹Ÿä¼šç»è¿‡<code>OutboundChannelHandler</code>ï¼Œåªä¸è¿‡ç•¥è¿‡äº†è¿™ä¸ª<code>ChannelHandler</code>)</strong></li>
<li><strong>å‡ºç«™äº‹ä»¶æµä»å°¾åˆ°å¤´æ‰§è¡Œæ‰€æœ‰çš„<code>handler</code>(å‡ºç«™çš„æ—¶å€™ä¹Ÿä¼šç»è¿‡<code>InboundChannelHandler</code>ï¼Œåªä¸è¿‡ç•¥è¿‡äº†è¿™ä¸ª<code>ChannelHandler</code>)</strong></li>
</ul>
<p><strong>æ³¨æ„ï¼š åœ¨å…·ä½“ä¸šåŠ¡å¤„ç†ç±»<code>ProcessingHandler</code>ä¸­å°†å“åº”æ•°æ®å‘å‡ºæœ‰2ç§æ–¹å¼</strong>ï¼š</p>
<ol>
<li><code>ChannelHandlerContext.writeAndFlush(msg)</code>ï¼šä¸ç”¨ç»è¿‡<code>TailConext</code>, ä»è¯¥<code>handler</code>å¼€å§‹å¾€å‰æ‰§è¡Œ<code>OutboundChannelHandler</code>ï¼Œæ€§èƒ½æ›´å¥½ä¸€äº›</li>
<li><code>ChannelHandlerContext.pipeline().writeAndFlush(msg)</code>ï¼šä»<code>TailConext</code>å¼€å§‹æ‰§è¡Œï¼Œ å¾€å‰æ‰§è¡Œ<code>OutboundChannelHandler</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> AbstractChannelHandlerContext <span class="title">findContextOutbound</span><span class="params">()</span> </span>&#123;</div><div class="line">        AbstractChannelHandlerContext ctx = <span class="keyword">this</span>;</div><div class="line">        do &#123;</div><div class="line">            <span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œæ˜¯å¾€å‰æ‰¾</span></div><div class="line">            ctx = ctx.prev;</div><div class="line">        &#125; <span class="keyword">while</span> (!ctx.outbound);</div><div class="line">        <span class="keyword">return</span> ctx;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="EventLoop"><a href="#EventLoop" class="headerlink" title="EventLoop"></a><code>EventLoop</code></h4><p><code>EventLoop</code> æ˜¯äº‹ä»¶å¾ªç¯ï¼Œå¯¹åº”<code>Reactor</code>çº¿ç¨‹ï¼Œä»¥ <code>NioEventLoop</code> ä¸ºä¾‹ï¼Œå®ç°åŸç†æ˜¯ï¼šç»´æŠ¤äº†ä¸€ä¸ªçº¿ç¨‹å’Œä»»åŠ¡é˜Ÿåˆ—ï¼Œæ”¯æŒå¼‚æ­¥æäº¤ä»»åŠ¡ï¼Œçº¿ç¨‹å¯åŠ¨æ—¶ä¼šè°ƒç”¨<code>NioEventLoop</code> çš„ <code>run</code> æ–¹æ³•ï¼Œæ‰§è¡ŒIOä»»åŠ¡å’ŒéIOä»»åŠ¡ï¼Œç”±äº <code>EventLoop</code> æ˜¯å•çº¿ç¨‹ï¼Œå› æ­¤åœ¨ä½¿ç”¨æ—¶è¦æ³¨æ„è€—æ—¶æ“ä½œï¼Œé˜»å¡æ“ä½œéƒ½ä¸è¦æ”¾åˆ° <code>EventLoop</code> ä¸­ï¼Œå…¶é€‚åˆå¤„ç†è€—æ—¶çŸ­å¹¶ä¸”ç®€å•çš„ä»»åŠ¡</p>
<ul>
<li><strong>IOä»»åŠ¡</strong>ï¼šå³ <code>selectionKey</code> ä¸­äº‹ä»¶ï¼Œå¦‚ <code>accept</code>ã€<code>connect</code>ã€<code>read</code>ã€<code>write</code>ç­‰ï¼Œç”±<code>processSelectedKeys</code>æ–¹æ³•è§¦å‘ã€‚</li>
<li><strong>éIOä»»åŠ¡</strong>ï¼šæ·»åŠ åˆ° <code>taskQueue</code> ä¸­çš„ä»»åŠ¡ï¼Œå¦‚å»¶è¿Ÿä»»åŠ¡ï¼Œç”± <code>runAllTasks</code> æ–¹æ³•è§¦å‘ã€‚</li>
</ul>
<p>ä¸¤ç§ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æ¯”ç”±å˜é‡ <code>ioRatio</code> æ§åˆ¶ï¼Œé»˜è®¤ä¸º50%ï¼Œåˆ™è¡¨ç¤ºå…è®¸<strong>éIOä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´ä¸IOä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ç›¸ç­‰</strong></p>
<h4 id="EventLoopGroup"><a href="#EventLoopGroup" class="headerlink" title="EventLoopGroup"></a><code>EventLoopGroup</code></h4><p><code>EventLoopGroup</code>åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ª<code>EventLoop</code>ï¼Œä¸»è¦ç®¡ç†<code>EventLoop</code>çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ç»„çº¿ç¨‹ï¼Œ<strong>æ¯ä¸ªçº¿ç¨‹(<code>EventLoop</code>)å¯ä»¥è´Ÿè´£å¤„ç†å¤šä¸ª<code>Channel</code>ä¸Šçš„äº‹ä»¶ï¼Œè€Œä¸€ä¸ª<code>Channel</code>åªèƒ½æ³¨å†Œäºä¸€ä¸ª<code>EventLoop</code>(é˜²æ­¢çº¿ç¨‹å¹¶å‘é—®é¢˜)</strong></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://www.lmlphp.com/user/95/article/item/12624/" target="_blank" rel="external">æœ€é€å½»çš„NettyåŸç†æ¶æ„è§£æ</a></p>
<p><a href="http://www.liuhaihua.cn/archives/530938.html" target="_blank" rel="external">Nettyâ€“Reactoræ¨¡å‹çš„åº”ç”¨</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Netty fix epoll bug]]></title>
      <url>http://zsr.github.io/2018/12/15/Netty-fix-epoll-bug/</url>
      <content type="html"><![CDATA[<p><code>JDK NIO</code>çš„<code>epoll bug</code>ï¼Œä¼šå¯¼è‡´<code>Selector</code>ç©ºè½®è¯¢ï¼Œæœ€ç»ˆå¯¼è‡´CPU 100%</p>
<h3 id="Bugå‡ºç°çš„åŸå› "><a href="#Bugå‡ºç°çš„åŸå› " class="headerlink" title="Bugå‡ºç°çš„åŸå› "></a><strong><code>Bug</code>å‡ºç°çš„åŸå› </strong></h3><p>è‹¥<code>Selector</code>çš„è½®è¯¢ç»“æœä¸€ç›´ä¸ºç©ºï¼Œæ²¡æœ‰æ–°æ¶ˆæ¯å¤„ç†ï¼Œåˆ™å‘ç”Ÿç©ºè½®è¯¢ï¼ŒCPUä½¿ç”¨ç‡100%ï¼ˆåœ¨<code>selector</code>ä¸­ï¼Œå³ä½¿æ˜¯<code>select</code>è½®è¯¢äº‹ä»¶ä¸º0çš„è¯ï¼Œç…§æ ·ä¸æ–­çš„ä»<code>select</code>æœ¬åº”è¯¥é˜»å¡çŠ¶æ€ä¸‹<code>wake up</code>å‡ºæ¥ï¼‰</p>
<h3 id="Nettyçš„è§£å†³æ–¹æ¡ˆ"><a href="#Nettyçš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="Nettyçš„è§£å†³æ–¹æ¡ˆ"></a><strong><code>Netty</code>çš„è§£å†³æ–¹æ¡ˆ</strong></h3><ul>
<li>å¯¹<code>Selector</code>çš„<code>select</code>æ“ä½œå‘¨æœŸè¿›è¡Œç»Ÿè®¡ï¼Œæ¯å®Œæˆä¸€æ¬¡ç©ºçš„<code>select</code>æ“ä½œè¿›è¡Œä¸€æ¬¡è®¡æ•°</li>
<li>è‹¥åœ¨æŸä¸ªå‘¨æœŸå†…è¿ç»­å‘ç”ŸNæ¬¡ç©ºè½®è¯¢ï¼Œåˆ™è§¦å‘äº†<code>epoll</code>æ­»å¾ªç¯bugã€‚</li>
<li>é‡å»º<code>Selector</code>ï¼Œå°†å‡ºç°bugçš„<code>Selector</code>ä¸Šçš„<code>channel</code>é‡æ–°æ³¨å†Œåˆ°æ–°çš„<code>Selector</code>ä¸Šï¼Œå¹¶å°†åŸæ¥çš„<code>Selector</code>å…³é—­ï¼Œä½¿ç”¨æ–°çš„<code>Selector</code>è¿›è¡Œæ›¿æ¢ã€‚</li>
</ul>
<h3 id="JDKæºç åˆ†æï¼š"><a href="#JDKæºç åˆ†æï¼š" class="headerlink" title="JDKæºç åˆ†æï¼š"></a><code>JDK</code>æºç åˆ†æï¼š</h3><p><code>JDK NIO</code>æ‰§è¡Œä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy7ija4ukgj311e0j2q7v.jpg" alt=""></p>
<p>æ‰§è¡Œ<code>selector.select()</code>æ–¹æ³•è¿”å›keysæ˜¯0ï¼Œæ‰€ä»¥æœ¬åº”è¯¥å¯¹keyå€¼è¿›è¡Œéå†çš„äº‹ä»¶å¤„ç†æ ¹æœ¬æ²¡æœ‰æ‰§è¡Œï¼Œåˆå›åˆ°æœ€ä¸Šé¢çš„<code>while(true)</code>å¾ªç¯ï¼Œå¾ªç¯å¾€å¤ï¼Œä¸æ–­çš„è½®è¯¢ï¼Œç›´åˆ°ç³»ç»Ÿå‡ºç°100%çš„CPUæƒ…å†µï¼Œæœ€ç»ˆå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p>
<h3 id="Nettyæºç åˆ†æ"><a href="#Nettyæºç åˆ†æ" class="headerlink" title="Nettyæºç åˆ†æ"></a><code>Netty</code>æºç åˆ†æ</h3><p>å…·ä½“ä½ç½®åœ¨å®ç°ç±»<code>NioEventLoop</code>ä¸­ï¼š</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fy7jey5qmkj315c0nigso.jpg" alt=""></p>
<p><code>netty</code>ä¼šåœ¨æ¯æ¬¡è¿›è¡Œ <code>selector.select(timeoutMillis)</code> ä¹‹å‰è®°å½•ä¸€ä¸‹å¼€å§‹æ—¶é—´<code>currentTimeNanos</code>ï¼Œåœ¨<code>select</code>ä¹‹åè®°å½•ä¸€ä¸‹ç»“æŸæ—¶é—´ï¼Œåˆ¤æ–­<code>select</code>æ“ä½œæ˜¯å¦è‡³å°‘æŒç»­äº†<code>timeoutMillis</code>æ—¶é—´ï¼›<code>selectCnt</code>è®°å½•ç©ºè½®è¯¢æ¬¡æ•°</p>
<h4 id="é‡å»ºselector"><a href="#é‡å»ºselector" class="headerlink" title="é‡å»ºselector"></a>é‡å»º<code>selector</code></h4><p>å½“å‘ç”Ÿ<code>epoll bug</code>ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„<code>Selector</code>ï¼Œå°†å‡ºç°bugçš„<code>Selector</code>ä¸Šçš„<code>channel</code>é‡æ–°æ³¨å†Œåˆ°æ–°çš„<code>Selector</code>ä¸Šï¼Œå…³é—­bugçš„<code>Selector</code>ï¼Œä½¿ç”¨æ–°çš„<code>Selector</code>è¿›è¡Œæ›¿æ¢ :</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy7k5ilf63j31h40u0ahl.jpg" alt=""></p>
<p><code>Netty</code>çš„è§£å†³ç­–ç•¥ï¼š</p>
<ul>
<li>æ ¹æ®è¯¥<code>bug</code>çš„ç‰¹å¾ï¼Œé¦–å…ˆä¾¦æµ‹è¯¥<code>bug</code>æ˜¯å¦å‘ç”Ÿ</li>
<li>å°†é—®é¢˜<code>Selector</code>ä¸Šæ³¨å†Œçš„<code>Channel</code>è½¬ç§»åˆ°æ–°å»ºçš„<code>Selector</code>ä¸Š</li>
<li>è€çš„é—®é¢˜<code>Selector</code>å…³é—­ï¼Œä½¿ç”¨æ–°å»ºçš„<code>Selector</code>æ›¿æ¢</li>
</ul>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://www.cnblogs.com/JAYIT/p/8241634.html" target="_blank" rel="external">NIOçš„epollç©ºè½®è¯¢bug</a></p>
<p><a href="http://blogxin.cn/2017/03/20/Netty-epollbug/" target="_blank" rel="external">Nettyæºç åˆ†æ è§£å†³NIOçš„epollæ­»å¾ªç¯bug</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[java å’Œnetty epollå®ç°]]></title>
      <url>http://zsr.github.io/2018/12/14/java-%E5%92%8Cnetty-epoll%E5%AE%9E%E7%8E%B0/</url>
      <content type="html"><![CDATA[<p><code>Java NIO</code>æ ¹æ®æ“ä½œç³»ç»Ÿä¸åŒï¼Œ é’ˆå¯¹<code>Selector</code>æœ‰ä¸åŒçš„é»˜è®¤å®ç°ï¼š</p>
<ul>
<li><strong>macosx</strong>ï¼šKQueueSelectorProvider</li>
<li><strong>solaris</strong>ï¼šDevPollSelectorProvider</li>
<li><strong>Linux</strong>ï¼šEPollSelectorProvider (Linux kernels &gt;= 2.6)æˆ– PollSelectorProvider</li>
<li><strong>windows</strong>ï¼š WindowsSelectorProvider</li>
</ul>
<h3 id="ä¸ºä»€ä¹ˆnettyè¿˜è¦æä¾›ä¸€ä¸ªåŸºäºepollçš„å®ç°"><a href="#ä¸ºä»€ä¹ˆnettyè¿˜è¦æä¾›ä¸€ä¸ªåŸºäºepollçš„å®ç°" class="headerlink" title="ä¸ºä»€ä¹ˆnettyè¿˜è¦æä¾›ä¸€ä¸ªåŸºäºepollçš„å®ç°"></a>ä¸ºä»€ä¹ˆ<code>netty</code>è¿˜è¦æä¾›ä¸€ä¸ªåŸºäº<code>epoll</code>çš„å®ç°</h3><p>è‡ª4.0.16èµ·, <code>Netty</code>ä¸º<code>Linux</code>é€šè¿‡<code>JNI</code>çš„æ–¹å¼æä¾›äº†<code>native socket transport</code>.</p>
<ul>
<li><code>NioEventLoopGroup</code> â†’ <code>EpollEventLoopGroup</code></li>
<li><code>NioEventLoop</code> â†’ <code>EpollEventLoop</code></li>
<li><code>NioServerSocketChannel</code> â†’ <code>EpollServerSocketChannel</code></li>
<li><code>NioSocketChannel</code> â†’ <code>EpollSocketChannel</code></li>
</ul>
<p><strong>åŸå› ï¼š</strong></p>
<ol>
<li><code>Netty</code>çš„ <code>epoll transport</code>ä½¿ç”¨ <code>epoll</code>è¾¹ç¼˜è§¦å‘ è€Œ <code>java nio</code> ä½¿ç”¨ <code>epoll</code>æ°´å¹³è§¦å‘ï¼ˆåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œioæ¥äº†æ•°æ®ï¼Œå°±åªé€šçŸ¥è¿™äº›ioè®¾å¤‡å¯¹åº”çš„fdï¼Œä¸Šæ¬¡é€šçŸ¥è¿‡çš„fdä¸å†é€šçŸ¥ï¼Œå†…æ ¸ä¸ç”¨æ‰«æä¸€å¤§å †fdï¼‰</li>
<li><code>netty epoll transport</code> æš´éœ²äº†æ›´å¤šçš„<code>java nio</code>æ²¡æœ‰çš„é…ç½®å‚æ•°ï¼Œ å¦‚ <code>TCP_CORK</code>, <code>SO_REUSEADDR</code>ç­‰</li>
</ol>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://netty.io/wiki/native-transports.html" target="_blank" rel="external">Netty native transports</a></p>
<p><a href="https://stackoverflow.com/questions/23465401/why-native-epoll-support-is-introduced-in-netty" target="_blank" rel="external">Why native epoll support is introduced in Netty?</a></p>
<p><a href="https://www.cnblogs.com/tianhangzhang/p/5374034.html" target="_blank" rel="external">é«˜æ€§èƒ½ç½‘ç»œæœåŠ¡å™¨ç¼–ç¨‹ï¼šä¸ºä»€ä¹ˆlinuxä¸‹epollæ˜¯æœ€å¥½ï¼ŒNettyè¦æ¯”NIOå¥½ï¼Ÿ</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Netty Server Demo]]></title>
      <url>http://zsr.github.io/2018/12/14/Netty-Server-Demo/</url>
      <content type="html"><![CDATA[<h3 id="Mavenæ·»åŠ ä¾èµ–"><a href="#Mavenæ·»åŠ ä¾èµ–" class="headerlink" title="Mavenæ·»åŠ ä¾èµ–"></a><code>Maven</code>æ·»åŠ ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.29.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="Server-Demo"><a href="#Server-Demo" class="headerlink" title="Server Demo"></a><code>Server Demo</code></h3><h4 id="æ¨¡æ‹Ÿè¯·æ±‚-å“åº”model"><a href="#æ¨¡æ‹Ÿè¯·æ±‚-å“åº”model" class="headerlink" title="æ¨¡æ‹Ÿè¯·æ±‚/å“åº”model"></a>æ¨¡æ‹Ÿè¯·æ±‚/å“åº”<code>model</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.netty;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestData</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> intValue;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIntValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> intValue;</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIntValue</span><span class="params">(<span class="keyword">int</span> intValue)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.intValue = intValue;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// return RequestData inValue * 2</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseData</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> intValue;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIntValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> intValue;</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIntValue</span><span class="params">(<span class="keyword">int</span> intValue)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.intValue = intValue;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="æœåŠ¡ç«¯å¯¹è¯·æ±‚è§£ç "><a href="#æœåŠ¡ç«¯å¯¹è¯·æ±‚è§£ç " class="headerlink" title="æœåŠ¡ç«¯å¯¹è¯·æ±‚è§£ç "></a>æœåŠ¡ç«¯å¯¹è¯·æ±‚è§£ç </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerRequestDecoder</span> <span class="keyword">extends</span> <span class="title">ReplayingDecoder</span>&lt;<span class="title">RequestData</span>&gt; </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    RequestData data = <span class="keyword">new</span> RequestData();</div><div class="line">    data.setIntValue(in.readInt());</div><div class="line">    out.add(data);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="æœåŠ¡ç«¯å¯¹å“åº”ç¼–ç "><a href="#æœåŠ¡ç«¯å¯¹å“åº”ç¼–ç " class="headerlink" title="æœåŠ¡ç«¯å¯¹å“åº”ç¼–ç "></a>æœåŠ¡ç«¯å¯¹å“åº”ç¼–ç </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerResponseEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">ResponseData</span>&gt; </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, ResponseData msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    out.writeInt(msg.getIntValue());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="æœåŠ¡ç«¯å…·ä½“ä¸šåŠ¡å¤„ç†"><a href="#æœåŠ¡ç«¯å…·ä½“ä¸šåŠ¡å¤„ç†" class="headerlink" title="æœåŠ¡ç«¯å…·ä½“ä¸šåŠ¡å¤„ç†"></a>æœåŠ¡ç«¯å…·ä½“ä¸šåŠ¡å¤„ç†</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerProcessingHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    RequestData requestData = (RequestData) msg;</div><div class="line">    ResponseData responseData = <span class="keyword">new</span> ResponseData();</div><div class="line">    responseData.setIntValue(requestData.getIntValue() * <span class="number">2</span>);</div><div class="line">    ctx.writeAndFlush(responseData);</div><div class="line">    System.out.println(<span class="string">"server receive request: "</span> + requestData.getIntValue());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyTestServer</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">new</span> NettyTestServer(<span class="number">8080</span>).start();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</div><div class="line">    EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</div><div class="line">      bootstrap.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)</div><div class="line">          .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">              ch.pipeline().addLast(<span class="keyword">new</span> ServerRequestDecoder(), <span class="keyword">new</span> ServerResponseEncoder(),</div><div class="line">                  <span class="keyword">new</span> ServerProcessingHandler());</div><div class="line">            &#125;</div><div class="line">          &#125;).option(ChannelOption.SO_BACKLOG, <span class="number">128</span>).childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">      ChannelFuture channelFuture = bootstrap.bind(<span class="keyword">new</span> InetSocketAddress(port)).sync();</div><div class="line">      System.out.println(</div><div class="line">          NettyTestServer.class.getName() + <span class="string">" started and listen on "</span> + channelFuture.channel().localAddress());</div><div class="line"></div><div class="line">      channelFuture.channel().closeFuture().sync();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      workerGroup.shutdownGracefully();</div><div class="line">      bossGroup.shutdownGracefully();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://www.baeldung.com/netty" target="_blank" rel="external">Introduction to Netty</a></p>
<p><a href="https://sylvanassun.github.io/2017/11/30/2017-11-30-netty_introduction/" target="_blank" rel="external">Nettyçš„é‚£ç‚¹äº‹å„¿</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Nettyåˆæ¢]]></title>
      <url>http://zsr.github.io/2018/12/12/Netty%E5%88%9D%E6%8E%A2/</url>
      <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Netty is an asynchronous event-driven network application framework for rapid development of maintainable high performance protocol servers &amp; clients.</div><div class="line"></div><div class="line">Netty is a NIO client server framework which enables quick and easy development of network applications such as protocol servers and clients. It greatly simplifies and streamlines network programming such as TCP and UDP socket server.</div></pre></td></tr></table></figure>
<h3 id="ä¸ºä»€ä¹ˆä¸é€‰æ‹©JAVAåŸç”ŸNIO"><a href="#ä¸ºä»€ä¹ˆä¸é€‰æ‹©JAVAåŸç”ŸNIO" class="headerlink" title="ä¸ºä»€ä¹ˆä¸é€‰æ‹©JAVAåŸç”ŸNIO"></a>ä¸ºä»€ä¹ˆä¸é€‰æ‹©<code>JAVA</code>åŸç”Ÿ<code>NIO</code></h3><ul>
<li><code>NIO</code> çš„ç±»åº“å’Œ <code>API</code> ç¹æ‚ï¼Œä½¿ç”¨éº»çƒ¦ï¼šéœ€è¦ç†Ÿç»ƒæŒæ¡ <code>Selector</code>ã€<code>ServerSocketChannel</code>ã€<code>SocketChannel</code>ã€<code>ByteBuffer</code>ç­‰ã€‚</li>
<li>ç¼–å†™å‡ºé«˜è´¨é‡çš„ <code>NIO</code> ç¨‹åºéœ€è¦å…·å¤‡å…¶ä»–çš„é¢å¤–æŠ€èƒ½åšé“ºå«ï¼šä¾‹å¦‚ç†Ÿæ‚‰ <code>Java</code> å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå› ä¸º <code>NIO</code> ç¼–ç¨‹æ¶‰åŠåˆ° <code>Reactor</code> æ¨¡å¼ï¼Œå¿…é¡»å¯¹å¤šçº¿ç¨‹å’Œç½‘è·¯ç¼–ç¨‹éå¸¸ç†Ÿæ‚‰ã€‚</li>
<li><code>NIO</code> ç¼–ç¨‹çš„ç‰¹ç‚¹æ˜¯åŠŸèƒ½å¼€å‘ç›¸å¯¹å®¹æ˜“ï¼Œä½†æ˜¯å¯é æ€§èƒ½åŠ›è¡¥é½å·¥ä½œé‡å’Œéš¾åº¦éƒ½éå¸¸å¤§ï¼šä¾‹å¦‚å®¢æˆ·ç«¯é¢ä¸´æ–­è¿é‡è¿ã€ç½‘ç»œé—ªæ–­ã€åŠåŒ…è¯»å†™ã€å¤±è´¥ç¼“å­˜ã€ç½‘ç»œæ‹¥å¡å’Œå¼‚å¸¸ç æµçš„å¤„ç†ç­‰ç­‰ã€‚</li>
<li><a href="http://www.10tiao.com/html/308/201602/401718035/1.html" target="_blank" rel="external"><code>JDK NIO</code>çš„ <code>Epoll Bug</code>ï¼Œå®ƒä¼šå¯¼è‡´<code>Selector</code>ç©ºè½®è¯¢ï¼Œæœ€ç»ˆå¯¼è‡´<code>CPU 100%</code></a></li>
</ul>
<h3 id="ä¸ºä»€ä¹ˆé€‰æ‹©Netty"><a href="#ä¸ºä»€ä¹ˆé€‰æ‹©Netty" class="headerlink" title="ä¸ºä»€ä¹ˆé€‰æ‹©Netty"></a>ä¸ºä»€ä¹ˆé€‰æ‹©<code>Netty</code></h3><ul>
<li><code>API</code>ä½¿ç”¨ç®€å•ï¼Œå¼€å‘é—¨æ§›ä½ï¼›</li>
<li>åŠŸèƒ½å¼ºå¤§ï¼Œé¢„ç½®äº†å¤šç§ç¼–è§£ç åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§ä¸»æµåè®®ï¼›</li>
<li><strong>å®šåˆ¶èƒ½åŠ›å¼ºï¼Œå¯ä»¥é€šè¿‡ChannelHandlerå¯¹é€šä¿¡æ¡†æ¶è¿›è¡Œçµæ´»åœ°æ‰©å±•ï¼›</strong></li>
<li>æ€§èƒ½é«˜ï¼Œé€šè¿‡ä¸å…¶ä»–ä¸šç•Œä¸»æµçš„<code>NIO</code>æ¡†æ¶å¯¹æ¯”ï¼ŒNettyçš„ç»¼åˆæ€§èƒ½æœ€ä¼˜ï¼›</li>
<li>æˆç†Ÿã€ç¨³å®šï¼Œ<code>Netty</code>ä¿®å¤äº†å·²ç»å‘ç°çš„æ‰€æœ‰<code>JDK NIO BUG</code>ï¼›</li>
</ul>
<h3 id="Nettyæ¶æ„è®¾è®¡"><a href="#Nettyæ¶æ„è®¾è®¡" class="headerlink" title="Nettyæ¶æ„è®¾è®¡"></a><code>Netty</code>æ¶æ„è®¾è®¡</h3><p><code>Netty</code>é‡‡ç”¨äº†æ¯”è¾ƒå…¸å‹çš„ä¸‰å±‚ç½‘ç»œæ¶æ„è¿›è¡Œè®¾è®¡ï¼Œé€»è¾‘æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy53lm41bjj30ts0fytgt.jpg" alt=""></p>
<ul>
<li>ä¼ è¾“æœåŠ¡ï¼šæ”¯æŒ <code>BIO</code> å’Œ <code>NIO</code></li>
<li>å®¹å™¨é›†æˆï¼šæ”¯æŒ <code>OSGI</code>ã€<code>JBossMC</code>ã€<code>Spring</code>ã€<code>Guice</code>å®¹å™¨</li>
<li>åè®®æ”¯æŒï¼š<code>HTTP</code>ã€<code>Protobuf</code>ã€äºŒè¿›åˆ¶ã€<code>WebSocket</code>ç­‰ä¸€ç³»åˆ—å¸¸è§åè®®éƒ½æ”¯æŒã€‚è¿˜æ”¯æŒé€šè¿‡å®è¡Œç¼–ç è§£ç é€»è¾‘æ¥å®ç°è‡ªå®šä¹‰åè®®</li>
<li><code>Core</code> æ ¸å¿ƒï¼šå¯æ‰©å±•äº‹ä»¶æ¨¡å‹ã€é€šç”¨é€šä¿¡ <code>API</code>ã€æ”¯æŒé›¶æ‹·è´çš„ <code>ByteBuf</code> ç¼“å†²å¯¹è±¡</li>
</ul>
<h3 id="é«˜æ€§èƒ½çš„ä¸‰å¤§è¦ç´ "><a href="#é«˜æ€§èƒ½çš„ä¸‰å¤§è¦ç´ " class="headerlink" title="é«˜æ€§èƒ½çš„ä¸‰å¤§è¦ç´ "></a><strong>é«˜æ€§èƒ½çš„ä¸‰å¤§è¦ç´ </strong></h3><ol>
<li><strong>ä¼ è¾“</strong>ï¼šç”¨ä»€ä¹ˆæ ·çš„é€šé“å°†æ•°æ®å‘é€ç»™å¯¹æ–¹ï¼ŒBIOã€NIO æˆ–è€… AIOï¼Œ<strong>IO æ¨¡å‹åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå†³å®šäº†æ¡†æ¶çš„æ€§èƒ½</strong>ã€‚</li>
<li><strong>åè®®</strong>ï¼šé‡‡ç”¨ä»€ä¹ˆæ ·çš„é€šä¿¡åè®®ï¼Œ<code>HTTP</code> æˆ–è€…å†…éƒ¨ç§æœ‰åè®®ã€‚åè®®çš„é€‰æ‹©ä¸åŒï¼Œæ€§èƒ½æ¨¡å‹ä¹Ÿä¸åŒã€‚ç›¸æ¯”äºå…¬æœ‰åè®®ï¼Œå†…éƒ¨ç§æœ‰åè®®çš„æ€§èƒ½é€šå¸¸å¯ä»¥è¢«è®¾è®¡çš„æ›´ä¼˜ã€‚</li>
<li><strong>çº¿ç¨‹æ¨¡å‹</strong>ï¼šæ•°æ®æŠ¥å¦‚ä½•è¯»å–ï¼Ÿè¯»å–ä¹‹åçš„ç¼–è§£ç åœ¨å“ªä¸ªçº¿ç¨‹è¿›è¡Œï¼Œç¼–è§£ç åçš„æ¶ˆæ¯å¦‚ä½•æ´¾å‘ï¼Œ<code>Reactor</code> çº¿ç¨‹æ¨¡å‹çš„ä¸åŒï¼Œå¯¹æ€§èƒ½çš„å½±å“ä¹Ÿéå¸¸å¤§ã€‚</li>
</ol>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy53swbgjzj30rc0nwdk8.jpg" alt=""></p>
<h3 id="Nettyé«˜æ€§èƒ½åŸå› "><a href="#Nettyé«˜æ€§èƒ½åŸå› " class="headerlink" title="Nettyé«˜æ€§èƒ½åŸå› "></a><code>Netty</code>é«˜æ€§èƒ½åŸå› </h3><h4 id="IOæ¨¡å‹"><a href="#IOæ¨¡å‹" class="headerlink" title="IOæ¨¡å‹"></a><strong>IOæ¨¡å‹</strong></h4><p><code>Netty</code>çš„IOçº¿ç¨‹<code>NioEventLoop</code>ç”±äºèšåˆäº†å¤šè·¯å¤ç”¨å™¨<code>Selector</code>ï¼Œå¯ä»¥åŒæ—¶å¹¶å‘å¤„ç†æˆç™¾ä¸Šåƒä¸ªå®¢æˆ·ç«¯<code>Channel</code>ï¼Œç”±äºè¯»å†™æ“ä½œéƒ½æ˜¯éé˜»å¡çš„ï¼Œè¿™å°±å¯ä»¥å……åˆ†æå‡IOçº¿ç¨‹çš„è¿è¡Œæ•ˆç‡ï¼Œé¿å…ç”±äºé¢‘ç¹IOé˜»å¡å¯¼è‡´çš„çº¿ç¨‹æŒ‚èµ·</p>
<h4 id="é›¶æ‹·è´"><a href="#é›¶æ‹·è´" class="headerlink" title="é›¶æ‹·è´"></a>é›¶æ‹·è´</h4><p><strong>åœ¨åé¢çš„æ–‡ç« ä¸“é—¨è¯¦è§£</strong></p>
<h4 id="å†…å­˜æ± "><a href="#å†…å­˜æ± " class="headerlink" title="å†…å­˜æ± "></a>å†…å­˜æ± </h4><p><strong>åœ¨åé¢çš„æ–‡ç« ä¸“é—¨è¯¦è§£</strong></p>
<h4 id="Netty-çº¿ç¨‹æ¨¡å‹"><a href="#Netty-çº¿ç¨‹æ¨¡å‹" class="headerlink" title="Netty çº¿ç¨‹æ¨¡å‹"></a><strong>Netty çº¿ç¨‹æ¨¡å‹</strong></h4><p><code>Netty</code> ä¸»è¦åŸºäºä¸»ä» <code>Reactor</code> å¤šçº¿ç¨‹æ¨¡å‹ï¼ˆå¦‚ä¸‹å›¾ï¼‰åšäº†ä¸€å®šçš„ä¿®æ”¹ï¼Œå…¶ä¸­ä¸»ä» <code>Reactor</code> å¤šçº¿ç¨‹æ¨¡å‹æœ‰å¤šä¸ª <code>Reactor</code>ï¼š</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy548sanm2j30rk0iwh0n.jpg" alt=""></p>
<ul>
<li><code>MainReactor</code>è´Ÿè´£å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚è½¬äº¤ç»™ <code>SubReactor</code></li>
<li><code>SubReactor</code>è´Ÿè´£ç›¸åº”é€šé“çš„IOè¯»å†™è¯·æ±‚</li>
<li>éIOè¯·æ±‚ï¼ˆå…·ä½“é€»è¾‘å¤„ç†ï¼‰ç­‰å¾… <code>worker threads</code> è¿›è¡Œå¤„ç†</li>
</ul>
<p><strong>æ³¨æ„ï¼š<code>Netty</code> çš„çº¿ç¨‹æ¨¡å‹åŸºäºä¸»ä» <code>Reactor</code>å¤šçº¿ç¨‹ï¼Œå€Ÿç”¨äº† <code>MainReactor</code> å’Œ <code>SubReactor</code> çš„ç»“æ„ã€‚ä½†æ˜¯<code>Netty</code>å®é™…å®ç°ä¸Š <code>SubReactor</code> å’Œ <code>Worker</code> çº¿ç¨‹åœ¨åŒä¸€ä¸ªçº¿ç¨‹æ± ä¸­</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(); </div><div class="line">EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(); </div><div class="line">ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap(); </div><div class="line">bootstrap.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)</div></pre></td></tr></table></figure>
<p><code>Netty</code>é‡Œå¯¹åº”<code>mainReactor</code>çš„è§’è‰²å«åš<code>Boss</code>ï¼Œè€Œå¯¹åº”<code>subReactor</code>çš„è§’è‰²å«åš<code>Worker</code></p>
<p><code>bossGroup</code> å’Œ <code>workerGroup</code> è¿™ä¸¤ä¸ª <code>group</code> å‡æ˜¯çº¿ç¨‹æ± ï¼š</p>
<ul>
<li><code>bossGroup</code> çº¿ç¨‹æ± åˆ™åªæ˜¯åœ¨ <code>Bind</code> æŸä¸ªç«¯å£åï¼Œè·å¾—å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ä½œä¸º <code>MainReactor</code>ï¼Œä¸“é—¨å¤„ç†ç«¯å£çš„ <code>Accept</code> äº‹ä»¶</li>
<li><code>workerGroup</code> çº¿ç¨‹æ± ä¼šè¢«å„ä¸ª<code>SubReactor</code> å’Œ <code>Worker</code> çº¿ç¨‹å……åˆ†åˆ©ç”¨</li>
</ul>
<h3 id="Nettyçº¿ç¨‹æ¨¡å‹"><a href="#Nettyçº¿ç¨‹æ¨¡å‹" class="headerlink" title="Nettyçº¿ç¨‹æ¨¡å‹"></a>Nettyçº¿ç¨‹æ¨¡å‹</h3><p>ä¸‹å›¾æ¥è‡ªç»„å†…å¤§ç‰›åˆ†äº«ï¼Œç›—æ¥ä½¿ç”¨ï½ï½ï¼š</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fy6dbsx3k1j31d60sok1f.jpg" alt=""></p>
<p><strong>æ³¨æ„ï¼šæœåŠ¡å™¨ç«¯çš„ <code>ServerSocketChannel</code> åªç»‘å®šåˆ°äº† <code>bossGroup</code> ä¸­çš„ä¸€ä¸ªçº¿ç¨‹, å› æ­¤åœ¨è°ƒç”¨<code>Selector.select</code> å¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚æ—¶, å®é™…ä¸Šæ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­çš„, æ‰€ä»¥å¯¹åªæœ‰ä¸€ä¸ªæœåŠ¡(ç›‘å¬ä¸€ä¸ªç«¯å£)çš„åº”ç”¨æ¥è¯´, <code>bossGroup</code> è®¾ç½®å¤šä¸ªçº¿ç¨‹æ˜¯æ²¡æœ‰ä»€ä¹ˆä½œç”¨çš„, åè€Œè¿˜ä¼šé€ æˆèµ„æºæµªè´¹ã€‚</strong></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://www.baeldung.com/netty" target="_blank" rel="external">Introduction to Netty</a></p>
<p><a href="https://sylvanassun.github.io/2017/11/30/2017-11-30-netty_introduction/" target="_blank" rel="external">Nettyçš„é‚£ç‚¹äº‹å„¿</a></p>
<p><a href="https://xiaozhuanlan.com/topic/2153098467" target="_blank" rel="external">NIO Reactor æ¨¡å‹ &amp; Netty çº¿ç¨‹æ¨¡å‹</a></p>
<p><a href="https://stackoverflow.com/questions/22280916/do-we-need-more-than-a-single-thread-for-boss-group" target="_blank" rel="external">do we need more than a single thread for boss group?</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Reactor æ¨¡å‹]]></title>
      <url>http://zsr.github.io/2018/12/07/Reactor-%E6%A8%A1%E5%9E%8B/</url>
      <content type="html"><![CDATA[<p>æœåŠ¡ç«¯å¦‚ä½•å¤„ç†è¯·æ±‚ï¼šåç«¯æ¥æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œç®€åŒ–ä¸‹ä¼šåšä»¥ä¸‹å››ä¸ªæ“ä½œï¼š</p>
<ol>
<li><strong>å»ºç«‹è¿æ¥</strong></li>
<li><strong>è¯»å–æ•°æ®</strong></li>
<li><strong>ä¸šåŠ¡æ“ä½œ</strong></li>
<li><strong>å†™å›æ•°æ®</strong></li>
</ol>
<p><strong>Reactorçš„æ ¸å¿ƒæ€æƒ³</strong>ï¼š<code>Reactor</code> æ¨¡å¼ä¹Ÿå« <code>Dispatcher</code> æ¨¡å¼ï¼Œå°†å…³æ³¨çš„IOäº‹ä»¶æ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œä¸€æ—¦æœ‰IOäº‹ä»¶è§¦å‘ï¼Œå°†äº‹ä»¶åˆ†å‘åˆ°äº‹ä»¶å¤„ç†å™¨ä¸­ï¼Œæ‰§è¡Œå°±ç»ªIOäº‹ä»¶å¯¹åº”çš„å¤„ç†å‡½æ•°ä¸­ã€‚æ¨¡å‹ä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„ç»„ä»¶ï¼š</p>
<ul>
<li><code>Reactor</code>ï¼šåœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œè´Ÿè´£ç›‘å¬å’Œåˆ†å‘äº‹ä»¶ï¼Œåˆ†å‘ç»™é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å¯¹ IO äº‹ä»¶åšå‡ºååº”ã€‚</li>
<li><code>Handlers</code>ï¼šå¤„ç†ç¨‹åºæ‰§è¡ŒIOäº‹ä»¶è¦å®Œæˆçš„å®é™…äº‹ä»¶ï¼Œ<code>Reactor</code>é€šè¿‡è°ƒåº¦å¤„ç†ç¨‹åºæ¥å“åº”IOäº‹ä»¶ï¼Œå¤„ç†ç¨‹åºæ‰§è¡Œéé˜»å¡æ“ä½œã€‚</li>
</ul>
<h3 id="Reactoræ¨¡å¼æ¼”è¿›"><a href="#Reactoræ¨¡å¼æ¼”è¿›" class="headerlink" title="Reactoræ¨¡å¼æ¼”è¿›"></a><a href="http://gee.cs.oswego.edu/dl/cpjslides/nio.pdf" target="_blank" rel="external">Reactoræ¨¡å¼æ¼”è¿›</a></h3><p><code>Reactor</code> æ¨¡å‹å–å†³äº <code>Reactor</code> çš„æ•°é‡å’Œ <code>Hanndler</code> çº¿ç¨‹æ•°é‡çš„ä¸åŒï¼Œ<code>Reactor</code> æ¨¡å‹æœ‰ 3 ä¸ªå˜ç§ï¼š</p>
<ul>
<li>å•çº¿ç¨‹<code>Reactor</code>æ¨¡å¼ï¼šå•<code>Reactor</code>å•çº¿ç¨‹<code>Hanndler</code></li>
<li>å¤šçº¿ç¨‹<code>Reactor</code>æ¨¡å¼ï¼šå•<code>Reactor</code>å¤šçº¿ç¨‹<code>Hanndler</code></li>
<li>ä¸»ä»<code>Reactor</code>æ¨¡å¼ï¼šä¸»ä»<code>Reactor</code>å¤šçº¿ç¨‹<code>Hanndler</code></li>
</ul>
<p><code>Reactor</code> å°±æ˜¯ä¸€ä¸ªæ‰§è¡Œ <code>while (true) { selector.select(); â€¦}</code> å¾ªç¯çš„çº¿ç¨‹ï¼Œä¼šæºæºä¸æ–­çš„äº§ç”Ÿæ–°çš„äº‹ä»¶ï¼Œç§°ä½œååº”å †å¾ˆè´´åˆ‡ã€‚</p>
<h4 id="å•çº¿ç¨‹Reactoræ¨¡å¼"><a href="#å•çº¿ç¨‹Reactoræ¨¡å¼" class="headerlink" title="å•çº¿ç¨‹Reactoræ¨¡å¼"></a>å•çº¿ç¨‹<code>Reactor</code>æ¨¡å¼</h4><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy1i62jskoj31la0muk05.jpg" alt=""></p>
<p>å•çº¿ç¨‹<code>Reactor</code>æ¨¡å¼ : å»ºç«‹è¿æ¥ï¼Œè¯»å–/å†™å›æ•°æ®å’Œä¸šåŠ¡æ“ä½œéƒ½åœ¨åŒä¸€ä¸ª<code>Reactor</code>çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè™½ç„¶<code>Reactor</code>çš„è¯»å–å†™å›ä¸ä¼šé€ æˆé˜»å¡ï¼Œä½†æ˜¯ä¸šåŠ¡æ“ä½œå°±å¾ˆå¯èƒ½é€ æˆé˜»å¡ï¼›å¹¶ä¸”å•çº¿ç¨‹ä¸èƒ½å……åˆ†åˆ©ç”¨<code>CPU</code>å¤šæ ¸ä¼˜åŠ¿ï¼Œå› æ­¤å¤„ç†èƒ½åŠ›æ˜¯æœ‰é™çš„ï¼Œå¯¹äºå°é‡è¿æ¥æƒ…å†µä¸‹é—®é¢˜ä¸å¤§ï¼Œå¯¹äºå¤§é‡é“¾æ¥æƒ…å†µä¸‹ï¼Œå•ä¸ª<code>NIO</code>çº¿ç¨‹å› å¤„ç†èƒ½åŠ›æœ‰é™ä¼šå¯¼è‡´è¿æ¥å¤§é‡è¶…æ—¶ã€‚</p>
<h4 id="å¤šçº¿ç¨‹Reactoræ¨¡å¼"><a href="#å¤šçº¿ç¨‹Reactoræ¨¡å¼" class="headerlink" title="å¤šçº¿ç¨‹Reactoræ¨¡å¼"></a>å¤šçº¿ç¨‹<code>Reactor</code>æ¨¡å¼</h4><p>å°†éIOçš„ä¸šåŠ¡é€»è¾‘æ“ä½œä»<code>Reactor</code>çº¿ç¨‹ä¸Šå¸è½½ï¼Œä»¥æ­¤æ¥åŠ é€Ÿ<code>Reactor</code>çº¿ç¨‹å¯¹IOè¯·æ±‚çš„å“åº”ã€‚</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fy2txzpfcwj30rs0jjqdo.jpg" alt=""></p>
<p>å¤šçº¿ç¨‹<code>Reactor</code>æ¨¡å¼ï¼šå¤šçº¿ç¨‹æ¨¡å¼ä¸‹æŠŠä¸šåŠ¡æ“ä½œï¼ˆ<code>decode</code>ï¼Œ<code>compute</code>ï¼Œ<code>encode</code>ï¼‰ç­‰æ”¾åˆ°çº¿ç¨‹æ± ä¸­å¤„ç†ï¼Œä¿è¯<code>Reactor</code>çº¿ç¨‹ä¸ä¼šé˜»å¡ï¼Œè€Œ<code>Reactor</code>ä»ä¸ºå•ä¸ªçº¿ç¨‹ä»ç„¶è¦å¤„ç†è¿æ¥å’Œè¯»å–/å†™å›æ“ä½œï¼Œå…¶æ‰¿æ‹…è¿æ¥è´Ÿè½½é‡ä¸Šæ¥æ—¶ä»ç„¶æ‰¿å—å¾ˆå¤§å‹åŠ›ï¼ˆä¾‹å¦‚å¹¶å‘ç™¾ä¸‡å®¢æˆ·ç«¯è¿æ¥ï¼Œæˆ–è€…æœåŠ¡ç«¯éœ€è¦å¯¹å®¢æˆ·ç«¯æ¡æ‰‹è¿›è¡Œå®‰å…¨è®¤è¯ï¼Œä½†æ˜¯è®¤è¯æœ¬èº«éå¸¸æŸè€—æ€§èƒ½ï¼‰</p>
<h3 id="ä¸»ä»Reactoræ¨¡å¼"><a href="#ä¸»ä»Reactoræ¨¡å¼" class="headerlink" title="ä¸»ä»Reactoræ¨¡å¼"></a>ä¸»ä»<code>Reactor</code>æ¨¡å¼</h3><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fy3sy13x4cj312u0r847b.jpg" alt=""></p>
<p>ä¸»ä»<code>Reactor</code>æ¨¡å¼ï¼šç›¸æ¯”å¤šçº¿ç¨‹<code>Reactor</code>æ¨¡å¼ï¼Œä¸»ä»<code>Reactor</code>æ¨¡å¼ä¸‹æŠŠIOè¯»å–/å†™å›ä¸¤ä¸ªæ“ä½œæ”¾åœ¨ <strong>ä»Reactorçº¿ç¨‹æ± </strong> ä¸­æ‰§è¡Œï¼Œ <strong>ä¸»Reactorçº¿ç¨‹</strong>ä¹Ÿå°±æ˜¯<code>Acceptor</code>åªè´Ÿè´£å»ºç«‹è¿æ¥ï¼Œå»ºç«‹ä¹‹åå°†å…¶æ³¨å†Œåˆ° <strong>ä»Reactorçº¿ç¨‹</strong> ä¸­ï¼Œå› æ­¤å¤§å¤§æé«˜äº†è´Ÿè½½èƒ½åŠ›ã€‚åŒæ—¶ä¸ºäº†é¿å…å¹¶å‘é—®é¢˜è¿˜è¦ä¿è¯ä¸€ä¸ªè¿æ¥åªèƒ½æ³¨å†Œä¸€ä¸ª<code>Reactor</code>çº¿ç¨‹ä¸Š</p>
<ul>
<li><code>MainReactor</code>è´Ÿè´£å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚è½¬äº¤ç»™ <code>SubReactor</code></li>
<li><code>SubReactor</code>è´Ÿè´£ç›¸åº”é€šé“çš„IOè¯»å†™æ“ä½œ</li>
<li>éIOè¯·æ±‚ï¼ˆå…·ä½“é€»è¾‘å¤„ç†ï¼‰çš„ä»»åŠ¡åˆ™ä¼šäº¤ç”±å·¥ä½œçº¿ç¨‹æ± å¤„ç†</li>
</ul>
<p><strong>å¥½å¤„ï¼šå› ä¸ºsubReactorä¹Ÿä¼šæ‰§è¡Œä¸€äº›æ¯”è¾ƒè€—æ—¶çš„IOæ“ä½œï¼Œä¾‹å¦‚æ¶ˆæ¯çš„è¯»å†™ï¼Œä½¿ç”¨å¤šä¸ªçº¿ç¨‹å»æ‰§è¡Œï¼Œåˆ™æ›´åŠ æœ‰åˆ©äºå‘æŒ¥CPUçš„è¿ç®—èƒ½åŠ›ï¼Œå‡å°‘IOç­‰å¾…æ—¶é—´ã€‚</strong></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://gee.cs.oswego.edu/dl/cpjslides/nio.pdf" target="_blank" rel="external">Scalable IO in Java</a></p>
<p><a href="http://www.liuhaihua.cn/archives/530938.html" target="_blank" rel="external">Nettyâ€“Reactoræ¨¡å‹çš„åº”ç”¨</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Java NIO:Selectorè¯¦è§£]]></title>
      <url>http://zsr.github.io/2018/12/04/Java-NIO-Selector%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<p><code>Selector</code>äº‹ä»¶åˆ†å‘å™¨(å•çº¿ç¨‹é€‰æ‹©å°±ç»ªçš„äº‹ä»¶)ä½œä¸ºJava NIOçš„æ ¸å¿ƒç»„ä»¶ï¼Œè¿™é‡Œè¯¦ç»†äº†è§£å†…éƒ¨å®ç°</p>
<h3 id="æœåŠ¡ç«¯ä»£ç "><a href="#æœåŠ¡ç«¯ä»£ç " class="headerlink" title="æœåŠ¡ç«¯ä»£ç "></a>æœåŠ¡ç«¯ä»£ç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">ServerSocketChannel serverChannel = ServerSocketChannel.open();</div><div class="line">serverChannel.configureBlocking(<span class="keyword">false</span>);</div><div class="line">serverChannel.socket().bind(<span class="keyword">new</span> InetSocketAddress(port));</div><div class="line">Selector selector = Selector.open();</div><div class="line">serverChannel.register(selector, SelectionKey.OP_ACCEPT);</div><div class="line"><span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</div><div class="line">    selector.select();</div><div class="line">    Iterator iter = <span class="keyword">this</span>.selector.selectedKeys().iterator();</div><div class="line">    <span class="keyword">while</span>(iter.hasNext())&#123;</div><div class="line">        SelectionKey key = (SelectionKey)iter.next();</div><div class="line">        <span class="keyword">if</span> (key.isAcceptable())&#123;</div><div class="line">            SocketChannel clientChannel = ((ServerSocketChannel) key.channel()).accept();</div><div class="line">            clientChannel.configureBlocking(<span class="keyword">false</span>);</div><div class="line">            <span class="comment">// ç›‘å¬å®¢æˆ·ç«¯socketå¯è¯»å°±ç»ªäº‹ä»¶</span></div><div class="line">            client.register(selector, SelectionKey.OP_READ);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (key.isReadable())&#123;</div><div class="line">            handleRead(key);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (key.isWritable() &amp;&amp; key.isValid())&#123;</div><div class="line">            handleWrite(key);</div><div class="line">        &#125;</div><div class="line">      iter.remove();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>å¦‚æœæœ‰å®¢æˆ·ç«¯Aè¿æ¥æœåŠ¡ï¼Œæ‰§è¡Œ<code>select</code>æ–¹æ³•æ—¶ï¼Œå¯ä»¥é€šè¿‡<code>serverSocketChannel</code>è·å–å®¢æˆ·ç«¯Açš„<code>socketChannel</code>ï¼Œå¹¶åœ¨<code>selector</code>ä¸Šæ³¨å†Œ<code>socketChannel</code>çš„<code>OP_READ</code>äº‹ä»¶ã€‚</li>
<li>å¦‚æœå®¢æˆ·ç«¯Aå‘é€æ•°æ®ï¼Œä¼šè§¦å‘<code>OP_READ</code>äº‹ä»¶ï¼Œè¿™æ ·ä¸‹æ¬¡è½®è¯¢è°ƒç”¨<code>select</code>æ–¹æ³•æ—¶ï¼Œå°±èƒ½é€šè¿‡<code>socketChannel</code>è¯»å–æ•°æ®ï¼ŒåŒæ—¶åœ¨<code>selector</code>ä¸Šæ³¨å†Œè¯¥<code>socketChannel</code>çš„<code>OP_WRITE</code>äº‹ä»¶ï¼Œå®ç°æœåŠ¡å™¨å¾€å®¢æˆ·ç«¯å†™æ•°æ®ã€‚</li>
</ol>
<h3 id="Selector-open-å®ç°åŸç†"><a href="#Selector-open-å®ç°åŸç†" class="headerlink" title="Selector.open()å®ç°åŸç†"></a><code>Selector.open()</code>å®ç°åŸç†</h3><p><strong>æ³¨æ„ï¼šä»¥ä¸‹æºä»£ç çš†æ¥æºäº<code>openjdk8</code></strong></p>
<ul>
<li><code>Selector.open()</code>å¯ä»¥å¾—åˆ°ä¸€ä¸ª<code>Selector</code>å®ä¾‹</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Selector <span class="title">open</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">// é¦–å…ˆæ‰¾åˆ°provider,ç„¶åå†æ‰“å¼€Selector</span></div><div class="line">    <span class="keyword">return</span> SelectorProvider.provider().openSelector();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// java.nio.channels.spi.SelectorProvider</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SelectorProvider <span class="title">provider</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">        <span class="keyword">if</span> (provider != <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> provider;</div><div class="line">        <span class="keyword">return</span> AccessController.doPrivileged(</div><div class="line">            <span class="keyword">new</span> PrivilegedAction&lt;SelectorProvider&gt;() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> SelectorProvider <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        <span class="keyword">if</span> (loadProviderFromProperty())</div><div class="line">                            <span class="keyword">return</span> provider;</div><div class="line">                        <span class="keyword">if</span> (loadProviderAsService())</div><div class="line">                            <span class="keyword">return</span> provider;</div><div class="line">                            <span class="comment">// å®é™…åˆ›å»ºSelectorProviderçš„æ–¹æ³•</span></div><div class="line">                        provider = sun.nio.ch.DefaultSelectorProvider.create();</div><div class="line">                        <span class="keyword">return</span> provider;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>sun.nio.ch.DefaultSelectorProvider</code></li>
</ul>
<p>ä¸åŒç³»ç»Ÿå¯¹åº”ç€ä¸åŒçš„<code>sun.nio.ch.DefaultSelectorProvider</code>ï¼Œä»¥<code>Linux</code>ä¸ºä¾‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Returns the default SelectorProvider.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SelectorProvider <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// è·å–OSåç§°</span></div><div class="line">    String osname = AccessController</div><div class="line">        .doPrivileged(<span class="keyword">new</span> GetPropertyAction(<span class="string">"os.name"</span>));</div><div class="line">    <span class="comment">// æ ¹æ®åç§°æ¥åˆ›å»ºä¸åŒçš„Selctor</span></div><div class="line">    <span class="keyword">if</span> (osname.equals(<span class="string">"SunOS"</span>))</div><div class="line">        <span class="keyword">return</span> createProvider(<span class="string">"sun.nio.ch.DevPollSelectorProvider"</span>);</div><div class="line">    <span class="keyword">if</span> (osname.equals(<span class="string">"Linux"</span>))</div><div class="line">        <span class="keyword">return</span> createProvider(<span class="string">"sun.nio.ch.EPollSelectorProvider"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> sun.nio.ch.PollSelectorProvider();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœç³»ç»Ÿåç§°æ˜¯<code>Linux</code>çš„è¯ï¼ŒçœŸæ­£åˆ›å»ºçš„æ˜¯<code>sun.nio.ch.EPollSelectorProvider</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// EPollSelectorProvider.openSelector()</span></div><div class="line"><span class="function"><span class="keyword">public</span> AbstractSelector <span class="title">openSelector</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> EPollSelectorImpl(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Linux</code>æœ€ç»ˆçš„<code>Selector</code>å®ç°:<code>sun.nio.ch.EPollSelectorImpl</code></p>
<h3 id="EPollSelectorImpl-select-å®ç°åŸç†"><a href="#EPollSelectorImpl-select-å®ç°åŸç†" class="headerlink" title="EPollSelectorImpl.select()å®ç°åŸç†"></a><code>EPollSelectorImpl.select()</code>å®ç°åŸç†</h3><p><code>epoll</code>ç³»ç»Ÿè°ƒç”¨ä¸»è¦åˆ†ä¸º3ä¸ªå‡½æ•°: <code>epoll_create</code>, <code>epoll_ctl</code>, <code>epoll_wait</code></p>
<h4 id="epoll-createï¼šåˆ›å»ºä¸€ä¸ªepoll-fd"><a href="#epoll-createï¼šåˆ›å»ºä¸€ä¸ªepoll-fd" class="headerlink" title="epoll_createï¼šåˆ›å»ºä¸€ä¸ªepoll fd"></a><code>epoll_create</code>ï¼šåˆ›å»ºä¸€ä¸ª<code>epoll fd</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// class EPollSelectorImpl extends SelectorImpl</span></div><div class="line">EPollSelectorImpl(SelectorProvider sp) <span class="keyword">throws</span> IOException &#123;</div><div class="line">        <span class="keyword">super</span>(sp);</div><div class="line">        <span class="comment">// makePipeè¿”å›ç®¡é“çš„2ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç¼–ç åœ¨ä¸€ä¸ªlongç±»å‹çš„å˜é‡ä¸­</span></div><div class="line">        <span class="comment">// é«˜32ä½ä»£è¡¨è¯» ä½32ä½ä»£è¡¨å†™</span></div><div class="line">        <span class="comment">// ä½¿ç”¨pipeä¸ºäº†å®ç°Selectorçš„wakeupé€»è¾‘</span></div><div class="line">        <span class="keyword">long</span> pipeFds = IOUtil.makePipe(<span class="keyword">false</span>);</div><div class="line">        fd0 = (<span class="keyword">int</span>) (pipeFds &gt;&gt;&gt; <span class="number">32</span>);</div><div class="line">        fd1 = (<span class="keyword">int</span>) pipeFds;</div><div class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªEPollArrayWrapper</span></div><div class="line">        pollWrapper = <span class="keyword">new</span> EPollArrayWrapper();</div><div class="line">        pollWrapper.initInterrupt(fd0, fd1);</div><div class="line">        fdToKey = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p> åˆ›å»ºä¸€ä¸ª<code>EPollArrayWrapper</code> åˆå§‹åŒ–</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">EPollArrayWrapper() <span class="keyword">throws</span> IOException &#123;</div><div class="line">    <span class="comment">// åˆ›å»ºepoll fd</span></div><div class="line">    epfd = epollCreate();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">epollCreate</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure>
<p>åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­è°ƒç”¨äº†<code>native epollCreate</code>æ–¹æ³•ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Java_sun_nio_ch_EPollArrayWrapper_epollCreate(JNIEnv *env, jobject <span class="keyword">this</span>)</div><div class="line">&#123;</div><div class="line">     <span class="comment">//ä»Linux2.6.8ä¹‹åï¼Œæ”¹ç”¨äº†çº¢é»‘æ ‘ç»“æ„ï¼ŒæŒ‡å®šäº†å¤§å°ä¹Ÿæ²¡ç”¨</span></div><div class="line">    <span class="keyword">int</span> epfd = epoll_create(<span class="number">256</span>);</div><div class="line">    <span class="keyword">if</span> (epfd &lt; <span class="number">0</span>) &#123;</div><div class="line">       JNU_ThrowIOExceptionWithLastError(env, <span class="string">"epoll_create failed"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> epfd;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>epoll_create</code>: å†…æ ¸ç³»ç»Ÿè°ƒç”¨ï¼Œåˆ›å»ºä¸€ä¸ª<code>epoll fd</code>, å¹¶ä¸”å¼€è¾Ÿepollè‡ªå·±çš„å†…æ ¸é«˜é€ŸcacheåŒºï¼Œå»ºç«‹çº¢é»‘æ ‘åˆ†é…åˆå§‹sizeçš„å†…å­˜å¯¹è±¡ï¼ŒåŒæ—¶å»ºç«‹ä¸€ä¸ªlisté“¾è¡¨ï¼Œç”¨äºå­˜å‚¨å‡†å¤‡å°±ç»ªçš„äº‹ä»¶</strong></p>
<h4 id="Epoll-wait-ç­‰å¾…å†…æ ¸IOäº‹ä»¶"><a href="#Epoll-wait-ç­‰å¾…å†…æ ¸IOäº‹ä»¶" class="headerlink" title="Epoll wait:ç­‰å¾…å†…æ ¸IOäº‹ä»¶"></a><code>Epoll wait</code>:ç­‰å¾…å†…æ ¸IOäº‹ä»¶</h4><p>è°ƒç”¨<code>Selector.select()</code>,æœ€åä¼šå§”æ‰˜ç»™<code>EPollSelectorImpl</code>çš„<code>doSelect()</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doSelect</span><span class="params">(<span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (closed)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClosedSelectorException();</div><div class="line">    processDeregisterQueue();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        begin();</div><div class="line">        <span class="comment">// ç­‰å¾…äº‹ä»¶åˆ°æ¥ï¼Œæ”¶é›†äº‹ä»¶åˆ°æ¥çš„fdå¹¶ç”¨æ¥å¤„ç†</span></div><div class="line">        pollWrapper.poll(timeout);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        end();</div><div class="line">    &#125;</div><div class="line">    processDeregisterQueue();</div><div class="line">    <span class="keyword">int</span> numKeysUpdated = updateSelectedKeys();</div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (pollWrapper.interrupted()) &#123;</div><div class="line">        <span class="comment">// Clear the wakeup pipe</span></div><div class="line">        pollWrapper.putEventOps(pollWrapper.interruptedIndex(), <span class="number">0</span>);</div><div class="line">        <span class="keyword">synchronized</span> (interruptLock) &#123;</div><div class="line">            pollWrapper.clearInterrupted();</div><div class="line">            IOUtil.drain(fd0);</div><div class="line">            interruptTriggered = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> numKeysUpdated;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å®é™…æ‰§è¡Œ<code>EPollArrayWrapper.poll(timeout);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">poll</span><span class="params">(<span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">// çœ‹ä¸‹æ–‡</span></div><div class="line">    updateRegistrations();</div><div class="line">    <span class="comment">// è°ƒç”¨nativeæ–¹æ³•ï¼Œå‘èµ·ç³»ç»Ÿå†…æ ¸è°ƒç”¨</span></div><div class="line">    updated = epollWait(pollArrayAddress, NUM_EPOLLEVENTS, timeout, epfd);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;updated; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (getDescriptor(i) == incomingInterruptFD) &#123;</div><div class="line">            interruptedIndex = i;</div><div class="line">            interrupted = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> updated;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">epollWait</span><span class="params">(<span class="keyword">long</span> pollAddress, <span class="keyword">int</span> numfds, <span class="keyword">long</span> timeout,</span></span></div><div class="line">                             <span class="keyword">int</span> epfd) <span class="keyword">throws</span> IOException;</div></pre></td></tr></table></figure>
<p><code>epollWait</code>ä¹Ÿæ˜¯ä¸ª<code>native</code>æ–¹æ³•:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Java_sun_nio_ch_EPollArrayWrapper_epollWait(JNIEnv *env, jobject <span class="keyword">this</span>,</div><div class="line">                                            jlong address, jint numfds,</div><div class="line">                                            jlong timeout, jint epfd)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> epoll_event *events = jlong_to_ptr(address);</div><div class="line">    <span class="keyword">int</span> res;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (timeout &lt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// å‘èµ·epoll_waitç³»ç»Ÿè°ƒç”¨ç­‰å¾…å†…æ ¸äº‹ä»¶</span></div><div class="line">        RESTARTABLE(epoll_wait(epfd, events, numfds, timeout), res);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        res = iepoll(epfd, events, numfds, timeout);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</div><div class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"epoll_wait failed"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> res;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>epoll_wait</code>: å†…æ ¸ç³»ç»Ÿè°ƒç”¨, ç­‰å¾…å†…æ ¸è¿”å›IOäº‹ä»¶</strong></p>
<h4 id="epoll-ctl-IOäº‹ä»¶ç®¡ç†"><a href="#epoll-ctl-IOäº‹ä»¶ç®¡ç†" class="headerlink" title="epoll_ctl: IOäº‹ä»¶ç®¡ç†"></a><code>epoll_ctl</code>: IOäº‹ä»¶ç®¡ç†</h4><p>æ³¨å†Œåˆ°<code>Selector</code>ä¸Šçš„IOäº‹ä»¶æ˜¯ä½¿ç”¨<code>SelectionKey</code>æ¥è¡¨ç¤ºï¼Œä»£è¡¨äº†<code>Channel</code>æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œå¦‚<code>Read</code>,<code>Write</code>,<code>Connect</code>,<code>Accept</code>.</p>
<p>è°ƒç”¨<code>Selector.register()</code>å®ŒæˆIOäº‹ä»¶æ³¨å†Œï¼Œå®é™…æ‰§è¡Œ<code>EPollSelectorImpl.implRegister()</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">implRegister</span><span class="params">(SelectionKeyImpl ski)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (closed)</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> ClosedSelectorException();</div><div class="line">       SelChImpl ch = ski.channel;</div><div class="line">       <span class="keyword">int</span> fd = Integer.valueOf(ch.getFDVal());</div><div class="line">       fdToKey.put(fd, ski);</div><div class="line">       pollWrapper.add(fd);</div><div class="line">       keys.add(ski);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>è°ƒç”¨<code>Selector.register()</code>æ—¶å‡ä¼šå°†äº‹ä»¶å­˜å‚¨åˆ°<code>EpollArrayWrapper</code>çš„æˆå‘˜å˜é‡<code>eventsLow</code>å’Œ<code>eventsHigh</code>ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ä½¿ç”¨æ•°ç»„ä¿å­˜äº‹ä»¶å˜æ›´, æ•°ç»„çš„æœ€å¤§é•¿åº¦æ˜¯MAX_UPDATE_ARRAY_SIZE, æœ€å¤§64*1024</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] eventsLow = <span class="keyword">new</span> <span class="keyword">byte</span>[MAX_UPDATE_ARRAY_SIZE];</div><div class="line"><span class="comment">// è¶…è¿‡æ•°ç»„é•¿åº¦çš„äº‹ä»¶ä¼šç¼“å­˜åˆ°è¿™ä¸ªmapä¸­ï¼Œç­‰å¾…ä¸‹æ¬¡å¤„ç†</span></div><div class="line"><span class="keyword">private</span> Map&lt;Integer,Byte&gt; eventsHigh;</div><div class="line"></div><div class="line"><span class="comment">// æ·»åŠ æ–‡ä»¶æè¿°ç¬¦fd</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>&#123;</div><div class="line">        <span class="comment">// force the initial update events to 0 as it may be KILLED by a</span></div><div class="line">        <span class="comment">// previous registration.</span></div><div class="line">        <span class="keyword">synchronized</span> (updateLock) &#123;</div><div class="line">            <span class="keyword">assert</span> !registered.get(fd);</div><div class="line">            setUpdateEvents(fd, (<span class="keyword">byte</span>)<span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setUpdateEvents</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">byte</span> events, <span class="keyword">boolean</span> force)</span> </span>&#123;</div><div class="line">    <span class="comment">// åˆ¤æ–­fdå’Œæ•°ç»„é•¿åº¦</span></div><div class="line">    <span class="keyword">if</span> (fd &lt; MAX_UPDATE_ARRAY_SIZE) &#123;</div><div class="line">        <span class="keyword">if</span> ((eventsLow[fd] != KILLED) || force) &#123;</div><div class="line">            eventsLow[fd] = events;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Integer key = Integer.valueOf(fd);</div><div class="line">        <span class="keyword">if</span> (!isEventsHighKilled(key) || force) &#123;</div><div class="line">            eventsHigh.put(key, Byte.valueOf(events));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰§è¡Œ<code>EpollArrayWrapper.poll()</code>çš„æ—¶å€™, é¦–å…ˆä¼šè°ƒç”¨<code>updateRegistrations()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Returns the pending update events for the given file descriptor.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">byte</span> <span class="title">getUpdateEvents</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (fd &lt; MAX_UPDATE_ARRAY_SIZE) &#123;</div><div class="line">        <span class="keyword">return</span> eventsLow[fd];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Byte result = eventsHigh.get(Integer.valueOf(fd));</div><div class="line">        <span class="comment">// result should never be null</span></div><div class="line">        <span class="keyword">return</span> result.byteValue();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateRegistrations</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (updateLock) &#123;</div><div class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (j &lt; updateCount) &#123;</div><div class="line">            <span class="keyword">int</span> fd = updateDescriptors[j];</div><div class="line">            <span class="comment">// ä»ä¿å­˜çš„eventsLowå’ŒeventsHighé‡Œå–å‡ºäº‹ä»¶</span></div><div class="line">            <span class="keyword">short</span> events = getUpdateEvents(fd);</div><div class="line">            <span class="keyword">boolean</span> isRegistered = registered.get(fd);</div><div class="line">            <span class="keyword">int</span> opcode = <span class="number">0</span>;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (events != KILLED) &#123;</div><div class="line">                <span class="comment">// åˆ¤æ–­æ“ä½œç±»å‹ä»¥ä¼ ç»™epoll_ctl</span></div><div class="line">                <span class="comment">// æ²¡æœ‰æŒ‡å®šEPOLLETäº‹ä»¶ç±»å‹</span></div><div class="line">                <span class="keyword">if</span> (isRegistered) &#123;</div><div class="line">                    <span class="comment">// å¦‚æœå·²ç»æ³¨å†Œè¿‡ï¼Œä¸éœ€è¦è°ƒç”¨epollCtlå»å†…æ ¸çº¢é»‘æ ‘æ–°å¢èŠ‚ç‚¹</span></div><div class="line">                    opcode = (events != <span class="number">0</span>) ? EPOLL_CTL_MOD : EPOLL_CTL_DEL;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    opcode = (events != <span class="number">0</span>) ? EPOLL_CTL_ADD : <span class="number">0</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (opcode != <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// ç†Ÿæ‚‰çš„epoll_ctl</span></div><div class="line">                    epollCtl(epfd, opcode, fd, events);</div><div class="line">                    <span class="keyword">if</span> (opcode == EPOLL_CTL_ADD) &#123;</div><div class="line">                        registered.set(fd);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opcode == EPOLL_CTL_DEL) &#123;</div><div class="line">                        registered.clear(fd);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            j++;</div><div class="line">        &#125;</div><div class="line">        updateCount = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">epollCtl</span><span class="params">(<span class="keyword">int</span> epfd, <span class="keyword">int</span> opcode, <span class="keyword">int</span> fd, <span class="keyword">int</span> events)</span></span>;</div></pre></td></tr></table></figure>
<p>åœ¨è·å–åˆ°äº‹ä»¶ä¹‹åå°†æ“ä½œå§”æ‰˜ç»™äº†<code>epollCtl</code>,è¿™åˆæ˜¯ä¸ªnativeæ–¹æ³•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Java_sun_nio_ch_EPollArrayWrapper_epollCtl(JNIEnv *env, jobject <span class="keyword">this</span>, jint epfd,</div><div class="line">                                           jint opcode, jint fd, jint events)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> epoll_event event;</div><div class="line">    <span class="keyword">int</span> res;</div><div class="line"></div><div class="line">    event.events = events;</div><div class="line">    event.data.fd = fd;</div><div class="line"></div><div class="line">    <span class="comment">// å‘èµ·epoll_ctlè°ƒç”¨æ¥è¿›è¡ŒIOäº‹ä»¶çš„ç®¡ç†</span></div><div class="line">    RESTARTABLE(epoll_ctl(epfd, (<span class="keyword">int</span>)opcode, (<span class="keyword">int</span>)fd, &amp;event), res);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span> &amp;&amp; errno != EBADF &amp;&amp; errno != ENOENT &amp;&amp; errno != EPERM) &#123;</div><div class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"epoll_ctl failed"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼šjdk nioæ²¡æœ‰æŒ‡å®š<code>ET(è¾¹ç¼˜è§¦å‘)</code>è¿˜æ˜¯<code>LT(æ°´å¹³è§¦å‘)</code>, æ‰€ä»¥é»˜è®¤ä¼šç”¨<code>LT</code>, è€Œ<code>Netty epoll transport</code>ä½¿ç”¨<code>ET</code>è§¦å‘</strong></p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxv38f07maj310g0jmdm2.jpg" alt=""></p>
<p>é€šè¿‡<code>channel</code>å°±èƒ½ä¸æ–­çš„è·å–å®¢æˆ·ç«¯<code>socket</code>æ•°æ®ï¼Œå®ç°åç«¯ä¸šåŠ¡å¤„ç†</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://juejin.im/entry/5b51546df265da0f70070b93" target="_blank" rel="external">Java NIOåˆ†æ(8): é«˜å¹¶å‘æ ¸å¿ƒSelectorè¯¦è§£</a></p>
<p><a href="https://www.jianshu.com/p/7b507069debb" target="_blank" rel="external">java NIO è¿è¡ŒåŸç†ä»‹ç»</a></p>
<p><a href="https://www.baeldung.com/java-nio-selector" target="_blank" rel="external">Introduction to the Java NIO Selector</a></p>
<p><a href="https://www.jianshu.com/p/0d497fe5484a" target="_blank" rel="external">æ·±å…¥æµ…å‡ºNIOä¹‹Selectorå®ç°åŸç†</a></p>
<p><a href="http://matt33.com/2017/08/12/java-nio/" target="_blank" rel="external">è°ˆä¸€è°ˆ Java IO æ¨¡å‹</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[IOå¤šè·¯å¤ç”¨æœºåˆ¶]]></title>
      <url>http://zsr.github.io/2018/11/29/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E6%9C%BA%E5%88%B6/</url>
      <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">One basic concept of Linux (actually Unix) is the rule that everything in Unix/Linux is a file. Each process has a table of file descriptors that point to files, sockets, devices and other operating system objects</div></pre></td></tr></table></figure>
<h3 id="ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´"><a href="#ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´" class="headerlink" title="ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´"></a>ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´</h3><p>å¯¹äºä¸€æ¬¡IOè®¿é—®ï¼ˆä»¥<code>read</code>ä¸¾ä¾‹ï¼‰ï¼Œæ•°æ®ä¼šå…ˆè¢«æ‹·è´åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„ç¼“å†²åŒºä¸­(é€šè¿‡DMAï¼Œä¸éœ€è¦CPU)ï¼Œç„¶åæ‰ä¼šä»æ“ä½œç³»ç»Ÿå†…æ ¸çš„ç¼“å†²åŒºæ‹·è´åˆ°åº”ç”¨ç¨‹åºçš„åœ°å€ç©ºé—´(éœ€è¦CPU)ã€‚æ‰€ä»¥è¯´ï¼Œå½“ä¸€ä¸ªreadæ“ä½œå‘ç”Ÿæ—¶ï¼Œå®ƒä¼šç»å†ä¸¤ä¸ªé˜¶æ®µï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1. ç­‰å¾…æ•°æ®å‡†å¤‡ (Waiting for the data to be ready)ï¼›å¯¹äºä¸€ä¸ªsocketæ¥å£ä¸Šçš„æ“ä½œï¼Œè¿™ä¸€æ­¥éª¤å…³ç³»åˆ°æ•°æ®ä»ç½‘ç»œåˆ°è¾¾ï¼Œå¹¶å°†å…¶å¤åˆ¶åˆ°å†…æ ¸çš„ç¼“å†²åŒº</div><div class="line">2. å°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°è¿›ç¨‹ä¸­ (Copying the data from the kernel to the process)</div></pre></td></tr></table></figure>
<h3 id="Blocking-IO"><a href="#Blocking-IO" class="headerlink" title="Blocking IO"></a>Blocking IO</h3><p>ä¼ ç»Ÿçš„é˜»å¡ I/O æ¨¡å‹å·¥ä½œæ–¹å¼ï¼šå½“çº¿ç¨‹ä½¿ç”¨ <code>read</code> æˆ–è€… <code>write</code> å¯¹æŸä¸€ä¸ª<strong>æ–‡ä»¶æè¿°ç¬¦ï¼ˆFile Descriptor ä»¥ä¸‹ç®€ç§° FD)</strong>è¿›è¡Œè¯»å†™æ—¶ï¼Œå¦‚æœå½“å‰ FD ä¸å¯è¯»æˆ–ä¸å¯å†™ï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«CPUæŒ‚èµ·é˜»å¡ï¼Œä¸€ç›´ç­‰å¾…æ•°æ®å‡†å¤‡å®Œæ¯•ã€‚</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxp3a06e2jj30rs0ku0wq.jpg" alt=""></p>
<p>ä¾‹å¦‚ï¼štomcatæœåŠ¡å™¨BIOæ¨¡å¼ï¼Œåˆ©ç”¨å¤šçº¿ç¨‹ + çº¿ç¨‹æ±  å¤„ç†ï¼›å³æ¯ä¸€ä¸ªsocketè¿æ¥åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line"> ExecutorService executor = Excutors.newFixedThreadPollExecutor(<span class="number">100</span>);<span class="comment">//çº¿ç¨‹æ± </span></div><div class="line"> ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket();</div><div class="line"> serverSocket.bind(<span class="number">8080</span>);</div><div class="line"> <span class="keyword">while</span>(<span class="keyword">true</span>)&#123; <span class="comment">//æ­»å¾ªç¯ç­‰å¾…æ–°è¿æ¥åˆ°æ¥</span></div><div class="line"> 	Socket socket = serverSocket.accept();</div><div class="line"> 	executor.submit(<span class="keyword">new</span> ConnectIOHandler(socket));<span class="comment">//ä¸ºæ–°çš„è¿æ¥åˆ›å»ºæ–°çš„çº¿ç¨‹</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConnectIOHandler</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Socket socket;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConnectIOnHandler</span><span class="params">(Socket socket)</span></span>&#123;</div><div class="line">       <span class="keyword">this</span>.socket = socket;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">      <span class="keyword">while</span>(!socket.isClosed())&#123; <span class="comment">// æ­»å¾ªç¯å¤„ç†è¯»å†™äº‹ä»¶</span></div><div class="line">          String someThing = socket.read()....<span class="comment">//è¯»å–æ•°æ®</span></div><div class="line">          <span class="keyword">if</span>(someThing!=<span class="keyword">null</span>)&#123;</div><div class="line">             ......<span class="comment">//å¤„ç†æ•°æ®</span></div><div class="line">             socket.write()....<span class="comment">//å†™æ•°æ®</span></div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><ul>
<li>çº¿ç¨‹æœ¬èº«å ç”¨è¾ƒå¤§å†…å­˜ï¼ŒåƒJavaçš„çº¿ç¨‹æ ˆï¼Œä¸€èˆ¬è‡³å°‘åˆ†é…512Kï½1Mçš„ç©ºé—´ï¼Œå¦‚æœç³»ç»Ÿä¸­çš„çº¿ç¨‹æ•°è¿‡åƒï¼Œææ€•æ•´ä¸ªJVMçš„å†…å­˜éƒ½ä¼šè¢«åƒæ‰ä¸€åŠ</li>
<li>çº¿ç¨‹çš„åˆ‡æ¢æˆæœ¬æ˜¯å¾ˆé«˜çš„ã€‚æ“ä½œç³»ç»Ÿå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢çš„æ—¶å€™ï¼Œéœ€è¦ä¿ç•™çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œç„¶åæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ã€‚å¦‚æœçº¿ç¨‹æ•°è¿‡é«˜ï¼Œå¯èƒ½æ‰§è¡Œçº¿ç¨‹åˆ‡æ¢çš„æ—¶é—´ç”šè‡³ä¼šå¤§äºçº¿ç¨‹æ‰§è¡Œçš„æ—¶é—´</li>
</ul>
<h3 id="IOå¤šè·¯å¤ç”¨-IO-mutiplexing"><a href="#IOå¤šè·¯å¤ç”¨-IO-mutiplexing" class="headerlink" title="IOå¤šè·¯å¤ç”¨(IO mutiplexing)"></a>IOå¤šè·¯å¤ç”¨(IO mutiplexing)</h3><p>IOå¤šè·¯å¤ç”¨å°±é€šè¿‡ä¸€ç§æœºåˆ¶ï¼Œå•ä¸ªçº¿ç¨‹é€šè¿‡ç›‘è§†å¤šä¸ªI/Oæµçš„çŠ¶æ€æ¥åŒæ—¶ç®¡ç†å¤šä¸ªI/Oæµï¼Œä¸€æ—¦æŸä¸ªæè¿°ç¬¦å°±ç»ªï¼ˆä¸€èˆ¬æ˜¯è¯»å°±ç»ªæˆ–è€…å†™å°±ç»ªï¼‰ï¼Œèƒ½å¤Ÿé€šçŸ¥ç¨‹åºè¿›è¡Œç›¸åº”çš„è¯»å†™æ“ä½œ</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxpxgg7qbfj30rs0kun32.jpg" alt=""></p>
<p>å½“åº”ç”¨è¿›ç¨‹é€šè¿‡<code>select</code>è¯»å–æ–‡ä»¶(<code>socket</code>)ï¼Œåº”ç”¨è¿›ç¨‹ä¼šè¢«<code>block</code>ï¼Œäºæ­¤åŒæ—¶å†…æ ¸ä¼šâ€œç›‘è§†â€æ‰€æœ‰é€šè¿‡<code>select</code>è¯·æ±‚çš„æ–‡ä»¶è¯»å–(<code>socket</code>)ï¼Œä»»ä½•ä¸€ä¸ªæ–‡ä»¶(<code>socket</code>)çš„æ•°æ®è¢«å‡†å¤‡å¥½ï¼Œ<code>select</code>å°±ä¼šè¿”å›ï¼Œåº”ç”¨è¿›ç¨‹å†è°ƒç”¨<code>read</code>æ“ä½œï¼ŒæŠŠæ•°æ®ä»å†…æ ¸ä¸­æ‹·è´åˆ°åº”ç”¨è¿›ç¨‹ã€‚</p>
<h4 id="ä¼˜ç¼ºç‚¹"><a href="#ä¼˜ç¼ºç‚¹" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h4><ul>
<li>IOå¤ç”¨æŠ€æœ¯çš„ä¼˜åŠ¿åœ¨äºï¼Œåªéœ€è¦ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥ç®¡ç†å¤šä¸ªsocketï¼Œç³»ç»Ÿä¸éœ€è¦å»ºç«‹æ–°çš„è¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œä¹Ÿä¸å¿…ç»´æŠ¤è¿™äº›çº¿ç¨‹å’Œè¿›ç¨‹ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå‡å°‘äº†èµ„æºå ç”¨ï¼›é€‚åˆäºè¿æ¥æ•°å¤šçš„åœºæ™¯(nginxï¼Œrpcï¼Œredisç­‰)ã€‚</li>
<li>å¦‚æœå¤„ç†çš„è¿æ¥æ•°ä¸æ˜¯å¾ˆé«˜çš„è¯ï¼Œä½¿ç”¨select/epollçš„web serverä¸ä¸€å®šæ¯”ä½¿ç”¨multi-threading + blocking IOçš„web serveræ€§èƒ½æ›´å¥½ï¼Œå¯èƒ½å»¶è¿Ÿè¿˜æ›´å¤§ã€‚select/epollçš„ä¼˜åŠ¿å¹¶ä¸æ˜¯å¯¹äºå•ä¸ªè¿æ¥èƒ½å¤„ç†å¾—æ›´å¿«ï¼Œè€Œæ˜¯åœ¨äº<strong>èƒ½å¤„ç†æ›´å¤šçš„è¿æ¥</strong></li>
</ul>
<h3 id="selectï¼Œpollï¼Œepoll"><a href="#selectï¼Œpollï¼Œepoll" class="headerlink" title="selectï¼Œpollï¼Œepoll"></a><code>select</code>ï¼Œ<code>poll</code>ï¼Œ<code>epoll</code></h3><p><code>select</code>ï¼Œ<code>poll</code>ï¼Œ<code>epoll</code>éƒ½æ˜¯IOå¤šè·¯å¤ç”¨çš„å®ç°æœºåˆ¶ã€‚<code>select</code>ï¼Œ<code>poll</code>ï¼Œ<code>epoll</code>æœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥I/Oï¼Œå› ä¸ºå®ƒä»¬éƒ½éœ€è¦åœ¨è¯»å†™äº‹ä»¶å°±ç»ªåè‡ªå·±è´Ÿè´£è¿›è¡Œè¯»å†™ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¯»å†™è¿‡ç¨‹æ˜¯é˜»å¡çš„</p>
<p><strong>æ³¨æ„: IOå¤šè·¯å¤ç”¨ç»å¸¸è¢«ç§°ä¸ºå¼‚æ­¥éé˜»å¡ï¼Œè¿™é‡Œçš„å¼‚æ­¥åªæ˜¯ç›¸å¯¹äºä»¥å‰åŒæ­¥é˜»å¡è€Œèµ·çš„åç§°ï¼Œå¹¶éå®é™…æƒ…å†µä¸‹çš„unixå¼‚æ­¥æ¨¡å‹ï¼Œå¦‚æœä»Unix IOæ¨¡å‹è§’åº¦åªèƒ½å°†IOå¤šè·¯å¤ç”¨ç§°ä¸ºéé˜»å¡IO</strong></p>
<p>å¯¹äºIOå¤šè·¯å¤ç”¨ï¼Œæœ‰ä¸¤ä»¶äº‹æ˜¯å¿…é¡»è¦åšçš„(å¯¹äºç›‘æ§å¯è¯»äº‹ä»¶è€Œè¨€)ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1. å‡†å¤‡å¥½éœ€è¦ç›‘æ§çš„fdsé›†åˆ</div><div class="line">2. æ¢æµ‹å¹¶è¿”å›fdsé›†åˆä¸­å“ªäº›fdå¯è¯»</div></pre></td></tr></table></figure>
<h4 id="select"><a href="#select" class="headerlink" title="select"></a><code>select</code></h4><h5 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">å•ä¸ªè¿›ç¨‹å°±å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªç½‘ç»œè¿æ¥çš„IOè¯·æ±‚ï¼ˆåŒæ—¶é˜»å¡å¤šä¸ªIOæ“ä½œï¼‰ã€‚åŸºæœ¬åŸç†å°±æ˜¯ç¨‹åºè°ƒç”¨select()ï¼Œç„¶åæ•´ä¸ªç¨‹åºå°±é˜»å¡äº†ï¼Œè¿™æ—¶å€™ï¼Œselectä¼šå°†éœ€è¦ç›‘æ§çš„readfdsé›†åˆæ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆå‡è®¾ç›‘æ§çš„ä»…ä»…æ˜¯socketå¯è¯»ï¼‰ï¼Œkernelå°±ä¼šè½®è¯¢æ£€æŸ¥æ‰€æœ‰selectè´Ÿè´£çš„fdï¼Œå½“æ‰¾åˆ°ä¸€ä¸ªclientä¸­çš„æ•°æ®å‡†å¤‡å°±ç»ªäº†ï¼Œselectå°±ä¼šè¿”å›ï¼Œè¿™ä¸ªæ—¶å€™ç¨‹åºå°±ä¼šç³»ç»Ÿè°ƒç”¨ï¼Œå°†æ•°æ®ä»kernelå¤åˆ¶åˆ°è¿›ç¨‹ç¼“å†²åŒºã€‚</div></pre></td></tr></table></figure>
<h5 id="ä¼˜ç¼ºç‚¹-1"><a href="#ä¼˜ç¼ºç‚¹-1" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h5><ul>
<li><code>select</code>ç›®å‰å‡ ä¹åœ¨æ‰€æœ‰çš„å¹³å°ä¸Šæ”¯æŒï¼Œå…¶è‰¯å¥½è·¨å¹³å°æ”¯æŒä¹Ÿæ˜¯å®ƒçš„ä¸€ä¸ªä¼˜ç‚¹</li>
<li>æ¯æ¬¡è°ƒç”¨<code>select</code>ï¼Œéƒ½éœ€è¦æŠŠfdé›†åˆä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªå¼€é”€åœ¨fdå¾ˆå¤šæ—¶ä¼šå¾ˆå¤§</li>
<li>åŒæ—¶æ¯æ¬¡è°ƒç”¨<code>select</code>éƒ½éœ€è¦åœ¨å†…æ ¸éå†ä¼ é€’è¿›æ¥çš„æ‰€æœ‰fdï¼Œè¿™ä¸ªå¼€é”€åœ¨fdå¾ˆå¤šæ—¶ä¹Ÿå¾ˆå¤§</li>
<li><code>select</code>æ”¯æŒçš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å¤ªå°äº†ï¼Œé»˜è®¤æ˜¯1024</li>
</ul>
<h4 id="poll"><a href="#poll" class="headerlink" title="poll"></a><code>poll</code></h4><h5 id="åŸºæœ¬åŸç†-1"><a href="#åŸºæœ¬åŸç†-1" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pollçš„åŸç†ä¸selectéå¸¸ç›¸ä¼¼ï¼Œå·®åˆ«å¦‚ä¸‹ï¼š</div><div class="line">	1) æè¿°fdé›†åˆçš„æ–¹å¼ä¸åŒï¼Œpollä½¿ç”¨ pollfd ç»“æ„è€Œä¸æ˜¯selectç»“æ„fd_setç»“æ„ï¼Œæ‰€ä»¥pollæ˜¯é“¾å¼çš„ï¼Œæ²¡æœ‰æœ€å¤§è¿æ¥æ•°çš„é™åˆ¶</div><div class="line">	2) pollæœ‰ä¸€ä¸ªç‰¹ç‚¹æ˜¯æ°´å¹³è§¦å‘ï¼Œä¹Ÿå°±æ˜¯é€šçŸ¥ç¨‹åºfdå°±ç»ªåï¼Œè¿™æ¬¡æ²¡æœ‰è¢«å¤„ç†ï¼Œé‚£ä¹ˆä¸‹æ¬¡pollçš„æ—¶å€™ä¼šå†æ¬¡é€šçŸ¥è¯¥fdå·²ç»å°±ç»ªã€‚</div></pre></td></tr></table></figure>
<h5 id="ä¼˜ç¼ºç‚¹-2"><a href="#ä¼˜ç¼ºç‚¹-2" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h5><p><code>poll</code>æœºåˆ¶è™½ç„¶æ”¹è¿›äº†<code>select</code>çš„ç›‘æ§å¤§å°1024çš„é™åˆ¶ï¼Œä½†ä»¥ä¸‹ä¸¤ä¸ªæ€§èƒ½é—®é¢˜è¿˜æ²¡æœ‰è§£å†³ :</p>
<ul>
<li>fdsé›†åˆæ•´ä½“ä»ç„¶éœ€è¦ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„é—®é¢˜ï¼Œè€Œä¸ç®¡è¿™æ ·çš„å¤åˆ¶æ˜¯ä¸æ˜¯æœ‰æ„ä¹‰</li>
<li>å½“è¢«ç›‘æ§çš„fdsä¸­æŸäº›æœ‰æ•°æ®å¯è¯»çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›é€šçŸ¥æ›´åŠ ç²¾ç»†ä¸€ç‚¹ï¼Œå°±æ˜¯æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿä»é€šçŸ¥ä¸­å¾—åˆ°æœ‰å¯è¯»äº‹ä»¶çš„fdsåˆ—è¡¨ï¼Œè€Œä¸æ˜¯éœ€è¦éå†æ•´ä¸ªfdsæ¥æ”¶é›†ã€‚</li>
</ul>
<h4 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a><code>epoll</code></h4><p>å®ƒæ˜¯ç”±<code>Linux</code>å†…æ ¸2.6æ¨å‡ºçš„å¯ä¼¸ç¼©çš„IOå¤šè·¯å¤ç”¨å®ç°ï¼Œç›®çš„æ˜¯ä¸ºäº†æ›¿ä»£<code>select()</code>ä¸<code>poll()</code></p>
<p>äº‹å®ä¸Šï¼ŒåŒæ—¶è¿æ¥çš„å¤§é‡å®¢æˆ·ç«¯åœ¨ä¸€æ—¶åˆ»å¯èƒ½åªæœ‰å¾ˆå°‘çš„å¤„äºå°±ç»ªçŠ¶æ€ï¼Œå› æ­¤éšç€ç›‘è§†çš„æè¿°ç¬¦æ•°é‡çš„å¢é•¿ï¼Œ<code>select()</code>ä¸<code>poll()</code>çš„æ•ˆç‡ä¹Ÿä¼šçº¿æ€§ä¸‹é™ã€‚</p>
<h5 id="åŸºæœ¬åŸç†-2"><a href="#åŸºæœ¬åŸç†-2" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h5><p><code>select</code>å’Œ<code>poll</code>éƒ½åªæä¾›äº†ä¸€ä¸ªå‡½æ•°ï¼<code>select</code>æˆ–è€…<code>poll</code>å‡½æ•°ã€‚è€Œ<code>epoll</code>æä¾›äº†ä¸‰ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>int epoll_create(int size)</strong>ï¼š// åˆ›å»ºä¸€ä¸ª<code>epoll</code>çš„å¥æŸ„ï¼Œsizeç”¨æ¥å‘Šè¯‰å†…æ ¸è¿™ä¸ªç›‘å¬çš„æ•°ç›®ä¸€å…±æœ‰å¤šå¤§</li>
<li><strong>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)</strong>ï¼š// æ³¨å†Œæè¿°ç¬¦fdè¦ç›‘å¬çš„äº‹ä»¶ç±»å‹ï¼›<code>epfd</code>:æ˜¯<code>epoll_create()</code>çš„è¿”å›å€¼; fd:éœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦; <code>epoll_event</code>:å‘Šè¯‰å†…æ ¸éœ€è¦ç›‘å¬ä»€ä¹ˆäº‹</li>
<li><strong>int epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout)</strong>ï¼š // ç­‰å¾…<code>epfd</code>ä¸Šçš„ioäº‹ä»¶ï¼Œè¿”å›åœ¨<code>events</code>ä¸­å‘ç”Ÿçš„äº‹ä»¶, æœ€å¤šè¿”å›<code>maxevents</code>ä¸ªäº‹ä»¶</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">epollæ‰§è¡Œè¿‡ç¨‹:</div><div class="line">	1) é¦–å…ˆæ‰§è¡Œepoll_createåˆ›å»ºä¸€ä¸ªepollå¥æŸ„ï¼›å¹¶å¼€è¾Ÿepollè‡ªå·±çš„å†…æ ¸é«˜é€ŸcacheåŒºï¼Œåœ¨è¯¥ç¼“å†²åŒºå»ºç«‹çº¢é»‘æ ‘å’Œå°±ç»ªé“¾è¡¨</div><div class="line">	2) epoll_ctlæ‰§è¡ŒaddåŠ¨ä½œæ—¶é™¤äº†å°†è¦ç›‘å¬çš„æ–‡ä»¶å¥æŸ„æ”¾åˆ°çº¢é»‘æ ‘ä¸Šä¹‹å¤–ï¼Œè¿˜å‘å†…æ ¸æ³¨å†Œäº†è¯¥æ–‡ä»¶å¥æŸ„çš„å›è°ƒå‡½æ•°(å†…æ ¸ä¸­æ–­å¤„ç†ç¨‹åºæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°)ï¼Œå†…æ ¸åœ¨æ£€æµ‹åˆ°æŸå¥æŸ„å¯è¯»å¯å†™æ—¶ï¼ˆå†…æ ¸é’ˆå¯¹è¯»ç¼“å†²åŒºå’Œå†™ç¼“å†²åŒºæ¥åˆ¤æ–­æ˜¯å¦å¯è¯»å¯å†™ï¼‰åˆ™è°ƒç”¨è¯¥å›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°å°†æ–‡ä»¶å¥æŸ„æ”¾åˆ°å°±ç»ªé“¾è¡¨(å½“ä¸€ä¸ªsocketä¸Šæœ‰æ•°æ®åˆ°äº†ï¼Œå†…æ ¸åœ¨æŠŠç½‘å¡ä¸Šçš„æ•°æ®copyåˆ°å†…æ ¸ä¸­åå°±æ¥æŠŠsocketæ’å…¥åˆ°å‡†å¤‡å°±ç»ªé“¾è¡¨é‡Œäº†)ã€‚</div><div class="line">	3) epoll_waitåªç›‘æ§å°±ç»ªé“¾è¡¨å°±å¯ä»¥(åˆ©ç”¨schedule_timeout()å®ç°ç¡ä¸€ä¼šï¼Œåˆ¤æ–­ä¸€ä¼šçš„æ•ˆæœ)ï¼Œå¦‚æœå°±ç»ªé“¾è¡¨æœ‰æ–‡ä»¶å¥æŸ„ä¸ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºè¯¥æ–‡ä»¶å¥æŸ„å¯è¯»å¯å†™ï¼Œå¹¶è¿”å›åˆ°ç”¨æˆ·æ€ï¼ˆå°‘é‡çš„æ‹·è´ï¼‰</div><div class="line">	4) ç”±äºå†…æ ¸ä¸ä¿®æ”¹æ–‡ä»¶å¥æŸ„çš„ä½ç½®ï¼Œå› æ­¤åªéœ€è¦åœ¨ç¬¬ä¸€æ¬¡ä¼ å…¥å°±å¯ä»¥é‡å¤ç›‘æ§ï¼Œç›´åˆ°ä½¿ç”¨epoll_ctlåˆ é™¤ï¼Œå¦åˆ™ä¸éœ€è¦é‡æ–°ä¼ å…¥ï¼Œå› æ­¤æ— å¤šæ¬¡æ‹·è´</div></pre></td></tr></table></figure>
<p><code>epoll_ctl</code>é€šè¿‡(<code>EPOLL_CTL_ADD</code>ã€<code>EPOLL_CTL_MOD</code>ã€<code>EPOLL_CTL_DEL</code>)ä¸‰ä¸ªæ“ä½œæ¥åˆ†æ•£å¯¹éœ€è¦ç›‘æ§çš„fdsé›†åˆçš„ä¿®æ”¹ï¼Œåšåˆ°äº†æœ‰å˜åŒ–æ‰å˜æ›´ï¼Œå°†<code>select/poll</code>é«˜é¢‘ã€å¤§å—å†…å­˜æ‹·è´(é›†ä¸­å¤„ç†)å˜æˆ<code>epoll_ctl</code>çš„ä½é¢‘ã€å°å—å†…å­˜çš„æ‹·è´(åˆ†æ•£å¤„ç†)ï¼Œé¿å…äº†å¤§é‡çš„å†…å­˜æ‹·è´</p>
<h5 id="ä¼˜ç¼ºç‚¹-3"><a href="#ä¼˜ç¼ºç‚¹-3" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h5><p>ç›¸æ¯”<code>select/poll</code>ï¼Œepollçš„ä¼˜ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ²¡æœ‰æœ€å¤§å¹¶å‘è¿æ¥çš„é™åˆ¶ï¼Œèƒ½æ‰“å¼€çš„FDçš„ä¸Šé™è¿œå¤§äº1024 (åœ¨1GBå†…å­˜çš„æœºå™¨ä¸Šå¤§çº¦æ˜¯10ä¸‡å·¦å³)</li>
<li>æ•ˆç‡æå‡ï¼Œä¸æ˜¯è½®è¯¢çš„æ–¹å¼ï¼Œä¸ä¼šéšç€FDæ•°ç›®çš„å¢åŠ æ•ˆç‡ä¸‹é™ã€‚åªæœ‰æ´»è·ƒå¯ç”¨çš„FDæ‰ä¼šè°ƒç”¨<code>callback</code>å‡½æ•°ï¼›å³<code>epoll</code>æœ€å¤§çš„ä¼˜ç‚¹å°±åœ¨äºå®ƒåªç®¡ä½ â€œæ´»è·ƒâ€çš„è¿æ¥ï¼Œè€Œè·Ÿè¿æ¥æ€»æ•°æ— å…³ï¼Œå› æ­¤åœ¨å®é™…çš„ç½‘ç»œç¯å¢ƒä¸­ï¼Œ<code>epoll</code>çš„æ•ˆç‡å°±ä¼šè¿œè¿œé«˜äº<code>select</code>å’Œ<code>poll</code>ã€‚</li>
<li><code>epoll</code>å†…éƒ¨ä½¿ç”¨äº†<code>mmap</code>å…±äº«äº†ç”¨æˆ·å’Œå†…æ ¸çš„éƒ¨åˆ†ç©ºé—´ï¼Œé¿å…äº†æ•°æ®çš„æ¥å›æ‹·è´</li>
<li><code>epoll</code> æœ‰ä¸ªè‡´å‘½çš„ç¼ºç‚¹ï¼Œåªæœ‰<code>linux</code>æ”¯æŒ</li>
</ul>
<h5 id="epollçš„ä¸¤ç§å·¥ä½œæ¨¡å¼"><a href="#epollçš„ä¸¤ç§å·¥ä½œæ¨¡å¼" class="headerlink" title="epollçš„ä¸¤ç§å·¥ä½œæ¨¡å¼"></a><code>epoll</code>çš„ä¸¤ç§å·¥ä½œæ¨¡å¼</h5><p>æ”¯æŒè¾¹ç¼˜è§¦å‘<strong>ETï¼ˆedge triggerï¼‰</strong>ä¸æ°´å¹³è§¦å‘<strong>LTï¼ˆlevel triggerï¼‰</strong>ä¸¤ç§æ¨¡å¼ï¼ˆ<code>poll()</code>åªæ”¯æŒæ°´å¹³è§¦å‘ï¼‰</p>
<ul>
<li><strong>LTæ¨¡å¼</strong>ï¼šç¼ºçœçš„å·¥ä½œæ–¹å¼ï¼Œå¹¶ä¸”åŒæ—¶æ”¯æŒ<code>block</code>å’Œ<code>no-block socket</code>ï¼›å½“<code>epoll_wait</code>æ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œ<code>åº”ç”¨ç¨‹åºå¯ä»¥ä¸ç«‹å³å¤„ç†è¯¥äº‹ä»¶</code>ã€‚ä¸‹æ¬¡è°ƒç”¨<code>epoll_wait</code>æ—¶ï¼Œä¼šå†æ¬¡å“åº”åº”ç”¨ç¨‹åºå¹¶é€šçŸ¥æ­¤äº‹ä»¶(<strong>æ¸…ç†å°±ç»ªåˆ—è¡¨åï¼Œé‡æ–°æŠŠå¥æŸ„æ”¾å›åˆšåˆšæ¸…ç©ºçš„å°±ç»ªåˆ—è¡¨</strong>)</li>
<li><p><strong>ETæ¨¡å¼</strong>ï¼šé«˜é€Ÿå·¥ä½œæ–¹å¼ï¼Œåªæ”¯æŒ<code>no-block socket</code>ï¼›å½“<code>epoll_wait</code>æ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œ<code>åº”ç”¨ç¨‹åºå¿…é¡»ç«‹å³å¤„ç†è¯¥äº‹ä»¶</code>ã€‚å¦‚æœä¸å¤„ç†ï¼Œä¸‹æ¬¡è°ƒç”¨<code>epoll_wait</code>æ—¶ï¼Œä¸ä¼šå†æ¬¡å“åº”åº”ç”¨ç¨‹åºå¹¶é€šçŸ¥æ­¤äº‹ä»¶(<strong>only once</strong>)ã€‚æ‰€ä»¥åœ¨<strong>ETæ¨¡å¼</strong>ä¸‹ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡whileå¾ªç¯ï¼Œä¸€æ¬¡æ€§è¯»å®Œå…¨éƒ¨æ•°æ®ï¼<code>epoll</code>é»˜è®¤ä½¿ç”¨çš„æ˜¯LTï¼</p>
<p><strong>ETæ¨¡å¼</strong>åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå‡å°‘äº†<code>epoll</code>äº‹ä»¶è¢«é‡å¤è§¦å‘çš„æ¬¡æ•°ï¼Œå› æ­¤æ•ˆç‡è¦æ¯”<strong>LTæ¨¡å¼</strong>é«˜ã€‚<code>epoll</code>å·¥ä½œåœ¨ETæ¨¡å¼çš„æ—¶å€™ï¼Œå¿…é¡»ä½¿ç”¨éé˜»å¡å¥—æ¥å£ï¼Œä»¥é¿å…ç”±äºä¸€ä¸ªæ–‡ä»¶å¥æŸ„çš„é˜»å¡è¯»/é˜»å¡å†™æ“ä½œæŠŠå¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„ä»»åŠ¡é¥¿æ­»ã€‚</p>
</li>
</ul>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://devarea.com/linux-io-multiplexing-select-vs-poll-vs-epoll/" target="_blank" rel="external">LINUX â€“ IO MULTIPLEXING â€“ SELECT VS POLL VS EPOLL</a></p>
<p><a href="https://github.com/jasonGeng88/blog/blob/master/201708/java-socket.md" target="_blank" rel="external">JAVA ä¸­åŸç”Ÿçš„ socket é€šä¿¡æœºåˆ¶</a></p>
<p><a href="https://www.zybuluo.com/phper/note/595507" target="_blank" rel="external">é€šä¿—è®²è§£ å¼‚æ­¥ï¼Œéé˜»å¡å’Œ IO å¤ç”¨</a></p>
<p><a href="https://draveness.me/redis-io-multiplexing" target="_blank" rel="external">Redis å’Œ I/O å¤šè·¯å¤ç”¨</a></p>
<p><a href="https://www.cnblogs.com/Anker/p/3265058.html" target="_blank" rel="external">selectã€pollã€epollä¹‹é—´çš„åŒºåˆ«æ€»ç»“</a></p>
<p><a href="https://segmentfault.com/a/1190000003063859" target="_blank" rel="external">Linux IOæ¨¡å¼åŠ selectã€pollã€epollè¯¦è§£</a></p>
<p><a href="https://cs.xieyonghui.com/java/33.html" target="_blank" rel="external">Java NIOå’Œå¤šè·¯å¤ç”¨(I/O multiplexing)</a></p>
<p><a href="https://tech.meituan.com/nio.html" target="_blank" rel="external">Java NIOæµ…æ</a></p>
<p><a href="http://ifeve.com/netty-2-5/" target="_blank" rel="external">ã€ŠNetty æƒå¨æŒ‡å—ã€‹â€”4ç§IOçš„å¯¹æ¯”</a></p>
<p><a href="https://www.zhihu.com/question/20122137" target="_blank" rel="external">epoll æˆ–è€… kqueue çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[innoDbå¿«ç…§è¯»]]></title>
      <url>http://zsr.github.io/2018/10/22/innoDb%E5%BF%AB%E7%85%A7%E8%AF%BB/</url>
      <content type="html"><![CDATA[<h3 id="å¿«ç…§è¯»-Snapshot-Read"><a href="#å¿«ç…§è¯»-Snapshot-Read" class="headerlink" title="å¿«ç…§è¯»(Snapshot Read)"></a>å¿«ç…§è¯»(Snapshot Read)</h3><p>MySQLæ•°æ®åº“ï¼ŒInnoDBå­˜å‚¨å¼•æ“ï¼Œä¸ºäº†æé«˜å¹¶å‘ï¼Œä½¿ç”¨MVCC(<strong>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶</strong>)æœºåˆ¶ï¼Œåœ¨å¹¶å‘äº‹åŠ¡æ—¶ï¼Œé€šè¿‡è¯»å–æ•°æ®è¡Œçš„å†å²æ•°æ®ç‰ˆæœ¬ï¼Œä¸åŠ é”ï¼Œæ¥æé«˜å¹¶å‘çš„ä¸€ç§ä¸åŠ é”ä¸€è‡´æ€§è¯»(Consistent Nonlocking Read)ã€‚ä¸€è‡´æ€§è¯»ï¼Œåˆç§°ä¸ºå¿«ç…§è¯»</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">A consistent read means that InnoDB uses multi-versioning to present to a query a snapshot of the database at a point in time. The query sees the changes made by transactions that committed before that point of time, and no changes made by later or uncommitted transactions. The exception to this rule is that the query sees the changes made by earlier statements within the same transaction.</div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼šæœ¬äº‹åŠ¡ä¸­ä¿®æ”¹çš„æ•°æ®ï¼Œå³ä½¿æœªæäº¤çš„æ•°æ®ä¹Ÿå¯ä»¥è¢«æœ¬äº‹åŠ¡çš„åé¢éƒ¨åˆ†è¯»å–åˆ°</strong></p>
<h3 id="å¿«ç…§å®ç°"><a href="#å¿«ç…§å®ç°" class="headerlink" title="å¿«ç…§å®ç°"></a>å¿«ç…§å®ç°</h3><ul>
<li><strong>undo log</strong> ï¼šè®°å½•äº‹åŠ¡å˜æ›´å‰çš„çŠ¶æ€ã€‚æ“ä½œæ•°æ®ä¹‹å‰ï¼Œå…ˆå°†æ•°æ®å¤‡ä»½åˆ°undo logï¼Œç„¶åè¿›è¡Œæ•°æ®ä¿®æ”¹(COW:å†™æ—¶å¤‡ä»½)ï¼Œå¦‚æœå‡ºç°é”™è¯¯æˆ–ç”¨æˆ·æ‰§è¡Œäº†rollbackè¯­å¥ï¼Œåˆ™ç³»ç»Ÿå°±å¯ä»¥åˆ©ç”¨undo logä¸­çš„å¤‡ä»½æ•°æ®æ¢å¤åˆ°äº‹åŠ¡å¼€å§‹ä¹‹å‰çš„çŠ¶æ€ã€‚</li>
<li><strong>redo logï¼š</strong> è®°å½•äº‹åŠ¡å˜æ›´åçš„çŠ¶æ€ã€‚åœ¨äº‹åŠ¡æäº¤å‰ï¼Œåªè¦å°†redo logæŒä¹…åŒ–å³å¯ï¼Œæ•°æ®åœ¨å†…å­˜ä¸­å˜æ›´ã€‚å½“ç³»ç»Ÿå´©æºƒæ—¶ï¼Œè™½ç„¶æ•°æ®æ²¡æœ‰è½ç›˜ï¼Œä½†æ˜¯redo logå·²æŒä¹…åŒ–ï¼Œç³»ç»Ÿå¯ä»¥æ ¹æ®redo Logçš„å†…å®¹ï¼Œå°†æ‰€æœ‰æ•°æ®æ¢å¤åˆ°æœ€æ–°çš„çŠ¶æ€ã€‚</li>
</ul>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://dev.mysql.com/doc/refman/5.6/en/innodb-consistent-read.html" target="_blank" rel="external">ä¸€è‡´æ€§è¯»</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[nginxè´Ÿè½½å‡è¡¡ç­–ç•¥]]></title>
      <url>http://zsr.github.io/2018/09/17/nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5/</url>
      <content type="html"><![CDATA[<p>è´Ÿè½½å‡è¡¡å¯ä»¥å°†å‰ç«¯çš„è¯·æ±‚åˆ†æ‹…åˆ°åç«¯å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œæå‡ç³»ç»Ÿçš„å“åº”å’Œå¤„ç†èƒ½åŠ›ã€‚</p>
<h3 id="è´Ÿè½½å‡è¡¡ç­–ç•¥"><a href="#è´Ÿè½½å‡è¡¡ç­–ç•¥" class="headerlink" title="è´Ÿè½½å‡è¡¡ç­–ç•¥"></a>è´Ÿè½½å‡è¡¡ç­–ç•¥</h3><p>è´Ÿè½½å‡è¡¡çš„ç­–ç•¥å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼š<code>å†…ç½®ç­–ç•¥</code> å’Œ<code>æ‰©å±•ç­–ç•¥</code></p>
<ul>
<li>å†…ç½®ç­–ç•¥ï¼šä¸€èˆ¬ä¼šç›´æ¥ç¼–è¯‘è¿›Nginxå†…æ ¸ï¼Œå¸¸ç”¨çš„æœ‰<code>è½®è¯¢</code>ã€<code>ip hash</code></li>
<li>æ‰©å±•ç­–ç•¥ï¼š<code>fair</code>ã€<code>url hash</code>ç­‰</li>
</ul>
<h4 id="æ™®é€šè½®è¯¢æ–¹å¼"><a href="#æ™®é€šè½®è¯¢æ–¹å¼" class="headerlink" title="æ™®é€šè½®è¯¢æ–¹å¼"></a>æ™®é€šè½®è¯¢æ–¹å¼</h4><p>é»˜è®¤é€‰é¡¹ï¼Œå½“<code>weight</code>ä¸æŒ‡å®šæ—¶ï¼Œå„æœåŠ¡å™¨æƒé‡ç›¸åŒï¼Œ æ¯ä¸ªè¯·æ±‚æŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœåç«¯æœåŠ¡å™¨downæ‰ï¼Œèƒ½è‡ªåŠ¨å‰”é™¤ã€‚</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">upstream</span> bakend &#123;</div><div class="line">  <span class="attribute">server</span> <span class="number">10.11.0.1</span>;</div><div class="line">  <span class="attribute">server</span> <span class="number">10.11.0.2</span>;</div><div class="line">  <span class="attribute">server</span> <span class="number">10.11.0.3</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="åŠ æƒè½®è¯¢æ–¹å¼"><a href="#åŠ æƒè½®è¯¢æ–¹å¼" class="headerlink" title="åŠ æƒè½®è¯¢æ–¹å¼"></a>åŠ æƒè½®è¯¢æ–¹å¼</h4><p>æŒ‡å®šè½®è¯¢å‡ ç‡ï¼Œ<code>weight</code>å’Œè®¿é—®æ¯”ç‡æˆæ­£æ¯”ï¼Œç”¨äºåç«¯æœåŠ¡å™¨æ€§èƒ½ä¸å‡çš„æƒ…å†µã€‚</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">upstream</span> backend &#123;</div><div class="line">  <span class="attribute">server</span> <span class="number">10.11.0.1</span> weight=<span class="number">3</span>;</div><div class="line">  <span class="attribute">server</span> <span class="number">10.11.0.2</span> weight=<span class="number">7</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æƒé‡è¶Šé«˜ï¼Œåœ¨è¢«è®¿é—®çš„æ¦‚ç‡è¶Šå¤§ï¼Œå¦‚ä¸Šä¾‹ï¼Œåˆ†åˆ«æ˜¯30%ï¼Œ70%ã€‚</p>
<h5 id="è½®è¯¢æµç¨‹å›¾"><a href="#è½®è¯¢æµç¨‹å›¾" class="headerlink" title="è½®è¯¢æµç¨‹å›¾"></a>è½®è¯¢æµç¨‹å›¾</h5><p><img src="http://www.rowkey.me/images/blog_images/nginx/ngx_wr.png" alt=""></p>
<p>é¦–å…ˆå°†è¯·æ±‚éƒ½åˆ†ç»™é«˜æƒé‡çš„æœºå™¨ï¼Œç›´åˆ°è¯¥æœºå™¨çš„æƒå€¼é™åˆ°äº†æ¯”å…¶ä»–æœºå™¨ä½ï¼Œæ‰å¼€å§‹å°†è¯·æ±‚åˆ†ç»™ä¸‹ä¸€ä¸ªé«˜æƒé‡çš„æœºå™¨ï¼›å½“æ‰€æœ‰åç«¯æœºå™¨éƒ½downæ‰æ—¶ï¼Œ<code>nginx</code>ä¼šç«‹å³å°†æ‰€æœ‰æœºå™¨çš„æ ‡å¿—ä½æ¸…æˆåˆå§‹çŠ¶æ€ï¼Œä»¥é¿å…é€ æˆæ‰€æœ‰çš„æœºå™¨éƒ½å¤„åœ¨<code>timeout</code>çš„çŠ¶æ€</p>
<h4 id="ip-hashæ–¹å¼"><a href="#ip-hashæ–¹å¼" class="headerlink" title="ip hashæ–¹å¼"></a>ip hashæ–¹å¼</h4><p><strong>é»˜è®¤æƒ…å†µä¸‹ï¼ŒNginx ä¼šä¸ºä½ æä¾›è½®è¯¢ä½œä¸ºè´Ÿè½½å‡è¡¡ç­–ç•¥</strong>ã€‚</p>
<p>é‡‡ç”¨<code>ip_hash</code>ç­–ç•¥è§£å†³ç™»å½•ä¿¡æ¯ä¸¢å¤±ï¼Œå¦‚æœå®¢æˆ·å·²ç»è®¿é—®äº†æŸä¸ªæœåŠ¡å™¨ï¼Œå½“ç”¨æˆ·å†æ¬¡è®¿é—®æ—¶ï¼Œä¼šå°†è¯¥è¯·æ±‚é€šè¿‡<strong>å“ˆå¸Œç®—æ³•ï¼Œè‡ªåŠ¨å®šä½åˆ°åŒä¸€ä¸ªæœåŠ¡å™¨</strong>ï¼Œå½“ç„¶ï¼Œå¦‚æœæ‰€ <code>hash</code> åˆ°çš„ <code>server</code> å½“å‰ä¸å¯ç”¨ï¼Œåˆ™è¯·æ±‚ä¼šè¢«è½¬ç§»åˆ°å…¶ä»–<code>server</code>ã€‚<br>æ¯ä¸ªè¯·æ±‚æŒ‰è®¿é—®<code>ip</code>çš„<code>hash</code>ç»“æœåˆ†é…ï¼Œè¿™æ ·æ¯ä¸ªè®¿å®¢å›ºå®šè®¿é—®ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥è§£å†³<strong>sessionçš„é—®é¢˜</strong>ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">    ip_hash;</div><div class="line">    server 10.11.0.1;</div><div class="line">    server 10.11.0.2;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="fair"><a href="#fair" class="headerlink" title="fair"></a>fair</h4><p>æ ¹æ®åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´åˆ¤æ–­è´Ÿè½½æƒ…å†µï¼Œä»ä¸­é€‰å‡ºè´Ÿè½½æœ€è½»çš„æœºå™¨è¿›è¡Œä¼˜å…ˆåˆ†é…ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">    server 10.11.0.1;</div><div class="line">    server 10.11.0.2;</div><div class="line">    fair;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¼ºç‚¹ï¼šéœ€è¦ã€Œè´Ÿè½½å‡è¡¡å™¨ã€ä¸åœçš„å»ç»Ÿè®¡æ¯ä¸€å°åç«¯æœåŠ¡å™¨å¯¹è¯·æ±‚çš„å¤„ç†é€Ÿåº¦ï¼Œæ¯”å¦‚ä¸€åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡ï¼Œç”Ÿæˆä¸€ä¸ªåç«¯æœåŠ¡å™¨å¤„ç†é€Ÿåº¦çš„æ’è¡Œæ¦œï¼Œç„¶åã€Œè´Ÿè½½å‡è¡¡å™¨ã€æ ¹æ®è¿™ä¸ªæ’è¡Œæ¦œå»è½¬å‘æœåŠ¡ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[jvmå†…å­˜å‚æ•°]]></title>
      <url>http://zsr.github.io/2018/05/10/jvm%E5%86%85%E5%AD%98%E5%8F%82%E6%95%B0/</url>
      <content type="html"><![CDATA[<h3 id="çº¿ä¸Šjvmå‚æ•°"><a href="#çº¿ä¸Šjvmå‚æ•°" class="headerlink" title="çº¿ä¸Šjvmå‚æ•°"></a>çº¿ä¸Šjvmå‚æ•°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager,</div><div class="line">-XX:MetaspaceSize=256M, // åˆ†é…ç»™ç±»å…ƒæ•°æ®ç©ºé—´çš„åˆå§‹å¤§å°</div><div class="line">-XX:MaxMetaspaceSize=256M, // åˆ†é…ç»™ç±»å…ƒæ•°æ®ç©ºé—´çš„æœ€å¤§å€¼</div><div class="line">-Xms4g, // åˆå§‹å †å¤§å°</div><div class="line">-Xmx4g, // æœ€å¤§å †å¤§å°</div><div class="line">-Xmn1g, // å¹´è½»ä»£å¤§å°</div><div class="line">-Xss256k, // æ¯ä¸ªçº¿ç¨‹çš„å †æ ˆå¤§å°</div><div class="line">-XX:SurvivorRatio=8, // EdenåŒºä¸SurvivoråŒºçš„å¤§å°æ¯”å€¼</div><div class="line">-XX:MaxTenuringThreshold=8, // åƒåœ¾æœ€å¤§å¹´é¾„, è¯¥å‚æ•°åªæœ‰åœ¨ä¸²è¡ŒGCæ—¶æ‰æœ‰æ•ˆ.</div><div class="line">-XX:ParallelGCThreads=8, // å¹¶è¡Œæ”¶é›†å™¨çš„çº¿ç¨‹æ•°</div><div class="line">-XX:+UseConcMarkSweepGC, // ä½¿ç”¨CMSå†…å­˜æ”¶é›†</div><div class="line">-XX:+UseParNewGC, // è®¾ç½®å¹´è½»ä»£ä¸ºå¹¶è¡Œæ”¶é›†</div><div class="line">-XX:+DisableExplicitGC, // å…³é—­System.gc()</div><div class="line">-XX:+CMSParallelRemarkEnabled, // é™ä½æ ‡è®°åœé¡¿</div><div class="line">-XX:+CMSClassUnloadingEnabled, // åœ¨CMSä¸­æ¸…ç†è¿‡æœŸçš„Classè€Œä¸ç­‰åˆ°Full GC</div><div class="line">-XX:CMSInitiatingOccupancyFraction=70, // ä½¿ç”¨cmsä½œä¸ºåƒåœ¾å›æ”¶ï¼Œä½¿ç”¨70ï¼…åå¼€å§‹CMSæ”¶é›†</div><div class="line">-XX:CMSFullGCsBeforeCompaction=5, // å¤šå°‘æ¬¡GCåè¿›è¡Œå†…å­˜å‹ç¼©</div><div class="line">-XX:+UseCMSCompactAtFullCollection, // åœ¨FULLGCçš„æ—¶å€™ï¼Œå¯¹å¹´è€ä»£çš„å‹ç¼©</div><div class="line">-XX:+CMSScavengeBeforeRemark, // åœ¨CMS remarkå‰ï¼Œå…ˆæ‰§è¡Œä¸€æ¬¡minor GCå°†æ–°ç”Ÿä»£æ¸…æ‰</div><div class="line">-XX:+HeapDumpOnOutOfMemoryError, // å½“OutOfMemoryErrorå‘ç”Ÿæ—¶ï¼Œå°†heapå†…å­˜dumpåˆ°æ–‡ä»¶</div><div class="line">......</div></pre></td></tr></table></figure>
<h4 id="XX-MetaspaceSize"><a href="#XX-MetaspaceSize" class="headerlink" title="-XX:MetaspaceSize"></a>-XX:MetaspaceSize</h4><p><code>Java 8</code>å½»åº•å°†æ°¸ä¹…ä»£ (<code>PermGen</code>) ç§»é™¤å‡ºäº† <code>HotSpot JVM</code>ï¼Œå°†å…¶åŸæœ‰çš„æ•°æ®è¿ç§»è‡³ <code>Java Heap</code> æˆ– <code>Metaspace</code></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Springäº‹åŠ¡æºç åˆ†æ]]></title>
      <url>http://zsr.github.io/2018/05/08/Spring%E4%BA%8B%E5%8A%A1%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<p>å…³äºäº‹åŠ¡çš„å…·ä½“æ¦‚å¿µå’Œä½¿ç”¨æ–¹å¼ï¼Œ<strong>Springäº‹åŠ¡ç®¡ç†</strong>æœ‰è¯¦ç»†ä»‹ç»</p>
<h3 id="åŸºäºæ³¨è§£çš„äº‹åŠ¡ç®¡ç†"><a href="#åŸºäºæ³¨è§£çš„äº‹åŠ¡ç®¡ç†" class="headerlink" title="åŸºäºæ³¨è§£çš„äº‹åŠ¡ç®¡ç†"></a>åŸºäºæ³¨è§£çš„äº‹åŠ¡ç®¡ç†</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">&lt;!-- æ•°æ®æºé…ç½® --&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"#&#123;jdbc['jdbc.driverClassName']&#125;"</span>/&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"> <span class="comment">&lt;!-- é…ç½®äº‹åŠ¡ç®¡ç†å™¨ --&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- å¼€å¯æ³¨è§£æ–¹å¼é…ç½®äº‹ç‰© --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>/&gt;</span></div></pre></td></tr></table></figure>
<h3 id="Springäº‹åŠ¡è°ƒç”¨è¿‡ç¨‹"><a href="#Springäº‹åŠ¡è°ƒç”¨è¿‡ç¨‹" class="headerlink" title="Springäº‹åŠ¡è°ƒç”¨è¿‡ç¨‹"></a>Springäº‹åŠ¡è°ƒç”¨è¿‡ç¨‹</h3><p><code>Spring</code>äº‹åŠ¡ä½¿ç”¨AOPä»£ç†åçš„æ–¹æ³•è°ƒç”¨æ‰§è¡Œæµç¨‹ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><a href="http://tech.lede.com/2017/02/06/rd/server/SpringTransactional/2.png" target="_blank" rel="external"><img src="http://tech.lede.com/2017/02/06/rd/server/SpringTransactional/2.png" alt="2"></a></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œè°ƒç”¨äº‹åŠ¡æ—¶é¦–å…ˆè°ƒç”¨çš„æ˜¯AOPä»£ç†å¯¹è±¡è€Œä¸æ˜¯ç›®æ ‡å¯¹è±¡ï¼Œé¦–å…ˆæ‰§è¡Œäº‹åŠ¡åˆ‡é¢ï¼Œäº‹åŠ¡åˆ‡é¢å†…éƒ¨é€šè¿‡<code>TransactionInterceptor</code>ç¯ç»•å¢å¼ºè¿›è¡Œäº‹åŠ¡çš„å¢å¼ºã€‚å³è¿›å…¥ç›®æ ‡æ–¹æ³•ä¹‹å‰å¼€å¯äº‹åŠ¡ï¼Œé€€å‡ºç›®æ ‡æ–¹æ³•æ—¶æäº¤/å›æ»šäº‹åŠ¡ã€‚</p>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>å‡è®¾é…ç½®ä¸¤ä¸ªä»¥ä¸Šçš„<code>&lt;tx:annotation-driven/&gt;</code>æ ‡ç­¾ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager1"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager1"</span> </span></div><div class="line">        <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource1"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager2"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager2"</span> </span></div><div class="line">        <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource2"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<p>ç»“æœåªæœ‰ç¬¬ä¸€ä¸ª<code>&lt;tx:annotation-driven/&gt;</code>ä¼šç”Ÿæ•ˆï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨<code>@Transactional</code>æ³¨è§£æ—¶ä¸æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨ï¼Œé»˜è®¤ä½¿ç”¨çš„äº‹åŠ¡ç®¡ç†å™¨æ˜¯<code>transactionManager1</code>ã€‚å¦‚æœè¦ä½¿ç”¨å¤šä¸ªäº‹åŠ¡ç®¡ç†å™¨ï¼Œéœ€è¦åœ¨ä½¿ç”¨<code>@Transactional</code>æ—¶æŒ‡å®šå…·ä½“çš„<code>TransactionManager</code></p>
<h4 id="lt-tx-annotation-driven-gt-åˆ†æ"><a href="#lt-tx-annotation-driven-gt-åˆ†æ" class="headerlink" title="&lt;tx:annotation-driven/&gt;åˆ†æ"></a><code>&lt;tx:annotation-driven/&gt;</code>åˆ†æ</h4><p>è¿™ä¸ªæ ‡ç­¾æ˜¯ç”±<code>TxNamespaceHandler</code>è§£æçš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TxNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String TRANSACTION_MANAGER_ATTRIBUTE = <span class="string">"transaction-manager"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_TRANSACTION_MANAGER_BEAN_NAME = <span class="string">"transactionManager"</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// adviceæ ‡ç­¾è§£æ</span></div><div class="line">		registerBeanDefinitionParser(<span class="string">"advice"</span>, <span class="keyword">new</span> TxAdviceBeanDefinitionParser());</div><div class="line">        <span class="comment">// annotation-drivenæ ‡ç­¾è§£æ</span></div><div class="line">		registerBeanDefinitionParser(<span class="string">"annotation-driven"</span>, <span class="keyword">new</span> AnnotationDrivenBeanDefinitionParser());</div><div class="line">        <span class="comment">// jta-transaction-manageråˆ†å¸ƒå¼äº‹åŠ¡æ ‡ç­¾è§£æ</span></div><div class="line">		registerBeanDefinitionParser(<span class="string">"jta-transaction-manager"</span>, <span class="keyword">new</span> JtaTransactionManagerBeanDefinitionParser());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œå…³æ³¨<code>AnnotationDrivenBeanDefinitionParser</code>è§£æå™¨ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnnotationDrivenBeanDefinitionParser</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionParser</span> </span>&#123;</div><div class="line">   </div><div class="line">  	<span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</div><div class="line">		String mode = element.getAttribute(<span class="string">"mode"</span>);</div><div class="line">		<span class="keyword">if</span> (<span class="string">"aspectj"</span>.equals(mode)) &#123;</div><div class="line">			<span class="comment">// mode="aspectj"</span></div><div class="line">            <span class="comment">// æä¾›å¯¹aspectjæ–¹å¼è¿›è¡Œäº‹åŠ¡åˆ‡å…¥çš„æ”¯æŒ</span></div><div class="line">			registerTransactionAspect(element, parserContext);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// mode="proxy"</span></div><div class="line">            <span class="comment">// é»˜è®¤é‡‡ç”¨aopä»£ç†æ–¹å¼</span></div><div class="line">			AopAutoProxyConfigurer.configureAutoProxyCreator(element, parserContext);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>AopAutoProxyConfigurer</code>ä½œä¸º<code>AnnotationDrivenBeanDefinitionParser</code>é™æ€å†…éƒ¨ç±»ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fr3sdys27fj317u0xiwsb.jpg" alt=""></p>
<p>é‡ç‚¹ä»£ç è¢«çº¢æ¡†æ ‡è®°ï¼Œ<strong>æœ€å¤–å±‚çš„ifåˆ¤æ–­ä¿è¯<code>&lt;tx:annotation-driven/&gt;</code>æ ‡ç­¾åªèƒ½è¢«è§£æä¸€æ¬¡</strong>ï¼Œæ‰€ä»¥åªæœ‰ç¬¬ä¸€æ¬¡è¢«è§£æçš„æ ‡ç­¾ä¼šç”Ÿæ•ˆã€‚åˆ†åˆ«æ³¨å†Œäº†ä¸‰ä¸ª<code>BeanDefinition</code>ï¼Œåˆ†åˆ«ä¸º<code>AnnotationTransactionAttributeSource</code>ã€<code>TransactionInterceptor</code>å’Œ<code>BeanFactoryTransactionAttributeSourceAdvisor</code>ï¼Œå¹¶å°†å‰ä¸¤ä¸ª<code>BeanDefinition</code>æ·»åŠ åˆ°ç¬¬ä¸‰ä¸ª<code>BeanDefinition</code>çš„å±æ€§å½“ä¸­ï¼Œè¿™ä¸‰ä¸ªbeanæ”¯æ’‘äº†æ•´ä¸ªäº‹åŠ¡åŠŸèƒ½</p>
<p>ä¸‹é¢å…³æ³¨äº‹åŠ¡ç®¡ç†æ€ä¹ˆæ³¨å†Œçš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">registerTransactionManager(element, interceptorDef);</div><div class="line"></div><div class="line"><span class="comment">// AnnotationDrivenBeanDefinitionParser.class</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerTransactionManager</span><span class="params">(Element element, BeanDefinition def)</span> </span>&#123;</div><div class="line">		def.getPropertyValues().add(<span class="string">"transactionManagerBeanName"</span>,</div><div class="line">				TxNamespaceHandler.getTransactionManagerName(element));</div><div class="line">	&#125;</div><div class="line"></div><div class="line"><span class="comment">// TxNamespaceHandler.class</span></div><div class="line"><span class="function"><span class="keyword">static</span> String <span class="title">getTransactionManagerName</span><span class="params">(Element element)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> (element.hasAttribute(TRANSACTION_MANAGER_ATTRIBUTE) ?</div><div class="line">				element.getAttribute(TRANSACTION_MANAGER_ATTRIBUTE) : DEFAULT_TRANSACTION_MANAGER_BEAN_NAME);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœ<code>tx:annotation-driven</code>æ²¡æœ‰æŒ‡å®š<code>transaction-manager</code>ï¼Œç³»ç»Ÿä¼šé»˜è®¤æ³¨å†Œ<code>transactionManager</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">AopNamespaceUtils.registerAutoProxyCreatorIfNecessary(parserContext, element);</div><div class="line"></div><div class="line"><span class="comment">// AopNamespaceUtils.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerAutoProxyCreatorIfNecessary</span><span class="params">(</span></span></div><div class="line">			ParserContext parserContext, Element sourceElement) &#123;</div><div class="line">        <span class="comment">// æ³¨å†ŒAutoProxyCreatorï¼Œè¿™é‡Œæ˜¯InfrastructureAdvisorAutoProxyCreator</span></div><div class="line">		BeanDefinition beanDefinition = AopConfigUtils.registerAutoProxyCreatorIfNecessary(</div><div class="line">				parserContext.getRegistry(), parserContext.extractSource(sourceElement));</div><div class="line">	&#125;</div><div class="line"></div><div class="line"><span class="comment">// AopConfigUtils.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BeanDefinition <span class="title">registerAutoProxyCreatorIfNecessary</span><span class="params">(BeanDefinitionRegistry registry, Object source)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> registerOrEscalateApcAsRequired(InfrastructureAdvisorAutoProxyCreator.class, registry, source);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>å®é™…æ³¨å†Œçš„æ˜¯<code>InfrastructureAdvisorAutoProxyCreator</code>åŠ¨æ€ä»£ç†ç”Ÿæˆå™¨</p>
<p><img src="https://img-blog.csdn.net/20161126120230590?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="img"></p>
<p>å‰é¢æ–‡ç« ä»‹ç»ä½¿ç”¨<code>Spring Aop</code>åšåˆ‡é¢å¢å¼ºï¼Œä½¿ç”¨çš„æ˜¯<code>AspectJAwareAdvisorAutoProxyCreator</code>ï¼Œå¯è§æ™®é€šaopä»£ç†ç”Ÿæˆå™¨å’Œ<code>InfrastructureAdvisorAutoProxyCreator</code>éƒ½æ˜¯ç»§æ‰¿äº<code>AbstractAdvisorAutoProxyCreator</code>,å…·ä½“çš„ä»£ç†ç”Ÿæˆè¿‡ç¨‹å‚è€ƒâ€œ<a href="https://zsr.github.io/2017/11/30/Spring-AOP%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Spring AOPæºç åˆ†æ</a>â€</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.linkedkeeper.com/detail/blog.action?bid=1045" target="_blank" rel="external">Springæºç è§£æä¹‹äº‹åŠ¡ç¯‡</a></p>
<p><a href="http://tech.lede.com/2017/02/06/rd/server/SpringTransactional/" target="_blank" rel="external">Spring @TransactionalåŸç†åŠä½¿ç”¨</a></p>
<p><a href="http://cxis.me/2017/04/10/Spring%E4%B8%ADAOP%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BB%8E1.0%E5%88%B05.0%E7%9A%84%E6%BC%94%E8%BF%9B/" target="_blank" rel="external">Springä¸­AOPçš„é…ç½®ä»1.0åˆ°5.0çš„æ¼”è¿›</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Javaä¸­æ£€æŸ¥çš„å¼‚å¸¸ä¸æœªæ£€æŸ¥çš„å¼‚å¸¸]]></title>
      <url>http://zsr.github.io/2018/05/07/Java%E4%B8%AD%E6%A3%80%E6%9F%A5%E7%9A%84%E5%BC%82%E5%B8%B8%E4%B8%8E%E6%9C%AA%E6%A3%80%E6%9F%A5%E7%9A%84%E5%BC%82%E5%B8%B8/</url>
      <content type="html"><![CDATA[<h3 id="javaå¼‚å¸¸"><a href="#javaå¼‚å¸¸" class="headerlink" title="javaå¼‚å¸¸"></a>javaå¼‚å¸¸</h3><p> <img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fr6dtnesi2j30ow0dgabd.jpg" alt=""></p>
<p>é€šå¸¸æˆ‘ä»¬è¯´çš„å¼‚å¸¸æ˜¯åŒ…æ‹¬<code>exception</code>å’Œ<code>error</code>ï¼š</p>
<ul>
<li><code>Error</code>ï¼ˆé”™è¯¯ï¼‰ï¼šæ˜¯ç¨‹åºæ— æ³•å¤„ç†çš„é”™è¯¯ï¼Œè¡¨ç¤ºè¿è¡Œåº”ç”¨ç¨‹åºä¸­è¾ƒä¸¥é‡é—®é¢˜ã€‚å¤§å¤šæ•°çš„é”™è¯¯ä¸ä»£ç ç¼–å†™è€…æ‰§è¡Œçš„æ“ä½œæ— å…³ï¼Œè€Œæ˜¯è¡¨ç¤ºä»£ç è¿è¡Œæ—¶ JVMï¼ˆJava è™šæ‹Ÿæœºï¼‰å‡ºç°çš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå½“ JVM ä¸å†æœ‰ç»§ç»­æ‰§è¡Œæ“ä½œæ‰€éœ€çš„å†…å­˜èµ„æºæ—¶ï¼Œå°†å‡ºç° OutOfMemoryErrorã€‚è¿™äº›å¼‚å¸¸å‘ç”Ÿæ—¶ï¼ŒJavaè™šæ‹Ÿæœºï¼ˆJVMï¼‰ä¸€èˆ¬ä¼šé€‰æ‹©çº¿ç¨‹ç»ˆæ­¢ã€‚</li>
<li><code>Exception</code>ï¼ˆå¼‚å¸¸ï¼‰:æ˜¯ç¨‹åºæœ¬èº«å¯ä»¥å¤„ç†çš„å¼‚å¸¸ã€‚</li>
</ul>
<p>é™¤äº†<code>RuntimeException</code>ä¸å…¶å­ç±»ï¼Œä»¥åŠé”™è¯¯ï¼ˆ<code>Error</code>ï¼‰ï¼Œå…¶ä»–çš„éƒ½æ˜¯æ£€æŸ¥å¼‚å¸¸</p>
<ul>
<li><code>checked exception</code>(æ£€æŸ¥å¼‚å¸¸) ï¼šç¼–è¯‘å™¨è¦æ±‚ä½ å¿…é¡»å¤„ç½®çš„å¼‚å¸¸</li>
<li><code>unchecked exception</code>(æœªæ£€æŸ¥å¼‚å¸¸)ï¼šç¼–è¯‘å™¨ä¸è¦æ±‚å¼ºåˆ¶å¤„ç½®çš„å¼‚å¸¸</li>
</ul>
<p>å¯¹äºæœªæ£€æŸ¥å¼‚å¸¸ä¹Ÿå«<code>RuntimeException</code>(è¿è¡Œæ—¶å¼‚å¸¸)ï¼Œå¯¹äºè¿è¡Œæ—¶å¼‚å¸¸ï¼Œjavaç¼–è¯‘å™¨ä¸è¦æ±‚ä½ ä¸€å®šè¦æŠŠå®ƒæ•è·æˆ–è€…ä¸€å®šè¦ç»§ç»­æŠ›å‡ºï¼Œä½†æ˜¯å¯¹<code>checked exception</code>(æ£€æŸ¥å¼‚å¸¸)è¦æ±‚ä½ å¿…é¡»è¦åœ¨æ–¹æ³•é‡Œé¢æˆ–è€…æ•è·æˆ–è€…ç»§ç»­æŠ›å‡º.</p>
<h3 id="å¼‚å¸¸å¤„ç†æ–¹æ³•"><a href="#å¼‚å¸¸å¤„ç†æ–¹æ³•" class="headerlink" title="å¼‚å¸¸å¤„ç†æ–¹æ³•"></a>å¼‚å¸¸å¤„ç†æ–¹æ³•</h3><ul>
<li>å¯¹æœªæ£€æŸ¥çš„å¼‚å¸¸(<code>unchecked exception</code>)çš„å‡ ç§å¤„ç†æ–¹å¼ï¼š </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1ã€æ•è· </div><div class="line">2ã€ç»§ç»­æŠ›å‡º </div><div class="line">3ã€ä¸å¤„ç†</div></pre></td></tr></table></figure>
<ul>
<li>å¯¹æ£€æŸ¥çš„å¼‚å¸¸(<code>checked exception</code>ï¼Œé™¤äº†<code>RuntimeException</code>ï¼Œå…¶ä»–çš„å¼‚å¸¸éƒ½æ˜¯<code>checked exception</code>)çš„å‡ ç§å¤„ç†æ–¹å¼ï¼š </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1ã€ç»§ç»­æŠ›å‡ºï¼Œæ¶ˆæçš„æ–¹æ³•ï¼Œä¸€ç›´å¯ä»¥æŠ›åˆ°javaè™šæ‹Ÿæœºæ¥å¤„ç† </div><div class="line">2ã€ç”¨try...catchæ•è·</div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼šå¯¹äºæ£€æŸ¥çš„å¼‚å¸¸å¿…é¡»å¤„ç†ï¼Œæˆ–è€…å¿…é¡»æ•è·æˆ–è€…å¿…é¡»æŠ›å‡º</strong></p>
<p>â€‹     </p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[mysqlæ…¢æŸ¥è¯¢åˆ†æ]]></title>
      <url>http://zsr.github.io/2018/05/02/mysql%E6%85%A2%E6%9F%A5%E8%AF%A2%E5%88%86%E6%9E%90/</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[javaå­—èŠ‚ç å¢å¼ºæŠ€æœ¯]]></title>
      <url>http://zsr.github.io/2018/04/24/java%E5%AD%97%E8%8A%82%E7%A0%81%E5%A2%9E%E5%BC%BA%E6%8A%80%E6%9C%AF/</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[äº‹åŠ¡ç‰¹æ€§]]></title>
      <url>http://zsr.github.io/2018/04/18/%E4%BA%8B%E5%8A%A1%E7%89%B9%E6%80%A7/</url>
      <content type="html"><![CDATA[<h3 id="äº‹åŠ¡ç‰¹æ€§"><a href="#äº‹åŠ¡ç‰¹æ€§" class="headerlink" title="äº‹åŠ¡ç‰¹æ€§"></a>äº‹åŠ¡ç‰¹æ€§</h3><ul>
<li><strong>åŸå­æ€§ï¼š</strong>äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼›</li>
<li><strong>ä¸€è‡´æ€§ï¼š</strong>ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œä¹‹å‰å’Œæ‰§è¡Œä¹‹åéƒ½å¿…é¡»å¤„äºä¸€è‡´æ€§çŠ¶æ€ï¼›å‡è®¾ç”¨æˆ·Aå’Œç”¨æˆ·Bä¸¤è€…çš„é’±åŠ èµ·æ¥ä¸€å…±æ˜¯5000ï¼Œé‚£ä¹ˆä¸ç®¡Aå’ŒBä¹‹é—´å¦‚ä½•è½¬è´¦ï¼Œäº‹åŠ¡ç»“æŸåä¸¤ä¸ªç”¨æˆ·çš„é’±ç›¸åŠ èµ·æ¥åº”è¯¥è¿˜å¾—æ˜¯5000ï¼Œè¿™å°±æ˜¯äº‹åŠ¡çš„ä¸€è‡´æ€§</li>
<li><strong>éš”ç¦»æ€§ï¼š</strong>å¤šä¸ªäº‹åŠ¡å¹¶å‘ï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½æ„Ÿè§‰ä¸åˆ°ç³»ç»Ÿä¸­æœ‰å…¶ä»–çš„äº‹åŠ¡åœ¨æ‰§è¡Œï¼›</li>
<li><strong>æŒä¹…æ€§ï¼š</strong>ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦è¢«æäº¤äº†ï¼Œé‚£ä¹ˆå¯¹æ•°æ®åº“ä¸­çš„æ•°æ®çš„æ”¹å˜å°±æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³ä¾¿æ˜¯åœ¨æ•°æ®åº“ç³»ç»Ÿé‡åˆ°æ•…éšœçš„æƒ…å†µä¸‹ä¹Ÿä¸ä¼šä¸¢å¤±æäº¤äº‹åŠ¡çš„æ“ä½œï¼›</li>
</ul>
<h3 id="éš”ç¦»æ€§"><a href="#éš”ç¦»æ€§" class="headerlink" title="éš”ç¦»æ€§"></a>éš”ç¦»æ€§</h3><p>å¦‚æœæ²¡æœ‰äº‹åŠ¡çš„éš”ç¦»æ€§ï¼Œä¼šå‘ç”Ÿçš„å‡ ç§é—®é¢˜ï¼š</p>
<h4 id="è„è¯»"><a href="#è„è¯»" class="headerlink" title="è„è¯»"></a>è„è¯»</h4><p><strong>è„è¯»æ˜¯æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡å¤„ç†è¿‡ç¨‹é‡Œè¯»å–äº†å¦ä¸€ä¸ªæœªæäº¤çš„äº‹åŠ¡ä¸­çš„æ•°æ®ã€‚</strong></p>
<p>ã€€ã€€å½“ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨å¤šæ¬¡ä¿®æ”¹æŸä¸ªæ•°æ®ï¼Œè€Œåœ¨è¿™ä¸ªäº‹åŠ¡ä¸­è¿™å¤šæ¬¡çš„ä¿®æ”¹éƒ½è¿˜æœªæäº¤ï¼Œè¿™æ—¶ä¸€ä¸ªå¹¶å‘çš„äº‹åŠ¡æ¥è®¿é—®è¯¥æ•°æ®ï¼Œå°±ä¼šé€ æˆä¸¤ä¸ªäº‹åŠ¡å¾—åˆ°çš„æ•°æ®ä¸ä¸€è‡´ã€‚ä¾‹å¦‚ï¼šç”¨æˆ·Aå‘ç”¨æˆ·Bè½¬è´¦100å…ƒï¼Œå¯¹åº”SQLå‘½ä»¤å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">update account set money=money+100 where name=â€™Bâ€™; </div><div class="line">update account set money=money - 100 where name=â€™Aâ€™;</div></pre></td></tr></table></figure>
<p>ã€€ã€€å½“åªæ‰§è¡Œç¬¬ä¸€æ¡SQLæ—¶ï¼ŒAé€šçŸ¥BæŸ¥çœ‹è´¦æˆ·ï¼ŒBå‘ç°ç¡®å®é’±å·²åˆ°è´¦ï¼ˆæ­¤æ—¶å³å‘ç”Ÿäº†è„è¯»ï¼‰ï¼Œè€Œä¹‹åæ— è®ºç¬¬äºŒæ¡SQLæ˜¯å¦æ‰§è¡Œï¼Œåªè¦è¯¥äº‹åŠ¡ä¸æäº¤ï¼Œåˆ™æ‰€æœ‰æ“ä½œéƒ½å°†å›æ»šï¼Œé‚£ä¹ˆå½“Bä»¥åå†æ¬¡æŸ¥çœ‹è´¦æˆ·æ—¶å°±ä¼šå‘ç°é’±å…¶å®å¹¶æ²¡æœ‰è½¬ã€‚</p>
<h4 id="ä¸å¯é‡å¤è¯»"><a href="#ä¸å¯é‡å¤è¯»" class="headerlink" title="ä¸å¯é‡å¤è¯»"></a>ä¸å¯é‡å¤è¯»</h4><p><strong>ä¸å¯é‡å¤è¯»æ˜¯æŒ‡åœ¨å¯¹äºæ•°æ®åº“ä¸­çš„æŸä¸ªæ•°æ®ï¼Œä¸€ä¸ªäº‹åŠ¡èŒƒå›´å†…å¤šæ¬¡æŸ¥è¯¢å´è¿”å›äº†ä¸åŒçš„æ•°æ®å€¼ï¼Œè¿™æ˜¯ç”±äºåœ¨æŸ¥è¯¢ä¹‹é—´ï¼Œè¢«å¦ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹å¹¶æäº¤äº†ã€‚</strong></p>
<p>ã€€ã€€ä¾‹å¦‚äº‹åŠ¡T1åœ¨è¯»å–æŸä¸€æ•°æ®ï¼Œè€Œäº‹åŠ¡T2ç«‹é©¬ä¿®æ”¹äº†è¿™ä¸ªæ•°æ®å¹¶ä¸”æäº¤äº‹åŠ¡ç»™æ•°æ®åº“ï¼Œäº‹åŠ¡T1å†æ¬¡è¯»å–è¯¥æ•°æ®å°±å¾—åˆ°äº†ä¸åŒçš„ç»“æœï¼Œå‘é€äº†ä¸å¯é‡å¤è¯»ã€‚</p>
<p>ã€€ã€€ä¸å¯é‡å¤è¯»å’Œè„è¯»çš„åŒºåˆ«æ˜¯ï¼š<strong>è„è¯»æ˜¯æŸä¸€äº‹åŠ¡è¯»å–äº†å¦ä¸€ä¸ªäº‹åŠ¡æœªæäº¤çš„è„æ•°æ®ï¼Œè€Œä¸å¯é‡å¤è¯»åˆ™æ˜¯è¯»å–äº†å‰ä¸€äº‹åŠ¡å·²æäº¤çš„æ•°æ®ã€‚</strong></p>
<h4 id="å¹»è¯»"><a href="#å¹»è¯»" class="headerlink" title="å¹»è¯»"></a>å¹»è¯»</h4><p><strong>å¹»è¯»æ˜¯æŒ‡äº‹åŠ¡T1è¯»å–äº†æ»¡è¶³æŸæ¡ä»¶çš„ä¸€ä¸ªæ•°æ®é›†ï¼Œäº‹åŠ¡T2æ’å…¥äº†ä¸€è¡Œæˆ–è€…å¤šè¡Œæ•°æ®æ»¡è¶³äº†T1çš„é€‰æ‹©æ¡ä»¶ï¼Œå¯¼è‡´äº‹åŠ¡T1å†æ¬¡ä½¿ç”¨åŒæ ·çš„é€‰æ‹©æ¡ä»¶è¯»å–çš„æ—¶å€™ï¼Œå¾—åˆ°äº†æ¯”ç¬¬ä¸€æ¬¡è¯»å–æ›´å¤šçš„æ•°æ®é›†</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1ã€T1ï¼šselect * from users where name = &quot;A&quot;;</div><div class="line">2ã€T2ï¼šinsert into `users`(`id`, `name`) values (1, &apos;A&apos;);</div><div class="line">3ã€T1ï¼šselect * from users where name = &quot;A&quot;;</div></pre></td></tr></table></figure>
<p>ã€€ã€€å¹»è¯»å’Œä¸å¯é‡å¤è¯»éƒ½æ˜¯è¯»å–äº†å¦ä¸€æ¡å·²ç»æäº¤çš„äº‹åŠ¡ï¼Œæ‰€ä¸åŒçš„æ˜¯ä¸å¯é‡å¤è¯»æŸ¥è¯¢çš„éƒ½æ˜¯åŒä¸€ä¸ªæ•°æ®é¡¹ï¼Œè€Œå¹»è¯»é’ˆå¯¹çš„æ˜¯ä¸€æ‰¹æ•°æ®æ•´ä½“ã€‚</p>
<h4 id="éš”ç¦»çº§åˆ«"><a href="#éš”ç¦»çº§åˆ«" class="headerlink" title="éš”ç¦»çº§åˆ«"></a>éš”ç¦»çº§åˆ«</h4><p><code>MySQL</code>æ•°æ®åº“æä¾›äº†å››ç§éš”ç¦»çº§åˆ«ï¼š</p>
<table>
<thead>
<tr>
<th>éš”ç¦»çº§åˆ«</th>
<th>è„è¯»</th>
<th>ä¸å¯é‡å¤è¯»</th>
<th>å¹»è¯»</th>
</tr>
</thead>
<tbody>
<tr>
<td>æœªæäº¤è¯»(<code>Read uncommitted</code>)</td>
<td>å¯èƒ½</td>
<td>å¯èƒ½</td>
<td>å¯èƒ½</td>
</tr>
<tr>
<td>å·²æäº¤è¯»(<code>Read committed</code>)</td>
<td>ä¸å¯èƒ½</td>
<td>å¯èƒ½</td>
<td>å¯èƒ½</td>
</tr>
<tr>
<td>å¯é‡å¤è¯»(<code>Repeatable read</code>)</td>
<td>ä¸å¯èƒ½</td>
<td>ä¸å¯èƒ½</td>
<td>å¯èƒ½</td>
</tr>
<tr>
<td>å¯ä¸²è¡ŒåŒ–(<code>Serializable</code>)</td>
<td>ä¸å¯èƒ½</td>
<td>ä¸å¯èƒ½</td>
<td>ä¸å¯èƒ½</td>
</tr>
</tbody>
</table>
<p><strong><code>InnoDB</code>é»˜è®¤çº§åˆ«ï¼šå¯é‡å¤è¯»(<code>Repeatable read</code>)ï¼Œä¸ºä»€ä¹ˆèƒ½é¿å…å¹»è¯»ï¼Œå¦ä¸€ç¯‡<code>mysqlé”</code>æœ‰è¯´æ˜(é—´éš™é”)</strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Springäº‹åŠ¡ç®¡ç†]]></title>
      <url>http://zsr.github.io/2018/04/17/Spring%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86/</url>
      <content type="html"><![CDATA[<h3 id="Springäº‹åŠ¡ç®¡ç†æ¦‚è¿°"><a href="#Springäº‹åŠ¡ç®¡ç†æ¦‚è¿°" class="headerlink" title="Springäº‹åŠ¡ç®¡ç†æ¦‚è¿°"></a>Springäº‹åŠ¡ç®¡ç†æ¦‚è¿°</h3><h4 id="äº‹åŠ¡éš”ç¦»çº§åˆ«"><a href="#äº‹åŠ¡éš”ç¦»çº§åˆ«" class="headerlink" title="äº‹åŠ¡éš”ç¦»çº§åˆ«"></a>äº‹åŠ¡éš”ç¦»çº§åˆ«</h4><p>éš”ç¦»çº§åˆ«æ˜¯æŒ‡è‹¥å¹²ä¸ªå¹¶å‘çš„äº‹åŠ¡ä¹‹é—´çš„éš”ç¦»ç¨‹åº¦ã€‚<code>TransactionDefinition</code> æ¥å£ä¸­å®šä¹‰äº†äº”ä¸ªè¡¨ç¤ºéš”ç¦»çº§åˆ«çš„å¸¸é‡ï¼š</p>
<ul>
<li><code>TransactionDefinition.ISOLATION_DEFAULT</code>ï¼šè¿™æ˜¯é»˜è®¤å€¼ï¼Œè¡¨ç¤ºä½¿ç”¨åº•å±‚æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚å¯¹å¤§éƒ¨åˆ†æ•°æ®åº“è€Œè¨€ï¼Œé€šå¸¸è¿™å€¼å°±æ˜¯<code>TransactionDefinition.ISOLATION_READ_COMMITTED</code>ï¼Œ<code>MySQL InnoDB</code> å­˜å‚¨å¼•æ“éš”ç¦»çº§åˆ«ä¸º <code>Repeatable Read</code>ã€‚</li>
<li><code>TransactionDefinition.ISOLATION_READ_UNCOMMITTED</code>ï¼šè¯¥éš”ç¦»çº§åˆ«è¡¨ç¤ºä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¯»å–å¦ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹ä½†è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ã€‚è¯¥çº§åˆ«ä¸èƒ½é˜²æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œå› æ­¤å¾ˆå°‘ä½¿ç”¨è¯¥éš”ç¦»çº§åˆ«ã€‚</li>
<li><code>TransactionDefinition.ISOLATION_READ_COMMITTED</code>ï¼šè¯¥éš”ç¦»çº§åˆ«è¡¨ç¤ºä¸€ä¸ªäº‹åŠ¡åªèƒ½è¯»å–å¦ä¸€ä¸ªäº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ã€‚è¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ï¼Œè¿™ä¹Ÿæ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹çš„æ¨èå€¼ã€‚</li>
<li><code>TransactionDefinition.ISOLATION_REPEATABLE_READ</code>ï¼šè¯¥éš”ç¦»çº§åˆ«è¡¨ç¤ºä¸€ä¸ªäº‹åŠ¡åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­å¯ä»¥å¤šæ¬¡é‡å¤æ‰§è¡ŒæŸä¸ªæŸ¥è¯¢ï¼Œå¹¶ä¸”æ¯æ¬¡è¿”å›çš„è®°å½•éƒ½ç›¸åŒã€‚å³ä½¿åœ¨å¤šæ¬¡æŸ¥è¯¢ä¹‹é—´æœ‰æ–°å¢çš„æ•°æ®æ»¡è¶³è¯¥æŸ¥è¯¢ï¼Œè¿™äº›æ–°å¢çš„è®°å½•ä¹Ÿä¼šè¢«å¿½ç•¥ã€‚è¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ã€‚</li>
<li><code>TransactionDefinition.ISOLATION_SERIALIZABLE</code>ï¼šæ‰€æœ‰çš„äº‹åŠ¡ä¾æ¬¡é€ä¸ªæ‰§è¡Œï¼Œè¿™æ ·äº‹åŠ¡ä¹‹é—´å°±å®Œå…¨ä¸å¯èƒ½äº§ç”Ÿå¹²æ‰°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»ã€‚ä½†æ˜¯è¿™å°†ä¸¥é‡å½±å“ç¨‹åºçš„æ€§èƒ½ã€‚é€šå¸¸æƒ…å†µä¸‹ä¹Ÿä¸ä¼šç”¨åˆ°è¯¥çº§åˆ«ã€‚</li>
</ul>
<h4 id="äº‹åŠ¡ä¼ æ’­è¡Œä¸º"><a href="#äº‹åŠ¡ä¼ æ’­è¡Œä¸º" class="headerlink" title="äº‹åŠ¡ä¼ æ’­è¡Œä¸º"></a>äº‹åŠ¡ä¼ æ’­è¡Œä¸º</h4><p>äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºæ˜¯æŒ‡ï¼Œå¦‚æœåœ¨å¼€å§‹å½“å‰äº‹åŠ¡ä¹‹å‰ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸Šä¸‹æ–‡å·²ç»å­˜åœ¨ï¼Œæ­¤æ—¶æœ‰è‹¥å¹²é€‰é¡¹å¯ä»¥æŒ‡å®šä¸€ä¸ªäº‹åŠ¡æ€§æ–¹æ³•çš„æ‰§è¡Œè¡Œä¸ºã€‚åœ¨<code>TransactionDefinition</code>å®šä¹‰ä¸­åŒ…æ‹¬äº†å¦‚ä¸‹å‡ ä¸ªè¡¨ç¤ºä¼ æ’­è¡Œä¸ºçš„å¸¸é‡</p>
<ul>
<li><code>TransactionDefinition.PROPAGATION_REQUIRED</code>ï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚</li>
</ul>
<p><img src="https://img-blog.csdn.net/20140420132157531?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaXRfd2FuZ3hpYW5ncGFu/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="img"></p>
<ul>
<li><code>TransactionDefinition.PROPAGATION_REQUIRES_NEW</code>ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</li>
<li><code>TransactionDefinition.PROPAGATION_SUPPORTS</code>ï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™ä»¥éäº‹åŠ¡çš„æ–¹å¼ç»§ç»­è¿è¡Œã€‚</li>
<li><code>TransactionDefinition.PROPAGATION_NOT_SUPPORTED</code>ï¼šä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</li>
<li><code>TransactionDefinition.PROPAGATION_NEVER</code>ï¼šä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li><code>TransactionDefinition.PROPAGATION_MANDATORY</code>ï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li><code>TransactionDefinition.PROPAGATION_NESTED</code>ï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªäº‹åŠ¡ä½œä¸ºå½“å‰äº‹åŠ¡çš„åµŒå¥—äº‹åŠ¡æ¥è¿è¡Œï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™è¯¥å–å€¼ç­‰ä»·äº<code>TransactionDefinition.PROPAGATION_REQUIRED</code>ã€‚</li>
</ul>
<h3 id="Springäº‹åŠ¡ä½¿ç”¨æ–¹å¼"><a href="#Springäº‹åŠ¡ä½¿ç”¨æ–¹å¼" class="headerlink" title="Springäº‹åŠ¡ä½¿ç”¨æ–¹å¼"></a>Springäº‹åŠ¡ä½¿ç”¨æ–¹å¼</h3><p><code>Spring</code>æä¾›äº†å¯¹<code>ç¼–ç å¼</code>å’Œ<code>å£°æ˜å¼</code>äº‹åŠ¡ç®¡ç†çš„æ”¯æŒï¼Œ<code>Spring</code>å¯¹äº‹åŠ¡ç®¡ç†æ˜¯é€šè¿‡äº‹åŠ¡ç®¡ç†å™¨æ¥å®ç°çš„</p>
<ul>
<li><strong>ç¼–ç¨‹å¼äº‹åŠ¡ï¼š</strong>æŒ‡çš„æ˜¯é€šè¿‡ç¼–ç æ–¹å¼å®ç°äº‹åŠ¡ï¼Œå³ç±»ä¼¼äº<code>JDBC</code>ç¼–ç¨‹å®ç°äº‹åŠ¡ç®¡ç†ã€‚ä½¿ç”¨<code>TransactionTemplate</code>æˆ–è€…ç›´æ¥ä½¿ç”¨åº•å±‚çš„<code>PlatformTransactionManager</code>åšäº‹åŠ¡ç®¡ç†ã€‚</li>
<li><strong>å£°æ˜å¼äº‹åŠ¡ï¼š</strong>å…¶æœ¬è´¨æ˜¯å¯¹æ–¹æ³•å‰åè¿›è¡Œæ‹¦æˆª(<code>AOP</code>)ï¼Œç„¶ååœ¨ç›®æ ‡æ–¹æ³•å¼€å§‹ä¹‹å‰åˆ›å»ºæˆ–è€…åŠ å…¥ä¸€ä¸ªäº‹åŠ¡ï¼Œåœ¨æ‰§è¡Œå®Œç›®æ ‡æ–¹æ³•ä¹‹åæ ¹æ®æ‰§è¡Œæƒ…å†µæäº¤æˆ–è€…å›æ»šäº‹åŠ¡ã€‚</li>
</ul>
<p><strong>å£°æ˜å¼äº‹åŠ¡ä¼˜ç‚¹ï¼šä¸éœ€è¦é€šè¿‡ç¼–ç¨‹çš„æ–¹å¼ç®¡ç†äº‹åŠ¡ï¼Œè¿™æ ·å°±ä¸éœ€è¦åœ¨ä¸šåŠ¡é€»è¾‘ä»£ç ä¸­æºæ‚äº‹åŠ¡ç®¡ç†çš„ä»£ç ï¼Œ</strong>åªéœ€åœ¨é…ç½®æ–‡ä»¶ä¸­åšç›¸å…³çš„äº‹åŠ¡è§„åˆ™å£°æ˜(æˆ–é€šè¿‡åŸºäº<code>@Transactional</code>æ³¨è§£çš„æ–¹å¼)ï¼Œä¾¿å¯ä»¥å°†äº‹åŠ¡è§„åˆ™åº”ç”¨åˆ°ä¸šåŠ¡é€»è¾‘ä¸­;</p>
<p><strong>å£°æ˜å¼äº‹åŠ¡ç¼ºç‚¹ï¼šå£°æ˜å¼çš„æœ€ç»†ç²’åº¦åªèƒ½ä½œç”¨åˆ°æ–¹æ³•çº§åˆ«ï¼Œæ— æ³•åšåˆ°åƒç¼–ç¨‹å¼äº‹åŠ¡é‚£æ ·å¯ä»¥ä½œç”¨åˆ°ä»£ç å—çº§åˆ«</strong></p>
<table>
<thead>
<tr>
<th>äº‹åŠ¡ç®¡ç†å™¨(<code>org.springframework.*</code>)</th>
<th>ä½¿ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DataSourceTransactionManager</code></td>
<td>æä¾›å¯¹å•ä¸ª<code>javax.sql.DataSource</code>äº‹åŠ¡ç®¡ç†ï¼Œç”¨äºSpring JDBCæŠ½è±¡æ¡†æ¶ã€iBATISæˆ–MyBatisæ¡†æ¶çš„äº‹åŠ¡ç®¡ç†ï¼›</td>
</tr>
<tr>
<td><code>JpaTransactionManager</code></td>
<td>æä¾›å¯¹å•ä¸ª<code>javax.persistence.EntityManagerFactory</code>äº‹åŠ¡æ”¯æŒï¼Œç”¨äºé›†æˆJPAå®ç°æ¡†æ¶æ—¶çš„äº‹åŠ¡ç®¡ç†ï¼›</td>
</tr>
<tr>
<td><code>JtaTransactionManager</code></td>
<td>æä¾›å¯¹åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†çš„æ”¯æŒï¼Œå¹¶å°†äº‹åŠ¡ç®¡ç†å§”æ‰˜ç»™Java EEåº”ç”¨æœåŠ¡å™¨äº‹åŠ¡ç®¡ç†å™¨ï¼›</td>
</tr>
</tbody>
</table>
<h4 id="ç¼–ç¨‹å¼äº‹åŠ¡"><a href="#ç¼–ç¨‹å¼äº‹åŠ¡" class="headerlink" title="ç¼–ç¨‹å¼äº‹åŠ¡"></a>ç¼–ç¨‹å¼äº‹åŠ¡</h4><p><code>Spring</code>æä¾›äº†çº¿ç¨‹å®‰å…¨çš„<code>TransactionTemplate</code>æ¨¡æ¿ç±»æ¥å¤„ç†ä¸å˜çš„äº‹åŠ¡ç®¡ç†é€»è¾‘ï¼Œå°†å˜åŒ–çš„éƒ¨åˆ†æŠ½è±¡ä¸ºå›è°ƒæ¥å£<code>TransactionCallback</code>ä¾›ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®è®¿é—®é€»è¾‘</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- æ•°æ®æºé…ç½® --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"#&#123;jdbc['jdbc.driverClassName']&#125;"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- é…ç½®äº‹åŠ¡ç®¡ç†å™¨ --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!--äº‹åŠ¡æ¨¡æ¿ --&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.transaction.support.TransactionTemplate"</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"transactionManager"</span> <span class="attr">ref</span>=<span class="string">"transactionManager"</span>/&gt;</span>  </div><div class="line">    <span class="comment">&lt;!--ISOLATION_DEFAULT è¡¨ç¤ºç”±ä½¿ç”¨çš„æ•°æ®åº“å†³å®š  --&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"isolationLevelName"</span> <span class="attr">value</span>=<span class="string">"ISOLATION_DEFAULT"</span>/&gt;</span>  </div><div class="line">    <span class="comment">&lt;!-- äº‹åŠ¡ä¼ æ’­æ–¹å¼ --&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"propagationBehaviorName"</span> <span class="attr">value</span>=<span class="string">"PROPAGATION_REQUIRED"</span> /&gt;</span>  </div><div class="line">    <span class="comment">&lt;!-- &lt;property name="timeout" value="30"/&gt; --&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceImpl</span> </span>&#123;</div><div class="line">  </div><div class="line">	<span class="meta">@autowried</span></div><div class="line">	<span class="keyword">private</span> TransactionTemplate template;</div><div class="line">  </div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addElement</span><span class="params">(<span class="keyword">final</span> Element ele)</span> </span>&#123;</div><div class="line">		template.execute(<span class="keyword">new</span> TransactionCallbackWithoutResult() &#123;</div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doInTransactionWithoutResult</span><span class="params">(TransactionStatus status)</span></span>&#123;</div><div class="line">                    <span class="comment">// æ•°æ®åº“æ“ä½œ1</span></div><div class="line">                    <span class="comment">// æ•°æ®åº“æ“ä½œ2</span></div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ ¹æ®é»˜è®¤è§„åˆ™ï¼Œå¦‚æœåœ¨æ‰§è¡Œå›è°ƒæ–¹æ³•çš„è¿‡ç¨‹ä¸­æŠ›å‡ºäº†æœªæ£€æŸ¥å¼‚å¸¸(ç»§æ‰¿è‡ª<code>RuntimeException</code>çš„å¼‚å¸¸)ï¼Œæˆ–è€…æ˜¾å¼è°ƒç”¨äº†<code>TransacationStatus.setRollbackOnly()</code> æ–¹æ³•ï¼Œåˆ™å›æ»šäº‹åŠ¡ï¼›å¦‚æœäº‹åŠ¡æ‰§è¡Œå®Œæˆæˆ–è€…æŠ›å‡ºäº† checked ç±»å‹çš„å¼‚å¸¸ï¼Œåˆ™æäº¤äº‹åŠ¡ã€‚</p>
<p>ä¸ç®¡æ˜¯ä½¿ç”¨å“ªç§æ–¹å¼ï¼Œ<strong>æ•°æ®æº</strong>ã€<strong>äº‹åŠ¡ç®¡ç†å™¨</strong>éƒ½æ˜¯å¿…é¡»çš„ï¼Œä¸€èˆ¬é€šè¿‡XMLçš„Beané…ç½®</p>
<h4 id="å£°æ˜å¼äº‹åŠ¡-å¸¸ç”¨"><a href="#å£°æ˜å¼äº‹åŠ¡-å¸¸ç”¨" class="headerlink" title="å£°æ˜å¼äº‹åŠ¡(å¸¸ç”¨)"></a>å£°æ˜å¼äº‹åŠ¡(å¸¸ç”¨)</h4><p>å£°æ˜å¼äº‹åŠ¡å¯ä»¥åˆ†ä¸º2ç§ï¼š<strong>åŸºäºXMLé…ç½®çš„äº‹åŠ¡ç®¡ç†</strong>æˆ–<strong>åŸºäºæ³¨è§£çš„äº‹åŠ¡ç®¡ç†</strong>ï¼Œéƒ½æ˜¯åŸºäºAOPå®ç°</p>
<h5 id="åŸºäºXMLé…ç½®çš„äº‹åŠ¡ç®¡ç†"><a href="#åŸºäºXMLé…ç½®çš„äº‹åŠ¡ç®¡ç†" class="headerlink" title="åŸºäºXMLé…ç½®çš„äº‹åŠ¡ç®¡ç†"></a>åŸºäºXMLé…ç½®çš„äº‹åŠ¡ç®¡ç†</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">&lt;!-- æ•°æ®æºé…ç½® --&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"#&#123;jdbc['jdbc.driverClassName']&#125;"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">   <span class="comment">&lt;!-- é…ç½®äº‹åŠ¡ç®¡ç†å™¨ --&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">   <span class="comment">&lt;!-- é…ç½®äº‹åŠ¡å±æ€§ï¼šä¼ æ’­è¡Œä¸ºã€éš”ç¦»çº§åˆ«ã€åªè¯»ã€è¶…æ—¶æ—¶é—´å›æ»š--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"txManager"</span>&gt;</span></div><div class="line">   	<span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></div><div class="line">   		<span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"create*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> <span class="attr">timeout</span>=<span class="string">"300"</span> <span class="attr">rollback-</span>	<span class="attr">for</span>=<span class="string">"java.lang.Exception"</span> /&gt;</span></div><div class="line"> 		<span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></div><div class="line"></div><div class="line">   <span class="comment">&lt;!-- é…ç½®äº‹åŠ¡åˆ‡å…¥ç‚¹ã€‚å¹¶æŠŠäº‹åŠ¡åˆ‡å…¥ç‚¹ä¸äº‹åŠ¡å±æ€§å…³è”èµ·æ¥ --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></div><div class="line"> 		<span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"txPointcut"</span> <span class="attr">expression</span>=<span class="string">"execution(* com.zsr.test.transaction.service.*ServiceImpl.*(..))"</span> /&gt;</span></div><div class="line"> 		<span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">pointcut-ref</span>=<span class="string">"txPointcut"</span> <span class="attr">advice-ref</span>=<span class="string">"txAdvice"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></div></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceImpl</span> <span class="keyword">implements</span> <span class="title">IService</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">createTicket</span><span class="params">(String isbn)</span> </span>&#123;</div><div class="line">		<span class="comment">// do something</span></div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h5 id="åŸºäºæ³¨è§£çš„äº‹åŠ¡ç®¡ç†"><a href="#åŸºäºæ³¨è§£çš„äº‹åŠ¡ç®¡ç†" class="headerlink" title="åŸºäºæ³¨è§£çš„äº‹åŠ¡ç®¡ç†"></a>åŸºäºæ³¨è§£çš„äº‹åŠ¡ç®¡ç†</h5><p>é€šè¿‡<code>@Transactional</code>å¯¹éœ€è¦äº‹åŠ¡å¢å¼ºçš„Beanæ¥å£ã€å®ç°ç±»æˆ–æ–¹æ³•è¿›è¡Œæ ‡æ³¨ï¼Œåœ¨å®¹å™¨ä¸­é…ç½®ä»¥å¯ç”¨åŸºäºæ³¨è§£çš„å£°æ˜å¼äº‹åŠ¡ã€‚ã€‚æ³¨è§£æ‰€æä¾›çš„äº‹åŠ¡å±æ€§ä¿¡æ¯ä¸XMLé…ç½®ä¸­çš„äº‹åŠ¡ä¿¡æ¯åŸºæœ¬ä¸€è‡´ï¼Œåªä¸è¿‡æ˜¯å¦ä¸€ç§å½¢å¼çš„å…ƒæ•°æ®è€Œå·²</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- æ•°æ®æºé…ç½® --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"#&#123;jdbc['jdbc.driverClassName']&#125;"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- é…ç½®äº‹åŠ¡ç®¡ç†å™¨ --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">   <span class="comment">&lt;!-- å¼€å¯æ³¨è§£æ–¹å¼é…ç½®äº‹ç‰© --&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼šå½“<code>&lt;tx:annotation-driven/&gt;</code>æ ‡ç­¾åœ¨ä¸æŒ‡å®š<code>transaction-manager</code>å±æ€§çš„æ—¶å€™ï¼Œä¼šé»˜è®¤å¯»æ‰¾idå›ºå®šåä¸º<code>transactionManager</code>çš„beanä½œä¸ºäº‹åŠ¡ç®¡ç†å™¨ï¼Œå¦‚æœæ²¡æœ‰idä¸º<code>transactionManager</code>çš„beanå¹¶ä¸”åœ¨ä½¿ç”¨<code>@Transactional</code>æ³¨è§£æ—¶ä¹Ÿæ²¡æœ‰æŒ‡å®švalueï¼ˆäº‹åŠ¡ç®¡ç†å™¨ï¼‰ï¼Œç¨‹åºå°±ä¼šæŠ¥é”™</strong></p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Transactional</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceImpl</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> DaoA daoA;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addElement</span><span class="params">(<span class="keyword">final</span> Element ele)</span> </span>&#123;</div><div class="line">		...</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>@Transactional</code>å¯ä»¥ä½œç”¨äºæ¥å£ã€æ¥å£æ–¹æ³•ã€ç±»ä»¥åŠç±»æ–¹æ³•ä¸Šã€‚å½“ä½œç”¨äºç±»ä¸Šæ—¶ï¼Œè¯¥ç±»çš„æ‰€æœ‰ <code>public</code> æ–¹æ³•å°†éƒ½å…·æœ‰è¯¥ç±»å‹çš„äº‹åŠ¡å±æ€§ï¼ŒåŒæ—¶ï¼Œä¹Ÿå¯ä»¥åœ¨æ–¹æ³•çº§åˆ«ä½¿ç”¨è¯¥æ ‡æ³¨æ¥è¦†ç›–ç±»çº§åˆ«çš„å®šä¹‰</p>
<h4 id="Spring-Transactionalçš„æ³¨æ„äº‹é¡¹"><a href="#Spring-Transactionalçš„æ³¨æ„äº‹é¡¹" class="headerlink" title="Spring @Transactionalçš„æ³¨æ„äº‹é¡¹"></a><code>Spring @Transactional</code>çš„æ³¨æ„äº‹é¡¹</h4><ul>
<li><code>@Transactional</code> æ³¨è§£åªè¢«åº”ç”¨åˆ° <code>public</code> å¯è§åº¦çš„æ–¹æ³•ä¸Šã€‚ å¦‚æœä½ åœ¨ <code>protected</code>ã€<code>private</code> æˆ–è€… <code>package-visible</code> çš„æ–¹æ³•ä¸Šä½¿ç”¨ <code>@Transactional</code> æ³¨è§£ï¼Œå®ƒä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯è¿™ä¸ªè¢«æ³¨è§£çš„æ–¹æ³•å°†ä¸ä¼šå±•ç¤ºå·²é…ç½®çš„äº‹åŠ¡è®¾ç½®ã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ï¼ˆ1ï¼‰å¯¹äºåŸºäºæ¥å£åŠ¨æ€ä»£ç†çš„AOPäº‹åŠ¡å¢å¼ºæ¥è¯´ï¼Œç”±äºæ¥å£çš„æ–¹æ³•æ˜¯publicçš„ï¼Œè¿™å°±è¦æ±‚å®ç°ç±»çš„å®ç°æ–¹æ³•å¿…é¡»æ˜¯publicçš„ï¼ˆä¸èƒ½æ˜¯protectedï¼Œprivateç­‰ï¼‰ï¼ŒåŒæ—¶ä¸èƒ½ä½¿ç”¨staticçš„ä¿®é¥°ç¬¦ã€‚æ‰€ä»¥ï¼Œå¯ä»¥å®æ–½æ¥å£åŠ¨æ€ä»£ç†çš„æ–¹æ³•åªèƒ½æ˜¯ä½¿ç”¨â€œpublicâ€æˆ–â€œpublic finalâ€ä¿®é¥°ç¬¦çš„æ–¹æ³•ï¼Œå…¶å®ƒæ–¹æ³•ä¸å¯èƒ½è¢«åŠ¨æ€ä»£ç†ï¼Œç›¸åº”çš„ä¹Ÿå°±ä¸èƒ½å®æ–½AOPå¢å¼ºï¼Œä¹Ÿå³ä¸èƒ½è¿›è¡ŒSpringäº‹åŠ¡å¢å¼ºã€‚</div><div class="line"></div><div class="line">ï¼ˆ2ï¼‰åŸºäºCGLibå­—èŠ‚ç åŠ¨æ€ä»£ç†çš„æ–¹æ¡ˆæ˜¯é€šè¿‡æ‰©å±•è¢«å¢å¼ºç±»ï¼ŒåŠ¨æ€åˆ›å»ºå­ç±»çš„æ–¹å¼è¿›è¡ŒAOPå¢å¼ºæ¤å…¥çš„ã€‚ç”±äºä½¿ç”¨final,static,privateä¿®é¥°ç¬¦çš„æ–¹æ³•éƒ½ä¸èƒ½è¢«å­ç±»è¦†ç›–ï¼Œç›¸åº”çš„ï¼Œè¿™äº›æ–¹æ³•å°†ä¸èƒ½è¢«å®æ–½çš„AOPå¢å¼ºã€‚</div></pre></td></tr></table></figure>
<ul>
<li>Springå›¢é˜Ÿçš„å»ºè®®åœ¨å…·ä½“çš„ç±»ï¼ˆæˆ–ç±»çš„æ–¹æ³•ï¼‰ä¸Šä½¿ç”¨ <code>@Transactional</code> æ³¨è§£ï¼Œè€Œä¸è¦ä½¿ç”¨åœ¨ç±»æ‰€è¦å®ç°çš„ä»»ä½•æ¥å£ä¸Šã€‚å½“ç„¶ä¹Ÿå¯ä»¥åœ¨æ¥å£ä¸Šä½¿ç”¨ <code>@Transactional</code> æ³¨è§£ï¼Œä½†æ˜¯è¿™å°†åªèƒ½å½“ä½ è®¾ç½®äº†åŸºäºæ¥å£çš„ä»£ç†æ—¶å®ƒæ‰ç”Ÿæ•ˆã€‚å› ä¸ºæ³¨è§£æ˜¯ä¸èƒ½ç»§æ‰¿çš„ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœä½ æ­£åœ¨ä½¿ç”¨åŸºäºç±»çš„ä»£ç†æ—¶(cglib)ï¼Œé‚£ä¹ˆäº‹åŠ¡çš„è®¾ç½®å°†ä¸èƒ½è¢«åŸºäºç±»çš„ä»£ç†æ‰€è¯†åˆ«ï¼Œè€Œä¸”å¯¹è±¡ä¹Ÿå°†ä¸ä¼šè¢«äº‹åŠ¡ä»£ç†æ‰€åŒ…è£…ã€‚å› æ­¤ï¼Œå»ºè®®å¹¶ä¸”åœ¨å…·ä½“çš„ç±»ç«æ–¹æ³•ä¸Šä½¿ç”¨ <code>@Transactional</code> æ³¨è§£ã€‚</li>
<li><code>@Transactional</code> çš„äº‹åŠ¡å¼€å¯ï¼Œåœ¨åŒä¸€ä¸ªç±»ä¸­ä¸€ä¸ªæ–¹æ³•è°ƒç”¨å¦ä¸€ä¸ªæœ‰äº‹åŠ¡çš„æ–¹æ³•ï¼Œäº‹åŠ¡æ˜¯ä¸ä¼šèµ·ä½œç”¨çš„ã€‚</li>
<li><code>@Transactional</code> æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•ä¸­ä¸è¦å‡ºç°ç½‘ç»œè°ƒç”¨ã€æ¯”è¾ƒè€—æ—¶çš„å¤„ç†ç¨‹åºï¼Œå› ä¸ºï¼Œäº‹åŠ¡ä¸­æ•°æ®åº“è¿æ¥æ˜¯ä¸ä¼šé‡Šæ”¾çš„ï¼Œå¦‚æœæ¯ä¸ªäº‹åŠ¡çš„å¤„ç†æ—¶é—´éƒ½éå¸¸é•¿ï¼Œé‚£ä¹ˆå®è´µçš„æ•°æ®åº“è¿æ¥èµ„æºå°†å¾ˆå¿«è¢«è€—å°½ã€‚</li>
<li><code>Spring</code>ä½¿ç”¨å£°æ˜å¼äº‹åŠ¡å¤„ç†ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ“ä½œæ–¹æ³•ä¸­å‘ç”Ÿäº†<code>unchecked</code>å¼‚å¸¸ï¼Œæ‰€æœ‰çš„æ“ä½œå°†<code>rollback</code>ï¼›å¦‚æœå‘ç”Ÿçš„å¼‚å¸¸æ˜¯<code>checked</code>å¼‚å¸¸ï¼Œé»˜è®¤æƒ…å†µä¸‹æ•°æ®åº“æ“ä½œè¿˜æ˜¯ä¼šæäº¤çš„ã€‚</li>
</ul>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://www.ibm.com/developerworks/cn/education/opensource/os-cn-spring-trans/index.html" target="_blank" rel="external">å…¨é¢åˆ†æ Spring çš„ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†åŠå£°æ˜å¼äº‹åŠ¡ç®¡ç†</a></p>
<p><a href="https://blog.csdn.net/lovesomnus/article/details/52619702" target="_blank" rel="external">Springçš„å£°æ˜å¼äº‹åŠ¡å’Œç¼–ç¨‹å¼äº‹åŠ¡è¯¦è§£</a></p>
<p><a href="http://www.yangbing.club/2017/03/22/spring-transaction-management/" target="_blank" rel="external">springäº‹åŠ¡ç®¡ç†</a></p>
<p><a href="http://tech.lede.com/2017/02/06/rd/server/SpringTransactional/" target="_blank" rel="external">Spring @TransactionalåŸç†åŠä½¿ç”¨</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[jdkåŠ¨æ€ä»£ç†åˆ†æ]]></title>
      <url>http://zsr.github.io/2018/04/08/jdk%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ç–‘é—®ï¼šJDKçš„åŠ¨æ€ä»£ç†ä¸ºä»€ä¹ˆä¸æ”¯æŒå¯¹ç±»çš„ä»£ç†ï¼Œåªæ”¯æŒæ¥å£çš„ä»£ç†ï¼Ÿ</div></pre></td></tr></table></figure>
<h3 id="jdkåŠ¨æ€ä»£ç†å®ä¾‹"><a href="#jdkåŠ¨æ€ä»£ç†å®ä¾‹" class="headerlink" title="jdkåŠ¨æ€ä»£ç†å®ä¾‹"></a><code>jdk</code>åŠ¨æ€ä»£ç†å®ä¾‹</h3><ul>
<li>æœåŠ¡æ¥å£</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.proxy;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Hello</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(String someThing)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ¥å£å®ç°ç±»</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.proxy;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloImpl</span> <span class="keyword">implements</span> <span class="title">Hello</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(String someThing)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"Hello: "</span> + someThing);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨å¤„ç†ç±»</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.proxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloInvocationHandle</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Object target;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HelloInvocationHandle</span><span class="params">(Object target)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.target = target;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    System.out.println(<span class="string">"Before invocation"</span>);</div><div class="line">    Object ret = method.invoke(target, args);</div><div class="line">    System.out.println(<span class="string">"after invocation"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>è¿è¡Œæµ‹è¯•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.proxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloProxyTest</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"></div><div class="line">    Hello hello = <span class="keyword">new</span> HelloImpl();</div><div class="line">    HelloInvocationHandle helloInvocationHandler = <span class="keyword">new</span> HelloInvocationHandle(hello);</div><div class="line"></div><div class="line">    <span class="comment">// é€šè¿‡Proxy.newProxyInstanceç”Ÿæˆä»£ç†å¯¹è±¡</span></div><div class="line">    Hello helloProxy = (Hello) Proxy.newProxyInstance(Hello.class.getClassLoader(), hello.getClass().getInterfaces(),</div><div class="line">            helloInvocationHandler);</div><div class="line"></div><div class="line">    <span class="comment">// è°ƒç”¨sayæ–¹æ³•</span></div><div class="line">    helloProxy.say(<span class="string">"test"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Before invocation</div><div class="line">Hello: test</div><div class="line">after invocation</div></pre></td></tr></table></figure>
<h3 id="Proxy-newProxyInstanceåˆ†æ"><a href="#Proxy-newProxyInstanceåˆ†æ" class="headerlink" title="Proxy.newProxyInstanceåˆ†æ"></a><code>Proxy.newProxyInstance</code>åˆ†æ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader,</span></span></div><div class="line">                                          Class&lt;?&gt;[] interfaces,</div><div class="line">                                          InvocationHandler h)</div><div class="line">        <span class="keyword">throws</span> IllegalArgumentException</div><div class="line">    &#123;</div><div class="line">        Objects.requireNonNull(h);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Class&lt;?&gt;[] intfs = interfaces.clone();</div><div class="line">        <span class="keyword">final</span> SecurityManager sm = System.getSecurityManager();</div><div class="line">        <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</div><div class="line">            checkProxyAccess(Reflection.getCallerClass(), loader, intfs);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * åŠ¨æ€ç”ŸæˆClassçš„åœ°æ–¹ï¼Œé‡ç‚¹æ˜¯çœ‹è¿™é‡Œé¢çš„æ–¹æ³•</div><div class="line">         */</div><div class="line">        Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * è·å–ä»£ç†ç±»çš„å®ä¾‹  </div><div class="line">         */</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</div><div class="line">                checkNewProxyPermission(Reflection.getCallerClass(), cl);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);</div><div class="line">            <span class="keyword">final</span> InvocationHandler ih = h;</div><div class="line">            <span class="keyword">if</span> (!Modifier.isPublic(cl.getModifiers())) &#123;</div><div class="line">                AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</div><div class="line">                    <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        cons.setAccessible(<span class="keyword">true</span>);</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> cons.newInstance(<span class="keyword">new</span> Object[]&#123;h&#125;);</div><div class="line">        &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ç”Ÿæˆä»£ç†ç±»<code>Class</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> Class&lt;?&gt; getProxyClass0(ClassLoader loader,</div><div class="line">                                           Class&lt;?&gt;... interfaces) &#123;</div><div class="line">        <span class="keyword">if</span> (interfaces.length &gt; <span class="number">65535</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"interface limit exceeded"</span>);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// JDKå¯¹ä»£ç†è¿›è¡Œäº†ç¼“å­˜ï¼Œå¦‚æœå·²ç»å­˜åœ¨ç›¸åº”çš„ä»£ç†ç±»ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œ</span></div><div class="line">        <span class="comment">// å¦åˆ™æ‰ä¼šé€šè¿‡ProxyClassFactoryæ¥åˆ›å»ºä»£ç†  </span></div><div class="line">        <span class="keyword">return</span> proxyClassCache.get(loader, interfaces);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> WeakCache&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;</div><div class="line">        proxyClassCache = <span class="keyword">new</span> WeakCache&lt;&gt;(<span class="keyword">new</span> KeyFactory(), <span class="keyword">new</span> ProxyClassFactory());</div></pre></td></tr></table></figure>
<ul>
<li>ä»£ç†ç±»<code>Class</code>å·¥å‚</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">private static final class ProxyClassFactory</div><div class="line">        implements BiFunction&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;</div><div class="line">    &#123;</div><div class="line">        // æ‰€æœ‰ä»£ç†ç±»åå­—çš„å‰ç¼€</div><div class="line">        private static final String proxyClassNamePrefix = "$Proxy";</div><div class="line"></div><div class="line">        // next number to use for generation of unique proxy class names</div><div class="line">        private static final AtomicLong nextUniqueNumber = new AtomicLong();</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) &#123;</div><div class="line">            ......</div><div class="line"></div><div class="line">            /*</div><div class="line">             * Choose a name for the proxy class to generate.</div><div class="line">             */</div><div class="line">            long num = nextUniqueNumber.getAndIncrement();</div><div class="line">            // é»˜è®¤æƒ…å†µä¸‹ï¼Œä»£ç†ç±»çš„å®Œå…¨é™å®šåä¸ºï¼š</div><div class="line">            // com.sun.proxy.$Proxy0ï¼Œcom.sun.proxy.$Proxy1ä¾æ¬¡é€’å¢</div><div class="line">            String proxyName = proxyPkg + proxyClassNamePrefix + num;</div><div class="line"></div><div class="line">            // ** ç”Ÿæˆä»£ç†ç±»å­—èŠ‚ç çš„åœ°æ–¹ ** //</div><div class="line">            byte[] proxyClassFile = ProxyGenerator.generateProxyClass(</div><div class="line">                proxyName, interfaces);</div><div class="line">            try &#123;</div><div class="line">               // æ ¹æ®äºŒè¿›åˆ¶å­—èŠ‚ç è¿”å›ç›¸åº”çš„Classå®ä¾‹  </div><div class="line">                return defineClass0(loader, proxyName,</div><div class="line">                                    proxyClassFile, 0, proxyClassFile.length);</div><div class="line">            &#125; catch (ClassFormatError e) &#123;</div><div class="line">                throw new IllegalArgumentException(e.toString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="åç¼–è¯‘ä»£ç†ç±»"><a href="#åç¼–è¯‘ä»£ç†ç±»" class="headerlink" title="åç¼–è¯‘ä»£ç†ç±»"></a>åç¼–è¯‘ä»£ç†ç±»</h3><ul>
<li>ä¿®æ”¹æµ‹è¯•<code>HelloProxyTest</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloProxyTest</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    </div><div class="line">  <span class="comment">//è®¾ç½®ä¸ºtrue,ä¼šåœ¨å·¥ç¨‹æ ¹ç›®å½•ç”Ÿæˆ$Proxy0.classä»£ç†ç±»ï¼ˆcom.sun.proxy.$Proxy0.classï¼‰</span></div><div class="line">    System.getProperties().put(</div><div class="line">        <span class="string">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span>, <span class="string">"true"</span>);</div><div class="line"></div><div class="line">    Hello hello = <span class="keyword">new</span> HelloImpl();</div><div class="line">    HelloInvocationHandle helloInvocationHandler = <span class="keyword">new</span> HelloInvocationHandle(hello);</div><div class="line"></div><div class="line">    <span class="comment">// é€šè¿‡Proxy.newProxyInstanceç”Ÿæˆä»£ç†å¯¹è±¡</span></div><div class="line">    Hello helloProxy = (Hello) Proxy.newProxyInstance(Hello.class.getClassLoader(), hello.getClass().getInterfaces(),</div><div class="line">            helloInvocationHandler);</div><div class="line"></div><div class="line">    <span class="comment">// è°ƒç”¨sayæ–¹æ³•</span></div><div class="line">    helloProxy.say(<span class="string">"test"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼Œå½“æŠŠ<code>saveGeneratedFiles</code>å±æ€§è®¾ç½®ä¸ºtrueæ—¶ï¼Œç”Ÿæˆçš„classæ–‡ä»¶åŠå…¶æ‰€åœ¨çš„è·¯å¾„éƒ½éœ€è¦æå‰åˆ›å»ºï¼Œå¦åˆ™ä¼šæŠ›å‡ºFileNotFoundExceptionå¼‚å¸¸ï¼›å³è¦åœ¨è¿è¡Œå½“å‰mainæ–¹æ³•çš„è·¯å¾„ä¸‹åˆ›å»ºcom/sun/proxyç›®å½•ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª$Proxy0.classæ–‡ä»¶</strong></p>
<ul>
<li>åç¼–è¯‘æ–‡ä»¶<code>$Proxy0.class</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sun.proxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.zsr.test.proxy.Hello;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.UndeclaredThrowableException;</div><div class="line"></div><div class="line"><span class="comment">// ** æ³¨æ„è¿™é‡Œä»£ç†ç±»å®ç°äº†æ¥å£ ** //</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> $<span class="title">Proxy0</span> <span class="keyword">extends</span> <span class="title">Proxy</span></span></div><div class="line">  <span class="keyword">implements</span> <span class="title">Hello</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> $Proxy0(InvocationHandler paramInvocationHandler)</div><div class="line">    <span class="keyword">throws</span> </div><div class="line">  &#123;</div><div class="line">    <span class="keyword">super</span>(paramInvocationHandler);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object paramObject)</span></span></div><div class="line">    <span class="keyword">throws</span> </div><div class="line">  &#123;</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">      <span class="keyword">return</span> ((Boolean)<span class="keyword">this</span>.h.invoke(<span class="keyword">this</span>, m1, <span class="keyword">new</span> Object[] &#123; paramObject &#125;)).booleanValue();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (RuntimeException localRuntimeException)</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">throw</span> localRuntimeException;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Throwable localThrowable)</div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(localThrowable);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span></span></div><div class="line">    <span class="keyword">throws</span> </div><div class="line">  &#123;</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">      <span class="keyword">return</span> ((Integer)<span class="keyword">this</span>.h.invoke(<span class="keyword">this</span>, m0, <span class="keyword">null</span>)).intValue();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (RuntimeException localRuntimeException)</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">throw</span> localRuntimeException;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Throwable localThrowable)</div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(localThrowable);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(String paramString)</span></span></div><div class="line">    <span class="keyword">throws</span> </div><div class="line">  &#123;</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">      <span class="keyword">this</span>.h.invoke(<span class="keyword">this</span>, m3, <span class="keyword">new</span> Object[] &#123; paramString &#125;);</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (RuntimeException localRuntimeException)</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">throw</span> localRuntimeException;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Throwable localThrowable)</div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(localThrowable);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span></span></div><div class="line">    <span class="keyword">throws</span> </div><div class="line">  &#123;</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">      <span class="keyword">return</span> (String)<span class="keyword">this</span>.h.invoke(<span class="keyword">this</span>, m2, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (RuntimeException localRuntimeException)</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">throw</span> localRuntimeException;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Throwable localThrowable)</div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(localThrowable);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">static</span></div><div class="line">  &#123;</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">      m1 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"equals"</span>, <span class="keyword">new</span> Class[] &#123; Class.forName(<span class="string">"java.lang.Object"</span>) &#125;);</div><div class="line">      m0 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"hashCode"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</div><div class="line">      m3 = Class.forName(<span class="string">"com.zsr.test.proxy.Hello"</span>).getMethod(<span class="string">"say"</span>, <span class="keyword">new</span> Class[] &#123; Class.forName(<span class="string">"java.lang.String"</span>) &#125;);</div><div class="line">      m2 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"toString"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (NoSuchMethodException localNoSuchMethodException)</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(localNoSuchMethodException.getMessage());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (ClassNotFoundException localClassNotFoundException)</div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NoClassDefFoundError(localClassNotFoundException.getMessage());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ˜¾è€Œæ˜“è§ï¼ŒåŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š</p>
<ol>
<li><strong>ç»§æ‰¿äº†Proxyç±»ï¼Œå®ç°äº†ä»£ç†çš„æ¥å£ï¼Œç”±äºjavaä¸èƒ½å¤šç»§æ‰¿ï¼Œè¿™é‡Œå·²ç»ç»§æ‰¿äº†Proxyç±»äº†ï¼Œä¸èƒ½å†ç»§æ‰¿å…¶ä»–çš„ç±»ï¼Œæ‰€ä»¥JDKçš„åŠ¨æ€ä»£ç†ä¸æ”¯æŒå¯¹å®ç°ç±»çš„ä»£ç†ï¼Œåªæ”¯æŒæ¥å£çš„ä»£ç†ã€‚</strong></li>
<li>ä»£ç†ç±»å®ç°ä»£ç†æ¥å£çš„<code>say</code>æ–¹æ³•ä¸­ï¼Œåªæ˜¯ç®€å•çš„è°ƒç”¨äº†<code>InvocationHandler</code>çš„<code>invoke</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<code>invoke</code>æ–¹æ³•ä¸­è¿›è¡Œä¸€äº›ç‰¹æ®Šæ“ä½œï¼Œç”šè‡³ä¸è°ƒç”¨å®ç°çš„æ–¹æ³•ï¼Œç›´æ¥è¿”å›ã€‚</li>
</ol>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://zhuanlan.zhihu.com/p/29188162" target="_blank" rel="external">JDKåŠ¨æ€ä»£ç†æºç åˆ†æ</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[æ¶ˆæ¯feedç³»ç»Ÿç ”ç©¶]]></title>
      <url>http://zsr.github.io/2018/03/27/%E6%B6%88%E6%81%AFfeed%E7%B3%BB%E7%BB%9F%E7%A0%94%E7%A9%B6/</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[LRUMap]]></title>
      <url>http://zsr.github.io/2018/03/21/LRUMap/</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[æ— é”hashMap]]></title>
      <url>http://zsr.github.io/2018/03/14/%E6%97%A0%E9%94%81hashMap/</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[TreeMap]]></title>
      <url>http://zsr.github.io/2018/03/13/TreeMap/</url>
      <content type="html"><![CDATA[<h2 id="æ¦‚è¦"><a href="#æ¦‚è¦" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h2><ul>
<li>ç±»ç»§æ‰¿å…³ç³»</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">NavigableMap&lt;K,V&gt;</div><div class="line">    java.util.AbstractMap&lt;K,V&gt;</div><div class="line">        java.util.TreeMap&lt;K,V&gt;</div></pre></td></tr></table></figure>
<ul>
<li>å®šä¹‰ </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public class TreeMap&lt;K,V&gt;</div><div class="line">    extends AbstractMap&lt;K,V&gt;</div><div class="line">    implements NavigableMap&lt;K,V&gt;, Cloneable, java.io.Serializable</div></pre></td></tr></table></figure>
<p><code>TreeMap</code>å®ç°<code>NavigableMap</code>æ¥å£ï¼Œè¯´æ˜æ”¯æŒä¸€ç³»åˆ—çš„å¯¼èˆªæ–¹æ³•</p>
<ul>
<li>æ ¸å¿ƒæˆå‘˜å˜é‡</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
<ul>
<li>å†…éƒ¨èŠ‚ç‚¹</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
<ul>
<li>è¦ç‚¹</li>
</ul>
<p>]</p>
<a id="more"></a>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[rabbitmqæ¶ˆæ¯é˜²ä¸¢å¤±]]></title>
      <url>http://zsr.github.io/2018/02/22/rabbitmq%E6%B6%88%E6%81%AF%E9%98%B2%E4%B8%A2%E5%A4%B1/</url>
      <content type="html"><![CDATA[<h3 id="å¦‚ä½•è§£å†³æ¶ˆæ¯ä¸¢å¤±"><a href="#å¦‚ä½•è§£å†³æ¶ˆæ¯ä¸¢å¤±" class="headerlink" title="å¦‚ä½•è§£å†³æ¶ˆæ¯ä¸¢å¤±"></a>å¦‚ä½•è§£å†³æ¶ˆæ¯ä¸¢å¤±</h3><p><strong>ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ç›¸äº’è§£è€¦ï¼Œæ€ä¹ˆä¿è¯ç”Ÿäº§è€…å·²å°†æ¶ˆæ¯æŠ•é€’åˆ° <code>RabbitMQ</code> æœåŠ¡ç«¯ï¼Œåˆå¦‚ä½•ç¡®è®¤æ¶ˆè´¹è€…å·²ç»æ¶ˆè´¹äº†è¯¥æ¶ˆæ¯ï¼Ÿ</strong></p>
<h4 id="æ¶ˆæ¯ç”Ÿäº§å¯é æ€§"><a href="#æ¶ˆæ¯ç”Ÿäº§å¯é æ€§" class="headerlink" title="æ¶ˆæ¯ç”Ÿäº§å¯é æ€§"></a>æ¶ˆæ¯ç”Ÿäº§å¯é æ€§</h4><p><code>RabbitMQ</code>ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§æ–¹å¼ï¼š</p>
<ol>
<li>é€šè¿‡<code>AMQP</code>äº‹åŠ¡æœºåˆ¶å®ç°ï¼Œè¿™ä¹Ÿæ˜¯<code>AMQP</code>åè®®å±‚é¢æä¾›çš„è§£å†³æ–¹æ¡ˆï¼›</li>
<li>é€šè¿‡å°†<code>channel</code>è®¾ç½®æˆ<code>confirm</code>æ¨¡å¼æ¥å®ç°ï¼›</li>
</ol>
<h5 id="RabbitMQäº‹åŠ¡æœºåˆ¶"><a href="#RabbitMQäº‹åŠ¡æœºåˆ¶" class="headerlink" title="RabbitMQäº‹åŠ¡æœºåˆ¶"></a><code>RabbitMQ</code>äº‹åŠ¡æœºåˆ¶</h5><p><strong>æ³¨æ„ï¼šä½¿ç”¨äº‹åŠ¡æ¨¡å¼ä¼šå¯¼è‡´æœåŠ¡ç«¯ååé‡æ€¥å‰§ä¸‹é™ï¼Œå®é™…ä½¿ç”¨åœºæ™¯å¾ˆå°‘ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹</strong></p>
<p><code>RabbitMQ</code>ä¸­ä¸äº‹åŠ¡æœºåˆ¶æœ‰å…³çš„æ–¹æ³•æœ‰ä¸‰ä¸ªï¼š<code>txSelect()</code>, <code>txCommit()</code>ä»¥åŠ<code>txRollback()</code>, <code>txSelect</code>ç”¨äºå°†å½“å‰<code>channel</code>è®¾ç½®æˆ<code>transaction</code>æ¨¡å¼(é€šé“äº‹åŠ¡)ï¼Œ<code>txCommit</code>ç”¨äºæäº¤äº‹åŠ¡ï¼Œ<code>txRollback</code>ç”¨äºå›æ»šäº‹åŠ¡ï¼Œåœ¨é€šè¿‡<code>txSelect</code>å¼€å¯äº‹åŠ¡ä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å‘å¸ƒæ¶ˆæ¯ç»™<code>broker</code>ä»£ç†æœåŠ¡å™¨äº†ï¼Œå¦‚æœ<code>txCommit</code>æäº¤æˆåŠŸäº†ï¼Œåˆ™æ¶ˆæ¯ä¸€å®šåˆ°è¾¾äº†<code>broker</code>äº†ï¼Œå¦‚æœåœ¨<code>txCommit</code>æ‰§è¡Œä¹‹å‰<code>broker</code>å¼‚å¸¸å´©æºƒæˆ–è€…ç”±äºå…¶ä»–åŸå› æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¾¿å¯ä»¥æ•è·å¼‚å¸¸é€šè¿‡<code>txRollback</code>å›æ»šäº‹åŠ¡äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    channel.txSelect();</div><div class="line">    channel.basicPublish(exchange, routingKey, MessageProperties.PERSISTENT_TEXT_PLAIN, msg.getBytes());</div><div class="line">    channel.txCommit();</div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">    channel.txRollback();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="Confirmæ¨¡å¼-å¸¸ç”¨æ¨¡å¼"><a href="#Confirmæ¨¡å¼-å¸¸ç”¨æ¨¡å¼" class="headerlink" title="Confirmæ¨¡å¼(å¸¸ç”¨æ¨¡å¼)"></a>Confirmæ¨¡å¼(å¸¸ç”¨æ¨¡å¼)</h5><p>æ¨¡ä»¿äº†åè®®ä¸­å·²ç»å­˜åœ¨çš„æ¶ˆè´¹è€…<code>ACK</code>ç¡®è®¤æœºåˆ¶ï¼Œç”Ÿäº§è€…å°†ä¿¡é“è®¾ç½®æˆ<code>confirm</code>æ¨¡å¼ï¼Œä¸€æ—¦ä¿¡é“è¿›å…¥<code>confirm</code>æ¨¡å¼ï¼Œæ‰€æœ‰åœ¨è¯¥ä¿¡é“ä¸Šé¢å‘å¸ƒçš„æ¶ˆæ¯éƒ½ä¼šè¢«æŒ‡æ´¾ä¸€ä¸ªå”¯ä¸€çš„IDï¼Œä¸€æ—¦æ¶ˆæ¯è¢«æŠ•é€’åˆ°æ‰€æœ‰åŒ¹é…çš„é˜Ÿåˆ—ä¹‹åï¼Œ<code>broker</code>å°±ä¼šå‘é€ä¸€ä¸ªç¡®è®¤ç»™ç”Ÿäº§è€…ï¼ˆåŒ…å«æ¶ˆæ¯çš„å”¯ä¸€IDï¼‰,è¿™å°±ä½¿å¾—ç”Ÿäº§è€…çŸ¥é“æ¶ˆæ¯å·²ç»æ­£ç¡®åˆ°è¾¾ç›®çš„é˜Ÿåˆ—äº†ï¼›å¦‚æœæ¶ˆæ¯å’Œé˜Ÿåˆ—æ˜¯å¯æŒä¹…åŒ–çš„ï¼Œé‚£ä¹ˆç¡®è®¤æ¶ˆæ¯ä¼šå°†æ¶ˆæ¯å†™å…¥ç£ç›˜ä¹‹åå‘å‡º</p>
<p><code>confirm</code>æ¨¡å¼æœ€å¤§çš„å¥½å¤„åœ¨äºä»–æ˜¯å¼‚æ­¥çš„ï¼Œä¸€æ—¦å‘å¸ƒä¸€æ¡æ¶ˆæ¯ï¼Œç”Ÿäº§è€…åº”ç”¨ç¨‹åºå°±å¯ä»¥åœ¨ç­‰ä¿¡é“è¿”å›ç¡®è®¤çš„åŒæ—¶ç»§ç»­å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œå½“æ¶ˆæ¯æœ€ç»ˆå¾—åˆ°ç¡®è®¤ä¹‹åï¼Œç”Ÿäº§è€…åº”ç”¨ä¾¿å¯ä»¥é€šè¿‡å›è°ƒæ–¹æ³•æ¥å¤„ç†è¯¥ç¡®è®¤æ¶ˆæ¯ï¼Œå¦‚æœRabbitMQå› ä¸ºè‡ªèº«å†…éƒ¨é”™è¯¯å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œå°±ä¼šå‘é€ä¸€æ¡nackæ¶ˆæ¯ï¼Œç”Ÿäº§è€…åº”ç”¨ç¨‹åºåŒæ ·å¯ä»¥åœ¨å›è°ƒæ–¹æ³•ä¸­å¤„ç†è¯¥nackæ¶ˆæ¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1. å¯¹äºå¯è·¯ç”±çš„æ¶ˆæ¯ï¼Œå½“æ‰€æœ‰çš„é˜Ÿåˆ—æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œbrokerå‘clientå‘é€basic.ackç¡®è®¤é€šçŸ¥ï¼›</div><div class="line">2. å¯¹äºè·¯ç”±åˆ°æŒä¹…é˜Ÿåˆ—çš„æŒä¹…åŒ–æ¶ˆæ¯ï¼Œå½“æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜åï¼Œbrokerå‘clientå‘é€basic.ackç¡®è®¤é€šçŸ¥ï¼›</div><div class="line">3. å¯¹äºè·¯ç”±åˆ°é•œåƒé˜Ÿåˆ—çš„æ¶ˆæ¯ï¼Œå½“æ‰€æœ‰çš„é•œåƒé˜Ÿåˆ—éƒ½æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œbrokerå‘clientå‘é€basic.ackç¡®è®¤é€šçŸ¥ï¼›</div><div class="line"></div><div class="line">4. å¯¹äºä¸å¯è·¯ç”±çš„æ¶ˆæ¯ï¼Œbrokerä¸€æ—¦ç¡®è®¤è¯¥æ¶ˆæ¯ä¸å¯è·¯ç”±æ—¶ï¼Œåˆ™å‘clientå‘é€basic.ackç¡®è®¤é€šçŸ¥ï¼›</div><div class="line">5. å¯¹äºä¸å¯è·¯ç”±ä¸”mandatoryå¼ºåˆ¶æŠ•é€’çš„æ¶ˆæ¯ï¼Œbrokerä¸€æ—¦ç¡®è®¤è¯¥æ¶ˆæ¯ä¸å¯è·¯ç”±æ—¶ï¼Œå…ˆå‘clientå‘é€basic.returné€šçŸ¥ï¼Œç„¶åå‘é€basic.ackç¡®è®¤é€šçŸ¥ï¼›</div></pre></td></tr></table></figure>
<ul>
<li><code>Spring Amqpé…ç½®</code></li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span></span></div><div class="line">		<span class="attr">host</span>=<span class="string">"$&#123;rabbit.connect.host&#125;"</span> </div><div class="line">        <span class="attr">port</span>=<span class="string">"$&#123;rabbit.connect.port&#125;"</span> </div><div class="line">        <span class="attr">username</span>=<span class="string">"$&#123;rabbit.connect.username&#125;"</span></div><div class="line">		<span class="attr">password</span>=<span class="string">"$&#123;rabbit.connect.password&#125;"</span> </div><div class="line">        <span class="attr">channel-cache-size</span>=<span class="string">"$&#123;rabbit.connect.channelCacheSize&#125;"</span></div><div class="line">		<span class="attr">publisher-returns</span>=<span class="string">"true"</span> </div><div class="line">        <span class="attr">publisher-confirms</span>=<span class="string">"true"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"returnCallback"</span></span></div><div class="line">		<span class="attr">class</span>=<span class="string">"com.ximalaya.trump.business.message.callback.MessageReturnCallback"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"confirmCallback"</span></span></div><div class="line">		<span class="attr">class</span>=<span class="string">"com.ximalaya.trump.business.message.callback.MessageConfirmCallback"</span> /&gt;</div><div class="line"></div><div class="line"><span class="comment">&lt;!-- mandatoryå¿…é¡»è®¾ç½®true,return-callbackæ‰ç”Ÿæ•ˆ --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">"rabbitTemplate"</span></span></div><div class="line">		<span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> </div><div class="line">        <span class="attr">confirm-callback</span>=<span class="string">"confirmCallback"</span></div><div class="line">		<span class="attr">return-callback</span>=<span class="string">"returnCallback"</span> </div><div class="line">        <span class="attr">message-converter</span>=<span class="string">"messageConverter"</span></div><div class="line">        <span class="attr">mandatory</span>=<span class="string">"true"</span> /&gt;</div></pre></td></tr></table></figure>
<p>å½“<code>mandatory</code>æ ‡å¿—è®¾ç½®ä¸ºtrueæ—¶ï¼Œå¦‚æœ<code>exchange</code>æ ¹æ®è‡ªèº«ç±»å‹å’Œæ¶ˆæ¯<code>routingKey</code>æ— æ³•æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„<code>queue</code>å­˜å‚¨æ¶ˆæ¯ï¼Œé‚£ä¹ˆ<code>broker</code>ä¼šè°ƒç”¨<code>basic.return</code>æ–¹æ³•å°†æ¶ˆæ¯è¿”è¿˜ç»™ç”Ÿäº§è€…;å½“<code>mandatory</code>è®¾ç½®ä¸ºfalseæ—¶ï¼Œå‡ºç°ä¸Šè¿°æƒ…å†µbrokerä¼šç›´æ¥å°†æ¶ˆæ¯ä¸¢å¼ƒ</p>
<ul>
<li><code>confirmCallback</code>å›è°ƒæ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageConfirmCallback</span> <span class="keyword">implements</span> <span class="title">ConfirmCallback</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(MessageConfirmCallback.class);</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">(CorrelationData correlationData, <span class="keyword">boolean</span> ack)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (ack) &#123;</div><div class="line">      <span class="comment">// å¦‚æœå‘é€åˆ°äº¤æ¢å™¨æˆåŠŸï¼Œä½†æ˜¯æ²¡æœ‰åŒ¹é…çš„é˜Ÿåˆ—ï¼ˆæ¯”å¦‚è¯´å–æ¶ˆäº†ç»‘å®šï¼‰ï¼Œack è¿”å›å€¼ä¸ºè¿˜æ˜¯ trueï¼ˆè¿™æ˜¯ä¸€ä¸ªå‘ï¼Œéœ€è¦æ³¨æ„ï¼‰, è¿™ç§æƒ…å†µä¸€èˆ¬éœ€è¦åœ¨returnCallBackä¸­é‡æ–°æŠ•é€’</span></div><div class="line">             LOG.info(<span class="string">"æ¶ˆæ¯ç¡®è®¤æˆåŠŸ"</span>);</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">// å¦‚æœå‘é€åˆ°äº¤æ¢å™¨éƒ½æ²¡æœ‰æˆåŠŸï¼ˆæ¯”å¦‚è¯´åˆ é™¤äº†äº¤æ¢å™¨ï¼‰ï¼Œack è¿”å›å€¼ä¸º false</span></div><div class="line">      <span class="comment">// å¤„ç†ä¸¢å¤±çš„æ¶ˆæ¯ï¼ˆnackï¼‰</span></div><div class="line">             LOG.warn(<span class="string">"æ¶ˆæ¯ç¡®è®¤å¤±è´¥"</span>);</div><div class="line">     &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>returnCallback</code>å›è°ƒæ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageReturnCallback</span> <span class="keyword">implements</span> <span class="title">ReturnCallback</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(MessageReturnCallback.class);</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Charset charset = Charset.forName(<span class="string">"UTF-8"</span>);</div><div class="line"></div><div class="line">  <span class="meta">@Autowired</span></div><div class="line">  <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> JsonParser jsonParser;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnedMessage</span><span class="params">(Message message, <span class="keyword">int</span> replyCode, String replyText, String exchange, String routingKey)</span> </span>&#123;</div><div class="line">    String messageContent = <span class="keyword">new</span> String(message.getBody(), charset);</div><div class="line">    LOG.warn(</div><div class="line">        <span class="string">"Return message from exchange &#123;&#125; and routing &#123;&#125;, reply-code is &#123;&#125;, reply-text is &#123;&#125;, message content is &#123;&#125;"</span>,</div><div class="line">        exchange, routingKey, replyCode, replyCode, messageContent);</div><div class="line">    Map&lt;String, Object&gt; map = jsonParser.toMap(messageContent);</div><div class="line">    String correlationId = (String) map.get(<span class="string">"id"</span>);</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == correlationId) &#123;</div><div class="line">      rabbitTemplate.convertAndSend(exchange, routingKey, message);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      CorrelationData correlationData = <span class="keyword">new</span> CorrelationData(correlationId);</div><div class="line">      rabbitTemplate.convertAndSend(exchange, routingKey, message, correlationData);</div><div class="line">    &#125;</div><div class="line">    LOG.info(<span class="string">"retry send message &#123;&#125; to exchange &#123;&#125; succeed."</span>, messageContent, exchange);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li><code>confirm</code> ä¸»è¦æ˜¯ç”¨æ¥åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦æœ‰æ­£ç¡®åˆ°è¾¾äº¤æ¢æœºï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆå°± ack å°±è¿”å› trueï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™æ˜¯ falseã€‚</li>
<li><code>return</code> åˆ™è¡¨ç¤ºå¦‚æœä½ çš„æ¶ˆæ¯å·²ç»æ­£ç¡®åˆ°è¾¾äº¤æ¢æœºï¼Œä½†æ˜¯åç»­å¤„ç†å‡ºé”™äº†ï¼Œé‚£ä¹ˆå°±ä¼šå›è°ƒ returnï¼Œå¹¶ä¸”æŠŠä¿¡æ¯é€å›ç»™ä½ ï¼ˆå‰ææ˜¯éœ€è¦è®¾ç½®äº† Mandatoryï¼Œä¸è®¾ç½®é‚£ä¹ˆå°±ä¸¢å¼ƒï¼‰ï¼›å¦‚æœæ¶ˆæ¯æ²¡æœ‰åˆ°è¾¾äº¤æ¢æœºï¼Œé‚£ä¹ˆä¸ä¼šè°ƒç”¨ return çš„ä¸œè¥¿ã€‚</li>
</ul>
<h4 id="æ¶ˆæ¯æ¶ˆè´¹å¯é æ€§"><a href="#æ¶ˆæ¯æ¶ˆè´¹å¯é æ€§" class="headerlink" title="æ¶ˆæ¯æ¶ˆè´¹å¯é æ€§"></a>æ¶ˆæ¯æ¶ˆè´¹å¯é æ€§</h4><p>ä¸ºäº†ä¿è¯æ¶ˆæ¯ä»é˜Ÿåˆ—å¯é åœ°åˆ°è¾¾ <code>Consumer</code>ï¼Œ<code>RabbitMQ</code>æä¾›æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ã€‚æ¶ˆè´¹è€…åœ¨å£°æ˜é˜Ÿåˆ—æ—¶ï¼Œå¯ä»¥æŒ‡å®š<code>noAck</code>å‚æ•°ï¼Œå½“<code>noAck=false</code>æ—¶ï¼Œ<code>RabbitMQ</code>ä¼šç­‰å¾…æ¶ˆè´¹è€…æ˜¾å¼å‘å›<code>ack</code>ä¿¡å·åæ‰ä»å†…å­˜(å’Œç£ç›˜ï¼Œå¦‚æœæ˜¯æŒä¹…åŒ–æ¶ˆæ¯çš„è¯)ä¸­ç§»å»æ¶ˆæ¯ã€‚å¦åˆ™ï¼Œ<code>RabbitMQ</code>ä¼šåœ¨é˜Ÿåˆ—ä¸­æ¶ˆæ¯è¢«æ¶ˆè´¹åç«‹å³åˆ é™¤å®ƒ</p>
<p>æ¶ˆæ¯ç”Ÿäº§ã€æ¶ˆè´¹çš„æµç¨‹å›¾ï¼š</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1foqf1jfheyj313s0pqjvu.jpg" alt=""></p>
<h5 id="ack-æ¨¡å¼"><a href="#ack-æ¨¡å¼" class="headerlink" title="ack æ¨¡å¼"></a><code>ack</code> æ¨¡å¼</h5><ul>
<li><p><code>NONE</code></p>
<p>è¯¥æ¨¡å¼ä¸‹, å½“ <code>broker</code> å‘é€æ¶ˆæ¯æˆåŠŸå, ä¼šç«‹å³å°†æ­¤æ¶ˆæ¯ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­åˆ é™¤, è€Œä¸ä¼šç­‰å¾…æ¶ˆè´¹è€…çš„ <code>ACK</code> å›å¤</p>
</li>
</ul>
<ul>
<li><code>MANUAL</code></li>
</ul>
<ul>
<li><p><code>AUTO</code>(é»˜è®¤æ¨¡å¼)</p>
<p>å½“ <code>broker</code> å‘é€æ¶ˆæ¯ç»™æ¶ˆè´¹è€…æ—¶, ä¸ä¼šç«‹å³å°†æ­¤æ¶ˆæ¯åˆ é™¤, è€Œæ˜¯éœ€è¦ç­‰å¾…æ¶ˆè´¹è€…çš„ ACK å›å¤åæ‰ä¼šåˆ é™¤æ¶ˆæ¯. å› æ­¤åœ¨æ‰‹åŠ¨ <code>ACK</code> æ¨¡å¼ä¸‹, å½“æ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯å¹¶å¤„ç†å®Œæˆå, éœ€è¦å‘ <code>broker</code> æ˜¾ç¤ºåœ°å‘é€ ACK æŒ‡ä»¤.</p>
</li>
</ul>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://my.oschina.net/u/3523423/blog/1620885" target="_blank" rel="external">RabbitMQ å®æˆ˜ï¼ˆå››ï¼‰æ¶ˆè´¹è€… ack ä»¥åŠ ç”Ÿäº§è€… confirms</a></p>
<p><a href="http://www.pandan.xyz/2017/03/05/rabbitmq%20%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%8A%95%E9%80%92%E5%8F%8A%E6%B6%88%E8%B4%B9%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">rabbitmq æ¶ˆæ¯å¯é æŠ•é€’åŠæ¶ˆè´¹æœºåˆ¶</a></p>
<p><a href="http://www.bijishequ.com/detail/52417?p=" target="_blank" rel="external">rabbitmqçš„å‘å¸ƒç¡®è®¤å’Œäº‹åŠ¡</a></p>
<p><a href="http://blog.csdn.net/u013256816/article/details/55515234" target="_blank" rel="external">RabbitMQä¹‹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆäº‹åŠ¡+Confirmï¼‰</a></p>
<p><a href="http://www.10tiao.com/html/773/201801/2247487341/1.html" target="_blank" rel="external">æœ‰è´§RabbitMQåŒæ´»å®è·µ</a></p>
<p><a href="https://laoyuan.me/posts/spring-rabbitmq-demo.html" target="_blank" rel="external">Spring Booté›†æˆRabbitMQä¸ACKç¡®è®¤æ¨¡å¼</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Java çº¿ç¨‹çŠ¶æ€]]></title>
      <url>http://zsr.github.io/2018/02/09/Java-%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81/</url>
      <content type="html"><![CDATA[<h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">åŒä¸€ä¸ªçº¿ç¨‹èƒ½ä¸èƒ½startæ‰§è¡Œ2æ¬¡ï¼Ÿ</div><div class="line">---ä¸èƒ½</div></pre></td></tr></table></figure>
<p><code>Java</code>è™šæ‹Ÿæœºæ‰€æš´éœ²çš„çº¿ç¨‹çŠ¶æ€ï¼Œä¸æ“ä½œç³»ç»Ÿåº•å±‚çš„çº¿ç¨‹çŠ¶æ€æ˜¯ä¸¤ä¸ªä¸åŒå±‚é¢çš„äº‹</p>
<h3 id="JVMçº¿ç¨‹çŠ¶æ€"><a href="#JVMçº¿ç¨‹çŠ¶æ€" class="headerlink" title="JVMçº¿ç¨‹çŠ¶æ€"></a>JVMçº¿ç¨‹çŠ¶æ€</h3><p><code>JVM</code>ä¸­å®šä¹‰çš„çº¿ç¨‹çŠ¶æ€æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> State &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * çº¿ç¨‹åˆšåˆ›å»ºï¼Œè¿˜æœªstart</div><div class="line">         */</div><div class="line">        NEW,</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * çº¿ç¨‹æ­£åœ¨jvmä¸­æ‰§è¡Œï¼Œå¯¹æ“ä½œç³»ç»Ÿæ¥è¯´å¯èƒ½æ­£åœ¨ç­‰å¾…æ—¶é—´ç‰‡æ‰§è¡Œ(å°±ç»ªæ€)</div><div class="line">         * I/Oé˜»å¡æˆ–ç½‘ç»œç­‰å¾…ï¼Œå¯¹åº”çš„JVMçº¿ç¨‹çŠ¶æ€ä¹Ÿæ˜¯RUNNABLE</div><div class="line">         */</div><div class="line">        RUNNABLE,</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * ç¨‹æ­£åœ¨ç­‰å¾…è·å–é”ï¼Œé˜»å¡çŠ¶æ€</div><div class="line">         */</div><div class="line">        BLOCKED,</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * ä¸€èˆ¬é€šè¿‡Object.wait()æˆ–è€…Thread.join()ï¼Œè¿›å…¥waitingçŠ¶æ€;å‰ææ˜¯è¿™ä¸ªçº¿ç¨‹å·²ç»æ‹¥æœ‰é”äº†</div><div class="line">         * å¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†ä¸€ä¸ªå¯¹è±¡çš„waitæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±ä¼šå¤„äºwaitingçŠ¶æ€ç›´åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨è¿™ä¸ªå¯¹                          </div><div class="line">         * è±¡çš„notifyæˆ–è€…notifyAllæ–¹æ³•åæ‰ä¼šè§£é™¤è¿™ä¸ªçŠ¶æ€</div><div class="line">         */</div><div class="line">        WAITING,</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * é€šè¿‡sleep(timeout)æˆ–wait(timeout)æ–¹æ³•è¿›å…¥çš„é™æœŸç­‰å¾…çš„çŠ¶æ€</div><div class="line">         * éœ€è¦æ³¨æ„2è€…åŒºåˆ«</div><div class="line">         */</div><div class="line">        TIMED_WAITING,</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * çº¿ç¨‹æ‰§è¡Œç»“æŸ</div><div class="line">         */</div><div class="line">        TERMINATED;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="blockedå’ŒwaitingçŠ¶æ€çš„åŒºåˆ«"><a href="#blockedå’ŒwaitingçŠ¶æ€çš„åŒºåˆ«" class="headerlink" title="blockedå’ŒwaitingçŠ¶æ€çš„åŒºåˆ«"></a><code>blocked</code>å’Œ<code>waiting</code>çŠ¶æ€çš„åŒºåˆ«</h4><ul>
<li><code>blocked</code>æ˜¯è™šæ‹Ÿæœºè®¤ä¸ºç¨‹åºè¿˜ä¸èƒ½è¿›å…¥æŸä¸ªåŒºåŸŸï¼Œå› ä¸ºåŒæ—¶è¿›å»å°±ä¼šæœ‰é—®é¢˜ï¼Œè¿™æ˜¯ä¸€å—ä¸´ç•ŒåŒº</li>
<li><code>wait</code>æ“ä½œçš„å…ˆå†³æ¡ä»¶æ˜¯è¦è¿›å…¥ä¸´ç•ŒåŒºï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹å·²ç»æ‹¿åˆ°é”äº†ï¼Œè‡ªå·±å¯èƒ½è¿›å»åšäº†ä¸€äº›äº‹æƒ…ï¼Œä½†æ­¤æ—¶é€šè¿‡åˆ¤å®šä¸šåŠ¡ä¸Šçš„å‚æ•°ï¼Œå‘ç°è¿˜æœ‰ä¸€äº›å…¶ä»–é…åˆçš„èµ„æºæ²¡æœ‰å‡†å¤‡å……åˆ†ï¼Œé‚£ä¹ˆè‡ªå·±å°±ç­‰ç­‰å†åšå…¶ä»–äº‹æƒ…ã€‚</li>
</ul>
<h4 id="sleep-å’Œwait-æ“ä½œçš„åŒºåˆ«"><a href="#sleep-å’Œwait-æ“ä½œçš„åŒºåˆ«" class="headerlink" title="sleep()å’Œwait()æ“ä½œçš„åŒºåˆ«"></a><code>sleep()</code>å’Œ<code>wait()</code>æ“ä½œçš„åŒºåˆ«</h4><ul>
<li><code>sleep</code>æ˜¯<code>Thread</code>ç±»çš„é™æ€æ–¹æ³•,<code>wait</code>æ˜¯<code>Object</code>ç±»ä¸­å®šä¹‰çš„æ–¹æ³•</li>
<li><code>Thread.sleep</code>ä¸ä¼šå¯¼è‡´é”è¡Œä¸ºçš„æ”¹å˜ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ˜¯æ‹¥æœ‰é”çš„ï¼Œé‚£ä¹ˆ<code>Thread.sleep</code>ä¸ä¼šè®©çº¿ç¨‹é‡Šæ”¾é”ï¼›<code>Object.wait</code>ä¼šé‡Šæ”¾é”ï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­</li>
<li><code>wait</code>ä¸å¸¦è®¡æ—¶å‚æ•°æ˜¯<code>WAITING</code>çŠ¶æ€ï¼Œå¸¦è®¡æ—¶å‚æ•°æ˜¯<code>TIMED_WAITING</code>çŠ¶æ€ï¼›ä¸ç®¡æ˜¯é€šè¿‡<code>notify()</code>å”¤é†’è¿˜æ˜¯è¶…æ—¶æ—¶é—´å·²åˆ°ï¼Œéƒ½éœ€è¦é‡æ–°è·å–é”æ‰èƒ½ç»§ç»­æ‰§è¡Œ</li>
</ul>
<h3 id="çº¿ç¨‹startæ–¹æ³•"><a href="#çº¿ç¨‹startæ–¹æ³•" class="headerlink" title="çº¿ç¨‹startæ–¹æ³•"></a>çº¿ç¨‹startæ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// threadStatus=0,è¡¨ç¤ºå½“å‰ä¸ºNEWçŠ¶æ€</span></div><div class="line">        <span class="keyword">if</span> (threadStatus != <span class="number">0</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</div><div class="line">  </div><div class="line">        group.add(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// æœ¬åœ°æ–¹æ³•æ‰§è¡Œçº¿ç¨‹</span></div><div class="line">            start0();</div><div class="line">            started = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> (!started) &#123;</div><div class="line">                    group.threadStartFailed(<span class="keyword">this</span>);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</div><div class="line">                <span class="comment">/* do nothing. If start0 threw a Throwable then</span></div><div class="line">                  it will be passed up the call stack */</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><code>start()</code>æ–¹æ³•æ˜¯åŒæ­¥çš„ï¼Œè€Œä¸”æ‰§è¡Œå‰ä¼šåˆ¤æ–­å½“å‰çº¿ç¨‹çŠ¶æ€æ˜¯å¦ä¸º<code>NEW</code>ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹åªèƒ½æ‰§è¡Œä¸€æ¬¡</p>
<h3 id="ç½‘ç»œé˜»å¡çº¿ç¨‹çŠ¶æ€"><a href="#ç½‘ç»œé˜»å¡çº¿ç¨‹çŠ¶æ€" class="headerlink" title="ç½‘ç»œé˜»å¡çº¿ç¨‹çŠ¶æ€"></a>ç½‘ç»œé˜»å¡çº¿ç¨‹çŠ¶æ€</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">testBlockedSocketState</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line"></div><div class="line">    Thread serverThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        ServerSocket serverSocket = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">10086</span>);</div><div class="line">          <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="comment">// é˜»å¡çš„acceptæ–¹æ³•</span></div><div class="line">            Socket socket = serverSocket.accept();</div><div class="line">          &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">          e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">            serverSocket.close();</div><div class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;, <span class="string">"socketçº¿ç¨‹"</span>); <span class="comment">// çº¿ç¨‹çš„åå­—</span></div><div class="line">    serverThread.start();</div><div class="line"></div><div class="line">    <span class="comment">// ç¡®ä¿runå·²ç»å¾—åˆ°æ‰§è¡Œ</span></div><div class="line">    Thread.sleep(<span class="number">500</span>);</div><div class="line"></div><div class="line">    <span class="comment">// çŠ¶æ€ä¸ºRUNNABLE</span></div><div class="line">    System.out.println(serverThread.getState());</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>jstack</code>æŸ¥çœ‹çº¿ç¨‹çŠ¶æ€ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&quot;socketçº¿ç¨‹&quot; #9 prio=5 os_prio=31 tid=0x00007ff0bc026800 nid=0x4c03 runnable [0x00007000010c6000]</div><div class="line">   java.lang.Thread.State: RUNNABLE</div><div class="line">	at java.net.PlainSocketImpl.socketAccept(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409)</div><div class="line">	at java.net.ServerSocket.implAccept(ServerSocket.java:545)</div><div class="line">	at java.net.ServerSocket.accept(ServerSocket.java:513)</div><div class="line">	at com.zsr.test.thread.ThreadBlockedIOState$1.run(ThreadBlockedIOState.java:19)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div></pre></td></tr></table></figure>
<p>å¯è§JVMçº¿ç¨‹çŠ¶æ€ä¸º<code>RUNNABLE</code>ï¼›I/O é˜»å¡ä¹Ÿæ˜¯å¦‚æ­¤</p>
<p><strong>æ³¨æ„ï¼šè¿›è¡Œä¼ ç»Ÿä¸Šçš„ IO æ“ä½œæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¼šè¯´â€œé˜»å¡â€ï¼Œä½†è¿™ä¸ªâ€œé˜»å¡â€ä¸çº¿ç¨‹çš„<code>BLOCKED</code> çŠ¶æ€æ˜¯ä¸¤ç äº‹</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">å½“è¿›è¡Œé˜»å¡å¼çš„ IO æ“ä½œæ—¶ï¼Œåº•å±‚çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ç¡®å®å¤„åœ¨é˜»å¡çŠ¶æ€</div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://fangjian0423.github.io/2016/06/04/java-thread-state/" target="_blank" rel="external">Javaçº¿ç¨‹çŠ¶æ€åˆ†æ</a></p>
<p><a href="https://my.oschina.net/goldenshaw/blog/705397" target="_blank" rel="external">Java çº¿ç¨‹çŠ¶æ€ä¹‹ RUNNABLE</a></p>
<p><a href="http://www.java67.com/2012/08/what-are-difference-between-wait-and.html" target="_blank" rel="external">What is difference between wait and sleep in Java?</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ç¼“å­˜æ›´æ–°åˆ†æ]]></title>
      <url>http://zsr.github.io/2018/01/24/%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<h3 id="é—®é¢˜æ¥æº"><a href="#é—®é¢˜æ¥æº" class="headerlink" title="é—®é¢˜æ¥æº"></a>é—®é¢˜æ¥æº</h3><p>é¡¹ç›®ä¸­ä¸ºäº†åŠ å¿«å“åº”æ—¶é—´ä»¥åŠå‡è½»æ•°æ®åº“å‹åŠ›ï¼Œä½¿ç”¨äº†<code>redis</code>ç¼“å­˜ï¼ŒåŒæ—¶ç¼“å­˜è®¾ç½®äº†è¿‡æœŸæ—¶é—´(1å¤©)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">2ä¸ªçº¿ç¨‹å¹¶å‘ï¼šä¸€ä¸ªè¯»æ•°æ®ï¼Œä¸€ä¸ªå†™æ•°æ®ï¼›</div><div class="line">å‡ä½¿ç¼“å­˜è¿‡æœŸï¼Œè¯»ç¼“å­˜æœªå‘½ä¸­ï¼Œå†™æ•°æ®è¿˜æœªå¼€å§‹ï¼Œè¿™ä¸ªæ—¶å€™åŠ è½½æ•°æ®åˆ°ç¼“å­˜ä¸­(è„æ•°æ®)ï¼›ç„¶åï¼Œå†™æ•°æ®å¼€å§‹ã€‚</div><div class="line">ç»“æœå¯¼è‡´ï¼Œç¼“å­˜å¤±æ•ˆå‰è¯»åˆ°çš„æ•°æ®éƒ½æ˜¯è„æ•°æ®ï¼Œå¦‚ä½•è§£å†³ï¼Ÿ</div></pre></td></tr></table></figure>
<h3 id="ä¸ºä»€ä¹ˆè¦ç”¨ç¼“å­˜"><a href="#ä¸ºä»€ä¹ˆè¦ç”¨ç¼“å­˜" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ç”¨ç¼“å­˜"></a>ä¸ºä»€ä¹ˆè¦ç”¨ç¼“å­˜</h3><p>ä¸€èˆ¬æ•°æ®éƒ½å­˜æ”¾åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œä»¥å¸¸ç”¨çš„MySQLæ•°æ®åº“ä¸ºä¾‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹å“åº”æ—¶é—´åœ¨10msä»¥å†…ç”šè‡³æ›´çŸ­ï¼›ä½†æ˜¯å½“æ•°æ®ä¸Šäº¿æ¡ï¼Œä»»ä½•ä¸€æ¬¾å…³ç³»å‹æ•°æ®åº“çš„å“åº”æ—¶é—´éƒ½ä¸å¯èƒ½æ§åˆ¶åœ¨10msä»¥å†…</p>
<p>åŒæ—¶é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œæ¯”å¦‚åŒæ—¶æ¥1ä¸‡æ¬¡è¯·æ±‚ï¼ŒMySQLå•åº“TPS(æ¯ç§’äº‹åŠ¡é‡)å¤§æ¦‚åªæœ‰1500å·¦å³ï¼Œå…¶å®ƒçš„è¯·æ±‚åªèƒ½å¤„äºç­‰å¾…çŠ¶æ€ï¼Œä¸¥é‡æƒ…å†µä¸‹æ•°æ®åº“å´©æºƒ</p>
<h3 id="ä½¿ç”¨ç¼“å­˜çš„åœºæ™¯"><a href="#ä½¿ç”¨ç¼“å­˜çš„åœºæ™¯" class="headerlink" title="ä½¿ç”¨ç¼“å­˜çš„åœºæ™¯"></a>ä½¿ç”¨ç¼“å­˜çš„åœºæ™¯</h3><p>å¯¹äºç¼“å­˜æ¥è¯´ï¼Œæ•°æ®å˜æ›´å°‘ä¸”æŸ¥è¯¢æ¯”è¾ƒé¢‘ç¹æ˜¯æœ€å¥½çš„åœºæ™¯ï¼Œå¦‚æœæŸ¥è¯¢é‡ä¸å¤Ÿå¤§æˆ–è€…æ•°æ®å˜åŠ¨å¤ªé¢‘ç¹ï¼Œç¼“å­˜ä¹Ÿå°±æ˜¯å¤±å»äº†æ„ä¹‰ã€‚</p>
<h3 id="ç¼“å­˜ç±»å‹"><a href="#ç¼“å­˜ç±»å‹" class="headerlink" title="ç¼“å­˜ç±»å‹"></a>ç¼“å­˜ç±»å‹</h3><h4 id="æœ¬åœ°ç¼“å­˜"><a href="#æœ¬åœ°ç¼“å­˜" class="headerlink" title="æœ¬åœ°ç¼“å­˜"></a>æœ¬åœ°ç¼“å­˜</h4><p>æœ‰äº›æ•°æ®é‡ä¸å¸¸å˜åŒ–ï¼Œä½†æ˜¯è®¿é—®ååˆ†é¢‘ç¹ï¼Œä¾‹å¦‚çœã€å¸‚åœ°åŒºæ•°æ®ã€‚é’ˆå¯¹è¿™ç§åœºæ™¯ï¼Œå¯ä»¥å°†æ•°æ®åŠ è½½åˆ°åº”ç”¨çš„å†…å­˜ä¸­ï¼Œä»¥æå‡ç³»ç»Ÿçš„è®¿é—®æ•ˆç‡ï¼Œå‡å°‘æ•°æ®åº“è®¿é—®åŒæ—¶åŠ å¿«å“åº”æ—¶é—´ã€‚</p>
<ul>
<li><strong>Guava Cache</strong></li>
</ul>
<p>æ¯”è¾ƒå¸¸è§çš„æœ¬åœ°ç¼“å­˜æœ‰<code>Guava Cache</code>ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">LoadingCache&lt;String, String&gt; cache = CacheBuilder.newBuilder()</div><div class="line">        .maximumSize(<span class="number">1000</span>) <span class="comment">// è®¾ç½®æœ€å¤§å¤§å°</span></div><div class="line">        .expireAfterWrite(<span class="number">10</span>, TimeUnit.MINUTES) <span class="comment">// è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œ 10åˆ†é’Ÿ</span></div><div class="line">        .build(</div><div class="line">            <span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</div><div class="line">                <span class="comment">// åŠ è½½ç¼“å­˜å†…å®¹</span></div><div class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    <span class="keyword">return</span> getFromDB(key);</div><div class="line">                &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<ul>
<li><strong>æœ¬åœ°ç¼“å­˜çš„ç¼ºç‚¹</strong><ol>
<li>æ•°æ®ä¿å­˜åœ¨å½“å‰<code>JVM</code>ä¸­ï¼Œæ— æ³•å…±äº«</li>
<li>é‡å¯åº”ç”¨ç¼“å­˜ä¸¢å¤±</li>
</ol>
</li>
</ul>
<h4 id="åˆ†å¸ƒå¼ç¼“å­˜"><a href="#åˆ†å¸ƒå¼ç¼“å­˜" class="headerlink" title="åˆ†å¸ƒå¼ç¼“å­˜"></a>åˆ†å¸ƒå¼ç¼“å­˜</h4><p>æåˆ°åˆ†å¸ƒå¼ç¼“å­˜åŸºæœ¬ä¸Šéƒ½ä¼šè¯´åˆ° <code>Redis</code>ï¼Œ<code>Redis</code>ä½¿ç”¨å†…å­˜ä½œä¸ºå­˜å‚¨ï¼Œæ‰€ä»¥æ€§èƒ½ä¸Šè¦æ¯”æ•°æ®åº“è¦å¥½å¾ˆå¤šï¼Œå†åŠ ä¸Š<code>Redis</code> è¿˜æ”¯æŒå¾ˆå¤šç§æ•°æ®ç»“æ„ï¼Œä½¿ç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ï¼›ä½†æ˜¯ï¼Œ<code>Redis</code>éœ€è¦é€šè¿‡ç½‘ç»œæ¥è®¿é—®ï¼Œæ‰€ä»¥ç½‘ç»œçš„æ€§èƒ½å†³å®šäº† <code>Reids</code> çš„ç“¶é¢ˆ</p>
<h3 id="ç¼“å­˜æ›´æ–°ç­–ç•¥"><a href="#ç¼“å­˜æ›´æ–°ç­–ç•¥" class="headerlink" title="ç¼“å­˜æ›´æ–°ç­–ç•¥"></a>ç¼“å­˜æ›´æ–°ç­–ç•¥</h3><p>æ›´å¤šç­–ç•¥è§<a href="https://coolshell.cn/articles/17416.html" target="_blank" rel="external">ç¼“å­˜æ›´æ–°çš„å¥—è·¯</a>ï¼Œè¿™é‡Œå…·ä½“åˆ†æå–œé©¬æ‹‰é›…çš„ç¼“å­˜æ›´æ–°ç­–ç•¥ï¼šå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†å¤±æ•ˆç¼“å­˜</p>
<h4 id="Cache-Aside-Pattern"><a href="#Cache-Aside-Pattern" class="headerlink" title="Cache Aside Pattern"></a><strong>Cache Aside Pattern</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1. å¤±æ•ˆï¼šå…ˆä»ç¼“å­˜ä¸­è¯»å–æ•°æ®ï¼Œæ²¡æœ‰å¾—åˆ°ï¼Œåˆ™ä»æ•°æ®åº“ä¸­è¯»å–ï¼ŒæˆåŠŸåï¼Œæ”¾åˆ°ç¼“å­˜ä¸­ã€‚</div><div class="line">2. å‘½ä¸­ï¼šä»ç¼“å­˜ä¸­è¯»å–æ•°æ®ï¼Œå–åˆ°åè¿”å›ã€‚</div><div class="line">3. æ›´æ–°ï¼šå…ˆæŠŠæ•°æ®å­˜åˆ°æ•°æ®åº“ä¸­ï¼ŒæˆåŠŸåï¼Œå†è®©ç¼“å­˜å¤±æ•ˆã€‚</div></pre></td></tr></table></figure>
<p>è¿™ç§ç­–ç•¥ä¹Ÿä¼šäº§ç”Ÿé—®é¢˜ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ä¸¤ä¸ªå¹¶å‘æ“ä½œï¼Œä¸€ä¸ªæ˜¯æ›´æ–°æ“ä½œï¼Œä¸€ä¸ªæ˜¯æŸ¥è¯¢æ“ä½œï¼›</div><div class="line">è¯»æ“ä½œå…ˆåˆ°ï¼Œæ²¡æœ‰å‘½ä¸­ç¼“å­˜ï¼Œç„¶åå°±åˆ°æ•°æ®åº“ä¸­è¯»å–ã€‚</div><div class="line">è¿™æ—¶æ¥äº†ä¸€ä¸ªå†™æ“ä½œï¼Œå†™å®Œæ•°æ®åº“åï¼Œç„¶ç¼“å­˜å¤±æ•ˆã€‚</div><div class="line">ç„¶åï¼Œä¹‹å‰çš„è¯»æ“ä½œå†æŠŠæ—§æ•°æ®å†™åˆ°ç¼“å­˜ä¸­ï¼Œè¿˜æ˜¯ä¼šé€ æˆè„æ•°æ®ã€‚</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯ï¼Œè¿™ç§æƒ…å†µå‡ºç°çš„æ¦‚ç‡éå¸¸ä½ã€‚è¿™ä¸ªåœºæ™¯éœ€è¦å‘ç”Ÿåœ¨è¯»ç¼“å­˜æ—¶ç¼“å­˜å¤±æ•ˆï¼Œå¹¶å‘ç€æœ‰ä¸€ä¸ªå†™æ“ä½œã€‚è€Œå®é™…ä¸Šæ•°æ®åº“çš„å†™æ“ä½œæ¯”è¯»æ“ä½œæ…¢å¾—å¤šï¼Œè€Œä¸”è¿˜è¦é”è¡¨ï¼Œè€Œ<strong>è¯»æ“ä½œéœ€è¦åœ¨å†™æ“ä½œä¹‹å‰è¿›å…¥æ•°æ®åº“æ“ä½œï¼Œåˆè¦åœ¨å†™æ“ä½œå®Œæˆåæ›´æ–°ç¼“å­˜</strong>ï¼Œæ‰€æœ‰çš„è¿™äº›æ¡ä»¶éƒ½å…·å¤‡çš„æ¦‚ç‡å¹¶ä¸å¤§ã€‚æ‰€ä»¥ï¼ŒCache Aside Pattern è¿˜æ˜¯ç›¸å¯¹é è°±çš„æ–¹å¼ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://zhaoqqi.github.io/2017/06/14/cache-system-design/" target="_blank" rel="external">ç¼“å­˜ç³»ç»Ÿè®¾è®¡ä¸æ›´æ–°æœºåˆ¶</a></p>
<p><a href="https://coolshell.cn/articles/17416.html" target="_blank" rel="external">ç¼“å­˜æ›´æ–°çš„å¥—è·¯</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[rabbitmqæ¶ˆæ¯é‡è¯•]]></title>
      <url>http://zsr.github.io/2018/01/17/rabbitmq%E6%B6%88%E6%81%AF%E9%87%8D%E8%AF%95/</url>
      <content type="html"><![CDATA[<h3 id="å¦‚ä½•å®ç°æ¶ˆæ¯é‡è¯•"><a href="#å¦‚ä½•å®ç°æ¶ˆæ¯é‡è¯•" class="headerlink" title="å¦‚ä½•å®ç°æ¶ˆæ¯é‡è¯•"></a>å¦‚ä½•å®ç°æ¶ˆæ¯é‡è¯•</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span> /&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">"amqpTemplate"</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> /&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> /&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"messageConverter"</span> <span class="attr">class</span>=<span class="string">"org.springframework.amqp.support.converter.SimpleMessageConverter"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">"microlesson.reward.msg.queue"</span> /&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">rabbit:direct-exchange</span> <span class="attr">name</span>=<span class="string">"business.common.order.confirmed.direct.exchange"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">key</span>=<span class="string">"1245"</span> <span class="attr">queue</span>=<span class="string">"microlesson.reward.msg.queue"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">rabbit:direct-exchange</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">rabbit:listener-container</span>   <span class="attr">prefetch</span>=<span class="string">"20"</span></span></div><div class="line">                             <span class="attr">concurrency</span>=<span class="string">"10"</span></div><div class="line">                             <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span></div><div class="line">                             <span class="attr">message-converter</span>=<span class="string">"messageConverter"</span></div><div class="line">                             <span class="attr">requeue-rejected</span>=<span class="string">"false"</span></div><div class="line">                             <span class="attr">advice-chain</span>=<span class="string">"retryInterceptor"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">"rewordMsgListener"</span> <span class="attr">queue-names</span>=<span class="string">"microlesson.reward.msg.queue"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"rewordMsgListener"</span> <span class="attr">class</span>=<span class="string">"com.ximalaya.microlesson.listener.listener.RewardMsgListener"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"retryTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.retry.support.RetryTemplate"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"backOffPolicy"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.retry.backoff.ExponentialBackOffPolicy"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"initialInterval"</span> <span class="attr">value</span>=<span class="string">"10000"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxInterval"</span> <span class="attr">value</span>=<span class="string">"600000"</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"retryPolicy"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.retry.policy.SimpleRetryPolicy"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxAttempts"</span> <span class="attr">value</span>=<span class="string">"7"</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!--retry Interceptor --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"retryInterceptor"</span></span></div><div class="line">        <span class="attr">class</span>=<span class="string">"org.springframework.amqp.rabbit.config.StatelessRetryOperationsInterceptorFactoryBean"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"messageRecoverer"</span> <span class="attr">ref</span>=<span class="string">"messageRecoverer"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"retryOperations"</span> <span class="attr">ref</span>=<span class="string">"retryTemplate"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li><code>requeue-rejected</code>è®¾ä¸ºfalseè¡¨ç¤ºä¸€æ¡æ¶ˆæ¯å³ä½¿æ²¡æœ‰è¢«ackï¼Œä¹Ÿä¸ä¼šå†é‡æ–°å‘é€ï¼ˆé»˜è®¤æ˜¯ä¼šé‡æ–°åŠ å…¥é˜Ÿåˆ—ï¼‰</li>
</ul>
<h3 id="å¦‚ä½•å®ç°æ¶ˆæ¯å»¶æ—¶"><a href="#å¦‚ä½•å®ç°æ¶ˆæ¯å»¶æ—¶" class="headerlink" title="å¦‚ä½•å®ç°æ¶ˆæ¯å»¶æ—¶"></a>å¦‚ä½•å®ç°æ¶ˆæ¯å»¶æ—¶</h3><p><code>RabbitMQ</code>å¯ä»¥é’ˆå¯¹<code>Queue</code>å’Œ<code>Message</code>è®¾ç½®<code>x-message-tt</code>ï¼Œæ¥æ§åˆ¶æ¶ˆæ¯çš„ç”Ÿå­˜æ—¶é—´ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™æ¶ˆæ¯å˜ä¸º<code>dead letter</code></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.pandan.xyz/2017/03/05/rabbitmq%20%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%8A%95%E9%80%92%E5%8F%8A%E6%B6%88%E8%B4%B9%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">rabbitmq æ¶ˆæ¯å¯é æŠ•é€’åŠæ¶ˆè´¹æœºåˆ¶</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[EventBus]]></title>
      <url>http://zsr.github.io/2017/12/27/EventBus/</url>
      <content type="html"><![CDATA[<h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p><code>Guava</code>æä¾›äº†äº‹ä»¶æ€»çº¿<code>EventBus</code>åº“ï¼Œæ˜¯ä¸€ä¸ªåŸºäºäº‹ä»¶çš„<strong>å‘å¸ƒ/è®¢é˜…æ¡†æ¶</strong>ï¼ˆè§‚å¯Ÿè€…æ¨¡å¼ï¼‰ï¼Œé€šè¿‡è§£è€¦å‘å¸ƒè€…å’Œè®¢é˜…è€…ç®€åŒ–äº‹ä»¶ä¼ é€’ï¼Œå¯ä»¥ç”¨å®ƒåœ¨å•è¿›ç¨‹ä¸­æ›¿ä»£<code>RabbitMQ</code>æ¥åšäº‹ä»¶åˆ†å‘ã€‚</p>
<h3 id="Observeræ¨¡å¼"><a href="#Observeræ¨¡å¼" class="headerlink" title="Observeræ¨¡å¼"></a>Observeræ¨¡å¼</h3><p>JavaæŠŠ<code>Observer</code>æ”¾åˆ°äº†JDKé‡Œé¢ï¼šObservableå’ŒObserverï¼Œå®ƒç®€åŒ–äº†Observeræ¨¡å¼çš„å¼€å‘ï¼Œè‡³å°‘ä¸ç”¨å†æ‰‹å·¥ç»´æŠ¤è‡ªå·±çš„<code>Observer</code>åˆ—è¡¨äº†ã€‚ä¸è¿‡ï¼ŒJDKé‡Œçš„<code>Observer</code>ä»1.0å°±åœ¨é‚£é‡Œäº†ï¼Œç›´åˆ°<code>Java 7</code>ï¼Œå®ƒéƒ½æ²¡æœ‰ä»€ä¹ˆæ”¹å˜ï¼Œå°±è¿é€šçŸ¥çš„å‚æ•°è¿˜æ˜¯<code>Object</code>ç±»å‹ã€‚ç›®å‰å¾ˆå°‘ä¼šç›´æ¥åº”ç”¨JDKä¸­çš„<code>Observer</code>ï¼Œ<code>Guava</code>çš„<code>EventBus</code>ä¹Ÿå®ç°äº†<code>Observer</code>æ¨¡å¼</p>
<h3 id="å…³é”®ç‚¹"><a href="#å…³é”®ç‚¹" class="headerlink" title="å…³é”®ç‚¹"></a>å…³é”®ç‚¹</h3><ul>
<li><strong>äº‹ä»¶(Event)ï¼š</strong>åˆå¯ç§°ä¸ºæ¶ˆæ¯ï¼Œç”¨äºè®¢é˜…è€…å’Œå‘å¸ƒè€…ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’åª’ä»‹ã€‚<code>äº‹ä»¶ç±»å‹(EventType)</code>ä¸€èˆ¬æ˜¯æŒ‡ä¸€ä¸ªæ¶ˆæ¯å¯¹è±¡ã€‚</li>
<li><strong>è®¢é˜…è€…(Subscriber)ï¼š</strong>è®¢é˜…æŸç§äº‹ä»¶ç±»å‹çš„å¯¹è±¡ã€‚å½“æœ‰å‘å¸ƒè€…å‘å¸ƒè¿™ç±»äº‹ä»¶åï¼Œ<code>EventBus</code> ä¼šæ‰§è¡Œè®¢é˜…è€…çš„ <code>onEvent</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å«<code>äº‹ä»¶å“åº”å‡½æ•°</code>ã€‚è®¢é˜…è€…é€šè¿‡ <code>register</code> æ¥å£è®¢é˜…æŸä¸ªäº‹ä»¶ç±»å‹ï¼Œ<code>unregister</code> æ¥å£é€€è®¢ã€‚</li>
<li><strong>å‘å¸ƒè€…(Publisher)ï¼š</strong>å‘å¸ƒæŸäº‹ä»¶çš„å¯¹è±¡ï¼Œé€šè¿‡ post æ¥å£å‘å¸ƒäº‹ä»¶ã€‚</li>
</ul>
<h3 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h3><p><img src="https://raw.githubusercontent.com/android-cn/android-open-project-analysis/master/tool-lib/event-bus/event-bus/image/relation-flow-chart.png" alt="eventbus img"></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.iteye.com/topic/1132705" target="_blank" rel="external">æ·±å…¥ç†è§£EventBusçš„è®¾è®¡æ€æƒ³</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[æµè§ˆå™¨è·¨åŸŸè¯·æ±‚]]></title>
      <url>http://zsr.github.io/2017/12/14/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%B7%A8%E5%9F%9F%E8%AF%B7%E6%B1%82/</url>
      <content type="html"><![CDATA[<p>åœ¨è·¨åŸŸæƒ…å†µä¸‹ï¼ˆæºåŸŸåä¸ç›®çš„åŸŸåä¸ä¸€æ ·ï¼‰ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šå‘èµ·ä¸€ä¸ª<code>HTTP OPTIONS</code> çš„è¯·æ±‚é¢„æ£€ï¼ˆ<code>preflighting</code>ï¼‰æœåŠ¡ç«¯æ˜¯å¦æ”¯æŒ<code>CORS</code>ã€‚å¦‚æœæœåŠ¡ç«¯å…è®¸å½“å‰åŸŸå(æºåŸŸå)<code>CORS</code>ï¼Œåˆ™æµè§ˆå™¨ä¼šå†å‘èµ·çœŸæ­£çš„è¯·æ±‚ã€‚</p>
<h3 id="è·¨åŸŸè¯·æ±‚"><a href="#è·¨åŸŸè¯·æ±‚" class="headerlink" title="è·¨åŸŸè¯·æ±‚"></a>è·¨åŸŸè¯·æ±‚</h3><p>æµè§ˆå™¨å°†<code>CORS</code>è¯·æ±‚åˆ†æˆä¸¤ç±»ï¼šç®€å•è¯·æ±‚ï¼ˆ<code>simple request</code>ï¼‰å’Œéç®€å•è¯·æ±‚ï¼ˆ<code>not-so-simple request</code>ï¼‰ã€‚åªè¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤å¤§æ¡ä»¶ï¼Œå°±å±äºç®€å•è¯·æ±‚ã€‚</p>
<ul>
<li>è¯·æ±‚æ–¹æ³•æ˜¯ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ä¹‹ä¸€ï¼š<code>HEAD,GET,POST</code></li>
<li><code>HTTP</code>çš„å¤´ä¿¡æ¯ä¸è¶…å‡ºä»¥ä¸‹å‡ ç§å­—æ®µï¼š<ul>
<li><code>Accept</code></li>
<li><code>Accept-Language</code></li>
<li><code>Content-Language</code></li>
<li><code>Last-Event-ID</code></li>
<li><code>Content-Type</code>(åªé™äºä¸‰ä¸ªå€¼<code>application/x-www-form-urlencoded</code>ã€ <code>multipart/form-data</code>ã€<code>text/plain</code>)</li>
</ul>
</li>
</ul>
<p>å‡¡æ˜¯ä¸åŒæ—¶æ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶ï¼Œå°±å±äºéç®€å•è¯·æ±‚ã€‚</p>
<h4 id="ç®€å•è¯·æ±‚"><a href="#ç®€å•è¯·æ±‚" class="headerlink" title="ç®€å•è¯·æ±‚"></a>ç®€å•è¯·æ±‚</h4><p>å¯¹äºç®€å•è¯·æ±‚ï¼Œæµè§ˆå™¨ç›´æ¥å‘å‡º<code>CORS</code>è¯·æ±‚ã€‚æµè§ˆå™¨ä¼šè‡ªåŠ¨åœ¨å¤´ä¿¡æ¯(<code>Request Headers</code>)ä¸­ï¼Œæ·»åŠ ä¸€ä¸ª<code>Origin</code> å­—æ®µ,æ¥è¡¨æ˜æœ¬æ¬¡è¯·æ±‚æ¥è‡ªå“ªä¸ªåŸŸã€‚</p>
<ul>
<li>å¦‚æœ<code>Origin</code>ä¸åœ¨è®¸å¯èŒƒå›´å†…ï¼Œä¼šæŠ¥é”™ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">No &apos;Access-Control-Allow-Origin&apos; header is present on the requested resource.</div></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœ<code>Origin</code>æŒ‡å®šçš„åŸŸååœ¨è®¸å¯èŒƒå›´å†…(å¿…é¡»æ˜¯è·¨åŸŸçš„ï¼‰ï¼Œ<code>Response Headers</code>ä¸­ä¼šå¤šå‡ºå‡ ä¸ªå¤´ä¿¡æ¯å­—æ®µ:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Access-Control-Allow-Credentials:true //å€¼ä¸ºtrueè¡¨ç¤ºå…è®¸å‘é€cookie</div><div class="line">Access-Control-Allow-Methods:GET, POST, OPTIONS</div><div class="line">Access-Control-Allow-Origin:http://localhost:8080</div></pre></td></tr></table></figure>
<p>è¿™å‡ ä¸ªå­—ç«¯è¦ä¹ˆåœ¨æœåŠ¡å™¨ç«¯ç›´æ¥è¿”å›ï¼Œè¦ä¹ˆé…ç½®åœ¨<code>nginx</code>ä¸­ï¼Œå…·ä½“å®ç°çœ‹ä¸‹æ–‡</p>
<ul>
<li><code>withCredentials</code>å±æ€§</li>
</ul>
<p><code>CORS</code>é»˜è®¤ä¸å‘é€<code>cookie</code>å’Œ<code>http</code>è®¤è¯ï¼Œå¦‚æœè¦æŠŠ<code>Cookie</code>å‘åˆ°æœåŠ¡å™¨ï¼Œå°±è¦æŒ‡å®š<code>Access-Control-Allow-Credentials:true;</code><strong>å¦å¤–<code>ajax</code>ä¸­ä¹Ÿè¦æ‰“å¼€<code>withCredentials</code>å±æ€§</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">headers: &#123;</div><div class="line">        withCredentials: true,</div><div class="line">    &#125;,</div></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="éç®€å•è¯·æ±‚"><a href="#éç®€å•è¯·æ±‚" class="headerlink" title="éç®€å•è¯·æ±‚"></a>éç®€å•è¯·æ±‚</h4><p>æ¯”å¦‚ï¼šè¯·æ±‚æ–¹æ³•æ˜¯<code>PUT</code>æˆ–<code>DELETE</code>ï¼Œæˆ–è€…<code>Content-Type</code>å­—æ®µçš„ç±»å‹æ˜¯<code>application/json</code></p>
<p><strong>ç»“æœå‘ç°æµè§ˆå™¨è¿ç»­å‘åŒä¸€åœ°å€è¯·æ±‚äº†ä¸¤æ¬¡ï¼Œè€Œç¬¬ä¸€æ¬¡è¯·æ±‚ä»€ä¹ˆå€¼ä¹Ÿæ²¡æ‹¿åˆ°</strong></p>
<ul>
<li>ç¬¬ä¸€æ¬¡è¯·æ±‚ä¿¡æ¯</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">General</div><div class="line">Request URL:http:/mobile.test.ximalaya.com/v1/lesson</div><div class="line">Request Method:OPTIONS  </div><div class="line">Status Code:200 OK</div><div class="line"></div><div class="line">Response Headers</div><div class="line">Access-Control-Request-Headers:content-type  </div><div class="line">Access-Control-Request-Method:GET, POST, OPTIONS  </div><div class="line">Access-Control-Allow-Origin:http://localhost:8080</div><div class="line">Content-Length:0</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬äºŒæ¬¡è¯·æ±‚ä¿¡æ¯</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">General</div><div class="line">Request URL:http:/mobile.test.ximalaya.com/v1/lesson</div><div class="line">Request Method:POST  </div><div class="line">Status Code:200 OK</div><div class="line"></div><div class="line">Response Headers</div><div class="line">Access-Control-Request-Headers:content-type  </div><div class="line">Access-Control-Request-Method:GET, POST, OPTIONS  </div><div class="line">Access-Control-Allow-Origin:http://localhost:8080</div></pre></td></tr></table></figure>
<p>è¿™æ˜¯å› ä¸ºæµè§ˆå™¨å‘ç°ï¼Œè¿™æ˜¯ä¸€ä¸ªéç®€å•è¯·æ±‚ï¼Œå°±è‡ªåŠ¨å‘å‡ºä¸€ä¸ªâ€é¢„æ£€â€è¯·æ±‚ï¼Œè¦æ±‚æœåŠ¡å™¨ç¡®è®¤å¯ä»¥è¿™æ ·è¯·æ±‚ã€‚â€é¢„æ£€â€è¯·æ±‚ç”¨çš„è¯·æ±‚æ–¹æ³•æ˜¯<code>OPTIONS</code>ï¼Œè¡¨ç¤ºè¿™ä¸ªè¯·æ±‚æ˜¯ç”¨æ¥è¯¢é—®çš„ã€‚â€é¢„æ£€â€è¯·æ±‚ä¹‹åï¼Œæµè§ˆå™¨çƒä¼šè¿›è¡Œæ­£å¸¸<code>CORS</code>è¯·æ±‚ã€‚</p>
<h3 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><h4 id="èƒŒæ™¯è¯´æ˜"><a href="#èƒŒæ™¯è¯´æ˜" class="headerlink" title="èƒŒæ™¯è¯´æ˜"></a>èƒŒæ™¯è¯´æ˜</h4><p>å‰ç«¯H5é€šè¿‡<code>ajax</code>è°ƒç”¨åç«¯<code>restful api</code>ï¼Œå¹¶ä¸”é¡µé¢è®¿é—®åŸŸåä¸<code>api</code>è®¿é—®åŸŸå(<code>mobile.test.ximalaya.com</code>)ä¸åŒï¼Œå¯¼è‡´è®¿é—®æŠ¥é”™:</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fmomo2jmabj31kw045n0e.jpg" alt="05C9331E-30FD-4685-AB61-02F308FC3695"></p>
<p>å‡ºç°è¿™ç§æƒ…å†µçš„åŸå› å¦‚ä¸‹ï¼š</p>
<ul>
<li>æœ¬æ¬¡<code>ajax</code>è¯·æ±‚æ˜¯â€œéç®€å•è¯·æ±‚â€,æ‰€ä»¥è¯·æ±‚å‰ä¼šå‘é€ä¸€æ¬¡é¢„æ£€è¯·æ±‚(OPTIONS)</li>
<li>æœåŠ¡å™¨ç«¯åå°æ¥å£æ²¡æœ‰å…è®¸OPTIONSè¯·æ±‚,å¯¼è‡´æ— æ³•æ‰¾åˆ°å¯¹åº”æ¥å£åœ°å€</li>
</ul>
<h4 id="åŸå› åˆ†æ"><a href="#åŸå› åˆ†æ" class="headerlink" title="åŸå› åˆ†æ"></a>åŸå› åˆ†æ</h4><ol>
<li><strong>å‰ç«¯<code>ajax</code>è¯·æ±‚ä»£ç </strong></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$.ajax(&#123;</div><div class="line">    url: &apos;http://mobile.test.ximalaya.com/weikemsg-web/v1/room/110001/discuss/send&apos;,</div><div class="line">    headers: &#123;</div><div class="line">        &apos;Content-Type&apos;:&apos;application/json&apos;</div><div class="line">    &#125;,</div><div class="line">    method: &apos;POST&apos;,</div><div class="line">    data: &#123;id = 1&#125;,</div><div class="line">    success: function(data)&#123;</div><div class="line">      console.log(&apos;succes: &apos;+data);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div></pre></td></tr></table></figure>
<p>è¿™é‡Œè¯·æ±‚ç±»å‹ä½¿ç”¨<code>post</code>ï¼Œæ•°æ®ç±»å‹æ˜¯<code>json</code></p>
<ol>
<li><strong><code>http</code>è¯·æ±‚ä¿¡æ¯</strong></li>
</ol>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fmomo3etz5j30za0f6tbg.jpg" alt="F003603E-2FE9-4009-BF3D-CAA5EE0201F9"></p>
<p>ä»<code>request header</code>ä¿¡æ¯ä¸­å¯ä»¥å‘ç°ï¼Œå®é™…è¯·æ±‚ç±»å‹æ˜¯<code>OPTIONS</code>ï¼Œæ³¨æ„ï¼š</p>
<ul>
<li><code>Access-Control-Request-Method</code>ï¼šåœ¨å‘å‡ºé¢„æ£€è¯·æ±‚æ—¶å¸¦æœ‰è¿™ä¸ªå¤´ä¿¡æ¯, å‘Šè¯‰æœåŠ¡å™¨åœ¨å®é™…è¯·æ±‚æ—¶ä¼šä½¿ç”¨çš„è¯·æ±‚æ–¹å¼</li>
<li><code>Access-Control-Request-Headers</code>ï¼šåœ¨å‘å‡ºé¢„æ£€è¯·æ±‚æ—¶å¸¦æœ‰è¿™ä¸ªå¤´ä¿¡æ¯, å‘Šè¯‰æœåŠ¡å™¨åœ¨å®é™…è¯·æ±‚æ—¶ä¼šæºå¸¦çš„è‡ªå®šä¹‰å¤´ä¿¡æ¯. å¦‚æœ‰å¤šä¸ª, å¯ä»¥ç”¨é€—å·åˆ†å¼€.</li>
<li><code>Origin</code>ï¼šè¡¨æ˜å‘é€è¯·æ±‚æˆ–è€…é¢„è¯·æ±‚çš„åŸŸ</li>
</ul>
<ol>
<li><strong>å¤±è´¥åˆ†æ</strong></li>
</ol>
<ul>
<li><code>Status Code:401</code></li>
</ul>
<p>è¿™é‡Œçš„<code>http</code>è¿”å›çŠ¶æ€ç <code>401</code>(æœªæˆæƒ)ï¼Œæ˜¯å› ä¸ºæœåŠ¡ç«¯è¿™è¾¹è®¾ç½®äº†ç™»å½•éªŒè¯è¿‡æ»¤å™¨ï¼ŒæœåŠ¡ç«¯è¿”å›ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fmomo4slblj30fg03eq32.jpg" alt="F2AFC4E1-4CDE-4B6C-8237-A185565213D9"></p>
<ul>
<li>è·¨åŸŸ</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Response to preflight request doesn&apos;t pass access control check: No &apos;Access-Control-Allow-Origin&apos; header is present on the requested resource. Origin &apos;http://127.0.0.1:9000&apos; is therefore not allowed access</div></pre></td></tr></table></figure>
<p>ä»æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ä¸­ï¼Œå¯ä»¥å‘ç°æµè§ˆå™¨å‘é€çš„<code>OPTIONS</code>é¢„æ£€è¯·æ±‚ä¸å…è®¸è®¿é—®æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯ä¸å…è®¸è·¨åŸŸè®¿é—®</p>
<ol>
<li><strong>ç¬¬ä¸€æ¬¡å°è¯•è§£å†³</strong></li>
</ol>
<p><code>Nginx</code>æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location ^~ /weikemsg-web &#123;</div><div class="line">        add_header 'Access-Control-Allow-Origin' "*"; // å…è®¸æ‰€æœ‰åŸŸåè®¿é—®</div><div class="line">        add_header 'Access-Control-Allow-Credentials' 'true';  // å…è®¸æºå¸¦Cookie</div><div class="line">        add_header 'Access-Control-Allow-Methods' 'POST, GET, OPTIONS'; // æ”¯æŒè®¿é—®æ–¹å¼</div><div class="line">        proxy_pass http://weikemsg-web/weikemsg-web;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>åŒæ—¶ç”¨æˆ·å…ˆç™»å½•ï¼Œä¿ç•™<code>Cookie</code>ï¼Œå†æ¬¡è®¿é—®ç›®çš„åœ°å€ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fmomo2zcwoj31kw03641g.jpg" alt="01807CD6-DD4D-4F17-BF94-F5F75CE7E93E"></p>
<p>ç»“æœæ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œè·¨åŸŸè®¿é—®æ²¡æœ‰æˆåŠŸï¼ŒæœåŠ¡ç«¯è¿˜æ˜¯æ²¡æœ‰æ‹¿åˆ°<code>Cookie</code>ä¿¡æ¯</p>
<ol>
<li><strong>ç¬¬äºŒæ¬¡å°è¯•è§£å†³</strong></li>
</ol>
<p><strong>å¦‚æœ<code>http</code>è¯·æ±‚éœ€è¦å¸¦ä¸Š<code>Cookie</code>ï¼Œå¿…é¡»è®¾ç½®<code>Access-Control-Allow-Credentials</code>ä¸º<code>true</code>ï¼ŒåŒæ—¶ä¸èƒ½è®¾ç½®<code>Access-Control-Allow-Origin</code>ä¸º<code>*</code></strong></p>
<p>é‡æ–°é…ç½®<code>Nginx</code>:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /weikemsg-web &#123;</div><div class="line">        <span class="attribute">add_header</span> <span class="string">'Access-Control-Allow-Origin'</span> <span class="string">"<span class="variable">$http_origin</span>"</span>;</div><div class="line">        <span class="attribute">add_header</span> <span class="string">'Access-Control-Allow-Credentials'</span> <span class="string">'true'</span>;</div><div class="line">        <span class="attribute">add_header</span> <span class="string">'Access-Control-Allow-Methods'</span> <span class="string">'POST, GET, OPTIONS'</span>;</div><div class="line">        <span class="attribute">proxy_pass</span> http://weikemsg-web/weikemsg-web;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å†æ¬¡è®¿é—®ï¼Œä½†æ˜¯ç»“æœæ²¡æœ‰ä»»ä½•å˜åŒ–</p>
<ol>
<li><strong>ç¬¬ä¸‰æ¬¡å°è¯•è§£å†³</strong></li>
</ol>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fmomo3wo7rj312w09240h.jpg" alt="F570147A-895F-4223-AAD5-4E92C885BAB9"></p>
<p>é‡æ–°è§‚å¯Ÿè¯·æ±‚å¤´ä¿¡æ¯ï¼Œæµè§ˆå™¨å‘é€<code>OPTIONS</code>è¯·æ±‚å¹¶æ²¡æœ‰æºå¸¦<code>Cookie</code>ï¼Œè¯¥è¯·æ±‚è¿›å…¥æœåŠ¡å™¨åè¢«åˆ¤æ–­æœªç™»å½•ï¼Œæ‰€ä»¥ä¸€ç›´è¿”å›<code>401</code>é”™è¯¯ï¼Œé¦–å…ˆéœ€è¦è§£å†³çš„æ˜¯å¤„ç†<code>OPTIONS</code>è¯·æ±‚</p>
<p>é‡æ–°é…ç½®<code>Nginx</code>:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">location ^~ /weikemsg-web &#123;</div><div class="line">        if ($request_method = 'OPTIONS') &#123;</div><div class="line">            return 204; // ç­‰åŒäºè¯·æ±‚æ‰§è¡ŒæˆåŠŸï¼Œä½†æ˜¯æ²¡æœ‰æ•°æ®ï¼Œæµè§ˆå™¨ä¸ç”¨åˆ·æ–°é¡µé¢.ä¹Ÿä¸ç”¨å¯¼å‘æ–°çš„é¡µé¢</div><div class="line">        &#125;</div><div class="line">        add_header 'Access-Control-Allow-Origin' "$http_origin";</div><div class="line">        add_header 'Access-Control-Allow-Credentials' 'true';</div><div class="line">        add_header 'Access-Control-Allow-Methods' 'POST, GET, OPTIONS';</div><div class="line">       </div><div class="line">        proxy_pass http://weikemsg-web/weikemsg-web;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å†æ¬¡è·¨åŸŸè®¿é—®ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fmomo4d3wbj31kw026wfq.jpg" alt="5EC9BD61-4FF4-4ED3-A69F-E73E0E9D0475"></p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fmomo1pawej31040cego7.jpg" alt="676169C7-A9CF-4737-8B1B-25546C423DDB"></p>
<p>è·¨åŸŸçš„é—®é¢˜å·²ç»è§£å†³ï¼Œä½†æ˜¯ç”±äºæˆ‘çš„è¯·æ±‚å¤´ä¸­è®¾ç½®äº†<code>&#39;Content-Type&#39;:&#39;application/json&#39;</code>ï¼Œéœ€è¦æœåŠ¡ç«¯æ”¯æŒè¯¥ç±»å‹</p>
<ol>
<li><strong>ç¬¬ä¸‰æ¬¡å°è¯•è§£å†³: ç»ˆææ–¹æ¡ˆ</strong></li>
</ol>
<p>é‡æ–°é…ç½®<code>Nginx</code>ï¼š</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /weikemsg-web &#123;</div><div class="line">        <span class="attribute">if</span> (<span class="variable">$request_method</span> = <span class="string">'OPTIONS'</span>) &#123;</div><div class="line">            <span class="attribute">return</span> <span class="number">204</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="attribute">add_header</span> <span class="string">'Access-Control-Allow-Origin'</span> <span class="string">"<span class="variable">$http_origin</span>"</span>;</div><div class="line">        <span class="attribute">add_header</span> <span class="string">'Access-Control-Allow-Credentials'</span> <span class="string">'true'</span>;</div><div class="line">        <span class="attribute">add_header</span> <span class="string">'Access-Control-Allow-Methods'</span> <span class="string">'POST, GET, OPTIONS'</span>;</div><div class="line">        <span class="attribute">add_header</span> <span class="string">'Access-Control-Allow-Headers'</span> <span class="string">'Content-Type'</span>;</div><div class="line">        <span class="attribute">proxy_pass</span> http://weikemsg-web/weikemsg-web;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>Access-Control-Allow-Headers</code> ï¼šæŒ‡æ˜äº†å®é™…è¯·æ±‚ä¸­å…è®¸æºå¸¦çš„é¦–éƒ¨å­—æ®µã€‚</li>
</ul>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fmomo20v2qj30t00fotay.jpg" alt="75C9B3DC-40DE-4F2D-BDE3-7E9B8E40E803"></p>
<p>åˆ°æ­¤ï¼Œè·¨åŸŸé—®é¢˜ç»ˆäºè§£å†³äº†</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><code>Ajax</code>è·¨åŸŸå¯ä»¥ç”¨2ç§æ–¹å¼è§£å†³ï¼š<code>Nginx</code>è·¨åŸŸé…ç½®ï¼Œ<a href="https://dailc.github.io/2017/03/22/ajaxCrossDomainSolution.html" target="_blank" rel="external"><code>Java</code>æœåŠ¡ç«¯é…ç½®</a></p>
<h4 id="Nginxè·¨åŸŸé…ç½®-æ¨è"><a href="#Nginxè·¨åŸŸé…ç½®-æ¨è" class="headerlink" title="Nginxè·¨åŸŸé…ç½®(æ¨è)"></a><code>Nginx</code>è·¨åŸŸé…ç½®(æ¨è)</h4><ul>
<li><strong>ç®€å•è·¨åŸŸè¯·æ±‚</strong></li>
</ul>
<p>å¦‚æœéœ€è¦è·¨åŸŸçš„æœåŠ¡æ¥å£æä¾›ç®€å•çš„httpè¯·æ±‚ï¼Œå¯ä»¥åœ¨<code>Nginx</code>ä¸­é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location ^~ /microlesson-web &#123;</div><div class="line">        add_header &apos;Access-Control-Allow-Origin&apos; &quot;*&quot;;</div><div class="line">        add_header &apos;Access-Control-Allow-Methods&apos; &apos;POST, GET, OPTIONS&apos;;</div><div class="line"></div><div class="line">        proxy_pass http://192.168.3.58:9280/microlesson-web;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼šå¦‚æœ<code>http</code>è¯·æ±‚éœ€è¦å¸¦ä¸Š<code>Cookie</code>ï¼Œå¿…é¡»è®¾ç½®<code>Access-Control-Allow-Credentials</code>ä¸º<code>true</code>ï¼ŒåŒæ—¶ä¸èƒ½è®¾ç½®<code>Access-Control-Allow-Origin</code>ä¸º<code>*</code></strong></p>
<p>è·¨åŸŸå‘é€<code>Cookie</code>è¿˜è¦æ±‚<code>Access-Control-Allow-Origin</code><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="external">ä¸å…è®¸ä½¿ç”¨é€šé…ç¬¦</a>ã€‚ äº‹å®ä¸Šä¸ä»…ä¸å…è®¸é€šé…ç¬¦ï¼Œè€Œä¸”<a href="https://www.w3.org/TR/2010/WD-cors-20100727/#resource-sharing-check0" target="_blank" rel="external">åªèƒ½æŒ‡å®šå•ä¸€åŸŸå</a>ï¼š</p>
<blockquote>
<p>If the credentials flag is true and the response includes zero or more than one Access-Control-Allow-Credentials header values return fail and terminate this algorithm. â€“W3C Cross-Origin Resource Sharing</p>
</blockquote>
<p>ä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">location ^~ /microlesson-web &#123;</div><div class="line">        add_header &apos;Access-Control-Allow-Origin&apos; &quot;$http_origin&quot;; //å…è®¸httpè®¿é—®æºåœ°å€</div><div class="line">        add_header &apos;Access-Control-Allow-Credentials&apos; &apos;true&apos;;</div><div class="line">        add_header &apos;Access-Control-Allow-Methods&apos; &apos;POST, GET, OPTIONS&apos;;</div><div class="line">        add_header &apos;Access-Control-Allow-Headers&apos; &apos;Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Mx-ReqToken,X-Requested-With&apos;;</div><div class="line"></div><div class="line">        proxy_pass http://192.168.3.58:9280/microlesson-web;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>éç®€å•è·¨åŸŸè¯·æ±‚</strong></li>
</ul>
<p>é¡¹ç›®ä¸­å¸¸è§çš„éç®€å•è·¨åŸŸè¯·æ±‚ä¸€èˆ¬æ˜¯ï¼š<code>post</code>è¯·æ±‚ï¼Œä»¥åŠ<code>json</code>æ•°æ®ï¼›<code>Nginx</code>é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">location ^~ /microlesson-web &#123;</div><div class="line">   if ($request_method = &apos;OPTIONS&apos;) &#123;</div><div class="line">       add_header Access-Control-Allow-Origin *; </div><div class="line">       add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS;</div><div class="line">       #å…¶ä»–å¤´éƒ¨ä¿¡æ¯é…ç½®ï¼Œçœç•¥...</div><div class="line">       return 204;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">	add_header &apos;Access-Control-Allow-Origin&apos; &quot;$http_origin&quot;;</div><div class="line">	add_header &apos;Access-Control-Allow-Credentials&apos; &apos;true&apos;;</div><div class="line">	add_header &apos;Access-Control-Allow-Methods&apos; &apos;POST, GET, OPTIONS&apos;;</div><div class="line">	add_header &apos;Access-Control-Allow-Headers&apos; &apos;Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Mx-ReqToken,X-Requested-With&apos;;</div><div class="line"></div><div class="line">    proxy_pass http://192.168.3.58:9280/microlesson-web;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…³é”®çš„åœ°æ–¹åœ¨äºå…ˆåˆ¤æ–­è¯·æ±‚ç±»å‹å¦‚æœæ˜¯<code>OPTIONS</code>ï¼Œè®¾ç½®<code>Allow</code>çš„å“åº”å¤´ï¼Œé‡æ–°å¤„ç†è¿™æ¬¡è¯·æ±‚ã€‚</p>
<ul>
<li><strong>è¿‡æ»¤è¯·æ±‚åŸŸå</strong></li>
</ul>
<p>å¦‚æœéœ€è¦æŒ‡å®šä¸€äº›åŸŸåè·¨åŸŸè®¿é—®æœåŠ¡ï¼Œå¯ä»¥å¦‚ä¸‹é…ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">location ^~ /microlesson-web &#123;</div><div class="line">        set $cors &apos;&apos;;</div><div class="line">		if ($http_origin ~* &apos;http?://(localhost|www\.ximalaya\.com)&apos;) &#123;</div><div class="line">        	set $cors &apos;true&apos;;</div><div class="line">		&#125;</div><div class="line">		if ($cors = &apos;true&apos;) &#123;</div><div class="line">        	add_header &apos;Access-Control-Allow-Origin&apos; &quot;$http_origin&quot;;</div><div class="line">        	add_header &apos;Access-Control-Allow-Credentials&apos; &apos;true&apos;;</div><div class="line">        	add_header &apos;Access-Control-Allow-Methods&apos; &apos;GET, POST, OPTIONS&apos;;</div><div class="line">        	add_header &apos;Access-Control-Allow-Headers&apos; &apos;Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Mx-ReqToken,X-Requested-With&apos;;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">        proxy_pass http://192.168.3.58:9280/microlesson-web;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="external">HTTPè®¿é—®æ§åˆ¶(CORS)</a></p>
<p><a href="http://todoit.me/ajax-preflight/" target="_blank" rel="external">ä¸ºä»€ä¹ˆæˆ‘çš„è·¨åŸŸ AJAX å‘äº†ä¸¤ä¸ªè¯·æ±‚?</a></p>
<p><a href="http://kaifage.com/notes/181/configuration-cors-on-nginx.html" target="_blank" rel="external">Nginxé…ç½®æ”¯æŒCORS</a></p>
<p><a href="https://github.com/zhongxia245/blog/issues/33" target="_blank" rel="external">Nginxè·¨åŸŸé…ç½®</a></p>
<p><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="external">è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£</a></p>
<p><a href="https://dailc.github.io/2017/03/22/ajaxCrossDomainSolution.html" target="_blank" rel="external">ajaxè·¨åŸŸè§£å†³æ–¹æ¡ˆ</a></p>
<p><a href="http://harttle.land/2016/12/28/cors-with-cookie.html" target="_blank" rel="external">CORS è·¨åŸŸå‘é€ Cookie</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Spring AOPæºç åˆ†æ]]></title>
      <url>http://zsr.github.io/2017/11/30/Spring-AOP%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<p>å¯åŠ¨<code>Spring AOP</code>éœ€è¦é…ç½® <code>&lt;aop:config&gt;</code> æ ‡ç­¾æˆ–è€…<code>aspectj-autoproxy</code>æ ‡ç­¾</p>
<h3 id="lt-aop-gt-æ ‡ç­¾è§£æ"><a href="#lt-aop-gt-æ ‡ç­¾è§£æ" class="headerlink" title="&lt;aop&gt;æ ‡ç­¾è§£æ"></a><code>&lt;aop&gt;</code>æ ‡ç­¾è§£æ</h3><p>å¦‚æœä½¿ç”¨<code>&lt;aop:xxxx /&gt;</code>æ ‡ç­¾æ¥è‡ªåŠ¨ç”Ÿæˆä»£ç†çš„è¯ï¼Œå…¥å£ç¨‹åºæ˜¯<code>AopNamespaceHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">// In 2.0 XSD as well as in 2.1 XSD.</span></div><div class="line">  registerBeanDefinitionParser(<span class="string">"config"</span>, <span class="keyword">new</span> ConfigBeanDefinitionParser());</div><div class="line">  registerBeanDefinitionParser(<span class="string">"aspectj-autoproxy"</span>, <span class="keyword">new</span> AspectJAutoProxyBeanDefinitionParser());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœä½¿ç”¨äº†<code>&lt;aop:config&gt;</code>æ ‡ç­¾ï¼Œä½¿ç”¨ <code>ConfigBeanDefinitionParser</code> è§£æ</li>
<li>å¦‚æœä½¿ç”¨äº†<code>&lt;aop:aspectj-autoproxy&gt;</code>æ ‡ç­¾ï¼Œä½¿ç”¨ <code>AspectJAutoProxyBeanDefinitionParser</code> è§£æ</li>
</ul>
<h3 id="ç±»ç»“æ„å›¾"><a href="#ç±»ç»“æ„å›¾" class="headerlink" title="ç±»ç»“æ„å›¾"></a>ç±»ç»“æ„å›¾</h3><p>è¿™é‡Œæ”¾ä¸€å¼ <code>Spring AOP</code>ä»£ç†è‡ªåŠ¨ç”Ÿæˆå™¨çš„ç±»å›¾</p>
<ul>
<li><code>&lt;aop:config&gt;</code>æ–¹å¼ä½¿ç”¨<code>AspectJAwareAdvisorAutoProxyCreator</code>åˆ›å»ºä»£ç†ï¼Œ`</li>
<li><code>&lt;aop:aspectj-autoproxy&gt;</code>ä½¿ç”¨<code>AnnotationAwareAspectJAutoProxyCreator</code>åˆ›å»ºä»£ç†ï¼Œå…·ä½“è§ä¸‹æ–‡</li>
</ul>
<p><img src="http://img.my.csdn.net/uploads/201303/04/1362374823_4701.png" alt="img"></p>
<a id="more"></a>
<h3 id="aop-config-è§£æ"><a href="#aop-config-è§£æ" class="headerlink" title="aop:config`è§£æ"></a>aop:config`è§£æ</h3><ul>
<li><code>ConfigBeanDefinitionParser.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</div><div class="line">		CompositeComponentDefinition compositeDef =</div><div class="line">				<span class="keyword">new</span> CompositeComponentDefinition(element.getTagName(), parserContext.extractSource(element));</div><div class="line">		parserContext.pushContainingComponent(compositeDef);</div><div class="line"></div><div class="line">        <span class="comment">// æ³¨å†ŒAspectJAwareAdvisorAutoProxyCreator</span></div><div class="line">		configureAutoProxyCreator(parserContext, element);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureAutoProxyCreator</span><span class="params">(ParserContext parserContext, Element element)</span> </span>&#123;</div><div class="line">		AopNamespaceUtils.registerAspectJAutoProxyCreatorIfNecessary(parserContext, element);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>AopNamespaceUtils.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerAspectJAutoProxyCreatorIfNecessary</span><span class="params">(</span></span></div><div class="line">			ParserContext parserContext, Element sourceElement) &#123;</div><div class="line"><span class="comment">// æ³¨å†Œæˆ–æ›´æ–° AutoProxyCreator å®šä¹‰ beanName ä¸º org.Springframework.aop.config.internalAutoProxyCreatorçš„BeanDefinition</span></div><div class="line"><span class="comment">// å¦‚æœinternalAutoProxyCreatorçš„BeanDefinitionå·²ç»å­˜åœ¨ï¼Œåˆ™æ ¹æ®ä¼˜å…ˆçº§æ›´æ–°BeanDefinition</span></div><div class="line"><span class="comment">// åœ¨è¿™é‡Œæ³¨å†Œçš„æ˜¯AspectJAwareAdvisorAutoProxyCreator</span></div><div class="line">		BeanDefinition beanDefinition = AopConfigUtils.registerAspectJAutoProxyCreatorIfNecessary(</div><div class="line">				parserContext.getRegistry(), parserContext.extractSource(sourceElement));</div><div class="line">  </div><div class="line">        <span class="comment">// å¯¹äºproxy-target-classä»¥åŠexpose-proxyå±æ€§çš„å¤„ç†</span></div><div class="line">		useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement);</div><div class="line">        <span class="comment">// æ³¨å†Œç»„ä»¶ï¼Œå…¶ä¸­beanDefinitionçš„classNameä¸ºAspectJAwareAdvisorAutoProxyCreator</span></div><div class="line">		registerComponentIfNecessary(beanDefinition, parserContext);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>AspectJAwareAdvisorAutoProxyCreator.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AspectJAwareAdvisorAutoProxyCreator</span> <span class="keyword">extends</span> <span class="title">AbstractAdvisorAutoProxyCreator</span></span></div><div class="line">  </div><div class="line"><span class="title">public</span> <span class="title">abstract</span> <span class="title">class</span> <span class="title">AbstractAdvisorAutoProxyCreator</span> <span class="keyword">extends</span> <span class="title">AbstractAutoProxyCreator</span></div><div class="line">  </div><div class="line"><span class="title">public</span> <span class="title">abstract</span> <span class="title">class</span> <span class="title">AbstractAutoProxyCreator</span> <span class="keyword">extends</span> <span class="title">ProxyConfig</span></div><div class="line">		<span class="keyword">implements</span> <span class="title">SmartInstantiationAwareBeanPostProcessor</span>, <span class="title">BeanClassLoaderAware</span>, <span class="title">BeanFactoryAware</span>,</div><div class="line">		<span class="title">Ordered</span>, <span class="title">AopInfrastructureBean</span></div><div class="line">  </div><div class="line"><span class="title">public</span> <span class="title">interface</span> <span class="title">SmartInstantiationAwareBeanPostProcessor</span> <span class="keyword">extends</span> <span class="title">InstantiationAwareBeanPostProcessor</span></div></pre></td></tr></table></figure>
<p>å¯è§<code>AspectJAwareAdvisorAutoProxyCreator</code>å®ç°äº†<code>BeanPostProcessor</code>æ¥å£ï¼Œ<code>BeanPostProcessor</code>ä¸»è¦ä½œç”¨äº<code>Bean</code>å®ä¾‹åŒ–åï¼Œåˆå§‹åŒ–å‰åï¼Œæ‰€æœ‰çš„<code>Bean</code>éƒ½è¢«ä½œç”¨åˆ°ã€‚<code>InstantiationAwareBeanPostProcessor</code>è™½ç„¶æ˜¯<code>BeanPostProcessor</code>çš„å­æ¥å£ï¼Œä½†å®ƒçš„è°ƒç”¨æ—¶é—´ç‚¹å‘ç”Ÿåœ¨Beanå®ä¾‹åŒ–å‰ï¼Œåœ¨çœŸæ­£è°ƒç”¨<code>doCreateBean()</code>åˆ›å»ºbeanå®ä¾‹ä¹‹å‰æ‰§è¡Œ<code>postProcessBeforeInstantiation()</code></p>
<ul>
<li><code>postProcessBeforeInstantiation()</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractAutoProxyCreator.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">         <span class="comment">//1ã€å¾—åˆ°ä¸€ä¸ªç¼“å­˜çš„å”¯ä¸€keyï¼ˆæ ¹æ®beanClasså’ŒbeanNameç”Ÿæˆå”¯ä¸€keyï¼‰</span></div><div class="line">		Object cacheKey = getCacheKey(beanClass, beanName);</div><div class="line">        <span class="comment">//2ã€å¦‚æœå½“å‰targetSourcedBeansï¼ˆé€šè¿‡è‡ªå®šä¹‰TargetSourceCreatoråˆ›å»ºçš„TargetSourceï¼‰ä¸åŒ…å«cacheKey </span></div><div class="line">		<span class="keyword">if</span> (beanName == <span class="keyword">null</span> || !<span class="keyword">this</span>.targetSourcedBeans.containsKey(beanName)) &#123;</div><div class="line">            <span class="comment">//2.1ã€advisedBeansï¼ˆå·²ç»è¢«å¢å¼ºçš„Beanï¼Œå³AOPä»£ç†å¯¹è±¡ï¼‰ä¸­åŒ…å«å½“å‰cacheKeyï¼Œè¿”å›nullï¼Œå³èµ°Springé»˜è®¤æµç¨‹  </span></div><div class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.advisedBeans.containsKey(cacheKey)) &#123;</div><div class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">			&#125;</div><div class="line">            <span class="comment">//2.2ã€å¦‚æœæ˜¯åŸºç¡€è®¾æ–½ç±»ï¼ˆå¦‚Advisorã€Adviceã€AopInfrastructureBeançš„å®ç°ï¼‰ä¸è¿›è¡Œå¤„ç†  </span></div><div class="line">            <span class="comment">//2.2ã€shouldSkip é»˜è®¤falseï¼Œå¯ä»¥ç”Ÿæˆå­ç±»è¦†ç›–ï¼Œå¦‚AspectJAwareAdvisorAutoProxyCreatorè¦†ç›–ï¼ˆif (((AbstractAspectJAdvice) advisor.getAdvice()).getAspectName().equals(beanName)) return true;  å³å¦‚æœæ˜¯è‡ªå·±å°±è·³è¿‡ï¼‰  </span></div><div class="line">			<span class="keyword">if</span> (isInfrastructureClass(beanClass) || shouldSkip(beanClass, beanName)) &#123;</div><div class="line">				<span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">        <span class="comment">//3ã€å¼€å§‹åˆ›å»ºAOPä»£ç†å¯¹è±¡  </span></div><div class="line">		<span class="keyword">if</span> (beanName != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//3.1ã€é…ç½®è‡ªå®šä¹‰çš„TargetSourceCreatorè¿›è¡ŒTargetSourceåˆ›å»º </span></div><div class="line">			TargetSource targetSource = getCustomTargetSource(beanClass, beanName);</div><div class="line">            <span class="comment">//3.2ã€å¦‚æœtargetSourceä¸ä¸ºnull æ·»åŠ åˆ°targetSourcedBeansç¼“å­˜ï¼Œå¹¶åˆ›å»ºAOPä»£ç†å¯¹è±¡</span></div><div class="line">			<span class="keyword">if</span> (targetSource != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">this</span>.targetSourcedBeans.put(beanName, Boolean.TRUE);</div><div class="line">               <span class="comment">// specificInterceptorså³å¢å¼ºï¼ˆåŒ…æ‹¬å‰ç½®å¢å¼ºã€åç½®å¢å¼ºç­‰ç­‰ï¼‰  </span></div><div class="line">				Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource);</div><div class="line">              <span class="comment">//3.3ã€åˆ›å»ºä»£ç†å¯¹è±¡  </span></div><div class="line">				Object proxy = createProxy(beanClass, beanName, specificInterceptors, targetSource);</div><div class="line">              <span class="comment">//3.4ã€å°†ä»£ç†ç±»å‹æ”¾å…¥proxyTypesä»è€Œå…è®¸åç»­çš„predictBeanType()è°ƒç”¨è·å–  </span></div><div class="line">				<span class="keyword">this</span>.proxyTypes.put(cacheKey, proxy.getClass());</div><div class="line">				<span class="keyword">return</span> proxy;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬é…ç½®<code>TargetSourceCreator</code>è¿›è¡Œè‡ªå®šä¹‰<code>TargetSource</code>åˆ›å»ºæ—¶ï¼Œä¼šåˆ›å»ºä»£ç†å¯¹è±¡å¹¶ä¸­æ–­é»˜è®¤<code>Spring</code>åˆ›å»ºæµç¨‹(ç›®æ ‡å¯¹è±¡æ²¡æœ‰åˆ›å»ºï¼Œå¯è§<code>bean</code>åˆ›å»ºè¿‡ç¨‹: <code>BeanDefinitionValueResolver.resolveInnerBean()</code>)ã€‚</p>
<ul>
<li><code>getEarlyBeanReference()</code></li>
</ul>
<p><code>Spring Bean</code>å®ä¾‹åŒ–è¿‡ç¨‹ï¼Œè§£å†³å•ä¾‹<code>bean</code>ä¹‹é—´çš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œæå‰å°†ä»£ç†å¯¹è±¡æš´éœ²å‡ºå»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractAutoProxyCreator.java</span></div><div class="line"><span class="comment">//è·å–early Beanå¼•ç”¨ï¼ˆåªæœ‰å•ä¾‹Beanåœ¨åˆ›å»ºï¼‰  </span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getEarlyBeanReference</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;  </div><div class="line">    Object cacheKey = getCacheKey(bean.getClass(), beanName);  </div><div class="line">    <span class="comment">//1ã€å°†cacheKeyæ·»åŠ åˆ°earlyProxyReferencesç¼“å­˜ï¼Œä»è€Œé¿å…å¤šæ¬¡é‡å¤åˆ›å»º  </span></div><div class="line">    <span class="keyword">this</span>.earlyProxyReferences.add(cacheKey);  </div><div class="line">    <span class="comment">//2ã€åŒ…è£…ç›®æ ‡å¯¹è±¡åˆ°AOPä»£ç†å¯¹è±¡ï¼ˆå¦‚æœéœ€è¦ï¼‰  </span></div><div class="line">    <span class="keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯¦ç»†å¯è§<code>bean</code>åˆ›å»ºè¿‡ç¨‹ï¼š<code>AbstractAutowireCapableBeanFactory.doCreateBean() =&gt; getEarlyBeanReference()</code></p>
<ul>
<li><strong><code>postProcessAfterInitialization()</code>ï¼šåˆ›å»ºAOPä»£ç†</strong></li>
</ul>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä»£ç†æ˜¯é€šè¿‡<code>AbstractAutoProxyCreator</code>ä¸­çš„<code>postProcessAfterInitialization()</code>åˆ›å»ºçš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractAutoProxyCreator.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</div><div class="line">			Object cacheKey = getCacheKey(bean.getClass(), beanName);</div><div class="line">          <span class="comment">//1ã€å¦‚æœä¹‹å‰è°ƒç”¨è¿‡getEarlyBeanReferenceè·å–åŒ…è£…ç›®æ ‡å¯¹è±¡åˆ°AOPä»£ç†å¯¹è±¡ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œåˆ™ä¸å†æ‰§è¡Œ  </span></div><div class="line">			<span class="keyword">if</span> (!<span class="keyword">this</span>.earlyProxyReferences.containsKey(cacheKey)) &#123;</div><div class="line">              <span class="comment">//2ã€åŒ…è£…ç›®æ ‡å¯¹è±¡åˆ°AOPä»£ç†å¯¹è±¡ï¼ˆå¦‚æœéœ€è¦ï¼‰  </span></div><div class="line">				<span class="keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> bean;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">wrapIfNecessary</span><span class="params">(Object bean, String beanName, Object cacheKey)</span> </span>&#123;</div><div class="line">        <span class="comment">//é€šè¿‡TargetSourceCreatorè¿›è¡Œè‡ªå®šä¹‰TargetSourceä¸éœ€è¦åŒ…è£…  </span></div><div class="line">		<span class="keyword">if</span> (beanName != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.targetSourcedBeans.containsKey(beanName)) &#123;</div><div class="line">			<span class="keyword">return</span> bean;</div><div class="line">		&#125;</div><div class="line">        <span class="comment">//ä¸åº”è¯¥è¢«å¢å¼ºå¯¹è±¡ä¸éœ€è¦åŒ…è£… </span></div><div class="line">		<span class="keyword">if</span> (Boolean.FALSE.equals(<span class="keyword">this</span>.advisedBeans.get(cacheKey))) &#123;</div><div class="line">			<span class="keyword">return</span> bean;</div><div class="line">		&#125;</div><div class="line">        <span class="comment">//åŸºç¡€è®¾æ–½æˆ–åº”è¯¥skipçš„ä¸éœ€è¦ä¿è¯</span></div><div class="line">		<span class="keyword">if</span> (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName))     &#123;</div><div class="line">			<span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</div><div class="line">			<span class="keyword">return</span> bean;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// å¦‚æœæœ‰å¢å¼ºå°±æ‰§è¡ŒåŒ…è£…ç›®æ ‡å¯¹è±¡åˆ°ä»£ç†å¯¹è±¡</span></div><div class="line">		Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="keyword">null</span>);</div><div class="line">		<span class="keyword">if</span> (specificInterceptors != DO_NOT_PROXY) &#123;</div><div class="line">            <span class="comment">// å°†cacheKeyæ·»åŠ åˆ°å·²ç»è¢«å¢å¼ºåˆ—è¡¨ï¼Œé˜²æ­¢å¤šæ¬¡å¢å¼º</span></div><div class="line">			<span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);</div><div class="line">            <span class="comment">// åˆ›å»ºä»£ç†å¯¹è±¡  </span></div><div class="line">			Object proxy = createProxy(bean.getClass(), beanName, specificInterceptors, <span class="keyword">new</span> SingletonTargetSource(bean));</div><div class="line">            <span class="comment">// ç¼“å­˜ä»£ç†ç±»å‹</span></div><div class="line">			<span class="keyword">this</span>.proxyTypes.put(cacheKey, proxy.getClass());</div><div class="line">			<span class="keyword">return</span> proxy;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</div><div class="line">		<span class="keyword">return</span> bean;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡º <code>getEarlyBeanReference</code>å’Œ<code>postProcessAfterInitialization</code>æ˜¯äºŒè€…é€‰ä¸€çš„ï¼Œè€Œä¸”å•ä¾‹<code>Bean</code>ç›®æ ‡å¯¹è±¡åªèƒ½è¢«å¢å¼ºä¸€æ¬¡</p>
<p>å½“<code>SimpleServiceImpl bean</code>åˆå§‹åŒ–åˆ°è¿™æ­¥åï¼Œä¼šä»å®¹å™¨ä¸­æ‰¾å‡ºæ‰€æœ‰åŒ¹é…å½“å‰<code>bean</code>çš„é€šçŸ¥ï¼ˆå¦‚æœæœ‰å¯¹ä¸šåŠ¡æ–¹æ³•åšå¢å¼ºå¤„ç†ï¼‰ï¼Œå¦‚æœæ‰¾åˆ°å¯¹åº”çš„é€šçŸ¥åˆ™åˆ›å»ºä»£ç†ã€‚</p>
<ul>
<li><code>createAopProxy()</code></li>
</ul>
<p>å…·ä½“æ€ä¹ˆåˆ›å»ºä»£ç†ä»¥åŠç”¨å“ªç§æ–¹å¼åˆ›å»ºä»£ç†ï¼Œç”± <code>createAopProxy</code> å†³å®š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultAopProxyFactory.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> AopProxy <span class="title">createAopProxy</span><span class="params">(AdvisedSupport config)</span> <span class="keyword">throws</span> AopConfigException </span>&#123;</div><div class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰å®ç°æ¥å£æˆ–è€…è®¾ç½®proxy-target-class=true, é‡‡ç”¨CGLIBä»£ç†</span></div><div class="line">		<span class="keyword">if</span> (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123;</div><div class="line">			Class targetClass = config.getTargetClass();</div><div class="line">			<span class="keyword">if</span> (targetClass == <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">"TargetSource cannot determine target class: "</span> +</div><div class="line">						<span class="string">"Either an interface or a target is required for proxy creation."</span>);</div><div class="line">			&#125;</div><div class="line">            <span class="comment">// å¦‚æœç›®æ ‡ç±»æ˜¯æ¥å£, ä½¿ç”¨JDKåŠ¨æ€ä»£ç†æ¥ç”Ÿæˆä»£ç†ç±»</span></div><div class="line">			<span class="keyword">if</span> (targetClass.isInterface()) &#123;</div><div class="line">				<span class="keyword">return</span> <span class="keyword">new</span> JdkDynamicAopProxy(config);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> CglibProxyFactory.createCglibProxy(config);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> JdkDynamicAopProxy(config);</div><div class="line">		&#125;</div></pre></td></tr></table></figure>
<h3 id="aspectj-autoproxyæ ‡ç­¾è§£æ"><a href="#aspectj-autoproxyæ ‡ç­¾è§£æ" class="headerlink" title="aspectj-autoproxyæ ‡ç­¾è§£æ"></a><code>aspectj-autoproxy</code>æ ‡ç­¾è§£æ</h3><ul>
<li><code>AspectJAutoProxyBeanDefinitionParser.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</div><div class="line">        <span class="comment">// æ³¨å†ŒAnnotationAwareAspectJAutoProxyCreator</span></div><div class="line">		AopNamespaceUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(parserContext, element);</div><div class="line">		extendBeanDefinition(element, parserContext);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>AopNamespaceUtils.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="params">(</span></span></div><div class="line">			ParserContext parserContext, Element sourceElement) &#123;</div><div class="line">    <span class="comment">// æ³¨å†Œæˆ–æ›´æ–° AutoProxyCreator å®šä¹‰ beanName ä¸º org.Springframework.aop.config.internalAutoProxyCreatorçš„BeanDefinition</span></div><div class="line">    <span class="comment">// å¦‚æœinternalAutoProxyCreatorçš„BeanDefinitionå·²ç»å­˜åœ¨ï¼Œè€Œæ ¹æ®ä¼˜å…ˆçº§æ›´æ–°BeanDefinition</span></div><div class="line">    <span class="comment">// åœ¨è¿™é‡Œæ³¨å†Œçš„æ˜¯AnnotationAwareAspectJAutoProxyCreator</span></div><div class="line">		BeanDefinition beanDefinition = AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(</div><div class="line">				parserContext.getRegistry(), parserContext.extractSource(sourceElement));</div><div class="line">		useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement);</div><div class="line">        <span class="comment">// æ³¨å†Œç»„ä»¶</span></div><div class="line">		registerComponentIfNecessary(beanDefinition, parserContext);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>AnnotationAwareAspectJAutoProxyCreator.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationAwareAspectJAutoProxyCreator</span> <span class="keyword">extends</span> <span class="title">AspectJAwareAdvisorAutoProxyCreator</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥å‘ç°<code>AnnotationAwareAspectJAutoProxyCreator</code>ç»§æ‰¿äº†<code>AspectJAwareAdvisorAutoProxyCreator</code>ï¼Œ æ‰§è¡Œæµç¨‹å’Œ<code>aop:config</code>åŸºæœ¬ä¸€è‡´ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„æ³¨è§£çš„ç‰¹æ®Šæ ‡ç­¾<code>@Aspect</code>ï¼Œä¸‹é¢åˆ†æ<code>@Aspect</code>æ³¨è§£æ˜¯å¦‚ä½•èµ·ä½œç”¨çš„ï¼Ÿ</p>
<p>ä½¿ç”¨æ³¨è§£é…ç½®<code>AOP</code>ï¼Œéœ€è¦åœ¨åˆ‡é¢ç±»ä¸­é…ç½®<code>@Aspect</code>ï¼Œå†æ¥çœ‹çœ‹<code>AOP</code>ä»£ç†ç”Ÿæˆè¿‡ç¨‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractAutoProxyCreator.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">wrapIfNecessary</span><span class="params">(Object bean, String beanName, Object cacheKey)</span> </span>&#123;</div><div class="line">    <span class="comment">// è·å–è¯¥ç±»æ‰€æœ‰å¢å¼º</span></div><div class="line">    Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸ç®¡æ˜¯<code>aop:config</code>è¿˜æ˜¯<code>aspectj-autoproxy</code>éƒ½æ˜¯ç”±<code>AbstractAutoProxyCreator</code>è¿™ä¸ªç±»åœ¨åç½®å¤„ç†å™¨ä¸­ç”Ÿæˆ<code>AOP</code>ä»£ç†ï¼Œå…·ä½“çœ‹çœ‹<code>getadvicesAndAdvisorsForBean()</code>æ–¹æ³•æ˜¯å¦‚ä½•è·å–å¢å¼º</p>
<ul>
<li><code>getAdvicesAndAdvisorsForBean()</code></li>
</ul>
<p><code>getAdvicesAndAdvisorsForBean()</code>æ–¹æ³•å…·ä½“ç”±å­ç±»<code>AbstractAdvisorAutoProxyCreator</code>å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractAdvisorAutoProxyCreator.class</span></div><div class="line"><span class="keyword">protected</span> Object[] getAdvicesAndAdvisorsForBean(Class&lt;?&gt; beanClass, String beanName, TargetSource targetSource) &#123;</div><div class="line">		List&lt;Advisor&gt; advisors = findEligibleAdvisors(beanClass, beanName);</div><div class="line">		<span class="keyword">if</span> (advisors.isEmpty()) &#123;</div><div class="line">			<span class="keyword">return</span> DO_NOT_PROXY;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> advisors.toArray();</div><div class="line">	&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> List&lt;Advisor&gt; <span class="title">findEligibleAdvisors</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> </span>&#123;</div><div class="line">        <span class="comment">// æ‰¾åˆ°å®¹å™¨ä¸­æ‰€æœ‰å¢å¼º</span></div><div class="line">		List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors();</div><div class="line">        <span class="comment">// ä»æ‰€æœ‰å¢å¼ºä¸­æ‰¾å‡ºæŒ‡å®šç±»(æ­£å¸¸ä¸šåŠ¡ç±»)çš„å¢å¼º</span></div><div class="line">		List&lt;Advisor&gt; eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName);</div><div class="line">		extendAdvisors(eligibleAdvisors);</div><div class="line">		<span class="keyword">if</span> (!eligibleAdvisors.isEmpty()) &#123;</div><div class="line">			eligibleAdvisors = sortAdvisors(eligibleAdvisors);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> eligibleAdvisors;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>findCandidateAdvisors</code>æ–¹æ³•ï¼Œå¦‚æœé…ç½®<code>aop:config</code>åˆ™ç”±<code>AbstractAdvisorAutoProxyCreator</code>æœ¬ç±»ä¸­å®ç°ï¼Œå¦‚æœé…ç½®<code>aspectj-autoproxy</code>åˆ™ç”±<code>AnnotationAwareAspectJAutoProxyCreator</code>å­ç±»ä¸­å®ç°ã€‚ç°åœ¨æ¥çœ‹çœ‹å­ç±»å®ç°ï¼š</p>
<ul>
<li><code>findCandidateAdvisors()</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AnnotationAwareAspectJAutoProxyCreator.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> List&lt;Advisor&gt; <span class="title">findCandidateAdvisors</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">// å½“ä½¿ç”¨æ³¨è§£æ–¹å¼é…ç½®AOPçš„æ—¶å€™å¹¶ä¸æ˜¯ä¸¢å¼ƒäº†å¯¹xmlçš„é…ç½®ï¼Œè°ƒç”¨çˆ¶ç±»åŠ è½½é…ç½®æ–‡ä»¶ä¸­çš„AOPå£°æ˜</span></div><div class="line">		List&lt;Advisor&gt; advisors = <span class="keyword">super</span>.findCandidateAdvisors();</div><div class="line">		<span class="comment">// å¦‚æœä½¿ç”¨äº†aspectJæ³¨è§£é…ç½®aop</span></div><div class="line">		advisors.addAll(<span class="keyword">this</span>.aspectJAdvisorsBuilder.buildAspectJAdvisors());</div><div class="line">		<span class="keyword">return</span> advisors;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>ä»æ–¹æ³•ä¸­<code>aop</code>å¯ä»¥é…ç½®åœ¨<code>xml</code>ä¸­ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨æ³¨è§£ï¼Œ2è¿™éƒ½ä¼šåŒæ—¶ç”Ÿæ•ˆã€‚</p>
<h3 id="ç›®æ ‡å¯¹è±¡"><a href="#ç›®æ ‡å¯¹è±¡" class="headerlink" title="ç›®æ ‡å¯¹è±¡"></a>ç›®æ ‡å¯¹è±¡</h3><ul>
<li>é…ç½®å¢å¼º</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DoBeforeAspect</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Before</span>(<span class="string">"execution(* com.zsr.test.aop.SimpleService.sayHello(..))"</span>)</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doBefore</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</div><div class="line"></div><div class="line">    System.out.println(<span class="string">"***AspectJ*** DoBefore() is running!! intercepted : "</span> + joinPoint.getSignature().getName());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ä¸šåŠ¡é€»è¾‘</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(<span class="string">"simpleService"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleServiceImpl</span> <span class="keyword">implements</span> <span class="title">SimpleService</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"SimpleService : Method sayHello() : Hello "</span> + message);</div><div class="line">    <span class="keyword">return</span> message;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>æµ‹è¯•å‘ç°å½“é…ç½®äº†å¢å¼ºåï¼Œå†å»å®¹å™¨ä¸­è·å–ç›®æ ‡<code>bean</code>ï¼Œç»“æœè¯¥<code>bean</code>å…¶å®æ˜¯ä¸ªä»£ç†ï¼Œä»£ç†æœ€ç»ˆè¿˜æ˜¯è¦é€šè¿‡æ‰§è¡Œ<code>invoke()</code>æ–¹æ³•è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„<code>sayHello()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆç›®æ ‡å¯¹è±¡åˆ°åº•æ”¾åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Ÿ</strong></p>
<h4 id="ä»£ç†æ¨¡å¼"><a href="#ä»£ç†æ¨¡å¼" class="headerlink" title="ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h4><p>ä¸‹é¢æ˜¯ä»£ç†æ¨¡å¼çš„ç»“æ„ï¼š</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1735418-ad5e3aed11ebc4b4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt="img"></p>
<ul>
<li>Subjectï¼šæŠ½è±¡ä¸»é¢˜ï¼Œå®ƒæ˜¯ä»£ç†å¯¹è±¡çš„çœŸå®å¯¹è±¡è¦å®ç°çš„æ¥å£ï¼Œå½“ç„¶è¿™å¯ä»¥æ˜¯å¤šä¸ªæ¥å£ç»„æˆ</li>
<li>Proxyï¼šä»£ç†ç±»é™¤äº†å®ç°æŠ½è±¡ä¸»é¢˜å®šä¹‰çš„æ¥å£å¤–ï¼Œè¿˜å¿…é¡»æŒæœ‰æ‰€ä»£ç†å¯¹è±¡çš„å¼•ç”¨</li>
<li>RealSubjectï¼šè¢«ä»£ç†çš„ç±»ï¼Œæ˜¯ç›®æ ‡å¯¹è±¡</li>
</ul>
<h4 id="JdkDynamicAopProxy"><a href="#JdkDynamicAopProxy" class="headerlink" title="JdkDynamicAopProxy"></a><code>JdkDynamicAopProxy</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkDynamicAopProxy</span> <span class="keyword">implements</span> <span class="title">AopProxy</span>, <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/** Config used to configure this proxy */</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AdvisedSupport advised;</div><div class="line">  </div><div class="line">  <span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">      <span class="comment">// è¿™é‡Œä¼šå»æ‰§è¡Œå¢å¼ºå’Œç›®æ ‡å¯¹è±¡æ–¹æ³•</span></div><div class="line">      <span class="comment">// Get the interception chain for this method.</span></div><div class="line">			List&lt;Object&gt; chain = <span class="keyword">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</div><div class="line">      </div><div class="line">      <span class="keyword">if</span> (chain.isEmpty()) &#123;</div><div class="line">				Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);</div><div class="line">				retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse);</div><div class="line">			&#125;</div><div class="line">	  <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// We need to create a method invocation...</span></div><div class="line">				invocation = <span class="keyword">new</span> ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);</div><div class="line">				<span class="comment">// Proceed to the joinpoint through the interceptor chain.</span></div><div class="line">				retVal = invocation.proceed();</div><div class="line">			&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„<code>JdkDynamicAopProxy</code>æŒæœ‰çš„<code>AdvisedSupport</code>å®ä¾‹ï¼Œ<code>AdvisedSupport</code>ç±»ä¸­åŒ…å«äº†ä¸€ä¸ª<code>TargetSource</code>å®ä¾‹ï¼Œç›®æ ‡å¯¹è±¡å°±åœ¨<code>TargetSource</code>ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ä»£ç†é—´æ¥æŒæœ‰äº†ç›®æ ‡å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdvisedSupport</span> <span class="keyword">extends</span> <span class="title">ProxyConfig</span> <span class="keyword">implements</span> <span class="title">Advised</span> </span>&#123;</div><div class="line">  TargetSource targetSource = EMPTY_TARGET_SOURCE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å›è¿‡å¤´æ¥ï¼Œå†çœ‹çœ‹åŠ¨æ€ä»£ç†çš„åˆ›å»ºè¿‡ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractAutoProxyCreator.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">wrapIfNecessary</span><span class="params">(Object bean, String beanName, Object cacheKey)</span> </span>&#123;</div><div class="line">       <span class="comment">// åˆ›å»ºä»£ç†å¯¹è±¡  </span></div><div class="line">	   Object proxy = createProxy(bean.getClass(), beanName, specificInterceptors, <span class="keyword">new</span> SingletonTargetSource(bean));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœ‹åˆ°è¿™é‡Œçš„<code>SingletonTargetSource</code>å°±æ˜¯<code>TargetSource</code>çš„å®ç°ç±»ï¼Œå…¶å®åœ¨åˆ›å»ºä»£ç†çš„æ—¶å€™å°±å·²ç»æŠŠç›®æ ‡å¯¹è±¡æ”¾åˆ°<code>TargetSource</code>ä¸­ï¼Œæ¢å¥è¯è¯´ï¼Œ<strong>proxyï¼ˆä»£ç†å¯¹è±¡ï¼‰ä»£ç†çš„ä¸æ˜¯targetï¼Œè€Œæ˜¯TargetSource</strong></p>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li><strong>ç›®æ ‡beançš„ç”Ÿå‘½å‘¨æœŸä¸å—<code>Spring</code>å®¹å™¨ç®¡ç†ï¼Œæˆ‘ä»¬ä»¥å¾€çš„<code>XML</code>ä¸­çš„<code>AOP</code>é…ç½®ï¼Œåªæ˜¯å¯¹å—å®¹å™¨ç®¡ç†çš„<code>bean</code>è€Œè¨€çš„</strong></li>
<li><strong>ä»£ç†ç±»ä¼šä»£ç†æ¥å£ä¸­æ‰€æœ‰æ–¹æ³•ï¼Œéå¢å¼ºæ–¹æ³•åŒæ ·éœ€è¦é€šè¿‡ä»£ç†ç±»å»è®¿é—®(åªæ˜¯æ²¡æœ‰æ‰§è¡Œå¢å¼ºåˆ‡é¢)</strong></li>
<li><strong><code>Spring</code>çš„<code>AOP</code>æ¡†æ¶é»˜è®¤ä¸ºç›®æ ‡beanåˆ›å»ºé™æ€ç›®æ ‡æº<code>SingletonTargetSource</code>ï¼Œå¦‚æœbeanè¢«é…ç½®ä¸º<code>prototype</code>ï¼Œåˆ™<code>spring</code>ä¼šåœ¨æ¯æ¬¡<code>getBean</code>æ—¶åˆ›å»ºæ–°çš„<code>SingletonTargetSource</code>å®ä¾‹</strong></li>
</ul>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.jianshu.com/p/867991f3daa0" target="_blank" rel="external">Spring AOPæºç è§£è¯»1 - ç¨‹åºå…¥å£</a></p>
<p><a href="https://my.oschina.net/lixin91/blog/688188?p=1" target="_blank" rel="external">spring-aopç»„ä»¶è¯¦è§£â€”â€”TargetSourceç›®æ ‡æº</a></p>
<p><a href="http://www.jianshu.com/p/ef8c828798ca" target="_blank" rel="external">Springæºç -AOP(ä¸ƒ)-å¢å¼ºå™¨çš„è·å–</a></p>
<p><a href="http://jinnianshilongnian.iteye.com/blog/1492424" target="_blank" rel="external">Springå¼€é—­åŸåˆ™çš„è¡¨ç°-BeanPostProcessoræ‰©å±•ç‚¹-2</a></p>
<p><a href="https://fangjian0423.github.io/2017/06/20/spring-bean-post-processor/" target="_blank" rel="external">Springå†…éƒ¨çš„BeanPostProcessoræ¥å£æ€»ç»“</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Spring AOPé…ç½®]]></title>
      <url>http://zsr.github.io/2017/11/29/Spring-AOP%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<p>å‰æ–‡ä»‹ç»äº†<code>Spring AOP</code>çš„ä¸€äº›æ¦‚å¿µï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»<code>Spring AOP</code>çš„ä½¿ç”¨æ–¹å¼ï¼šåŸºäºæ³¨è§£å’Œxmlé…ç½®</p>
<h3 id="ä»£ç†åŸåˆ™"><a href="#ä»£ç†åŸåˆ™" class="headerlink" title="ä»£ç†åŸåˆ™"></a>ä»£ç†åŸåˆ™</h3><p><code>Spring AOP</code> æ¡†æ¶å¯¹ <code>AOP</code> ä»£ç†ç±»çš„å¤„ç†åŸåˆ™æ˜¯ï¼šå¦‚æœç›®æ ‡å¯¹è±¡çš„å®ç°ç±»å®ç°äº†æ¥å£ï¼Œ<code>Spring AOP</code> å°†ä¼šé‡‡ç”¨ JDK åŠ¨æ€ä»£ç†æ¥ç”Ÿæˆ <code>AOP</code> ä»£ç†ç±»ï¼›å¦‚æœç›®æ ‡å¯¹è±¡çš„å®ç°ç±»æ²¡æœ‰å®ç°æ¥å£ï¼Œ<code>Spring AOP</code> å°†ä¼šé‡‡ç”¨ <code>CGLIB</code> æ¥ç”Ÿæˆ <code>AOP</code> ä»£ç†ç±»(å¯ä»¥å¼ºåˆ¶ä½¿ç”¨<code>CGLIB</code>ç”Ÿæˆä»£ç†ï¼Œè®¾ç½®<code>proxy-target-classï¼true</code>)</p>
<h3 id="æ³¨è§£é…ç½®"><a href="#æ³¨è§£é…ç½®" class="headerlink" title="æ³¨è§£é…ç½®"></a>æ³¨è§£é…ç½®</h3><p>æ³¨è§£é…ç½®AOPï¼ˆä½¿ç”¨ <code>AspectJ</code> ç±»åº“å®ç°çš„ï¼‰ï¼Œå¤§è‡´åˆ†ä¸ºä¸‰æ­¥ï¼š </p>
<ol>
<li>ä½¿ç”¨æ³¨è§£<code>@Aspect</code>æ¥å®šä¹‰ä¸€ä¸ªåˆ‡é¢ï¼Œåœ¨åˆ‡é¢ä¸­å®šä¹‰åˆ‡å…¥ç‚¹<code>@Pointcut</code>ï¼Œé€šçŸ¥ç±»å‹<code>@Before</code>ï¼Œ<code>@AfterReturning</code>ï¼Œ<code>@After</code>ï¼Œ<code>@AfterThrowing</code>ï¼Œ<code>@Around</code></li>
<li>å¼€å‘éœ€è¦è¢«æ‹¦æˆªçš„ç±»(æ™®é€šçš„ä¸šåŠ¡é€»è¾‘)</li>
<li>å°†åˆ‡é¢é…ç½®åˆ°xmlä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªåŠ¨æ‰«æBeançš„æ–¹å¼ï¼Œè¿™æ ·åˆ‡é¢beanäº¤ç”±<code>Spring IOC</code>å®¹å™¨ç®¡ç†ã€‚ </li>
</ol>
<p>æ³¨æ„ï¼š<code>Spring</code>åªæ˜¯ä½¿ç”¨äº†å’Œ <code>AspectJ</code> ä¸€æ ·çš„æ³¨è§£ï¼Œåº•å±‚ä¾ç„¶ä½¿ç”¨çš„æ˜¯ <code>Spring AOP</code>ï¼Œä¾ç„¶æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†</p>
<a id="more"></a>
<ul>
<li>ä¾èµ–jaråŒ…</li>
</ul>
<p>è¦æƒ³ä½¿ç”¨<code>@Aspect</code>æ³¨è§£ï¼Œéœ€è¦å¼•ç”¨ <code>aspectJ</code> çš„jaråŒ…ï¼š <code>aspectjweaver.jar</code>å’Œ <code>aspectjrt.jar</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjrt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li>å®šä¹‰æ¥å£</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SimpleService</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String message)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ç›®æ ‡ç±»</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleServiceImpl</span> <span class="keyword">implements</span> <span class="title">SimpleService</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"SimpleService : Method sayHello() : Hello! "</span> + message);</div><div class="line">    <span class="keyword">return</span> message;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åˆ‡é¢ç±»`</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DoBeforeAspect</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Before</span>(<span class="string">"execution(* com.zsr.test.aop.SimpleService.sayHello(..))"</span>)</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doBefore</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"***AspectJ*** DoBefore() is running!! intercepted : "</span> + joinPoint.getSignature().getName());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li><code>@Aspect</code>ï¼šæ„æ€æ˜¯è¿™ä¸ªç±»ä¸ºåˆ‡é¢ç±»  </li>
<li><code>@Componet</code>ï¼šå› ä¸ºä½œä¸ºåˆ‡é¢ç±»éœ€è¦ <code>Spring</code> ç®¡ç†èµ·æ¥ï¼Œæ‰€ä»¥åœ¨åˆå§‹åŒ–æ—¶å°±éœ€è¦å°†è¿™ä¸ªç±»åˆå§‹åŒ–åŠ å…¥ <code>Spring IOC</code> çš„ç®¡ç†ï¼›  </li>
<li><code>@Befoe</code>ï¼šåˆ‡å…¥ç‚¹çš„é€»è¾‘(<code>Advice</code>)</li>
<li><code>execution</code>â€¦ï¼šåˆ‡å…¥ç‚¹è¯­æ³•</li>
</ol>
<ul>
<li>å¯åŠ¨æ³¨è§£</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></div><div class="line">  <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">  <span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span></div><div class="line">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></div><div class="line">    http://www.springframework.org/schema/beans </div><div class="line">    http://www.springframework.org/schema/beans/spring-beans-4.3.xsd</div><div class="line">    http://www.springframework.org/schema/context </div><div class="line">    http://www.springframework.org/schema/context/spring-context-4.3.xsd</div><div class="line">    http://www.springframework.org/schema/util</div><div class="line">    http://www.springframework.org/schema/util/spring-util-4.3.xsd</div><div class="line">    http://www.springframework.org/schema/aop </div><div class="line">    http://www.springframework.org/schema/aop/spring-aop-4.3.xsd"</div><div class="line">  <span class="attr">default-lazy-init</span>=<span class="string">"false"</span>&gt;</div><div class="line">  <span class="comment">&lt;!-- æ³¨æ„éœ€è¦æ·»åŠ aop schema --&gt;</span></div><div class="line">  </div><div class="line">  <span class="comment">&lt;!-- è‡ªåŠ¨æ‰«æ --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.zsr.test.aop"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- å¯åŠ¨ @AspectJ æ”¯æŒ --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li>æ‰§è¡Œç»“æœ</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">---------------</div><div class="line">***AspectJ*** DoBefore() is running!! intercepted : sayHello</div><div class="line">SimpleService : Method sayHello() : Hello zsr</div><div class="line">---------------</div></pre></td></tr></table></figure>
<h3 id="xmlé…ç½®"><a href="#xmlé…ç½®" class="headerlink" title="xmlé…ç½®"></a>xmlé…ç½®</h3><p>ä½¿ç”¨<code>xml</code>é…ç½®<code>aop</code>éœ€è¦ç”¨åˆ°æ ‡ç­¾ï¼š<code>&lt;aop:config&gt;</code></p>
<ul>
<li>é…ç½®</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- è‡ªåŠ¨æ‰«æ --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.zsr.test.aop"</span> /&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">"aspects"</span> <span class="attr">ref</span>=<span class="string">"doBeforeAspect"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"pointCutBefore"</span></span></div><div class="line">        <span class="attr">expression</span>=<span class="string">"execution(* com.zsr.test.aop.SimpleService.sayHello(..))"</span> /&gt;</div><div class="line">      <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"doBefore"</span> <span class="attr">pointcut-ref</span>=<span class="string">"pointCutBefore"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li>æ‰§è¡Œç»“æœ</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">---------------</div><div class="line">***AspectJ*** DoBefore() is running!! intercepted : sayHello</div><div class="line">SimpleService : Method sayHello() : Hello zsr</div><div class="line">---------------</div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://www.ibm.com/developerworks/cn/java/j-lo-springaopcglib/index.html" target="_blank" rel="external">Spring AOP å®ç°åŸç†ä¸ CGLIB åº”ç”¨</a></p>
<p><a href="http://www.cnblogs.com/oumyye/p/4480196.html" target="_blank" rel="external">spring aopä¸¤ç§é…ç½®æ–¹å¼</a></p>
<p><a href="https://examples.javacodegeeks.com/enterprise-java/spring/aop/spring-aop-aspectj-example/" target="_blank" rel="external">Spring AOP AspectJ Example</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Spring AOP and AspectJ]]></title>
      <url>http://zsr.github.io/2017/11/27/Spring-AOP-and-AspectJ/</url>
      <content type="html"><![CDATA[<p><code>Spring AOP</code> å’Œ <code>AspectJ</code>æ˜¯<code>Java</code>ä¸­æœ€æµè¡Œçš„ <code>AOP</code> æ¡†æ¶</p>
<h3 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h3><p><code>AOP</code> å®ç°çš„å…³é”®å°±åœ¨äº <code>AOP</code> æ¡†æ¶è‡ªåŠ¨åˆ›å»ºçš„ <code>AOP</code> ä»£ç†ï¼Œ<code>AOP</code> ä»£ç†åˆ™å¯åˆ†ä¸º<strong>é™æ€ä»£ç†</strong>å’Œ<strong>åŠ¨æ€ä»£ç†</strong>ä¸¤å¤§ç±»ï¼Œå…¶ä¸­é™æ€ä»£ç†æ˜¯æŒ‡åœ¨ç¼–è¯‘é˜¶æ®µä¿®æ”¹ç›®æ ‡ç±»å­—èŠ‚ç ï¼Œå±äºé™æ€ç¼–å…¥ï¼Œä¸éœ€è¦ä»£ç†ç±»ï¼Œå› æ­¤ä¹Ÿç§°ä¸ºç¼–è¯‘æ—¶å¢å¼ºï¼›è€ŒåŠ¨æ€ä»£ç†åˆ™åœ¨è¿è¡Œæ—¶å€ŸåŠ©äº <code>JDK</code> åŠ¨æ€ä»£ç†ã€<code>CGLIB</code> ç­‰åœ¨å†…å­˜ä¸­â€œä¸´æ—¶â€ç”Ÿæˆ <code>AOP</code> åŠ¨æ€ä»£ç†ç±»ï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¸ºè¿è¡Œæ—¶å¢å¼ºã€‚å…¶ä¸­<code>aspectj</code>ä¸ºé™æ€ä»£ç†ï¼Œ<code>Spring AOP</code>æ˜¯åŠ¨æ€ä»£ç†</p>
<h4 id="AOPæ ¸å¿ƒæ¦‚å¿µ"><a href="#AOPæ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="AOPæ ¸å¿ƒæ¦‚å¿µ"></a>AOPæ ¸å¿ƒæ¦‚å¿µ</h4><ul>
<li><code>Advice</code>ï¼šé€šçŸ¥ï¼Œæ˜¯æŒ‡æ‹¦æˆªåˆ°<code>jointpoint</code>ä¹‹åæ‰€è¦åšçš„äº‹æƒ…å³ç‰¹å®šçš„<code>Jointpoint</code>å¤„è¿è¡Œçš„ä»£ç ã€‚</li>
<li><code>JoinPoint</code>ï¼šè¿æ¥ç‚¹ï¼Œå®ƒå®šä¹‰åœ¨å“ªé‡Œ(å“ªäº›ç‚¹)åŠ å…¥ä½ çš„é€»è¾‘åŠŸèƒ½ï¼ŒåŸºæœ¬æ¯ä¸ªæ–¹æ³•çš„å‰å(ä¸¤è€…éƒ½æœ‰ä¹Ÿè¡Œ)ï¼Œæˆ–æŠ›å‡ºå¼‚å¸¸æ—¶éƒ½å¯ä»¥æ˜¯è¿æ¥ç‚¹ï¼Œ<code>spring</code>åªæ”¯æŒæ–¹æ³•è¿æ¥ç‚¹</li>
<li><code>PointCut</code>ï¼šåˆ‡å…¥ç‚¹çš„é›†åˆï¼Œå³ä¸€ç»„<code>Joinpoint</code>ï¼Œå°±æ˜¯è¯´ä¸€ä¸ª<code>Advice</code>å¯èƒ½åœ¨å¤šä¸ªåœ°æ–¹ç»‡å…¥ã€‚æ¯”å¦‚ä¸€ä¸ªç±»é‡Œï¼Œæœ‰15ä¸ªæ–¹æ³•ï¼Œé‚£å°±æœ‰å‡ åä¸ªè¿æ¥ç‚¹äº†ï¼Œè®©åˆ‡ç‚¹æ¥ç­›é€‰è¿æ¥ç‚¹ï¼Œé€‰ä¸­é‚£å‡ ä¸ªä½ æƒ³è¦çš„æ–¹æ³•ã€‚</li>
<li><code>Aspect</code>ï¼šåˆ‡é¢ï¼Œå®é™…æ˜¯é€šçŸ¥å’Œåˆ‡å…¥ç‚¹çš„ç»„åˆï¼Œé€šçŸ¥è¯´æ˜äº†å¹²ä»€ä¹ˆå’Œä»€ä¹ˆæ—¶å€™å¹²(ä»€ä¹ˆæ—¶å€™é€šè¿‡æ–¹æ³•åä¸­çš„<code>before</code>ï¼Œ<code>after</code>ï¼Œ<code>around</code>ç­‰)ï¼Œè€Œåˆ‡å…¥ç‚¹è¯´æ˜äº†åœ¨å“ªå¹²(æŒ‡å®šåˆ°åº•æ˜¯å“ªä¸ªæ–¹æ³•)ã€‚</li>
<li><code>Weaving</code>ï¼šç»‡å…¥ï¼ŒæŠŠåˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡æ¥åˆ›å»ºæ–°çš„ä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚</li>
</ul>
<h3 id="Aspectj"><a href="#Aspectj" class="headerlink" title="Aspectj"></a>Aspectj</h3><p><code>ApectJ</code>ä¸»è¦é‡‡ç”¨çš„æ˜¯ç¼–è¯‘æœŸç»‡å…¥ï¼Œåœ¨è¿™ä¸ªæœŸé—´ä½¿ç”¨<code>AspectJ</code>çš„<code>acj</code>ç¼–è¯‘å™¨æŠŠ<code>aspect</code>ç±»ç¼–è¯‘æˆ<code>class</code>å­—èŠ‚ç åï¼Œåœ¨javaç›®æ ‡ç±»ç¼–è¯‘æ—¶ç»‡å…¥ï¼Œå³å…ˆç¼–è¯‘<code>aspect</code>ç±»å†ç¼–è¯‘ç›®æ ‡ç±»ã€‚</p>
<p><img src="http://floodcool.com/wp-content/uploads/2017/08/apectj%E8%BF%87%E7%A8%8B.png" alt="img"></p>
<a id="more"></a>
<h4 id="ä¸¾ä¾‹"><a href="#ä¸¾ä¾‹" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h4><p>å®‰è£… <code>AspectJ</code> è§ï¼š<a href="https://www.ibm.com/developerworks/cn/java/j-lo-springaopcglib/index.html" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/java/j-lo-springaopcglib/index.html</a></p>
<ul>
<li>ä¸šåŠ¡é€»è¾‘</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.aspectj;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</div><div class="line">  <span class="comment">// æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"Hello AspectJ!"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    HelloWorld h = <span class="keyword">new</span> HelloWorld();</div><div class="line">    h.sayHello();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åˆ‡é¢<code>Aspect</code></li>
</ul>
<p>ä½¿ç”¨<code>AspectJ</code>ç¼–å†™ä¸€ä¸ª<code>Aspect</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.aspectj;</div><div class="line"></div><div class="line"><span class="keyword">public</span> aspect TestAspect &#123;</div><div class="line"><span class="comment">//æŒ‡å®šæ‰§è¡Œ Hello.sayHello() æ–¹æ³•æ—¶æ‰§è¡Œä¸‹é¢ä»£ç å—</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">around</span><span class="params">()</span>:<span class="title">call</span><span class="params">(<span class="keyword">void</span> HelloWorld.sayHello()</span>)</span>&#123;</div><div class="line">  System.out.println(<span class="string">"å¼€å§‹äº‹åŠ¡ ..."</span>);</div><div class="line">  proceed();</div><div class="line">  System.out.println(<span class="string">"äº‹åŠ¡ç»“æŸ ..."</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>ajc</code>ç¼–è¯‘</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ajc -d . HelloWorld.java TestAspect.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HelloWorld.class åç¼–è¯‘</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span></span></div><div class="line">&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span></div><div class="line">  &#123;</div><div class="line">    System.out.println(<span class="string">"Hello AspectJ!"</span>);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> sayHello_aroundBody1$advice(HelloWorld target, TestAspect ajc$aspectInstance, AroundClosure ajc$aroundClosure)</div><div class="line">  &#123;</div><div class="line">    System.out.println(<span class="string">"å¼€å§‹äº‹åŠ¡ ..."</span>);</div><div class="line">    AroundClosure localAroundClosure = ajc$aroundClosure;</div><div class="line">    sayHello_aroundBody0(target);</div><div class="line">    System.out.println(<span class="string">"äº‹åŠ¡ç»“æŸ ..."</span>);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></div><div class="line">  &#123;</div><div class="line">    HelloWorld h = <span class="keyword">new</span> HelloWorld();</div><div class="line">    HelloWorld localHelloWorld1 = h;</div><div class="line">    sayHello_aroundBody1$advice(localHelloWorld1, TestAspect.aspectOf(), <span class="keyword">null</span>);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">sayHello_aroundBody0</span><span class="params">(HelloWorld paramHelloWorld)</span></span></div><div class="line">  &#123;</div><div class="line">    paramHelloWorld.sayHello();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥å‘ç°åˆ‡é¢ä»£ç ç»‡å…¥äº†<code>HelloWorld.class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// TestAspect.class åç¼–è¯‘</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestAspect</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">void</span> ajc$around$com_zsr_test_aspectj_TestAspect$<span class="number">1</span>$<span class="number">8852f</span>95(AroundClosure ajc$aroundClosure)</div><div class="line">  &#123;</div><div class="line">    System.out.println(<span class="string">"å¼€å§‹äº‹åŠ¡ ..."</span>);</div><div class="line">    ajc$around$com_zsr_test_aspectj_TestAspect$<span class="number">1</span>$<span class="number">8852f</span>95proceed(ajc$aroundClosure);</div><div class="line">    System.out.println(<span class="string">"äº‹åŠ¡ç»“æŸ ..."</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»<code>Aspect</code>ç¼–è¯‘åçš„<code>class</code>æ–‡ä»¶å¯ä»¥æ›´æ˜æ˜¾çš„çœ‹å‡ºæ‰§è¡Œçš„é€»è¾‘ã€‚<code>proceed</code>æ–¹æ³•å°±æ˜¯å›è°ƒæ‰§è¡Œè¢«ä»£ç†ç±»ä¸­çš„æ–¹æ³•ã€‚</p>
<ul>
<li>æ‰§è¡Œç»“æœ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">âœ  aspectj java com.zsr.test.aspectj.HelloWorld</div><div class="line">å¼€å§‹äº‹åŠ¡ ...</div><div class="line">Hello AspectJ!</div><div class="line">äº‹åŠ¡ç»“æŸ ...</div><div class="line">âœ  aspectj pwd</div><div class="line">/Users/nali/Documents/workspace/test/src/main/java/com/zsr/test/aspectj</div><div class="line">âœ  aspectj</div></pre></td></tr></table></figure>
<h3 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h3><p><code>Spring AOP</code>ä½¿ç”¨çš„æ˜¯åŠ¨æ€ä»£ç†å¢å¼ºï¼ŒåŠ¨æ€ä»£ç†ä¸ä¼šæ”¹å˜ç±»çš„å­—èŠ‚ç ï¼Œè€Œæ˜¯åŠ¨æ€çš„ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚<code>Spring AOP</code>çš„åŠ¨æ€ä»£ç†æœºåˆ¶æœ‰ä¸¤ç§æ–¹å¼ï¼š<strong>JDKåŠ¨æ€ä»£ç†</strong>å’Œ<strong>CGLIBåŠ¨æ€ä»£ç†</strong>ã€‚</p>
<ul>
<li><p><strong>JDKåŠ¨æ€ä»£ç†</strong></p>
<p>JDKåŠ¨æ€ä»£ç†éœ€è¦è¢«ä»£ç†çš„ç±»å¿…é¡»å®ç°ä¸€ä¸ªæ¥å£ï¼Œåº•å±‚é€šè¿‡åå°„å®ç°</p>
</li>
<li><p><strong>CGLIBåŠ¨æ€ä»£ç†</strong></p>
<p>CGLIBåŠ¨æ€ä»£ç†å¯ä»¥ä¸ç”¨éœ€è¦è¢«ä»£ç†ç±»å¿…é¡»å®ç°æ¥å£ï¼Œåº•å±‚é€šè¿‡ç»§æ‰¿å®ç°ï¼Œå› æ­¤å¦‚æœæŸä¸ªç±»è¢«æ ‡è®°ä¸º<code>final</code>ï¼Œé‚£ä¹ˆå®ƒæ˜¯æ— æ³•ä½¿ç”¨CGLIBåšåŠ¨æ€ä»£ç†çš„</p>
</li>
</ul>
<p><img src="http://www.baeldung.com/wp-content/uploads/2017/10/springaop-process.png" alt="img"></p>
<h4 id="åˆ›å»ºAOPä»£ç†"><a href="#åˆ›å»ºAOPä»£ç†" class="headerlink" title="åˆ›å»ºAOPä»£ç†"></a>åˆ›å»ºAOPä»£ç†</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultAopProxyFactory.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> AopProxy <span class="title">createAopProxy</span><span class="params">(AdvisedSupport config)</span> <span class="keyword">throws</span> AopConfigException </span>&#123;</div><div class="line">        <span class="comment">// å¦‚æœç›®æ ‡ç±»æ²¡æœ‰å®ç°æ¥å£æˆ–è€…proxy-target-class="true"åˆ™é‡‡ç”¨CGLIBä»£ç†</span></div><div class="line">		<span class="keyword">if</span> (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123;</div><div class="line">			Class&lt;?&gt; targetClass = config.getTargetClass();</div><div class="line">			<span class="keyword">if</span> (targetClass == <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException()</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) &#123;</div><div class="line">				<span class="keyword">return</span> <span class="keyword">new</span> JdkDynamicAopProxy(config);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> ObjenesisCglibAopProxy(config);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> JdkDynamicAopProxy(config);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœé…ç½®äº†<code>&lt;aop:aspectj-autoproxy proxy-target-class=&quot;true&quot;/&gt;</code>æˆ–è€…ç›®æ ‡ç±»æ²¡æœ‰å®ç°æ¥å£ï¼Œåˆ™ä½¿ç”¨<code>CGLIB</code>ä»£ç†ï¼›å¦‚æœç›®æ ‡ç±»å®ç°äº†æ¥å£ï¼Œé»˜è®¤ä½¿ç”¨<code>JDK</code>ä»£ç†</p>
<h4 id="Spring-AOP-vs-ApectJ"><a href="#Spring-AOP-vs-ApectJ" class="headerlink" title="Spring AOP  vs ApectJ"></a>Spring AOP  vs ApectJ</h4><p><code>Spring AOP</code> ä¸ <code>ApectJ</code> çš„ç›®çš„ä¸€è‡´ï¼Œéƒ½æ˜¯ä¸ºäº†ç»Ÿä¸€å¤„ç†æ¨ªåˆ‡ä¸šåŠ¡ï¼Œä½†ä¸<code>AspectJ</code>ä¸åŒçš„æ˜¯:</p>
<ol>
<li><code>Spring AOP</code> å¹¶ä¸å°è¯•æä¾›å®Œæ•´çš„AOPåŠŸèƒ½ï¼Œ<code>Spring AOP</code> æ›´æ³¨é‡çš„æ˜¯ä¸<code>Spring IOC</code>å®¹å™¨çš„ç»“åˆï¼Œå¹¶ç»“åˆè¯¥ä¼˜åŠ¿æ¥è§£å†³æ¨ªåˆ‡ä¸šåŠ¡çš„é—®é¢˜ï¼Œå› æ­¤åœ¨<code>AOP</code>çš„åŠŸèƒ½å®Œå–„æ–¹é¢ï¼Œç›¸å¯¹æ¥è¯´<code>AspectJ</code>å…·æœ‰æ›´å¤§çš„ä¼˜åŠ¿ã€‚</li>
<li><code>AspectJ</code>åœ¨<code>AOP</code>çš„å®ç°æ–¹å¼ä¸Šä¾èµ–äºç‰¹æ®Šç¼–è¯‘å™¨(ajcç¼–è¯‘å™¨)ï¼Œè€Œ<code>Spring</code>å›é¿äº†è¿™ç‚¹ï¼Œè½¬å‘é‡‡ç”¨åŠ¨æ€ä»£ç†æŠ€æœ¯çš„å®ç°åŸç†æ¥æ„å»º<code>Spring AOP</code>çš„å†…éƒ¨æœºåˆ¶ï¼ˆåŠ¨æ€ç»‡å…¥ï¼‰ï¼Œè¿™æ˜¯ä¸<code>AspectJ</code>ï¼ˆé™æ€ç»‡å…¥ï¼‰æœ€æ ¹æœ¬çš„åŒºåˆ«</li>
</ol>
<p><strong>æ³¨æ„ï¼š</strong></p>
<p><code>Spring 2.0</code>åä¾¿ä½¿ç”¨äº†ä¸<code>AspectJ</code>ä¸€æ ·çš„æ³¨è§£ï¼Œæ–°å¢äº†å¯¹<code>AspectJ</code>åˆ‡ç‚¹è¡¨è¾¾å¼æ”¯æŒã€‚éœ€è¦æ³¨æ„<code>Spring</code> åªæ˜¯ä½¿ç”¨äº†ä¸ <code>AspectJ</code> ä¸€æ ·çš„æ³¨è§£ï¼Œä½†ä»ç„¶æ²¡æœ‰ä½¿ç”¨ <code>AspectJ</code> çš„ç¼–è¯‘å™¨ï¼Œåº•å±‚ä»ç„¶æ˜¯åŠ¨æ€ä»£ç†æŠ€æœ¯çš„å®ç°</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p> <a href="http://listenzhangbin.com/post/2016/09/spring-aop-cglib/" target="_blank" rel="external">Spring AOPçš„å®ç°åŸç†</a></p>
<p><a href="http://www.baeldung.com/spring-aop-vs-aspectj" target="_blank" rel="external">Comparing Spring AOP and AspectJ</a></p>
<p><a href="http://cxis.me/2017/04/12/AOP%E6%A6%82%E5%BF%B5%EF%BC%8C%E5%8E%9F%E7%90%86%EF%BC%8C%E5%BA%94%E7%94%A8%E4%BB%8B%E7%BB%8D/" target="_blank" rel="external">AOPæ¦‚å¿µï¼ŒåŸç†ï¼Œåº”ç”¨ä»‹ç»</a></p>
<p><a href="http://floodcool.com/blog/2220155.html" target="_blank" rel="external">Spring AOP (ä¸‰) AspectJ</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Spring Taskå®šæ—¶ä»»åŠ¡]]></title>
      <url>http://zsr.github.io/2017/11/17/Spring-Task%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</url>
      <content type="html"><![CDATA[<p><code>Spring3.0</code>ä»¥åå¼•å…¥çš„å®šæ—¶ä»»åŠ¡å·¥å…·ï¼š<code>spring task</code>ï¼Œå¯ä»¥å°†å®ƒæ¯”ä½œä¸€ä¸ªè½»é‡çº§çš„<code>Quartz</code>ï¼Œè€Œä¸”ä½¿ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œé™¤<code>spring</code>ç›¸å…³çš„åŒ…å¤–ä¸éœ€è¦é¢å¤–çš„åŒ…ï¼Œè€Œä¸”æ”¯æŒæ³¨è§£å’Œé…ç½®æ–‡ä»¶ä¸¤ç§ã€‚<code>spring</code>é€šè¿‡æ¥å£<code>TaskExecutor</code>å’Œ<code>TaskScheduler</code>è¿™ä¸¤ä¸ªæ¥å£çš„æ–¹å¼ä¸ºå¼‚æ­¥å®šæ—¶ä»»åŠ¡æä¾›äº†ä¸€ç§æŠ½è±¡ã€‚</p>
<h3 id="XMLé…ç½®"><a href="#XMLé…ç½®" class="headerlink" title="XMLé…ç½®"></a>XMLé…ç½®</h3><p><code>Spring</code>æä¾›äº†<code>task</code>å‘½åç©ºé—´ï¼Œè®©é…ç½®å®šæ—¶ä»»åŠ¡éå¸¸ç®€å•ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.zsr.test.springTask"</span>/&gt;</span> </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">task:scheduler</span> <span class="attr">id</span>=<span class="string">"scheduler"</span> <span class="attr">pool-size</span>=<span class="string">"10"</span> /&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">task:scheduled-tasks</span> <span class="attr">scheduler</span>=<span class="string">"scheduler"</span>&gt;</span>   </div><div class="line">        <span class="tag">&lt;<span class="name">task:scheduled</span> <span class="attr">ref</span>=<span class="string">"taskJob"</span> <span class="attr">method</span>=<span class="string">"execute"</span> <span class="attr">cron</span>=<span class="string">"0 * * * * ?"</span>/&gt;</span>   </div><div class="line"><span class="tag">&lt;/<span class="name">task:scheduled-tasks</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>è¯´æ˜ï¼š</strong><code>ref</code>å‚æ•°æŒ‡å®šçš„å³ä»»åŠ¡ç±»ï¼Œ<code>method</code>æŒ‡å®šçš„å³éœ€è¦è¿è¡Œçš„æ–¹æ³•ï¼Œ<code>cron</code>æŒ‡å®š<code>cronExpression</code>è¡¨è¾¾å¼</p>
<p><strong>æ³¨æ„ï¼š</strong><code>&lt;task:schedule-tasks scheduler=&quot;scheduler&quot;&gt;</code> è¿™é‡Œçš„<code>scheduler</code>å¿…é¡»æ˜¾å¼æŒ‡å®šï¼Œå¦åˆ™å®ƒåªä¼šä½¿ç”¨é»˜è®¤çš„å€¼ï¼Œé»˜è®¤ä¸ºå•çº¿ç¨‹çš„ã€‚</p>
<h4 id="ä»»åŠ¡Job"><a href="#ä»»åŠ¡Job" class="headerlink" title="ä»»åŠ¡Job"></a>ä»»åŠ¡Job</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskJob</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"ä»»åŠ¡è¿›è¡Œä¸­."</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="TaskExecutor"><a href="#TaskExecutor" class="headerlink" title="TaskExecutor"></a>TaskExecutor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TaskExecutor</span> <span class="keyword">extends</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable task)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>task:executor</code>ä¼šæ³¨å†Œä¸€ä¸ª<strong>ThreadPoolTaskExecutor</strong>æ‰§è¡Œå™¨ï¼Œå¯ä»¥ä½¿ç”¨å®ƒçš„ç›¸å…³å±æ€§æ¥é…ç½®è¯¥æ‰§è¡Œå™¨ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">task:executor</span></span></div><div class="line">        <span class="attr">id</span>=<span class="string">"executor"</span></div><div class="line">        <span class="attr">pool-size</span>=<span class="string">"10"</span></div><div class="line">        <span class="attr">queue-capacity</span>=<span class="string">"100"</span></div><div class="line">        <span class="attr">rejection-policy</span>=<span class="string">"CALLER_RUNS"</span>/&gt;</div></pre></td></tr></table></figure>
<ul>
<li><code>pool-size</code>ï¼šçº¿ç¨‹æ± å¤§å°ï¼Œå¦‚æœåªæ˜¯è®¾ç½®äº†ä¸€ä¸ªå€¼ã€‚åˆ™<code>corePoolsizeå’ŒmaxPoolSize</code>éƒ½æ˜¯è¿™ä¸ªå€¼ã€‚</li>
<li><code>queue-capacity</code>ï¼šé˜Ÿåˆ—å¤§å°</li>
<li><code>rejection-policy</code>: é˜Ÿåˆ—æ»¡çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ‹’ç»ç­–ç•¥ã€‚</li>
</ul>
<a id="more"></a>
<p>æ‹’ç»ç­–ç•¥æœ‰:</p>
<ul>
<li><code>ABORTï¼ˆé»˜è®¤ï¼‰</code>ï¼šæŠ›å‡º<code>TaskRejectedException</code>å¼‚å¸¸ï¼Œç„¶åä¸æ‰§è¡Œ</li>
<li><code>DISCARD</code>ï¼šä¸æ‰§è¡Œï¼Œä¹Ÿä¸æŠ›å‡ºå¼‚å¸¸</li>
<li><code>DISCARD_OLDEST</code>ï¼šä¸¢å¼ƒ<code>queue</code>ä¸­æœ€æ—§çš„é‚£ä¸ªä»»åŠ¡</li>
<li><code>CALLER_RUNS</code>ï¼šä¸åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œè€Œæ˜¯ç”±è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolTaskExecutor</span> <span class="keyword">extends</span> <span class="title">ExecutorConfigurationSupport</span> <span class="keyword">implements</span> <span class="title">SchedulingTaskExecutor</span> </span>&#123;</div><div class="line">  <span class="comment">// åˆå§‹åŒ–Executor</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> ExecutorService <span class="title">initializeExecutor</span><span class="params">(</span></span></div><div class="line">			ThreadFactory threadFactory, RejectedExecutionHandler rejectedExecutionHandler) &#123;</div><div class="line"></div><div class="line">		BlockingQueue&lt;Runnable&gt; queue = createQueue(<span class="keyword">this</span>.queueCapacity);</div><div class="line">        <span class="comment">// çº¿ç¨‹æ± ï¼Œé»˜è®¤æƒ…å†µä¸‹ç±»ä¼¼äºExecutors.newFixedThreadPool()</span></div><div class="line">		ThreadPoolExecutor executor  = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">				<span class="keyword">this</span>.corePoolSize, <span class="keyword">this</span>.maxPoolSize, <span class="keyword">this</span>.keepAliveSeconds, TimeUnit.SECONDS,</div><div class="line">				queue, threadFactory, rejectedExecutionHandler);</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.allowCoreThreadTimeOut) &#123;</div><div class="line">			executor.allowCoreThreadTimeOut(<span class="keyword">true</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">this</span>.threadPoolExecutor = executor;</div><div class="line">		<span class="keyword">return</span> executor;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é»˜è®¤æƒ…å†µä¸‹æ‰§è¡Œé˜Ÿåˆ—æ˜¯æ— é™çš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´JVMä½¿ç”¨å®Œæ‰€æœ‰å†…å­˜ï¼Œå› æ­¤æœ€å¥½æŒ‡å®šä¸€ä¸ªç¡®å®šçš„æ•°å€¼ã€‚</p>
<h4 id="TaskScheduler"><a href="#TaskScheduler" class="headerlink" title="TaskScheduler"></a>TaskScheduler</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TaskScheduler</span> </span>&#123;</div><div class="line">  <span class="function">ScheduledFuture <span class="title">schedule</span><span class="params">(Runnable task, Trigger trigger)</span></span>;</div><div class="line">  ......</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>task:scheduler</code>ä¼šæ³¨å†Œä¸€ä¸ª<strong>ThreadPoolTaskScheduler </strong>å®šæ—¶å™¨ï¼Œå®ƒåªæœ‰ä¸€ä¸ªå±æ€§çº¿ç¨‹æ± å¤§å°ã€‚é»˜è®¤æ˜¯1ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®ä»»åŠ¡çš„æ•°é‡æŒ‡å®šä¸€ä¸ªåˆé€‚çš„å¤§å°ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">task:scheduler</span> <span class="attr">id</span>=<span class="string">"scheduler"</span></span></div><div class="line">                   <span class="attr">pool-size</span>=<span class="string">"10"</span>/&gt;</div></pre></td></tr></table></figure>
<p><code>TaskScheduler</code>å°±æ˜¯ä¸ºäº†æä¾›å®šæ—¶ä»»åŠ¡çš„æ”¯æŒã€‚<code>TaskScheduler</code>éœ€è¦ä¼ å…¥ä¸€ä¸ª<code>Runnable</code>çš„ä»»åŠ¡åšä¸ºå‚æ•°ï¼Œå¹¶æŒ‡å®šéœ€è¦å‘¨æœŸæ‰§è¡Œçš„æ—¶é—´æˆ–è€…è§¦å‘å™¨ï¼Œè¿™æ ·<code>Runnable</code>ä»»åŠ¡å°±å¯ä»¥å‘¨æœŸæ€§æ‰§è¡Œäº†ã€‚</p>
<p><code>ThreadPoolTaskScheduler</code>å®é™…ä¸Šä»£ç†äº†<code>jdk</code>ä¸­çš„<code>SchedulingTaskExecutor</code>ï¼Œå¹¶ä¸”ä¹Ÿå®ç°äº†<code>TaskScheduler</code>æ¥å£ï¼Œæ‰€ä»¥ä¸€ä¸ª<code>ThreadPoolTaskScheduler</code>å®ä¾‹å³å¯åŒæ—¶ç”¨äºæ‰§è¡Œå®šæ—¶ä»»åŠ¡(ä»»åŠ¡è°ƒåº¦å’Œæ‰§è¡Œéƒ½æ˜¯è¯¥çº¿ç¨‹æ± )ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolTaskScheduler</span> <span class="keyword">extends</span> <span class="title">ExecutorConfigurationSupport</span></span></div><div class="line">		<span class="keyword">implements</span> <span class="title">TaskScheduler</span>, <span class="title">SchedulingTaskExecutor</span> &#123;</div><div class="line">  <span class="function"><span class="keyword">protected</span> ExecutorService <span class="title">initializeExecutor</span><span class="params">(</span></span></div><div class="line">			ThreadFactory threadFactory, RejectedExecutionHandler rejectedExecutionHandler) &#123;</div><div class="line"></div><div class="line">		<span class="keyword">this</span>.scheduledExecutor = createExecutor(<span class="keyword">this</span>.poolSize, threadFactory, rejectedExecutionHandler);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.scheduledExecutor;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="æ‰§è¡Œä»»åŠ¡"><a href="#æ‰§è¡Œä»»åŠ¡" class="headerlink" title="æ‰§è¡Œä»»åŠ¡"></a>æ‰§è¡Œä»»åŠ¡</h4><p>ä½¿ç”¨<code>&lt;task:scheduled-tasks&gt;</code>æŒ‡å®šè¦æ‰§è¡Œçš„<code>Bean</code>å’Œæ–¹æ³•å³å¯æ‰§è¡Œä»»åŠ¡ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">task:scheduler</span> <span class="attr">id</span>=<span class="string">"scheduler"</span> <span class="attr">pool-size</span>=<span class="string">"10"</span> /&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">task:scheduled-tasks</span> <span class="attr">scheduler</span>=<span class="string">"scheduler"</span>&gt;</span>   </div><div class="line">        <span class="tag">&lt;<span class="name">task:scheduled</span> <span class="attr">ref</span>=<span class="string">"taskJob"</span> <span class="attr">method</span>=<span class="string">"execute"</span> <span class="attr">cron</span>=<span class="string">"0 * * * * ?"</span>/&gt;</span>   </div><div class="line"><span class="tag">&lt;/<span class="name">task:scheduled-tasks</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨æ³¨è§£"><a href="#ä½¿ç”¨æ³¨è§£" class="headerlink" title="ä½¿ç”¨æ³¨è§£"></a>ä½¿ç”¨æ³¨è§£</h3><h4 id="Scheduleï¼šè°ƒåº¦ä»»åŠ¡"><a href="#Scheduleï¼šè°ƒåº¦ä»»åŠ¡" class="headerlink" title="@Scheduleï¼šè°ƒåº¦ä»»åŠ¡"></a>@Scheduleï¼šè°ƒåº¦ä»»åŠ¡</h4><p>ä»<code>spring 2.5</code>å¼€å§‹ï¼Œå¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨æ³¨è§£æ¥å£°æ˜<code>bean</code>ï¼Œå¯¹äºå®šæ—¶ä»»åŠ¡ï¼ŒåŒæ ·æä¾›äº†æ³¨è§£<code>@Scheduled</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Scheduled  </div><div class="line">&#123;  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">cron</span><span class="params">()</span></span>;  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">fixedDelay</span><span class="params">()</span></span>;  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">fixedRate</span><span class="params">()</span></span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>cron</code>ï¼šæŒ‡å®š<code>cron</code>è¡¨è¾¾å¼</li>
<li><code>fixedDelay</code>ï¼šè¡¨ç¤ºä»ä¸Šä¸€ä¸ªä»»åŠ¡å®Œæˆå¼€å§‹åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡å¼€å§‹çš„é—´éš”ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚</li>
<li><code>fixedRate</code>ï¼šè¡¨ç¤ºä»ä¸Šä¸€ä¸ªä»»åŠ¡å¼€å§‹åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡å¼€å§‹çš„é—´éš”ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚</li>
</ul>
<h5 id="æ³¨è§£é…ç½®"><a href="#æ³¨è§£é…ç½®" class="headerlink" title="æ³¨è§£é…ç½®"></a>æ³¨è§£é…ç½®</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- ä»»åŠ¡è°ƒåº¦å™¨ --&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">task:scheduler</span> <span class="attr">id</span>=<span class="string">"scheduler"</span> <span class="attr">pool-size</span>=<span class="string">"10"</span> /&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!--å¼€å¯è¿™ä¸ªé…ç½®ï¼Œspringæ‰èƒ½è¯†åˆ«@Scheduledæ³¨è§£, @Asyncæ³¨è§£--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">task:annotation-driven</span> <span class="attr">scheduler</span>=<span class="string">"scheduler"</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p><code>proxy-target-class=&quot;true&quot;</code>ï¼šè¡¨ç¤ºä½¿ç”¨<code>cglib</code>ä»£ç†</p>
<h5 id="ä»»åŠ¡Job-1"><a href="#ä»»åŠ¡Job-1" class="headerlink" title="ä»»åŠ¡Job"></a>ä»»åŠ¡Job</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskJob</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Scheduled</span>(cron = <span class="string">"0 * * * * ?"</span>)</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"ä»»åŠ¡è¿›è¡Œä¸­."</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>@Schedule</code>æ³¨è§£è¡¨ç¤ºè¯¥ä»»åŠ¡æ—¢ç”±<code>ThreadPoolTaskScheduler</code>è°ƒåº¦åŒæ—¶ä¹Ÿæœ‰è¯¥çº¿ç¨‹æ± æ‰§è¡Œ(ä¸ä¸Šé¢çš„xmlé…ç½®ä½œç”¨ç›¸åŒ)</p>
<h4 id="Asyncï¼šå¼‚æ­¥ä»»åŠ¡"><a href="#Asyncï¼šå¼‚æ­¥ä»»åŠ¡" class="headerlink" title="@Asyncï¼šå¼‚æ­¥ä»»åŠ¡"></a>@Asyncï¼šå¼‚æ­¥ä»»åŠ¡</h4><p>å¯¹äºå¼‚æ­¥ä»»åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨æ³¨è§£<code>@Async</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Async &#123;</div><div class="line">  </div><div class="line">	<span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥åœ¨æ³¨è§£çš„åœ°æ–¹æŒ‡å®šä»»åŠ¡æ‰§è¡Œçš„çº¿ç¨‹æ± (ä½œç”¨ä¸<code>executor=&quot;executor&quot;</code>ç›¸åŒ)ï¼Œæ–¹å¼ï¼š<code>@Async(&quot;executor&quot;)</code></p>
<h5 id="æ³¨è§£é…ç½®-1"><a href="#æ³¨è§£é…ç½®-1" class="headerlink" title="æ³¨è§£é…ç½®"></a>æ³¨è§£é…ç½®</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- ä»»åŠ¡æ‰§è¡Œå™¨ --&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">task:executor</span> <span class="attr">id</span>=<span class="string">"executor"</span> <span class="attr">pool-size</span>=<span class="string">"10"</span>/&gt;</span>  </div><div class="line">  </div><div class="line"><span class="comment">&lt;!--å¼€å¯æ³¨è§£è°ƒåº¦æ”¯æŒ @Async @Scheduled--&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">task:annotation-driven</span> <span class="attr">executor</span>=<span class="string">"executor"</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span>/&gt;</span></div></pre></td></tr></table></figure>
<h5 id="ä»»åŠ¡Job-2"><a href="#ä»»åŠ¡Job-2" class="headerlink" title="ä»»åŠ¡Job"></a>ä»»åŠ¡Job</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskJob</span> </span>&#123;</div><div class="line">  </div><div class="line">  <span class="meta">@Async</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"ä»»åŠ¡è¿›è¡Œä¸­."</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="åŒæ—¶ä½¿ç”¨-Schedule-Async"><a href="#åŒæ—¶ä½¿ç”¨-Schedule-Async" class="headerlink" title="åŒæ—¶ä½¿ç”¨@Schedule @Async"></a>åŒæ—¶ä½¿ç”¨@Schedule @Async</h4><p>æœ‰æ—¶å€™æ‰§è¡Œä»»åŠ¡éœ€è¦çš„æ—¶é—´æ¯”è¾ƒé•¿ï¼Œå¯ä»¥è®©<code>scheduler</code>åªåšè°ƒåº¦ï¼Œè€Œè®© <code>executor</code> æ¥æ‰§è¡Œæˆ‘ä»¬çš„ä»»åŠ¡</p>
<h5 id="æ³¨è§£é…ç½®-2"><a href="#æ³¨è§£é…ç½®-2" class="headerlink" title="æ³¨è§£é…ç½®"></a>æ³¨è§£é…ç½®</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">task:scheduler</span> <span class="attr">id</span>=<span class="string">"scheduler"</span> <span class="attr">pool-size</span>=<span class="string">"10"</span> /&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!--é…ç½®å®šæ—¶ä»»åŠ¡--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">task:scheduled-tasks</span> <span class="attr">scheduler</span>=<span class="string">"scheduler"</span>&gt;</span>   </div><div class="line">        <span class="tag">&lt;<span class="name">task:scheduled</span> <span class="attr">ref</span>=<span class="string">"taskJob"</span> <span class="attr">method</span>=<span class="string">"execute"</span> <span class="attr">cron</span>=<span class="string">"0 * * * * ?"</span>/&gt;</span>   </div><div class="line"><span class="tag">&lt;/<span class="name">task:scheduled-tasks</span>&gt;</span>  </div><div class="line"></div><div class="line"><span class="comment">&lt;!-- ä»»åŠ¡æ‰§è¡Œå™¨ --&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">task:executor</span> <span class="attr">id</span>=<span class="string">"executor"</span> <span class="attr">pool-size</span>=<span class="string">"10"</span>/&gt;</span>  </div><div class="line">  </div><div class="line"><span class="comment">&lt;!--å¼€å¯æ³¨è§£è°ƒåº¦æ”¯æŒ @Async @Scheduled--&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">task:annotation-driven</span> <span class="attr">executor</span>=<span class="string">"executor"</span> <span class="attr">scheduler</span>=<span class="string">"scheduler"</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼š</strong>ä¸Šè¿°XMLé…ç½®ä¿¡æ¯ï¼Œå…¶ä¸­å¤„ç†ä»»åŠ¡çš„<code>executor</code>å¼•ç”¨é…ç½®ï¼Œç›¸å½“äº<code>@Async</code>æ³¨è§£ï¼›ç®¡ç†ä»»åŠ¡çš„<code>Scheduler</code>ç›¸å½“äº<code>@Scheduled</code>æ³¨è§£ã€‚</p>
<h5 id="ä»»åŠ¡Job-3"><a href="#ä»»åŠ¡Job-3" class="headerlink" title="ä»»åŠ¡Job"></a>ä»»åŠ¡Job</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskJob</span> </span>&#123;</div><div class="line">  </div><div class="line">  <span class="meta">@Async</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"ä»»åŠ¡è¿›è¡Œä¸­."</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·å­ï¼Œ<code>execute</code>çš„æ–¹æ³•ï¼Œå°±ä¼šç”±<code>executor</code> çº¿ç¨‹æ± æ¥æ‰§è¡Œäº†ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://emacsist.github.io/2015/11/10/Spring-Task-%E4%BD%BF%E7%94%A8/" target="_blank" rel="external">Spring Task ä½¿ç”¨</a></p>
<p><a href="https://www.dexcoder.com/selfly/article/3951" target="_blank" rel="external">Spring 3å®ç°å®šæ—¶ä»»åŠ¡</a></p>
<p><a href="https://sanjay-f.github.io/2015/08/24/Spring%E7%9A%84%E4%B8%A4%E7%A7%8D%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6Scheduled%E5%92%8CAsync/" target="_blank" rel="external">Springçš„ä¸¤ç§ä»»åŠ¡è°ƒåº¦Scheduledå’ŒAsync</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[tomcat filteråˆ†æ]]></title>
      <url>http://zsr.github.io/2017/11/15/tomcat-filter%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><ul>
<li><code>Filter</code>æ˜¯<code>servlet</code>è§„èŒƒä¸­å®šä¹‰çš„<code>java web</code>ç»„ä»¶, åœ¨æ‰€æœ‰æ”¯æŒ<code>java web</code>çš„å®¹å™¨ä¸­éƒ½å¯ä»¥ä½¿ç”¨</li>
<li><code>Filter</code>å’Œ<code>FilterChain</code>å¯†ä¸å¯åˆ†, <code>Filter</code>å¯ä»¥å®ç°ä¾æ¬¡è°ƒç”¨æ­£æ˜¯å› ä¸ºæœ‰äº†<code>FilterChain</code></li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2017/1/16/7714d7aa0f6632da5463aef03464fc54?imageView2/0/w/1280/h/960/ignore-error/1" alt="img"></p>
<h4 id="Filteræ¥å£"><a href="#Filteræ¥å£" class="headerlink" title="Filteræ¥å£"></a>Filteræ¥å£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Filter.class</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Filter</span> </span>&#123;</div><div class="line"></div><div class="line">         <span class="comment">// å®¹å™¨åˆ›å»ºçš„æ—¶å€™è°ƒç”¨, å³å¯åŠ¨tomcatçš„æ—¶å€™è°ƒç”¨</span></div><div class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException</span>;</div><div class="line"></div><div class="line">         <span class="comment">// ç”±FilterChainè°ƒç”¨, å¹¶ä¸”ä¼ å…¥FilterChainæœ¬èº«, æœ€åå›è°ƒFilterChainçš„doFilter()æ–¹æ³•</span></div><div class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></div><div class="line">                 FilterChain chain) <span class="keyword">throws</span> IOException, ServletException;</div><div class="line"></div><div class="line">         <span class="comment">// å®¹å™¨é”€æ¯çš„æ—¶å€™è°ƒç”¨, å³å…³é—­tomcatçš„æ—¶å€™è°ƒç”¨</span></div><div class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<h4 id="FilterChainæ¥å£"><a href="#FilterChainæ¥å£" class="headerlink" title="FilterChainæ¥å£"></a>FilterChainæ¥å£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// FilterChain.class</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FilterChain</span> </span>&#123;</div><div class="line"></div><div class="line">         <span class="comment">// ç”±Filter.doFilter()ä¸­çš„chain.doFilterè°ƒç”¨</span></div><div class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span></div><div class="line">             <span class="keyword">throws</span> IOException, ServletException;</div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h3 id="Tomcat-filteræºç "><a href="#Tomcat-filteræºç " class="headerlink" title="Tomcat filteræºç "></a>Tomcat filteræºç </h3><h4 id="åˆ›å»ºFilterChain"><a href="#åˆ›å»ºFilterChain" class="headerlink" title="åˆ›å»ºFilterChain"></a>åˆ›å»ºFilterChain</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// StandardWrapperValve.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line">    <span class="comment">// .....çœç•¥......</span></div><div class="line">      </div><div class="line">      MessageBytes requestPathMB = request.getRequestPathMB();</div><div class="line">      DispatcherType dispatcherType = DispatcherType.REQUEST;</div><div class="line">      <span class="keyword">if</span> (request.getDispatcherType()==DispatcherType.ASYNC) </div><div class="line">          dispatcherType = DispatcherType.ASYNC;</div><div class="line">      request.setAttribute(Globals.DISPATCHER_TYPE_ATTR,dispatcherType);</div><div class="line">      request.setAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR,</div><div class="line">                requestPathMB);</div><div class="line">      <span class="comment">// Create the filter chain for this request</span></div><div class="line">      ApplicationFilterChain filterChain =</div><div class="line">                ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</div><div class="line">  </div><div class="line">      <span class="comment">// Call the filter chain for this request</span></div><div class="line">      <span class="comment">// <span class="doctag">NOTE:</span> This also calls the servlet's service() method</span></div><div class="line">      <span class="comment">// .....çœç•¥......</span></div><div class="line">      <span class="comment">// æ‰§è¡Œè¿‡æ»¤å™¨é“¾doFilter()</span></div><div class="line">      filterChain.doFilter(request.getRequest(), response.getResponse());</div><div class="line">      <span class="comment">// .....çœç•¥......</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æ¯æ¬¡è¯·æ±‚è¿‡æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ªè¿‡æ»¤å™¨é“¾(<code>filterChain</code>)ï¼Œå¹¶æŠŠå¾…æ‰§è¡Œçš„<code>servlet</code>å¯¹è±¡å­˜æ”¾åˆ°è¿‡æ»¤å™¨é“¾ä¸­ã€‚å¯¹äºæ¯ä¸ªurlï¼Œå¯¹åº”çš„<code>filter</code>ä¸ªæ•°éƒ½æ˜¯ä¸å›ºå®šçš„ï¼Œ<code>filterchain</code>éœ€è¦ä¿å­˜æ¯ä¸ªè¯·æ±‚æ‰€å¯¹åº”çš„ä¸€ä¸ª<code>filter</code>æ•°ç»„ï¼Œä»¥åŠè°ƒç”¨åˆ°çš„<code>filter</code>çš„<code>position</code>ï¼Œä»¥ä¾¿ç»§ç»­å‘ä¸‹è°ƒç”¨<code>filter</code></p>
<a id="more"></a>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ApplicationFilterFactory.class</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationFilterChain <span class="title">createFilterChain</span><span class="params">(ServletRequest request,</span></span></div><div class="line">            Wrapper wrapper, Servlet servlet) &#123;</div><div class="line"> 	<span class="comment">// .....çœç•¥......</span></div><div class="line">   </div><div class="line">    <span class="comment">// Acquire the filter mappings for this Context</span></div><div class="line">    StandardContext context = (StandardContext) wrapper.getParent();</div><div class="line">        FilterMap filterMaps[] = context.findFilterMaps();</div><div class="line"></div><div class="line">    <span class="comment">// If there are no filter mappings, we are done</span></div><div class="line">    <span class="keyword">if</span> ((filterMaps == <span class="keyword">null</span>) || (filterMaps.length == <span class="number">0</span>))</div><div class="line">            <span class="keyword">return</span> (filterChain);</div><div class="line">   </div><div class="line">   <span class="comment">// Add the relevant path-mapped filters to this filter chain </span></div><div class="line">   <span class="comment">// æ ¹æ®è¯·æ±‚urlæ‰¾åˆ°åŒ¹é…çš„filterï¼Œæ·»åŠ è¿›æ¥</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</div><div class="line">         <span class="keyword">if</span> (!matchFiltersURL(filterMaps[i], requestPath))</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        ...</div><div class="line">        filterChain.addFilter(filterConfig);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add filters that match on servlet name second</span></div><div class="line">    <span class="comment">// å¦‚æœé…ç½®äº†æ ¹æ®servletåç§°è¿‡æ»¤ï¼Œåˆ™å†å¯»æ‰¾ä¸€éfilter</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (!matchFiltersServlet(filterMaps[i], servletName))</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        ...</div><div class="line">        filterChain.addFilter(filterConfig);</div><div class="line">    &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>åˆ›å»ºé¡ºåºï¼š</p>
<ol>
<li>æŠŠè¦æ‰§è¡Œçš„<code>servlet</code>å­˜æ”¾åˆ°è¿‡æ»¤å™¨é“¾ä¸­ã€‚</li>
<li>å¦‚æœæ²¡æœ‰é…ç½®è¿‡æ»¤å™¨åˆ™<code>return</code>ä¸€ä¸ªç©ºçš„è¿‡æ»¤å™¨é“¾ï¼ˆåªåŒ…å«ä¸Šé¢è®¾ç½®çš„servletï¼‰ã€‚</li>
<li>å¦‚æœé…ç½®<code>url-pattern</code>è¿‡æ»¤å™¨ï¼Œåˆ™æŠŠåŒ¹é…çš„è¿‡æ»¤å™¨åŠ å…¥åˆ°è¿‡æ»¤å™¨é“¾ä¸­</li>
<li>å¦‚æœé…ç½®<code>servlet-name</code>è¿‡æ»¤å™¨ï¼Œåˆ™æŠŠåŒ¹é…çš„è¿‡æ»¤å™¨åŠ å…¥åˆ°è¿‡æ»¤å™¨é“¾ä¸­</li>
</ol>
<p><strong>æ³¨æ„: <code>filterChain.addFilter()</code>é¡ºåºä¸<code>web.xml</code>ä¸­å®šä¹‰çš„<code>Filter</code>é¡ºåºä¸€è‡´ï¼Œæ‰€ä»¥è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºæ˜¯æŒ‰å®šä¹‰çš„ä¸Šä¸‹é¡ºåºå†³å®šçš„ã€‚</strong></p>
<h4 id="è¿‡æ»¤å™¨é“¾æ‰§è¡Œ"><a href="#è¿‡æ»¤å™¨é“¾æ‰§è¡Œ" class="headerlink" title="è¿‡æ»¤å™¨é“¾æ‰§è¡Œ"></a>è¿‡æ»¤å™¨é“¾æ‰§è¡Œ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// StandardWrapperValve.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line">      <span class="comment">// .....çœç•¥......</span></div><div class="line">     <span class="keyword">if</span> ((servlet != <span class="keyword">null</span>) &amp;&amp; (filterChain != <span class="keyword">null</span>)) &#123;</div><div class="line">      <span class="comment">// æ‰§è¡Œè¿‡æ»¤å™¨é“¾doFilter()</span></div><div class="line">      filterChain.doFilter(request.getRequest(), response.getResponse());</div><div class="line">      <span class="comment">// .....çœç•¥......</span></div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœ<code>servlet</code>å’Œè¿‡æ»¤å™¨é“¾éƒ½ä¸ä¸ºç©ºï¼Œåˆ™å¼€å§‹è°ƒç”¨è¿‡æ»¤å™¨é“¾çš„<code>doFilter()</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line">    <span class="comment">// .....çœç•¥......</span></div><div class="line">    <span class="comment">// ***æ•´ä¸ªFilteræµç¨‹çš„å®ç°å°±æ˜¯ç”±è¿™ä¸ªæ–¹æ³•å®Œæˆ***</span></div><div class="line">  	internalDoFilter(request,response);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="ApplicationFilterChain-internalDoFilter"><a href="#ApplicationFilterChain-internalDoFilter" class="headerlink" title="ApplicationFilterChain.internalDoFilter()"></a>ApplicationFilterChain.internalDoFilter()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">internalDoFilter</span><span class="params">(ServletRequest request,</span></span></div><div class="line">                                 ServletResponse response)</div><div class="line">       <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line">	<span class="comment">// Call the next filter if there is one</span></div><div class="line">   <span class="keyword">if</span> (pos &lt; n) &#123;</div><div class="line">       ApplicationFilterConfig filterConfig = filters[pos++];</div><div class="line">       <span class="comment">// è·å–Filter</span></div><div class="line">       Filter filter = filterConfig.getFilter();</div><div class="line">       <span class="comment">// .....çœç•¥......</span></div><div class="line">       <span class="comment">// è°ƒç”¨Filterçš„doFilteræ–¹æ³•å¹¶æŠŠFilterChainæœ¬èº«ä¼ è¿›å»(this)</span></div><div class="line">       filter.doFilter(request, response, <span class="keyword">this</span>);</div><div class="line">     </div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">  </div><div class="line">    <span class="comment">// We fell off the end of the chain -- call the servlet instance</span></div><div class="line">    <span class="comment">// .....çœç•¥......</span></div><div class="line">    <span class="comment">// è¿‡æ»¤å™¨å…¨éƒ¨æ‰§è¡Œåï¼Œæ‰§è¡ŒServletçš„serviceæ–¹æ³•(è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘)</span></div><div class="line">    servlet.service(request, response); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> <code>FilterChain</code>è°ƒç”¨<code>Filter</code>åï¼Œ<code>Filter</code>å†æ‰§è¡Œ<code>FilterChain.doFilter(request, response)</code>ï¼Œå¯è§<code>FilterChain</code>ä¸<code>Filter</code>æ„æˆå›è°ƒæ¨¡å¼(è¿™ä¸ªä¹Ÿæ˜¯ä¸<code>Spring Interceptor</code>ä¸åŒç‚¹, <code>Interceptor</code>åŸºäº<code>java</code>åå°„æœºåˆ¶)</p>
<h3 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>å‡è®¾ä¸‹é¢çš„<code>Filter</code>å°±æ˜¯è°ƒç”¨é“¾ä¸­çš„æœ€åä¸€ä¸ª<code>Filter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></div><div class="line">            FilterChain chain) <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">        Log.info(<span class="string">"before"</span>);</div><div class="line">        chain.doFilter(request, response);       </div><div class="line">        Log.info(<span class="string">"after"</span>);</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>åœ¨<code>LogFilter</code>è°ƒç”¨<code>chain.doFilter</code>ä¹‹åå°±è·³è¿‡äº†<code>if</code>è¯­å¥ä»è€Œè°ƒç”¨äº†çœŸæ­£çš„<code>servlet</code>, ç„¶å<code>internalDoFilter</code>æ–¹æ³•å°±ç»“æŸ(å‡ºæ ˆ)äº†, ç´§æ¥ç€å°±æ˜¯è°ƒç”¨<code>Log.info(&quot;after&quot;)</code>äº†, ç„¶å<code>LogFilterçš„doFilterå°±ç»“æŸäº†(ä¹Ÿå‡ºæ ˆäº†)</code>, ç´§æ¥ç€å°±æ˜¯<code>internalDoFilter</code>ä¸­<code>filter.doFilter(request, response, this)</code>çš„ç»“æŸç„¶å<code>return</code>, ç„¶åå°±æ˜¯è°ƒç”¨ä¸Šä¸€ä¸ª<code>filter</code>çš„<code>chain.doFilter()</code>ä¹‹åçš„ä»£ç , ä»¥æ­¤ç±»æ¨.</li>
<li><code>Filter</code>è°ƒç”¨é“¾çš„å®ç°å…¶å®å°±æ˜¯ä¸€ä¸ªæ–¹æ³•è°ƒç”¨é“¾çš„è¿‡ç¨‹. åˆšå¼€å§‹, <code>Filter Chain</code>æ¯è°ƒç”¨ä¸€ä¸ª<code>Filter.doFilter()</code>æ–¹æ³•å°±æ˜¯å‘æ–¹æ³•è°ƒç”¨æ ˆä¸­è¿›è¡Œå‹æ ˆæ“ä½œ(ä»£ç ä¸Šçš„ä½“ç°å°±æ˜¯æ‰§è¡Œ<code>Filter.doFilter</code>ä¹‹å‰çš„ä»£ç ), å½“<code>Filter</code>å…¨éƒ¨è°ƒç”¨å®Œæˆä¹‹åå°±è°ƒç”¨çœŸæ­£å¤„ç†è¯·æ±‚çš„<code>servlet</code>, ç„¶åç”±æ–¹æ³•è°ƒç”¨é“¾è‡ªåŠ¨è¿›è¡Œå‡ºæ ˆæ“ä½œ(ä»£ç ä¸Šçš„ä½“ç°å°±æ˜¯æ‰§è¡Œ<code>Filter.doFilter</code>ä¹‹åçš„ä»£ç ), ä»è€Œå®Œæˆæ•´ä¸ª<code>Filter</code>çš„è°ƒç”¨é“¾. <strong>å› ä¸º<code>Filter</code>åŠŸèƒ½å®ç°å®é™…ä¸Šå°±æ˜¯åˆ©ç”¨äº†æ–¹æ³•çš„å‹æ ˆå‡ºæ ˆ</strong>, æ‰€ä»¥å¯ä»¥åœ¨è°ƒç”¨<code>chain.doFilter</code>ä¹‹å‰å°†æ–¹æ³•è¿”å›, è®©å®¹å™¨ä¸åœ¨è°ƒç”¨<code>servlet</code>æ–¹æ³•, ä»è€Œå®ç°æƒé™çš„æ§åˆ¶, å…³é”®è¯çš„è¿‡æ»¤ç­‰åŠŸèƒ½.</li>
</ol>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.bijishequ.com/detail/519398?p=" target="_blank" rel="external">Tomcat Filter æºç åˆ†æ</a></p>
<p><a href="https://juejin.im/entry/587c3a125c497d0058a84537" target="_blank" rel="external">Filter å’Œ Interceptor çš„æ¯”è¾ƒ</a></p>
<p>â€‹     </p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ä¸­æ–‡ä¹±ç ]]></title>
      <url>http://zsr.github.io/2017/10/26/%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81/</url>
      <content type="html"><![CDATA[<h3 id="ä¹±ç åŸå› "><a href="#ä¹±ç åŸå› " class="headerlink" title="ä¹±ç åŸå› "></a>ä¹±ç åŸå› </h3><p>å­—ç¬¦åœ¨ä¿å­˜æ—¶çš„ç¼–ç æ ¼å¼å¦‚æœå’Œè¦æ˜¾ç¤ºçš„ç¼–ç æ ¼å¼ä¸ä¸€æ ·çš„è¯ï¼Œå°±ä¼šå‡ºç°ä¹±ç é—®é¢˜ã€‚Javaåœ¨è¿è¡ŒæœŸä¸€å¾‹ä»¥<code>Unicode</code>æ¥å­˜å‚¨å­—ç¬¦,è¿™æ ·æœ‰åˆ©çš„æ”¯æŒäº†å¤šè¯­è¨€ç¯å¢ƒã€‚Javaè¯»æ–‡ä»¶çš„æ—¶å€™ä¼šç”¨åˆ°ç³»ç»Ÿé»˜è®¤çš„ç¼–ç æ¥è§£ç æ–‡ä»¶ã€‚æ‰€ä»¥åœ¨ç”¨<code>FileInputStream</code>ç±»è¯»å–æ–‡ä»¶å¯ä»¥æŒ‡å®šç¼–ç è¯»å–ã€‚ã€€</p>
<p><code>JAVA</code>åœ¨ç½‘ç»œä¼ è¾“ä¸­ä½¿ç”¨çš„ç¼–ç æ˜¯<code>ISO-8859-1</code>ï¼Œæ•…åœ¨è¾“å‡ºæ—¶éœ€è¦è¿›è¡Œè½¬åŒ–ï¼Œå¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">String str=<span class="keyword">new</span> String(str.getBytes(<span class="string">"å¼€å‘ç¯å¢ƒç¼–ç "</span>),<span class="string">"ISO-8859-1"</span>);</div></pre></td></tr></table></figure>
<p>ç»è¿‡ç½‘ç»œç¼–ç åçš„ä¸­æ–‡ï¼Œè¦æ­£ç¡®æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šå¿…é¡»è¦ç”¨ç±»ä¼¼äº:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Stirng str=<span class="keyword">new</span> String(str.getBytes(<span class="string">"ISO-8859-1"</span>),<span class="string">"å¼€å‘ç¯å¢ƒç¼–ç "</span>);</div></pre></td></tr></table></figure>
<h3 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>æµè§ˆå™¨è¯·æ±‚æœåŠ¡ï¼ŒæœåŠ¡å™¨è¿”å›å“åº”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http requestâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”&gt;http response</div></pre></td></tr></table></figure>
<p><code>request</code>è¯·æ±‚è¿‡ç¨‹ï¼š</p>
<ul>
<li>æµè§ˆå™¨<code>http</code>å“åº”å¢åŠ ä¸€ä¸ª<code>Content-Type:text/html; charset=utf-8</code>,å‘é€è¯·æ±‚</li>
<li><code>Tomcat</code>æ¥å—è¯·æ±‚(ä¸è®¾ç½®<code>URIEncodng</code>)</li>
<li><code>java</code>æœåŠ¡ç«¯å¤„ç†è¯·æ±‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line">    System.out.println(<span class="string">"name: "</span>+newString(req.getParameter(<span class="string">"name"</span>).getBytes(<span class="string">"iso8859-1"</span>),<span class="string">"utf-8"</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¼–ç è½¬æ¢è¿‡ç¨‹ï¼š</p>
<ul>
<li>æµè§ˆå™¨å¯¹å­—ç¬¦åšç™¾åˆ†å·ç¼–ç </li>
<li><code>Tomcat</code>è§£ç™¾åˆ†å·ç¼–ç </li>
<li><code>ISO8859-1</code>ç¼–ç è½¬<code>Java</code>å†…ç </li>
<li><code>Java</code>å†…ç è½¬<code>ISO8859-1</code>ç¼–ç </li>
<li>æŠŠå­—èŠ‚æ•°ç»„å½“æˆ<code>utf-8</code>ç¼–ç è½¬<code>Java</code>å†…ç </li>
<li><p><code>Java</code>å†…ç è½¬è¾“å‡ºç¼–ç </p>
<p><strong>æ³¨ï¼š</strong></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String.getBytes(<span class="string">"utf-8"</span>): æŠŠjavaå†…ç è½¬æˆutf-<span class="number">8</span>ç¼–ç </div><div class="line"><span class="keyword">new</span> String(bytes[],<span class="string">"utf-8"</span>): æŠŠå­—èŠ‚æ•°ç»„å½“æˆutf-<span class="number">8</span>ç¼–ç è½¬æˆjavaå†…ç </div></pre></td></tr></table></figure>
<h4 id="æµè§ˆå™¨å¯¹å­—ç¬¦åšç™¾åˆ†å·ç¼–ç "><a href="#æµè§ˆå™¨å¯¹å­—ç¬¦åšç™¾åˆ†å·ç¼–ç " class="headerlink" title="æµè§ˆå™¨å¯¹å­—ç¬¦åšç™¾åˆ†å·ç¼–ç "></a><strong>æµè§ˆå™¨å¯¹å­—ç¬¦åšç™¾åˆ†å·ç¼–ç </strong></h4><p>å¯¹äº[ä¸­å›½]è¿™ä¸¤ä¸ªå­—ç¬¦ï¼Œä»–ä»¬çš„<code>utf-8</code>ç¼–ç åˆ†åˆ«æ˜¯<code>0xE4B8AD</code>ã€<code>0xE59BBD</code>ï¼Œæ¯ä¸ªå­—ç¬¦å ç”¨ä¸‰ä¸ªå­—èŠ‚ã€‚ç»è¿‡ç™¾åˆ†å·ç¼–ç åå˜æˆäº†<code>%E4%B8%AD</code>ã€<code>%E5%9B%BD</code>ï¼Œå¯ä»¥çœ‹åˆ°ç™¾åˆ†å·ç¼–ç å¯¹åŸå§‹ç¼–ç æ˜¯æ— æŸçš„ï¼Œå®ƒåªæ˜¯æŠŠ<strong>åŸå§‹å­—èŠ‚</strong>å˜æˆäº†<strong>%+åŸå§‹å­—èŠ‚</strong>çš„16è¿›åˆ¶è¡¨ç¤ºã€‚æ¯”å¦‚å­—èŠ‚<code>0xE4</code>ï¼Œè½¬æˆç™¾åˆ†å·ç¼–ç ä¸º<code>%E4</code>ï¼Œæœ‰ä¸€ä¸ªå­—èŠ‚å˜æˆäº†ä¸‰ä¸ªå­—èŠ‚ã€‚</p>
<h4 id="Tomcatè§£ç ç™¾åˆ†å·ç¼–ç "><a href="#Tomcatè§£ç ç™¾åˆ†å·ç¼–ç " class="headerlink" title="Tomcatè§£ç ç™¾åˆ†å·ç¼–ç "></a><strong>Tomcatè§£ç ç™¾åˆ†å·ç¼–ç </strong></h4><p>è§£ç ç™¾åˆ†å·ç¼–ç ä¹Ÿå¾ˆç®€å•ï¼Œå…¶å®å°±æ˜¯å»æ‰ç™¾åˆ†å·ï¼Œç„¶åå°†ç™¾åˆ†å·åçš„ä¸¤ä¸ªå­—èŠ‚åˆå¹¶æˆä¸€ä¸ªå­—èŠ‚ï¼Œå¦‚ç™¾åˆ†å·ç¼–ç <code>%E4</code>ï¼Œè§£ç åå˜ä¸ºå­—èŠ‚<code>0xE4</code>ã€‚åˆ°è¿™ä¸€æ­¥â€œä¸­å›½â€è¿™ä¸¤ä¸ªå­—ç¬¦å°±å˜æˆäº†<code>0xE4B8AD</code>ã€<code>0xE59BBD</code>ã€‚</p>
<h4 id="ISO8859-1è½¬javaå†…ç "><a href="#ISO8859-1è½¬javaå†…ç " class="headerlink" title="ISO8859-1è½¬javaå†…ç "></a>ISO8859-1è½¬javaå†…ç </h4><p><code>ISO8859-1</code>ä¸<code>ascii</code>ä¸€æ ·éƒ½æ˜¯å•å­—èŠ‚å­—ç¬¦é›†ï¼Œä¸åŒçš„æ˜¯å®ƒæŠŠæœ€é«˜ä½åˆ©ç”¨èµ·æ¥äº†ï¼Œå¢åŠ äº†ä¸€äº›è¥¿æ–¹å­—ç¬¦(å¦‚Â±ã€Ã·ç­‰å­—ç¬¦)</p>
<p>è¿™é‡Œè¯´çš„<code>java</code>å†…ç æ˜¯<code>java</code>ç¨‹åºè¿è¡Œæ—¶ï¼Œåœ¨å†…å­˜ä¸­å­˜å‚¨å­—ç¬¦çš„ç¼–ç ï¼Œç”¨çš„æ˜¯<code>unicode</code>æ ‡å‡†ä¸­å®šä¹‰çš„<code>utf-16</code>ç¼–ç </p>
<p><code>utf-16</code>æ˜¯æŠŠ<code>unicode</code>å­—ç¬¦ç¼–ç æˆ2å­—èŠ‚æˆ–4å­—èŠ‚ã€‚<code>ISO8859-1</code>æ˜¯8ä½é•¿çš„å•å­—èŠ‚å­—ç¬¦ç¼–ç ï¼Œæ‰€ä»¥<code>utf-16</code>ç¼–ç å’Œ<code>ISO8859-1</code>ç¼–ç æ˜¯ä¸å…¼å®¹çš„ï¼Œä½†æ˜¯utf-16åŒ…å«ISO8859-1ä¸­çš„æ‰€æœ‰å­—ç¬¦.</p>
<p>Tomcatè§£ç ç™¾åˆ†å·ç¼–ç åï¼Œ[ä¸­å›½]è¿™ä¸¤ä¸ªå­—ç¬¦åœ¨å†…å­˜ä¸­æ˜¯è¿™æ ·çš„<code>0xE4B8ADE59BBD</code>ï¼Œæ­£å¥½å…­ä¸ªå­—èŠ‚ã€‚è¿™å…¶å®æ˜¯è¿™ä¸¤ä¸ªå­—ç¬¦çš„<code>utf-8</code>ç¼–ç åºåˆ—ï¼Œä½†æ˜¯ç”±äºå¹¶æ²¡æœ‰å‘Šè¯‰<code>tomcat</code>è¿™æ˜¯ä»€ä¹ˆå­—ç¬¦ç¼–ç åºåˆ—ï¼Œæ‰€ä»¥<code>tomcat</code>å°±è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ª<code>ISO8859-1</code>ç¼–ç åºåˆ—ï¼Œå¹¶æŠŠå®ƒå‘Šè¯‰äº†javaç¨‹åºï¼Œjavaç¨‹åºè¦åšçš„å°±æ˜¯æŠŠè¿™ä¸ªå­—èŠ‚åºåˆ—æŒ‰ç…§<code>ISO8859-1</code>è½¬æ¢æˆ<code>utf-16</code>ï¼Œè½¬æ¢æˆåŠŸåçš„å¯¹åº”å…³ç³»æ˜¯è¿™æ ·çš„:</p>
<table>
<thead>
<tr>
<th>ISO8859-1</th>
<th>0xE4</th>
<th>0xB8</th>
<th>0xAD</th>
<th>0xE5</th>
<th>0x9B</th>
<th>0xBD</th>
</tr>
</thead>
<tbody>
<tr>
<td>UTF-16</td>
<td>0x00E4</td>
<td>0x00B8</td>
<td>0x00AD</td>
<td>0x00E5</td>
<td>0x009B</td>
<td>0x00BD</td>
</tr>
</tbody>
</table>
<p>å¯ä»¥çœ‹åˆ°åŸæœ¬çš„ä¸¤ä¸ªå­—ç¬¦ï¼Œåœ¨javaä¸­å˜æˆäº†å…­ä¸ªå­—ç¬¦;åŸæœ¬çš„å…­ä¸ªå­—èŠ‚ï¼Œåœ¨javaä¸­å˜æˆäº†12ä¸ªå­—èŠ‚ã€‚</p>
<h4 id="Javaå†…ç è½¬æ¢æˆISO8859-1ç¼–ç "><a href="#Javaå†…ç è½¬æ¢æˆISO8859-1ç¼–ç " class="headerlink" title="Javaå†…ç è½¬æ¢æˆISO8859-1ç¼–ç "></a>Javaå†…ç è½¬æ¢æˆISO8859-1ç¼–ç </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">req.getParameter(<span class="string">"name"</span>).getBytes(<span class="string">"iso8859-1"</span>)</div></pre></td></tr></table></figure>
<p><code>getBytes(â€œiso8859-1â€)</code>è¿™ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æŠŠ<code>utf-16</code>è½¬æ¢æˆ<code>ISO8859-1</code>ã€‚æœ‰ç¬¬ä¸‰æ­¥(ISO8859-1è½¬javaå†…ç )ä¸­çš„å¯¹åº”è¡¨æ ¼å¯ä»¥çœ‹åˆ°ï¼Œ<code>utf-16</code>è½¬<code>ISO8859-1</code>åªéœ€è¦æŠŠæ¯ä¸ªå­—ç¬¦å‰é¢çš„8ä½0å»æ‰å°±å¯ä»¥äº†ï¼Œè½¬æ¢æˆåŠŸåä¿©ä¸ªå­—ç¬¦å°±åˆå˜æˆäº†<code>0xE4B8ADE59BBD</code>ã€‚è™½ç„¶ä¸¤æ¬¡è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œå¯¹å­—èŠ‚çš„è§£é‡Šæ˜¯é”™è¯¯çš„ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä¸¢å¤±åŸå§‹å­—èŠ‚ä¿¡æ¯ã€‚</p>
<h4 id="æŠŠå­—èŠ‚æ•°ç»„å½“æˆutf-8ç¼–ç è½¬javaå†…ç "><a href="#æŠŠå­—èŠ‚æ•°ç»„å½“æˆutf-8ç¼–ç è½¬javaå†…ç " class="headerlink" title="æŠŠå­—èŠ‚æ•°ç»„å½“æˆutf-8ç¼–ç è½¬javaå†…ç "></a>æŠŠå­—èŠ‚æ•°ç»„å½“æˆutf-8ç¼–ç è½¬javaå†…ç </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> String(<span class="number">0xE4B8ADE59BBD</span>,<span class="string">"utf-8"</span>)</div></pre></td></tr></table></figure>
<p>å› ä¸ºå­—èŠ‚æ•°ç»„æœ¬æ¥å°±æ˜¯utf-8ç¼–ç ï¼Œæ‰€ä»¥æŒ‰ç…§utf-8æ¥è½¬ç è‚¯å®šæ˜¯æ²¡é—®é¢˜çš„ï¼Œè½¬æ¢æˆåŠŸåçš„å¯¹åº”å…³ç³»æ˜¯è¿™ä¸€æ ·çš„ï¼š</p>
<table>
<thead>
<tr>
<th>UTF-8</th>
<th>0xE4B8AD</th>
<th>0xE59BBD</th>
</tr>
</thead>
<tbody>
<tr>
<td>UTF-16</td>
<td>0x4E2D</td>
<td>0x56FD</td>
</tr>
</tbody>
</table>
<p>åˆ°è¿™é‡Œ[ä¸­å›½]è¿™ä¸¤ä¸ªå­—ç¬¦åœ¨javaå†…éƒ¨æ‰å¾—åˆ°äº†æ­£ç¡®çš„è¡¨ç¤ºã€‚ </p>
<h4 id="Javaå†…ç è½¬è¾“å‡ºç¼–ç "><a href="#Javaå†…ç è½¬è¾“å‡ºç¼–ç " class="headerlink" title="Javaå†…ç è½¬è¾“å‡ºç¼–ç "></a>Javaå†…ç è½¬è¾“å‡ºç¼–ç </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.println(<span class="string">"ä¸­å›½"</span>)</div></pre></td></tr></table></figure>
<p>ç°åœ¨[ä¸­å›½]è¿™ä¸¤ä¸ªå­—ç¬¦åœ¨javaå†…éƒ¨ç”¨<code>utf-16</code>å¾—åˆ°äº†æ­£ç¡®çš„è¡¨ç¤ºï¼Œå‰©ä¸‹çš„æœ€åä¸€æ­¥å°±æ˜¯å¯¹å¤–è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯å¯¹å¤–ç¿»è¯‘çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿™é‡Œç”¨çš„javaè‡ªå¸¦çš„<code>println</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæ ¹æ®å½“å‰å¹³å°çš„è‡ªèº«ç¼–ç è¿›è¡Œè¾“å‡ºï¼Œæ¯”å¦‚ä½ çš„å¹³å°ç¯å¢ƒæ˜¯ä¸­æ–‡ï¼Œé‚£è¾“å‡ºçš„å¯èƒ½å°±æ˜¯<code>GBK</code>ç¼–ç ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Unicodeå’ŒUTF-8å­—ç¬¦ç¼–ç ]]></title>
      <url>http://zsr.github.io/2017/10/25/Unicode%E5%92%8CUTF-8%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/</url>
      <content type="html"><![CDATA[<h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><ul>
<li><p><strong>Unicode: </strong>(<code>Universal Code</code> ç»Ÿä¸€ç )æ˜¯ä¸€ä¸ªå›Šæ‹¬äº†ä¸–ç•Œä¸Šæ‰€æœ‰å­—ç¬¦çš„å­—ç¬¦é›†ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªå­—ç¬¦éƒ½å¯¹åº”æœ‰å”¯ä¸€çš„ç¼–ç å€¼ï¼ˆ<code>code point</code>ï¼‰ï¼Œç„¶è€Œå®ƒå¹¶ä¸æ˜¯ä¸€ç§ä»€ä¹ˆç¼–ç æ ¼å¼ï¼Œä»…ä»…æ˜¯å­—ç¬¦é›†è€Œå·²</p>
<p><code>Unicode</code> å­—ç¬¦ä¸ç®¡å…·ä½“æ€ä¹ˆç¼–ç å’Œå­˜å‚¨ï¼Œå¯ä»¥ç”¨ <code>UTF-8</code>ã€<code>UTF-16</code>æ¥ç¼–ç </p>
<p><code>UTF-16</code> è¡¨ç¤ºå­—ç¬¦éå¸¸æ–¹ä¾¿ï¼Œæ¯ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œè¿™ä¸ªåœ¨å­—ç¬¦ä¸²æ“ä½œæ—¶å°±å¤§å¤§ç®€åŒ–äº†æ“ä½œï¼Œè¿™ä¹Ÿæ˜¯ Java ä»¥ <code>UTF-16</code> ä½œä¸ºå†…å­˜çš„å­—ç¬¦å­˜å‚¨æ ¼å¼çš„ä¸€ä¸ªå¾ˆé‡è¦çš„åŸå› </p>
</li>
<li><p><strong>UTF-8:</strong> (<code>Unicode Transformation Format</code>)å°±æ˜¯åœ¨äº’è”ç½‘ä¸Šä½¿ç”¨æœ€å¹¿çš„ä¸€ç§<code>Unicode</code>çš„å®ç°æ–¹å¼(æ€ä¹ˆç¼–ç ï¼Œæ€ä¹ˆå­˜å‚¨)ã€‚å…¶ä»–å®ç°æ–¹å¼è¿˜åŒ…æ‹¬<code>UTF-16</code>ï¼ˆå­—ç¬¦ç”¨ä¸¤ä¸ªå­—èŠ‚æˆ–å››ä¸ªå­—èŠ‚è¡¨ç¤ºï¼‰å’Œ<code>UTF-32</code> (å­—ç¬¦ç”¨å››ä¸ªå­—èŠ‚è¡¨ç¤ºï¼‰</p>
<p><code>UTF-8</code>æœ€å¤§çš„ä¸€ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯å®ƒæ˜¯ä¸€ç§å˜é•¿çš„ç¼–ç æ–¹å¼ã€‚å®ƒå¯ä»¥ä½¿ç”¨1~4ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªç¬¦å·ï¼Œæ ¹æ®ä¸åŒçš„ç¬¦å·è€Œå˜åŒ–å­—èŠ‚é•¿åº¦</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UTF-8 and Unicode cannot be compared. UTF-8 is an encoding used to translate numbers into binary data. Unicode is a character set used to translate characters into numbers.</div></pre></td></tr></table></figure>
<h3 id="UTF-8ç¼–ç "><a href="#UTF-8ç¼–ç " class="headerlink" title="UTF-8ç¼–ç "></a>UTF-8ç¼–ç </h3><table>
<thead>
<tr>
<th>å­—ç¬¦</th>
<th>Unicode</th>
<th>UTF-8</th>
<th>GBK</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä¸­</td>
<td>01001110  00101101ï¼ˆ4e2dï¼‰</td>
<td>01001110  00101101ï¼ˆe4b8adï¼‰</td>
<td>11010110 11010000ï¼ˆd6d0ï¼‰</td>
</tr>
</tbody>
</table>
<p><code>UTF-8</code>å¸¸ç”¨çš„è‹±æ–‡å­—æ¯è¢«ç¼–ç æˆ1ä¸ªå­—èŠ‚ï¼Œæ±‰å­—é€šå¸¸æ˜¯3ä¸ªå­—èŠ‚ï¼Œåªæœ‰å¾ˆç”Ÿåƒ»çš„å­—ç¬¦æ‰ä¼šè¢«ç¼–ç æˆ4ä¸ªå­—èŠ‚.å¦‚æœè¦ä¼ è¾“çš„æ–‡æœ¬åŒ…å«å¤§é‡è‹±æ–‡å­—ç¬¦ï¼Œç”¨UTF-8ç¼–ç å°±èƒ½èŠ‚çœç©ºé—´ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>a = <span class="string">u"ä¸­"</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>a</div><div class="line"><span class="string">u'\u4e2d'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>b = a.encode(<span class="string">"utf-8"</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>b</div><div class="line"><span class="string">'\xe4\xb8\xad'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>c = a.encode(<span class="string">"gbk"</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>c</div><div class="line"><span class="string">'\xd6\xd0'</span></div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure>
<p>ã€Œä¸­ã€ç”¨ GBK ç¼–ç è½¬åå°±æ˜¯ç”¨2ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œç”¨ UTF-8 ç¼–ç å°±æ˜¯ 3 ä¸ªå­—èŠ‚ï¼ŒåŒä¸€ä¸ªå­—ç¬¦ç”¨ä¸åŒçš„ç¼–ç æ–¹å¼å ç”¨çš„å­—èŠ‚é•¿åº¦å¯èƒ½ä¸ä¸€ã€‚</p>
<a id="more"></a>
<h4 id="ç¼–ç è§„åˆ™"><a href="#ç¼–ç è§„åˆ™" class="headerlink" title="ç¼–ç è§„åˆ™"></a>ç¼–ç è§„åˆ™</h4><p>1ï¼‰å¯¹äºå•å­—èŠ‚çš„ç¬¦å·ï¼Œå­—èŠ‚çš„ç¬¬ä¸€ä½è®¾ä¸º0ï¼Œåé¢7ä½ä¸ºè¿™ä¸ªç¬¦å·çš„<code>unicode</code>ç ã€‚å› æ­¤å¯¹äºè‹±è¯­å­—æ¯ï¼Œ<code>UTF-8</code>ç¼–ç å’Œ<code>ASCII</code>ç æ˜¯ç›¸åŒçš„ã€‚</p>
<p>2ï¼‰å¯¹äºnå­—èŠ‚çš„ç¬¦å·ï¼ˆn&gt;1ï¼‰ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚çš„å‰nä½éƒ½è®¾ä¸º1ï¼Œç¬¬n+1ä½è®¾ä¸º0ï¼Œåé¢å­—èŠ‚çš„å‰ä¸¤ä½ä¸€å¾‹è®¾ä¸º10ã€‚å‰©ä¸‹çš„æ²¡æœ‰æåŠçš„äºŒè¿›åˆ¶ä½ï¼Œå…¨éƒ¨ä¸ºè¿™ä¸ªç¬¦å·çš„<code>unicode</code>ç ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Unicodeç¬¦å·èŒƒå›´ | UTF-8ç¼–ç æ–¹å¼</div><div class="line">(åå…­è¿›åˆ¶) | ï¼ˆäºŒè¿›åˆ¶ï¼‰</div><div class="line">--------------------+---------------------------------------------</div><div class="line">0000 ~ 007F | 0xxxxxxx</div><div class="line">0080 ~ 07FF | 110xxxxx 10xxxxxx</div><div class="line">0800 ~ FFFF | 1110xxxx 10xxxxxx 10xxxxxx</div><div class="line">1 0000 ~1F FFFF | 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</div></pre></td></tr></table></figure>
<p>å¦‚æœä¸€ä¸ªå­—èŠ‚çš„ç¬¬ä¸€ä½æ˜¯0ï¼Œåˆ™è¿™ä¸ªå­—èŠ‚å•ç‹¬å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ï¼›å¦‚æœç¬¬ä¸€ä½æ˜¯1ï¼Œåˆ™è¿ç»­æœ‰å¤šå°‘ä¸ª1ï¼Œå°±è¡¨ç¤ºå½“å‰å­—ç¬¦å ç”¨å¤šå°‘ä¸ªå­—èŠ‚ã€‚</p>
<h4 id="BOM"><a href="#BOM" class="headerlink" title="BOM"></a>BOM</h4><p><code>BOM</code>ï¼šåœ¨ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶æˆ–è€…ä¸€æ®µå­—ç¬¦ç¼–ç å‰åŠ ä¸Šå‡ ä¸ªå›ºå®šçš„å­—èŠ‚ç”¨äºè¯†åˆ«ï¼Œè¿™äº›å­—èŠ‚ä¿è¯ä¸å¯¹åº”ä»»ä½•ä¸€ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥è½¯ä»¶ä¸€è¯»å°±èƒ½éªŒæ˜æ­£èº«ï¼š</p>
<ul>
<li><code>EF BB BF</code> ï¼ <code>UTF-8</code></li>
<li><code>FF FE</code> ï¼ <code>UTF-16LE</code>(<code>Little endian</code>)</li>
<li><code>FE FF</code> ï¼ <code>UTF-16BE</code>(<code>Big endian</code>)</li>
</ul>
<p>ä»¥æ±‰å­—ã€Œä¸­ã€ä¸ºä¾‹ï¼Œ<code>Unicode</code>ç æ˜¯4e2dï¼Œéœ€è¦ç”¨ä¸¤ä¸ªå­—èŠ‚å­˜å‚¨ï¼Œä¸€ä¸ªå­—èŠ‚æ˜¯4eï¼Œå¦ä¸€ä¸ªå­—èŠ‚æ˜¯2dã€‚å­˜å‚¨çš„æ—¶å€™ï¼Œ4eåœ¨å‰ï¼Œ2dåœ¨åï¼Œå°±æ˜¯<code>Big endian</code>(é«˜ä½å­—èŠ‚åœ¨å‰ï¼Œé˜…è¯»é¡ºåº)æ–¹å¼ï¼›2dåœ¨å‰ï¼Œ4eåœ¨åï¼Œå°±æ˜¯<code>Little endian</code>(ä½ä½å­—èŠ‚åœ¨å‰)æ–¹å¼ã€‚<code>Windows</code>çš„è®°äº‹æœ¬è¿˜æœ‰<code>Windows</code>å…¶å®ƒåœ°æ–¹æ‰€è°“çš„<code>Unicode</code>ç¼–ç ï¼Œå…¶å®æ˜¯<code>UTF-16LE</code></p>
<h3 id="å…¶ä»–ç¼–ç "><a href="#å…¶ä»–ç¼–ç " class="headerlink" title="å…¶ä»–ç¼–ç "></a>å…¶ä»–ç¼–ç </h3><h4 id="ISO-8859-1"><a href="#ISO-8859-1" class="headerlink" title="ISO-8859-1"></a>ISO-8859-1</h4><p><code>ISO-8859-1</code>ä»ç„¶æ˜¯å•å­—èŠ‚ç¼–ç ï¼Œå®ƒæ€»å…±èƒ½è¡¨ç¤º 256 ä¸ªå­—ç¬¦ã€‚</p>
<h4 id="GB2312"><a href="#GB2312" class="headerlink" title="GB2312"></a>GB2312</h4><p>å…¨ç§°æ˜¯ã€Šä¿¡æ¯äº¤æ¢ç”¨æ±‰å­—ç¼–ç å­—ç¬¦é›† åŸºæœ¬é›†ã€‹ï¼Œå®ƒæ˜¯<strong>åŒå­—èŠ‚ç¼–ç </strong>ï¼Œæ€»çš„ç¼–ç èŒƒå›´æ˜¯ A1-F7ï¼Œå…¶ä¸­ä» A1-A9 æ˜¯ç¬¦å·åŒºï¼Œæ€»å…±åŒ…å« 682 ä¸ªç¬¦å·ï¼Œä» B0-F7 æ˜¯æ±‰å­—åŒºï¼ŒåŒ…å« 6763 ä¸ªæ±‰å­—ã€‚</p>
<h4 id="GBK"><a href="#GBK" class="headerlink" title="GBK"></a>GBK</h4><p>ä¸ºäº†æ‰©å±•<code>GB2312</code>ï¼ŒåŠ å…¥æ›´å¤šçš„æ±‰å­—ï¼Œå®ƒçš„ç¼–ç èŒƒå›´æ˜¯<code>8140~FEFE</code>ï¼ˆå»æ‰ XX7Fï¼‰æ€»å…±æœ‰ 23940 ä¸ªç ä½ï¼Œå®ƒèƒ½è¡¨ç¤º 21003 ä¸ªæ±‰å­—ï¼Œå®ƒçš„ç¼–ç æ˜¯å’Œ <code>GB2312</code> å…¼å®¹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨ <code>GB2312</code> ç¼–ç çš„æ±‰å­—å¯ä»¥ç”¨ <code>GBK</code> æ¥è§£ç ï¼Œå¹¶ä¸”ä¸ä¼šæœ‰ä¹±ç ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://stackoverflow.com/questions/3951722/whats-the-difference-between-unicode-and-utf-8" target="_blank" rel="external">https://stackoverflow.com/questions/3951722/whats-the-difference-between-unicode-and-utf-8</a></p>
<p><a href="http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html" target="_blank" rel="external">å­—ç¬¦ç¼–ç ç¬”è®°ï¼šASCIIï¼ŒUnicodeå’ŒUTF-8</a></p>
<p><a href="https://foofish.net/unicode_utf-8.html" target="_blank" rel="external">å¸¸è¯†æ€§é”™è¯¯ä¹‹ Unicode ä¸ UTF-8</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[SimpleDateFormatçº¿ç¨‹å®‰å…¨]]></title>
      <url>http://zsr.github.io/2017/10/24/SimpleDateFormat%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/</url>
      <content type="html"><![CDATA[<p><code>SimpleDateFormat</code> æ˜¯ Java ä¸­éå¸¸å¸¸ç”¨çš„ä¸€ä¸ªç±»ï¼Œç”¨äºè§£æå’Œæ ¼å¼åŒ–æ—¥æœŸå­—ç¬¦ä¸²ï¼Œä½†æ˜¯ <code>SimpleDateFormat</code> åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<h3 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        System.out.println(sdf.parse(<span class="string">"2016-03-21 12:00:00"</span>).getTime());</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    Task task = <span class="keyword">new</span> Task();</div><div class="line">    Thread t1 = <span class="keyword">new</span> Thread(task);</div><div class="line">    t1.start();</div><div class="line">    Thread t2 = <span class="keyword">new</span> Thread(task);</div><div class="line">    t2.start();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœæŠ¥é”™ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">java.lang.NumberFormatException: multiple points</div><div class="line">	at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:<span class="number">1110</span>)</div><div class="line">	at java.lang.Double.parseDouble(Double.java:<span class="number">540</span>)</div><div class="line">	at java.text.DigitList.getDouble(DigitList.java:<span class="number">168</span>)</div><div class="line">	at java.text.DecimalFormat.parse(DecimalFormat.java:<span class="number">1321</span>)</div><div class="line">	at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:<span class="number">1793</span>)</div><div class="line">	at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:<span class="number">1455</span>)</div><div class="line">	at java.text.DateFormat.parse(DateFormat.java:<span class="number">355</span>)</div></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h3><p>åœ¨ JDK çš„æ–‡æ¡£ä¸­æåˆ°äº† <code>SimpleDateFormat</code> çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Date formats are not synchronized. It is recommended to create separate format instances for each thread. If multiple threads access a format concurrently, it must be synchronized externally.</div></pre></td></tr></table></figure>
<p>å°±æ˜¯è¯´DateFormatä¸æ˜¯åŒæ­¥çš„ï¼Œå»ºè®®æ¯ä¸ªçº¿ç¨‹éƒ½åˆ†åˆ«åˆ›å»ºformatå®ä¾‹å˜é‡ï¼›æˆ–è€…å¦‚æœå¤šä¸ªçº¿å…±äº«ä¸€ä¸ªformatçš„è¯ï¼Œå¿…é¡»ä¿æŒåœ¨ä½¿ç”¨formatæ—¶æ˜¯åŒæ­¥çš„.</p>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>ä»¥<code>SimpleDateFormat</code>ç±»<code>format()</code>æ–¹æ³•ä¸ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> Calendar calendar;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> StringBuffer <span class="title">format</span><span class="params">(Date date, StringBuffer toAppendTo,</span></span></div><div class="line">                            FieldDelegate delegate) &#123;</div><div class="line">    <span class="comment">// Convert input date to time field list</span></div><div class="line">    calendar.setTime(date);</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> useDateFormatSymbols = useDateFormatSymbols();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; compiledPattern.length; ) &#123;</div><div class="line">       ..........</div><div class="line">         </div><div class="line">        <span class="keyword">switch</span> (tag) &#123;</div><div class="line">        .........</div><div class="line">          </div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            subFormat(tag, count, delegate, toAppendTo, useDateFormatSymbols);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> toAppendTo;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ <code>format()</code> æ–¹æ³•ä¸­å…ˆå°†æ—¥æœŸå­˜æ”¾åˆ°ä¸€ä¸ª <code>Calendar</code> å¯¹è±¡ä¸­ï¼Œè€Œè¿™ä¸ª <code>Calender</code>å¯¹è±¡åœ¨ <code>SimpleDateFormat</code> ä¸­è¿˜æ˜¯ä»¥æˆå‘˜å˜é‡å­˜åœ¨çš„ã€‚åœ¨éšåè°ƒç”¨ <code>subFormat()</code> æ—¶ä¼šå†æ¬¡ç”¨åˆ°æˆå‘˜å˜é‡ <code>calendar</code>ã€‚è¿™å°±æ˜¯å¼•å‘é—®é¢˜çš„æ ¹æºã€‚åœ¨ <code>parse()</code> æ–¹æ³•ä¸­ä¹Ÿä¼šå­˜åœ¨ç›¸åº”çš„é—®é¢˜ã€‚</p>
<p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹éƒ½ä½¿ç”¨åŒä¸€ä¸ª <code>SimpleDateFormat</code> å®ä¾‹ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½å­˜åœ¨å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº† <code>calendar</code> åç´§æ¥ç€å¦ä¸€ä¸ªçº¿ç¨‹ä¹Ÿä¿®æ”¹äº† <code>calendar</code>ï¼Œé‚£ä¹ˆéšåç¬¬ä¸€ä¸ªçº¿ç¨‹ç”¨åˆ° <code>calendar</code> æ—¶å·²ç»ä¸æ˜¯å®ƒæ‰€æœŸå¾…çš„å€¼äº†ã€‚</p>
<p><code>SimpleDateFormat</code> å…¶å®æ˜¯æœ‰çŠ¶æ€çš„ï¼Œå®ƒä½¿ç”¨ä¸€ä¸ª <code>Calendar</code> æˆå‘˜å˜é‡æ¥ä¿å­˜çŠ¶æ€ï¼›å¦‚æœè¦æ±‚ <code>SimpleDateFormat</code> çš„ <code>parse()</code> å’Œ <code>format()</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé‚£ä¹ˆå®ƒå…¶å®åº”è¯¥æ˜¯æ— çŠ¶æ€çš„ã€‚å°† <code>Calendar</code> å¯¹è±¡ä½œä¸ºå±€éƒ¨å˜é‡ï¼Œå†…éƒ¨åœ¨è¿›è¡Œæ–¹æ³•è°ƒç”¨æ—¶æ¯æ¬¡éƒ½æŠŠå®ƒä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’ï¼Œå…¶å®å°±åº”è¯¥å¯ä»¥åšåˆ°çº¿ç¨‹å®‰å…¨äº†ã€‚JDK ä¸­ <code>SimpleDateFormat</code> çš„å®ç°ä¹‹æ‰€ä»¥æ²¡æœ‰è¿™æ ·åšå¯èƒ½æ˜¯å‡ºäºæ€§èƒ½ä¸Šçš„è€ƒè™‘ï¼Œå¯ä»¥èŠ‚çº¦æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶éƒ½è¦åˆ›å»º <code>Calendar</code> å¯¹è±¡çš„å¼€é”€ã€‚ä½†è¿™ç§æœ‰çŠ¶æ€çš„è®¾è®¡åœ¨æŸäº›åœºæ™¯ä¸‹å´åè€Œå¸¦æ¥äº†ä½¿ç”¨ä¸Šçš„ä¸ä¾¿ã€‚</p>
<h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><h4 id="åˆ›å»ºå±€éƒ¨å˜é‡"><a href="#åˆ›å»ºå±€éƒ¨å˜é‡" class="headerlink" title="åˆ›å»ºå±€éƒ¨å˜é‡"></a>åˆ›å»ºå±€éƒ¨å˜é‡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Date <span class="title">formatDate</span><span class="params">(Date d)</span> </span>&#123;</div><div class="line">    SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</div><div class="line">    <span class="keyword">return</span> sdf.parse(d);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="SimpleDateFormat-è¿›è¡ŒåŠ é”"><a href="#SimpleDateFormat-è¿›è¡ŒåŠ é”" class="headerlink" title="SimpleDateFormat è¿›è¡ŒåŠ é”"></a><code>SimpleDateFormat</code> è¿›è¡ŒåŠ é”</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</div><div class="line"><span class="function"><span class="keyword">public</span> Date <span class="title">formatDate</span><span class="params">(Date d)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span>(sdf) &#123;</div><div class="line">        <span class="keyword">return</span> sdf.parse(d);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ä½¿ç”¨-ThreadLocal"><a href="#ä½¿ç”¨-ThreadLocal" class="headerlink" title="ä½¿ç”¨ ThreadLocal"></a>ä½¿ç”¨ <code>ThreadLocal</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ThreadLocal&lt;SimpleDateFormat&gt; tl = <span class="keyword">new</span> ThreadLocal&lt;SimpleDateFormat&gt;();</div><div class="line"><span class="function"><span class="keyword">public</span> Date <span class="title">formatDate</span><span class="params">(Date d)</span> </span>&#123;</div><div class="line">    SimpleDateFormat sdf = tl.get();</div><div class="line">    <span class="keyword">if</span>(sdf == <span class="keyword">null</span>) &#123;</div><div class="line">        sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</div><div class="line">        tl.set(sdf);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> sdf.parse(d);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ä½¿ç”¨-Joda-Time-æ¨è"><a href="#ä½¿ç”¨-Joda-Time-æ¨è" class="headerlink" title="ä½¿ç”¨ Joda-Time(æ¨è)"></a>ä½¿ç”¨ Joda-Time(æ¨è)</h4><p><a href="http://www.oschina.net/p/joda-time" target="_blank" rel="external">Joda-Time</a> æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„å¼€æºçš„ JDK çš„æ—¥æœŸå’Œæ—¥å† API çš„æ›¿ä»£å“ï¼Œå…¶ DateTimeFormat æ˜¯çº¿ç¨‹å®‰å…¨è€Œä¸”ä¸å˜çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DateFormatTest</span> </span>&#123;</div><div class="line"> </div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> DateTimeFormatter fmt =</div><div class="line">       DateTimeFormat.forPattern(<span class="string">"yyyyMMdd"</span>);</div><div class="line"> </div><div class="line">  <span class="function"><span class="keyword">public</span> Date <span class="title">convert</span><span class="params">(String source)</span></span>&#123;</div><div class="line">    DateTime d = fmt.parseDateTime(source);</div><div class="line">    <span class="keyword">return</span>.toDate();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://zclau.com/2016/03/22/Java-SimpleDateFormat%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7%E9%97%AE%E9%A2%98/" target="_blank" rel="external">Java SimpleDateFormatçš„çº¿ç¨‹å®‰å…¨æ€§é—®é¢˜</a></p>
<p><a href="http://blog.jrwang.me/2016/java-simpledateformat-multithread-threadlocal/" target="_blank" rel="external">SimpleDateFormat çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ä¸ ThreadLocal</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Springäº‹ä»¶ç›‘å¬å™¨]]></title>
      <url>http://zsr.github.io/2017/10/23/Spring%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%99%A8/</url>
      <content type="html"><![CDATA[<h3 id="Spring-äº‹ä»¶æ¡†æ¶"><a href="#Spring-äº‹ä»¶æ¡†æ¶" class="headerlink" title="Spring äº‹ä»¶æ¡†æ¶"></a>Spring äº‹ä»¶æ¡†æ¶</h3><p><code>Spring</code>äº‹ä»¶æ¡†æ¶åŒ…å«ä¸‰ä¸ªéƒ¨ä»¶ï¼š</p>
<ul>
<li>äº‹ä»¶ï¼š<code>ApplicationEvent</code></li>
<li>äº‹ä»¶ç›‘å¬å™¨ï¼š<code>ApplicationListener</code>ï¼Œå¯¹ç›‘å¬åˆ°çš„äº‹ä»¶è¿›è¡Œå¤„ç†</li>
<li>äº‹ä»¶å‘å¸ƒï¼š<code>ApplicationEventPublisher</code>ï¼Œ<code>ApplicationContext</code>ç»§æ‰¿äº†è¯¥æ¥å£ï¼Œåœ¨<code>ApplicationContext</code>çš„æŠ½è±¡å®ç°ç±»<code>AbstractApplicationContext</code>ä¸­åšäº†å®ç°</li>
</ul>
<h3 id="Spring-äº‹ä»¶åŸç†"><a href="#Spring-äº‹ä»¶åŸç†" class="headerlink" title="Spring äº‹ä»¶åŸç†"></a>Spring äº‹ä»¶åŸç†</h3><h4 id="Springæä¾›çš„äº‹ä»¶ç±»å‹"><a href="#Springæä¾›çš„äº‹ä»¶ç±»å‹" class="headerlink" title="Springæä¾›çš„äº‹ä»¶ç±»å‹"></a>Springæä¾›çš„äº‹ä»¶ç±»å‹</h4><p><img src="http://dl2.iteye.com/upload/attachment/0086/6532/8637476c-9877-3432-ae82-e85745f27cc3.png" alt="img"></p>
<ul>
<li><code>ContextStartedEvent</code>ï¼š<code>ApplicationContext</code>å¯åŠ¨åè§¦å‘çš„äº‹ä»¶ï¼›</li>
<li><code>ContextStoppedEvent</code>ï¼š<code>ApplicationContext</code>åœæ­¢åè§¦å‘çš„äº‹ä»¶ï¼›</li>
<li><code>ContextRefreshedEvent</code>ï¼š<code>ApplicationContext</code>åˆå§‹åŒ–æˆ–åˆ·æ–°å®Œæˆåè§¦å‘çš„äº‹ä»¶ï¼›ï¼ˆå®¹å™¨åˆå§‹åŒ–å®Œæˆåè°ƒç”¨ï¼‰</li>
<li><code>ContextClosedEvent</code>ï¼š<code>ApplicationContext</code>å…³é—­åè§¦å‘çš„äº‹ä»¶ï¼›ï¼ˆå¦‚webå®¹å™¨å…³é—­æ—¶è‡ªåŠ¨ä¼šè§¦å‘springå®¹å™¨çš„å…³é—­)</li>
</ul>
<h4 id="äº‹ä»¶å‘å¸ƒè€…"><a href="#äº‹ä»¶å‘å¸ƒè€…" class="headerlink" title="äº‹ä»¶å‘å¸ƒè€…"></a>äº‹ä»¶å‘å¸ƒè€…</h4><p><code>ApplicationContext</code>æ¥å£ç»§æ‰¿äº†<code>ApplicationEventPublisher</code>ï¼Œå¹¶åœ¨<code>AbstractApplicationContext</code>å®ç°äº†å…·ä½“ä»£ç ï¼Œå®é™…æ‰§è¡Œæ˜¯å§”æ‰˜ç»™<code>ApplicationEventMulticaster</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractApplicationContext.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(ApplicationEvent event)</span> </span>&#123;  </div><div class="line">    <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç   </span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// äº‹ä»¶å‘å¸ƒå§”æ‰˜ç»™ApplicationEventMulticasteræ¥æ‰§è¡Œ</span></div><div class="line">    getApplicationEventMulticaster().multicastEvent(event);  </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span>) &#123;  </div><div class="line">        <span class="keyword">this</span>.parent.publishEvent(event);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¸¸ç”¨çš„<code>ApplicationContext</code>éƒ½ç»§æ‰¿è‡ª<code>AbstractApplicationContext</code>ï¼Œå¦‚<code>ClassPathXmlApplicationContext</code>ã€<code>XmlWebApplicationContext</code>ç­‰ï¼Œè‡ªåŠ¨æ‹¥æœ‰è¿™ä¸ªåŠŸèƒ½</p>
<a id="more"></a>
<ul>
<li><code>ApplicationEventMulticaster</code> åˆå§‹åŒ–</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractApplicationContext.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</div><div class="line">   <span class="comment">// åˆå§‹åŒ–ApplicationEventMulticaster</span></div><div class="line">   initApplicationEventMulticaster();</div><div class="line"></div><div class="line">   <span class="comment">// Initialize other special beans in specific context subclasses.</span></div><div class="line">   onRefresh();</div><div class="line"></div><div class="line">   <span class="comment">// æ³¨å†Œç›‘å¬å™¨</span></div><div class="line">   registerListeners();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationEventMulticaster</span><span class="params">()</span> </span>&#123;</div><div class="line">		ConfigurableListableBeanFactory beanFactory = getBeanFactory();</div><div class="line">       <span class="comment">//å…ˆæŸ¥æ‰¾BeanFactoryä¸­æ˜¯å¦æœ‰ApplicationEventMulticaster(è‡ªå®šä¹‰)</span></div><div class="line">		<span class="keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</div><div class="line">			<span class="keyword">this</span>.applicationEventMulticaster =</div><div class="line">					beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">// åˆ›å»ºé»˜è®¤çš„SimpleApplicationEventMulticaster</span></div><div class="line">			<span class="keyword">this</span>.applicationEventMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster(beanFactory);</div><div class="line">			beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="keyword">this</span>.applicationEventMulticaster);</div><div class="line">		&#125;</div></pre></td></tr></table></figure>
<p><code>Spring</code>å®¹å™¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨<code>initApplicationEventMulticaster()</code>åˆå§‹åŒ–    <code>ApplicationEventMulticaster</code>ï¼Œå¦‚æœæ²¡æœ‰è‡ªå®šä¹‰çš„<code>applicationEventMulticaster</code>åˆ™é»˜è®¤åˆ›å»ºä¸€ä¸ª<code>SimpleApplicationEventMulticaster</code>ã€‚</p>
<ul>
<li><code>multicastEvent</code>å‘å¸ƒäº‹ä»¶</li>
</ul>
<p>å…¶ä¸­<code>SimpleApplicationEventMulticaster</code>å‘å¸ƒäº‹ä»¶çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// SimpleApplicationEventMulticaster.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">multicastEvent</span><span class="params">(<span class="keyword">final</span> ApplicationEvent event)</span> </span>&#123;</div><div class="line">    <span class="comment">//è·å¾—ç›‘å¬å™¨é›†åˆï¼Œéå†ç›‘å¬å™¨ï¼Œå¯æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥çš„å¹¿æ’­äº‹ä»¶</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> ApplicationListener listener : getApplicationListeners(event)) &#123;  </div><div class="line">        Executor executor = getTaskExecutor();  </div><div class="line">        <span class="keyword">if</span> (executor != <span class="keyword">null</span>) &#123;  </div><div class="line">            executor.execute(<span class="keyword">new</span> Runnable() &#123;  </div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">                    listener.onApplicationEvent(event);  </div><div class="line">                &#125;  </div><div class="line">            &#125;);  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// æ‰§è¡Œç›‘å¬å™¨é€»è¾‘</span></div><div class="line">            listener.onApplicationEvent(event);  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœç»™å®ƒä¸€ä¸ª<code>executor</code>ï¼Œå®ƒå°±å¯ä»¥å¼‚æ­¥æ”¯æŒå‘å¸ƒäº‹ä»¶äº†ã€‚</p>
<h4 id="äº‹ä»¶ç›‘å¬å™¨"><a href="#äº‹ä»¶ç›‘å¬å™¨" class="headerlink" title="äº‹ä»¶ç›‘å¬å™¨"></a>äº‹ä»¶ç›‘å¬å™¨</h4><ul>
<li><code>registerListeners</code>æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractApplicationContext.class</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerListeners</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></div><div class="line">		<span class="comment">// uninitialized to let post-processors apply to them!</span></div><div class="line">		String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line">		<span class="keyword">for</span> (String lisName : listenerBeanNames) &#123;</div><div class="line">			getApplicationEventMulticaster().addApplicationListenerBean(lisName);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p><code>Spring</code>ä½¿ç”¨åå°„æœºåˆ¶ï¼Œé€šè¿‡æ–¹æ³•<code>getBeanNamesForType</code>è·å–æ‰€æœ‰å®ç°äº†<code>ApplicationListener</code>æ¥å£çš„<code>Bean</code>ï¼Œå¹¶è°ƒç”¨<code>addApplicationListenerBean</code>æ–¹æ³•å°†å…¶æ³¨å†Œåˆ°<code>applicationEventMulticaster</code>ä¸­ã€‚æ‰€ä»¥å¯ä»¥åœ¨<code>Spring</code>é…ç½®æ–‡ä»¶ä¸­é…ç½®è‡ªå®šä¹‰ç›‘å¬å™¨ï¼Œåœ¨<code>Spring</code>åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šæŠŠç›‘å¬å™¨è‡ªåŠ¨æ³¨å†Œåˆ°æ³¨å†Œè¡¨ä¸­å»ã€‚</p>
<ul>
<li><code>SmartApplicationListener</code>ç›‘å¬å™¨</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationListener</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span>&gt; <span class="keyword">extends</span> <span class="title">EventListener</span> </span>&#123;</div><div class="line">	<span class="comment">// å¤„ç†æ”¶åˆ°çš„äº‹ä»¶</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(E event)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SmartApplicationListener</span> <span class="keyword">extends</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ApplicationEvent</span>&gt;, <span class="title">Ordered</span> </span>&#123;</div><div class="line">	<span class="comment">// å¦‚æœå®ç°æ”¯æŒè¯¥äº‹ä»¶ç±»å‹ é‚£ä¹ˆè¿”å›true</span></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">supportsEventType</span><span class="params">(Class&lt;? extends ApplicationEvent&gt; eventType)</span></span>;</div><div class="line">    </div><div class="line">    <span class="comment">// å¦‚æœå®ç°æ”¯æŒâ€œç›®æ ‡â€ç±»å‹ï¼Œé‚£ä¹ˆè¿”å›true  </span></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">supportsSourceType</span><span class="params">(Class&lt;?&gt; sourceType)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯¥æ¥å£å¯æ–¹ä¾¿å®ç°å»åˆ¤æ–­æ”¯æŒçš„äº‹ä»¶ç±»å‹ã€ç›®æ ‡ç±»å‹ã€‚</p>
<ol>
<li><code>supportsEventType</code>ï¼šç”¨äºæŒ‡å®šæ”¯æŒçš„äº‹ä»¶ç±»å‹ï¼Œåªæœ‰æ”¯æŒçš„æ‰è°ƒç”¨<code>onApplicationEvent</code>ï¼›</li>
<li><code>supportsSourceType</code>ï¼šæ”¯æŒçš„ç›®æ ‡ç±»å‹ï¼Œåªæœ‰æ”¯æŒçš„æ‰è°ƒç”¨<code>onApplicationEvent</code>ï¼›</li>
</ol>
<h3 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><ul>
<li>å®šä¹‰äº‹ä»¶</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestEvent</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TestEvent</span><span class="params">(String source)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(source);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å®šä¹‰ç›‘å¬å™¨</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestListener</span> <span class="keyword">implements</span> <span class="title">SmartApplicationListener</span> </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"hello: "</span> + event.getSource());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// ç›‘å¬å™¨æ‰§è¡Œçš„é¡ºåºï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ </span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsEventType</span><span class="params">(Class&lt;? extends ApplicationEvent&gt; eventType)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> eventType == TestEvent.class;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsSourceType</span><span class="params">(Class&lt;?&gt; sourceType)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> sourceType == String.class;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æµ‹è¯•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</div><div class="line"><span class="meta">@ContextConfiguration</span>(locations = &#123; <span class="string">"classpath:spring-listener-config.xml"</span> &#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMain</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Autowired</span></div><div class="line">  <span class="keyword">private</span> ApplicationContext applicationContext;</div><div class="line"></div><div class="line">  <span class="meta">@Test</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPublishEvent</span><span class="params">()</span> </span>&#123;</div><div class="line">    applicationContext.publishEvent(<span class="keyword">new</span> TestEvent(<span class="string">"world."</span>));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://www.limisky.com/125.html" target="_blank" rel="external">Springçš„äº‹ä»¶ä¸å¼‚æ­¥äº‹ä»¶</a></p>
<p><a href="http://cxis.me/2017/02/15/Spring-ApplicationContext%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6/" target="_blank" rel="external">Spring ApplicationContextäº‹ä»¶æœºåˆ¶</a></p>
<p><a href="http://jinnianshilongnian.iteye.com/blog/1902886" target="_blank" rel="external">è¯¦è§£Springäº‹ä»¶é©±åŠ¨æ¨¡å‹</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[scala Execution Context]]></title>
      <url>http://zsr.github.io/2017/10/19/scala-Execution-Context/</url>
      <content type="html"><![CDATA[<h2 id="Implicits-global-vs-Implicits-defaultContext"><a href="#Implicits-global-vs-Implicits-defaultContext" class="headerlink" title="Implicits.global  vs  Implicits.defaultContext"></a>Implicits.global  vs  Implicits.defaultContext</h2><hr>
<p><code>Scala Future</code>éœ€è¦æ”¾åœ¨æ‰§è¡Œä¸Šä¸‹æ–‡(çº¿ç¨‹æ± )ä¸­æ‰§è¡Œï¼Œä¸€èˆ¬å¸¸è§çš„çº¿ç¨‹æ± æœ‰2ç§ï¼š</p>
<ul>
<li><code>Scala  Execution Context</code>ï¼š</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> scala.concurrent.<span class="type">ExecutionContext</span>.<span class="type">Implicits</span>.global</div></pre></td></tr></table></figure>
<p>è¯¥çº¿ç¨‹æ± æ˜¯ç”±<code>Scala</code>æ ‡å‡†åº“æä¾›çš„ï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„<code>ForkJoinPool</code>çº¿ç¨‹æ± ï¼Œåœ¨é«˜è´Ÿè½½æ—¶ï¼Œä½¿ç”¨çš„çº¿ç¨‹å¯èƒ½æ¯”ä¼˜åŒ–æ—¶å¤š(å¯¹æ¯”<code>play</code>æˆ–è€…<code>akka framework</code>)ï¼Œå› æ­¤æ€§èƒ½å¯èƒ½ä¼šé™ä½</p>
<ul>
<li><code>Play Default  Execution Context</code>ï¼š</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> play.api.libs.concurrent.<span class="type">Execution</span>.<span class="type">Implicits</span>.defaultContext</div></pre></td></tr></table></figure>
<p>è¯¥çº¿ç¨‹æ± æ˜¯ç”±playæä¾›ï¼Œplayåº”ç”¨åº”è¯¥ä½¿ç”¨è¿™ç§æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚åŒæ—¶ï¼Œåº”è¯¥é¿å…é˜»å¡æ“ä½œæ”¾å…¥<code>play execution context</code>ï¼Œå¥½çš„åŠæ³•æ˜¯æ”¾å…¥å…¶ä»–çš„<code>execution context</code>ï¼Œé¿å…playåº”ç”¨èµ„æºç”¨å°½ã€‚</p>
<p>æ³¨æ„ï¼šç†è§£å“ªä¸ªçº¿ç¨‹è¿è¡Œäº†<code>future</code>éå¸¸é‡è¦ï¼Œå¯¼å…¥playçš„é»˜è®¤æ‰§è¡Œç¯å¢ƒï¼ˆ<code>execution context</code>ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªéšå¼ï¼ˆ<code>implicit</code>ï¼‰çš„å‚æ•°ï¼Œä¼šè¢«ä¼ å…¥æ‰€æœ‰æ¥å—å›è°ƒçš„<code>future API</code>æ–¹æ³•ä¸­ã€‚æ‰§è¡Œç¯å¢ƒï¼ˆ<code>execution context</code>ï¼‰é€šå¸¸ç­‰ä»·äºçº¿ç¨‹æ± ï¼Œä½†è¿™å¹¶ä¸æ˜¯ä¸€å®šçš„ã€‚</p>
<p>ç®€å•çš„æŠŠåŒæ­¥IOå°è£…å…¥<code>Future</code>å¹¶ä¸èƒ½å°†å…¶è½¬æ¢ä¸ºå¼‚æ­¥çš„ã€‚å¦‚æœä½ ä¸èƒ½é€šè¿‡æ”¹å˜åº”ç”¨æ¶æ„æ¥é¿å…é˜»å¡æ“ä½œï¼Œé‚£ä¹ˆè¯¥æ“ä½œæ€»ä¼šåœ¨æŸä¸€æ—¶åˆ»è¢«æ‰§è¡Œçš„ï¼Œè€Œç›¸åº”çš„çº¿ç¨‹åˆ™ä¼šè¢«é˜»å¡ã€‚æ‰€ä»¥ï¼Œé™¤äº†å°†æ“ä½œå°è£…äº<code>Future</code>ä¸­ï¼Œè¿˜å¿…é¡»è®©å®ƒè¿è¡Œåœ¨é…ç½®äº†è¶³å¤Ÿçº¿ç¨‹æ¥å¤„ç†å¯é¢„è®¡å¹¶å‘çš„ç‹¬ç«‹æ‰§è¡Œç¯å¢ƒï¼ˆ<code>execution context</code>ï¼‰ä¸­ã€‚æ›´å¤šä¿¡æ¯è¯·è§<a href="https://www.playframework.com/documentation/2.3.x/ThreadPools" target="_blank" rel="external">ç†è§£Playçº¿ç¨‹æ± </a></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://stackoverflow.com/questions/40301032/what-is-the-difference-between-scalas-execution-context-and-plays-execution-co" target="_blank" rel="external">https://stackoverflow.com/questions/40301032/what-is-the-difference-between-scalas-execution-context-and-plays-execution-co</a></p>
<p><a href="https://stackoverflow.com/questions/30805337/plays-internal-execution-context" target="_blank" rel="external">https://stackoverflow.com/questions/30805337/plays-internal-execution-context</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ForkJoinPool]]></title>
      <url>http://zsr.github.io/2017/10/18/ForkJoinPool/</url>
      <content type="html"><![CDATA[<p><code>Java 1.7</code> å¼•å…¥äº†ä¸€ç§æ–°çš„å¹¶å‘æ¡†æ¶â€”â€” <code>Fork/Join Framework</code></p>
<p><code>Fork/Join</code>çš„æ€è·¯ï¼šé€šè¿‡åˆ†è€Œæ²»ä¹‹(æŠŠå¤§ä»»åŠ¡åˆ†å‰²æˆè‹¥å¹²ä¸ªå°ä»»åŠ¡)ï¼Œåªä¸è¿‡åˆ’åˆ†ä¹‹åçš„ä»»åŠ¡æ›´é€‚åˆåˆ†æ´¾ç»™ä¸åŒçš„è®¡ç®—èµ„æºï¼Œå¯ä»¥å¹¶è¡Œçš„å®Œæˆä»»åŠ¡ã€‚</p>
<h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p><code>Fork/Join</code>æ¡†æ¶ä¸»è¦ä¾é <code>fork</code>å’Œ<code>join</code>ä¸¤ä¸ªæ“ä½œï¼Œä¸€èˆ¬å¯¹è¿™ä¸¤ä¸ªæ“ä½œçš„è§£é‡Šå¦‚ä¸‹ï¼š</p>
<ul>
<li><code>fork()</code>ï¼šå¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹ï¼ˆæˆ–æ˜¯é‡ç”¨çº¿ç¨‹æ± å†…çš„ç©ºé—²çº¿ç¨‹ï¼‰ï¼Œå°†ä»»åŠ¡äº¤ç»™è¯¥çº¿ç¨‹å¤„ç†ã€‚</li>
<li><code>join()</code>ï¼šç­‰å¾…è¯¥ä»»åŠ¡çš„å¤„ç†çº¿ç¨‹å¤„ç†å®Œæ¯•ï¼Œè·å¾—è¿”å›å€¼ã€‚</li>
</ul>
<p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œä¸æ–­çš„<code>fork()</code>å¦‚æœæ˜¯ä¸æ–­åˆ›å»ºçº¿ç¨‹ï¼Œå²‚ä¸æ˜¯è¦â€œçº¿ç¨‹æ•°é‡çˆ†ç‚¸â€ï¼Ÿäº‹å®ä¸Šï¼Œ<code>ForkJoinPool</code>ç”¨äº†ä¸€ç§<code>work stealing</code>çš„ç®—æ³•ï¼Œé¿å…äº§ç”Ÿå¤§é‡çº¿ç¨‹ã€‚æ‰€ä»¥å¦‚æœä¸€å¼€å§‹è®¾ç½®çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°ä¸ºNï¼Œå®é™…ä¸Šä½¿ç”¨<code>ForkJoinPool</code>çš„æ—¶å€™ä¹Ÿåªä¼šæœ‰å›ºå®šçš„çº¿ç¨‹æ•°(é»˜è®¤å’ŒCPUæ ¸æ•°ä¸€æ ·)ã€‚</p>
<h4 id="Fork-Joinçš„åŸºæœ¬ç”¨æ³•"><a href="#Fork-Joinçš„åŸºæœ¬ç”¨æ³•" class="headerlink" title="Fork/Joinçš„åŸºæœ¬ç”¨æ³•"></a>Fork/Joinçš„åŸºæœ¬ç”¨æ³•</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if (å½“å‰è¿™ä¸ªä»»åŠ¡å·¥ä½œé‡è¶³å¤Ÿå°)</div><div class="line">    ç›´æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡</div><div class="line">else</div><div class="line">    å°†è¿™ä¸ªä»»åŠ¡åˆ†è§£æˆä¸¤ä¸ªéƒ¨åˆ†</div><div class="line">    åˆ†åˆ«è§¦å‘(invoke)è¿™ä¸¤ä¸ªå­ä»»åŠ¡çš„æ‰§è¡Œï¼Œå¹¶ç­‰å¾…ç»“æœ</div></pre></td></tr></table></figure>
<h4 id="ForkJoinæ¡†æ¶ç»„æˆ"><a href="#ForkJoinæ¡†æ¶ç»„æˆ" class="headerlink" title="ForkJoinæ¡†æ¶ç»„æˆ"></a>ForkJoinæ¡†æ¶ç»„æˆ</h4><ul>
<li><code>ForkJoinPool</code>ï¼šç®¡ç†<code>worker</code>çº¿ç¨‹ï¼Œç±»ä¼¼<code>ThreadPoolExecutor</code>ï¼Œæä¾›æ¥å£ç”¨äºæäº¤æˆ–è€…æ‰§è¡Œä»»åŠ¡ï¼›</li>
<li><code>ForkJoinWorkerThread</code>ï¼š<code>worker</code>çº¿ç¨‹ï¼Œä»»åŠ¡ä¿å­˜åœ¨ä¸€ä¸ª<code>deque</code>ä¸­ï¼›</li>
<li><code>ForkJoinTask</code>ï¼š<code>ForkJoin</code>æ¡†æ¶ä¸­è¿è¡Œçš„ä»»åŠ¡ï¼Œå¯ä»¥<code>fork</code>å­ä»»åŠ¡ï¼Œå¯ä»¥<code>join</code>å­ä»»åŠ¡å®Œæˆã€‚</li>
</ul>
<a id="more"></a>
<h4 id="ForkJoinPoolæ„é€ å‡½æ•°"><a href="#ForkJoinPoolæ„é€ å‡½æ•°" class="headerlink" title="ForkJoinPoolæ„é€ å‡½æ•°"></a>ForkJoinPoolæ„é€ å‡½æ•°</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForkJoinPool</span> <span class="keyword">extends</span> <span class="title">AbstractExecutorService</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ForkJoinPool</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// é»˜è®¤å¹¶è¡Œæ•°ä¸ºCPUæ ¸æ•°</span></div><div class="line">        <span class="keyword">this</span>(Math.min(MAX_CAP, Runtime.getRuntime().availableProcessors()),</div><div class="line">             defaultForkJoinWorkerThreadFactory, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ForkJoinPool</span><span class="params">(<span class="keyword">int</span> parallelism)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(parallelism, defaultForkJoinWorkerThreadFactory, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="work-stealing-çªƒå–-ç®—æ³•"><a href="#work-stealing-çªƒå–-ç®—æ³•" class="headerlink" title="work stealing(çªƒå–)ç®—æ³•"></a>work stealing(çªƒå–)ç®—æ³•</h4><p>ä¸€ä¸ªä»»åŠ¡é€šè¿‡<code>fork()</code>è¢«åˆ†å‰²æˆè‹¥å¹²ä¸ªå°ä»»åŠ¡ã€‚æ¯”å¦‚çº¿ç¨‹1å’Œçº¿ç¨‹2éƒ½è¢«åˆ†å‰²æˆ4ä¸ªå°ä»»åŠ¡ï¼Œå¦‚æœçº¿ç¨‹1æ‰§è¡Œå®Œæ¯•ï¼Œé‚£ä¹ˆä»–å¯ä»¥å»çªƒå–çº¿ç¨‹2çš„å·¥ä½œã€‚å½“è¦å‘ç”Ÿçº¿ç¨‹çªƒå–çš„æ—¶å€™ï¼Œä¸¤ä¸ªçº¿ç¨‹å†…çš„ä»»åŠ¡å¯ä»¥ç†è§£æˆæ”¾åœ¨ä¸€ä¸ªçº¿ç¨‹è‡ªå·±çš„åŒç«¯é˜Ÿåˆ—ä¸­ã€‚ä¾‹å¦‚ä¸‹å›¾çº¿ç¨‹2ä¸­çš„ä»»åŠ¡è¢«åˆ†å‰²æˆè‹¥å¹²ä¸ªå°ä»»åŠ¡ï¼ˆå°±<code>WorkQueue</code>é‡Œé¢çš„ä¸€ä¸ªä¸ªå°æ–¹å—ï¼‰æ”¾åœ¨å…¶çº¿ç¨‹çš„åŒç«¯é˜Ÿåˆ—ä¸­ã€‚è¢«çªƒå–ä»»åŠ¡çº¿ç¨‹ä»å…¶ä»–åŒç«¯é˜Ÿåˆ—çš„å¤´éƒ¨æ‹¿ä»»åŠ¡æ‰§è¡Œï¼Œè€Œçªƒå–ä»»åŠ¡çš„çº¿ç¨‹æ°¸è¿œä»åŒç«¯é˜Ÿåˆ—çš„å°¾éƒ¨æ‹¿ä»»åŠ¡æ‰§è¡Œã€‚</p>
<p><img src="http://kaimingwan.com/java/_image/forkjoinpool%E8%A7%A3%E8%AF%BB/15-21-18.jpg" alt="img"></p>
<ul>
<li><code>ForkJoinPool</code> çš„æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½ç»´æŠ¤ç€ä¸€ä¸ª<strong>å·¥ä½œé˜Ÿåˆ—</strong>ï¼ˆ<code>WorkQueue</code>ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼ˆDequeï¼‰ï¼Œé‡Œé¢å­˜æ”¾çš„å¯¹è±¡æ˜¯<strong>ä»»åŠ¡</strong>ï¼ˆ<code>ForkJoinTask</code>ï¼‰ã€‚</li>
<li>æ¯ä¸ªå·¥ä½œçº¿ç¨‹åœ¨è¿è¡Œä¸­äº§ç”Ÿæ–°çš„ä»»åŠ¡ï¼ˆé€šå¸¸æ˜¯å› ä¸ºè°ƒç”¨äº† <code>fork()</code>ï¼‰æ—¶ï¼Œä¼šæ”¾å…¥å·¥ä½œé˜Ÿåˆ—çš„é˜Ÿå°¾ï¼Œå¹¶ä¸”å·¥ä½œçº¿ç¨‹åœ¨å¤„ç†è‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ <em>LIFO</em> æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡ä»é˜Ÿå°¾å–å‡ºä»»åŠ¡æ¥æ‰§è¡Œã€‚</li>
<li>æ¯ä¸ªå·¥ä½œçº¿ç¨‹åœ¨å¤„ç†è‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—åŒæ—¶ï¼Œä¼šå°è¯•<strong>çªƒå–</strong>ä¸€ä¸ªä»»åŠ¡ï¼ˆæˆ–æ˜¯æ¥è‡ªäºåˆšåˆšæäº¤åˆ° pool çš„ä»»åŠ¡ï¼Œæˆ–æ˜¯æ¥è‡ªäºå…¶ä»–å·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—ï¼‰ï¼Œçªƒå–çš„ä»»åŠ¡ä½äºå…¶ä»–çº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—çš„é˜Ÿé¦–ï¼Œä¹Ÿå°±æ˜¯è¯´å·¥ä½œçº¿ç¨‹åœ¨çªƒå–å…¶ä»–å·¥ä½œçº¿ç¨‹çš„ä»»åŠ¡æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ <em>FIFO</em> æ–¹å¼ã€‚</li>
<li>åœ¨é‡åˆ° <code>join()</code> æ—¶ï¼Œå¦‚æœéœ€è¦<code>join</code>çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œåˆ™ä¼šå…ˆå¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œå¹¶ç­‰å¾…å…¶å®Œæˆã€‚</li>
<li>åœ¨æ—¢æ²¡æœ‰è‡ªå·±çš„ä»»åŠ¡ï¼Œä¹Ÿæ²¡æœ‰å¯ä»¥çªƒå–çš„ä»»åŠ¡æ—¶ï¼Œè¿›å…¥ä¼‘çœ </li>
</ul>
<h4 id="ä¼˜ç¼ºç‚¹"><a href="#ä¼˜ç¼ºç‚¹" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h4><p><code>work stealing</code>ç®—æ³•çš„ä¼˜ç‚¹ï¼šåˆ©ç”¨äº†çº¿ç¨‹è¿›è¡Œå¹¶è¡Œè®¡ç®—ï¼Œå‡å°‘äº†çº¿ç¨‹é—´çš„ç«äº‰ã€‚</p>
<p><code>work stealing</code>ç®—æ³•çš„ç¼ºç‚¹ï¼š</p>
<ul>
<li>å¦‚æœåŒç«¯é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹é—´ä¼šå­˜åœ¨ç«äº‰ã€‚</li>
<li>é¢å¤–çš„å¼€é”€ï¼Œä¾‹å¦‚åŒç«¯é˜Ÿåˆ—</li>
</ul>
<h4 id="fork"><a href="#fork" class="headerlink" title="fork()"></a>fork()</h4><p><code>fork()</code> åšçš„å·¥ä½œåªæœ‰ä¸€ä»¶äº‹ï¼Œæ—¢æ˜¯<strong>æŠŠä»»åŠ¡æ¨å…¥å½“å‰å·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—é‡Œ</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ForkJoinTask&lt;V&gt; <span class="title">fork</span><span class="params">()</span> </span>&#123;</div><div class="line">    Thread t;</div><div class="line">    <span class="keyword">if</span> ((t = Thread.currentThread()) <span class="keyword">instanceof</span> ForkJoinWorkerThread)</div><div class="line">        ((ForkJoinWorkerThread)t).workQueue.push(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        ForkJoinPool.common.externalPush(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="join"><a href="#join" class="headerlink" title="join()"></a>join()</h4><ol>
<li>æ£€æŸ¥è°ƒç”¨ <code>join()</code> çš„çº¿ç¨‹æ˜¯å¦æ˜¯ <code>ForkJoinThread</code>çº¿ç¨‹ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç­‰å¾…ä»»åŠ¡å®Œæˆã€‚å¦‚æœæ˜¯ï¼Œåˆ™ä¸é˜»å¡ã€‚</li>
<li>æŸ¥çœ‹ä»»åŠ¡çš„å®ŒæˆçŠ¶æ€ï¼Œå¦‚æœå·²ç»å®Œæˆï¼Œç›´æ¥è¿”å›ç»“æœã€‚</li>
<li>å¦‚æœä»»åŠ¡å°šæœªå®Œæˆï¼Œä½†å¤„äºè‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—å†…ï¼Œåˆ™å®Œæˆå®ƒã€‚</li>
<li>å¦‚æœä»»åŠ¡å·²ç»è¢«å…¶ä»–çš„å·¥ä½œçº¿ç¨‹å·èµ°ï¼Œåˆ™çªƒå–è¿™ä¸ªä»»åŠ¡çš„workeræ‰§è¡Œ(ä»¥ <em>FIFO</em> æ–¹å¼)ï¼Œä»¥æœŸå¸®åŠ©å®ƒæ—©æ—¥å®Œæˆ<code>join</code>çš„ä»»åŠ¡ã€‚</li>
<li>å¦‚æœå·èµ°ä»»åŠ¡çš„workerä¹Ÿå·²ç»æŠŠè‡ªå·±çš„ä»»åŠ¡å…¨éƒ¨åšå®Œï¼Œæ­£åœ¨ç­‰å¾…éœ€è¦<code>join</code>çš„ä»»åŠ¡æ—¶ï¼Œåˆ™æ‰¾åˆ°è¯¥å°å·çš„å°å·ï¼Œå¸®åŠ©å®ƒå®Œæˆå®ƒçš„ä»»åŠ¡ã€‚</li>
<li>é€’å½’åœ°æ‰§è¡Œç¬¬5æ­¥ã€‚</li>
</ol>
<p><img src="http://kaimingwan.com/java/_image/forkjoinpool%E8%A7%A3%E8%AF%BB/16-42-15.jpg" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doJoin</span><span class="params">()</span> </span>&#123;</div><div class="line">        Thread t; ForkJoinWorkerThread w; <span class="keyword">int</span> s; <span class="keyword">boolean</span> completed;</div><div class="line">        <span class="keyword">if</span> ((t = Thread.currentThread()) <span class="keyword">instanceof</span> ForkJoinWorkerThread) &#123;</div><div class="line">          <span class="comment">// statuså€¼çš„åˆå§‹åŒ–å€¼æ˜¯0ï¼Œåœ¨ä»»åŠ¡æ²¡æœ‰å®Œæˆä»¥å‰ä¸€ç›´æ˜¯éè´Ÿå€¼</span></div><div class="line">            <span class="keyword">if</span> ((s = status) &lt; <span class="number">0</span>)</div><div class="line">                <span class="keyword">return</span> s;</div><div class="line">            <span class="comment">// ä»å½“å‰å·¥ä½œçº¿ç¨‹çš„æ ˆé¡¶ä¸­ pop è¯¥ä»»åŠ¡ï¼Œå‡†å¤‡æ‰§è¡Œ</span></div><div class="line">            <span class="keyword">if</span> ((w = (ForkJoinWorkerThread)t).unpushTask(<span class="keyword">this</span>)) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    completed = exec();</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable rex) &#123;</div><div class="line">                    <span class="keyword">return</span> setExceptionalCompletion(rex);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (completed)</div><div class="line">                    <span class="keyword">return</span> setCompletion(NORMAL);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// å½“å·¥ä½œçº¿ç¨‹é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…ä»»åŠ¡æ²¡æœ‰æ­£å¸¸å®Œæˆï¼Œåˆ™ä¼šç»™helpJoinTask stolen-&gt;joining æ–¹å¼æ‰§è¡Œ</span></div><div class="line">            <span class="keyword">return</span> w.joinTask(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">          <span class="comment">// ä¸æ˜¯workerçº¿ç¨‹ï¼Œç›´æ¥è°ƒç”¨Object.waitç­‰å¾…ä»»åŠ¡å®Œæˆ(é˜»å¡)ã€‚</span></div><div class="line">            <span class="keyword">return</span> externalAwaitDone();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>ç»Ÿè®¡1ï½1000æ•´æ•°ä¹‹å’Œ</p>
<h4 id="å•çº¿ç¨‹Forå¾ªç¯"><a href="#å•çº¿ç¨‹Forå¾ªç¯" class="headerlink" title="å•çº¿ç¨‹Forå¾ªç¯"></a>å•çº¿ç¨‹Forå¾ªç¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForLoopCalculator</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">sum</span><span class="params">(<span class="keyword">long</span>[] numbers)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> sum = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> i : numbers) &#123;</div><div class="line">      sum += i;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> sum;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span>[] numbers = LongStream.rangeClosed(<span class="number">1</span>, <span class="number">1000</span>).toArray();</div><div class="line">    System.out.println(sum(numbers));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ExecutorServiceçº¿ç¨‹æ± "><a href="#ExecutorServiceçº¿ç¨‹æ± " class="headerlink" title="ExecutorServiceçº¿ç¨‹æ± "></a>ExecutorServiceçº¿ç¨‹æ± </h4><p>æŠŠå¤§ä»»åŠ¡åˆ†å‰²æˆè‹¥å¹²ä¸ªå°ä»»åŠ¡ï¼Œå¹¶è¡Œè®¡ç®—å†åˆå¹¶ç»“æœ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä»»åŠ¡Task</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SumTask</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Long</span>&gt; </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">long</span>[] numbers;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SumTask</span><span class="params">(<span class="keyword">long</span>[] numbers)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.numbers = numbers;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Long <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">return</span> Arrays.stream(numbers).sum();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Taskæ‰§è¡Œçº¿ç¨‹æ± </span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorServiceCalculator</span> </span>&#123;</div><div class="line">  <span class="keyword">int</span> parallism;</div><div class="line">  <span class="keyword">private</span> ExecutorService pool;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ExecutorServiceCalculator</span><span class="params">(<span class="keyword">int</span> parallism)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.parallism = parallism;</div><div class="line">    pool = Executors.newFixedThreadPool(parallism);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sum</span><span class="params">(<span class="keyword">long</span>[] numbers)</span> </span>&#123;</div><div class="line">    List&lt;Future&lt;Long&gt;&gt; results = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">// æŠŠä»»åŠ¡åˆ†è§£ä¸º n ä»½ï¼Œäº¤ç»™ n ä¸ªçº¿ç¨‹å¤„ç†</span></div><div class="line">    <span class="keyword">int</span> part = numbers.length / parallism;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parallism; i++) &#123;</div><div class="line">      <span class="keyword">int</span> from = i * part + <span class="number">1</span>;</div><div class="line">      <span class="keyword">int</span> to = (i + <span class="number">1</span>) * part;</div><div class="line">      results.add(pool.submit(<span class="keyword">new</span> SumTask(LongStream.rangeClosed(from, to).toArray())));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// æŠŠæ¯ä¸ªçº¿ç¨‹çš„ç»“æœç›¸åŠ ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœ</span></div><div class="line">    <span class="keyword">long</span> sum = results.stream().map(f -&gt; &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> f.get();</div><div class="line">      &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">      &#125;</div><div class="line">    &#125;).reduce(<span class="number">0L</span>, Long::sum);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> sum;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ForkJoinPoolçº¿ç¨‹æ± "><a href="#ForkJoinPoolçº¿ç¨‹æ± " class="headerlink" title="ForkJoinPoolçº¿ç¨‹æ± "></a>ForkJoinPoolçº¿ç¨‹æ± </h4><p><code>ForkJoinPool</code>ä¸»è¦ç”¨äºå®ç°â€œåˆ†è€Œæ²»ä¹‹â€çš„ç®—æ³•ï¼Œç‰¹åˆ«æ˜¯åˆ†æ²»ä¹‹åé€’å½’è°ƒç”¨çš„å‡½æ•°ï¼Œä¾‹å¦‚<code>quick sort</code> ç­‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForkJoinCalculator</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> ForkJoinPool pool;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ForkJoinCalculator</span><span class="params">()</span> </span>&#123;</div><div class="line">    pool = <span class="keyword">new</span> ForkJoinPool();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sum</span><span class="params">(<span class="keyword">long</span>[] numbers)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pool.invoke(<span class="keyword">new</span> SumTask(numbers, <span class="number">0</span>, numbers.length - <span class="number">1</span>));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SumTask</span> <span class="keyword">extends</span> <span class="title">RecursiveTask</span>&lt;<span class="title">Long</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span>[] numbers;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> from;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> to;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SumTask</span><span class="params">(<span class="keyword">long</span>[] numbers, <span class="keyword">int</span> from, <span class="keyword">int</span> to)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.numbers = numbers;</div><div class="line">      <span class="keyword">this</span>.from = from;</div><div class="line">      <span class="keyword">this</span>.to = to;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Long <span class="title">compute</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (to - from &lt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> numbers[from];</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (to - from &lt;= <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">return</span> numbers[from] + numbers[to];</div><div class="line">        <span class="comment">// å¦åˆ™ï¼ŒæŠŠä»»åŠ¡ä¸€åˆ†ä¸ºäºŒï¼Œé€’å½’è®¡ç®—</span></div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">int</span> middle = (from + to) / <span class="number">2</span>;</div><div class="line">        SumTask taskLeft = <span class="keyword">new</span> SumTask(numbers, from, middle);</div><div class="line">        SumTask taskRight = <span class="keyword">new</span> SumTask(numbers, middle + <span class="number">1</span>, to);</div><div class="line">        taskLeft.fork();</div><div class="line">        taskRight.fork();</div><div class="line">        <span class="keyword">return</span> taskLeft.join() + taskRight.join();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨è¿™æ®µä»£ç é‡Œæ²¡æœ‰æ˜¾å¼åœ°â€œæŠŠä»»åŠ¡åˆ†é…ç»™çº¿ç¨‹â€ï¼Œåªæ˜¯åˆ†è§£äº†ä»»åŠ¡ï¼Œè€ŒæŠŠå…·ä½“çš„ä»»åŠ¡åˆ°çº¿ç¨‹çš„æ˜ å°„äº¤ç»™äº† <code>ForkJoinPool</code> æ¥å®Œæˆã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://blog.dyngr.com/blog/2016/09/15/java-forkjoinpool-internals" target="_blank" rel="external">å¦‚ä½•ä½¿ç”¨ ForkJoinPool ä»¥åŠåŸç†</a></p>
<p><a href="http://kaimingwan.com/post/java/forkjoinpooljie-du" target="_blank" rel="external">ForkJoinPoolè§£è¯»</a></p>
<p><a href="https://ketao1989.github.io/2014/05/24/Java-Fork-Join-Task-Framework-API-Introduce/" target="_blank" rel="external">Java Fork&amp;Joinæ¡†æ¶ä½¿ç”¨å’Œå®ç°åˆ†æ</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[RabbitMQç”Ÿäº§è€…åˆ†æ]]></title>
      <url>http://zsr.github.io/2017/09/28/RabbitMQ%E7%94%9F%E4%BA%A7%E8%80%85%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<h3 id="åˆ†å¸ƒå¼æ¶ˆæ¯ä¸­é—´ä»¶"><a href="#åˆ†å¸ƒå¼æ¶ˆæ¯ä¸­é—´ä»¶" class="headerlink" title="åˆ†å¸ƒå¼æ¶ˆæ¯ä¸­é—´ä»¶"></a>åˆ†å¸ƒå¼æ¶ˆæ¯ä¸­é—´ä»¶</h3><p>åœ¨ä½¿ç”¨<code>RabbitMQ</code>åšæ¶ˆæ¯åˆ†å‘æ—¶ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæ¦‚å¿µè¦æ³¨æ„ï¼š<code>Exchange</code>ï¼Œ<code>RoutingKey</code>ï¼Œ<code>Queue</code>ã€‚</p>
<p><code>Exchange</code>å¯ä»¥ç†è§£ä¸ºäº¤æ¢å™¨ï¼Œ<code>RoutingKey</code>å¯ä»¥ç†è§£ä¸ºè·¯ç”±ï¼Œ<code>Queue</code>ä½œä¸ºçœŸå®å­˜å‚¨æ¶ˆæ¯çš„é˜Ÿåˆ—å’ŒæŸä¸ª<code>Exchange</code>ç»‘å®šï¼Œå…·ä½“å¦‚ä½•è·¯ç”±åˆ°æ„Ÿå…´è¶£çš„<code>Queue</code>åˆ™ç”±<code>Exchange</code>çš„ä¸‰ç§æ¨¡å¼å†³å®šï¼š</p>
<ul>
<li><code>fanout</code>ï¼šç”Ÿäº§è€…å¾€æ­¤Exchangeå‘é€çš„æ¶ˆæ¯ä¼šå‘ç»™æ¯ä¸ªå’Œå…¶ç»‘å®šçš„Queueï¼Œæ­¤æ—¶RoutingKeyå¹¶ä¸èµ·ä½œç”¨</li>
<li><code>topic</code> : ç”Ÿäº§è€…å¯ä»¥æŒ‡å®šä¸€ä¸ªæ”¯æŒé€šé…ç¬¦çš„RoutingKeyï¼ˆå¦‚demo.*ï¼‰å‘å‘æ­¤Exchangeï¼Œå‡¡æ˜¯Exchangeä¸ŠRoutingKeyæ»¡è¶³æ­¤é€šé…ç¬¦çš„Queueå°±ä¼šæ”¶åˆ°æ¶ˆæ¯</li>
<li><code>direct</code>ï¼šç”Ÿäº§è€…æŒ‡å®šExchangeå’ŒRoutingKeyï¼Œç„¶åå¾€å…¶å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯åªèƒ½è¢«ç»‘å®šçš„æ»¡è¶³RoutingKeyçš„Queueæ¥å—æ¶ˆæ¯ã€‚(å¦‚æœä¸æŒ‡å®šRoutingKeyçš„å…·ä½“åå­—ï¼Œé‚£ä¹ˆé»˜è®¤çš„åå­—å…¶å®æ˜¯Queueçš„åå­—ï¼‰</li>
</ul>
<h3 id="ç”Ÿäº§è€…é…ç½®"><a href="#ç”Ÿäº§è€…é…ç½®" class="headerlink" title="ç”Ÿäº§è€…é…ç½®"></a>ç”Ÿäº§è€…é…ç½®</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span></span></div><div class="line">		<span class="attr">host</span>=<span class="string">"$&#123;rabbit.connect.host&#125;"</span> <span class="attr">port</span>=<span class="string">"$&#123;rabbit.connect.port&#125;"</span> <span class="attr">username</span>=<span class="string">"$&#123;rabbit.connect.username&#125;"</span></div><div class="line">		<span class="attr">password</span>=<span class="string">"$&#123;rabbit.connect.password&#125;"</span> <span class="attr">channel-cache-size</span>=<span class="string">"$&#123;rabbit.connect.channelCacheSize&#125;"</span></div><div class="line">		<span class="attr">publisher-returns</span>=<span class="string">"true"</span> <span class="attr">publisher-confirms</span>=<span class="string">"true"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">id</span>=<span class="string">"rabbitAdmin"</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> /&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"messageConverter"</span></span></div><div class="line">		<span class="attr">class</span>=<span class="string">"org.springframework.amqp.support.converter.SimpleMessageConverter"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"returnCallback"</span></span></div><div class="line">		<span class="attr">class</span>=<span class="string">"com.zsr.test.callback.MessageReturnCallback"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"confirmCallback"</span></span></div><div class="line">		<span class="attr">class</span>=<span class="string">"com.zsr.test.callback.MessageConfirmCallback"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">"rabbitTemplate"</span></span></div><div class="line">		<span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> <span class="attr">confirm-callback</span>=<span class="string">"confirmCallback"</span></div><div class="line">		<span class="attr">return-callback</span>=<span class="string">"returnCallback"</span> <span class="attr">message-converter</span>=<span class="string">"messageConverter"</span> /&gt;</div></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    ConnectionFactory connectionFactory = <span class="keyword">new</span> CachingConnectionFactory(<span class="number">5672</span>);</div><div class="line">    RabbitAdmin admin = <span class="keyword">new</span> RabbitAdmin(connectionFactory);</div><div class="line">    admin.declareQueue(<span class="keyword">new</span> Queue(<span class="string">"test.queue"</span>));</div><div class="line">    RabbitTemplate template = admin.getRabbitTemplate();</div><div class="line">    template.convertAndSend(<span class="string">"spring"</span>, <span class="string">"test"</span>);</div><div class="line">    String foo = (String) template.receiveAndConvert(<span class="string">"spring"</span>);</div><div class="line">    System.out.println(foo);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h4 id="ConnectionFactoryåˆ†æ"><a href="#ConnectionFactoryåˆ†æ" class="headerlink" title="ConnectionFactoryåˆ†æ"></a>ConnectionFactoryåˆ†æ</h4><p><code>org.springframework.amqp.rabbit.connection.ConnectionFactory</code> æ˜¯ Spring AMQP å®šä¹‰çš„è¿æ¥å·¥å‚æ¥å£ï¼Œè´Ÿè´£åˆ›å»ºè¿æ¥.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// CachingConnectionFactory.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">CachingConnectionFactory</span><span class="params">(String hostname, <span class="keyword">int</span> port)</span> </span>&#123;</div><div class="line">        <span class="comment">// çœŸæ­£çš„RabbitMQè¿æ¥å·¥å‚, å®é™…è¿æ¥éƒ½æ˜¯é€šè¿‡è¿™ä¸ªrabbitConnectionFactoryåˆ›å»ºçš„</span></div><div class="line">		<span class="keyword">super</span>(<span class="keyword">new</span> com.rabbitmq.client.ConnectionFactory());</div><div class="line">		<span class="keyword">if</span> (!StringUtils.hasText(hostname)) &#123;</div><div class="line">			hostname = getDefaultHostName();</div><div class="line">		&#125;</div><div class="line">		setHost(hostname);</div><div class="line">		setPort(port);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p><code>CachingConnectionFactory</code>å®ç°æ”¯æŒå¯¹è¿™äº›é€šé“çš„ç¼“å­˜ï¼Œå¹¶ä¸”åŸºäºå®ƒä»¬æ˜¯å¦æ˜¯äº‹åŠ¡æ¥ç»´æŠ¤å•ç‹¬çš„é€šé“é«˜é€Ÿç¼“å­˜ã€‚å¦‚æœè¦é…ç½®é€šé“ç¼“å­˜çš„å¤§å°(é»˜è®¤å€¼ä¸º25)ï¼Œå¯ä»¥è°ƒç”¨<code>setChannelCacheSize()</code>æ–¹æ³•ã€‚</p>
<h4 id="RabbitAdminåˆ†æ"><a href="#RabbitAdminåˆ†æ" class="headerlink" title="RabbitAdminåˆ†æ"></a>RabbitAdminåˆ†æ</h4><p><code>org.springframework.amqp.core.AmqpAdmin</code>æ¥å£å®šä¹‰äº†AMQPåŸºç¡€ç®¡ç†æ“ä½œï¼Œä¸»è¦æ˜¯å¯¹å„ç§èµ„æºï¼ˆäº¤æ¢æœºã€é˜Ÿåˆ—ã€ç»‘å®šï¼‰çš„ç”³æ˜å’Œåˆ é™¤æ“ä½œ.<code>org.springframework.amqp.rabbit.core.RabbitAdmin</code>å®ç°äº†<code>AmqpAdmin</code>æ¥å£.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RabbitAdmin.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">RabbitAdmin</span><span class="params">(ConnectionFactory connectionFactory)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.connectionFactory = connectionFactory;</div><div class="line">		Assert.notNull(connectionFactory, <span class="string">"ConnectionFactory must not be null"</span>);</div><div class="line">        <span class="comment">// åˆ›å»ºäº†ä¸€ä¸ªRabbitTemplateå®ä¾‹</span></div><div class="line">		<span class="keyword">this</span>.rabbitTemplate = <span class="keyword">new</span> RabbitTemplate(connectionFactory);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœä½¿ç”¨xmlé…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">id</span>=<span class="string">"amqpAdmin"</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>å½“<code>CachingConnectionFactory</code>ç¼“å­˜æ¨¡å¼æ˜¯CHANNEL(é»˜è®¤å€¼)æ—¶ï¼Œ<code>RabbitAdmin</code>å®ç°ä¼šåœ¨åŒä¸€ä¸ª<code>ApplicationContext</code>ä¸­å£°æ˜çš„<code>Queue</code>ï¼Œ<code>Exchanges</code>å’Œ<code>Bindings</code>è‡ªåŠ¨å»¶è¿Ÿå£°æ˜.</p>
<h5 id="declareQueue"><a href="#declareQueue" class="headerlink" title="declareQueue"></a>declareQueue</h5><p><code>declareQueue</code>æ–¹æ³•ç”¨æ¥ç”³æ˜é˜Ÿåˆ—ã€‚<code>org.springframework.amqp.core.Queue</code>æ˜¯ Spring AMQP å¯¹é˜Ÿåˆ—çš„å°è£…ï¼Œå…¶å±æ€§ä¸<code>RabbitMQ Java client</code>ä¸­å®šä¹‰çš„<code>Queue</code>çš„å±æ€§åŸºæœ¬ä¸€è‡´ï¼Œ<code>new Queue(&quot;spring&quot;)</code>ç›¸å½“äº<code>RabbitMQ Java client</code>ä¸­ <code>channel.queueDeclare(&quot;spring&quot;, true, false, false, null)</code>æŒ‡å®šçš„é˜Ÿåˆ—ç‰¹æ€§ï¼Œå³é˜Ÿåˆ—æ˜¯æŒä¹…åŒ–ã€éæ’ä»–æ€§ã€éè‡ªåŠ¨åˆ é™¤çš„.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Queue.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Queue</span><span class="params">(String name, <span class="keyword">boolean</span> durable, <span class="keyword">boolean</span> exclusive, <span class="keyword">boolean</span> autoDelete, Map&lt;String, Object&gt; arguments)</span> </span>&#123;</div><div class="line">		Assert.notNull(name, <span class="string">"'name' cannot be null"</span>);</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">		<span class="keyword">this</span>.durable = durable;</div><div class="line">		<span class="keyword">this</span>.exclusive = exclusive;</div><div class="line">		<span class="keyword">this</span>.autoDelete = autoDelete;</div><div class="line">		<span class="keyword">this</span>.arguments = arguments;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RabbitAdmin.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">declareQueue</span><span class="params">(<span class="keyword">final</span> Queue queue)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.rabbitTemplate.execute(<span class="keyword">new</span> ChannelCallback&lt;String&gt;() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> String <span class="title">doInRabbit</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">				<span class="keyword">return</span> declareQueues(channel, queue)[<span class="number">0</span>].getQueue();</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p><code>declareQueue</code>è°ƒç”¨<code>rabbitTemplate</code>çš„<code>execute(ChannelCallback)</code>æ–¹æ³•ï¼Œåœ¨<code>ChannelCallback</code>çš„å›è°ƒæ–¹æ³• <code>doInRabbit(Channel channel)</code> ä¸­é€šè¿‡å…¥åƒ<code>channel</code>è°ƒç”¨<code>RabbitMQ Java client</code>æä¾›çš„<code>channel.queueDeclare</code>æ–¹æ³•ç”³æ˜é˜Ÿåˆ—ã€‚</p>
<h4 id="RabbitTemplateåˆ†æ"><a href="#RabbitTemplateåˆ†æ" class="headerlink" title="RabbitTemplateåˆ†æ"></a>RabbitTemplateåˆ†æ</h4><p><code>org.springframework.amqp.core.AmqpTemplate</code>æ¥å£å®šä¹‰äº† AMQP åŸºç¡€æ“ä½œï¼Œä¸»è¦ä¸ºåŒæ­¥çš„æ¶ˆæ¯æ”¶å‘æ–¹æ³•ã€‚<code>org.springframework.amqp.rabbit.core.RabbitTemplate</code>å®ç°äº† AmqpTemplate æ¥å£ã€‚</p>
<p><code>RabbitTemplate</code>å°±æ˜¯ RabbitMQ æ”¶å‘æ¶ˆæ¯çš„æ¨¡æ¿æ–¹æ³•ï¼Œæ‰€ä»¥ï¼Œ<code>RabbitTemplate</code>è¦å®ç°åˆ›å»ºè¿æ¥ã€è·å–channelã€æ”¶å‘æ¶ˆæ¯ã€æ¶ˆæ¯æ ¼å¼è½¬æ¢ã€å…³é—­ä¿¡é“ä¸è¿æ¥ç­‰æ¨¡æ¿ä»£ç ã€‚</p>
<h5 id="æ¶ˆæ¯å‘é€"><a href="#æ¶ˆæ¯å‘é€" class="headerlink" title="æ¶ˆæ¯å‘é€"></a>æ¶ˆæ¯å‘é€</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RabbitTemplate.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">convertAndSend</span><span class="params">(String exchange, String routingKey, <span class="keyword">final</span> Object object, CorrelationData correlationData)</span> <span class="keyword">throws</span> AmqpException </span>&#123;</div><div class="line">        <span class="comment">// convertMessageIfNecessaryæ–¹æ³•å°†Objectè½¬åŒ–ä¸ºMessageå®ä¾‹</span></div><div class="line">		send(exchange, routingKey, convertMessageIfNecessary(object), correlationData);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">final</span> String exchange, <span class="keyword">final</span> String routingKey,</span></span></div><div class="line">			<span class="keyword">final</span> Message message, <span class="keyword">final</span> CorrelationData correlationData)</div><div class="line">			<span class="keyword">throws</span> AmqpException &#123;</div><div class="line">  <span class="comment">// å®é™…åœ¨ChannelCallbackæ¥å£çš„åŒ¿åå®ç°ç±»çš„doInRabbit(Channel)æ–¹æ³•ä¸­å®ç°å‘é€æ¶ˆæ¯åŠŸèƒ½</span></div><div class="line">		execute(<span class="keyword">new</span> ChannelCallback&lt;Object&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Object <span class="title">doInRabbit</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">				doSend(channel, exchange, routingKey, message, correlationData);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"><span class="comment">// Messageç±»æ˜¯Spring AMQPå¯¹æ¶ˆæ¯çš„å°è£…</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Message <span class="title">convertMessageIfNecessary</span><span class="params">(<span class="keyword">final</span> Object object)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (object <span class="keyword">instanceof</span> Message) &#123;</div><div class="line">			<span class="keyword">return</span> (Message) object;</div><div class="line">		&#125;</div><div class="line">       <span class="comment">// è·å–åœ¨RabbitTemplateæ„é€ å‡½æ•°ä¸­åˆ›å»ºçš„MessageConverter,é»˜è®¤æ˜¯SimpleMessageConverter</span></div><div class="line">		<span class="keyword">return</span> getRequiredMessageConverter().toMessage(object, <span class="keyword">new</span> MessageProperties());</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p><code>execute</code>æ–¹æ³•ä¸­é€šè¿‡ä¼ å…¥çš„<code>ConnectionFactory</code>è·å–è¿æ¥å’Œä¿¡é“ï¼Œ<code>ChannelCallback</code>æ¥å£çš„<code>doInRabbit(Channel channel)</code>æ–¹æ³•ä½œä¸ºå›è°ƒå‡½æ•°ï¼Œé€šè¿‡<code>channel</code>å‚æ•°æ¥å—<code>execute</code>æ–¹æ³•ä¸­è·å–çš„ä¿¡é“ï¼Œå®Œæˆæ¶ˆæ¯å‘é€çš„å…·ä½“ä¸šåŠ¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RabbitTemplate.class</span></div><div class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">doExecute</span><span class="params">(ChannelCallback&lt;T&gt; action)</span> </span>&#123;</div><div class="line">		Assert.notNull(action, <span class="string">"Callback object must not be null"</span>);</div><div class="line">        <span class="comment">// resourceHolderåŒ…è£…äº†connectionå’Œchannel</span></div><div class="line">		RabbitResourceHolder resourceHolder = getTransactionalResourceHolder();</div><div class="line">        <span class="comment">// è·å–channel</span></div><div class="line">		Channel channel = resourceHolder.getChannel();</div><div class="line">        <span class="comment">// å¦‚æœæœ‰confirmCallbackæˆ–è€…returnCallbackï¼Œåˆ™æ·»åŠ ç›‘å¬å™¨ï¼Œç”¨äºå‘é€ç»“æœå¼‚æ­¥å›è°ƒ</span></div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.confirmCallback != <span class="keyword">null</span> || <span class="keyword">this</span>.returnCallback != <span class="keyword">null</span>) &#123;</div><div class="line">			addListener(channel);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">				logger.debug(<span class="string">"Executing callback on RabbitMQ Channel: "</span> + channel);</div><div class="line">			&#125;</div><div class="line">            <span class="comment">// è°ƒç”¨doSendæ–¹æ³•ï¼Œé€šè¿‡channelæ‰§è¡Œæ¶ˆæ¯å‘é€</span></div><div class="line">			<span class="keyword">return</span> action.doInRabbit(channel);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">			<span class="keyword">if</span> (isChannelLocallyTransacted(channel)) &#123;</div><div class="line">				resourceHolder.rollbackAll();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">throw</span> convertRabbitAccessException(ex);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">finally</span> &#123;</div><div class="line">           <span class="comment">// å›æ”¶è¿æ¥å’Œä¿¡é“èµ„æº</span></div><div class="line">			ConnectionFactoryUtils.releaseResources(resourceHolder);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>ä¸ç®¡æ˜¯ç”Ÿäº§è€…è¿˜æ˜¯æ¶ˆè´¹è€…éƒ½éœ€è¦ä¸RabbitMQå»ºç«‹è¿æ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªTCPè¿æ¥ï¼Œåœ¨TCPè¿æ¥ä¸ŠRabbitMQä¼šåˆ›å»ºä¸€ä¸ªä¸ªè™šæ‹Ÿçš„<code>channel</code>ï¼Œæ‰€æœ‰çš„RabbitMQæ“ä½œå¿…é¡»åœ¨<code>channel</code>ä¹‹ä¸Šæ‰§è¡Œï¼Œä½¿ç”¨<code>channel</code>çš„å¥½å¤„æ˜¯æ¯”TCPæ›´èŠ‚çœç³»ç»Ÿèµ„æºã€‚TCPè¿æ¥å°±åƒç”µç¼†ï¼ŒAMQP channelå°±åƒçº¤ç»´æŸ.</p>
<p><code>doSend</code>æ–¹æ³•å®ç°æ¶ˆæ¯å‘é€è¿™ä¸ªå…·ä½“æ“ä½œã€‚å®é™…ä¸Šè°ƒç”¨RabbitMQ Java clientæä¾›çš„<code>channel.basicPublish</code>æ–¹æ³•å‘é€æ¶ˆæ¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doSend</span><span class="params">(Channel channel, String exchange, String routingKey, Message message,</span></span></div><div class="line">			CorrelationData correlationData) <span class="keyword">throws</span> Exception &#123;</div><div class="line">		...some code...</div><div class="line">          </div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.confirmCallback != <span class="keyword">null</span> &amp;&amp; channel <span class="keyword">instanceof</span> PublisherCallbackChannel) &#123;</div><div class="line">			PublisherCallbackChannel publisherCallbackChannel = (PublisherCallbackChannel) channel;</div><div class="line">			publisherCallbackChannel.addPendingConfirm(<span class="keyword">this</span>, channel.getNextPublishSeqNo(),</div><div class="line">					<span class="keyword">new</span> PendingConfirm(correlationData, System.currentTimeMillis()));</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">boolean</span> mandatory = <span class="keyword">this</span>.returnCallback != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.mandatory;</div><div class="line">		MessageProperties messageProperties = message.getMessageProperties();</div><div class="line">		<span class="keyword">if</span> (mandatory) &#123;</div><div class="line">			messageProperties.getHeaders().put(PublisherCallbackChannel.RETURN_CORRELATION, <span class="keyword">this</span>.uuid);</div><div class="line">		&#125;</div><div class="line">		BasicProperties convertedMessageProperties = <span class="keyword">this</span>.messagePropertiesConverter</div><div class="line">				.fromMessageProperties(messageProperties, encoding);</div><div class="line">        <span class="comment">// å‘é€æ¶ˆæ¯</span></div><div class="line">		channel.basicPublish(exchange, routingKey, mandatory, convertedMessageProperties, message.getBody());</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡å°†<code>CachingConnectionFactory</code>çš„<code>publisherConfirms</code>å’Œ<code>publisherReturns</code>å±æ€§åˆ†åˆ«è®¾ç½®ä¸ºâ€œtrueâ€ï¼Œæ”¯æŒç¡®è®¤å’Œè¿”å›çš„æ¶ˆæ¯ã€‚è®¾ç½®è¿™äº›é€‰é¡¹æ—¶ï¼Œå·¥å‚åˆ›å»ºçš„é€šé“å°†è¢«åŒ…è£…åœ¨<code>PublisherCallbackChannel</code>ä¸­ï¼Œè¯¥é€šé“ç”¨äºæ–¹æ³•å›è°ƒã€‚å½“è·å¾—è¿™æ ·çš„é¢‘é“æ—¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨è¯¥<code>channel</code>æ³¨å†Œä¸€ä¸ª<code>PublisherCallbackChannel.Listener</code>ã€‚ ï½€<code>PublisherCallbackChannel</code>å®ç°åŒ…å«å°†â€œç¡®è®¤â€æˆ–â€œè¿”å›â€è·¯ç”±åˆ°é€‚å½“çš„ç›‘å¬å™¨çš„é€»è¾‘ã€‚</p>
<p>ä¸šåŠ¡æ“ä½œå®Œæˆåï¼Œ<code>execute</code>æ–¹æ³•ä¼šå›æ”¶è¿æ¥å’Œä¿¡é“èµ„æºï¼Œæ•´ä¸ªæ¶ˆæ¯å‘é€æ¨¡æ¿åŠŸèƒ½å®Œæˆã€‚</p>
<h4 id="Publisherçš„æ¶ˆæ¯ç¡®è®¤æœºåˆ¶"><a href="#Publisherçš„æ¶ˆæ¯ç¡®è®¤æœºåˆ¶" class="headerlink" title="Publisherçš„æ¶ˆæ¯ç¡®è®¤æœºåˆ¶"></a>Publisherçš„æ¶ˆæ¯ç¡®è®¤æœºåˆ¶</h4><p>å½“ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œéœ€è¦è€ƒè™‘ä¸€ä¸ªäº‹æƒ…ï¼Œå°±æ˜¯è¿™ä¸ªæ¶ˆæ¯æ˜¯å¦æäº¤æˆåŠŸ, æ˜¯å¦é€è¾¾åˆ°äº†é˜Ÿåˆ—ä¸­ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Returns are when the broker returns a message because it&apos;s undeliverable (no matching bindings on the exchange to which the message was published, and the mandatory bit is set).</div><div class="line"></div><div class="line">Confirms are when the broker sends an ack back to the publisher, indicating that a message was successfully routed.</div></pre></td></tr></table></figure>
<p><code>returnCallback</code>ï¼šç”¨æ¥åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦æ­£ç¡®åˆ°è¾¾ç»‘å®šçš„é˜Ÿåˆ—ï¼Œå¦‚æœæ²¡æœ‰é˜Ÿåˆ—ç»‘å®šåˆ°è¯¥<code>exchange</code>ï¼Œå›è°ƒreturnCallbackæ¥å£</p>
<p><code>confirmCallback</code>ï¼šæ¶ˆæ¯æ­£ç¡®åˆ°è¾¾ç»‘å®šçš„é˜Ÿåˆ—(å¦‚æœè®¾ç½®äº†æŒä¹…åŒ–ï¼Œåˆ™æ¶ˆæ¯å¿…é¡»æŒä¹…åŒ–åˆ°ç£ç›˜)ï¼Œbrokerè¿”å›ackï¼Œå›è°ƒ<code>confirmCallback</code>æ¥å£</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.cnblogs.com/gordonkong/p/7051220.html" target="_blank" rel="external">Spring AMQP æºç åˆ†æ</a></p>
<p><a href="http://liuxing.info/%202017/06/30/Spring%20AMQP%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/" target="_blank" rel="external">Spring AMQPä¸­æ–‡æ–‡æ¡£</a></p>
<p><a href="https://stackoverflow.com/questions/30034092/spring-amqp-return-callback-vs-retry-callback" target="_blank" rel="external">ConfirmCallback vs ReturnCallback</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[RabbitMQæ¶ˆè´¹è€…åˆ†æ]]></title>
      <url>http://zsr.github.io/2017/09/27/RabbitMQ%E6%B6%88%E8%B4%B9%E8%80%85%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<p>æ¶ˆæ¯æ¶ˆè´¹è€…æœ‰2ç§æ¨¡å¼ï¼špullæˆ–pushï¼ŒRabbitMQé€šå¸¸ä½¿ç”¨pushæ¨¡å¼(ä¹Ÿå¯ä»¥ä½¿ç”¨æ‹‰æ¨¡å¼)ï¼ŒKafkaé‡‡ç”¨pullæ¨¡å¼ã€‚pushæ›´å…³æ³¨å®æ—¶æ€§ï¼Œpullæ›´å…³æ³¨æ¶ˆè´¹è€…æ¶ˆè´¹èƒ½åŠ›ã€‚</p>
<h3 id="æ¶ˆè´¹è€…é…ç½®"><a href="#æ¶ˆè´¹è€…é…ç½®" class="headerlink" title="æ¶ˆè´¹è€…é…ç½®"></a>æ¶ˆè´¹è€…é…ç½®</h3><p><code>Java</code>é¡¹ç›®ä¸­ï¼Œä¸€èˆ¬ä¼šç»“åˆ<code>spring-amqp</code>æ¡†æ¶æ¥ä½¿ç”¨<code>RabbitMQ</code>ï¼Œ<code>spring-amqp</code>åº•å±‚è°ƒç”¨<code>RabbitMQ</code>çš„java clientæ¥å’Œ<code>Broker</code>äº¤äº’ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¼šç”¨å¦‚ä¸‹é…ç½®æ¥å»ºç«‹<code>RabbitMQ</code>çš„è¿æ¥æ± ã€å£°æ˜Queueä»¥åŠæŒ‡æ˜ç›‘å¬è€…çš„ç›‘å¬è¡Œä¸ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">id</span>=<span class="string">"rabbitAdmin"</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span>/&gt;</span></div><div class="line"><span class="comment">&lt;!-- templateéå¿…é¡»ï¼Œä¸»è¦ç”¨äºç”Ÿäº§è€…å‘é€æ¶ˆæ¯--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">"template"</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">"test.queue"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> <span class="attr">concurrency</span>=<span class="string">"1"</span> <span class="attr">prefetch</span>=<span class="string">"1"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">"listener"</span> <span class="attr">queue-names</span>=<span class="string">"test.queue"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>concurrency</code>è®¾ç½®çš„æ˜¯å¯¹æ¯ä¸ª<code>listener</code>åœ¨åˆå§‹åŒ–çš„æ—¶å€™è®¾ç½®çš„å¹¶å‘æ¶ˆè´¹è€…çš„ä¸ªæ•°ï¼Œ<code>prefetch</code>æ˜¯æ¯æ¬¡ä»ä¸€æ¬¡æ€§ä»brokeré‡Œé¢å–çš„å¾…æ¶ˆè´¹çš„æ¶ˆæ¯çš„ä¸ªæ•°(é»˜è®¤ä¸º1).</p>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    ConnectionFactory connectionFactory = <span class="keyword">new</span> CachingConnectionFactory(<span class="number">5672</span>);</div><div class="line">    SimpleMessageListenerContainer container = <span class="keyword">new</span> SimpleMessageListenerContainer(connectionFactory);</div><div class="line">    container.setConcurrentConsumers(<span class="number">1</span>);</div><div class="line">    container.setQueueNames(<span class="string">"spring"</span>);</div><div class="line">    container.setMessageListener(<span class="keyword">new</span> MessageListener() &#123;</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"received: "</span> + message);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    container.start();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="MessageListenerContaineråˆ†æ"><a href="#MessageListenerContaineråˆ†æ" class="headerlink" title="MessageListenerContaineråˆ†æ"></a>MessageListenerContaineråˆ†æ</h4><p><code>org.springframework.amqp.rabbit.listener.MessageListenerContainer</code>å¯ä»¥çœ‹ä½œ<code>MessageLinstener</code>çš„å®¹å™¨ã€‚<code>MessageListenerContainer</code>åªåŒ…å«ä¸€ä¸ª<code>MessageListener</code>ï¼Œå¯ä»¥ç”Ÿæˆå¤šä¸ªçº¿ç¨‹ä½¿ç”¨ç›¸åŒçš„<code>MessageListener</code>åŒæ—¶æ¶ˆè´¹æ¶ˆæ¯.</p>
<p><code>MessageListenerContainer</code>ç»§æ‰¿è‡ª<code>SmartLifecycle</code>æ¥å£ï¼Œè¯¥æ¥å£æ˜¯Springå®¹å™¨æä¾›çš„ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†ç›¸å…³çš„æ¥å£ï¼Œå®ç°è¯¥æ¥å£çš„ç±»ä¼šç”±Springå®¹å™¨è´Ÿè´£å¯åŠ¨ä¸åœæ­¢ã€‚SpringåŠ è½½å’Œåˆå§‹åŒ–æ‰€æœ‰beanåï¼Œä¼šæ¥ç€å›è°ƒå®ç°è¯¥æ¥å£çš„ç±»ä¸­å¯¹åº”çš„<code>start()</code>æ–¹æ³•.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// SimpleMessageListenerContainer.class</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">  <span class="comment">//some code</span></div><div class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>.consumersMonitor) &#123;</div><div class="line">    <span class="keyword">int</span> newConsumers = initializeConsumers();</div><div class="line">    <span class="comment">//some code</span></div><div class="line">    Set&lt;AsyncMessageProcessingConsumer&gt; processors = <span class="keyword">new</span> HashSet&lt;AsyncMessageProcessingConsumer&gt;();</div><div class="line">    <span class="keyword">for</span> (BlockingQueueConsumer consumer : <span class="keyword">this</span>.consumers.keySet()) &#123;</div><div class="line">    	AsyncMessageProcessingConsumer processor = <span class="keyword">new</span> AsyncMessageProcessingConsumer(consumer);</div><div class="line">    	processors.add(processor);</div><div class="line">        <span class="comment">// å°†æ¶ˆè´¹è€…çº¿ç¨‹æ”¾åœ¨çº¿ç¨‹æ± ä¸­ï¼Œæ¯ä¸€ä¸ªæ¶ˆè´¹è€…ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å‘æ‰§è¡Œ</span></div><div class="line">    	<span class="keyword">this</span>.taskExecutor.execute(processor);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//some code</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨<code>doStart()</code>æ–¹æ³•ä¸­è°ƒç”¨<code>initializeConsumers()</code>æ¥åˆå§‹åŒ–æ‰€æœ‰çš„æ¶ˆè´¹è€…ï¼Œ<code>AsyncMessageProcessingConsumer</code>ä½œä¸ºçœŸå®çš„å¤„ç†å™¨åŒ…è£…äº†<code>BlockingQueueConsumer</code>ï¼Œè€Œä¸”<code>AsyncMessageProcessingConsumer</code>å…¶å®å®ç°äº†<code>Runnable</code>æ¥å£.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">initializeConsumers</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>.consumersMonitor) &#123;</div><div class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.consumers == <span class="keyword">null</span>) &#123;</div><div class="line">				cancellationLock.reset();</div><div class="line">				<span class="keyword">this</span>.consumers = <span class="keyword">new</span> HashSet&lt;BlockingQueueConsumer&gt;(<span class="keyword">this</span>.concurrentConsumers);</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.concurrentConsumers; i++) &#123;</div><div class="line">					BlockingQueueConsumer consumer = createBlockingQueueConsumer();</div><div class="line">					<span class="keyword">this</span>.consumers.add(consumer);</div><div class="line">					count++;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> count;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p><code>container</code>å¯åŠ¨çš„æ—¶å€™ä¼šæ ¹æ®è®¾ç½®çš„<code>concurrency</code>çš„å€¼åˆ›å»ºnä¸ª<code>BlockingQueueConsumer</code></p>
<h5 id="AsyncMessageProcessingConsumer"><a href="#AsyncMessageProcessingConsumer" class="headerlink" title="AsyncMessageProcessingConsumer"></a>AsyncMessageProcessingConsumer</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// SimpleMessageListenerContainer$AsyncMessageProcessingConsumer.class</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncMessageProcessingConsumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueueConsumer consumer;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch start;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> FatalListenerStartupException startupException;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">AsyncMessageProcessingConsumer</span><span class="params">(BlockingQueueConsumer consumer)</span> </span>&#123;</div><div class="line">  	<span class="keyword">this</span>.consumer = consumer;</div><div class="line">  	<span class="keyword">this</span>.start = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">     ...some code...</div><div class="line">       </div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">      <span class="comment">// æ¶ˆè´¹è€…æ‰§è¡Œï¼Œæ¯æ¬¡ä»é˜Ÿåˆ—ä¸­è·å–prefetchCountæ•°é‡çš„æ¶ˆæ¯ï¼Œæ”¾åœ¨æ¶ˆè´¹è€…BlockingQueueä¸­</span></div><div class="line">          consumer.start();</div><div class="line">          start.countDown();</div><div class="line">        &#125; <span class="keyword">catch</span> (FatalListenerStartupException ex) &#123;</div><div class="line">          <span class="keyword">throw</span> ex;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">          start.countDown();</div><div class="line">          handleStartupFailure(t);</div><div class="line">          <span class="keyword">throw</span> t;</div><div class="line">        &#125;</div><div class="line">        ...some code...</div><div class="line">       </div><div class="line">        <span class="keyword">boolean</span> continuable = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">while</span> (isActive() || continuable) &#123;</div><div class="line">          <span class="comment">// isActive()è¡¨ç¤ºMessageListenerContaineræ˜¯å¦æ˜¯æ´»è·ƒçš„ï¼Œæ­£å¸¸æƒ…å†µä¸‹éƒ½æ˜¯true</span></div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// ä¸åœçš„å°è¯•ä»æ¶ˆè´¹è€…queueä¸­è·å–Deliveryå®ä¾‹ï¼Œå°†ä¹‹è½¬åŒ–ä¸ºMessageï¼Œç„¶åæ‰§è¡ŒMessageListener çš„onMessageå›è°ƒæ–¹æ³•</span></div><div class="line">            continuable = receiveAndExecute(consumer) &amp;&amp; !isChannelTransacted();</div><div class="line">          &#125; <span class="keyword">catch</span> (ListenerExecutionFailedException ex) &#123;</div><div class="line">            <span class="comment">// æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œä¸å½±å“çº¿ç¨‹æ‰§è¡Œï¼Œç»§ç»­è·å–æ¶ˆæ¯è¿›è¡Œå¤„ç†</span></div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ...some code...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="è·å–æ¶ˆæ¯ï¼šconsumer-start"><a href="#è·å–æ¶ˆæ¯ï¼šconsumer-start" class="headerlink" title="è·å–æ¶ˆæ¯ï¼šconsumer.start()"></a>è·å–æ¶ˆæ¯ï¼šconsumer.start()</h5><p><code>BlockingQueueConsumer</code>å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—<code>BlockingQueue</code>ï¼Œè¿™ä¸ªqueueä¸æ˜¯å¯¹åº”RabbitMQçš„é˜Ÿåˆ—ï¼Œè€Œæ˜¯Consumerè‡ªå·±ç»´æŠ¤çš„å†…å­˜çº§åˆ«çš„é˜Ÿåˆ—ï¼Œç”¨æ¥æš‚æ—¶å­˜å‚¨ä»RabbitMQä¸­å–å‡ºæ¥çš„æ¶ˆæ¯.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BlockingQueueConsumer.class</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Delivery&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Delivery&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> AmqpException </span>&#123;</div><div class="line">    <span class="keyword">this</span>.consumer = <span class="keyword">new</span> InternalConsumer(channel);</div><div class="line"></div><div class="line">    ...some code...</div><div class="line"></div><div class="line">    <span class="keyword">int</span> passiveDeclareTries = <span class="number">3</span>;</div><div class="line">    do &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (!acknowledgeMode.isAutoAck()) &#123;</div><div class="line">          <span class="comment">// å£°æ˜æ¯æ¬¡è·å–æ¶ˆæ¯æ•°é‡</span></div><div class="line">          channel.basicQos(prefetchCount);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; queues.length; i++) &#123;</div><div class="line">          <span class="comment">// å£°æ˜æ¯ä¸ªé˜Ÿåˆ—ï¼Œæ¶ˆæ¯æ¥æºå¯èƒ½æ˜¯å¤šä¸ªé˜Ÿåˆ—</span></div><div class="line">          channel.queueDeclarePassive(queues[i]);</div><div class="line">        &#125;</div><div class="line">        passiveDeclareTries = <span class="number">0</span>;</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        ...some code...</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">while</span> (passiveDeclareTries-- &gt; <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; queues.length; i++) &#123;</div><div class="line">        <span class="comment">// å¯¹æ¯ä¸ªé˜Ÿåˆ—ï¼Œéƒ½ä¼šè°ƒç”¨basicConsumeæ–¹æ³•è®©InternalConsumerç›‘å¬å½“å‰é˜Ÿåˆ—</span></div><div class="line">        channel.basicConsume(queues[i], acknowledgeMode.isAutoAck(), consumer);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      <span class="keyword">throw</span> RabbitExceptionTranslator.convertRabbitAccessException(e);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>è°ƒç”¨<code>channel.basicConsume</code>åï¼Œ<code>broker</code>å°±ä¼šä¸æ–­å¾€<code>consumer</code>æŠ•é€’<code>message</code>ï¼Œæ¯æ¬¡<code>prefetch</code>æ¡ã€‚<code>consumer</code>æ˜¯é€šè¿‡å¼‚æ­¥æ–¹å¼æ¥æŠ“å–<code>message</code>çš„ï¼Œ<code>BlockingQueue</code>çš„sizeæ˜¯åœ¨å¼‚æ­¥åœ°ä¸æ–­å¢é•¿ç›´åˆ°<code>prefetch</code>ã€‚</p>
<p>å½“é˜Ÿåˆ—æ¥å—åˆ°æ¶ˆæ¯æ—¶ï¼Œ<code>amqp client</code>ä¼šä¸»åŠ¨è°ƒç”¨<code>InternalConsumer</code>çš„<code>handleDelivery()</code>æ–¹æ³•ã€‚è¯¥æ–¹æ³•è°ƒç”¨ <code>BlockingQueueConsumer.this.queue.put(new Delivery(consumerTag, envelope, properties, body))</code>å°†æ¶ˆæ¯æ”¾åˆ°<code>BlockingQueueConsumer</code>çš„<code>BlockingQueue&lt;Delivery&gt; queue</code>ä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BlockingQueueConsumer$InternalConsumer.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span></span></div><div class="line">				<span class="keyword">throws</span> IOException &#123;</div><div class="line">		...some code...</div><div class="line">          </div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				queue.put(<span class="keyword">new</span> Delivery(envelope, properties, body));</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				Thread.currentThread().interrupt();</div><div class="line">			&#125;</div><div class="line">		&#125;</div></pre></td></tr></table></figure>
<h5 id="å¤„ç†æ¶ˆæ¯"><a href="#å¤„ç†æ¶ˆæ¯" class="headerlink" title="å¤„ç†æ¶ˆæ¯"></a>å¤„ç†æ¶ˆæ¯</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// SimpleMessageListenerContainer$AsyncMessageProcessingConsumer.class</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">doReceiveAndExecute</span><span class="params">(BlockingQueueConsumer consumer)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"></div><div class="line">		Channel channel = consumer.getChannel();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; txSize; i++) &#123;</div><div class="line">            <span class="comment">// ä»æ¶ˆè´¹è€…é˜Ÿåˆ—ä¸­è·å–Deliveryï¼Œå°†ä¹‹è½¬åŒ–ä¸º Message</span></div><div class="line">			Message message = consumer.nextMessage(receiveTimeout);</div><div class="line">			<span class="keyword">if</span> (message == <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">              <span class="comment">// æ‰§è¡ŒMessageListenerçš„onMessageå›è°ƒæ–¹æ³•</span></div><div class="line">				executeListener(channel, message);</div><div class="line">			&#125; <span class="keyword">catch</span> (ImmediateAcknowledgeAmqpException e) &#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">               <span class="comment">// æ¶ˆæ¯å¤„ç†å¤±è´¥,æ‰§è¡Œchannel.basicReject()</span></div><div class="line">				consumer.rollbackOnExceptionIfNecessary(ex);</div><div class="line">				<span class="keyword">throw</span> ex;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> consumer.commitIfNecessary(isChannelLocallyTransacted(channel));</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<ol>
<li>å¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œåˆ™è°ƒç”¨ AMQP ä¿¡é“çš„<code>basicAck</code>æ–¹æ³•ç¡®è®¤æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸã€‚</li>
<li>å¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™å°†å¼‚å¸¸è½¬åŒ–ä¸º<code>ListenerExecutionFailedException</code>æŠ›å‡ºã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring AMQP å¤„ç†ç”¨æˆ·è‡ªå®šä¹‰å¼‚å¸¸çš„é€»è¾‘éå¸¸ç®€å•ï¼šè°ƒç”¨ AMQP ä¿¡é“çš„<code>basicReject</code>æ–¹æ³•å°†æ¶ˆæ¯é€€å›é˜Ÿåˆ—ï¼Œä½†ä¸ä¼šæ‰“ç ´<code>AsyncMessageProcessingConsumer</code>çº¿ç¨‹çš„whileå¾ªç¯ï¼Œæ¶ˆæ¯æ¶ˆè´¹ç»§ç»­è¿›è¡Œã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">commitIfNecessary</span><span class="params">(<span class="keyword">boolean</span> locallyTransacted)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        ...some code...</div><div class="line">          </div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">boolean</span> ackRequired = !acknowledgeMode.isAutoAck() &amp;&amp; !acknowledgeMode.isManual();</div><div class="line"></div><div class="line">            <span class="comment">// éœ€è¦ack</span></div><div class="line">			<span class="keyword">if</span> (ackRequired) &#123;</div><div class="line">              ...some code...</div><div class="line">                </div><div class="line">					<span class="keyword">if</span> (!deliveryTags.isEmpty()) &#123;</div><div class="line">						<span class="keyword">long</span> deliveryTag = <span class="keyword">new</span> ArrayList&lt;Long&gt;(deliveryTags).get(deliveryTags.size() - <span class="number">1</span>);</div><div class="line">                        <span class="comment">// å‘é€brokeræ¶ˆæ¯ç¡®è®¤ï¼Œæ–¹ä¾¿åˆ é™¤è¯¥æ¡æ¶ˆæ¯</span></div><div class="line">						channel.basicAck(deliveryTag, <span class="keyword">true</span>);</div><div class="line">					&#125;</div><div class="line">			&#125;</div><div class="line">          </div><div class="line">        ...some code...</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			deliveryTags.clear();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p><code>org.springframework.amqp.core.AcknowledgeMode</code>å®šä¹‰äº†ä¸‰ç§ç¡®è®¤æ¨¡å¼ï¼š</p>
<ul>
<li><code>NONE</code>ï¼šä¸ç¡®è®¤ï¼Œç›¸å½“äº amqp client ä¸­<code>Channel.basicConsume</code>æ–¹æ³•ä¸­<code>autoAck</code>å‚æ•°å€¼è®¾ä¸ºâ€œtrueâ€ï¼Œå¦‚æœæ˜¯è¿™ç§æ¨¡å¼ï¼Œä¸ç®¡ä¸šåŠ¡æ‰§è¡Œæ˜¯å¦æˆåŠŸï¼Œbrokeréƒ½ä¼šæ”¶åˆ°ackä»è€Œåˆ é™¤è¯¥æ¶ˆæ¯</li>
<li><code>MANUAL</code>ï¼šç”¨æˆ·é€šè¿‡æ‰‹åŠ¨æ§åˆ¶æ¶ˆæ¯ç¡®è®¤ï¼Œç”±ä¸šåŠ¡è‡ªå·±ç¡®å®šä»€ä¹ˆæ—¶å€™ack(æ‰‹åŠ¨è°ƒç”¨<code>channel.basicAck</code>)</li>
<li><code>AUTO</code>ï¼šSpring AMQPæ¡†æ¶æ ¹æ®<code>MessageListener</code>çš„<code>onMessage</code>æ‰§è¡Œè¿‡ç¨‹ä¸­æ˜¯å¦æŠ›å‡ºå¼‚å¸¸æ¥å†³å®šæ˜¯å¦ç¡®è®¤æ¶ˆæ¯æ¶ˆè´¹</li>
</ul>
<p>Springåˆ›å»º<code>CachingConnectionFactory</code>çš„æ—¶å€™ï¼Œ<code>AcknowledgeMode</code>é»˜è®¤ä¸º AUTOï¼›ä¹Ÿå°±æ˜¯ä¸šåŠ¡æ‰§è¡Œå¤±è´¥åˆ™æ¶ˆæ¯å›é€€é˜Ÿåˆ—ï¼Œå¦åˆ™brokeræ”¶åˆ°ackåˆ é™¤è¯¥æ¶ˆæ¯ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è®¾ç½®å¹¶å‘æ¶ˆè´¹é™¤äº†èƒ½æé«˜æ¶ˆè´¹çš„é€Ÿåº¦ï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªå¥½å¤„ï¼šå½“æŸä¸ªæ¶ˆè´¹è€…é•¿æœŸé˜»å¡ï¼Œæ­¤æ—¶åœ¨å½“å‰æ¶ˆè´¹è€…å†…éƒ¨çš„<code>BlockingQueue</code>çš„æ¶ˆæ¯ä¹Ÿä¼šè¢«ä¸€ç›´é˜»å¡ï¼Œä½†æ˜¯æ–°æ¥çš„æ¶ˆæ¯ä»ç„¶å¯ä»¥æŠ•é€’ç»™å…¶ä»–æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œè¿™ç§æƒ…å†µé¡¶å¤šä¼šå¯¼è‡´<code>prefetch</code>ä¸ªæ•°ç›®çš„æ¶ˆæ¯æ¶ˆè´¹æœ‰é—®é¢˜ï¼Œè€Œä¸è‡³äºå•æ¶ˆè´¹è€…æƒ…å†µä¸‹æ•´ä¸ªRabbitMQçš„é˜Ÿåˆ—ä¼šå› ä¸ºä¸€ä¸ªæ¶ˆæ¯æœ‰é—®é¢˜è€Œå…¨éƒ¨å µæ­»ã€‚æ‰€æœ‰åœ¨åˆé€‚çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œéœ€è¦åˆç†è®¾ç½®<code>concurrency</code>å’Œ<code>prefetch</code>å€¼ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p>[<a href="http://liuxing.info/%202017/06/30/Spring%20AMQP%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/" target="_blank" rel="external">Spring AMQPä¸­æ–‡æ–‡æ¡£</a>]</p>
<p>[<a href="http://www.cnblogs.com/gordonkong/p/7115155.html" target="_blank" rel="external">Spring AMQP æºç åˆ†æ MessageListener</a>]</p>
<p><a href="http://yuanwhy.com/2016/09/10/rabbitmq-concurrency-prefetch/" target="_blank" rel="external">RabbitMQæ¶ˆè´¹è€…çš„å‡ ä¸ªå‚æ•°</a></p>
<p><a href="http://blog.csdn.net/catoop/article/details/71274561" target="_blank" rel="external">Spring SmartLifecycle åœ¨å®¹å™¨æ‰€æœ‰beanåŠ è½½å’Œåˆå§‹åŒ–å®Œæ¯•æ‰§è¡Œ</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Spring Retry]]></title>
      <url>http://zsr.github.io/2017/09/25/Spring-Retry/</url>
      <content type="html"><![CDATA[<p>â€‹    åœ¨å¾ˆå¤šåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬éœ€è¦â€œé‡è¯•â€ï¼Œé‡è¯•æ„å‘³ç€åå¤æ‰§è¡Œä¸€æ®µä»£ç ç›´è‡³æˆåŠŸï¼Œæˆ–è€…é‡è¯•å¤šæ¬¡æ— æœåæ ‡è®°å¤±è´¥ã€‚æ¯”å¦‚<code>MQ</code>å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œä¼šé‡‡å–é‡è¯•æ‰‹æ®µï¼Œæ¯”å¦‚å·¥ç¨‹ä¸­ä½¿ç”¨<code>RPC</code>è¯·æ±‚å¤–éƒ¨æœåŠ¡,å¯èƒ½å› ä¸ºç½‘ç»œæ³¢åŠ¨å‡ºç°è¶…æ—¶è€Œé‡‡å–é‡è¯•æ‰‹æ®µç­‰ç­‰.</p>
<p>MQè‡ªèº«ä¹Ÿæœ‰é‡è¯•æœºåˆ¶,ä½†æ˜¯è¿™ç§æœºåˆ¶ä¸æ˜¯å¾ˆçµæ´»ï¼Œå¦‚æœæŸäº›åŠŸèƒ½æ²¡æœ‰ä½¿ç”¨MQçš„è¯ï¼Œé‚£ä¹ˆå°±ä¸æ˜¯é‚£ä¹ˆæ–¹ä¾¿äº†.</p>
<h3 id="æ¡†æ¶æ¦‚è§ˆ"><a href="#æ¡†æ¶æ¦‚è§ˆ" class="headerlink" title="æ¡†æ¶æ¦‚è§ˆ"></a>æ¡†æ¶æ¦‚è§ˆ</h3><p><em>Spring Retry</em> æ¡†æ¶å¹¿æ³›ä½¿ç”¨äº<code>Spring Batch</code>,<code>Spring Integration</code>,<code>Spring for Apache Hadoop</code>ç­‰springé¡¹ç›®</p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://kriszhang.com/spring-retry/spring-retry.png" alt="spring"></p>
<p></p>
<ol>
<li><code>RetryTemplate</code>ï¼Œé‡è¯•æ¨¡æ¿ï¼Œæ˜¯è¿›å…¥spring-retryæ¡†æ¶çš„æ•´ä½“æµç¨‹å…¥å£</li>
<li><code>RetryCallback</code>ï¼Œé‡è¯•å›è°ƒï¼Œç”¨æˆ·åŒ…è£…ä¸šåŠ¡æµï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œå’Œäº§ç”Ÿé‡è¯•æ‰§è¡Œéƒ½ä¼šè°ƒç”¨è¿™ä¸ªcallbackä»£ç </li>
<li><code>RetryPolicy</code>ï¼Œé‡è¯•ç­–ç•¥ï¼Œä¸åŒç­–ç•¥æœ‰ä¸åŒçš„é‡è¯•æ–¹å¼</li>
<li><code>BackOffPolicy</code>ï¼Œä¸¤æ¬¡é‡è¯•ä¹‹é—´çš„å›é¿ç­–ç•¥ï¼Œä¸€èˆ¬é‡‡ç”¨è¶…æ—¶æ—¶é—´æœºåˆ¶</li>
<li><code>RecoveryCallback</code>ï¼Œå½“æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥åï¼Œå›è°ƒè¯¥æ¥å£ï¼Œæä¾›ç»™ä¸šåŠ¡é‡è¯•å›å¤æœºåˆ¶</li>
<li><code>RetryContext</code>ï¼Œæ¯æ¬¡é‡è¯•éƒ½ä¼šå°†å…¶ä½œä¸ºå‚æ•°ä¼ å…¥RetryCallbackä¸­ä½¿ç”¨</li>
<li><code>RetryListener</code>ï¼Œç›‘å¬é‡è¯•è¡Œä¸ºï¼Œä¸»è¦ç”¨äºç›‘æ§ã€‚</li>
</ol>
<h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> RetryTemplate retryTemplate = <span class="keyword">new</span> RetryTemplate();</div><div class="line">    </div><div class="line">    <span class="keyword">final</span> SimpleRetryPolicy policy = <span class="keyword">new</span> SimpleRetryPolicy(<span class="number">3</span>,</div><div class="line">        Collections.&lt;Class&lt;? extends Throwable&gt;, Boolean&gt; singletonMap(Exception.class, <span class="keyword">true</span>));</div><div class="line">    FixedBackOffPolicy fixedBackOffPolicy = <span class="keyword">new</span> FixedBackOffPolicy();</div><div class="line">    fixedBackOffPolicy.setBackOffPeriod(<span class="number">100</span>);</div><div class="line">    retryTemplate.setRetryPolicy(policy);</div><div class="line">    retryTemplate.setBackOffPolicy(fixedBackOffPolicy);</div><div class="line">    </div><div class="line">    <span class="keyword">final</span> RetryCallback&lt;Object, Exception&gt; retryCallback = <span class="keyword">new</span> RetryCallback&lt;Object, Exception&gt;() &#123;</div><div class="line">      <span class="function"><span class="keyword">public</span> Object <span class="title">doWithRetry</span><span class="params">(RetryContext context)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        System.out.println(<span class="string">"do some thing"</span>);</div><div class="line">        <span class="comment">// è®¾ç½®contextä¸€äº›å±æ€§,ç»™RecoveryCallbackä¼ é€’ä¸€äº›å±æ€§</span></div><div class="line">        context.setAttribute(<span class="string">"key"</span>, <span class="string">"value"</span>);</div><div class="line">        System.out.println(context.getRetryCount());</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"exception"</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// å¦‚æœRetryCallbackæ‰§è¡Œå‡ºç°æŒ‡å®šå¼‚å¸¸, å¹¶ä¸”è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ä¾æ—§å‡ºç°æŒ‡å®šå¼‚å¸¸çš„è¯,å°±æ‰§è¡ŒRecoveryCallbackåŠ¨ä½œ</span></div><div class="line">    <span class="keyword">final</span> RecoveryCallback&lt;Object&gt; recoveryCallback = <span class="keyword">new</span> RecoveryCallback&lt;Object&gt;() &#123;</div><div class="line">      <span class="function"><span class="keyword">public</span> Object <span class="title">recover</span><span class="params">(RetryContext context)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        System.out.println(<span class="string">"do recory operation"</span>);</div><div class="line">        System.out.println(context.getAttribute(<span class="string">"key"</span>));</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">final</span> Object result = retryTemplate.execute(retryCallback, recoveryCallback);</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="é‡è¯•ç­–ç•¥-RetryPolicy"><a href="#é‡è¯•ç­–ç•¥-RetryPolicy" class="headerlink" title="é‡è¯•ç­–ç•¥:RetryPolicy"></a>é‡è¯•ç­–ç•¥:RetryPolicy</h4><p>é‡è¯•ç­–ç•¥å®šä¹‰äº†å½“æ“ä½œå¤±è´¥æ—¶å¦‚ä½•è¿›è¡Œé‡è¯•æ“ä½œ</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fj6gaoq06cj30j00cemxi.jpg" alt="é‡è¯•æ¡†æ¶Spring retryå®è·µ"></p>
<ol>
<li><code>NeverRetryPolicy</code>ï¼šåªè°ƒç”¨RetryCallbackä¸€æ¬¡ï¼Œä¸é‡è¯•</li>
<li><code>AlwaysRetryPolicy</code>ï¼šæ— é™é‡è¯•ï¼Œæœ€å¥½ä¸è¦ç”¨</li>
<li><code>SimpleRetryPolicy</code>ï¼šé‡è¯•næ¬¡ï¼Œé»˜è®¤3ï¼Œä¹Ÿæ˜¯æ¨¡æ¿é»˜è®¤çš„ç­–ç•¥</li>
<li><code>TimeoutRetryPolicy</code>ï¼šåœ¨næ¯«ç§’å†…ä¸æ–­è¿›è¡Œé‡è¯•ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ååœæ­¢é‡è¯•</li>
<li><code>ExceptionClassifierRetryPolicy</code>: å¯ä»¥æ ¹æ®ä¸åŒçš„å¼‚å¸¸ï¼Œæ‰§è¡Œä¸åŒçš„é‡è¯•ç­–ç•¥</li>
</ol>
<h4 id="å›é€€ç­–ç•¥-BackOffPolicy-é‡è¯•é—´éš”"><a href="#å›é€€ç­–ç•¥-BackOffPolicy-é‡è¯•é—´éš”" class="headerlink" title="å›é€€ç­–ç•¥:BackOffPolicy(é‡è¯•é—´éš”)"></a>å›é€€ç­–ç•¥:BackOffPolicy(é‡è¯•é—´éš”)</h4><p>å½“æ“ä½œæ‰§è¡Œå¤±è´¥æ—¶ï¼Œæ ¹æ®è®¾ç½®çš„é‡è¯•ç­–ç•¥è¿›è¡Œé‡è¯•ã€‚é€šè¿‡BackoffPolicyå¯ä»¥è®¾å®šå†æ¬¡é‡è¯•çš„æ—¶é—´é—´éš”ã€‚</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fj6g6lddqtj30k0098mxj.jpg" alt="é‡è¯•æ¡†æ¶Spring retryå®è·µ"></p>
<ol>
<li><code>NoBackOffPolicy</code>ï¼šä¸å›é¿</li>
<li><code>FixedBackOffPolicy</code>ï¼šnæ¯«ç§’é€€é¿åå†è¿›è¡Œé‡è¯•</li>
</ol>
<h5 id="æœ‰çŠ¶æ€é‡è¯•-OR-æ— çŠ¶æ€é‡è¯•"><a href="#æœ‰çŠ¶æ€é‡è¯•-OR-æ— çŠ¶æ€é‡è¯•" class="headerlink" title="æœ‰çŠ¶æ€é‡è¯• OR æ— çŠ¶æ€é‡è¯•"></a>æœ‰çŠ¶æ€é‡è¯• OR æ— çŠ¶æ€é‡è¯•</h5><p>æ‰€è°“æ— çŠ¶æ€é‡è¯•æ˜¯æŒ‡é‡è¯•åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­å®Œæˆçš„é‡è¯•ï¼Œåä¹‹ä¸åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡å®Œæˆé‡è¯•çš„å°±æ˜¯æœ‰çŠ¶æ€é‡è¯•ã€‚ä¹‹å‰çš„SimpleRetryPolicyå°±å±äºæ— çŠ¶æ€é‡è¯•ï¼Œå› ä¸ºé‡è¯•æ˜¯åœ¨ä¸€ä¸ªå¾ªç¯ä¸­å®Œæˆçš„ã€‚ä»€ä¹ˆæ—¶å€™åä¼šå‡ºç°æˆ–è€…è¯´éœ€è¦æœ‰çŠ¶æ€é‡è¯•å‘¢ï¼Ÿé€šå¸¸æœ‰ä¸¤ç§æƒ…å†µï¼šäº‹åŠ¡å›æ»šå’Œç†”æ–­ã€‚</p>
<h4 id="ä½¿ç”¨æ³¨è§£"><a href="#ä½¿ç”¨æ³¨è§£" class="headerlink" title="ä½¿ç”¨æ³¨è§£"></a>ä½¿ç”¨æ³¨è§£</h4><p>æ¯æ¬¡æœ‰é‡è¯•éœ€æ±‚çš„æ—¶å€™éƒ½å†™ä¸€ä¸ª<code>RetryTemplate</code>å¤ªè‡ƒè‚¿äº†ï¼Œä½¿ç”¨æ³¨è§£å¯ä»¥å¤§å¤§ç®€åŒ–å¼€å‘ï¼Œå‡å°‘é‡å¤ä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationService</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> Logger logger = LoggerFactory.getLogger(AnnotationService.class);</div><div class="line"></div><div class="line">  <span class="meta">@Retryable</span>(maxAttempts = <span class="number">5</span>, backoff = <span class="meta">@Backoff</span>(random = <span class="keyword">true</span>))</div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">someService</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> random = (<span class="keyword">int</span>) (Math.random() * <span class="number">10</span>);</div><div class="line">    <span class="keyword">if</span> (random &lt; <span class="number">4</span>) &#123;</div><div class="line">      logger.info(<span class="string">"random=&#123;&#125; Null Pointer Excep"</span>, random);</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (random &lt; <span class="number">9</span>) &#123;</div><div class="line">      logger.info(<span class="string">"random=&#123;&#125; Arithmetic Excep"</span>, random);</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException();</div><div class="line">    &#125;</div><div class="line">    logger.info(<span class="string">"random=&#123;&#125; ok !!!!"</span>, random);</div><div class="line">    <span class="keyword">return</span> <span class="string">"ok"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Recover</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">recover</span><span class="params">(NullPointerException ne)</span> </span>&#123;</div><div class="line">    logger.info(<span class="string">"&#123;&#125;"</span>, <span class="string">"NullPointerException"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="string">"null pointer recover"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Recover</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">recover</span><span class="params">(ArithmeticException ne)</span> </span>&#123;</div><div class="line">    logger.info(<span class="string">"&#123;&#125;"</span>, <span class="string">"ArithmeticException"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="string">"ArithmeticException recover"</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">  </div><div class="line"><span class="meta">@Configuration</span> <span class="comment">// ç›¸å½“äºxml beanå®¹å™¨</span></div><div class="line"><span class="meta">@EnableRetry</span></div><div class="line"><span class="meta">@EnableAspectJAutoProxy</span>(proxyTargetClass = <span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationRetryTest</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">AnnotationRetryTest</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"springå®¹å™¨å¯åŠ¨åˆå§‹åŒ–ã€‚ã€‚ã€‚"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Bean</span>  <span class="comment">// æ³¨å…¥AnnotationService</span></div><div class="line">  <span class="function"><span class="keyword">public</span> AnnotationService <span class="title">annotationService</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AnnotationService();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(AnnotationRetryTest.class);</div><div class="line">    AnnotationService annoService = context.getBean(AnnotationService.class);</div><div class="line">    String result = annoService.someService();</div><div class="line">    System.out.println(result);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li><code>@EnableRetry</code>ï¼šèƒ½å¦é‡è¯•ï¼Œ<code>proxyTargetClass</code>å±æ€§ä¸ºtrueæ—¶ï¼ˆé»˜è®¤falseï¼‰ï¼Œä½¿ç”¨CGLIBä»£ç†ã€‚é»˜è®¤ä½¿ç”¨æ ‡å‡†JAVAæ³¨è§£ã€‚å½“ç±»ä¸­æœ‰<code>@Retryable</code>æ³¨é‡Šçš„æ–¹æ³•æ—¶ï¼Œå¯¹è¯¥æ–¹æ³•ç”Ÿæˆä»£ç†ã€‚</li>
<li><code>@Retryable</code>ï¼šæ³¨è§£éœ€è¦è¢«é‡è¯•çš„æ–¹æ³• <ul>
<li><code>include</code> æŒ‡å®šå¤„ç†çš„å¼‚å¸¸ç±»ã€‚é»˜è®¤ä¸ºç©º</li>
<li><code>exclude</code> æŒ‡å®šä¸éœ€è¦å¤„ç†çš„å¼‚å¸¸ã€‚é»˜è®¤ä¸ºç©º </li>
<li><code>vaue</code> æŒ‡å®šè¦é‡è¯•çš„å¼‚å¸¸ã€‚é»˜è®¤ä¸ºç©º </li>
<li><code>maxAttempts</code> æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚é»˜è®¤3æ¬¡ </li>
<li><code>backoff</code> é‡è¯•ç­‰å¾…ç­–ç•¥ã€‚é»˜è®¤ä½¿ç”¨@Backoffæ³¨è§£</li>
</ul>
</li>
<li><code>@Backoff</code>ï¼šé‡è¯•å›é€€ç­–ç•¥(ç«‹å³é‡è¯•è¿˜æ˜¯ç­‰å¾…ä¸€ä¼šå†é‡è¯•)<ul>
<li>ä¸è®¾ç½®å‚æ•°æ—¶ï¼Œé»˜è®¤ä½¿ç”¨<code>FixedBackOffPolicy</code>ï¼Œé‡è¯•ç­‰å¾…1000ms</li>
<li>åªè®¾ç½®<code>delay</code>å±æ€§æ—¶ï¼Œä½¿ç”¨<code>FixedBackOffPolicy</code>ï¼Œé‡è¯•ç­‰å¾…æŒ‡å®šçš„æ¯«ç§’æ•°</li>
<li>å½“è®¾ç½®<code>delay</code>å’Œ<code>maxDealy</code>å±æ€§æ—¶ï¼Œé‡è¯•ç­‰å¾…åœ¨è¿™ä¸¤ä¸ªå€¼ä¹‹é—´å‡æ€åˆ†å¸ƒ</li>
<li>ä½¿ç”¨<code>delay</code>ï¼Œ<code>maxDealy</code>å’Œ<code>multiplier</code>å±æ€§æ—¶ï¼Œä½¿ç”¨<code>ExponentialBackOffPolicy</code></li>
<li>å½“è®¾ç½®<code>multiplier</code>å±æ€§ä¸ç­‰äº0æ—¶ï¼ŒåŒæ—¶ä¹Ÿè®¾ç½®äº†random<code>å±æ€§æ—¶ï¼Œä½¿ç”¨</code>ExponentialRandomBackOffPolicy`</li>
<li><code>@Recover</code>: ç”¨äº<code>@Retryable</code>å¤±è´¥æ—¶çš„â€œå…œåº•â€å¤„ç†æ–¹æ³•ã€‚<code>@Recover</code>æ³¨é‡Šçš„æ–¹æ³•å‚æ•°ä¸º<code>@Retryable</code>å¼‚å¸¸ç±»ï¼Œè¿”å›å€¼åº”ä¸é‡è¯•æ–¹æ³•è¿”å›ç›¸åŒï¼Œå¦åˆ™æ— æ³•è¯†åˆ«ï¼å› æ­¤å¯ä»¥é’ˆå¯¹å¯èƒ½å¼‚å¸¸è®¾ç½®å¤šä¸ª<code>@Recover</code>æ–¹æ³•è¿›è¡Œâ€œå…œåº•â€å¤„ç†ã€‚</li>
</ul>
</li>
</ol>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p><code>RetryTemplate</code>çš„<code>execute</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ç°é€»è¾‘ä½¿ç”¨<code>ThreadLocal</code>ä¿å­˜æ¯ä¸ªæ‰§è¡Œå®ä¾‹çš„<code>RetryContext</code>æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚</p>
<p>è¿™é‡Œä»¥<code>SimpleRetryPolicy</code>å’Œ<code>FixedBackOffPolicy</code>ç­–ç•¥ä¸ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RetrySynchronizationManager.class</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;RetryContext&gt; context = <span class="keyword">new</span> ThreadLocal&lt;RetryContext&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RetryContext <span class="title">register</span><span class="params">(RetryContext context)</span> </span>&#123;</div><div class="line">		RetryContext oldContext = getContext();</div><div class="line">		RetrySynchronizationManager.context.set(context);</div><div class="line">		<span class="keyword">return</span> oldContext;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> &lt;T, E extends Throwable&gt; <span class="function">T <span class="title">doExecute</span><span class="params">(RetryCallback&lt;T, E&gt; retryCallback,</span></span></div><div class="line">      RecoveryCallback&lt;T&gt; recoveryCallback, RetryState state) <span class="keyword">throws</span> E,</div><div class="line">      ExhaustedRetryException &#123;</div><div class="line"></div><div class="line">    ....some code ...</div><div class="line"></div><div class="line">    <span class="comment">// æ³¨å†Œå½“å‰çš„RetryContextï¼Œæ”¾åœ¨ThreadLocalä¸­ä¿è¯çº¿ç¨‹å®‰å…¨</span></div><div class="line">    RetrySynchronizationManager.register(context);</div><div class="line"></div><div class="line">    Throwable lastException = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">      ...some code...</div><div class="line"></div><div class="line">      <span class="comment">// åˆ¤æ–­å½“å‰contextæ˜¯å¦æ»¡è¶³é‡è¯•æ¡ä»¶,è¿™é‡Œæ˜¯å¾ªç¯</span></div><div class="line">      <span class="keyword">while</span> (canRetry(retryPolicy, context) &amp;&amp; !context.isExhaustedOnly()) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">// Reset the last exception, so if we are successful</span></div><div class="line">          <span class="comment">// the close interceptors will not think we failed...</span></div><div class="line">          lastException = <span class="keyword">null</span>;</div><div class="line">          <span class="comment">// æ‰§è¡Œè‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘</span></div><div class="line">          <span class="keyword">return</span> retryCallback.doWithRetry(context);</div><div class="line">        &#125;<span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// æŠŠå¼‚å¸¸eå¡«å……è¿›contextï¼ŒåŒæ—¶é‡è¯•æŠ€æœ¯åŠ 1</span></div><div class="line">            registerThrowable(retryPolicy, state, context, e);</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TerminatedRetryException(<span class="string">"Could not register throwable"</span>, ex);</div><div class="line">          &#125;</div><div class="line">          </div><div class="line">          <span class="keyword">if</span> (canRetry(retryPolicy, context) &amp;&amp; !context.isExhaustedOnly()) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">              <span class="comment">// å¦‚æœæ»¡è¶³é‡è¯•æ¡ä»¶ï¼Œå¦‚å·²é‡è¯•æ¬¡æ•°å°äºé¢„å®šæ¬¡æ•°ï¼Œåˆ™çº¿ç¨‹ç­‰å¾…é¢„å®šçš„é—´éš”æ—¶é—´</span></div><div class="line">              backOffPolicy.backOff(backOffContext);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span> (BackOffInterruptedException ex) &#123;</div><div class="line">              lastException = e;</div><div class="line">              <span class="comment">// back off was prevented by another thread - fail the retry</span></div><div class="line">              <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                logger.debug(<span class="string">"Abort retry because interrupted: count="</span> + context.getRetryCount());</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">throw</span> ex;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">if</span> (shouldRethrow(retryPolicy, context, state)) &#123;</div><div class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">              logger.debug(<span class="string">"Rethrow in retry for policy: count="</span> + context.getRetryCount());</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">throw</span> RetryTemplate.&lt;E&gt;wrapIfNecessary(e);</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (context.isExhaustedOnly()) &#123;</div><div class="line">        rethrow(context, <span class="string">"Retry exhausted after last attempt with no recovery path."</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œå¤„ç†â€œå…œåº•â€æ–¹æ³•recover()</span></div><div class="line">      <span class="keyword">return</span> handleRetryExhausted(recoveryCallback, context, state);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">      <span class="keyword">throw</span> RetryTemplate.&lt;E&gt;wrapIfNecessary(e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">finally</span> &#123;</div><div class="line">      close(retryPolicy, context, state, lastException == <span class="keyword">null</span>);</div><div class="line">      doCloseInterceptors(retryCallback, context, lastException);</div><div class="line">      RetrySynchronizationManager.clear();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// FixedBackOffPolicy.class</span></div><div class="line"><span class="keyword">private</span> Sleeper sleeper = <span class="keyword">new</span> ThreadWaitSleeper();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBackOff</span><span class="params">()</span> <span class="keyword">throws</span> BackOffInterruptedException </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// æ—¶é—´é—´éš”æ˜¯ç”±çº¿ç¨‹sleepå®ç°</span></div><div class="line">			sleeper.sleep(backOffPeriod);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BackOffInterruptedException(<span class="string">"Thread interrupted while sleeping"</span>, e);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadWaitSleeper</span> <span class="keyword">implements</span> <span class="title">Sleeper</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">(<span class="keyword">long</span> backOffPeriod)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		Thread.sleep(backOffPeriod);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://iyiguo.net/blog/2016/01/19/spring-retry-common-case/" target="_blank" rel="external">Spring Retry å¸¸ç”¨ç¤ºä¾‹</a></p>
<p><a href="http://kriszhang.com/spring-retry/" target="_blank" rel="external">åˆ©ç”¨Spring-Retryå®šåˆ¶åŒ–ä½ çš„RPCé‡è¯•</a></p>
<p><a href="http://www.baeldung.com/spring-retry" target="_blank" rel="external">Guide to Spring Retry</a></p>
<p><a href="https://github.com/spring-projects/spring-retry" target="_blank" rel="external">github:spring-retry</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è¿æ¥æ± åŸç†]]></title>
      <url>http://zsr.github.io/2017/09/15/%E8%BF%9E%E6%8E%A5%E6%B1%A0%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<p>â€‹    è¿æ¥æ± çš„åŸºæœ¬æ€æƒ³å°±æ˜¯ä¸ºè¿æ¥å»ºç«‹ä¸€ä¸ªâ€œç¼“å†²æ± â€ã€‚é¢„å…ˆåœ¨ç¼“å†²æ± ä¸­æ”¾å…¥ä¸€å®šæ•°é‡çš„è¿æ¥ï¼Œå½“éœ€è¦å»ºç«‹è¿æ¥æ—¶ï¼Œåªéœ€è¦ä»ç¼“å†²æ± ä¸­å–å‡ºä¸€ä¸ªäº†ï¼Œä½¿ç”¨å®Œæ¯•åå†æ”¾å›å»ã€‚</p>
<p><code>apache commons-pool</code>æ˜¯apacheåŸºé‡‘ä¼šçš„ä¸€ä¸ªå¼€æºå¯¹è±¡æ± ç»„ä»¶ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„æ•°æ®åº“è¿æ¥æ± <code>dpcp</code>å’Œ<code>redis</code>çš„javaå®¢æˆ·ç«¯jediséƒ½ä½¿ç”¨<code>commons-pool</code>æ¥ç®¡ç†è¿æ¥ã€‚</p>
<p>ä¸»è¦æä¾›è¿™ä¸ªå‡ ç§ç±»å‹çš„å¯¹è±¡æ± ï¼š</p>
<p><img src="https://www.throwsnew.com/img/GenericObjectPool.PNG" alt="ç±»å›¾"><br>è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»<code>GenericObjectPool</code>çš„å®ç°ã€‚</p>
<h3 id="å·¥ä½œåŸç†ï¼š"><a href="#å·¥ä½œåŸç†ï¼š" class="headerlink" title="å·¥ä½œåŸç†ï¼š"></a>å·¥ä½œåŸç†ï¼š</h3><p>è¿æ¥æ± çš„æ ¸å¿ƒæ€æƒ³æ˜¯è¿æ¥çš„å¤ç”¨ï¼Œé€šè¿‡å»ºç«‹ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± ä»¥åŠä¸€å¥—è¿æ¥ä½¿ç”¨ã€åˆ†é…å’Œç®¡ç†ç­–ç•¥ï¼Œä½¿å¾—è¯¥è¿æ¥æ± ä¸­çš„è¿æ¥å¯ä»¥å¾—åˆ°é«˜æ•ˆï¼Œå®‰å…¨çš„å¤ç”¨ï¼Œé¿å…äº†æ•°æ®åº“è¿æ¥é¢‘ç¹å»ºç«‹å’Œå…³é—­çš„å¼€é”€ã€‚</p>
<p>è¿æ¥æ± çš„å·¥ä½œåŸç†ä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«ä¸ºè¿æ¥æ± çš„å»ºç«‹ï¼Œè¿æ¥æ± ä¸­è¿æ¥çš„ä½¿ç”¨ç®¡ç†ï¼Œè¿æ¥æ± çš„å…³é—­ã€‚</p>
<ol>
<li><p>è¿æ¥æ± çš„å»ºç«‹ã€‚ä¸€èˆ¬åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œè¿æ¥æ± ä¼šæ ¹æ®ç³»ç»Ÿé…ç½®å»ºç«‹ï¼Œå¹¶åœ¨æ± ä¸­å»ºç«‹å‡ ä¸ªè¿æ¥å¯¹è±¡ï¼Œä»¥ä¾¿ä½¿ç”¨æ—¶èƒ½ä»è¿æ¥æ± ä¸­è·å–ï¼Œè¿æ¥æ± ä¸­çš„è¿æ¥ä¸èƒ½éšæ„åˆ›å»ºå’Œå…³é—­ï¼Œè¿™æ ·é¿å…äº†è¿æ¥éšæ„å»ºç«‹å’Œå…³é—­é€ æˆçš„ç³»ç»Ÿå¼€é”€ã€‚</p>
</li>
<li><p>è¿æ¥æ± çš„ç®¡ç†ã€‚è¿æ¥æ± ç®¡ç†ç­–ç•¥æ˜¯è¿æ¥æ± æœºåˆ¶çš„æ ¸å¿ƒï¼Œè¿æ¥æ± å†…è¿æ¥çš„åˆ†é…å’Œé‡Šæ”¾å¯¹ç³»ç»Ÿçš„æ€§èƒ½æœ‰å¾ˆå¤§çš„å½±å“ã€‚å…¶ç­–ç•¥æ˜¯ï¼š</p>
<p>å½“å®¢æˆ·è¯·æ±‚æ•°æ®åº“è¿æ¥æ—¶ï¼Œé¦–å…ˆæŸ¥çœ‹è¿æ¥æ± ä¸­æ˜¯å¦æœ‰ç©ºé—²è¿æ¥ï¼Œå¦‚æœå­˜åœ¨ç©ºé—²è¿æ¥ï¼Œåˆ™å°†è¿æ¥åˆ†é…ç»™å®¢æˆ·ä½¿ç”¨ï¼›å¦‚æœæ²¡æœ‰æ§çº¿è¿æ¥ï¼Œåˆ™æŸ¥çœ‹å½“å‰æ‰€å¼€çš„è¿æ¥æ•°æ˜¯å¦å·²ç»è¾¾åˆ°æœ€å¤§è¿æ¥æ•°ï¼Œä¾‹å¦‚å¦‚æœæ²¡æœ‰è¾¾åˆ°å°±é‡æ–°åˆ›å»ºä¸€ä¸ªè¯·æ±‚çš„å®¢æˆ·ï¼›å¦‚æœè¾¾åˆ°ï¼Œå°±æŒ‰è®¾å®šçš„æœ€å¤§ç­‰å¾…æ—¶é—´è¿›è¡Œç­‰å¾…ï¼Œå¦‚æœè¶…å‡ºæœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ç»™å®¢æˆ·ã€‚</p>
</li>
<li><p>è¿æ¥æ± çš„å…³é—­ã€‚å½“åº”ç”¨ç¨‹åºé€€å‡ºæ—¶ï¼Œå…³é—­è¿æ¥æ± ä¸­æ‰€æœ‰çš„é“¾æ¥ï¼Œé‡Šæ”¾è¿æ¥æ± ç›¸å…³èµ„æºï¼Œè¯¥è¿‡ç¨‹æ­£å¥½ä¸åˆ›å»ºç›¸åã€‚</p>
</li>
</ol>
<a id="more"></a>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p><code>commons-pool</code>å®šä¹‰äº†ä¸€ä¸ªæ¥å£<code>PooledObject</code>æ¥å°è£…æ± ä¸­çš„å¯¹è±¡ï¼Œæ·»åŠ äº†ç©ºé—²æ—¶é—´ï¼Œä½¿ç”¨æ—¶é—´ç­‰ä¿¡æ¯å’Œå¯¹è±¡çŠ¶æ€æµè½¬çš„è¡Œä¸ºã€‚</p>
<h4 id="å¯¹è±¡æ± å®šä¹‰"><a href="#å¯¹è±¡æ± å®šä¹‰" class="headerlink" title="å¯¹è±¡æ± å®šä¹‰"></a>å¯¹è±¡æ± å®šä¹‰</h4><p>å¯¹è±¡æ± (è¿æ¥æ± )æ˜¯æˆ‘ä»¬ä¿å­˜å¯¹è±¡çš„åœ°æ–¹ï¼Œå¯¹è±¡çš„è·å–ï¼Œå½’è¿˜å’Œå®šæ—¶æ£€æŸ¥éƒ½é€šè¿‡å¯¹è±¡æ± æ¥å®ç°ã€‚ä»¥GenericObjectPoolä¸ºä¾‹ï¼Œä½¿ç”¨äº†çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»æ¥ä¿å­˜å¯¹è±¡ï¼ŒLinkedBlockingDequeç”¨äºä¿å­˜ç©ºé—²çš„å¯¹è±¡ï¼ŒConcurrentHashMapä¿å­˜å…¨éƒ¨å¯¹è±¡.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;T, PooledObject&lt;T&gt;&gt; allObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;T, PooledObject&lt;T&gt;&gt;();</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> LinkedBlockingDeque&lt;PooledObject&lt;T&gt;&gt; idleObjects = <span class="keyword">new</span> LinkedBlockingDeque&lt;PooledObject&lt;T&gt;&gt;();</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GenericObjectPool.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">GenericObjectPool</span><span class="params">(PooledObjectFactory&lt;T&gt; factory,</span></span></div><div class="line">            GenericObjectPoolConfig config) &#123;</div><div class="line"></div><div class="line">        ...other code...</div><div class="line"></div><div class="line">        setConfig(config);</div><div class="line"></div><div class="line">        <span class="comment">// **å¯åŠ¨è‡ªåŠ¨å›æ”¶ç©ºé—²è¿æ¥**</span></div><div class="line">        startEvictor(getTimeBetweenEvictionRunsMillis());</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="è·å–è¿æ¥-borrowObject"><a href="#è·å–è¿æ¥-borrowObject" class="headerlink" title="è·å–è¿æ¥:borrowObject"></a>è·å–è¿æ¥:<code>borrowObject</code></h4><p>è¿æ¥æ± å€Ÿå‡ºå¯¹è±¡æ—¶ï¼Œç»è¿‡<code>Abandoned</code>å’Œ<code>validate</code>ä¸¤ç§æ£€æŸ¥ï¼Œåœ¨è¿æ¥æ± æ»¡æ—¶æ ¹æ®é…ç½®æ‰§è¡Œå¯¹åº”çš„ç­‰å¾…ç­–ç•¥ï¼Œå½“æ²¡æœ‰å¯ç”¨å¯¹è±¡æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<ol>
<li><code>Abandoned</code>æ£€æŸ¥ç›®æ ‡æ˜¯è¿æ¥æ± æ‰€æœ‰è¢«å€Ÿå‡ºçš„å¯¹è±¡ï¼Œä¸»è¦é˜²æ­¢å¯¹è±¡å€Ÿå‡ºä¹‹åé•¿æ—¶é—´è¢«å ç”¨ï¼Œä¸èƒ½é€€è¿˜ï¼ˆæˆ–è€…ä½¿ç”¨è€…å¿˜è®°returnï¼‰åˆ°è¿æ¥æ± å¯¼è‡´è¿æ¥è¢«è€—å°½ã€‚</li>
<li><code>validate</code>æ£€æŸ¥ç›®æ ‡æ˜¯å½“å‰å³å°†è¢«å€Ÿå‡ºçš„å¯¹è±¡ï¼Œç›®çš„æ˜¯ä¿è¯æä¾›çš„å¯¹è±¡æ˜¯å¯ç”¨çš„ï¼Œæ£€æŸ¥æ–¹å¼ç”±å¯¹è±¡å·¥å‚çš„<code>validateObject</code>æ–¹æ³•å®šä¹‰ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">borrowObject</span><span class="params">(<span class="keyword">long</span> borrowMaxWaitMillis)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"><span class="comment">// getNumIdle() è¡¨ç¤ºå½“å‰ç©ºé—²å¯¹è±¡æ•°é‡ï¼ŒgetNumActive() è¡¨ç¤ºå½“å‰éç©ºé—²çš„å¯¹è±¡æ•°é‡ï¼ŒgetMaxTotal()è¡¨ç¤ºè¿æ¥æ± å®¹é‡</span></div><div class="line"><span class="comment">// é‚£ä¹ˆå‡è®¾æœ€å¤§å®¹é‡10ä¸ªï¼Œéç©ºé—²8ä¸ª &gt; 7 ï¼Œç©ºé—²å¯¹è±¡åªè¦å°‘äº2ä¸ªï¼Œå°±éœ€è¦å¼€å§‹Abandonedæ£€æŸ¥</span></div><div class="line">        AbandonedConfig ac = <span class="keyword">this</span>.abandonedConfig;</div><div class="line">        <span class="keyword">if</span> (ac != <span class="keyword">null</span> &amp;&amp; ac.getRemoveAbandonedOnBorrow() &amp;&amp;</div><div class="line">                (getNumIdle() &lt; <span class="number">2</span>) &amp;&amp;</div><div class="line">                (getNumActive() &gt; getMaxTotal() - <span class="number">3</span>) ) &#123;</div><div class="line">            removeAbandoned(ac);</div><div class="line">        &#125;</div><div class="line">        PooledObject&lt;T&gt; p = <span class="keyword">null</span>;</div><div class="line">        </div><div class="line">        <span class="comment">//blockWhenExhaustedå¯¹è±¡æ± è€—å°½æ—¶æ˜¯å¦ç­‰å¾…(é»˜è®¤ä¸ºtrue)</span></div><div class="line">        <span class="keyword">boolean</span> blockWhenExhausted = getBlockWhenExhausted();</div><div class="line">        <span class="keyword">boolean</span> create;</div><div class="line">        <span class="keyword">long</span> waitTime = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">            create = <span class="keyword">false</span>;</div><div class="line">            <span class="comment">// è®¾ç½®äº†å¯¹è±¡æ± è€—å°½(æ˜¯å¦è¾¾åˆ°æœ€å¤§æ´»è·ƒæ•°)æ—¶ç­‰å¾…</span></div><div class="line">            <span class="keyword">if</span> (blockWhenExhausted) &#123;</div><div class="line">                <span class="comment">//ä»ç©ºé—²é˜Ÿåˆ—å–å¯¹è±¡</span></div><div class="line">                p = idleObjects.pollFirst();</div><div class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">//æ²¡æœ‰ç©ºé—²å¯¹è±¡ æ–°å»ºä¸€ä¸ª</span></div><div class="line">                    create = <span class="keyword">true</span>;</div><div class="line">                    p = create();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (borrowMaxWaitMillis &lt; <span class="number">0</span>) &#123;</div><div class="line">                        <span class="comment">//æ³¨æ„ï¼šæ²¡é…ç½®ç­‰å¾…æ—¶é—´ï¼Œä¼šä¸€ç›´é˜»å¡</span></div><div class="line">                        p = idleObjects.takeFirst();</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="comment">//æŒ‰ç…§é…ç½®çš„æ—¶é—´ç­‰å¾…</span></div><div class="line">.....</div><div class="line">                        p = idleObjects.pollFirst(borrowMaxWaitMillis,</div><div class="line">                                TimeUnit.MILLISECONDS);</div><div class="line">.....</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                 <span class="comment">//ç­‰å¾…ä¹‹åè¿˜æ˜¯æ²¡æœ‰ç©ºé—²å¯¹è±¡</span></div><div class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException(</div><div class="line">                            <span class="string">"Timeout waiting for idle object"</span>);</div><div class="line">                &#125;</div><div class="line">                 <span class="comment">//ç­‰å¾…ä¹‹åè·å¾—å¯¹è±¡ å°è¯•åˆ†é…å¯¹è±¡</span></div><div class="line">                 <span class="comment">//è¿™ä¸ªæ–¹æ³•ç”±pooledobjectå®ç°</span></div><div class="line">                <span class="keyword">if</span> (!p.allocate()) &#123;</div><div class="line">                    p = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//æ²¡æœ‰é…ç½®blockWhenExhausted ä¸ç­‰å¾…</span></div><div class="line">                p = idleObjects.pollFirst();</div><div class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">                    create = <span class="keyword">true</span>;</div><div class="line">                    p = create();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException(<span class="string">"Pool exhausted"</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (!p.allocate()) &#123;</div><div class="line">                    p = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//å¯¹è±¡åˆ†é…æˆåŠŸ</span></div><div class="line">            <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">//æ¿€æ´»å¯¹è±¡</span></div><div class="line">                    factory.activateObject(p);</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        destroy(p);</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e1) &#123;</div><div class="line">                    &#125;</div><div class="line">                    p = <span class="keyword">null</span>;</div><div class="line">                    .....</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//å¦‚æœé…ç½®äº†å¯¹è±¡æ£€æŸ¥</span></div><div class="line">                <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; (getTestOnBorrow() || create &amp;&amp; getTestOnCreate())) &#123;</div><div class="line">                    <span class="keyword">boolean</span> validate = <span class="keyword">false</span>;</div><div class="line">                    Throwable validationThrowable = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        validate = factory.validateObject(p);</div><div class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                        PoolUtils.checkRethrow(t);</div><div class="line">                        validationThrowable = t;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (!validate) &#123;</div><div class="line">                    <span class="comment">//éªŒè¯å¤±è´¥ é”€æ¯å¯¹è±¡</span></div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            destroy(p);</div><div class="line">                         destroyedByBorrowValidationCount.incrementAndGet();</div><div class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        &#125;</div><div class="line">                        p = <span class="keyword">null</span>;</div><div class="line">                        .....</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//æ›´æ–°å€Ÿå‡ºæ—¶é—´ç­‰ä¿¡æ¯</span></div><div class="line">        updateStatsBorrow(p, waitTime);</div><div class="line">        <span class="keyword">return</span> p.getObject();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>1) å½“å®¢æˆ·è¯·æ±‚æ•°æ®åº“è¿æ¥æ—¶ï¼Œé¦–å…ˆæŸ¥çœ‹è¿æ¥æ± ä¸­æ˜¯å¦æœ‰ç©ºé—²è¿æ¥;</p>
<p>2) å¦‚æœå­˜åœ¨ç©ºé—²è¿æ¥ï¼Œåˆ™å°†è¿æ¥åˆ†é…ç»™å®¢æˆ·ä½¿ç”¨ï¼›å¦‚æœæ²¡æœ‰ç©ºé—²è¿æ¥ï¼Œåˆ™æŸ¥çœ‹å½“å‰æ‰€å¼€çš„è¿æ¥æ•°æ˜¯å¦å·²ç»è¾¾åˆ°æœ€å¤§è¿æ¥æ•°;</p>
<p>3) å¦‚æœæ²¡æœ‰è¾¾åˆ°å°±é‡æ–°åˆ›å»ºä¸€ä¸ªè¿æ¥ï¼›å¦‚æœè¾¾åˆ°æœ€å¤§è¿æ¥æ•°ï¼Œå°±æŒ‰è®¾å®šçš„æœ€å¤§ç­‰å¾…æ—¶é—´è¿›è¡Œç­‰å¾…ï¼Œå¦‚æœè¶…å‡ºæœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ç»™å®¢æˆ·ã€‚</p>
<h4 id="é‡Šæ”¾è¿æ¥-returnObject"><a href="#é‡Šæ”¾è¿æ¥-returnObject" class="headerlink" title="é‡Šæ”¾è¿æ¥:returnObject"></a>é‡Šæ”¾è¿æ¥:<code>returnObject</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GenericObjectPool.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnObject</span><span class="params">(T obj)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// ä»allObjectsä¸­è·å–è¦å½’è¿˜çš„è¿æ¥</span></div><div class="line">        PooledObject&lt;T&gt; p = allObjects.get(obj);</div><div class="line"></div><div class="line">        ...other code...</div><div class="line"></div><div class="line">        <span class="keyword">int</span> maxIdleSave = getMaxIdle();</div><div class="line">        <span class="comment">// å¦‚æœidleObjectsç©ºé—²é˜Ÿåˆ—ä¸­è¿æ¥æ•°å·²ç»&gt;=å…è®¸çš„æœ€å¤§ç©ºé—²è¿æ¥æ•°æˆ–è€…è¿æ¥æ± å·²ç»å…³é—­å°±ç›´æ¥é”€æ¯è¿™ä¸ªè¿æ¥</span></div><div class="line">        <span class="keyword">if</span> (isClosed() || maxIdleSave &gt; -<span class="number">1</span> &amp;&amp; maxIdleSave &lt;= idleObjects.size()) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">               <span class="comment">// é”€æ¯è¿æ¥</span></div><div class="line">                destroy(p);</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                swallowException(e);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123; </div><div class="line">          <span class="comment">// å°†è¿æ¥æ”¾å…¥åˆ°idleObjectsé˜Ÿåˆ—ä¸­, ä¸€æ—¦å°†è¿æ¥æ”¾å…¥åˆ°idleObjectsä¸­å¦‚æœè¿æ¥é•¿æ—¶é—´ä¸è¢«ä½¿ç”¨å°±ä¼šè¢«è‡ªåŠ¨å›æ”¶</span></div><div class="line">            <span class="keyword">if</span> (getLifo()) &#123; </div><div class="line">              <span class="comment">// é»˜è®¤æ˜¯ä½¿ç”¨last in first outæœºåˆ¶(åè¿›å…ˆå‡º)</span></div><div class="line">                idleObjects.addFirst(p);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                idleObjects.addLast(p);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        updateStatsReturn(activeTime);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>1) ä»<code>allObjects</code>ä¸­è·å–è¦å½’è¿˜çš„è¿æ¥</p>
<p>2) å¦‚æœ<code>idleObjects</code>ç©ºé—²é˜Ÿåˆ—ä¸­è¿æ¥æ•°å·²ç»&gt;=å…è®¸çš„æœ€å¤§ç©ºé—²è¿æ¥æ•°æˆ–è€…è¿æ¥æ± å·²ç»å…³é—­å°±ç›´æ¥é”€æ¯è¿™ä¸ªè¿æ¥</p>
<p>3) å¦åˆ™ï¼Œå°†è¿æ¥æ”¾å…¥åˆ°<code>idleObjects</code>é˜Ÿåˆ—ä¸­, ä¸€æ—¦å°†è¿æ¥æ”¾å…¥åˆ°<code>idleObjects</code>ä¸­å¦‚æœè¿æ¥é•¿æ—¶é—´ä¸è¢«ä½¿ç”¨å°±ä¼šè¢«è‡ªåŠ¨å›æ”¶(ç”±åå°é©±é€çº¿ç¨‹å›æ”¶ç©ºé—²è¿æ¥)</p>
<h4 id="é”€æ¯è¿æ¥"><a href="#é”€æ¯è¿æ¥" class="headerlink" title="é”€æ¯è¿æ¥"></a>é”€æ¯è¿æ¥</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">(PooledObject&lt;T&gt; toDestory)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        toDestory.invalidate();</div><div class="line">        idleObjects.remove(toDestory);</div><div class="line">        allObjects.remove(toDestory.getObject());</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            factory.destroyObject(toDestory);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            destroyedCount.incrementAndGet();</div><div class="line">            createCount.decrementAndGet();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="å›æ”¶ç©ºé—²è¿æ¥-evict"><a href="#å›æ”¶ç©ºé—²è¿æ¥-evict" class="headerlink" title="å›æ”¶ç©ºé—²è¿æ¥:evict"></a>å›æ”¶ç©ºé—²è¿æ¥:<code>evict</code></h4><h5 id="å¯åŠ¨é©±é€è€…çº¿ç¨‹"><a href="#å¯åŠ¨é©±é€è€…çº¿ç¨‹" class="headerlink" title="å¯åŠ¨é©±é€è€…çº¿ç¨‹"></a>å¯åŠ¨é©±é€è€…çº¿ç¨‹</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//GenericObjectPool.java</span></div><div class="line"><span class="comment">//æ„é€ æ–¹æ³•ä¸­å¯åŠ¨é©±é€è€…çº¿ç¨‹</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">GenericObjectPool</span><span class="params">(PooledObjectFactory&lt;T&gt; factory,</span></span></div><div class="line">            GenericObjectPoolConfig config) &#123;</div><div class="line">        ...</div><div class="line">        startEvictor(getTimeBetweenEvictionRunsMillis());</div><div class="line">        ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//çˆ¶ç±»BaseGenericObjectPool.java</span></div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startEvictor</span><span class="params">(<span class="keyword">long</span> delay)</span> </span>&#123;</div><div class="line">        <span class="comment">//evictionLockå¯¹è±¡é”</span></div><div class="line">        <span class="keyword">synchronized</span> (evictionLock) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != evictor) &#123;</div><div class="line">                <span class="comment">//å·²å­˜åœ¨evictorï¼Œå–æ¶ˆå½“å‰é©±é€è€…çº¿ç¨‹ï¼›é‡æ–°å¯åŠ¨å¦ä¸€ä¸ªé©±é€è€…çº¿ç¨‹</span></div><div class="line">                EvictionTimer.cancel(evictor);</div><div class="line">                evictor = <span class="keyword">null</span>;</div><div class="line">                evictionIterator = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (delay &gt; <span class="number">0</span>) &#123;</div><div class="line">                evictor = <span class="keyword">new</span> Evictor();</div><div class="line">                EvictionTimer.schedule(evictor, delay, delay);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>é©±é€è€…<code>Evictor</code>,åœ¨<code>BaseGenericObjectPool</code>ä¸­å®šä¹‰ï¼Œæœ¬è´¨æ˜¯ç”±<code>java.util.TimerTask</code>å®šä¹‰çš„å®šæ—¶ä»»åŠ¡.</p>
<h5 id="é©±é€è€…çº¿ç¨‹æ‰§è¡Œ"><a href="#é©±é€è€…çº¿ç¨‹æ‰§è¡Œ" class="headerlink" title="é©±é€è€…çº¿ç¨‹æ‰§è¡Œ"></a>é©±é€è€…çº¿ç¨‹æ‰§è¡Œ</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//BaseGenericObjectPoolå†…éƒ¨ç±»Evictor</span></div><div class="line"><span class="comment">//ä½œç”¨ï¼šé©±é€ç©ºé—²å¯¹è±¡</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Evictor</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</div><div class="line">    </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            ClassLoader savedClassLoader =</div><div class="line">                    Thread.currentThread().getContextClassLoader();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// åˆ‡æ¢åˆ°å½“å‰è¿æ¥æ± çš„classLoader</span></div><div class="line">                Thread.currentThread().setContextClassLoader(</div><div class="line">                        factoryClassLoader);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="comment">//æ‰§è¡Œevict()æ–¹æ³•</span></div><div class="line">                    evict();</div><div class="line">                &#125; <span class="keyword">catch</span>(Exception e) &#123;</div><div class="line">                    swallowException(e);</div><div class="line">                &#125; <span class="keyword">catch</span>(OutOfMemoryError oome) &#123;</div><div class="line">                    oome.printStackTrace(System.err);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// é©±é€ä¹‹åè¿˜è¦ä¿è¯ç©ºé—²è¿æ¥æ•°é‡ä¸èƒ½å°äºé…ç½®</span></div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    ensureMinIdle();</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    swallowException(e);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                <span class="comment">// åˆ‡æ¢å›ä¹‹å‰çš„classLoader</span></div><div class="line">                Thread.currentThread().setContextClassLoader(savedClassLoader);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>é©±é€è€…çº¿ç¨‹<code>Evictor</code>è¢«å¤šä¸ªè¿æ¥æ± å…±äº«,ä½†æ˜¯è¿™äº›è¿æ¥æ± å¯èƒ½å±äºä¸åŒçš„<code>classloader</code>,æ‰€ä»¥<code>Evictor</code>å¿…é¡»è¦ä¿è¯å®ƒçš„æ‰€æœ‰è¡Œä¸ºåœ¨<strong>å½“å‰è¿™ä¸ªè¿æ¥æ± çš„classloader</strong>ä¸‹æ‰§è¡Œ</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://throwsnew.com/2017/06/12/commons-pool/" target="_blank" rel="external">å¦‚ä½•è®¾è®¡ä¸€ä¸ªè¿æ¥æ± ï¼šcommons-pool2æºç åˆ†æ</a></p>
<p><a href="https://juejin.im/entry/592fec83a0bb9f0058a79876" target="_blank" rel="external">Jedis æºç é˜…è¯»ä¹‹è¿æ¥æ± </a></p>
<p><a href="http://www.cnblogs.com/newpanderking/p/3875749.html" target="_blank" rel="external">æ•°æ®åº“è¿æ¥æ± çš„å·¥ä½œåŸç†</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/21404377" target="_blank" rel="external">æ•°æ®æºè¿æ¥æ± çš„åŸç†åŠTomcatä¸­çš„åº”ç”¨</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Tomcatçº¿ç¨‹æ± ]]></title>
      <url>http://zsr.github.io/2017/09/15/Tomcat%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
      <content type="html"><![CDATA[<p>JDKåªæœ‰ä¸¤ç§å…¸å‹çš„çº¿ç¨‹æ± ï¼Œ<code>FixedPool</code> ä¸ <code>CachedPool</code>ï¼š</p>
<ul>
<li><code>FixedPool</code>ï¼šå›ºå®šçº¿ç¨‹æ•°ï¼Œå¿™ä¸è¿‡æ¥çš„å…¨æ”¾åˆ°æ— é™é•¿çš„ç¼“å†²é˜Ÿåˆ—é‡Œã€‚</li>
<li><code>CachedPool</code>ï¼šå¿™ä¸è¿‡æ¥æ—¶æ— é™çš„å¢åŠ ä¸´æ—¶çº¿ç¨‹ï¼Œé—²æ—¶å›è½ï¼Œæ²¡æœ‰ç¼“å†²é˜Ÿåˆ—ã€‚</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ScheduledExecutorServiceå®šæ—¶åŸç†]]></title>
      <url>http://zsr.github.io/2017/09/08/ScheduledExecutorService%E5%AE%9A%E6%97%B6%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<h3 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h3><p>JUC åŒ…ä¸­çš„ Executor æ¶æ„å¸¦æ¥äº†çº¿ç¨‹çš„åˆ›å»ºä¸æ‰§è¡Œçš„åˆ†ç¦»ã€‚<code>Executor</code> çš„ç»§æ‰¿è€… <code>ExecutorService</code> ä¸‹é¢è¡ç”Ÿå‡ºäº†ä¸¤ä¸ªé‡è¦çš„å®ç°ç±»ï¼Œä»–ä»¬åˆ†åˆ«æ˜¯</p>
<ul>
<li><code>ThreadPoolExecutor</code> çº¿ç¨‹æ± </li>
<li><code>ScheduledThreadPoolExecutor</code>ç»§æ‰¿äº†<code>ThreadPoolExecutor</code>, æ”¯æŒå‘¨æœŸæ€§ä»»åŠ¡çš„çº¿ç¨‹æ± </li>
</ul>
<p>é€šè¿‡ <code>ThreadPoolExecutor</code> å¯ä»¥å®ç°å„å¼å„æ ·çš„è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œè€Œ <code>ScheduledThreadPoolExecutor</code> ç±»åˆ™åœ¨è‡ªå®šä¹‰çº¿ç¨‹æ± çš„åŸºç¡€ä¸Šå¢åŠ äº†å‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡çš„åŠŸèƒ½ã€‚</p>
<p><img src="https://segmentfault.com/img/bVHU6v?w=437&amp;h=384" alt="img"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[AbstractQueuedSynchronizer]]></title>
      <url>http://zsr.github.io/2017/07/26/AbstractQueuedSynchronizer/</url>
      <content type="html"><![CDATA[<h3 id="AbstractQueuedSynchronizerä»‹ç»"><a href="#AbstractQueuedSynchronizerä»‹ç»" class="headerlink" title="AbstractQueuedSynchronizerä»‹ç»"></a><code>AbstractQueuedSynchronizer</code>ä»‹ç»</h3><p>JDK1.5ä¸­æä¾›çš„<code>java.util.concurrent</code>åŒ…ä¸­çš„å¤§å¤šæ•°çš„åŒæ­¥å™¨(<code>Synchronizer</code>)å¦‚<code>Lock</code>, <code>Semaphore</code>, <code>Latch</code>, <code>Barrier</code>ç­‰ï¼Œè¿™äº›ç±»ä¹‹é—´å¤§å¤šå¯ä»¥äº’ç›¸å®ç°ï¼Œå¦‚ä½¿ç”¨Lockå®ç°ä¸€ä¸ªSemaphoreæˆ–è€…åè¿‡æ¥ï¼Œä½†æ˜¯å®ƒä»¬éƒ½æ˜¯åŸºäº<code>java.util.concurrent.locks.AbstractQueuedSynchronizer</code>è¿™ä¸ªç±»çš„æ¡†æ¶å®ç°çš„</p>
<p><code>AbstractQueuedSynchronizer</code>ï¼Œé˜Ÿåˆ—åŒæ­¥å™¨ï¼Œç®€ç§°<code>AQS</code>ï¼Œå®ƒæ˜¯javaå¹¶å‘ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ã€‚</p>
<p>ä¸€èˆ¬ä½¿ç”¨<code>AQS</code>çš„ä¸»è¦æ–¹å¼æ˜¯ç»§æ‰¿ï¼Œå­ç±»é€šè¿‡å®ç°å®ƒæä¾›çš„æŠ½è±¡æ–¹æ³•æ¥ç®¡ç†åŒæ­¥çŠ¶æ€ï¼Œä¸»è¦ç®¡ç†çš„æ–¹å¼æ˜¯é€šè¿‡<code>tryAcquire</code>å’Œ<code>tryRelease</code>ç±»ä¼¼çš„æ–¹æ³•æ¥æ“ä½œçŠ¶æ€.</p>
<p>AQSæœ¬èº«æ˜¯æ²¡æœ‰å®ç°ä»»ä½•åŒæ­¥æ¥å£çš„ï¼Œå®ƒä»…ä»…åªæ˜¯å®šä¹‰äº†åŒæ­¥çŠ¶æ€çš„è·å–å’Œé‡Šæ”¾çš„æ–¹æ³•æ¥ä¾›è‡ªå®šä¹‰çš„åŒæ­¥ç»„ä»¶çš„ä½¿ç”¨ã€‚åœ¨javaçš„åŒæ­¥ç»„ä»¶ä¸­ï¼ŒAQSçš„å­ç±»ä¸€èˆ¬æ˜¯åŒæ­¥ç»„ä»¶çš„é™æ€å†…éƒ¨ç±»ã€‚åŒæ­¥ç»„ä»¶æ˜¯é¢å‘ä½¿ç”¨è€…çš„ï¼Œå®ƒå®šä¹‰äº†ä½¿ç”¨è€…ä¸ç»„ä»¶äº¤äº’çš„æ¥å£ï¼Œéšè—äº†å…·ä½“çš„å®ç°ç»†èŠ‚ï¼›è€ŒAQSé¢å‘çš„æ˜¯åŒæ­¥ç»„ä»¶çš„å®ç°è€…ï¼Œå®ƒç®€åŒ–äº†å…·ä½“çš„å®ç°æ–¹å¼ï¼Œå±è”½äº†çº¿ç¨‹åˆ‡æ¢ç›¸å…³åº•å±‚æ“ä½œ.</p>
<h3 id="AQSæºç åˆ†æ"><a href="#AQSæºç åˆ†æ" class="headerlink" title="AQSæºç åˆ†æ"></a><code>AQS</code>æºç åˆ†æ</h3><p>AQSçš„å®ç°ä¾èµ–å†…éƒ¨çš„åŒæ­¥é˜Ÿåˆ—ï¼ˆ<strong>FIFOåŒå‘é˜Ÿåˆ—</strong>ï¼‰æ¥å®ŒæˆåŒæ­¥çŠ¶æ€çš„ç®¡ç†ï¼Œå‡å¦‚å½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥ï¼ŒAQSä¼šå°†è¯¥çº¿ç¨‹ä»¥åŠç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æ„é€ æˆä¸€ä¸ª<code>Node</code>ï¼Œå¹¶å°†å…¶åŠ å…¥åŒæ­¥é˜Ÿåˆ—ï¼ŒåŒæ—¶é˜»å¡å½“å‰çº¿ç¨‹ã€‚å½“åŒæ­¥çŠ¶æ€é‡Šæ”¾æ—¶ï¼Œå”¤é†’é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹ã€‚</p>
<h4 id="Node"><a href="#Node" class="headerlink" title="Node"></a><code>Node</code></h4><p><code>Node</code>ä¸»è¦åŒ…å«ä»¥ä¸‹æˆå‘˜å˜é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</div><div class="line">        <span class="keyword">volatile</span> <span class="keyword">int</span> waitStatus;</div><div class="line">        <span class="keyword">volatile</span> Node prev;</div><div class="line">        <span class="keyword">volatile</span> Node next;</div><div class="line">        <span class="keyword">volatile</span> Thread thread;</div><div class="line">        Node nextWaiter;</div><div class="line">        ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>waitStatus</code>ï¼šèŠ‚ç‚¹çŠ¶æ€ï¼Œä¸»è¦æœ‰è¿™å‡ ç§çŠ¶æ€ï¼š<ol>
<li><code>CANCELLED</code>ï¼šå½“å‰çº¿ç¨‹ç­‰å¾…å·²ç»å–æ¶ˆï¼Œæ˜¯å”¯ä¸€ä¸€ä¸ªå¤§äº0çš„çŠ¶æ€ï¼›</li>
<li><code>SIGNAL</code>ï¼šå½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹éœ€è¦è¿è¡Œï¼›</li>
<li><code>CONDITION</code>ï¼šå½“å‰èŠ‚ç‚¹åœ¨ç­‰å¾…conditionï¼›</li>
<li><code>PROPAGATE</code>ï¼šå½“å‰åœºæ™¯ä¸‹åç»­çš„acquireSharedå¯ä»¥æ‰§è¡Œï¼›</li>
</ol>
</li>
<li><code>prev</code>ï¼šå‰é©±èŠ‚ç‚¹ï¼›</li>
<li><code>next</code>ï¼šåç»§èŠ‚ç‚¹ï¼›</li>
<li><code>thread</code>ï¼šè¿›å…¥é˜Ÿåˆ—çš„å½“å‰çº¿ç¨‹ï¼›</li>
<li><code>nextWaiter</code>ï¼šå­˜å‚¨conditioné˜Ÿåˆ—ä¸­çš„åç»§èŠ‚ç‚¹;</li>
</ul>
<p><code>Node</code>æ˜¯<code>sync</code>é˜Ÿåˆ—å’Œ<code>condition</code>é˜Ÿåˆ—æ„å»ºçš„åŸºç¡€ï¼ŒAQSæ‹¥æœ‰ä¸‰ä¸ªæˆå‘˜å˜é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Head of the wait queue, lazily initialized.  Except for</div><div class="line">    * initialization, it is modified only via method setHead.  Note:</div><div class="line">    * If head exists, its waitStatus is guaranteed not to be</div><div class="line">    * CANCELLED.</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node head;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Tail of the wait queue, lazily initialized.  Modified only via</div><div class="line">    * method enq to add new wait node.</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node tail;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * The synchronization state.</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> state;</div></pre></td></tr></table></figure>
<ul>
<li><code>åŒæ­¥é˜Ÿåˆ—æ’å…¥èŠ‚ç‚¹</code></li>
</ul>
<p>å½“çº¿ç¨‹åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­è¢«é˜»å¡ä¹‹åï¼Œè¿™ä¸ªçº¿ç¨‹ä¼šè¢«åŒ…è£…æˆä¸€ä¸ªNodeèŠ‚ç‚¹å¹¶è¢«æ·»åŠ åˆ°çº¿ç¨‹åŒæ­¥é˜Ÿåˆ—ä¹‹ä¸­ï¼ŒAQSæä¾›åŸºäºCASçš„è®¾ç½®å°¾èŠ‚ç‚¹çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSetTail</span><span class="params">(Node expect, Node update)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> unsafe.compareAndSwapObject(<span class="keyword">this</span>, tailOffset, expect, update);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å‡å¦‚ç°åœ¨æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è¢«é˜»å¡ï¼Œé‚£ä¹ˆå„ä¸ªçº¿ç¨‹æ‰€è·å–çš„å°¾èŠ‚ç‚¹å°±æœ‰å¯èƒ½ç›¸åŒï¼Œçº¿ç¨‹å°±ä¸èƒ½è¢«æ­£ç¡®åœ°æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­å»äº†ï¼Œä½¿ç”¨<code>compareAndSetTail(Node expect,Node update)</code>æ¥å¯¹åŠ å…¥åŒæ­¥é˜Ÿåˆ—çš„çº¿ç¨‹è¿›è¡Œå®‰å…¨åœ°æ’å…¥</p>
<p><img src="http://upload-images.jianshu.io/upload_images/5223907-4e4832f2be36aa4c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="img"></p>
<ul>
<li><p><code>èŠ‚ç‚¹åˆ é™¤</code><br>åŒæ­¥é˜Ÿåˆ—éµå¾ªFIFOï¼Œé¦–èŠ‚ç‚¹æ˜¯è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„èŠ‚ç‚¹ï¼Œé¦–èŠ‚ç‚¹çš„çº¿ç¨‹åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€ä¹‹åå°†ä¼šå”¤é†’åç»§èŠ‚ç‚¹ï¼Œåç»§èŠ‚ç‚¹å°†ä¼šåœ¨è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„æ—¶å€™å°†è‡ªå·±è®¾ç½®ä¸ºé¦–èŠ‚ç‚¹ã€‚</p>
<p>â€‹</p>
<p><img src="http://upload-images.jianshu.io/upload_images/5223907-a387fd4657047c14.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="img"></p>
<p>â€‹</p>
<p>è®¾ç½®é¦–èŠ‚ç‚¹æ˜¯ç”±è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„çº¿ç¨‹æ¥å®Œæˆï¼Œå› ä¸ºæ¯æ¬¡åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸæˆåŠŸçš„è·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œæ‰€ä»¥ï¼Œè®¾ç½®é¦–èŠ‚ç‚¹å¹¶ä¸éœ€è¦CASæ¥ä¿è¯ã€‚</p>
<p>â€‹</p>
</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[CyclicBarrier]]></title>
      <url>http://zsr.github.io/2017/07/26/CyclicBarrier/</url>
      <content type="html"><![CDATA[<p><code>CountDownLatch</code>å’Œ<code>CyclicBarrier</code>æ˜¯jdk concurrentåŒ…ä¸‹éå¸¸æœ‰ç”¨çš„ä¸¤ä¸ªå¹¶å‘å·¥å…·ç±»ï¼Œå®ƒä»¬æä¾›äº†ä¸€ç§æ§åˆ¶å¹¶å‘æµç¨‹çš„æ‰‹æ®µã€‚</p>
<h3 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h3><p><code>CyclicBarrier</code>ï¼Œè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªåŒæ­¥ç‚¹åå†ä¸€èµ·ç»§ç»­è¿è¡Œï¼Œå…¶ä¸­ä»»æ„ä¸€ä¸ªçº¿ç¨‹æœªè¾¾åˆ°åŒæ­¥ç‚¹ï¼Œå…¶ä»–åˆ°è¾¾çš„çº¿ç¨‹å‡ä¼šè¢«é˜»å¡ã€‚</p>
<ul>
<li><strong>CountDownLatch</strong> : ä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹ï¼Œç­‰å¾…å…¶ä»–å¤šä¸ªçº¿ç¨‹å®ŒæˆæŸä»¶äº‹æƒ…ä¹‹åæ‰èƒ½æ‰§è¡Œï¼›</li>
<li><strong>CyclicBarrier</strong>: å¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°åˆ°è¾¾åŒä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œå†ç»§ç»­ä¸€èµ·æ‰§è¡Œã€‚</li>
</ul>
<p>å¯¹äº<code>CountDownLatch</code>æ¥è¯´ï¼Œé‡ç‚¹æ˜¯â€œä¸€ä¸ªçº¿ç¨‹ï¼ˆå¤šä¸ªçº¿ç¨‹ï¼‰ç­‰å¾…â€ï¼Œè€Œå…¶ä»–çš„Nä¸ªçº¿ç¨‹åœ¨å®Œæˆâ€œæŸä»¶äº‹æƒ…â€ä¹‹åï¼Œå¯ä»¥ç»ˆæ­¢ï¼Œä¹Ÿå¯ä»¥ç­‰å¾…ã€‚è€Œå¯¹äºCyclicBarrierï¼Œé‡ç‚¹æ˜¯å¤šä¸ªçº¿ç¨‹ï¼Œåœ¨ä»»æ„ä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰å®Œæˆï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å¿…é¡»ç­‰å¾…ã€‚</p>
<p>CountDownLatchæ˜¯è®¡æ•°å™¨ï¼Œçº¿ç¨‹å®Œæˆä¸€ä¸ªè®°å½•ä¸€ä¸ªï¼Œåªä¸è¿‡è®¡æ•°ä¸æ˜¯é€’å¢è€Œæ˜¯é€’å‡ï¼Œè€ŒCyclicBarrieræ›´åƒæ˜¯ä¸€ä¸ªé˜€é—¨ï¼Œéœ€è¦æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾ï¼Œé˜€é—¨æ‰èƒ½æ‰“å¼€ï¼Œç„¶åç»§ç»­æ‰§è¡Œã€‚</p>
<h4 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h4><p>å‡è®¾æœ‰åªæœ‰çš„ä¸€ä¸ªåœºæ™¯ï¼šæ¯ä¸ªçº¿ç¨‹ä»£è¡¨ä¸€ä¸ªè·‘æ­¥è¿åŠ¨å‘˜ï¼Œå½“è¿åŠ¨å‘˜éƒ½å‡†å¤‡å¥½åï¼Œæ‰ä¸€èµ·å‡ºå‘ï¼Œåªè¦æœ‰ä¸€ä¸ªäººæ²¡æœ‰å‡†å¤‡å¥½ï¼Œå¤§å®¶éƒ½ç­‰å¾….</p>
<ul>
<li><code>Runner.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.cyclicBarrier;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.BrokenBarrierException;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.CyclicBarrier;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Runner</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> CyclicBarrier barrier;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Runner</span><span class="params">(CyclicBarrier barrier, String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>();</div><div class="line">    <span class="keyword">this</span>.barrier = barrier;</div><div class="line">    <span class="keyword">this</span>.name = name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      Thread.sleep(<span class="number">100</span>);</div><div class="line">      System.out.println(name + <span class="string">" å‡†å¤‡OK."</span>);</div><div class="line">      barrier.await();</div><div class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">    &#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">    System.out.println(name + <span class="string">" Go!!"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>CyclicBarrierTest.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.cyclicBarrier;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.CyclicBarrier;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTest</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">    CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">3</span>);</div><div class="line"></div><div class="line">    ExecutorService executor = Executors.newFixedThreadPool(<span class="number">3</span>);</div><div class="line">    executor.submit(<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runner(barrier, <span class="string">"zhangsan"</span>)));</div><div class="line">    executor.submit(<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runner(barrier, <span class="string">"lisi"</span>)));</div><div class="line">    executor.submit(<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runner(barrier, <span class="string">"wangwu"</span>)));</div><div class="line"></div><div class="line">    executor.shutdown();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="CyclicBarrieræºç åˆ†æ"><a href="#CyclicBarrieræºç åˆ†æ" class="headerlink" title="CyclicBarrieræºç åˆ†æ"></a><code>CyclicBarrier</code>æºç åˆ†æ</h4><ul>
<li>æ„é€ æ–¹æ³•</li>
</ul>
<p><code>CyclicBarrier</code>æä¾›ä¸¤ä¸ªæ„é€ æ–¹æ³•<code>CyclicBarrier(int parties)</code>å’Œ<code>CyclicBarrier(int parties, Runnable barrierAction)</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">CyclicBarrier</span><span class="params">(<span class="keyword">int</span> parties)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(parties, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é»˜è®¤æ„é€ æ–¹æ³•ï¼Œå‚æ•°è¡¨ç¤ºæ‹¦æˆªçš„çº¿ç¨‹æ•°é‡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">CyclicBarrier</span><span class="params">(<span class="keyword">int</span> parties, Runnable barrierAction)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (parties &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</div><div class="line">        <span class="keyword">this</span>.parties = parties;</div><div class="line">        <span class="keyword">this</span>.count = parties;</div><div class="line">        <span class="keyword">this</span>.barrierCommand = barrierAction;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”±äºçº¿ç¨‹ä¹‹å‰çš„è°ƒåº¦æ˜¯ç”±CPUå†³å®šçš„ï¼Œæ‰€ä»¥é»˜è®¤çš„æ„é€ æ–¹æ³•æ— æ³•è®¾ç½®çº¿ç¨‹æ‰§è¡Œä¼˜å…ˆçº§ï¼ŒCyclicBarrieræä¾›ä¸€ä¸ªæ›´é«˜çº§çš„æ„é€ å‡½æ•°<code>CyclicBarrier(int parties, Runnable barrierAction)</code>ï¼Œç”¨äºåœ¨çº¿ç¨‹åˆ°è¾¾åŒæ­¥ç‚¹æ—¶ï¼Œä¼˜å…ˆæ‰§è¡Œçº¿ç¨‹barrierActionï¼Œè¿™æ ·å¯ä»¥æ›´åŠ æ–¹ä¾¿çš„å¤„ç†ä¸€äº›è´Ÿè´£çš„ä¸šåŠ¡åœºæ™¯ã€‚</p>
<ul>
<li><code>await</code>æ–¹æ³•</li>
</ul>
<p>åˆ›å»º<code>CyclicBarrier</code>åï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨<code>await</code>æ–¹æ³•å‘Šè¯‰<code>CyclicBarrier</code>è‡ªå·±å·²ç»åˆ°è¾¾åŒæ­¥ç‚¹ï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹<code>await</code>æ–¹æ³•çš„å…·ä½“å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, BrokenBarrierException </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> dowait(<span class="keyword">false</span>, <span class="number">0L</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (TimeoutException toe) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(toe); <span class="comment">// cannot happen;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></div><div class="line">        <span class="keyword">throws</span> InterruptedException,</div><div class="line">               BrokenBarrierException,</div><div class="line">               TimeoutException &#123;</div><div class="line">        <span class="keyword">return</span> dowait(<span class="keyword">true</span>, unit.toNanos(timeout));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><code>CyclicBarrier</code>åŒæ ·æä¾›å¸¦è¶…æ—¶æ—¶é—´çš„awaitå’Œä¸å¸¦è¶…æ—¶æ—¶é—´çš„<code>await</code></p>
<ul>
<li><code>dowait</code>æ–¹æ³•</li>
</ul>
<ol>
<li>åœ¨<code>dowait</code>çš„å‰æ®µéƒ¨åˆ†ï¼Œä¸»è¦å®Œæˆäº†å½“æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾åŒæ­¥ç‚¹ï¼ˆbarrierï¼‰æ—¶ï¼Œå”¤é†’æ‰€æœ‰çš„ç­‰å¾…çº¿ç¨‹ï¼Œä¸€èµ·å¾€ä¸‹ç»§ç»­è¿è¡Œï¼Œå¯æ ¹æ®å‚æ•°<code>barrierAction</code>å†³å®šä¼˜å…ˆæ‰§è¡Œçš„çº¿ç¨‹ã€‚</li>
<li>åœ¨<code>dowait</code>çš„å®ç°ååŠéƒ¨åˆ†ï¼Œä¸»è¦å®ç°äº†çº¿ç¨‹æœªåˆ°è¾¾åŒæ­¥ç‚¹ï¼ˆbarrierï¼‰æ—¶ï¼Œçº¿ç¨‹è¿›å…¥<code>Condition</code>è‡ªæ—‹ç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…è¶…æ—¶æˆ–è€…æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾barrieræ—¶è¢«å”¤é†’ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">dowait</span><span class="params">(<span class="keyword">boolean</span> timed, <span class="keyword">long</span> nanos)</span></span></div><div class="line">        <span class="keyword">throws</span> InterruptedException, BrokenBarrierException,</div><div class="line">               TimeoutException &#123;</div><div class="line">        <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">final</span> Generation g = generation;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (g.broken)</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BrokenBarrierException();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (Thread.interrupted()) &#123;</div><div class="line">                breakBarrier();</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">           <span class="keyword">int</span> index = --count;</div><div class="line">           <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;  <span class="comment">// tripped</span></div><div class="line">               <span class="keyword">boolean</span> ranAction = <span class="keyword">false</span>;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="keyword">final</span> Runnable command = barrierCommand;</div><div class="line">                   <span class="keyword">if</span> (command != <span class="keyword">null</span>)</div><div class="line">                       command.run();</div><div class="line">                   ranAction = <span class="keyword">true</span>;</div><div class="line">                   nextGeneration();</div><div class="line">                   <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">               &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                   <span class="keyword">if</span> (!ranAction)</div><div class="line">                       breakBarrier();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">            <span class="comment">// loop until tripped, broken, interrupted, or timed out</span></div><div class="line">            <span class="keyword">for</span> (;;) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (!timed)</div><div class="line">                        trip.await();</div><div class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (nanos &gt; <span class="number">0L</span>)</div><div class="line">                        nanos = trip.awaitNanos(nanos);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</div><div class="line">                    <span class="keyword">if</span> (g == generation &amp;&amp; ! g.broken) &#123;</div><div class="line">                        breakBarrier();</div><div class="line">                        <span class="keyword">throw</span> ie;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="comment">// We're about to finish waiting even if we had not</span></div><div class="line">                        <span class="comment">// been interrupted, so this interrupt is deemed to</span></div><div class="line">                        <span class="comment">// "belong" to subsequent execution.</span></div><div class="line">                        Thread.currentThread().interrupt();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (g.broken)</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BrokenBarrierException();</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (g != generation)</div><div class="line">                    <span class="keyword">return</span> index;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0L</span>) &#123;</div><div class="line">                    breakBarrier();</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>åœ¨æ•´ä¸ªdowaitï¼š</p>
<ol>
<li>ä½¿ç”¨ReentrantLockä¿è¯æ¯ä¸€æ¬¡æ“ä½œçº¿ç¨‹å®‰å…¨ï¼›</li>
<li>çº¿ç¨‹ç­‰å¾…/å”¤é†’ä½¿ç”¨Locké…åˆConditionæ¥å®ç°ï¼›</li>
<li>çº¿ç¨‹è¢«å”¤é†’çš„æ¡ä»¶ï¼šç­‰å¾…è¶…æ—¶æˆ–è€…æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾barrierã€‚</li>
</ol>
</blockquote>
<h4 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h4><p><code>CyclicBarrier</code>å°±æ˜¯ä¸€ä¸ªæ …æ ï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾åå†æ‰§è¡Œç›¸å…³çš„æ“ä½œã€‚<code>CyclicBarrier</code>åœ¨é‡Šæ”¾ç­‰å¾…çº¿ç¨‹åå¯ä»¥é‡ç”¨ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[CountDownLatch]]></title>
      <url>http://zsr.github.io/2017/07/26/CountDownLatch/</url>
      <content type="html"><![CDATA[<p><code>CountDownLatch</code>å’Œ<code>CyclicBarrier</code>æ˜¯jdk concurrentåŒ…ä¸‹éå¸¸æœ‰ç”¨çš„ä¸¤ä¸ªå¹¶å‘å·¥å…·ç±»ï¼Œå®ƒä»¬æä¾›äº†ä¸€ç§æ§åˆ¶å¹¶å‘æµç¨‹çš„æ‰‹æ®µã€‚</p>
<h3 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h3><p><code>CountDownLatch</code>å…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆæ“ä½œã€‚</p>
<p><code>CountDownLatch</code>å¯ä»¥æŠŠå®ƒçœ‹ä½œä¸€ä¸ªè®¡æ•°å™¨ï¼Œåªä¸è¿‡è¿™ä¸ªè®¡æ•°å™¨çš„æ“ä½œæ˜¯åŸå­æ“ä½œï¼ŒåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å»æ“ä½œè¿™ä¸ªè®¡æ•°å™¨ï¼Œä¹Ÿå°±æ˜¯åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å»å‡è¿™ä¸ªè®¡æ•°å™¨é‡Œé¢çš„å€¼ã€‚</p>
<h4 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h4><p>æœ‰ä¸€ä¸ªä»»åŠ¡æƒ³è¦å¾€ä¸‹æ‰§è¡Œï¼Œä½†å¿…é¡»è¦ç­‰åˆ°å…¶ä»–çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åæ‰å¯ä»¥ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚å‡å¦‚æˆ‘ä»¬è¿™ä¸ªæƒ³è¦ç»§ç»­å¾€ä¸‹æ‰§è¡Œçš„ä»»åŠ¡è°ƒç”¨ä¸€ä¸ª<code>CountDownLatch</code>å¯¹è±¡çš„<code>await()</code>æ–¹æ³•ï¼Œå…¶ä»–çš„ä»»åŠ¡æ‰§è¡Œå®Œè‡ªå·±çš„ä»»åŠ¡åè°ƒç”¨åŒä¸€ä¸ª<code>CountDownLatch</code>å¯¹è±¡ä¸Šçš„<code>countDown()</code>æ–¹æ³•åˆ™è®¡æ•°å‡1ï¼Œè¿™ä¸ªè°ƒç”¨<code>await()</code>æ–¹æ³•çš„ä»»åŠ¡å°†ä¸€ç›´é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°è¿™ä¸ª<code>CountDownLatch</code>å¯¹è±¡çš„è®¡æ•°å€¼å‡åˆ°0ä¸ºæ­¢ã€‚</p>
<h4 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h4><p>æ¯”å¦‚ï¼šæœ‰2ä¸ªå·¥äººåœ¨ä¸ºè€æ¿å¹²æ´»ï¼Œå½“2ä¸ªå·¥äººæŠŠä¸€å¤©çš„æ´»éƒ½å¹²å®Œäº†çš„æ—¶å€™ï¼Œè€æ¿å°±æ¥æ£€æŸ¥æ‰€æœ‰å·¥äººæ‰€å¹²çš„æ´»ã€‚è®°ä½è¿™ä¸ªæ¡ä»¶ï¼šä¸‰ä¸ªå·¥äººå…ˆå…¨éƒ¨å¹²å®Œæ´»ï¼Œè€æ¿æ‰æ£€æŸ¥ã€‚æ‰€ä»¥åœ¨è¿™é‡Œè®¾è®¡ä¸¤ä¸ªç±»ï¼ŒWorkerä»£è¡¨å·¥äººï¼ŒBossä»£è¡¨è€æ¿ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>Worker.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.countDownLatch;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> CountDownLatch downLatch;</div><div class="line">  <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Worker</span><span class="params">(CountDownLatch downLatch, String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.downLatch = downLatch;</div><div class="line">    <span class="keyword">this</span>.name = name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.doWork();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      TimeUnit.SECONDS.sleep(<span class="number">10</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</div><div class="line">    &#125;</div><div class="line">    System.out.println(<span class="keyword">this</span>.name + <span class="string">"æ´»å¹²å®Œäº†!"</span>);</div><div class="line">    <span class="keyword">this</span>.downLatch.countDown();</div><div class="line"></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="keyword">this</span>.name + <span class="string">"æ­£åœ¨å¹²æ´»!"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>Boss.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.countDownLatch;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Boss</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> CountDownLatch downLatch;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Boss</span><span class="params">(CountDownLatch downLatch)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.downLatch = downLatch;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"è€æ¿æ­£åœ¨ç­‰æ‰€æœ‰çš„å·¥äººå¹²å®Œæ´»......"</span>);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">this</span>.downLatch.await();</div><div class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">    &#125;</div><div class="line">    System.out.println(<span class="string">"å·¥äººæ´»éƒ½å¹²å®Œäº†ï¼Œè€æ¿å¼€å§‹æ£€æŸ¥äº†ï¼"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>CountDownLatchTest.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.countDownLatch;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchTest</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    ExecutorService executor = Executors.newCachedThreadPool();</div><div class="line">    CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">2</span>);</div><div class="line"></div><div class="line">    Worker w1 = <span class="keyword">new</span> Worker(latch, <span class="string">"å¼ ä¸‰"</span>);</div><div class="line">    Worker w2 = <span class="keyword">new</span> Worker(latch, <span class="string">"æå››"</span>);</div><div class="line"></div><div class="line">    Boss boss = <span class="keyword">new</span> Boss(latch);</div><div class="line"></div><div class="line">    executor.execute(w2);</div><div class="line">    executor.execute(w1);</div><div class="line">    executor.execute(boss);</div><div class="line"></div><div class="line">    executor.shutdown();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="CountDownLatchæºç åˆ†æ"><a href="#CountDownLatchæºç åˆ†æ" class="headerlink" title="CountDownLatchæºç åˆ†æ"></a>CountDownLatchæºç åˆ†æ</h4><ul>
<li>è‡ªå®šä¹‰åŒæ­¥å™¨<code>Sync</code>å®ç°</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/**</span></div><div class="line">     * Synchronization control For CountDownLatch.</div><div class="line">     * Uses AQS state to represent count.</div><div class="line">     */</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4982264981922014374L</span>;</div><div class="line"></div><div class="line">        Sync(<span class="keyword">int</span> count) &#123;</div><div class="line">            setState(count);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> getState();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> (getState() == <span class="number">0</span>) ? <span class="number">1</span> : -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</div><div class="line">            <span class="comment">// Decrement count; signal when transition to zero</span></div><div class="line">            <span class="keyword">for</span> (;;) &#123;</div><div class="line">                <span class="keyword">int</span> c = getState();</div><div class="line">                <span class="keyword">if</span> (c == <span class="number">0</span>)</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">int</span> nextc = c-<span class="number">1</span>;</div><div class="line">                <span class="keyword">if</span> (compareAndSetState(c, nextc))</div><div class="line">                    <span class="keyword">return</span> nextc == <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ„é€ æ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">CountDownLatch</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (count &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"count &lt; 0"</span>);</div><div class="line">       <span class="keyword">this</span>.sync = <span class="keyword">new</span> Sync(count);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>ä»æ„é€ æ–¹æ³•çš„å…·ä½“å®ç°å¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡æ„é€ æ–¹æ³•ä¼ å…¥çš„intå‹å‚æ•°countå…¶å®å°±æ˜¯åŒæ­¥å™¨çš„çŠ¶æ€ã€‚</p>
<ul>
<li><code>countDown</code>æ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countDown</span><span class="params">()</span> </span>&#123;</div><div class="line">        sync.releaseShared(<span class="number">1</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æ•´ä¸ª<code>countDown</code>åªåšäº†ä¸€ä»¶äº‹æƒ…ï¼Œé‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼ŒåŒæ­¥çŠ¶æ€åœ¨è¿™é‡Œçš„å®é™…æ„ä¹‰ä¹Ÿå°±æ˜¯éœ€è¦ç­‰å¾…çš„å®Œæˆçš„ç‚¹çš„æ•°é‡ï¼Œåªè¦æ¯å®Œæˆä¸€ä¸ªç‚¹ï¼Œå°±è°ƒç”¨countDownæ–¹æ³•é‡Šæ”¾åŒæ­¥çŠ¶æ€ã€‚</p>
<ul>
<li><code>await</code>æ–¹æ³•</li>
</ul>
<p><code>CountDownLatch</code>æä¾›å¸¦è¶…æ—¶æ—¶é—´çš„<code>await</code>å’Œä¸å¸¦è¶…æ—¶æ—¶é—´çš„<code>await</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        sync.acquireSharedInterruptibly(<span class="number">1</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><code>await</code>çš„å®è´¨æ˜¯åœ¨è·å–åŒæ­¥çŠ¶æ€ï¼ŒåŒæ­¥çŠ¶æ€state == 0æˆç«‹ï¼Œå½“å‰ç­‰å¾…å®Œæˆçš„ç‚¹å‡å·²å®Œæˆï¼Œä¸»çº¿ç¨‹ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¦åˆ™ï¼Œä¸»çº¿ç¨‹è¿›å…¥ç­‰å¾…é˜Ÿåˆ—è‡ªæ—‹ç­‰å¾…ç›´åˆ°åŒæ­¥çŠ¶æ€é‡Šæ”¾åstate == 0ã€‚æœ‰äº›æ—¶å€™ä¸»çº¿ç¨‹æ˜¯ä¸èƒ½ä¸€ç›´è‡ªæ—‹ç­‰å¾…ï¼Œè¿™ä¸ªæ—¶å€™å¸¦è¶…æ—¶æ—¶é—´çš„awaitå°±æ´¾ä¸Šç”¨åœºäº†ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…Nä¸ªç‚¹éƒ½æœªå®Œæˆï¼Œè¿”å›falseï¼Œä¸»çº¿ç¨‹ä¸å†ç­‰å¾…ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</p>
<h4 id="CountDownLatchæ€»ç»“"><a href="#CountDownLatchæ€»ç»“" class="headerlink" title="CountDownLatchæ€»ç»“"></a>CountDownLatchæ€»ç»“</h4><p><code>CountDownLatch</code>å®è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª<code>AQS</code>è®¡æ•°å™¨ï¼Œé€šè¿‡<code>AQS</code>æ¥å®ç°çº¿ç¨‹çš„ç­‰å¾…ä¸å”¤é†’ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[redis åˆ†å¸ƒå¼é”]]></title>
      <url>http://zsr.github.io/2017/07/05/redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
      <content type="html"><![CDATA[<h3 id="åŸºäºrediså®ç°åˆ†å¸ƒå¼é”"><a href="#åŸºäºrediså®ç°åˆ†å¸ƒå¼é”" class="headerlink" title="åŸºäºrediså®ç°åˆ†å¸ƒå¼é”"></a>åŸºäºrediså®ç°åˆ†å¸ƒå¼é”</h3><p>åˆ†å¸ƒå¼é”éƒ½æ˜¯å€ŸåŠ©ç¬¬ä¸‰æ–¹æ¥ç®¡ç†é”ï¼Œä»¥è¾¾åˆ°å¤šåº”ç”¨ç›´æ¥å…±åŒäº«æœ‰ä¸€æŠŠé”ã€‚æ¯”è¾ƒå¸¸ç”¨ä¸”è½»é‡çº§çš„å°±æ˜¯åŸºäºrediså®ç°ã€‚</p>
<p>å®ç°åŸç†ï¼šRedisä¸ºå•è¿›ç¨‹å•çº¿ç¨‹æ¨¡å¼ï¼Œé‡‡ç”¨é˜Ÿåˆ—æ¨¡å¼å°†å¹¶å‘è®¿é—®å˜æˆä¸²è¡Œè®¿é—®ï¼Œä¸”å¤šå®¢æˆ·ç«¯å¯¹Redisçš„è¿æ¥å¹¶ä¸å­˜åœ¨ç«äº‰å…³ç³»ã€‚å…¶æ¬¡Redisæä¾›ä¸€äº›å‘½ä»¤SETNXï¼ŒGETSETï¼Œå¯ä»¥æ–¹ä¾¿å®ç°åˆ†å¸ƒå¼é”æœºåˆ¶ã€‚</p>
<p>SETNXå‘½ä»¤ï¼ˆSET if Not eXistsï¼‰ è¯­æ³•ï¼š SETNX key value åŠŸèƒ½ï¼š </p>
<ul>
<li>å½“ä¸”ä»…å½“ key ä¸å­˜åœ¨ï¼Œè¿”å›1ï¼Œåˆ™è¯¥å®¢æˆ·ç«¯è·å¾—é”ï¼ŒæŠŠkeyçš„é”®å€¼è®¾ç½®ä¸ºvalueè¡¨ç¤ºè¯¥é”®å·²è¢«é”å®šï¼Œè¯¥å®¢æˆ·ç«¯æœ€åå¯ä»¥é€šè¿‡DEL keyæ¥é‡Šæ”¾è¯¥é”(è·å–é”åå¿…é¡»è¦é‡Šæ”¾)ï¼›</li>
<li>è‹¥ç»™å®šçš„ key å·²ç»å­˜åœ¨ï¼Œè¿”å›0ï¼Œè¡¨æ˜è¯¥é”å·²è¢«å…¶ä»–å®¢æˆ·ç«¯å–å¾—ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥å…ˆè¿”å›æˆ–è¿›è¡Œé‡è¯•ç­‰å¯¹æ–¹å®Œæˆæˆ–ç­‰å¾…é”è¶…æ—¶ã€‚</li>
</ul>
<h4 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h4><p>å¦‚æœè·å–é”çš„å®¢æˆ·ç«¯ç«¯æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œè¿›ç¨‹è¢«killæ‰ï¼Œæˆ–è€…å› ä¸ºå…¶ä»–å¼‚å¸¸å´©æºƒï¼Œå¯¼è‡´æ— æ³•é‡Šæ”¾é”ï¼Œå°±ä¼šé€ æˆæ­»é”ã€‚æ‰€ä»¥ï¼Œéœ€è¦å¯¹åŠ é”è¦åšæ—¶æ•ˆæ€§æ£€æµ‹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨åŠ é”æ—¶ï¼ŒæŠŠå½“å‰æ—¶é—´æˆ³ä½œä¸ºvalueå­˜å…¥æ­¤é”ä¸­ï¼Œé€šè¿‡å½“å‰æ—¶é—´æˆ³å’ŒRedisä¸­çš„æ—¶é—´æˆ³è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šå·®å€¼ï¼Œè®¤ä¸ºé”å·²ç»æ—¶æ•ˆï¼Œé˜²æ­¢é”æ— é™æœŸçš„é”ä¸‹å»ï¼Œä½†æ˜¯ï¼Œåœ¨å¤§å¹¶å‘æƒ…å†µï¼Œå¦‚æœåŒæ—¶æ£€æµ‹é”å¤±æ•ˆï¼Œå¹¶ç®€å•ç²—æš´çš„åˆ é™¤æ­»é”ï¼Œå†é€šè¿‡SETNXä¸Šé”ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç«äº‰æ¡ä»¶çš„äº§ç”Ÿï¼Œå³å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è·å–é”ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">C1 è·å–é”ï¼Œå¹¶å´©æºƒã€‚C2å’ŒC3è°ƒç”¨SETNXä¸Šé”è¿”å›0åï¼Œè·å¾—foo.lock(key)çš„æ—¶é—´æˆ³ï¼Œé€šè¿‡æ¯”å¯¹æ—¶é—´æˆ³ï¼Œå‘ç°é”è¶…æ—¶ã€‚</div><div class="line">C2 å‘foo.lockå‘é€DELå‘½ä»¤ã€‚</div><div class="line">C2 å‘foo.lockå‘é€SETNXè·å–é”ã€‚</div><div class="line">C3 å‘foo.lockå‘é€DELå‘½ä»¤ï¼Œæ­¤æ—¶C3å‘é€DELæ—¶ï¼Œå…¶å®DELæ‰çš„æ˜¯C2çš„é”ã€‚</div><div class="line">C3 å‘foo.lockå‘é€SETNXè·å–é”ã€‚</div></pre></td></tr></table></figure>
<p>æ­¤æ—¶C2å’ŒC3éƒ½è·å–äº†é”ï¼Œäº§ç”Ÿç«äº‰æ¡ä»¶ï¼Œå¦‚æœåœ¨æ›´é«˜å¹¶å‘çš„æƒ…å†µï¼Œå¯èƒ½ä¼šæœ‰æ›´å¤šå®¢æˆ·ç«¯è·å–é”ã€‚æ‰€ä»¥ï¼ŒDELé”çš„æ“ä½œï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨åœ¨é”è¶…æ—¶çš„æƒ…å†µä¸‹ï¼Œå¹¸å¥½æœ‰GETSETæ–¹æ³•ï¼Œå‡è®¾ç°åœ¨æœ‰å¦å¤–ä¸€ä¸ªå®¢æˆ·ç«¯C4ï¼Œçœ‹çœ‹å¦‚ä½•ä½¿ç”¨GETSETæ–¹å¼ï¼Œé¿å…è¿™ç§æƒ…å†µäº§ç”Ÿã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">C4 å‘é€SETNX lock.foo æƒ³è¦è·å¾—é”ï¼Œç”±äºC1è¿˜æŒæœ‰é”ï¼Œæ‰€ä»¥Redisè¿”å›ç»™C4ä¸€ä¸ª0</div><div class="line">C4 å‘é€GET lock.foo ä»¥æ£€æŸ¥é”æ˜¯å¦è¶…æ—¶äº†ï¼Œå¦‚æœæ²¡è¶…æ—¶ï¼Œåˆ™ç­‰å¾…æˆ–é‡è¯•ã€‚åä¹‹ï¼Œå¦‚æœå·²è¶…æ—¶ï¼ŒC4é€šè¿‡ä¸‹é¢çš„æ“ä½œæ¥å°è¯•è·å¾—é”ï¼š</div><div class="line">	GETSET lock.foo &lt;current Unix time + lock timeout + 1&gt;</div><div class="line">é€šè¿‡GETSETï¼ŒC4æ‹¿åˆ°çš„æ—¶é—´æˆ³å¦‚æœä»ç„¶æ˜¯è¶…æ—¶çš„ï¼Œé‚£å°±è¯´æ˜ï¼ŒC4å¦‚æ„¿ä»¥å¿æ‹¿åˆ°é”äº†ã€‚</div><div class="line">å¦‚æœåœ¨C4ä¹‹å‰ï¼Œæœ‰ä¸ªå«C5çš„å®¢æˆ·ç«¯æ¯”C4å¿«ä¸€æ­¥æ‰§è¡Œäº†ä¸Šé¢çš„æ“ä½œï¼Œé‚£ä¹ˆC4æ‹¿åˆ°çš„æ—¶é—´æˆ³æ˜¯ä¸ªæœªè¶…æ—¶çš„å€¼ï¼Œè¿™æ—¶ï¼ŒC4æ²¡æœ‰å¦‚æœŸè·å¾—é”ï¼Œéœ€è¦å†æ¬¡ç­‰å¾…æˆ–é‡è¯•ã€‚æ³¨æ„ï¼šå°½ç®¡C4æ²¡æ‹¿åˆ°é”ï¼Œä½†å®ƒæ”¹å†™äº†C5è®¾ç½®çš„é”çš„è¶…æ—¶å€¼ï¼Œä¸è¿‡è¿™ä¸€ç‚¹éå¸¸å¾®å°çš„è¯¯å·®å¸¦æ¥çš„å½±å“å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼š</strong>ä¸ºäº†è®©åˆ†å¸ƒå¼é”çš„ç®—æ³•æ›´ç¨³é”®äº›ï¼ŒæŒæœ‰é”çš„å®¢æˆ·ç«¯åœ¨è§£é”ä¹‹å‰åº”è¯¥å†æ£€æŸ¥ä¸€æ¬¡è‡ªå·±çš„é”æ˜¯å¦å·²ç»è¶…æ—¶ï¼Œå†å»åšDELæ“ä½œï¼Œå› ä¸ºå¯èƒ½å®¢æˆ·ç«¯å› ä¸ºæŸä¸ªè€—æ—¶çš„æ“ä½œè€ŒæŒ‚èµ·ï¼Œæ“ä½œå®Œçš„æ—¶å€™é”å› ä¸ºè¶…æ—¶å·²ç»è¢«åˆ«äººè·å¾—ï¼Œè¿™æ—¶å°±ä¸å¿…è§£é”äº†ã€‚</p>
<h4 id="åˆ†å¸ƒå¼é”çš„é—®é¢˜"><a href="#åˆ†å¸ƒå¼é”çš„é—®é¢˜" class="headerlink" title="åˆ†å¸ƒå¼é”çš„é—®é¢˜"></a>åˆ†å¸ƒå¼é”çš„é—®é¢˜</h4><ol>
<li>å¿…è¦çš„è¶…æ—¶æœºåˆ¶ï¼šè·å–é”çš„å®¢æˆ·ç«¯ä¸€æ—¦å´©æºƒï¼Œä¸€å®šè¦æœ‰è¿‡æœŸæœºåˆ¶ï¼Œå¦åˆ™å…¶ä»–å®¢æˆ·ç«¯éƒ½é™æ— æ³•è·å–é”ï¼Œé€ æˆæ­»é”é—®é¢˜ã€‚</li>
<li>åˆ†å¸ƒå¼é”ï¼Œå¤šå®¢æˆ·ç«¯çš„æ—¶é—´æˆ³ä¸èƒ½ä¿è¯ä¸¥æ ¼æ„ä¹‰çš„ä¸€è‡´æ€§ï¼Œæ‰€ä»¥åœ¨æŸäº›ç‰¹å®šå› ç´ ä¸‹ï¼Œæœ‰å¯èƒ½å­˜åœ¨é”ä¸²çš„æƒ…å†µã€‚è¦é€‚åº¦çš„æœºåˆ¶ï¼Œå¯ä»¥æ‰¿å—å°æ¦‚ç‡çš„äº‹ä»¶äº§ç”Ÿã€‚</li>
<li>åªå¯¹å…³é”®å¤„ç†èŠ‚ç‚¹åŠ é”ï¼Œè‰¯å¥½çš„ä¹ æƒ¯æ˜¯ï¼ŒæŠŠç›¸å…³çš„èµ„æºå‡†å¤‡å¥½ï¼Œæ¯”å¦‚è¿æ¥æ•°æ®åº“åï¼Œè°ƒç”¨åŠ é”æœºåˆ¶è·å–é”ï¼Œç›´æ¥è¿›è¡Œæ“ä½œï¼Œç„¶åé‡Šæ”¾ï¼Œå°½é‡å‡å°‘æŒæœ‰é”çš„æ—¶é—´ã€‚</li>
<li>åœ¨æŒæœ‰é”æœŸé—´è¦ä¸è¦CHECKé”ï¼Œå¦‚æœéœ€è¦ä¸¥æ ¼ä¾èµ–é”çš„çŠ¶æ€ï¼Œæœ€å¥½åœ¨å…³é”®æ­¥éª¤ä¸­åšé”çš„CHECKæ£€æŸ¥æœºåˆ¶ï¼Œä½†æ˜¯æ ¹æ®æˆ‘ä»¬çš„æµ‹è¯•å‘ç°ï¼Œåœ¨å¤§å¹¶å‘æ—¶ï¼Œæ¯ä¸€æ¬¡CHECKé”æ“ä½œï¼Œéƒ½è¦æ¶ˆè€—æ‰å‡ ä¸ªæ¯«ç§’ï¼Œè€Œæˆ‘ä»¬çš„æ•´ä¸ªæŒé”å¤„ç†é€»è¾‘æ‰ä¸åˆ°10æ¯«ç§’ï¼Œç©å®¢æ²¡æœ‰é€‰æ‹©åšé”çš„æ£€æŸ¥ã€‚</li>
<li>ä¸ºäº†å‡å°‘å¯¹Redisçš„å‹åŠ›ï¼Œè·å–é”å°è¯•æ—¶ï¼Œå¾ªç¯ä¹‹é—´ä¸€å®šè¦åšsleepæ“ä½œã€‚ä½†æ˜¯sleepæ—¶é—´æ˜¯å¤šå°‘æ˜¯é—¨å­¦é—®ã€‚éœ€è¦æ ¹æ®è‡ªå·±çš„Redisçš„QPSï¼ŒåŠ ä¸ŠæŒé”å¤„ç†æ—¶é—´ç­‰è¿›è¡Œåˆç†è®¡ç®—ã€‚</li>
</ol>
<h3 id="å®ç°åŸºäºredisçš„é”"><a href="#å®ç°åŸºäºredisçš„é”" class="headerlink" title="å®ç°åŸºäºredisçš„é”"></a>å®ç°åŸºäºredisçš„é”</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.redislock;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"><span class="keyword">import</span> org.springframework.dao.DataAccessException;</div><div class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnection;</div><div class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisCallback;</div><div class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</div><div class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * å®ç°åˆ†å¸ƒå¼é”</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisLock</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(RedisLock.class);</div><div class="line"></div><div class="line">  <span class="keyword">private</span> RedisTemplate redisTemplate;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_ACQUIRY_RESOLUTION_MILLIS = <span class="number">100</span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Lock key path.</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> String lockKey;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * é”è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢çº¿ç¨‹åœ¨å…¥é”ä»¥åï¼Œæ— é™çš„æ‰§è¡Œç­‰å¾…</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> expireMsecs = <span class="number">1000</span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * é”ç­‰å¾…æ—¶é—´ï¼Œé˜²æ­¢çº¿ç¨‹é¥¥é¥¿</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> timeoutMsecs = <span class="number">1000</span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * é”åˆ°æœŸæ—¶é—´</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> String expiresStr = <span class="string">""</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> locked = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Detailed constructor with default acquire timeout 10000 msecs and lock expiration of 60000</div><div class="line">   * msecs.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> lockKey lock key (ex. account:1, ...)</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">RedisLock</span><span class="params">(String lockKey)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.lockKey = <span class="string">"LOCK_"</span> + lockKey;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Detailed constructor with default lock expiration of 60000 msecs.</div><div class="line">   *</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">RedisLock</span><span class="params">(String lockKey, <span class="keyword">int</span> timeoutMsecs)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(lockKey);</div><div class="line">    <span class="keyword">this</span>.timeoutMsecs = timeoutMsecs;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Detailed constructor.</div><div class="line">   *</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">RedisLock</span><span class="params">(String lockKey, <span class="keyword">int</span> timeoutMsecs, <span class="keyword">int</span> expireMsecs)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(lockKey, timeoutMsecs);</div><div class="line">    <span class="keyword">this</span>.expireMsecs = expireMsecs;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * <span class="doctag">@return</span> lock key</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getLockKey</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> lockKey;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">get</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</div><div class="line">    Object obj = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      obj = redisTemplate.execute(<span class="keyword">new</span> RedisCallback&lt;Object&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">doInRedis</span><span class="params">(RedisConnection connection)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</div><div class="line">          StringRedisSerializer serializer = <span class="keyword">new</span> StringRedisSerializer();</div><div class="line">          <span class="keyword">byte</span>[] data = connection.get(serializer.serialize(key));</div><div class="line">          connection.close();</div><div class="line">          <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">return</span> serializer.deserialize(data);</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      logger.error(<span class="string">"get redis error, key : &#123;&#125;"</span>, key);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> obj != <span class="keyword">null</span> ? obj.toString() : <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setNX</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">    Object obj = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      obj = redisTemplate.execute(<span class="keyword">new</span> RedisCallback&lt;Object&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">doInRedis</span><span class="params">(RedisConnection connection)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</div><div class="line">          StringRedisSerializer serializer = <span class="keyword">new</span> StringRedisSerializer();</div><div class="line">          Boolean success = connection.setNX(serializer.serialize(key), serializer.serialize(value));</div><div class="line">          connection.close();</div><div class="line">          <span class="keyword">return</span> success;</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      logger.error(<span class="string">"setNX redis error, key : &#123;&#125;"</span>, key);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> obj != <span class="keyword">null</span> ? (Boolean) obj : <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">getSet</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">    Object obj = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      obj = redisTemplate.execute(<span class="keyword">new</span> RedisCallback&lt;Object&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">doInRedis</span><span class="params">(RedisConnection connection)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</div><div class="line">          StringRedisSerializer serializer = <span class="keyword">new</span> StringRedisSerializer();</div><div class="line">          <span class="keyword">byte</span>[] ret = connection.getSet(serializer.serialize(key), serializer.serialize(value));</div><div class="line">          connection.close();</div><div class="line">          <span class="keyword">return</span> serializer.deserialize(ret);</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      logger.error(<span class="string">"setNX redis error, key : &#123;&#125;"</span>, key);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> obj != <span class="keyword">null</span> ? (String) obj : <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * ä¸»è¦æ˜¯ä½¿ç”¨äº†redis çš„setnxå‘½ä»¤,ç¼“å­˜äº†é”. reidsç¼“å­˜çš„keyæ˜¯é”çš„key,æ‰€æœ‰çš„å…±äº«,</div><div class="line">   * valueæ˜¯é”çš„åˆ°æœŸæ—¶é—´(æ³¨æ„:è¿™é‡ŒæŠŠè¿‡æœŸæ—¶é—´æ”¾åœ¨valueäº†,æ²¡æœ‰æ—¶é—´ä¸Šè®¾ç½®å…¶è¶…æ—¶æ—¶é—´)</div><div class="line">   * &lt;p&gt;</div><div class="line">   * æ‰§è¡Œè¿‡ç¨‹:</div><div class="line">   * &lt;p&gt;</div><div class="line">   * 1.é€šè¿‡setnxå°è¯•è®¾ç½®æŸä¸ªkeyçš„å€¼,æˆåŠŸ(å½“å‰æ²¡æœ‰è¿™ä¸ªé”)åˆ™è¿”å›,æˆåŠŸè·å¾—é”</div><div class="line">   * &lt;p&gt;</div><div class="line">   * 2.é”å·²ç»å­˜åœ¨åˆ™è·å–é”çš„åˆ°æœŸæ—¶é—´,å’Œå½“å‰æ—¶é—´æ¯”è¾ƒ,è¶…æ—¶çš„è¯,åˆ™è®¾ç½®æ–°çš„å€¼</div><div class="line">   *</div><div class="line">   * <span class="doctag">@return</span> true if lock is acquired, false acquire timeouted</div><div class="line">   * <span class="doctag">@throws</span> InterruptedException in case of thread interruption</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    <span class="keyword">int</span> timeout = timeoutMsecs;</div><div class="line">    <span class="keyword">while</span> (timeout &gt;= <span class="number">0</span>) &#123;</div><div class="line">      <span class="comment">// é”åˆ°æœŸæ—¶é—´</span></div><div class="line">      expiresStr = String.valueOf(System.currentTimeMillis() + expireMsecs + <span class="number">1</span>);</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.setNX(lockKey, expiresStr)) &#123;</div><div class="line">        <span class="comment">// lock acquired</span></div><div class="line">        locked = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      String currentValueStr = <span class="keyword">this</span>.get(lockKey); <span class="comment">// redisé‡Œçš„æ—¶é—´</span></div><div class="line">      <span class="keyword">if</span> (currentValueStr != <span class="keyword">null</span> &amp;&amp; Long.parseLong(currentValueStr) &lt; System.currentTimeMillis()) &#123;</div><div class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œå¦‚æœè¢«å…¶ä»–çº¿ç¨‹è®¾ç½®äº†å€¼ï¼Œåˆ™ç¬¬äºŒä¸ªæ¡ä»¶åˆ¤æ–­æ˜¯è¿‡ä¸å»çš„</span></div><div class="line">        <span class="comment">// lock is expired</span></div><div class="line"></div><div class="line">        String oldValueStr = <span class="keyword">this</span>.getSet(lockKey, expiresStr);</div><div class="line">        <span class="comment">// è·å–ä¸Šä¸€ä¸ªé”åˆ°æœŸæ—¶é—´ï¼Œå¹¶è®¾ç½®ç°åœ¨çš„é”åˆ°æœŸæ—¶é—´ï¼Œ</span></div><div class="line">        <span class="comment">// åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰èƒ½è·å–ä¸Šä¸€ä¸ªçº¿ä¸Šçš„è®¾ç½®æ—¶é—´ï¼Œå› ä¸ºjedis.getSetæ˜¯åŒæ­¥çš„</span></div><div class="line">        <span class="keyword">if</span> (oldValueStr != <span class="keyword">null</span> &amp;&amp; oldValueStr.equals(currentValueStr)) &#123;</div><div class="line">          <span class="comment">// é˜²æ­¢è¯¯åˆ ï¼ˆè¦†ç›–ï¼Œå› ä¸ºkeyæ˜¯ç›¸åŒçš„ï¼‰äº†ä»–äººçš„é”â€”â€”è¿™é‡Œè¾¾ä¸åˆ°æ•ˆæœï¼Œè¿™é‡Œå€¼ä¼šè¢«è¦†ç›–ï¼Œä½†æ˜¯å› ä¸ºä»€ä¹ˆç›¸å·®äº†å¾ˆå°‘çš„æ—¶é—´ï¼Œæ‰€ä»¥å¯ä»¥æ¥å—</span></div><div class="line"></div><div class="line">          <span class="comment">// [åˆ†å¸ƒå¼çš„æƒ…å†µä¸‹]:å¦‚è¿‡è¿™ä¸ªæ—¶å€™ï¼Œå¤šä¸ªçº¿ç¨‹æ°å¥½éƒ½åˆ°äº†è¿™é‡Œï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„è®¾ç½®å€¼å’Œå½“å‰å€¼ç›¸åŒï¼Œä»–æ‰æœ‰æƒåˆ©è·å–é”</span></div><div class="line">          <span class="comment">// lock acquired</span></div><div class="line">          locked = <span class="keyword">true</span>;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      timeout -= DEFAULT_ACQUIRY_RESOLUTION_MILLIS;</div><div class="line"></div><div class="line">      <span class="comment">/*</span></div><div class="line">       * å»¶è¿Ÿ100 æ¯«ç§’, è¿™é‡Œä½¿ç”¨éšæœºæ—¶é—´å¯èƒ½ä¼šå¥½ä¸€ç‚¹,å¯ä»¥é˜²æ­¢é¥¥é¥¿è¿›ç¨‹çš„å‡ºç°,å³,å½“åŒæ—¶åˆ°è¾¾å¤šä¸ªè¿›ç¨‹,</div><div class="line">       * åªä¼šæœ‰ä¸€ä¸ªè¿›ç¨‹è·å¾—é”,å…¶ä»–çš„éƒ½ç”¨åŒæ ·çš„é¢‘ç‡è¿›è¡Œå°è¯•,åé¢æœ‰æ¥äº†ä¸€äº›è¿›è¡Œ,ä¹Ÿä»¥åŒæ ·çš„é¢‘ç‡ç”³è¯·é”,è¿™å°†å¯èƒ½å¯¼è‡´å‰é¢æ¥çš„é”å¾—ä¸åˆ°æ»¡è¶³. ä½¿ç”¨éšæœºçš„ç­‰å¾…æ—¶é—´å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šä¿è¯å…¬å¹³æ€§</div><div class="line">       */</div><div class="line">      Thread.sleep(DEFAULT_ACQUIRY_RESOLUTION_MILLIS);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Acqurired lock release.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (locked) &#123;</div><div class="line">      <span class="keyword">if</span> (expiresStr != <span class="keyword">null</span> &amp;&amp; expiresStr.equals(redisTemplate.opsForValue().get(lockKey))) &#123;</div><div class="line">        redisTemplate.delete(lockKey);</div><div class="line">        locked = <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * æµ‹è¯•</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> String key = <span class="string">"lockKey"</span>;</div><div class="line">    <span class="keyword">final</span> RedisLock lock = <span class="keyword">new</span> RedisLock(key, <span class="number">1000</span>, <span class="number">2000</span>);</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">      <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (lock.lock()) &#123;</div><div class="line">              System.out.println(<span class="string">"Thread: "</span> + Thread.currentThread().getName() + <span class="string">"running"</span>);</div><div class="line">            &#125;</div><div class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">          &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">          &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">      &#125;, <span class="string">""</span> + i).start();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…·ä½“spring integrationä¸­å·²ç»å®ç°è¿™æ ·çš„åŠŸèƒ½äº†ã€‚å…·ä½“å®ç°æºç <a href="https://github.com/spring-projects/spring-integration/blob/master/spring-integration-redis/src/main/java/org/springframework/integration/redis/util/RedisLockRegistry.java" target="_blank" rel="external">é“¾æ¥</a>ï¼Œå…·ä½“æºç åˆ†æå¯ä»¥æŸ¥çœ‹<a href="https://wangkang007.gitbooks.io/java/redislockregistry.html" target="_blank" rel="external">gitbooké“¾æ¥</a></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://0opslab.com/2017/02/13/%E5%9F%BA%E4%BA%8ERedis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" target="_blank" rel="external">åŸºäºrediså®ç°åˆ†å¸ƒå¼é”</a></p>
<p><a href="https://github.com/spring-projects/spring-integration/blob/master/spring-integration-redis/src/main/java/org/springframework/integration/redis/util/RedisLockRegistry.java" target="_blank" rel="external">RedisLockRegistry</a></p>
<p><a href="https://wangkang007.gitbooks.io/java/redislockregistry.html" target="_blank" rel="external">RedisLockRegistryæºç åˆ†æ</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[redis zsetå†…éƒ¨å®ç°]]></title>
      <url>http://zsr.github.io/2017/07/03/redis-zset%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0/</url>
      <content type="html"><![CDATA[<h3 id="Rediså¯¹è±¡"><a href="#Rediså¯¹è±¡" class="headerlink" title="Rediså¯¹è±¡"></a>Rediså¯¹è±¡</h3><p>Rediså¯¹è±¡ç”±<code>redisObject</code>ç»“æ„ä½“è¡¨ç¤ºã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> redisObject &#123;</div><div class="line">    <span class="keyword">unsigned</span> type:<span class="number">4</span>;            <span class="comment">// å¯¹è±¡çš„ç±»å‹ï¼ŒåŒ…æ‹¬ /* Object types */</span></div><div class="line">    <span class="keyword">unsigned</span> encoding:<span class="number">4</span>;        <span class="comment">// åº•éƒ¨ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œä¸€ç§typeçš„æ•°æ®ï¼Œå¯ä»¥é‡‡ç”¨ä¸åŒçš„å­˜å‚¨æ–¹å¼</span></div><div class="line">    <span class="keyword">unsigned</span> lru:REDIS_LRU_BITS; <span class="comment">/* lru time (relative to server.lruclock) */</span></div><div class="line">    <span class="keyword">int</span> refcount;         <span class="comment">// å¼•ç”¨è®¡æ•°</span></div><div class="line">    <span class="keyword">void</span> *ptr;</div><div class="line">&#125; robj;</div></pre></td></tr></table></figure>
<ul>
<li>Redisä¸­çš„æ¯ä¸ªé”®å€¼å¯¹çš„é”®å’Œå€¼éƒ½æ˜¯ä¸€ä¸ªredisObjectã€‚</li>
<li>å…±æœ‰äº”ç§ç±»å‹çš„å¯¹è±¡ï¼šå­—ç¬¦ä¸²ï¼ˆStringï¼‰ã€åˆ—è¡¨ï¼ˆListï¼‰ã€å“ˆå¸Œï¼ˆHashï¼‰ã€é›†åˆï¼ˆSetï¼‰ã€æœ‰åºé›†åˆï¼ˆSortedSetï¼‰ï¼Œæºç <code>server.h</code>å¦‚ä¸‹å®šä¹‰ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/* The actual Redis Object */</div><div class="line">#define OBJ_STRING 0</div><div class="line">#define OBJ_LIST 1 </div><div class="line">#define OBJ_SET 2</div><div class="line">#define OBJ_ZSET 3</div><div class="line">#define OBJ_HASH 4</div></pre></td></tr></table></figure>
<ul>
<li>æ¯ç§ç±»å‹çš„å¯¹è±¡è‡³å°‘éƒ½æœ‰ä¸¤ç§æˆ–ä»¥ä¸Šçš„ç¼–ç æ–¹å¼ï¼›å¯ä»¥åœ¨ä¸åŒçš„ä½¿ç”¨åœºæ™¯ä¸Šä¼˜åŒ–å¯¹è±¡çš„ä½¿ç”¨åœºæ™¯ã€‚ç”¨<code>TYPE</code>å‘½ä»¤å¯æŸ¥çœ‹æŸä¸ªé”®å€¼å¯¹çš„ç±»å‹</li>
</ul>
<h3 id="å¯¹è±¡ç¼–ç "><a href="#å¯¹è±¡ç¼–ç " class="headerlink" title="å¯¹è±¡ç¼–ç "></a>å¯¹è±¡ç¼–ç </h3><p>Redisç›®å‰ä½¿ç”¨çš„ç¼–ç æ–¹å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">/* Objects encoding. Some kind of objects like Strings and Hashes can be</div><div class="line"> * internally represented in multiple ways. The &apos;encoding&apos; field of the object</div><div class="line"> * is set to one of this fields for this object. </div><div class="line"> */</div><div class="line">#define OBJ_ENCODING_RAW     /* Raw representation */ ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</div><div class="line">#define OBJ_ENCODING_INT      /* Encoded as integer */ æ•´æ•°</div><div class="line">#define OBJ_ENCODING_HT       /* Encoded as hash table */ å­—å…¸</div><div class="line">#define OBJ_ENCODING_ZIPLIST  /* Encoded as ziplist */ å‹ç¼©åˆ—è¡¨</div><div class="line">#define OBJ_ENCODING_INTSET   /* Encoded as intset */ æ•´æ•°é›†åˆ</div><div class="line">#define OBJ_ENCODING_SKIPLIST   /* Encoded as skiplist */ è·³è·ƒè¡¨</div><div class="line">#define OBJ_ENCODING_EMBSTR  /* Embedded sds string encoding */ embstrç¼–ç çš„ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</div><div class="line">#define OBJ_ENCODING_QUICKLIST  /* Encoded as linked list of ziplists */</div></pre></td></tr></table></figure>
<p>æœ¬è´¨ä¸Šï¼ŒRediså°±æ˜¯åŸºäºè¿™äº›æ•°æ®ç»“æ„è€Œæ„é€ å‡ºä¸€ä¸ªå¯¹è±¡å­˜å‚¨ç³»ç»Ÿã€‚redisObjectç»“æ„ä½“æœ‰ä¸ªptræŒ‡é’ˆï¼ŒæŒ‡å‘å¯¹è±¡çš„åº•å±‚å®ç°æ•°æ®ç»“æ„ï¼Œencodingå±æ€§è®°å½•å¯¹è±¡æ‰€ä½¿ç”¨çš„ç¼–ç ï¼Œå³è¯¥å¯¹è±¡ä½¿ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„ä½œä¸ºåº•å±‚å®ç°ã€‚</p>
<h3 id="zsetä»‹ç»"><a href="#zsetä»‹ç»" class="headerlink" title="zsetä»‹ç»"></a>zsetä»‹ç»</h3><p>æœ‰åºé›†åˆå¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯<code>ziplist</code>æˆ–è€…<code>skiplist</code>ã€‚åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ä½¿ç”¨ziplistç¼–ç ï¼š</p>
<ul>
<li>å…ƒç´ æ•°é‡å°äº128ä¸ª</li>
<li>æ‰€æœ‰memberçš„é•¿åº¦éƒ½å°äº64å­—èŠ‚</li>
</ul>
<p>ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼å¯é€šè¿‡zset-max-ziplist-entrieså’Œzset-max-ziplist-valueæ¥ä¿®æ”¹ã€‚</p>
<p><code>ziplist</code>ç¼–ç çš„æœ‰åºé›†åˆä½¿ç”¨ç´§æŒ¨åœ¨ä¸€èµ·çš„å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹æ¥ä¿å­˜ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¿å­˜memberï¼Œç¬¬äºŒä¸ªä¿å­˜scoreã€‚ziplistå†…çš„é›†åˆå…ƒç´ æŒ‰scoreä»å°åˆ°å¤§æ’åºï¼Œscoreè¾ƒå°çš„æ’åœ¨è¡¨å¤´ä½ç½®ã€‚</p>
<p><code>skiplist</code>ç¼–ç çš„æœ‰åºé›†åˆåº•å±‚æ˜¯ä¸€ä¸ªå‘½åä¸º<code>zset</code>çš„ç»“æ„ä½“ï¼Œè€Œä¸€ä¸ªzsetç»“æ„åŒæ—¶åŒ…å«ä¸€ä¸ªå­—å…¸å’Œä¸€ä¸ªè·³è·ƒè¡¨ã€‚è·³è·ƒè¡¨æŒ‰scoreä»å°åˆ°å¤§ä¿å­˜æ‰€æœ‰é›†åˆå…ƒç´ ã€‚è€Œå­—å…¸åˆ™ä¿å­˜ç€ä»memberåˆ°scoreçš„æ˜ å°„ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨O(1)çš„å¤æ‚åº¦æ¥æŸ¥æ‰¾memberå¯¹åº”çš„scoreå€¼ã€‚è™½ç„¶åŒæ—¶ä½¿ç”¨ä¸¤ç§ç»“æ„ï¼Œä½†å®ƒä»¬ä¼šé€šè¿‡æŒ‡é’ˆæ¥å…±äº«ç›¸åŒå…ƒç´ çš„memberå’Œscoreï¼Œå› æ­¤ä¸ä¼šæµªè´¹é¢å¤–çš„å†…å­˜ã€‚</p>
<h3 id="zsetæ“ä½œå‘½ä»¤"><a href="#zsetæ“ä½œå‘½ä»¤" class="headerlink" title="zsetæ“ä½œå‘½ä»¤"></a>zsetæ“ä½œå‘½ä»¤</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">zadd(key, score, member)ï¼šå‘åç§°ä¸ºkeyçš„zsetä¸­æ·»åŠ å…ƒç´ memberï¼Œscoreç”¨äºæ’åºã€‚å¦‚æœè¯¥å…ƒç´ å·²ç»å­˜åœ¨ï¼Œåˆ™æ ¹æ®scoreæ›´æ–°è¯¥å…ƒç´ çš„é¡ºåºã€‚</div><div class="line"></div><div class="line">zrem(key, member) ï¼šåˆ é™¤åç§°ä¸ºkeyçš„zsetä¸­çš„å…ƒç´ member</div><div class="line"></div><div class="line">zincrby(key, increment, member) ï¼šå¦‚æœåœ¨åç§°ä¸ºkeyçš„zsetä¸­å·²ç»å­˜åœ¨å…ƒç´ memberï¼Œåˆ™è¯¥å…ƒç´ çš„scoreå¢åŠ incrementï¼›å¦åˆ™å‘é›†åˆä¸­æ·»åŠ è¯¥å…ƒç´ ï¼Œå…¶scoreçš„å€¼ä¸ºincrement</div><div class="line"></div><div class="line">zrank(key, member) ï¼šè¿”å›åç§°ä¸ºkeyçš„zsetï¼ˆå…ƒç´ å·²æŒ‰scoreä»å°åˆ°å¤§æ’åºï¼‰ä¸­memberå…ƒç´ çš„rankï¼ˆå³indexï¼Œä»0å¼€å§‹ï¼‰ï¼Œè‹¥æ²¡æœ‰memberå…ƒç´ ï¼Œè¿”å›â€œnilâ€</div><div class="line"></div><div class="line">zrevrank(key, member) ï¼šè¿”å›åç§°ä¸ºkeyçš„zsetï¼ˆå…ƒç´ å·²æŒ‰scoreä»å¤§åˆ°å°æ’åºï¼‰ä¸­memberå…ƒç´ çš„rankï¼ˆå³indexï¼Œä»0å¼€å§‹ï¼‰ï¼Œè‹¥æ²¡æœ‰memberå…ƒç´ ï¼Œè¿”å›â€œnilâ€</div><div class="line"></div><div class="line">zrange(key, start, end)ï¼šè¿”å›åç§°ä¸ºkeyçš„zsetï¼ˆå…ƒç´ å·²æŒ‰scoreä»å°åˆ°å¤§æ’åºï¼‰ä¸­çš„indexä»startåˆ°endçš„æ‰€æœ‰å…ƒç´ </div><div class="line"></div><div class="line">zrevrange(key, start, end)ï¼šè¿”å›åç§°ä¸ºkeyçš„zsetï¼ˆå…ƒç´ å·²æŒ‰scoreä»å¤§åˆ°å°æ’åºï¼‰ä¸­çš„indexä»startåˆ°endçš„æ‰€æœ‰å…ƒç´ </div><div class="line"></div><div class="line">zrangebyscore(key, min, max)ï¼šè¿”å›åç§°ä¸ºkeyçš„zsetä¸­score &gt;= minä¸”score &lt;= maxçš„æ‰€æœ‰å…ƒç´  zcard(key)ï¼šè¿”å›åç§°ä¸ºkeyçš„zsetçš„åŸºæ•°</div><div class="line"></div><div class="line">zscore(key, element)ï¼šè¿”å›åç§°ä¸ºkeyçš„zsetä¸­å…ƒç´ elementçš„score zremrangebyrank(key, min, max)ï¼šåˆ é™¤åç§°ä¸ºkeyçš„zsetä¸­rank &gt;= minä¸”rank &lt;= maxçš„æ‰€æœ‰å…ƒç´  zremrangebyscore(key, min, max) ï¼šåˆ é™¤åç§°ä¸ºkeyçš„zsetä¸­score &gt;= minä¸”score &lt;= maxçš„æ‰€æœ‰å…ƒç´ </div></pre></td></tr></table></figure>
<h3 id="skiplistä»‹ç»"><a href="#skiplistä»‹ç»" class="headerlink" title="skiplistä»‹ç»"></a><strong>skiplistä»‹ç»</strong></h3><p>è·³è¡¨(skip List)æ˜¯ä¸€ç§éšæœºåŒ–çš„æ•°æ®ç»“æ„ï¼ŒåŸºäºå¹¶è”çš„é“¾è¡¨ï¼Œå®ç°ç®€å•ï¼Œæ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾çš„å¤æ‚åº¦å‡ä¸ºO(logN)ã€‚ç®€å•è¯´æ¥è·³è¡¨ä¹Ÿæ˜¯é“¾è¡¨çš„ä¸€ç§ï¼Œåªä¸è¿‡å®ƒåœ¨é“¾è¡¨çš„åŸºç¡€ä¸Šå¢åŠ äº†è·³è·ƒåŠŸèƒ½ï¼Œæ­£æ˜¯è¿™ä¸ªè·³è·ƒçš„åŠŸèƒ½ï¼Œä½¿å¾—åœ¨æŸ¥æ‰¾å…ƒç´ æ—¶ï¼Œè·³è¡¨èƒ½å¤Ÿæä¾›O(logN)çš„æ—¶é—´å¤æ‚åº¦ã€‚</p>
<p>å…ˆæ¥çœ‹ä¸€ä¸ªæœ‰åºé“¾è¡¨ï¼Œå¦‚ä¸‹å›¾ï¼ˆæœ€å·¦ä¾§çš„ç°è‰²èŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªç©ºçš„å¤´ç»“ç‚¹ï¼‰ï¼š</p>
<p><a href="http://zhangtielei.com/assets/photos_redis/skiplist/sorted_linked_list.png" target="_blank" rel="external"><img src="http://zhangtielei.com/assets/photos_redis/skiplist/sorted_linked_list.png" alt="æœ‰åºé“¾è¡¨ç»“æ„å›¾"></a></p>
<p>åœ¨è¿™æ ·ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œå¦‚æœæˆ‘ä»¬è¦æŸ¥æ‰¾æŸä¸ªæ•°æ®ï¼Œé‚£ä¹ˆéœ€è¦ä»å¤´å¼€å§‹é€ä¸ªè¿›è¡Œæ¯”è¾ƒï¼Œç›´åˆ°æ‰¾åˆ°åŒ…å«æ•°æ®çš„é‚£ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”ç»™å®šæ•°æ®å¤§çš„èŠ‚ç‚¹ä¸ºæ­¢ï¼ˆæ²¡æ‰¾åˆ°ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ã€‚åŒæ ·ï¼Œå½“æˆ‘ä»¬è¦æ’å…¥æ–°æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿè¦ç»å†åŒæ ·çš„æŸ¥æ‰¾è¿‡ç¨‹ï¼Œä»è€Œç¡®å®šæ’å…¥ä½ç½®ã€‚</p>
<p>å‡å¦‚æˆ‘ä»¬æ¯ç›¸é‚»ä¸¤ä¸ªèŠ‚ç‚¹å¢åŠ ä¸€ä¸ªæŒ‡é’ˆï¼Œè®©æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸‹ä¸ªèŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><a href="http://zhangtielei.com/assets/photos_redis/skiplist/skip2node_linked_list.png" target="_blank" rel="external"><img src="http://zhangtielei.com/assets/photos_redis/skiplist/skip2node_linked_list.png" alt="æ¯ä¸¤ä¸ªèŠ‚ç‚¹å¢åŠ ä¸€ä¸ªè·³è·ƒæŒ‡é’ˆçš„æœ‰åºé“¾è¡¨"></a></p>
<p>è¿™æ ·æ‰€æœ‰æ–°å¢åŠ çš„æŒ‡é’ˆè¿æˆäº†ä¸€ä¸ªæ–°çš„é“¾è¡¨ï¼Œä½†å®ƒåŒ…å«çš„èŠ‚ç‚¹ä¸ªæ•°åªæœ‰åŸæ¥çš„ä¸€åŠï¼ˆä¸Šå›¾ä¸­æ˜¯7, 19, 26ï¼‰ã€‚ç°åœ¨å½“æˆ‘ä»¬æƒ³æŸ¥æ‰¾æ•°æ®çš„æ—¶å€™ï¼Œå¯ä»¥å…ˆæ²¿ç€è¿™ä¸ªæ–°é“¾è¡¨è¿›è¡ŒæŸ¥æ‰¾ã€‚å½“ç¢°åˆ°æ¯”å¾…æŸ¥æ•°æ®å¤§çš„èŠ‚ç‚¹æ—¶ï¼Œå†å›åˆ°åŸæ¥çš„é“¾è¡¨ä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬æƒ³æŸ¥æ‰¾23ï¼ŒæŸ¥æ‰¾çš„è·¯å¾„æ˜¯æ²¿ç€ä¸‹å›¾ä¸­æ ‡çº¢çš„æŒ‡é’ˆæ‰€æŒ‡å‘çš„æ–¹å‘è¿›è¡Œçš„ï¼š</p>
<p><a href="http://zhangtielei.com/assets/photos_redis/skiplist/search_path_on_skip2node_list.png" target="_blank" rel="external"><img src="http://zhangtielei.com/assets/photos_redis/skiplist/search_path_on_skip2node_list.png" alt="ä¸€ä¸ªæœç´¢è·¯å¾„çš„ä¾‹å­"></a></p>
<ul>
<li>23é¦–å…ˆå’Œ7æ¯”è¾ƒï¼Œå†å’Œ19æ¯”è¾ƒï¼Œæ¯”å®ƒä»¬éƒ½å¤§ï¼Œç»§ç»­å‘åæ¯”è¾ƒã€‚</li>
<li>ä½†23å’Œ26æ¯”è¾ƒçš„æ—¶å€™ï¼Œæ¯”26è¦å°ï¼Œå› æ­¤å›åˆ°ä¸‹é¢çš„é“¾è¡¨ï¼ˆåŸé“¾è¡¨ï¼‰ï¼Œä¸22æ¯”è¾ƒã€‚</li>
<li>23æ¯”22è¦å¤§ï¼Œæ²¿ä¸‹é¢çš„æŒ‡é’ˆç»§ç»­å‘åå’Œ26æ¯”è¾ƒã€‚23æ¯”26å°ï¼Œè¯´æ˜å¾…æŸ¥æ•°æ®23åœ¨åŸé“¾è¡¨ä¸­ä¸å­˜åœ¨ï¼Œè€Œä¸”å®ƒçš„æ’å…¥ä½ç½®åº”è¯¥åœ¨22å’Œ26ä¹‹é—´ã€‚</li>
</ul>
<p>åœ¨è¿™ä¸ªæŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œç”±äºæ–°å¢åŠ çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬ä¸å†éœ€è¦ä¸é“¾è¡¨ä¸­æ¯ä¸ªèŠ‚ç‚¹é€ä¸ªè¿›è¡Œæ¯”è¾ƒäº†ã€‚éœ€è¦æ¯”è¾ƒçš„èŠ‚ç‚¹æ•°å¤§æ¦‚åªæœ‰åŸæ¥çš„ä¸€åŠã€‚</p>
<p>åˆ©ç”¨åŒæ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šå±‚æ–°äº§ç”Ÿçš„é“¾è¡¨ä¸Šï¼Œç»§ç»­ä¸ºæ¯ç›¸é‚»çš„ä¸¤ä¸ªèŠ‚ç‚¹å¢åŠ ä¸€ä¸ªæŒ‡é’ˆï¼Œä»è€Œäº§ç”Ÿç¬¬ä¸‰å±‚é“¾è¡¨ã€‚å¦‚ä¸‹å›¾ï¼š</p>
<p><a href="http://zhangtielei.com/assets/photos_redis/skiplist/skip2node_level3_linked_list.png" target="_blank" rel="external"><img src="http://zhangtielei.com/assets/photos_redis/skiplist/skip2node_level3_linked_list.png" alt="ä¸¤å±‚è·³è·ƒæŒ‡é’ˆ"></a></p>
<p>åœ¨è¿™ä¸ªæ–°çš„ä¸‰å±‚é“¾è¡¨ç»“æ„ä¸Šï¼Œå¦‚æœæˆ‘ä»¬è¿˜æ˜¯æŸ¥æ‰¾23ï¼Œé‚£ä¹ˆæ²¿ç€æœ€ä¸Šå±‚é“¾è¡¨é¦–å…ˆè¦æ¯”è¾ƒçš„æ˜¯19ï¼Œå‘ç°23æ¯”19å¤§ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±çŸ¥é“åªéœ€è¦åˆ°19çš„åé¢å»ç»§ç»­æŸ¥æ‰¾ï¼Œä»è€Œä¸€ä¸‹å­è·³è¿‡äº†19å‰é¢çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚å¯ä»¥æƒ³è±¡ï¼Œå½“é“¾è¡¨è¶³å¤Ÿé•¿çš„æ—¶å€™ï¼Œè¿™ç§å¤šå±‚é“¾è¡¨çš„æŸ¥æ‰¾æ–¹å¼èƒ½è®©æˆ‘ä»¬è·³è¿‡å¾ˆå¤šä¸‹å±‚èŠ‚ç‚¹ï¼Œå¤§å¤§åŠ å¿«æŸ¥æ‰¾çš„é€Ÿåº¦ã€‚</p>
<p><code>skiplist</code>æ­£æ˜¯å—è¿™ç§å¤šå±‚é“¾è¡¨çš„æƒ³æ³•çš„å¯å‘è€Œè®¾è®¡å‡ºæ¥çš„ã€‚å®é™…ä¸Šï¼ŒæŒ‰ç…§ä¸Šé¢ç”Ÿæˆé“¾è¡¨çš„æ–¹å¼ï¼Œä¸Šé¢æ¯ä¸€å±‚é“¾è¡¨çš„èŠ‚ç‚¹ä¸ªæ•°ï¼Œæ˜¯ä¸‹é¢ä¸€å±‚çš„èŠ‚ç‚¹ä¸ªæ•°çš„ä¸€åŠï¼Œè¿™æ ·æŸ¥æ‰¾è¿‡ç¨‹å°±éå¸¸ç±»ä¼¼äºä¸€ä¸ªäºŒåˆ†æŸ¥æ‰¾ï¼Œä½¿å¾—æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦å¯ä»¥é™ä½åˆ°O(log n)ã€‚ä½†æ˜¯ï¼Œè¿™ç§æ–¹æ³•åœ¨æ’å…¥æ•°æ®çš„æ—¶å€™æœ‰å¾ˆå¤§çš„é—®é¢˜ã€‚æ–°æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ä¹‹åï¼Œå°±ä¼šæ‰“ä¹±ä¸Šä¸‹ç›¸é‚»ä¸¤å±‚é“¾è¡¨ä¸ŠèŠ‚ç‚¹ä¸ªæ•°ä¸¥æ ¼çš„2:1çš„å¯¹åº”å…³ç³»ã€‚å¦‚æœè¦ç»´æŒè¿™ç§å¯¹åº”å…³ç³»ï¼Œå°±å¿…é¡»æŠŠæ–°æ’å…¥çš„èŠ‚ç‚¹åé¢çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ˆä¹ŸåŒ…æ‹¬æ–°æ’å…¥çš„èŠ‚ç‚¹ï¼‰é‡æ–°è¿›è¡Œè°ƒæ•´ï¼Œè¿™ä¼šè®©æ—¶é—´å¤æ‚åº¦é‡æ–°èœ•åŒ–æˆO(n)ã€‚åˆ é™¤æ•°æ®ä¹Ÿæœ‰åŒæ ·çš„é—®é¢˜ã€‚</p>
<p>skiplistä¸ºäº†é¿å…è¿™ä¸€é—®é¢˜ï¼Œå®ƒä¸è¦æ±‚ä¸Šä¸‹ç›¸é‚»ä¸¤å±‚é“¾è¡¨ä¹‹é—´çš„èŠ‚ç‚¹ä¸ªæ•°æœ‰ä¸¥æ ¼çš„å¯¹åº”å…³ç³»ï¼Œè€Œæ˜¯ä¸ºæ¯ä¸ªèŠ‚ç‚¹éšæœºå‡ºä¸€ä¸ªå±‚æ•°(level)ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªèŠ‚ç‚¹éšæœºå‡ºçš„å±‚æ•°æ˜¯3ï¼Œé‚£ä¹ˆå°±æŠŠå®ƒé“¾å…¥åˆ°ç¬¬1å±‚åˆ°ç¬¬3å±‚è¿™ä¸‰å±‚é“¾è¡¨ä¸­ã€‚ä¸ºäº†è¡¨è¾¾æ¸…æ¥šï¼Œä¸‹å›¾å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ä¸€æ­¥æ­¥çš„æ’å…¥æ“ä½œä»è€Œå½¢æˆä¸€ä¸ªskiplistçš„è¿‡ç¨‹ï¼š</p>
<p><a href="http://zhangtielei.com/assets/photos_redis/skiplist/skiplist_insertions.png" target="_blank" rel="external"><img src="http://zhangtielei.com/assets/photos_redis/skiplist/skiplist_insertions.png" alt="skiplistæ’å…¥å½¢æˆè¿‡ç¨‹"></a></p>
<p>ä»ä¸Šé¢skiplistçš„åˆ›å»ºå’Œæ’å…¥è¿‡ç¨‹å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å±‚æ•°ï¼ˆlevelï¼‰æ˜¯éšæœºå‡ºæ¥çš„ï¼Œè€Œä¸”æ–°æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¼šå½±å“å…¶å®ƒèŠ‚ç‚¹çš„å±‚æ•°ã€‚å› æ­¤ï¼Œæ’å…¥æ“ä½œåªéœ€è¦ä¿®æ”¹æ’å…¥èŠ‚ç‚¹å‰åçš„æŒ‡é’ˆï¼Œè€Œä¸éœ€è¦å¯¹å¾ˆå¤šèŠ‚ç‚¹éƒ½è¿›è¡Œè°ƒæ•´ã€‚è¿™å°±é™ä½äº†æ’å…¥æ“ä½œçš„å¤æ‚åº¦ã€‚å®é™…ä¸Šï¼Œè¿™æ˜¯skiplistçš„ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹æ€§ï¼Œè¿™è®©å®ƒåœ¨æ’å…¥æ€§èƒ½ä¸Šæ˜æ˜¾ä¼˜äºå¹³è¡¡æ ‘çš„æ–¹æ¡ˆã€‚è¿™åœ¨åé¢æˆ‘ä»¬è¿˜ä¼šæåˆ°ã€‚</p>
<p>skiplistï¼ŒæŒ‡çš„å°±æ˜¯é™¤äº†æœ€ä¸‹é¢ç¬¬1å±‚é“¾è¡¨ä¹‹å¤–ï¼Œå®ƒä¼šäº§ç”Ÿè‹¥å¹²å±‚ç¨€ç–çš„é“¾è¡¨ï¼Œè¿™äº›é“¾è¡¨é‡Œé¢çš„æŒ‡é’ˆæ•…æ„è·³è¿‡äº†ä¸€äº›èŠ‚ç‚¹ï¼ˆè€Œä¸”è¶Šé«˜å±‚çš„é“¾è¡¨è·³è¿‡çš„èŠ‚ç‚¹è¶Šå¤šï¼‰ã€‚è¿™å°±ä½¿å¾—æˆ‘ä»¬åœ¨æŸ¥æ‰¾æ•°æ®çš„æ—¶å€™èƒ½å¤Ÿå…ˆåœ¨é«˜å±‚çš„é“¾è¡¨ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œç„¶åé€å±‚é™ä½ï¼Œæœ€ç»ˆé™åˆ°ç¬¬1å±‚é“¾è¡¨æ¥ç²¾ç¡®åœ°ç¡®å®šæ•°æ®ä½ç½®ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è·³è¿‡äº†ä¸€äº›èŠ‚ç‚¹ï¼Œä»è€Œä¹Ÿå°±åŠ å¿«äº†æŸ¥æ‰¾é€Ÿåº¦ã€‚</p>
<p>åˆšåˆšåˆ›å»ºçš„è¿™ä¸ªskiplistæ€»å…±åŒ…å«4å±‚é“¾è¡¨ï¼Œç°åœ¨å‡è®¾æˆ‘ä»¬åœ¨å®ƒé‡Œé¢ä¾ç„¶æŸ¥æ‰¾23ï¼Œä¸‹å›¾ç»™å‡ºäº†æŸ¥æ‰¾è·¯å¾„ï¼š</p>
<p><a href="http://zhangtielei.com/assets/photos_redis/skiplist/search_path_on_skiplist.png" target="_blank" rel="external"><img src="http://zhangtielei.com/assets/photos_redis/skiplist/search_path_on_skiplist.png" alt="skiplistä¸Šçš„æŸ¥æ‰¾è·¯å¾„å±•ç¤º"></a></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‰é¢æ¼”ç¤ºçš„å„ä¸ªèŠ‚ç‚¹çš„æ’å…¥è¿‡ç¨‹ï¼Œå®é™…ä¸Šåœ¨æ’å…¥ä¹‹å‰ä¹Ÿè¦å…ˆç»å†ä¸€ä¸ªç±»ä¼¼çš„æŸ¥æ‰¾è¿‡ç¨‹ï¼Œåœ¨ç¡®å®šæ’å…¥ä½ç½®åï¼Œå†å®Œæˆæ’å…¥æ“ä½œã€‚</p>
<p>å®é™…åº”ç”¨ä¸­çš„skiplistæ¯ä¸ªèŠ‚ç‚¹åº”è¯¥åŒ…å«keyå’Œvalueä¸¤éƒ¨åˆ†ã€‚å‰é¢çš„æè¿°ä¸­æˆ‘ä»¬æ²¡æœ‰å…·ä½“åŒºåˆ†keyå’Œvalueï¼Œä½†å®é™…ä¸Šåˆ—è¡¨ä¸­æ˜¯æŒ‰ç…§key(score)è¿›è¡Œæ’åºçš„ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ä¹Ÿæ˜¯æ ¹æ®keyåœ¨æ¯”è¾ƒã€‚</p>
<p>æ‰§è¡Œæ’å…¥æ“ä½œæ—¶è®¡ç®—éšæœºæ•°çš„è¿‡ç¨‹ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå…³é”®çš„è¿‡ç¨‹ï¼Œå®ƒå¯¹skiplistçš„ç»Ÿè®¡ç‰¹æ€§æœ‰ç€å¾ˆé‡è¦çš„å½±å“ã€‚è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„æœä»å‡åŒ€åˆ†å¸ƒçš„éšæœºæ•°ï¼Œå®ƒçš„è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>é¦–å…ˆï¼Œæ¯ä¸ªèŠ‚ç‚¹è‚¯å®šéƒ½æœ‰ç¬¬1å±‚æŒ‡é’ˆï¼ˆæ¯ä¸ªèŠ‚ç‚¹éƒ½åœ¨ç¬¬1å±‚é“¾è¡¨é‡Œï¼‰ã€‚</li>
<li>å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æœ‰ç¬¬iå±‚(i&gt;=1)æŒ‡é’ˆï¼ˆå³èŠ‚ç‚¹å·²ç»åœ¨ç¬¬1å±‚åˆ°ç¬¬iå±‚é“¾è¡¨ä¸­ï¼‰ï¼Œé‚£ä¹ˆå®ƒæœ‰ç¬¬(i+1)å±‚æŒ‡é’ˆçš„æ¦‚ç‡ä¸ºpã€‚</li>
<li>èŠ‚ç‚¹æœ€å¤§çš„å±‚æ•°ä¸å…è®¸è¶…è¿‡ä¸€ä¸ªæœ€å¤§å€¼ï¼Œè®°ä¸ºMaxLevelã€‚</li>
</ul>
<p>è¿™ä¸ªè®¡ç®—éšæœºå±‚æ•°çš„ä¼ªç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">randomLevel()</div><div class="line">    level := <span class="number">1</span></div><div class="line">    <span class="comment">// random()è¿”å›ä¸€ä¸ª[0...1)çš„éšæœºæ•°</span></div><div class="line">    <span class="keyword">while</span> random() &lt; p and level &lt; MaxLevel <span class="keyword">do</span></div><div class="line">        level := level + <span class="number">1</span></div><div class="line">    <span class="keyword">return</span> level</div></pre></td></tr></table></figure>
<p>randomLevel()çš„ä¼ªç ä¸­åŒ…å«ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯pï¼Œä¸€ä¸ªæ˜¯MaxLevelã€‚åœ¨Redisçš„skiplistå®ç°ä¸­ï¼Œè¿™ä¸¤ä¸ªå‚æ•°çš„å–å€¼ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">p = <span class="number">1</span>/<span class="number">4</span></div><div class="line">MaxLevel = <span class="number">32</span></div></pre></td></tr></table></figure>
<h3 id="skiplistä¸å¹³è¡¡æ ‘ã€å“ˆå¸Œè¡¨çš„æ¯”è¾ƒ"><a href="#skiplistä¸å¹³è¡¡æ ‘ã€å“ˆå¸Œè¡¨çš„æ¯”è¾ƒ" class="headerlink" title="skiplistä¸å¹³è¡¡æ ‘ã€å“ˆå¸Œè¡¨çš„æ¯”è¾ƒ"></a>skiplistä¸å¹³è¡¡æ ‘ã€å“ˆå¸Œè¡¨çš„æ¯”è¾ƒ</h3><ul>
<li>skiplistå’Œå„ç§å¹³è¡¡æ ‘ï¼ˆå¦‚AVLã€çº¢é»‘æ ‘ç­‰ï¼‰çš„å…ƒç´ æ˜¯æœ‰åºæ’åˆ—çš„ï¼Œè€Œå“ˆå¸Œè¡¨ä¸æ˜¯æœ‰åºçš„ã€‚å› æ­¤ï¼Œåœ¨å“ˆå¸Œè¡¨ä¸Šåªèƒ½åšå•ä¸ªkeyçš„æŸ¥æ‰¾ï¼Œä¸é€‚å®œåšèŒƒå›´æŸ¥æ‰¾ã€‚æ‰€è°“èŒƒå›´æŸ¥æ‰¾ï¼ŒæŒ‡çš„æ˜¯æŸ¥æ‰¾é‚£äº›å¤§å°åœ¨æŒ‡å®šçš„ä¸¤ä¸ªå€¼ä¹‹é—´çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚</li>
<li>åœ¨åšèŒƒå›´æŸ¥æ‰¾çš„æ—¶å€™ï¼Œå¹³è¡¡æ ‘æ¯”skiplistæ“ä½œè¦å¤æ‚ã€‚åœ¨å¹³è¡¡æ ‘ä¸Šï¼Œæˆ‘ä»¬æ‰¾åˆ°æŒ‡å®šèŒƒå›´çš„å°å€¼ä¹‹åï¼Œè¿˜éœ€è¦ä»¥ä¸­åºéå†çš„é¡ºåºç»§ç»­å¯»æ‰¾å…¶å®ƒä¸è¶…è¿‡å¤§å€¼çš„èŠ‚ç‚¹ã€‚å¦‚æœä¸å¯¹å¹³è¡¡æ ‘è¿›è¡Œä¸€å®šçš„æ”¹é€ ï¼Œè¿™é‡Œçš„ä¸­åºéå†å¹¶ä¸å®¹æ˜“å®ç°ã€‚è€Œåœ¨skiplistä¸Šè¿›è¡ŒèŒƒå›´æŸ¥æ‰¾å°±éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨æ‰¾åˆ°å°å€¼ä¹‹åï¼Œå¯¹ç¬¬1å±‚é“¾è¡¨è¿›è¡Œè‹¥å¹²æ­¥çš„éå†å°±å¯ä»¥å®ç°ã€‚</li>
<li>å¹³è¡¡æ ‘çš„æ’å…¥å’Œåˆ é™¤æ“ä½œå¯èƒ½å¼•å‘å­æ ‘çš„è°ƒæ•´ï¼Œé€»è¾‘å¤æ‚ï¼Œè€Œskiplistçš„æ’å…¥å’Œåˆ é™¤åªéœ€è¦ä¿®æ”¹ç›¸é‚»èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œæ“ä½œç®€å•åˆå¿«é€Ÿã€‚</li>
<li>ä»å†…å­˜å ç”¨ä¸Šæ¥è¯´ï¼Œskiplistæ¯”å¹³è¡¡æ ‘æ›´çµæ´»ä¸€äº›ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¹³è¡¡æ ‘æ¯ä¸ªèŠ‚ç‚¹åŒ…å«2ä¸ªæŒ‡é’ˆï¼ˆåˆ†åˆ«æŒ‡å‘å·¦å³å­æ ‘ï¼‰ï¼Œè€Œskiplistæ¯ä¸ªèŠ‚ç‚¹åŒ…å«çš„æŒ‡é’ˆæ•°ç›®å¹³å‡ä¸º1/(1-p)ï¼Œå…·ä½“å–å†³äºå‚æ•°pçš„å¤§å°ã€‚å¦‚æœåƒRedisé‡Œçš„å®ç°ä¸€æ ·ï¼Œå–p=1/4ï¼Œé‚£ä¹ˆå¹³å‡æ¯ä¸ªèŠ‚ç‚¹åŒ…å«1.33ä¸ªæŒ‡é’ˆï¼Œæ¯”å¹³è¡¡æ ‘æ›´æœ‰ä¼˜åŠ¿ã€‚</li>
<li>æŸ¥æ‰¾å•ä¸ªkeyï¼Œskiplistå’Œå¹³è¡¡æ ‘çš„æ—¶é—´å¤æ‚åº¦éƒ½ä¸ºO(log n)ï¼Œå¤§ä½“ç›¸å½“ï¼›è€Œå“ˆå¸Œè¡¨åœ¨ä¿æŒè¾ƒä½çš„å“ˆå¸Œå€¼å†²çªæ¦‚ç‡çš„å‰æä¸‹ï¼ŒæŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦æ¥è¿‘O(1)ï¼Œæ€§èƒ½æ›´é«˜ä¸€äº›ã€‚æ‰€ä»¥æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨çš„å„ç§Mapæˆ–dictionaryç»“æ„ï¼Œå¤§éƒ½æ˜¯åŸºäºå“ˆå¸Œè¡¨å®ç°çš„ã€‚</li>
<li>ä»ç®—æ³•å®ç°éš¾åº¦ä¸Šæ¥æ¯”è¾ƒï¼Œskiplistæ¯”å¹³è¡¡æ ‘è¦ç®€å•å¾—å¤šã€‚</li>
</ul>
<h3 id="Redisä¸­çš„skiplistå®ç°"><a href="#Redisä¸­çš„skiplistå®ç°" class="headerlink" title="Redisä¸­çš„skiplistå®ç°"></a>Redisä¸­çš„skiplistå®ç°</h3><p>skiplistçš„æ•°æ®ç»“æ„å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ZSKIPLIST_MAXLEVEL 32</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ZSKIPLIST_P 0.25</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> zskiplistNode &#123;</div><div class="line">    robj *obj;</div><div class="line">    <span class="keyword">double</span> score;</div><div class="line">    <span class="keyword">struct</span> zskiplistNode *backward;</div><div class="line">    <span class="keyword">struct</span> zskiplistLevel &#123;</div><div class="line">        <span class="keyword">struct</span> zskiplistNode *forward;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> span;</div><div class="line">    &#125; level[];</div><div class="line">&#125; zskiplistNode;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> zskiplist &#123;</div><div class="line">    <span class="keyword">struct</span> zskiplistNode *header, *tail;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> length;</div><div class="line">    <span class="keyword">int</span> level;</div><div class="line">&#125; zskiplist;</div></pre></td></tr></table></figure>
<p>ç®€å•åˆ†æä¸€ä¸‹å‡ ä¸ªæŸ¥è¯¢å‘½ä»¤ï¼š</p>
<ul>
<li>zrevrankç”±æ•°æ®æŸ¥è¯¢å®ƒå¯¹åº”çš„æ’åï¼Œè¿™åœ¨å‰é¢ä»‹ç»çš„skiplistä¸­å¹¶ä¸æ”¯æŒã€‚</li>
<li>zscoreç”±æ•°æ®æŸ¥è¯¢å®ƒå¯¹åº”çš„åˆ†æ•°ï¼Œè¿™ä¹Ÿä¸æ˜¯skiplistæ‰€æ”¯æŒçš„ã€‚</li>
<li>zrevrangeæ ¹æ®ä¸€ä¸ªæ’åèŒƒå›´ï¼ŒæŸ¥è¯¢æ’ååœ¨è¿™ä¸ªèŒƒå›´å†…çš„æ•°æ®ã€‚è¿™åœ¨å‰é¢ä»‹ç»çš„skiplistä¸­ä¹Ÿä¸æ”¯æŒã€‚</li>
<li>zrevrangebyscoreæ ¹æ®åˆ†æ•°åŒºé—´æŸ¥è¯¢æ•°æ®é›†åˆï¼Œæ˜¯ä¸€ä¸ªskiplistæ‰€æ”¯æŒçš„å…¸å‹çš„èŒƒå›´æŸ¥æ‰¾ï¼ˆscoreç›¸å½“äºkeyï¼Œæ•°æ®ç›¸å½“äºvalueï¼‰ã€‚</li>
</ul>
<p>å®é™…ä¸Šï¼ŒRedisä¸­sorted setçš„å®ç°æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li>å½“æ•°æ®è¾ƒå°‘æ—¶ï¼Œsorted setæ˜¯ç”±ä¸€ä¸ªziplistæ¥å®ç°çš„ã€‚</li>
<li>å½“æ•°æ®å¤šçš„æ—¶å€™ï¼Œsorted setæ˜¯ç”±ä¸€ä¸ªdict + ä¸€ä¸ªskiplistæ¥å®ç°çš„ã€‚ç®€å•æ¥è®²ï¼Œdictç”¨æ¥æŸ¥è¯¢æ•°æ®åˆ°åˆ†æ•°çš„å¯¹åº”å…³ç³»ï¼Œè€Œskiplistç”¨æ¥æ ¹æ®åˆ†æ•°æŸ¥è¯¢æ•°æ®ï¼ˆå¯èƒ½æ˜¯èŒƒå›´æŸ¥æ‰¾ï¼‰ã€‚</li>
</ul>
<p>çœ‹ä¸€ä¸‹sorted setä¸skiplistçš„å…³ç³»ï¼Œï¼š</p>
<ul>
<li>zscoreçš„æŸ¥è¯¢ï¼Œä¸æ˜¯ç”±skiplistæ¥æä¾›çš„ï¼Œè€Œæ˜¯ç”±é‚£ä¸ªdictæ¥æä¾›çš„ã€‚</li>
<li>ä¸ºäº†æ”¯æŒæ’å(rank)ï¼ŒRedisé‡Œå¯¹skipliståšäº†æ‰©å±•ï¼Œä½¿å¾—æ ¹æ®æ’åèƒ½å¤Ÿå¿«é€ŸæŸ¥åˆ°æ•°æ®ï¼Œæˆ–è€…æ ¹æ®åˆ†æ•°æŸ¥åˆ°æ•°æ®ä¹‹åï¼Œä¹ŸåŒæ—¶å¾ˆå®¹æ˜“è·å¾—æ’åã€‚è€Œä¸”ï¼Œæ ¹æ®æ’åçš„æŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦ä¹Ÿä¸ºO(log n)ã€‚</li>
<li>zrevrangeçš„æŸ¥è¯¢ï¼Œæ˜¯æ ¹æ®æ’åæŸ¥æ•°æ®ï¼Œç”±æ‰©å±•åçš„skiplistæ¥æä¾›ã€‚</li>
<li>zrevrankæ˜¯å…ˆåœ¨dictä¸­ç”±æ•°æ®æŸ¥åˆ°åˆ†æ•°ï¼Œå†æ‹¿åˆ†æ•°åˆ°skiplistä¸­å»æŸ¥æ‰¾ï¼ŒæŸ¥åˆ°åä¹ŸåŒæ—¶è·å¾—äº†æ’åã€‚</li>
</ul>
<p>æ€»ç»“èµ·æ¥ï¼ŒRedisä¸­çš„skiplistè·Ÿå‰é¢ä»‹ç»çš„ç»å…¸çš„skiplistç›¸æ¯”ï¼Œæœ‰å¦‚ä¸‹ä¸åŒï¼š</p>
<ul>
<li>åˆ†æ•°(score)å…è®¸é‡å¤ï¼Œå³skiplistçš„keyå…è®¸é‡å¤ã€‚è¿™åœ¨æœ€å¼€å§‹ä»‹ç»çš„ç»å…¸skiplistä¸­æ˜¯ä¸å…è®¸çš„ã€‚</li>
<li>åœ¨æ¯”è¾ƒæ—¶ï¼Œä¸ä»…æ¯”è¾ƒåˆ†æ•°ï¼ˆç›¸å½“äºskiplistçš„keyï¼‰ï¼Œè¿˜æ¯”è¾ƒæ•°æ®æœ¬èº«ã€‚åœ¨Redisçš„skiplistå®ç°ä¸­ï¼Œæ•°æ®æœ¬èº«çš„å†…å®¹å”¯ä¸€æ ‡è¯†è¿™ä»½æ•°æ®ï¼Œè€Œä¸æ˜¯ç”±keyæ¥å”¯ä¸€æ ‡è¯†ã€‚å¦å¤–ï¼Œå½“å¤šä¸ªå…ƒç´ åˆ†æ•°ç›¸åŒçš„æ—¶å€™ï¼Œè¿˜éœ€è¦æ ¹æ®æ•°æ®å†…å®¹æ¥è¿›å­—å…¸æ’åºã€‚</li>
<li>ç¬¬1å±‚é“¾è¡¨ä¸æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œè€Œæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚è¿™æ˜¯ä¸ºäº†æ–¹ä¾¿ä»¥å€’åºæ–¹å¼è·å–ä¸€ä¸ªèŒƒå›´å†…çš„å…ƒç´ ã€‚</li>
<li>åœ¨skiplistä¸­å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è®¡ç®—å‡ºæ¯ä¸ªå…ƒç´ çš„æ’å(rank)ã€‚</li>
</ul>
<h3 id="Redisä¸ºä»€ä¹ˆç”¨skiplistè€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ"><a href="#Redisä¸ºä»€ä¹ˆç”¨skiplistè€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ" class="headerlink" title="Redisä¸ºä»€ä¹ˆç”¨skiplistè€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ"></a>Redisä¸ºä»€ä¹ˆç”¨skiplistè€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">There are a few reasons:</div><div class="line"></div><div class="line">1) They are not very memory intensive. Itâ€™s up to you basically. Changing parameters about the probability of a node to have a given number of levels will make then less memory intensive than btrees.</div><div class="line"></div><div class="line">2) A sorted set is often target of many ZRANGE or ZREVRANGE operations, that is, traversing the skip list as a linked list. With this operation the cache locality of skip lists is at least as good as with other kind of balanced trees.</div><div class="line"></div><div class="line">3) They are simpler to implement, debug, and so forth. For instance thanks to the skip list simplicity I received a patch (already in Redis master) with augmented skip lists implementing ZRANK in O(log(N)). It required little changes to the code.</div></pre></td></tr></table></figure>
<p>è¿™é‡Œä»å†…å­˜å ç”¨ã€å¯¹èŒƒå›´æŸ¥æ‰¾çš„æ”¯æŒå’Œå®ç°éš¾æ˜“ç¨‹åº¦è¿™ä¸‰æ–¹é¢æ€»ç»“çš„åŸå› ã€‚</p>
<h3 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a>å‚è€ƒï¼š</h3><p><a href="http://zhangtielei.com/posts/blog-redis-skiplist.html" target="_blank" rel="external">Rediså†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£(6)â€”â€”skiplist</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[JVMè¿è¡Œå‚æ•°]]></title>
      <url>http://zsr.github.io/2017/06/26/JVM%E8%BF%90%E8%A1%8C%E5%8F%82%E6%95%B0/</url>
      <content type="html"><![CDATA[<h3 id="Java-JVMå†…å­˜ä»‹ç»"><a href="#Java-JVMå†…å­˜ä»‹ç»" class="headerlink" title="Java JVMå†…å­˜ä»‹ç»"></a>Java JVMå†…å­˜ä»‹ç»</h3><p>JVMç®¡ç†ä¸¤ç§ç±»å‹çš„å†…å­˜ï¼Œå †å’Œéå †ã€‚æŒ‰ç…§å®˜æ–¹çš„è¯´æ³•ï¼šâ€œJava è™šæ‹Ÿæœºå…·æœ‰ä¸€ä¸ªå †ï¼Œå †æ˜¯è¿è¡Œæ—¶æ•°æ®åŒºåŸŸï¼Œæ‰€æœ‰ç±»å®ä¾‹å’Œæ•°ç»„çš„å†…å­˜å‡ä»æ­¤å¤„åˆ†é…ã€‚å †æ˜¯åœ¨ Java è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºçš„ã€‚â€â€œåœ¨JVMä¸­å †ä¹‹å¤–çš„å†…å­˜ç§°ä¸ºéå †å†…å­˜(Non-heap memory)â€ã€‚ç®€å•æ¥è¯´å †å°±æ˜¯Javaä»£ç å¯åŠçš„å†…å­˜ï¼Œæ˜¯ç•™ç»™å¼€å‘äººå‘˜ä½¿ç”¨çš„ï¼›éå †å°±æ˜¯JVMç•™ç»™è‡ªå·±ç”¨çš„ï¼Œæ‰€ä»¥æ–¹æ³•åŒºã€JVMå†…éƒ¨å¤„ç†æˆ–ä¼˜åŒ–æ‰€éœ€çš„å†…å­˜(å¦‚JITç¼–è¯‘åçš„ä»£ç ç¼“å­˜)ã€æ¯ä¸ªç±»ç»“æ„(å¦‚è¿è¡Œæ—¶å¸¸æ•°æ± ã€å­—æ®µå’Œæ–¹æ³•æ•°æ®)ä»¥åŠæ–¹æ³•å’Œæ„é€ æ–¹æ³•çš„ä»£ç éƒ½åœ¨éå †å†…å­˜ä¸­ï¼Œå®ƒå’Œå †ä¸åŒï¼Œè¿è¡ŒæœŸå†…GCä¸ä¼šé‡Šæ”¾å…¶ç©ºé—´ã€‚</p>
<h4 id="å †å†…å­˜åˆ†é…"><a href="#å †å†…å­˜åˆ†é…" class="headerlink" title="å †å†…å­˜åˆ†é…"></a>å †å†…å­˜åˆ†é…</h4><p>JVMåˆå§‹åˆ†é…çš„å†…å­˜ç”±-XmsæŒ‡å®šï¼Œé»˜è®¤æ˜¯ç‰©ç†å†…å­˜çš„1/64ï¼›JVMæœ€å¤§åˆ†é…çš„å†…å­˜ç”±-XmxæŒ‡å®šï¼Œé»˜è®¤æ˜¯ç‰©ç†å†…å­˜çš„1/4ã€‚é»˜è®¤ç©ºä½™å †å†…å­˜å°äº 40%æ—¶ï¼ŒJVMå°±ä¼šå¢å¤§å †ç›´åˆ°-Xmxçš„æœ€å¤§é™åˆ¶ï¼›ç©ºä½™å †å†…å­˜å¤§äº70%æ—¶ï¼ŒJVMä¼šå‡å°‘å †ç›´åˆ°-Xmsçš„æœ€å°é™åˆ¶ã€‚å› æ­¤æœåŠ¡å™¨ä¸€èˆ¬è®¾ç½®-Xmsã€ -Xmxç›¸ç­‰ä»¥é¿å…åœ¨æ¯æ¬¡GC åè°ƒæ•´å †çš„å¤§å°ã€‚å¯ä»¥åˆ©ç”¨JVMæä¾›çš„-Xmn -Xms -Xmxç­‰é€‰é¡¹å¯è¿›è¡Œå †å†…å­˜è®¾ç½®ï¼Œä¸€èˆ¬çš„è¦å°†-Xmså’Œ-Xmxé€‰é¡¹è®¾ç½®ä¸ºç›¸åŒï¼Œè€Œ-Xmnä¸º1/4çš„-Xmxå€¼ï¼Œå»ºè®®å †çš„æœ€å¤§å€¼è®¾ç½®ä¸ºå¯ç”¨å†…å­˜çš„æœ€å¤§å€¼çš„80%ã€‚</p>
<p>åˆå§‹åŒ–å †çš„å¤§å°æ˜¯JVMåœ¨å¯åŠ¨æ—¶å‘ç³»ç»Ÿç”³è¯·çš„å†…å­˜çš„å¤§å°ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œè¿™ä¸ªå‚æ•°ä¸é‡è¦ã€‚ä½†æ˜¯æœ‰çš„åº”ç”¨ç¨‹åºåœ¨å¤§è´Ÿè½½çš„æƒ…å†µä¸‹ä¼šæ€¥å‰§åœ°å ç”¨æ›´å¤šçš„å†…å­˜ï¼Œæ­¤æ—¶è¿™ä¸ªå‚æ•°å°±æ˜¯æ˜¾å¾—éå¸¸é‡è¦ï¼Œå¦‚æœJVMå¯åŠ¨æ—¶è®¾ç½®ä½¿ç”¨çš„å†…å­˜æ¯”è¾ƒå°è€Œåœ¨è¿™ç§æƒ…å†µä¸‹æœ‰è®¸å¤šå¯¹è±¡è¿›è¡Œåˆå§‹åŒ–ï¼ŒJVMå°±å¿…é¡»é‡å¤åœ°å¢åŠ å†…å­˜æ¥æ»¡è¶³ä½¿ç”¨ã€‚ç”±äºè¿™ç§åŸå› ï¼Œæˆ‘ä»¬ä¸€èˆ¬æŠŠ-Xmså’Œ-Xmxè®¾ä¸ºä¸€æ ·å¤§ï¼Œè€Œå †çš„æœ€å¤§å€¼å—é™äºç³»ç»Ÿä½¿ç”¨çš„ç‰©ç†å†…å­˜ã€‚ä¸€èˆ¬ä½¿ç”¨æ•°æ®é‡è¾ƒå¤§çš„åº”ç”¨ç¨‹åºä¼šä½¿ç”¨æŒä¹…å¯¹è±¡ï¼Œå†…å­˜ä½¿ç”¨æœ‰å¯èƒ½è¿…é€Ÿåœ°å¢é•¿ã€‚å½“åº”ç”¨ç¨‹åºéœ€è¦çš„å†…å­˜è¶…å‡ºå †çš„æœ€å¤§å€¼æ—¶JVMå°±ä¼šæç¤ºå†…å­˜æº¢å‡ºï¼Œå¹¶ä¸”å¯¼è‡´åº”ç”¨æœåŠ¡å´©æºƒã€‚æ‰€ä»¥ï¼Œå¦‚æœXmsè¶…è¿‡äº†Xmxå€¼ï¼Œæˆ–è€…å †æœ€å¤§å€¼å’Œéå †æœ€å¤§å€¼çš„æ€»å’Œè¶…è¿‡äº†ç‰©ç†å†…å­˜æˆ–è€…æ“ä½œç³»ç»Ÿçš„æœ€å¤§é™åˆ¶éƒ½ä¼šå¼•èµ·æœåŠ¡å™¨å¯åŠ¨ä¸èµ·æ¥ã€‚</p>
<h4 id="éå †å†…å­˜åˆ†é…"><a href="#éå †å†…å­˜åˆ†é…" class="headerlink" title="éå †å†…å­˜åˆ†é…"></a>éå †å†…å­˜åˆ†é…</h4><p>ä¹Ÿå«æ°¸ä¹…ä¿å­˜çš„åŒºåŸŸï¼Œç”¨äºå­˜æ”¾Classå’ŒMetaä¿¡æ¯,Classåœ¨è¢«Loadçš„æ—¶å€™è¢«æ”¾å…¥è¯¥åŒºåŸŸã€‚å®ƒå’Œå­˜æ”¾ç±»å®ä¾‹(Instance)çš„HeapåŒºåŸŸä¸åŒ,GC(Garbage Collection)ä¸ä¼šåœ¨ä¸»ç¨‹åºè¿è¡ŒæœŸå¯¹PermGen spaceè¿›è¡Œæ¸…ç†ã€‚JVMä½¿ç”¨-XX:PermSizeè®¾ç½®éå †å†…å­˜åˆå§‹å€¼ï¼Œé»˜è®¤æ˜¯ç‰©ç†å†…å­˜çš„1/64ï¼›ç”±XX:MaxPermSizeè®¾ç½®æœ€å¤§éå †å†…å­˜çš„å¤§å°ï¼Œé»˜è®¤æ˜¯ç‰©ç†å†…å­˜çš„1/4ã€‚ GCä¸ä¼šå¯¹PermGen spaceè¿›è¡Œæ¸…ç†ï¼Œæ‰€ä»¥å¦‚æœä½ çš„APPä¼šLOADå¾ˆå¤šCLASSçš„è¯,å°±å¾ˆå¯èƒ½å‡ºç°PermGen spaceé”™è¯¯ã€‚</p>
<h4 id="JVMå†…å­˜é™åˆ¶-æœ€å¤§å€¼"><a href="#JVMå†…å­˜é™åˆ¶-æœ€å¤§å€¼" class="headerlink" title="JVMå†…å­˜é™åˆ¶(æœ€å¤§å€¼)"></a>JVMå†…å­˜é™åˆ¶(æœ€å¤§å€¼)</h4><p>é¦–å…ˆJVMå†…å­˜é™åˆ¶äºå®é™…çš„æœ€å¤§ç‰©ç†å†…å­˜ï¼Œå‡è®¾ç‰©ç†å†…å­˜æ— é™å¤§çš„è¯ï¼ŒJVMå†…å­˜çš„æœ€å¤§å€¼è·Ÿæ“ä½œç³»ç»Ÿæœ‰å¾ˆå¤§çš„å…³ç³»ã€‚ç®€å•çš„è¯´å°±32ä½å¤„ç†å™¨è™½ç„¶å¯æ§å†…å­˜ç©ºé—´æœ‰4GB,ä½†æ˜¯å…·ä½“çš„æ“ä½œç³»ç»Ÿä¼šç»™ä¸€ä¸ªé™åˆ¶ï¼Œè¿™ä¸ªé™åˆ¶ä¸€èˆ¬æ˜¯2GB-3GBï¼ˆä¸€èˆ¬æ¥è¯´Windowsç³»ç»Ÿä¸‹ä¸º1.5G-2Gï¼ŒLinuxç³»ç»Ÿ ä¸‹ä¸º2G-3Gï¼‰ï¼Œè€Œ64bitä»¥ä¸Šçš„å¤„ç†å™¨å°±ä¸ä¼šæœ‰é™åˆ¶äº†ã€‚</p>
<h3 id="ä¸‰ç§å†…å­˜æº¢å‡ºå¼‚å¸¸ä»‹ç»"><a href="#ä¸‰ç§å†…å­˜æº¢å‡ºå¼‚å¸¸ä»‹ç»" class="headerlink" title="ä¸‰ç§å†…å­˜æº¢å‡ºå¼‚å¸¸ä»‹ç»"></a>ä¸‰ç§å†…å­˜æº¢å‡ºå¼‚å¸¸ä»‹ç»</h3><h4 id="OutOfMemoryErrorï¼šJava-heap-space-å †æº¢å‡º"><a href="#OutOfMemoryErrorï¼šJava-heap-space-å †æº¢å‡º" class="headerlink" title="OutOfMemoryErrorï¼šJava heap space å †æº¢å‡º"></a>OutOfMemoryErrorï¼šJava heap space å †æº¢å‡º</h4><p>å†…å­˜æº¢å‡ºä¸»è¦å­˜åœ¨é—®é¢˜å°±æ˜¯å‡ºç°åœ¨è¿™ä¸ªæƒ…å†µä¸­ã€‚å½“åœ¨JVMä¸­å¦‚æœ98ï¼…çš„æ—¶é—´æ˜¯ç”¨äºGCä¸”å¯ç”¨çš„ Heap size ä¸è¶³2ï¼…çš„æ—¶å€™å°†æŠ›å‡ºæ­¤å¼‚å¸¸ä¿¡æ¯ã€‚</p>
<h4 id="OutOfMemoryErrorï¼šPermGen-space-éå †æº¢å‡ºï¼ˆæ°¸ä¹…ä¿å­˜åŒºåŸŸæº¢å‡ºï¼‰"><a href="#OutOfMemoryErrorï¼šPermGen-space-éå †æº¢å‡ºï¼ˆæ°¸ä¹…ä¿å­˜åŒºåŸŸæº¢å‡ºï¼‰" class="headerlink" title="OutOfMemoryErrorï¼šPermGen space éå †æº¢å‡ºï¼ˆæ°¸ä¹…ä¿å­˜åŒºåŸŸæº¢å‡ºï¼‰"></a>OutOfMemoryErrorï¼šPermGen space éå †æº¢å‡ºï¼ˆæ°¸ä¹…ä¿å­˜åŒºåŸŸæº¢å‡ºï¼‰</h4><p>è¿™ç§é”™è¯¯å¸¸è§åœ¨webæœåŠ¡å™¨å¯¹JSPè¿›è¡Œpre compileçš„æ—¶å€™ã€‚å¦‚æœä½ çš„WEB APPä¸‹éƒ½ç”¨äº†å¤§é‡çš„ç¬¬ä¸‰æ–¹jar, å…¶å¤§å°è¶…è¿‡äº†jvmé»˜è®¤çš„å¤§å°(4M)é‚£ä¹ˆå°±ä¼šäº§ç”Ÿæ­¤é”™è¯¯ä¿¡æ¯äº†ã€‚å¦‚æœweb appç”¨äº†å¤§é‡çš„ç¬¬ä¸‰æ–¹jaræˆ–è€…åº”ç”¨æœ‰å¤ªå¤šçš„classæ–‡ä»¶è€Œæ°å¥½MaxPermSizeè®¾ç½®è¾ƒå°ï¼Œè¶…å‡ºäº†ä¹Ÿä¼šå¯¼è‡´è¿™å—å†…å­˜çš„å ç”¨è¿‡å¤šé€ æˆæº¢å‡ºï¼Œæˆ–è€…tomcatçƒ­éƒ¨ç½²æ—¶ä¾¯ä¸ä¼šæ¸…ç†å‰é¢åŠ è½½çš„ç¯å¢ƒï¼Œåªä¼šå°†contextæ›´æ”¹ä¸ºæ–°éƒ¨ç½²çš„ï¼Œéå †å­˜çš„å†…å®¹å°±ä¼šè¶Šæ¥è¶Šå¤šã€‚</p>
<h4 id="OutOfMemoryErrorï¼šunable-to-create-new-native-thread-æ— æ³•åˆ›å»ºæ–°çš„çº¿ç¨‹"><a href="#OutOfMemoryErrorï¼šunable-to-create-new-native-thread-æ— æ³•åˆ›å»ºæ–°çš„çº¿ç¨‹" class="headerlink" title="OutOfMemoryErrorï¼šunable to create new native thread. æ— æ³•åˆ›å»ºæ–°çš„çº¿ç¨‹"></a>OutOfMemoryErrorï¼šunable to create new native thread. æ— æ³•åˆ›å»ºæ–°çš„çº¿ç¨‹</h4><p>è¿™ç§ç°è±¡æ¯”è¾ƒå°‘è§ï¼Œä¹Ÿæ¯”è¾ƒå¥‡æ€ªï¼Œä¸»è¦æ˜¯å’Œjvmä¸ç³»ç»Ÿå†…å­˜çš„æ¯”ä¾‹æœ‰å…³ã€‚è¿™ç§æ€ªäº‹æ˜¯å› ä¸ºJVMå·²ç»è¢«ç³»ç»Ÿåˆ†é…äº†å¤§é‡çš„å†…å­˜ï¼ˆæ¯”å¦‚1.5Gï¼‰ï¼Œå¹¶ä¸”å®ƒè‡³å°‘è¦å ç”¨å¯ç”¨å†…å­˜çš„ä¸€åŠã€‚</p>
<h3 id="Java-JVMå†…å­˜é…ç½®"><a href="#Java-JVMå†…å­˜é…ç½®" class="headerlink" title="Java JVMå†…å­˜é…ç½®"></a>Java JVMå†…å­˜é…ç½®</h3><p>åœ¨Linuxä¸‹è®¾ç½®Tomcatçš„javaè™šæ‹Ÿæœºå†…å­˜</p>
<ul>
<li>æŸ¥çœ‹<code>catalina.sh</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">121 if [ -r &quot;$CATALINA_BASE/bin/setenv.sh&quot; ]; then</div><div class="line">122   . &quot;$CATALINA_BASE/bin/setenv.sh&quot;</div><div class="line">123 elif [ -r &quot;$CATALINA_HOME/bin/setenv.sh&quot; ]; then</div><div class="line">124   . &quot;$CATALINA_HOME/bin/setenv.sh&quot;</div><div class="line">125 fi</div></pre></td></tr></table></figure>
<ul>
<li>åœ¨tomcatçš„binç›®å½•ä¸‹æŸ¥çœ‹æ˜¯å¦æœ‰<code>setenv.sh</code>,å¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºï¼Œç„¶åæ·»åŠ å¦‚ä¸‹å†…å®¹</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">export JAVA_OPTS=&apos;-XX:PermSize=128m -XX:MaxPermSize=256m  -Xms512m -Xmx1024m -Xmn386M -Xss228k -XX:SurvivorRatio=8 -XX:MaxTenuringThreshold=8 -XX:ParallelGCThreads=4 -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSParallelRemarkEnabled -XX:+CMSClassUnloadingEnabled -XX:+CMSPermGenSweepingEnabled  -XX:CMSInitiatingOccupancyFraction=70 -XX:CMSFullGCsBeforeCompaction=5 -XX:+UseCMSCompactAtFullCollection -XX:-HeapDumpOnOutOfMemoryError -Xloggc:/srv/tomcat-forum-topic/logs/gc.log -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCApplicationStoppedTime -XX:+PrintGCApplicationConcurrentTime -Xdebug -Xrunjdwp:transport=dt_socket,address=10136,server=y,suspend=n -Djava.rmi.server.hostname=192.168.3.57 -Dcom.sun.management.jmxremote.port=10009 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false&apos;</div></pre></td></tr></table></figure>
<h4 id="å‚æ•°è¯´æ˜"><a href="#å‚æ•°è¯´æ˜" class="headerlink" title="å‚æ•°è¯´æ˜"></a>å‚æ•°è¯´æ˜</h4><ul>
<li><code>-XX:PermSize</code>ï¼šè®¾å®šå†…å­˜çš„æ°¸ä¹…ä¿å­˜åŒºåŸŸï¼›</li>
<li><code>-XX:MaxPermSize</code>ï¼šè®¾å®šæœ€å¤§å†…å­˜çš„æ°¸ä¹…ä¿å­˜åŒºåŸŸï¼›</li>
<li><code>-Xms</code>ï¼š Java Heapåˆå§‹å€¼ï¼ŒServerç«¯JVMæœ€å¥½å°†-Xmså’Œ-Xmxè®¾ä¸ºç›¸åŒå€¼ï¼Œå¼€å‘æµ‹è¯•æœºJVMå¯ä»¥ä¿ç•™é»˜è®¤å€¼ï¼›</li>
<li><code>-Xmx</code>ï¼š Java Heapæœ€å¤§å€¼ï¼Œé»˜è®¤å€¼ä¸ºç‰©ç†å†…å­˜çš„1/4ï¼›</li>
<li><code>-Xmn</code>ï¼š Java Heap YoungåŒºå¤§å°ï¼Œä¸ç†Ÿæ‚‰æœ€å¥½ä¿ç•™é»˜è®¤å€¼ï¼Œä¸€èˆ¬è®¾ç½®ä¸ºXmxçš„3ã€4åˆ†ä¹‹ä¸€ï¼›</li>
<li><code>-Xss</code>ï¼š æ¯ä¸ªçº¿ç¨‹çš„Stackå¤§å°ï¼Œä¸ç†Ÿæ‚‰æœ€å¥½ä¿ç•™é»˜è®¤å€¼ï¼›</li>
<li><code>-XX:NewSize</code>ï¼šè®¾ç½®JVMå †çš„â€˜æ–°ç”Ÿä»£â€™çš„é»˜è®¤å¤§å°ï¼›</li>
<li><code>-XX:MaxNewSize</code>ï¼šè®¾ç½®JVMå †çš„â€˜æ–°ç”Ÿä»£â€™çš„æœ€å¤§å¤§å°ï¼›</li>
<li><code>-XX:SurvivorRatio</code>ï¼šEdenåŒºä¸SurvivoråŒºçš„å¤§å°æ¯”å€¼;è®¾ç½®ä¸º8,åˆ™ä¸¤ä¸ªSurvivoråŒºä¸ä¸€ä¸ªEdenåŒºçš„æ¯”å€¼ä¸º2:8,ä¸€ä¸ªSurvivoråŒºå æ•´ä¸ªå¹´è½»ä»£çš„1/10</li>
<li><code>-XX:MaxTenuringThreshold</code>ï¼šåƒåœ¾æœ€å¤§å¹´é¾„ï¼›å¦‚æœè®¾ç½®ä¸º0çš„è¯,åˆ™å¹´è½»ä»£å¯¹è±¡ä¸ç»è¿‡SurvivoråŒº,ç›´æ¥è¿›å…¥å¹´è€ä»£. å¯¹äºå¹´è€ä»£æ¯”è¾ƒå¤šçš„åº”ç”¨,å¯ä»¥æé«˜æ•ˆç‡.å¦‚æœå°†æ­¤å€¼è®¾ç½®ä¸ºä¸€ä¸ªè¾ƒå¤§å€¼,åˆ™å¹´è½»ä»£å¯¹è±¡ä¼šåœ¨SurvivoråŒºè¿›è¡Œå¤šæ¬¡å¤åˆ¶,è¿™æ ·å¯ä»¥å¢åŠ å¯¹è±¡å†å¹´è½»ä»£çš„å­˜æ´»æ—¶é—´,å¢åŠ åœ¨å¹´è½»ä»£å³è¢«å›æ”¶çš„æ¦‚ç‡ã€‚è¯¥å‚æ•°åªæœ‰åœ¨ä¸²è¡ŒGCæ—¶æ‰æœ‰æ•ˆ.</li>
<li><code>-XX:ParallelGCThreads</code>ï¼šå¹¶è¡Œæ”¶é›†å™¨çš„çº¿ç¨‹æ•°ï¼›æ­¤å€¼æœ€å¥½é…ç½®ä¸å¤„ç†å™¨æ•°ç›®ç›¸ç­‰ åŒæ ·é€‚ç”¨äºCMS</li>
<li><code>-XX:+UseConcMarkSweepGC</code>ï¼šä½¿ç”¨CMSå†…å­˜æ”¶é›†ï¼›</li>
<li><code>-XX:+UseParNewGC</code>ï¼šè®¾ç½®å¹´è½»ä»£ä¸ºå¹¶è¡Œæ”¶é›†ï¼›å¯ä¸CMSæ”¶é›†åŒæ—¶ä½¿ç”¨</li>
<li><code>-XX:+CMSParallelRemarkEnabled</code>ï¼šé™ä½æ ‡è®°åœé¡¿</li>
<li><code>-XX:+CMSClassUnloadingEnabled</code>ï¼šæ˜¾ç¤ºåœ¨ä½¿ç”¨CMS GCæ—¶ï¼ŒæœªåŠ è½½ç±»æ˜¯å¦å¯ç”¨ã€‚JVMè¿›è¡ŒGCæ—¶ä¾¿ä¼šæ¸…é™¤æ°¸ä¹…ä»£ï¼Œå¹¶ä¸”åˆ é™¤ä¸å†ä½¿ç”¨çš„ç±»ï¼Œè¿™ä¸ªé€‰é¡¹åªä¼šåœ¨<code>UseConcMarkSweepGC</code> å¯ç”¨æ—¶æ‰èµ·ä½œç”¨ã€‚</li>
<li><code>-XX:+CMSPermGenSweepingEnabled</code>ï¼šæ˜¾ç¤ºæ¸…é™¤æ°¸ä¹…ä»£æ˜¯å¦å¯ç”¨ã€‚é»˜è®¤æƒ…å†µä¸‹è¿™ä¸ªå‚æ•°æ˜¯ä¸å¯ç”¨çš„ï¼Œæ‰€ä»¥è¦åè°ƒæ°¸ä¹…ä»£é—®é¢˜ï¼Œå°±å¿…é¡»æ˜¾ç¤ºè®¾ç½®è¿™ä¸ªå‚æ•°ã€‚è¿™ä¸ªå‚æ•°åœ¨Java 6é‡Œé¢è¢«åˆ é™¤ï¼Œæ‰€ä»¥å¦‚æœä½ åœ¨ä½¿ç”¨Java 6æˆ–ä»¥ä¸Šç‰ˆæœ¬ï¼Œä½ å°†ä¸å¾—ä¸ä½¿ç”¨ -XX:+CMSClassUnloadingEnabled é€‰é¡¹ã€‚</li>
<li><code>-XX:CMSInitiatingOccupancyFractionï¼70</code>ï¼šä½¿ç”¨cmsä½œä¸ºåƒåœ¾å›æ”¶ï¼Œä½¿ç”¨70ï¼…åå¼€å§‹CMSæ”¶é›†</li>
<li><code>-XX:CMSFullGCsBeforeCompaction=5</code> ï¼šå¤šå°‘æ¬¡åè¿›è¡Œå†…å­˜å‹ç¼©ï¼›ç”±äºå¹¶å‘æ”¶é›†å™¨ä¸å¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©,æ•´ç†,æ‰€ä»¥è¿è¡Œä¸€æ®µæ—¶é—´ä»¥åä¼šäº§ç”Ÿâ€ç¢ç‰‡â€,ä½¿å¾—è¿è¡Œæ•ˆç‡é™ä½.æ­¤å€¼è®¾ç½®è¿è¡Œå¤šå°‘æ¬¡GCä»¥åå¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©,æ•´ç†.</li>
<li><code>-XX:+UseCMSCompactAtFullCollection</code>ï¼šåœ¨FULL GCçš„æ—¶å€™ï¼Œå¯¹å¹´è€ä»£çš„å‹ç¼©ï¼›CMSæ˜¯ä¸ä¼šç§»åŠ¨å†…å­˜çš„ï¼Œå› æ­¤éå¸¸å®¹æ˜“äº§ç”Ÿç¢ç‰‡ï¼Œå¯¼è‡´å†…å­˜ä¸å¤Ÿç”¨ï¼Œå› æ­¤ï¼Œå†…å­˜çš„å‹ç¼©è¿™ä¸ªæ—¶å€™å°±ä¼šè¢«å¯ç”¨ã€‚</li>
<li><code>-XX:HeapDumpOnOutOfMemoryError</code>ï¼šå½“å‘ç”ŸOutOfMemoryErroré”™è¯¯æ—¶ï¼Œæ‰èƒ½è§¦å‘<code>-XX:HeapDumpOnOutOfMemoryError</code> è¾“å‡ºåˆ°<code>-XX:HeapDumpPath</code>æŒ‡å®šä½ç½®ã€‚</li>
<li><code>-Xloggc:/gc.log</code>ï¼šæŒ‡å®šåƒåœ¾æ”¶é›†æ—¥å¿—æ–‡ä»¶</li>
<li><code>-XX:+PrintGCDetails</code>ï¼šæ¯æ¬¡GCæ—¶æ‰“å°è¯¦ç»†ä¿¡æ¯</li>
<li><code>-XX:+PrintGCTimeStamps</code>ï¼šGCå‘ç”Ÿçš„æ—¶é—´</li>
<li><code>XX:+PrintGCApplicationStoppedTime</code>ï¼šGCæ¶ˆè€—äº†å¤šå°‘æ—¶é—´</li>
<li><code>XX:+PrintGCApplicationConcurrentTime</code>ï¼šGCä¹‹é—´è¿è¡Œäº†å¤šå°‘æ—¶é—´</li>
<li><code>-Xdebug -Xrunjdwp:transport=dt_socket,address=10136,server=y,suspend=n</code>ï¼šæ–¹ä¾¿å®¢æˆ·ç«¯è¿œç¨‹è°ƒè¯•</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">-XDebug               å¯ç”¨è°ƒè¯•ã€‚</div><div class="line">-Xnoagent             ç¦ç”¨é»˜è®¤sun.tools.debugè°ƒè¯•å™¨ã€‚</div><div class="line">-Djava.compiler=NONE  ç¦æ­¢ JIT ç¼–è¯‘å™¨çš„åŠ è½½ã€‚</div><div class="line">-Xrunjdwp             åŠ è½½JDWPçš„JPDAå‚è€ƒæ‰§è¡Œå®ä¾‹ã€‚</div><div class="line">transport             ç”¨äºåœ¨è°ƒè¯•ç¨‹åºå’Œ VM ä½¿ç”¨çš„è¿›ç¨‹ä¹‹é—´é€šè®¯ã€‚</div><div class="line">dt_socket             å¥—æ¥å­—ä¼ è¾“ã€‚</div><div class="line">dt_shmem              å…±äº«å†…å­˜ä¼ è¾“ï¼Œä»…é™äº Windowsã€‚</div><div class="line">server=y/n            VM æ˜¯å¦éœ€è¦ä½œä¸ºè°ƒè¯•æœåŠ¡å™¨æ‰§è¡Œã€‚</div><div class="line">address=3999          è°ƒè¯•æœåŠ¡å™¨çš„ç«¯å£å·ï¼Œå®¢æˆ·ç«¯ç”¨æ¥è¿æ¥æœåŠ¡å™¨çš„ç«¯å£å·ã€‚</div><div class="line">suspend=y/n           æ˜¯å¦åœ¨è°ƒè¯•å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ä¹‹åå¯åŠ¨ VM ã€‚</div></pre></td></tr></table></figure>
<ul>
<li><code>-Djava.rmi.server.hostname=192.168.3.57</code>ï¼šæŒ‡å®šip</li>
<li><code>-Dcom.sun.management.jmxremote.port=10009</code>ï¼šæŒ‡å®šç«¯å£</li>
<li><code>-Dcom.sun.management.jmxremote.ssl=false</code>ï¼šæŒ‡å®šæ˜¯å¦éœ€è¦å¯†ç éªŒè¯</li>
<li><code>-Dcom.sun.management.jmxremote.authenticate=false</code>ï¼šæŒ‡å®šæ˜¯å¦ä½¿ç”¨ SSL é€šè®¯</li>
</ul>
<p><code>å¤‡æ³¨ï¼šJMX(Java Management Extensions)æ˜¯ä¸€ä¸ªä¸ºåº”ç”¨ç¨‹åºæ¤å…¥ç®¡ç†åŠŸèƒ½çš„æ¡†æ¶,é€šè¿‡ä½¿ç”¨JMXï¼Œæˆ‘ä»¬å¯ä»¥å®æ—¶æŸ¥è¯¢åº”ç”¨ç¨‹åºä¸­é€šè¿‡JMXå‘å¤–å…¬å¸ƒçš„ç›¸åº”å‚æ•°æˆ–è€…æ˜¯å…¶ä»–åº”ç”¨æ•°æ®;å¯ä»¥ä½¿ç”¨Jconsoleç›‘æ§</code></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://blog.csdn.net/ye1992/article/details/9344807" target="_blank" rel="external">Tomcatä¸­JVMå†…å­˜æº¢å‡ºåŠåˆç†é…ç½®</a></p>
<p><a href="http://www.cnblogs.com/redcreen/archive/2011/05/04/2037057.html" target="_blank" rel="external">JVMç³»åˆ—ä¸‰:JVMå‚æ•°è®¾ç½®ã€åˆ†æ</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[RPCä»‹ç»]]></title>
      <url>http://zsr.github.io/2017/06/20/RPC%E4%BB%8B%E7%BB%8D/</url>
      <content type="html"><![CDATA[<p>è½¬è½½:<a href="http://blog.csdn.net/mindfloating/article/details/39474123" target="_blank" rel="external">æ·±å…¥æµ…å‡º RPC - æ·±å…¥ç¯‡</a></p>
<h3 id="RPC-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#RPC-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="RPC æ˜¯ä»€ä¹ˆï¼Ÿ"></a>RPC æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>RPC çš„å…¨ç§°æ˜¯ Remote Procedure Call æ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ã€‚å®ƒå…è®¸ç¨‹åºè°ƒç”¨å¦ä¸€ä¸ªåœ°å€ç©ºé—´ï¼ˆé€šå¸¸æ˜¯å…±äº«ç½‘ç»œçš„å¦ä¸€å°æœºå™¨ä¸Šï¼‰çš„è¿‡ç¨‹æˆ–å‡½æ•°ï¼Œè€Œä¸ç”¨ç¨‹åºå‘˜æ˜¾å¼ç¼–ç è¿™ä¸ªè¿œç¨‹è°ƒç”¨çš„ç»†èŠ‚ã€‚å³ç¨‹åºå‘˜æ— è®ºæ˜¯è°ƒç”¨æœ¬åœ°çš„è¿˜æ˜¯è¿œç¨‹çš„ï¼Œæœ¬è´¨ä¸Šç¼–å†™çš„è°ƒç”¨ä»£ç åŸºæœ¬ç›¸åŒã€‚</p>
<h2 id="RPC-èµ·æº"><a href="#RPC-èµ·æº" class="headerlink" title="RPC èµ·æº"></a>RPC èµ·æº</h2><p>RPC è¿™ä¸ªæ¦‚å¿µæœ¯è¯­åœ¨ä¸Šä¸–çºª 80 å¹´ä»£ç”± <a href="https://en.wikipedia.org/wiki/Bruce_Jay_Nelson" target="_blank" rel="external">Bruce Jay Nelson</a> æå‡ºã€‚åœ¨ Nelson çš„è®ºæ–‡ <a href="http://birrell.org/andrew/papers/ImplementingRPC.pdf" target="_blank" rel="external">â€œImplementing Remote Procedure Callsâ€</a> ä¸­ä»–æåˆ°äº†å‡ ç‚¹ï¼š</p>
<ul>
<li>ç®€å•ï¼šRPC æ¦‚å¿µçš„è¯­ä¹‰ååˆ†æ¸…æ™°å’Œç®€å•ï¼Œè¿™æ ·å»ºç«‹åˆ†å¸ƒå¼è®¡ç®—å°±æ›´å®¹æ˜“ã€‚</li>
<li>é«˜æ•ˆï¼šè¿‡ç¨‹è°ƒç”¨çœ‹èµ·æ¥ååˆ†ç®€å•è€Œä¸”é«˜æ•ˆã€‚</li>
<li>é€šç”¨ï¼šåœ¨å•æœºè®¡ç®—ä¸­è¿‡ç¨‹å¾€å¾€æ˜¯ä¸åŒç®—æ³•éƒ¨åˆ†é—´æœ€é‡è¦çš„é€šä¿¡æœºåˆ¶ã€‚ </li>
</ul>
<p>é€šä¿—ä¸€ç‚¹è¯´ï¼Œå°±æ˜¯ä¸€èˆ¬ç¨‹åºå‘˜å¯¹äºæœ¬åœ°çš„è¿‡ç¨‹è°ƒç”¨å¾ˆç†Ÿæ‚‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬æŠŠ RPC ä½œæˆå’Œæœ¬åœ°è°ƒç”¨å®Œå…¨ç±»ä¼¼ï¼Œé‚£ä¹ˆå°±æ›´å®¹æ˜“è¢«æ¥å—ï¼Œä½¿ç”¨èµ·æ¥æ¯«æ— éšœç¢ã€‚ä»Šå¤©æˆ‘ä»¬ä½¿ç”¨çš„ RPC æ¡†æ¶åŸºæœ¬å°±æ˜¯æŒ‰è¿™ä¸ªç›®æ ‡æ¥å®ç°çš„ã€‚</p>
<h3 id="RPC-ç»“æ„"><a href="#RPC-ç»“æ„" class="headerlink" title="RPC ç»“æ„"></a>RPC ç»“æ„</h3><p>Nelson çš„è®ºæ–‡ä¸­æŒ‡å‡ºå®ç° RPC çš„ç¨‹åºåŒ…æ‹¬ 5 ä¸ªéƒ¨åˆ†ï¼š</p>
<blockquote>
<ol>
<li>User</li>
<li>User-stub</li>
<li>RPCRuntime</li>
<li>Server-stub</li>
<li>Server</li>
</ol>
</blockquote>
<p>è¿™ 5 ä¸ªéƒ¨åˆ†çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="http://img.blog.csdn.net/20150108170924203?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbWluZGZsb2F0aW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="img"><br>è¿™é‡Œ user å°±æ˜¯ client ç«¯ï¼Œå½“ user æƒ³å‘èµ·ä¸€ä¸ªè¿œç¨‹è°ƒç”¨æ—¶ï¼Œå®ƒå®é™…æ˜¯é€šè¿‡æœ¬åœ°è°ƒç”¨ user-stubã€‚user-stub è´Ÿè´£å°†è°ƒç”¨çš„æ¥å£ã€æ–¹æ³•å’Œå‚æ•°é€šè¿‡çº¦å®šçš„åè®®è§„èŒƒè¿›è¡Œç¼–ç å¹¶é€šè¿‡æœ¬åœ°çš„ RPCRuntime å®ä¾‹ä¼ è¾“åˆ°è¿œç«¯çš„å®ä¾‹ã€‚è¿œç«¯ RPCRuntime å®ä¾‹æ”¶åˆ°è¯·æ±‚åäº¤ç»™ server-stub è¿›è¡Œè§£ç åå‘èµ·æœ¬åœ°ç«¯è°ƒç”¨ï¼Œè°ƒç”¨ç»“æœå†è¿”å›ç»™ user ç«¯ã€‚</p>
<h3 id="RPC-åŠŸèƒ½ç›®æ ‡"><a href="#RPC-åŠŸèƒ½ç›®æ ‡" class="headerlink" title="RPC åŠŸèƒ½ç›®æ ‡"></a>RPC åŠŸèƒ½ç›®æ ‡</h3><p><strong>RPC çš„ä¸»è¦åŠŸèƒ½ç›®æ ‡æ˜¯è®©æ„å»ºåˆ†å¸ƒå¼è®¡ç®—ï¼ˆåº”ç”¨ï¼‰æ›´å®¹æ˜“ï¼Œåœ¨æä¾›å¼ºå¤§çš„è¿œç¨‹è°ƒç”¨èƒ½åŠ›æ—¶ä¸æŸå¤±æœ¬åœ°è°ƒç”¨çš„è¯­ä¹‰ç®€æ´æ€§ã€‚</strong>ä¸ºå®ç°è¯¥ç›®æ ‡ï¼ŒRPC æ¡†æ¶éœ€æä¾›ä¸€ç§é€æ˜è°ƒç”¨æœºåˆ¶è®©ä½¿ç”¨è€…ä¸å¿…æ˜¾å¼çš„åŒºåˆ†æœ¬åœ°è°ƒç”¨å’Œè¿œç¨‹è°ƒç”¨ã€‚</p>
<h3 id="RPC-è°ƒç”¨åˆ†ç±»"><a href="#RPC-è°ƒç”¨åˆ†ç±»" class="headerlink" title="RPC è°ƒç”¨åˆ†ç±»"></a>RPC è°ƒç”¨åˆ†ç±»</h3><p>RPCè°ƒç”¨åˆ†ä»¥ä¸‹ä¸¤ç§ï¼š</p>
<ol>
<li><p>åŒæ­¥è°ƒç”¨  </p>
<p>å®¢æˆ·æ–¹ç­‰å¾…è°ƒç”¨æ‰§è¡Œå®Œæˆå¹¶è¿”å›ç»“æœã€‚  </p>
</li>
<li><p>å¼‚æ­¥è°ƒç”¨  </p>
<p>å®¢æˆ·æ–¹è°ƒç”¨åä¸ç”¨ç­‰å¾…æ‰§è¡Œç»“æœè¿”å›ï¼Œä½†ä¾ç„¶å¯ä»¥é€šè¿‡å›è°ƒé€šçŸ¥ç­‰æ–¹å¼è·å–è¿”å›ç»“æœã€‚  </p>
<p>è‹¥å®¢æˆ·æ–¹ä¸å…³å¿ƒè°ƒç”¨è¿”å›ç»“æœï¼Œåˆ™å˜æˆå•å‘å¼‚æ­¥è°ƒç”¨ï¼Œå•å‘è°ƒç”¨ä¸ç”¨è¿”å›ç»“æœã€‚  </p>
</li>
</ol>
<p>å¼‚æ­¥å’ŒåŒæ­¥çš„åŒºåˆ†åœ¨äºæ˜¯å¦ç­‰å¾…æœåŠ¡ç«¯æ‰§è¡Œå®Œæˆå¹¶è¿”å›ç»“æœã€‚</p>
<h3 id="RPC-ç»“æ„æ‹†è§£"><a href="#RPC-ç»“æ„æ‹†è§£" class="headerlink" title="RPC ç»“æ„æ‹†è§£"></a>RPC ç»“æ„æ‹†è§£</h3><p><img src="http://img.blog.csdn.net/20150108170231000?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbWluZGZsb2F0aW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="img"></p>
<p>RPCæœåŠ¡æ–¹é€šè¿‡ <code>RpcServer</code> å»å¯¼å‡ºï¼ˆexportï¼‰è¿œç¨‹æ¥å£æ–¹æ³•ï¼Œè€Œå®¢æˆ·æ–¹é€šè¿‡ <code>RpcClient</code> å»å¼•å…¥ï¼ˆimportï¼‰è¿œç¨‹æ¥å£æ–¹æ³•ã€‚å®¢æˆ·æ–¹åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·å»è°ƒç”¨è¿œç¨‹æ¥å£æ–¹æ³•ï¼ŒRPC æ¡†æ¶æä¾›æ¥å£çš„ä»£ç†å®ç°ï¼Œå®é™…çš„è°ƒç”¨å°†å§”æ‰˜ç»™ä»£ç†<code>RpcProxy</code> ã€‚ä»£ç†å°è£…è°ƒç”¨ä¿¡æ¯å¹¶å°†è°ƒç”¨è½¬äº¤ç»™<code>RpcInvoker</code> å»å®é™…æ‰§è¡Œã€‚åœ¨å®¢æˆ·ç«¯çš„<code>RpcInvoker</code> é€šè¿‡è¿æ¥å™¨<code>RpcConnector</code> å»ç»´æŒä¸æœåŠ¡ç«¯çš„é€šé“<code>RpcChannel</code>ï¼Œå¹¶ä½¿ç”¨<code>RpcProtocol</code> æ‰§è¡Œåè®®ç¼–ç ï¼ˆencodeï¼‰å¹¶å°†ç¼–ç åçš„è¯·æ±‚æ¶ˆæ¯é€šè¿‡é€šé“å‘é€ç»™æœåŠ¡æ–¹ã€‚</p>
<p>RPC æœåŠ¡ç«¯æ¥æ”¶å™¨ <code>RpcAcceptor</code> æ¥æ”¶å®¢æˆ·ç«¯çš„è°ƒç”¨è¯·æ±‚ï¼ŒåŒæ ·ä½¿ç”¨<code>RpcProtocol</code> æ‰§è¡Œåè®®è§£ç ï¼ˆdecodeï¼‰ã€‚è§£ç åçš„è°ƒç”¨ä¿¡æ¯ä¼ é€’ç»™<code>RpcProcessor</code> å»æ§åˆ¶å¤„ç†è°ƒç”¨è¿‡ç¨‹ï¼Œæœ€åå†å§”æ‰˜è°ƒç”¨ç»™<code>RpcInvoker</code> å»å®é™…æ‰§è¡Œå¹¶è¿”å›è°ƒç”¨ç»“æœã€‚</p>
<h3 id="RPC-ç»„ä»¶èŒè´£"><a href="#RPC-ç»„ä»¶èŒè´£" class="headerlink" title="RPC ç»„ä»¶èŒè´£"></a>RPC ç»„ä»¶èŒè´£</h3><p>ä¸‹é¢è¯¦ç»†è¯´æ˜ä¸‹æ¯ä¸ªç»„ä»¶çš„èŒè´£åˆ’åˆ†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">1. RpcServer  </div><div class="line">   è´Ÿè´£å¯¼å‡ºï¼ˆexportï¼‰è¿œç¨‹æ¥å£  </div><div class="line">2. RpcClient  </div><div class="line">   è´Ÿè´£å¯¼å…¥ï¼ˆimportï¼‰è¿œç¨‹æ¥å£çš„ä»£ç†å®ç°  </div><div class="line">3. RpcProxy  </div><div class="line">   è¿œç¨‹æ¥å£çš„ä»£ç†å®ç°  </div><div class="line">4. RpcInvoker  </div><div class="line">   å®¢æˆ·æ–¹å®ç°ï¼šè´Ÿè´£ç¼–ç è°ƒç”¨ä¿¡æ¯å’Œå‘é€è°ƒç”¨è¯·æ±‚åˆ°æœåŠ¡æ–¹å¹¶ç­‰å¾…è°ƒç”¨ç»“æœè¿”å›  </div><div class="line">   æœåŠ¡æ–¹å®ç°ï¼šè´Ÿè´£è°ƒç”¨æœåŠ¡ç«¯æ¥å£çš„å…·ä½“å®ç°å¹¶è¿”å›è°ƒç”¨ç»“æœ  </div><div class="line">5. RpcProtocol  </div><div class="line">   è´Ÿè´£åè®®ç¼–/è§£ç   </div><div class="line">6. RpcConnector  </div><div class="line">   è´Ÿè´£ç»´æŒå®¢æˆ·æ–¹å’ŒæœåŠ¡æ–¹çš„è¿æ¥é€šé“å’Œå‘é€æ•°æ®åˆ°æœåŠ¡æ–¹  </div><div class="line">7. RpcAcceptor  </div><div class="line">   è´Ÿè´£æ¥æ”¶å®¢æˆ·æ–¹è¯·æ±‚å¹¶è¿”å›è¯·æ±‚ç»“æœ  </div><div class="line">8. RpcProcessor  </div><div class="line">   è´Ÿè´£åœ¨æœåŠ¡æ–¹æ§åˆ¶è°ƒç”¨è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ç®¡ç†è°ƒç”¨çº¿ç¨‹æ± ã€è¶…æ—¶æ—¶é—´ç­‰  </div><div class="line">9. RpcChannel  </div><div class="line">   æ•°æ®ä¼ è¾“é€šé“</div></pre></td></tr></table></figure>
<h3 id="RPC-å®ç°åˆ†æ"><a href="#RPC-å®ç°åˆ†æ" class="headerlink" title="RPC å®ç°åˆ†æ"></a>RPC å®ç°åˆ†æ</h3><h4 id="å¯¼å‡ºè¿œç¨‹æ¥å£"><a href="#å¯¼å‡ºè¿œç¨‹æ¥å£" class="headerlink" title="å¯¼å‡ºè¿œç¨‹æ¥å£"></a>å¯¼å‡ºè¿œç¨‹æ¥å£</h4><p>å¯¼å‡ºè¿œç¨‹æ¥å£çš„æ„æ€æ˜¯æŒ‡åªæœ‰å¯¼å‡ºçš„æ¥å£å¯ä»¥ä¾›è¿œç¨‹è°ƒç”¨ï¼Œè€Œæœªå¯¼å‡ºçš„æ¥å£åˆ™ä¸èƒ½ã€‚åœ¨ java ä¸­å¯¼å‡ºæ¥å£çš„ä»£ç ç‰‡æ®µå¯èƒ½å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">DemoService demo   = <span class="keyword">new</span> DemoService();  </div><div class="line">RpcServer  server = <span class="keyword">new</span> RpcServer();  </div><div class="line">server.export(DemoService.class, demo, options);</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥å¯¼å‡ºæ•´ä¸ªæ¥å£ï¼Œä¹Ÿå¯ä»¥æ›´ç»†ç²’åº¦ä¸€ç‚¹åªå¯¼å‡ºæ¥å£ä¸­çš„æŸäº›æ–¹æ³•ï¼Œå¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// åªå¯¼å‡º DemoService ä¸­ç­¾åä¸º hi(String s) çš„æ–¹æ³•  </span></div><div class="line">server.export(DemoService.class, demo, <span class="string">"hi"</span>, <span class="keyword">new</span> Class&lt;?&gt;[] &#123; String.class &#125;, options);</div></pre></td></tr></table></figure>
<p>java ä¸­è¿˜æœ‰ä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„è°ƒç”¨å°±æ˜¯å¤šæ€ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ¥å£å¯èƒ½æœ‰å¤šä¸ªå®ç°ï¼Œé‚£ä¹ˆè¿œç¨‹è°ƒç”¨æ—¶åˆ°åº•è°ƒç”¨å“ªä¸ªï¼Ÿè¿™ä¸ªæœ¬åœ°è°ƒç”¨çš„è¯­ä¹‰æ˜¯é€šè¿‡ jvm æä¾›çš„å¼•ç”¨å¤šæ€æ€§éšå¼å®ç°çš„ï¼Œé‚£ä¹ˆå¯¹äº RPC æ¥è¯´è·¨è¿›ç¨‹çš„è°ƒç”¨å°±æ²¡æ³•éšå¼å®ç°äº†ã€‚å¦‚æœå‰é¢<code>DemoService</code> æ¥å£æœ‰ 2 ä¸ªå®ç°ï¼Œé‚£ä¹ˆåœ¨å¯¼å‡ºæ¥å£æ—¶å°±éœ€è¦ç‰¹æ®Šæ ‡è®°ä¸åŒçš„å®ç°ï¼Œå¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">DemoService demo   = <span class="keyword">new</span> DemoService();  </div><div class="line">DemoService demo2  = <span class="keyword">new</span> DemoService();  </div><div class="line">RpcServer   server = <span class="keyword">new</span> RpcServer();  </div><div class="line">server.export(DemoService.class, demo, options);  </div><div class="line">server.export(<span class="string">"demo2"</span>, DemoService.class, demo2, options);</div></pre></td></tr></table></figure>
<p>ä¸Šé¢ demo2 æ˜¯å¦ä¸€ä¸ªå®ç°ï¼Œæˆ‘ä»¬æ ‡è®°ä¸º â€œdemo2â€ æ¥å¯¼å‡ºï¼Œé‚£ä¹ˆè¿œç¨‹è°ƒç”¨æ—¶ä¹Ÿéœ€è¦ä¼ é€’è¯¥æ ‡è®°æ‰èƒ½è°ƒç”¨åˆ°æ­£ç¡®çš„å®ç°ç±»ï¼Œè¿™æ ·å°±è§£å†³äº†å¤šæ€è°ƒç”¨çš„è¯­ä¹‰ã€‚</p>
<h4 id="å¯¼å…¥è¿œç¨‹æ¥å£ä¸å®¢æˆ·ç«¯ä»£ç†"><a href="#å¯¼å…¥è¿œç¨‹æ¥å£ä¸å®¢æˆ·ç«¯ä»£ç†" class="headerlink" title="å¯¼å…¥è¿œç¨‹æ¥å£ä¸å®¢æˆ·ç«¯ä»£ç†"></a>å¯¼å…¥è¿œç¨‹æ¥å£ä¸å®¢æˆ·ç«¯ä»£ç†</h4><p>å¯¼å…¥ç›¸å¯¹äºå¯¼å‡ºè¿œç¨‹æ¥å£ï¼Œå®¢æˆ·ç«¯ä»£ç ä¸ºäº†èƒ½å¤Ÿå‘èµ·è°ƒç”¨å¿…é¡»è¦è·å¾—è¿œç¨‹æ¥å£çš„æ–¹æ³•æˆ–è¿‡ç¨‹å®šä¹‰ã€‚ç›®å‰ï¼Œå¤§éƒ¨åˆ†è·¨è¯­è¨€å¹³å° RPC æ¡†æ¶é‡‡ç”¨æ ¹æ® IDL å®šä¹‰é€šè¿‡ code generator å»ç”Ÿæˆ stub ä»£ç ï¼Œè¿™ç§æ–¹å¼ä¸‹å®é™…å¯¼å…¥çš„è¿‡ç¨‹å°±æ˜¯é€šè¿‡ä»£ç ç”Ÿæˆå™¨åœ¨ç¼–è¯‘æœŸå®Œæˆçš„ã€‚</p>
<p>ä»£ç ç”Ÿæˆçš„æ–¹å¼å¯¹è·¨è¯­è¨€å¹³å° RPC æ¡†æ¶è€Œè¨€æ˜¯å¿…ç„¶çš„é€‰æ‹©ï¼Œè€Œå¯¹äºåŒä¸€è¯­è¨€å¹³å°çš„ RPC åˆ™å¯ä»¥é€šè¿‡å…±äº«æ¥å£å®šä¹‰æ¥å®ç°ã€‚åœ¨ java ä¸­å¯¼å…¥æ¥å£çš„ä»£ç ç‰‡æ®µå¯èƒ½å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RpcClient client = <span class="keyword">new</span> RpcClient();  </div><div class="line">DemoService demo = client.refer(DemoService.class);  </div><div class="line">demo.hi(<span class="string">"how are you?"</span>);</div></pre></td></tr></table></figure>
<p>åœ¨ java ä¸­ â€˜importâ€™ æ˜¯å…³é”®å­—ï¼Œæ‰€ä»¥ä»£ç ç‰‡æ®µä¸­æˆ‘ä»¬ç”¨ refer æ¥è¡¨è¾¾å¯¼å…¥æ¥å£çš„æ„æ€ã€‚è¿™é‡Œçš„å¯¼å…¥æ–¹å¼æœ¬è´¨ä¹Ÿæ˜¯ä¸€ç§ä»£ç ç”ŸæˆæŠ€æœ¯ï¼Œåªä¸è¿‡æ˜¯åœ¨è¿è¡Œæ—¶ç”Ÿæˆï¼Œæ¯”é™æ€ç¼–è¯‘æœŸçš„ä»£ç ç”Ÿæˆçœ‹èµ·æ¥æ›´ç®€æ´äº›ã€‚</p>
<h4 id="åè®®ç¼–è§£ç "><a href="#åè®®ç¼–è§£ç " class="headerlink" title="åè®®ç¼–è§£ç "></a>åè®®ç¼–è§£ç </h4><p>å®¢æˆ·ç«¯ä»£ç†åœ¨å‘èµ·è°ƒç”¨å‰éœ€è¦å¯¹è°ƒç”¨ä¿¡æ¯è¿›è¡Œç¼–ç ï¼Œè¿™å°±è¦è€ƒè™‘éœ€è¦ç¼–ç äº›ä»€ä¹ˆä¿¡æ¯å¹¶ä»¥ä»€ä¹ˆæ ¼å¼ä¼ è¾“åˆ°æœåŠ¡ç«¯æ‰èƒ½è®©æœåŠ¡ç«¯å®Œæˆè°ƒç”¨ã€‚å‡ºäºæ•ˆç‡è€ƒè™‘ï¼Œç¼–ç çš„ä¿¡æ¯è¶Šå°‘è¶Šå¥½ï¼ˆä¼ è¾“æ•°æ®å°‘ï¼‰ï¼Œç¼–ç çš„è§„åˆ™è¶Šç®€å•è¶Šå¥½ï¼ˆæ‰§è¡Œæ•ˆç‡é«˜ï¼‰ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸‹éœ€è¦ç¼–ç äº›ä»€ä¹ˆä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">-- è°ƒç”¨ç¼–ç  --  </div><div class="line">1. æ¥å£æ–¹æ³•  </div><div class="line">   åŒ…æ‹¬æ¥å£åã€æ–¹æ³•å  </div><div class="line">2. æ–¹æ³•å‚æ•°  </div><div class="line">   åŒ…æ‹¬å‚æ•°ç±»å‹ã€å‚æ•°å€¼  </div><div class="line">3. è°ƒç”¨å±æ€§  </div><div class="line">   åŒ…æ‹¬è°ƒç”¨å±æ€§ä¿¡æ¯ï¼Œä¾‹å¦‚è°ƒç”¨é™„ä»¶éšå¼å‚æ•°ã€è°ƒç”¨è¶…æ—¶æ—¶é—´ç­‰  </div><div class="line">  </div><div class="line">-- è¿”å›ç¼–ç  --  </div><div class="line">1. è¿”å›ç»“æœ  </div><div class="line">   æ¥å£æ–¹æ³•ä¸­å®šä¹‰çš„è¿”å›å€¼  </div><div class="line">2. è¿”å›ç   </div><div class="line">   å¼‚å¸¸è¿”å›ç   </div><div class="line">3. è¿”å›å¼‚å¸¸ä¿¡æ¯  </div><div class="line">   è°ƒç”¨å¼‚å¸¸ä¿¡æ¯</div></pre></td></tr></table></figure>
<p>é™¤äº†ä»¥ä¸Šè¿™äº›å¿…é¡»çš„è°ƒç”¨ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜éœ€è¦ä¸€äº›å…ƒä¿¡æ¯ä»¥æ–¹ä¾¿ç¨‹åºç¼–è§£ç ä»¥åŠæœªæ¥å¯èƒ½çš„æ‰©å±•ã€‚è¿™æ ·æˆ‘ä»¬çš„ç¼–ç æ¶ˆæ¯é‡Œé¢å°±åˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯å…ƒä¿¡æ¯ã€å¦ä¸€éƒ¨åˆ†æ˜¯è°ƒç”¨çš„å¿…è¦ä¿¡æ¯ã€‚å¦‚æœè®¾è®¡ä¸€ç§ RPC åè®®æ¶ˆæ¯çš„è¯ï¼Œå…ƒä¿¡æ¯æˆ‘ä»¬æŠŠå®ƒæ”¾åœ¨åè®®æ¶ˆæ¯å¤´ä¸­ï¼Œè€Œå¿…è¦ä¿¡æ¯æ”¾åœ¨åè®®æ¶ˆæ¯ä½“ä¸­ã€‚ä¸‹é¢ç»™å‡ºä¸€ç§æ¦‚å¿µä¸Šçš„ RPC åè®®æ¶ˆæ¯è®¾è®¡æ ¼å¼ï¼š</p>
<p><img src="http://img.blog.csdn.net/20150108170315663?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbWluZGZsb2F0aW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">-- æ¶ˆæ¯å¤´ --  </div><div class="line">magic      : åè®®é­”æ•°ï¼Œä¸ºè§£ç è®¾è®¡  </div><div class="line">header size: åè®®å¤´é•¿åº¦ï¼Œä¸ºæ‰©å±•è®¾è®¡  </div><div class="line">version    : åè®®ç‰ˆæœ¬ï¼Œä¸ºå…¼å®¹è®¾è®¡  </div><div class="line">st         : æ¶ˆæ¯ä½“åºåˆ—åŒ–ç±»å‹  </div><div class="line">hb         : å¿ƒè·³æ¶ˆæ¯æ ‡è®°ï¼Œä¸ºé•¿è¿æ¥ä¼ è¾“å±‚å¿ƒè·³è®¾è®¡  </div><div class="line">ow         : å•å‘æ¶ˆæ¯æ ‡è®°ï¼Œ  </div><div class="line">rp         : å“åº”æ¶ˆæ¯æ ‡è®°ï¼Œä¸ç½®ä½é»˜è®¤æ˜¯è¯·æ±‚æ¶ˆæ¯  </div><div class="line">status code: å“åº”æ¶ˆæ¯çŠ¶æ€ç   </div><div class="line">reserved   : ä¸ºå­—èŠ‚å¯¹é½ä¿ç•™  </div><div class="line">message id : æ¶ˆæ¯ id  </div><div class="line">body size  : æ¶ˆæ¯ä½“é•¿åº¦  </div><div class="line">  </div><div class="line">-- æ¶ˆæ¯ä½“ --  </div><div class="line">é‡‡ç”¨åºåˆ—åŒ–ç¼–ç ï¼Œå¸¸è§æœ‰ä»¥ä¸‹æ ¼å¼  </div><div class="line">xml   : å¦‚ webservie soap  </div><div class="line">json  : å¦‚ JSON-RPC  </div><div class="line">binary: å¦‚ thrift; hession; kryo ç­‰</div></pre></td></tr></table></figure>
<p>æ ¼å¼ç¡®å®šåç¼–è§£ç å°±ç®€å•äº†ï¼Œç”±äºå¤´é•¿åº¦ä¸€å®šæ‰€ä»¥æˆ‘ä»¬æ¯”è¾ƒå…³å¿ƒçš„å°±æ˜¯æ¶ˆæ¯ä½“çš„åºåˆ—åŒ–æ–¹å¼ã€‚åºåˆ—åŒ–æˆ‘ä»¬å…³å¿ƒä¸‰ä¸ªæ–¹é¢ï¼š</p>
<ol>
<li>åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ•ˆç‡ï¼Œè¶Šå¿«è¶Šå¥½ã€‚ </li>
<li>åºåˆ—åŒ–åçš„å­—èŠ‚é•¿åº¦ï¼Œè¶Šå°è¶Šå¥½ã€‚ </li>
<li>åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å…¼å®¹æ€§ï¼Œæ¥å£å‚æ•°å¯¹è±¡è‹¥å¢åŠ äº†å­—æ®µï¼Œæ˜¯å¦å…¼å®¹ã€‚</li>
</ol>
<h4 id="ä¼ è¾“æœåŠ¡"><a href="#ä¼ è¾“æœåŠ¡" class="headerlink" title="ä¼ è¾“æœåŠ¡"></a>ä¼ è¾“æœåŠ¡</h4><p>åè®®ç¼–ç ä¹‹åï¼Œè‡ªç„¶å°±æ˜¯éœ€è¦å°†ç¼–ç åçš„ RPC è¯·æ±‚æ¶ˆæ¯ä¼ è¾“åˆ°æœåŠ¡æ–¹ï¼ŒæœåŠ¡æ–¹æ‰§è¡Œåè¿”å›ç»“æœæ¶ˆæ¯æˆ–ç¡®è®¤æ¶ˆæ¯ç»™å®¢æˆ·æ–¹ã€‚RPC çš„åº”ç”¨åœºæ™¯å®è´¨æ˜¯ä¸€ç§å¯é çš„è¯·æ±‚åº”ç­”æ¶ˆæ¯æµï¼Œå’Œ HTTP ç±»ä¼¼ã€‚å› æ­¤é€‰æ‹©é•¿è¿æ¥æ–¹å¼çš„ TCP åè®®ä¼šæ›´é«˜æ•ˆï¼Œä¸ HTTP ä¸åŒçš„æ˜¯åœ¨åè®®å±‚é¢æˆ‘ä»¬å®šä¹‰äº†æ¯ä¸ªæ¶ˆæ¯çš„å”¯ä¸€ idï¼Œå› æ­¤å¯ä»¥æ›´å®¹æ˜“çš„å¤ç”¨è¿æ¥ã€‚</p>
<p>æ—¢ç„¶ä½¿ç”¨é•¿è¿æ¥ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯åˆ°åº• client å’Œ server ä¹‹é—´éœ€è¦å¤šå°‘æ ¹è¿æ¥ï¼Ÿå®é™…ä¸Šå•è¿æ¥å’Œå¤šè¿æ¥åœ¨ä½¿ç”¨ä¸Šæ²¡æœ‰åŒºåˆ«ï¼Œå¯¹äºæ•°æ®ä¼ è¾“é‡è¾ƒå°çš„åº”ç”¨ç±»å‹ï¼Œå•è¿æ¥åŸºæœ¬è¶³å¤Ÿã€‚å•è¿æ¥å’Œå¤šè¿æ¥æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼Œæ¯æ ¹è¿æ¥éƒ½æœ‰è‡ªå·±ç§æœ‰çš„å‘é€å’Œæ¥æ”¶ç¼“å†²åŒºï¼Œå› æ­¤å¤§æ•°æ®é‡ä¼ è¾“æ—¶åˆ†æ•£åœ¨ä¸åŒçš„è¿æ¥ç¼“å†²åŒºä¼šå¾—åˆ°æ›´å¥½çš„ååæ•ˆç‡ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ çš„æ•°æ®ä¼ è¾“é‡ä¸è¶³ä»¥è®©å•è¿æ¥çš„ç¼“å†²åŒºä¸€ç›´å¤„äºé¥±å’ŒçŠ¶æ€çš„è¯ï¼Œé‚£ä¹ˆä½¿ç”¨å¤šè¿æ¥å¹¶ä¸ä¼šäº§ç”Ÿä»»ä½•æ˜æ˜¾çš„æå‡ï¼Œåè€Œä¼šå¢åŠ è¿æ¥ç®¡ç†çš„å¼€é”€ã€‚</p>
<p>è¿æ¥æ˜¯ç”± client ç«¯å‘èµ·å»ºç«‹å¹¶ç»´æŒã€‚å¦‚æœ client å’Œ server ä¹‹é—´æ˜¯ç›´è¿çš„ï¼Œé‚£ä¹ˆè¿æ¥ä¸€èˆ¬ä¸ä¼šä¸­æ–­ï¼ˆå½“ç„¶ç‰©ç†é“¾è·¯æ•…éšœé™¤å¤–ï¼‰ã€‚å¦‚æœ client å’Œ server è¿æ¥ç»è¿‡ä¸€äº›è´Ÿè½½ä¸­è½¬è®¾å¤‡ï¼Œæœ‰å¯èƒ½è¿æ¥ä¸€æ®µæ—¶é—´ä¸æ´»è·ƒæ—¶ä¼šè¢«è¿™äº›ä¸­é—´è®¾å¤‡ä¸­æ–­ã€‚ä¸ºäº†ä¿æŒè¿æ¥æœ‰å¿…è¦å®šæ—¶ä¸ºæ¯ä¸ªè¿æ¥å‘é€å¿ƒè·³æ•°æ®ä»¥ç»´æŒè¿æ¥ä¸ä¸­æ–­ã€‚å¿ƒè·³æ¶ˆæ¯æ˜¯ RPC æ¡†æ¶åº“ä½¿ç”¨çš„å†…éƒ¨æ¶ˆæ¯ï¼Œåœ¨å‰æ–‡åè®®å¤´ç»“æ„ä¸­ä¹Ÿæœ‰ä¸€ä¸ªä¸“é—¨çš„å¿ƒè·³ä½ï¼Œå°±æ˜¯ç”¨æ¥æ ‡è®°å¿ƒè·³æ¶ˆæ¯çš„ï¼Œå®ƒå¯¹ä¸šåŠ¡åº”ç”¨é€æ˜ã€‚</p>
<h4 id="æ‰§è¡Œè°ƒç”¨"><a href="#æ‰§è¡Œè°ƒç”¨" class="headerlink" title="æ‰§è¡Œè°ƒç”¨"></a>æ‰§è¡Œè°ƒç”¨</h4><p>client stub æ‰€åšçš„äº‹æƒ…ä»…ä»…æ˜¯ç¼–ç æ¶ˆæ¯å¹¶ä¼ è¾“ç»™æœåŠ¡æ–¹ï¼Œè€ŒçœŸæ­£è°ƒç”¨è¿‡ç¨‹å‘ç”Ÿåœ¨æœåŠ¡æ–¹ã€‚server stub ä»å‰æ–‡çš„ç»“æ„æ‹†è§£ä¸­æˆ‘ä»¬ç»†åˆ†äº† <code>RpcProcessor</code> å’Œ <code>RpcInvoker</code> ä¸¤ä¸ªç»„ä»¶ï¼Œä¸€ä¸ªè´Ÿè´£æ§åˆ¶è°ƒç”¨è¿‡ç¨‹ï¼Œä¸€ä¸ªè´Ÿè´£çœŸæ­£è°ƒç”¨ã€‚è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä»¥ java ä¸­å®ç°è¿™ä¸¤ä¸ªç»„ä»¶ä¸ºä¾‹æ¥åˆ†æä¸‹å®ƒä»¬åˆ°åº•éœ€è¦åšä»€ä¹ˆï¼Ÿ</p>
<p>java ä¸­å®ç°ä»£ç çš„åŠ¨æ€æ¥å£è°ƒç”¨ç›®å‰ä¸€èˆ¬é€šè¿‡åå°„è°ƒç”¨ã€‚é™¤äº†åŸç”Ÿçš„ jdk è‡ªå¸¦çš„åå°„ï¼Œä¸€äº›ç¬¬ä¸‰æ–¹åº“ä¹Ÿæä¾›äº†æ€§èƒ½æ›´ä¼˜çš„åå°„è°ƒç”¨ï¼Œå› æ­¤ <code>RpcInvoker</code> å°±æ˜¯å°è£…äº†åå°„è°ƒç”¨çš„å®ç°ç»†èŠ‚ã€‚</p>
<p>è°ƒç”¨è¿‡ç¨‹çš„æ§åˆ¶éœ€è¦è€ƒè™‘å“ªäº›å› ç´ ï¼Œ<code>RpcProcessor</code> éœ€è¦æä¾›ä»€ä¹ˆæ ·åœ°è°ƒç”¨æ§åˆ¶æœåŠ¡å‘¢ï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1. æ•ˆç‡æå‡  </div><div class="line">   æ¯ä¸ªè¯·æ±‚åº”è¯¥å°½å¿«è¢«æ‰§è¡Œï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½æ¯è¯·æ±‚æ¥å†åˆ›å»ºçº¿ç¨‹å»æ‰§è¡Œï¼Œéœ€è¦æä¾›çº¿ç¨‹æ± æœåŠ¡ã€‚  </div><div class="line">2. èµ„æºéš”ç¦»  </div><div class="line">   å½“æˆ‘ä»¬å¯¼å‡ºå¤šä¸ªè¿œç¨‹æ¥å£æ—¶ï¼Œå¦‚ä½•é¿å…å•ä¸€æ¥å£è°ƒç”¨å æ®æ‰€æœ‰çº¿ç¨‹èµ„æºï¼Œè€Œå¼•å‘å…¶ä»–æ¥å£æ‰§è¡Œé˜»å¡ã€‚  </div><div class="line">3. è¶…æ—¶æ§åˆ¶  </div><div class="line">   å½“æŸä¸ªæ¥å£æ‰§è¡Œç¼“æ…¢ï¼Œè€Œ client ç«¯å·²ç»è¶…æ—¶æ”¾å¼ƒç­‰å¾…åï¼Œserver ç«¯çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œæ­¤æ—¶æ˜¾å¾—æ¯«æ— æ„ä¹‰ã€‚</div></pre></td></tr></table></figure>
<h4 id="RPC-å¼‚å¸¸å¤„ç†"><a href="#RPC-å¼‚å¸¸å¤„ç†" class="headerlink" title="RPC å¼‚å¸¸å¤„ç†"></a>RPC å¼‚å¸¸å¤„ç†</h4><p>æ— è®º RPC æ€æ ·åŠªåŠ›æŠŠè¿œç¨‹è°ƒç”¨ä¼ªè£…çš„åƒæœ¬åœ°è°ƒç”¨ï¼Œä½†å®ƒä»¬ä¾ç„¶æœ‰å¾ˆå¤§çš„ä¸åŒç‚¹ï¼Œè€Œä¸”æœ‰ä¸€äº›å¼‚å¸¸æƒ…å†µæ˜¯åœ¨æœ¬åœ°è°ƒç”¨æ—¶ç»å¯¹ä¸ä¼šç¢°åˆ°çš„ã€‚åœ¨è¯´å¼‚å¸¸å¤„ç†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¯”è¾ƒä¸‹æœ¬åœ°è°ƒç”¨å’Œ RPC è°ƒç”¨çš„ä¸€äº›å·®å¼‚ï¼š</p>
<ol>
<li>æœ¬åœ°è°ƒç”¨ä¸€å®šä¼šæ‰§è¡Œï¼Œè€Œè¿œç¨‹è°ƒç”¨åˆ™ä¸ä¸€å®šï¼Œè°ƒç”¨æ¶ˆæ¯å¯èƒ½å› ä¸ºç½‘ç»œåŸå› å¹¶æœªå‘é€åˆ°æœåŠ¡æ–¹ã€‚</li>
<li>æœ¬åœ°è°ƒç”¨åªä¼šæŠ›å‡ºæ¥å£å£°æ˜çš„å¼‚å¸¸ï¼Œè€Œè¿œç¨‹è°ƒç”¨è¿˜ä¼šè·‘å‡º RPC æ¡†æ¶è¿è¡Œæ—¶çš„å…¶ä»–å¼‚å¸¸ã€‚</li>
<li>æœ¬åœ°è°ƒç”¨å’Œè¿œç¨‹è°ƒç”¨çš„æ€§èƒ½å¯èƒ½å·®è·å¾ˆå¤§ï¼Œè¿™å–å†³äº RPC å›ºæœ‰æ¶ˆè€—æ‰€å çš„æ¯”é‡ã€‚</li>
</ol>
<p>æ­£æ˜¯è¿™äº›åŒºåˆ«å†³å®šäº†ä½¿ç”¨ RPC æ—¶éœ€è¦æ›´å¤šè€ƒé‡ã€‚å½“è°ƒç”¨è¿œç¨‹æ¥å£æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¼‚å¸¸å¯èƒ½æ˜¯ä¸€ä¸ªä¸šåŠ¡å¼‚å¸¸ï¼Œä¹Ÿå¯èƒ½æ˜¯ RPC æ¡†æ¶æŠ›å‡ºçš„è¿è¡Œæ—¶å¼‚å¸¸ï¼ˆå¦‚ï¼šç½‘ç»œä¸­æ–­ç­‰ï¼‰ã€‚ä¸šåŠ¡å¼‚å¸¸è¡¨æ˜æœåŠ¡æ–¹å·²ç»æ‰§è¡Œäº†è°ƒç”¨ï¼Œå¯èƒ½å› ä¸ºæŸäº›åŸå› å¯¼è‡´æœªèƒ½æ­£å¸¸æ‰§è¡Œï¼Œè€Œ RPC è¿è¡Œæ—¶å¼‚å¸¸åˆ™æœ‰å¯èƒ½æœåŠ¡æ–¹æ ¹æœ¬æ²¡æœ‰æ‰§è¡Œï¼Œå¯¹è°ƒç”¨æ–¹è€Œè¨€çš„å¼‚å¸¸å¤„ç†ç­–ç•¥è‡ªç„¶éœ€è¦åŒºåˆ†ã€‚</p>
<p>ç”±äº RPC å›ºæœ‰çš„æ¶ˆè€—ç›¸å¯¹æœ¬åœ°è°ƒç”¨é«˜å‡ºå‡ ä¸ªæ•°é‡çº§ï¼Œæœ¬åœ°è°ƒç”¨çš„å›ºæœ‰æ¶ˆè€—æ˜¯çº³ç§’çº§ï¼Œè€Œ RPC çš„å›ºæœ‰æ¶ˆè€—æ˜¯åœ¨æ¯«ç§’çº§ã€‚é‚£ä¹ˆå¯¹äºè¿‡äºè½»é‡çš„è®¡ç®—ä»»åŠ¡å°±å¹¶ä¸åˆé€‚å¯¼å‡ºè¿œç¨‹æ¥å£ç”±ç‹¬ç«‹çš„è¿›ç¨‹æä¾›æœåŠ¡ï¼Œåªæœ‰èŠ±åœ¨è®¡ç®—ä»»åŠ¡ä¸Šæ—¶é—´è¿œè¿œé«˜äº RPC çš„å›ºæœ‰æ¶ˆè€—æ‰å€¼å¾—å¯¼å‡ºä¸ºè¿œç¨‹æ¥å£æä¾›æœåŠ¡ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Thriftè¯¦è§£]]></title>
      <url>http://zsr.github.io/2017/06/20/Thrift%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<h3 id="RPCè°ƒç”¨æµç¨‹"><a href="#RPCè°ƒç”¨æµç¨‹" class="headerlink" title="RPCè°ƒç”¨æµç¨‹"></a>RPCè°ƒç”¨æµç¨‹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">1ï¼‰å®¢æˆ·ç«¯ï¼ˆclientï¼‰è°ƒç”¨ä»¥æœ¬åœ°è°ƒç”¨æ–¹å¼è°ƒç”¨æœåŠ¡ï¼›</div><div class="line">2ï¼‰client stubæ¥æ”¶åˆ°è°ƒç”¨åè´Ÿè´£å°†æ–¹æ³•ã€å‚æ•°ç­‰ç»„è£…æˆèƒ½å¤Ÿè¿›è¡Œç½‘ç»œä¼ è¾“çš„æ¶ˆæ¯ä½“ï¼›</div><div class="line">3ï¼‰client stubæ‰¾åˆ°æœåŠ¡åœ°å€ï¼Œå¹¶å°†æ¶ˆæ¯å‘é€åˆ°æœåŠ¡ç«¯ï¼›</div><div class="line"></div><div class="line">4ï¼‰server stubæ”¶åˆ°æ¶ˆæ¯åè¿›è¡Œè§£ç ï¼›</div><div class="line">5ï¼‰server stubæ ¹æ®è§£ç ç»“æœè°ƒç”¨æœ¬åœ°çš„æœåŠ¡ï¼›</div><div class="line">6ï¼‰æœåŠ¡ç«¯æ‰§è¡Œå¹¶å°†ç»“æœè¿”å›ç»™server stubï¼›</div><div class="line">7ï¼‰server stubå°†è¿”å›ç»“æœæ‰“åŒ…æˆæ¶ˆæ¯å¹¶å‘é€è‡³æ¶ˆè´¹æ–¹ï¼›</div><div class="line"></div><div class="line">8ï¼‰client stubæ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå¹¶è¿›è¡Œè§£ç ï¼›</div><div class="line">9ï¼‰å®¢æˆ·ç«¯å¾—åˆ°æœ€ç»ˆç»“æœã€‚</div></pre></td></tr></table></figure>
<p><img src="http://images2015.cnblogs.com/blog/522490/201510/522490-20151003120412386-363334260.png" alt="img"></p>
<h3 id="Thriftä¸»è¦ç‰¹ç‚¹"><a href="#Thriftä¸»è¦ç‰¹ç‚¹" class="headerlink" title="Thriftä¸»è¦ç‰¹ç‚¹"></a>Thriftä¸»è¦ç‰¹ç‚¹</h3><ol>
<li>åŸºäºäºŒè¿›åˆ¶çš„é«˜æ€§èƒ½çš„ç¼–è§£ç æ¡†æ¶</li>
<li>åŸºäºNIOçš„åº•å±‚é€šä¿¡</li>
<li>ç›¸å¯¹ç®€å•çš„æœåŠ¡è°ƒç”¨æ¨¡å‹</li>
<li>ä½¿ç”¨IDLæ”¯æŒè·¨å¹³å°è°ƒç”¨</li>
</ol>
<h3 id="Thriftæ ¸å¿ƒç»„ä»¶"><a href="#Thriftæ ¸å¿ƒç»„ä»¶" class="headerlink" title="Thriftæ ¸å¿ƒç»„ä»¶"></a>Thriftæ ¸å¿ƒç»„ä»¶</h3><ol>
<li><code>TProtocol</code> åè®®å’Œç¼–è§£ç ç»„ä»¶</li>
<li><code>TTransport</code> ä¼ è¾“ç»„ä»¶</li>
<li><code>TProcessor</code> æœåŠ¡è°ƒç”¨ç»„ä»¶</li>
<li><code>TServer</code>ï¼Œ<code>Client</code> æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç»„ä»¶</li>
<li>IDL æœåŠ¡æè¿°ç»„ä»¶ï¼Œè´Ÿè´£ç”Ÿäº§è·¨å¹³å°å®¢æˆ·ç«¯</li>
</ol>
<a id="more"></a>
<h3 id="ThriftåŸºç¡€æ¶æ„"><a href="#ThriftåŸºç¡€æ¶æ„" class="headerlink" title="ThriftåŸºç¡€æ¶æ„"></a>ThriftåŸºç¡€æ¶æ„</h3><p> <img src="http://www.blogjava.net/images/blogjava_net/ldwblog/thrift%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="img"></p>
<p>thriftæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„æ¶æ„ä½“ç³»ï¼ˆc/sï¼‰ï¼Œåœ¨æœ€ä¸Šå±‚æ˜¯ç”¨æˆ·è‡ªè¡Œå®ç°çš„ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚ç¬¬äºŒå±‚æ˜¯ç”±thriftç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ï¼Œä¸»è¦ç”¨äºç»“æ„åŒ–æ•°æ®çš„è§£æï¼Œå‘é€å’Œæ¥æ”¶ã€‚TServerä¸»è¦ä»»åŠ¡æ˜¯é«˜æ•ˆçš„æ¥å—å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘ç»™Processorå¤„ç†ã€‚Processorè´Ÿè´£å¯¹å®¢æˆ·ç«¯çš„è¯·æ±‚åšå‡ºå“åº”ï¼ŒåŒ…æ‹¬RPCè¯·æ±‚è½¬å‘ï¼Œè°ƒç”¨å‚æ•°è§£æå’Œç”¨æˆ·é€»è¾‘è°ƒç”¨ï¼Œè¿”å›å€¼å†™å›ç­‰å¤„ç†ã€‚ä»TProtocolä»¥ä¸‹éƒ¨åˆ†æ˜¯thirftçš„ä¼ è¾“åè®®å’Œåº•å±‚I/Oé€šä¿¡ã€‚TProtocolæ˜¯ç”¨äºæ•°æ®ç±»å‹è§£æçš„ï¼Œå°†ç»“æ„åŒ–æ•°æ®è½¬åŒ–ä¸ºå­—èŠ‚æµç»™TTransportè¿›è¡Œä¼ è¾“ã€‚TTransportæ˜¯ä¸åº•å±‚æ•°æ®ä¼ è¾“å¯†åˆ‡ç›¸å…³çš„ä¼ è¾“å±‚ï¼Œè´Ÿè´£ä»¥å­—èŠ‚æµæ–¹å¼æ¥æ”¶å’Œå‘é€æ¶ˆæ¯ä½“ï¼Œä¸å…³æ³¨æ˜¯ä»€ä¹ˆæ•°æ®ç±»å‹ã€‚åº•å±‚IOè´Ÿè´£å®é™…çš„æ•°æ®ä¼ è¾“ï¼ŒåŒ…æ‹¬socketã€æ–‡ä»¶å’Œå‹ç¼©æ•°æ®æµç­‰ã€‚</p>
<h4 id="ä¼ è¾“å±‚TTransport"><a href="#ä¼ è¾“å±‚TTransport" class="headerlink" title="ä¼ è¾“å±‚TTransport"></a>ä¼ è¾“å±‚TTransport</h4><ul>
<li><code>TIOStreamTransport</code>: è¿™ä¸ªç±»å°è£…äº†<code>InputStream</code>å’Œ<code>OutputStream</code>è¿™ä¸¤ä¸ªæµï¼Œç”¨æ¥å¤„ç†æ•°æ®ä¼ è¾“ä¸­çš„è¾“å…¥è¾“å‡ºæµã€‚é‡‡ç”¨çš„æ˜¯é˜»å¡åŒæ­¥IOã€‚<ul>
<li><code>TSocket</code>: æ˜¯<code>TIOStreamTransport</code>ç±»çš„å­ç±»ï¼Œå¹¶ä¸”å°è£…äº†<code>Socket</code>æ¥å£ã€‚</li>
</ul>
</li>
<li><code>TNonblockingTransport</code>: è¿™ä¸ªç±»æ˜¯éé˜»å¡IOçš„æŠ½è±¡ç±»ã€‚<ul>
<li><code>TNonblockingSocket</code>: æ˜¯<code>TNonblockingTransport</code>ç±»çš„å­ç±»ï¼Œä½¿ç”¨äº†<code>SocketChannel</code>è¿›è¡Œäº†éé˜»å¡IOã€‚</li>
</ul>
</li>
<li><code>TFramedTransport</code>: ä½¿ç”¨éé˜»å¡æ–¹å¼ï¼Œå¸§ä¼ è¾“ç±»å°±æ˜¯æŒ‰ç…§ä¸€å¸§çš„å›ºå®šå¤§å°æ¥ä¼ è¾“æ•°æ®ï¼Œæ‰€æœ‰çš„å†™æ“ä½œé¦–å…ˆéƒ½æ˜¯åœ¨å†…å­˜ä¸­å®Œæˆçš„ç›´åˆ°è°ƒç”¨äº†flushæ“ä½œï¼Œç„¶åä¼ è¾“èŠ‚ç‚¹åœ¨flushæ“ä½œä¹‹åå°†æ‰€æœ‰æ•°æ®æ ¹æ®æ•°æ®çš„æœ‰æ•ˆè½½è·å†™å…¥æ•°æ®çš„é•¿åº¦çš„äºŒè¿›åˆ¶å—å‘é€å‡ºå»ï¼Œå…è®¸åœ¨æ¥æ”¶çš„å¦ä¸€ç«¯æŒ‰ç…§å›ºå®šçš„é•¿åº¦æ¥è¯»å–ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// TTransport.class</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TTransport</span> </span>&#123;</div><div class="line">  <span class="comment">// è¯»å–æŒ‡å®šé•¿åº¦çš„æ•°æ®</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">byte</span>[] buf, <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> TTransportException</span>;</div><div class="line"></div><div class="line">  <span class="comment">// å†™æ•°æ®</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">byte</span>[] buf, <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> TTransportException</span>;</div><div class="line">  </div><div class="line">  <span class="comment">// æŠŠç¼“å†²åŒºçš„æ•°æ®å…¨éƒ¨éƒ½pushå‡ºå»</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> <span class="keyword">throws</span> TTransportException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="é˜»å¡TSocket"><a href="#é˜»å¡TSocket" class="headerlink" title="é˜»å¡TSocket"></a>é˜»å¡TSocket</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// TSocket.class</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TSocket</span> <span class="keyword">extends</span> <span class="title">TIOStreamTransport</span> </span>&#123;</div><div class="line">  <span class="comment">// æ„é€ socket</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TSocket</span><span class="params">(String host, <span class="keyword">int</span> port, <span class="keyword">int</span> socketTimeout, <span class="keyword">int</span> connectTimeout)</span> </span>&#123;</div><div class="line">    host_ = host;</div><div class="line">    port_ = port;</div><div class="line">    socketTimeout_ = socketTimeout;</div><div class="line">    connectTimeout_ = connectTimeout;</div><div class="line">    initSocket();</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">// åˆ›å»ºæ–°çš„Socket</span></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initSocket</span><span class="params">()</span> </span>&#123;</div><div class="line">    socket_ = <span class="keyword">new</span> Socket();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      socket_.setSoLinger(<span class="keyword">false</span>, <span class="number">0</span>);</div><div class="line">      socket_.setTcpNoDelay(<span class="keyword">true</span>);</div><div class="line">      socket_.setKeepAlive(<span class="keyword">true</span>);</div><div class="line">      socket_.setSoTimeout(socketTimeout_);</div><div class="line">    &#125; <span class="keyword">catch</span> (SocketException sx) &#123;</div><div class="line">      LOGGER.error(<span class="string">"Could not configure socket."</span>, sx);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">// æ‰“å¼€é“¾æ¥</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">()</span> <span class="keyword">throws</span> TTransportException </span>&#123;</div><div class="line">     socket_.connect(<span class="keyword">new</span> InetSocketAddress(host_, port_), timeout_);</div><div class="line">     inputStream_ = <span class="keyword">new</span> BufferedInputStream(socket_.getInputStream(), <span class="number">1024</span>);</div><div class="line">     outputStream_ = <span class="keyword">new</span> BufferedOutputStream(socket_.getOutputStream(), <span class="number">1024</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="éé˜»å¡TFramedTransport"><a href="#éé˜»å¡TFramedTransport" class="headerlink" title="éé˜»å¡TFramedTransport"></a>éé˜»å¡TFramedTransport</h5><ul>
<li>æµç¨‹å›¾</li>
</ul>
<p><img src="http://img.voidcn.com/vcimg/000/005/545/078_fcf_750.jpg" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ul>
<li>æºç åˆ†æ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TFramedTransport</span> <span class="keyword">extends</span> <span class="title">TTransport</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> TTransport transport_ = <span class="keyword">null</span>;</div><div class="line">  </div><div class="line">  <span class="comment">// è¾“å‡ºç¼“å†²åŒº</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> TByteArrayOutputStream writeBuffer_ =</div><div class="line">    <span class="keyword">new</span> TByteArrayOutputStream(<span class="number">1024</span>);</div><div class="line">  </div><div class="line">  <span class="comment">// è¾“å…¥ç¼“å†²åŒº</span></div><div class="line">  <span class="keyword">private</span> TMemoryInputTransport readBuffer_ = <span class="keyword">new</span> TMemoryInputTransport(<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</div><div class="line">  </div><div class="line">  <span class="comment">// ä¸€å¸§4byte</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] i32buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</div><div class="line">  </div><div class="line">  <span class="comment">// è¯»å–æ•°æ®</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">byte</span>[] buf, <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> TTransportException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (readBuffer_ != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">int</span> got = readBuffer_.read(buf, off, len);</div><div class="line">      <span class="keyword">if</span> (got &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> got;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Read another frame of data</span></div><div class="line">    readFrame();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> readBuffer_.read(buf, off, len);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">// è¯»å–ä¸€å¸§æ•°æ®ï¼Œæ”¾åˆ°è¾“å…¥ç¼“å†²åŒº</span></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readFrame</span><span class="params">()</span> <span class="keyword">throws</span> TTransportException </span>&#123;</div><div class="line">    transport_.readAll(i32buf, <span class="number">0</span>, <span class="number">4</span>);</div><div class="line">    <span class="keyword">int</span> size = decodeFrameSize(i32buf);</div><div class="line"></div><div class="line">    <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[size];</div><div class="line">    transport_.readAll(buff, <span class="number">0</span>, size);</div><div class="line">    readBuffer_.reset(buff);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>TFramedTransport</code>å°è£…äº†<code>TMemoryInputTransport</code>åšè¾“å…¥æµï¼Œå°è£…äº†<code>TByteArryOutPutStream</code>åšè¾“å‡ºæµï¼Œä½œä¸ºå†…å­˜è¯»å†™ç¼“å†²åŒºçš„ä¸€ä¸ªå°è£…ã€‚<code>TFramedTransport</code>çš„<code>flush</code>æ–¹æ³•æ—¶ï¼Œä¼šå…ˆå†™4ä¸ªå­—èŠ‚çš„è¾“å‡ºæµçš„é•¿åº¦ä½œä¸ºæ¶ˆæ¯å¤´ï¼Œç„¶åå†™æ¶ˆæ¯ä½“ï¼›å’Œ<code>FrameBuffer</code>çš„è¯»æ¶ˆæ¯å¯¹åº”èµ·æ¥ï¼Œ<code>FrameBuffer</code> è¯»æ¶ˆæ¯æ—¶ï¼Œå…ˆè¯»4ä¸ªå­—èŠ‚çš„é•¿åº¦ï¼Œå†è¯»æ¶ˆæ¯ä½“ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Test </span></div><div class="line">TTransport transport = <span class="keyword">new</span> TFramedTransport(<span class="keyword">new</span> TSocket(SERVER_IP, SERVER_PORT, TIMEOUT));</div></pre></td></tr></table></figure>
<h4 id="åè®®å±‚TProtocol"><a href="#åè®®å±‚TProtocol" class="headerlink" title="åè®®å±‚TProtocol"></a>åè®®å±‚TProtocol</h4><ul>
<li><code>TBinaryProtocol</code>ï¼šäºŒè¿›åˆ¶ç¼–ç æ ¼å¼è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚ </li>
<li><code>TCompactProtocol</code>ï¼šé«˜æ•ˆçš„ç¼–ç æ–¹å¼ï¼Œå¯¹æ•°æ®è¿›è¡Œå‹ç¼©ã€‚ </li>
<li><code>TJSONProtocol</code>ï¼šä½¿ç”¨JSONçš„æ•°æ®ç¼–ç åè®®è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚ </li>
</ul>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.cnblogs.com/LBSer/p/4853234.html" target="_blank" rel="external">ä½ åº”è¯¥çŸ¥é“çš„RPCåŸç†</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ä¸€è‡´æ€§hash]]></title>
      <url>http://zsr.github.io/2017/06/07/%E4%B8%80%E8%87%B4%E6%80%A7hash/</url>
      <content type="html"><![CDATA[<h3 id="åˆ†å¸ƒå¼ç¼“å­˜é—®é¢˜"><a href="#åˆ†å¸ƒå¼ç¼“å­˜é—®é¢˜" class="headerlink" title="åˆ†å¸ƒå¼ç¼“å­˜é—®é¢˜"></a>åˆ†å¸ƒå¼ç¼“å­˜é—®é¢˜</h3><p>â€‹     åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå½“æœåŠ¡å¢é•¿åˆ°ä¸€å®šè§„æ¨¡æ—¶ï¼Œæƒ¯å¸¸çš„åšæ³•æ˜¯é›†ç¾¤åŒ–ï¼Œå¼•å…¥è´Ÿè½½å‡è¡¡ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š1. é«˜å¯ç”¨ã€‚2. è§£è€¦ã€‚ä»å¤–éƒ¨çœ‹ï¼Œé€æ˜åŒ–äº†é›†ç¾¤çš„å†…éƒ¨ç»†èŠ‚ï¼ˆå¤–éƒ¨éƒ½é€šè¿‡è´Ÿè½½å‡è¡¡æœåŠ¡å™¨é€šä¿¡ï¼Œç„¶åç”±è´Ÿè½½å‡è¡¡æœåŠ¡å™¨åˆ†å‘è¯·æ±‚ï¼‰ã€‚</p>
<p>å‡è®¾ä¸€ä¸ªç®€å•çš„åœºæ™¯ï¼šæœ‰4ä¸ªcacheæœåŠ¡å™¨ç»„æˆçš„é›†ç¾¤ï¼Œå½“ä¸€ä¸ªå¯¹è±¡ä¼ å…¥é›†ç¾¤æ—¶ï¼Œè¿™ä¸ªå¯¹è±¡åº”è¯¥å­˜å‚¨åœ¨å“ªä¸€ä¸ªcacheé‡Œå‘¢ï¼Ÿä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨æ˜ å°„å…¬å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Hash(object) % <span class="number">4</span></div></pre></td></tr></table></figure>
<p>è¿™ä¸ªç®—æ³•çš„é—®é¢˜åœ¨äºå®¹é”™æ€§å’Œæ‰©å±•æ€§ä¸å¥½ã€‚æ‰€è°“å®¹é”™æ€§æ˜¯æŒ‡å½“ç³»ç»Ÿä¸­æŸä¸€ä¸ªæˆ–å‡ ä¸ªæœåŠ¡å™¨å˜å¾—ä¸å¯ç”¨æ—¶ï¼Œæ•´ä¸ªç³»ç»Ÿæ˜¯å¦å¯ä»¥æ­£ç¡®é«˜æ•ˆè¿è¡Œï¼›è€Œæ‰©å±•æ€§æ˜¯æŒ‡å½“åŠ å…¥æ–°çš„æœåŠ¡å™¨åï¼Œæ•´ä¸ªç³»ç»Ÿæ˜¯å¦å¯ä»¥æ­£ç¡®é«˜æ•ˆè¿è¡Œã€‚</p>
<p>å‡è®¾ä¸€ä¸‹æƒ…å†µï¼š</p>
<ul>
<li>ç”±äºæµé‡å¢å¤§ï¼Œéœ€è¦å¢åŠ ä¸€å°cacheï¼Œå…±5ä¸ªcacheã€‚è¿™æ—¶ï¼Œæ˜ å°„å…¬å¼å°±å˜æˆ<code>Hash(object) % 5</code>ã€‚</li>
<li>æœ‰ä¸€ä¸ªcacheæœåŠ¡å™¨downæ‰ï¼Œå˜æˆ3ä¸ªcacheã€‚è¿™æ—¶ï¼Œæ˜ å°„å…¬å¼å°±å˜æˆ<code>Hash(object) % 3</code>ã€‚</li>
</ul>
<p>å› æ­¤ç³»ç»Ÿä¸­ä¸€æ—¦æœ‰æœåŠ¡å™¨å˜æ›´ï¼Œå¤§é‡çš„keyä¼šè¢«é‡å®šä½åˆ°ä¸åŒçš„æœåŠ¡å™¨ä»è€Œé€ æˆå¤§é‡çš„ç¼“å­˜ä¸å‘½ä¸­ï¼Œè¿™æ„å‘³ç€ä¸€æ—¶é—´æ‰€æœ‰çš„ç¼“å­˜å…¨éƒ¨å¤±æ•ˆã€‚è€Œè¿™ç§æƒ…å†µåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ˜¯éå¸¸ç³Ÿç³•çš„ã€‚</p>
<p>ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„åˆ†å¸ƒå¼å“ˆå¸Œæ–¹æ¡ˆåº”è¯¥å…·æœ‰è‰¯å¥½çš„å•è°ƒæ€§ï¼Œå³æœåŠ¡èŠ‚ç‚¹çš„å¢å‡ä¸ä¼šé€ æˆå¤§é‡å“ˆå¸Œé‡å®šä½ã€‚ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°±æ˜¯è¿™æ ·ä¸€ç§å“ˆå¸Œæ–¹æ¡ˆã€‚</p>
<h3 id="ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"><a href="#ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•" class="headerlink" title="ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"></a>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</h3><ol>
<li>ç®€å•æ¥è¯´ï¼Œä¸€è‡´æ€§å“ˆå¸Œå°†æ•´ä¸ªå“ˆå¸Œå€¼ç©ºé—´ç»„ç»‡æˆä¸€ä¸ªè™šæ‹Ÿçš„åœ†ç¯ï¼Œå¦‚å‡è®¾æŸå“ˆå¸Œå‡½æ•°Hçš„å€¼ç©ºé—´ä¸º${2}^{32}$-1ï¼ˆå³å“ˆå¸Œå€¼æ˜¯ä¸€ä¸ª32ä½æ— ç¬¦å·æ•´å½¢ï¼‰ï¼Œæ•´ä¸ªå“ˆå¸Œç©ºé—´ç¯å¦‚ä¸‹ï¼š</li>
</ol>
<p><img src="http://blog.codinglabs.org/uploads/pictures/consistent-hashing/2.png" alt="img"></p>
<p>æ•´ä¸ªç©ºé—´æŒ‰é¡ºæ—¶é’ˆæ–¹å‘ç»„ç»‡ã€‚0å’Œ${2}^{32}$-1åœ¨é›¶ç‚¹ä¸­æ–¹å‘é‡åˆã€‚</p>
<ol>
<li>ä¸‹ä¸€æ­¥å°†å„ä¸ªæœåŠ¡å™¨ä½¿ç”¨hashå‡½æ•°è¿›è¡Œä¸€æ¬¡å“ˆå¸Œï¼Œå…·ä½“å¯ä»¥é€‰æ‹©æœåŠ¡å™¨çš„ipæˆ–ä¸»æœºåä½œä¸ºå…³é”®å­—è¿›è¡Œå“ˆå¸Œï¼Œè¿™æ ·æ¯å°æœºå™¨å°±èƒ½ç¡®å®šå…¶åœ¨å“ˆå¸Œç¯ä¸Šçš„ä½ç½®ï¼Œè¿™é‡Œå‡è®¾å°†ä¸‰å°æœåŠ¡å™¨ä½¿ç”¨ipåœ°å€å“ˆå¸Œååœ¨ç¯ç©ºé—´çš„ä½ç½®å¦‚ä¸‹ï¼š</li>
</ol>
<p><img src="http://blog.codinglabs.org/uploads/pictures/consistent-hashing/3.png" alt="img"></p>
<ol>
<li>æ¥ä¸‹æ¥ä½¿ç”¨å¦‚ä¸‹ç®—æ³•å®šä½æ•°æ®è®¿é—®åˆ°ç›¸åº”æœåŠ¡å™¨ï¼šå°†æ•°æ®keyä½¿ç”¨ç›¸åŒçš„hashå‡½æ•°è®¡ç®—å‡ºå“ˆå¸Œå€¼hï¼Œé€šæ ¹æ®hç¡®å®šæ­¤æ•°æ®åœ¨ç¯ä¸Šçš„ä½ç½®ï¼Œä»æ­¤ä½ç½®æ²¿ç¯é¡ºæ—¶é’ˆâ€œè¡Œèµ°â€ï¼Œç¬¬ä¸€å°é‡åˆ°çš„æœåŠ¡å™¨å°±æ˜¯å…¶åº”è¯¥å®šä½åˆ°çš„æœåŠ¡å™¨ã€‚</li>
</ol>
<p>ä¾‹å¦‚æˆ‘ä»¬æœ‰Aã€Bã€Cã€Då››ä¸ªæ•°æ®å¯¹è±¡ï¼Œç»è¿‡å“ˆå¸Œè®¡ç®—åï¼Œåœ¨ç¯ç©ºé—´ä¸Šçš„ä½ç½®å¦‚ä¸‹ï¼š</p>
<p><img src="http://blog.codinglabs.org/uploads/pictures/consistent-hashing/4.png" alt="img"></p>
<p>æ ¹æ®ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼Œæ•°æ®Aä¼šè¢«å®šä¸ºåˆ°Server 1ä¸Šï¼ŒDè¢«å®šä¸ºåˆ°Server 3ä¸Šï¼Œè€ŒBã€Cåˆ†åˆ«è¢«å®šä¸ºåˆ°Server 2ä¸Šã€‚</p>
<h3 id="å®¹é”™æ€§ä¸å¯æ‰©å±•æ€§åˆ†æ"><a href="#å®¹é”™æ€§ä¸å¯æ‰©å±•æ€§åˆ†æ" class="headerlink" title="å®¹é”™æ€§ä¸å¯æ‰©å±•æ€§åˆ†æ"></a>å®¹é”™æ€§ä¸å¯æ‰©å±•æ€§åˆ†æ</h3><p>æ–°çš„ä¸€è‡´æ€§hashç®—æ³•æˆåŠŸè§£å†³äº†cacheæœåŠ¡å™¨å¢å‡æ—¶keyçš„å¤±æ•ˆé—®é¢˜ã€‚ç°åœ¨ï¼Œæ— è®ºå¢å‡cacheï¼Œ<strong>åªæœ‰éƒ¨åˆ†keyå¤±æ•ˆ</strong>ã€‚</p>
<p>ç°å‡è®¾Server 3å®•æœºäº†ï¼š</p>
<p><img src="http://blog.codinglabs.org/uploads/pictures/consistent-hashing/5.png" alt="img"></p>
<p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶Aã€Cã€Bä¸ä¼šå—åˆ°å½±å“ï¼Œåªæœ‰DèŠ‚ç‚¹è¢«é‡å®šä½åˆ°Server 2ã€‚ä¸€èˆ¬çš„ï¼Œåœ¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸­ï¼Œå¦‚æœä¸€å°æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œåˆ™å—å½±å“çš„æ•°æ®ä»…ä»…æ˜¯æ­¤æœåŠ¡å™¨åˆ°å…¶ç¯ç©ºé—´ä¸­å‰ä¸€å°æœåŠ¡å™¨ï¼ˆå³é¡ºç€é€†æ—¶é’ˆæ–¹å‘è¡Œèµ°é‡åˆ°çš„ç¬¬ä¸€å°æœåŠ¡å™¨ï¼‰ä¹‹é—´æ•°æ®ï¼Œå…¶å®ƒä¸ä¼šå—åˆ°å½±å“ã€‚</p>
<p>ä¸‹é¢è€ƒè™‘å¦å¤–ä¸€ç§æƒ…å†µï¼Œå¦‚æœæˆ‘ä»¬åœ¨ç³»ç»Ÿä¸­å¢åŠ ä¸€å°æœåŠ¡å™¨Memcached Server 4ï¼š</p>
<p><img src="http://blog.codinglabs.org/uploads/pictures/consistent-hashing/6.png" alt="img"></p>
<p>æ­¤æ—¶Aã€Dã€Cä¸å—å½±å“ï¼Œåªæœ‰Béœ€è¦é‡å®šä½åˆ°æ–°çš„Server 4ã€‚ä¸€èˆ¬çš„ï¼Œåœ¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸­ï¼Œå¦‚æœå¢åŠ ä¸€å°æœåŠ¡å™¨ï¼Œåˆ™å—å½±å“çš„æ•°æ®ä»…ä»…æ˜¯æ–°æœåŠ¡å™¨åˆ°å…¶ç¯ç©ºé—´ä¸­å‰ä¸€å°æœåŠ¡å™¨ï¼ˆå³é¡ºç€é€†æ—¶é’ˆæ–¹å‘è¡Œèµ°é‡åˆ°çš„ç¬¬ä¸€å°æœåŠ¡å™¨ï¼‰ä¹‹é—´æ•°æ®ï¼Œå…¶å®ƒä¸ä¼šå—åˆ°å½±å“ã€‚</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å¯¹äºèŠ‚ç‚¹çš„å¢å‡éƒ½åªéœ€é‡å®šä½ç¯ç©ºé—´ä¸­çš„ä¸€å°éƒ¨åˆ†æ•°æ®ï¼Œå…·æœ‰è¾ƒå¥½çš„å®¹é”™æ€§å’Œå¯æ‰©å±•æ€§ã€‚</p>
<h2 id="è™šæ‹ŸèŠ‚ç‚¹"><a href="#è™šæ‹ŸèŠ‚ç‚¹" class="headerlink" title="è™šæ‹ŸèŠ‚ç‚¹"></a>è™šæ‹ŸèŠ‚ç‚¹</h2><p>å¯¹äºä¸€ä¸ªobjectæ¥è¯´ï¼Œå®ƒè½åœ¨ç¯ä¸Šçš„ä»»ä½•ä½ç½®çš„æ¦‚ç‡éƒ½æ˜¯ä¸€æ ·çš„ï¼Œ<strong>é‚£ä¹ˆè½åœ¨ä¸€ä¸ªcacheçš„æ¦‚ç‡å°±å’Œåœ†å¼§çš„é•¿åº¦æˆæ­£æ¯”</strong>ã€‚äºæ˜¯ï¼Œæˆ‘ä»¬å¸Œæœ›æ¯ä¸ªcacheæ‰€å çš„åœ†å¼§é•¿åº¦æ›´æ¥è¿‘ã€‚</p>
<p>ç†è®ºä¸Šï¼Œ<strong>åªè¦cacheè¶³å¤Ÿå¤šï¼Œæ¯ä¸ªcacheåœ¨åœ†ç¯ä¸Šå°±ä¼šè¶³å¤Ÿåˆ†æ•£</strong>ã€‚ä½†æ˜¯åœ¨çœŸå®åœºæ™¯é‡Œï¼ŒcacheæœåŠ¡å™¨åªä¼šæœ‰å¾ˆå°‘ï¼Œæ‰€ä»¥ï¼Œå¼•å…¥äº†â€œè™šæ‹ŸèŠ‚ç‚¹â€çš„æ¦‚å¿µã€‚</p>
<p>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•åœ¨æœåŠ¡èŠ‚ç‚¹å¤ªå°‘æ—¶ï¼Œå®¹æ˜“å› ä¸ºèŠ‚ç‚¹åˆ†éƒ¨ä¸å‡åŒ€è€Œé€ æˆæ•°æ®å€¾æ–œé—®é¢˜ã€‚ä¾‹å¦‚æˆ‘ä»¬çš„ç³»ç»Ÿä¸­æœ‰ä¸¤å°æœåŠ¡å™¨ï¼Œå…¶ç¯åˆ†å¸ƒå¦‚ä¸‹ï¼š</p>
<p><img src="http://blog.codinglabs.org/uploads/pictures/consistent-hashing/7.png" alt="img"></p>
<p>æ­¤æ—¶å¿…ç„¶é€ æˆå¤§é‡æ•°æ®é›†ä¸­åˆ°Server 1ä¸Šï¼Œè€Œåªæœ‰æå°‘é‡ä¼šå®šä½åˆ°Server 2ä¸Šã€‚ä¸ºäº†è§£å†³è¿™ç§æ•°æ®å€¾æ–œé—®é¢˜ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å¼•å…¥äº†è™šæ‹ŸèŠ‚ç‚¹æœºåˆ¶ï¼Œ<strong>å°†ä¸€ä¸ªç‰©ç†èŠ‚ç‚¹æ‹†åˆ†ä¸ºå¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œå¹¶ä¸”åŒä¸€ä¸ªç‰©ç†èŠ‚ç‚¹çš„è™šæ‹ŸèŠ‚ç‚¹å°½é‡å‡åŒ€åˆ†å¸ƒåœ¨Hashç¯ä¸Š</strong>ã€‚å…·ä½“åšæ³•å¯ä»¥åœ¨æœåŠ¡å™¨ipæˆ–ä¸»æœºåçš„åé¢å¢åŠ ç¼–å·æ¥å®ç°ã€‚</p>
<h3 id="å®ç°ä¸€è‡´æ€§å“ˆå¸Œ-java"><a href="#å®ç°ä¸€è‡´æ€§å“ˆå¸Œ-java" class="headerlink" title="å®ç°ä¸€è‡´æ€§å“ˆå¸Œ(java)"></a>å®ç°ä¸€è‡´æ€§å“ˆå¸Œ(java)</h3><ul>
<li><strong>ä¸€è‡´æ€§Hashç®—æ³•å®ç°ç‰ˆæœ¬1ï¼šä¸å¸¦è™šæ‹ŸèŠ‚ç‚¹</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.ConsistentHash;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Map.Entry;</div><div class="line"><span class="keyword">import</span> java.util.TreeMap;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * ä¸€è‡´æ€§Hashç®—æ³•å®ç°ç‰ˆæœ¬1ï¼šä¸å¸¦è™šæ‹ŸèŠ‚ç‚¹</div><div class="line"> * </div><div class="line"> * <span class="doctag">@author</span> David</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsistentHashingWithoutVirtualNode</span> </span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line">   * å¾…æ·»åŠ å…¥Hashç¯çš„æœåŠ¡å™¨åˆ—è¡¨</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> String[] servers = &#123; <span class="string">"192.168.0.0:111"</span>, <span class="string">"192.168.0.1:111"</span>, <span class="string">"192.168.0.2:111"</span>, <span class="string">"192.168.0.3:111"</span>,</div><div class="line">      <span class="string">"192.168.0.4:111"</span> &#125;;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * keyè¡¨ç¤ºæœåŠ¡å™¨çš„hashå€¼ï¼Œvalueè¡¨ç¤ºæœåŠ¡å™¨çš„åç§°</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> TreeMap&lt;Integer, String&gt; treeMap = <span class="keyword">new</span> TreeMap&lt;Integer, String&gt;();</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * ç¨‹åºåˆå§‹åŒ–ï¼Œå°†æ‰€æœ‰çš„æœåŠ¡å™¨æ”¾å…¥sortedMapä¸­</div><div class="line">   */</div><div class="line">  <span class="keyword">static</span> &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; servers.length; i++) &#123;</div><div class="line">      <span class="keyword">int</span> hash = getHash(servers[i]);</div><div class="line">      System.out.println(<span class="string">"["</span> + servers[i] + <span class="string">"]åŠ å…¥é›†åˆä¸­, å…¶Hashå€¼ä¸º"</span> + hash);</div><div class="line">      treeMap.put(hash, servers[i]);</div><div class="line">    &#125;</div><div class="line">    System.out.println();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * ç®€å•èµ·è§ï¼Œå¤ç”¨Stringçš„hashCodeç®—æ³•;å®é™…hashç®—æ³•å¯ä»¥é‡‡ç”¨MurmurHash</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getHash</span><span class="params">(String str)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> hash = str.hashCode();</div><div class="line">    <span class="comment">// Stringçš„hashCode()æ–¹æ³•å´ä¼šäº§ç”Ÿè´Ÿæ•°ï¼Œå–ç»å¯¹å€¼</span></div><div class="line">    <span class="keyword">return</span> Math.abs(hash);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * å¾—åˆ°åº”å½“è·¯ç”±åˆ°çš„ç»“ç‚¹</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getServer</span><span class="params">(String node)</span> </span>&#123;</div><div class="line">    <span class="comment">// å¾—åˆ°å¸¦è·¯ç”±çš„ç»“ç‚¹çš„Hashå€¼</span></div><div class="line">    <span class="keyword">int</span> hash = getHash(node);</div><div class="line">    <span class="comment">// è·å–å¤§äºæˆ–ç­‰äºæŒ‡å®škeyçš„æœ€å°mapé”®ç›¸å…³è”çš„mapé”®å€¼å¯¹</span></div><div class="line">    Entry&lt;Integer, String&gt; entry = treeMap.ceilingEntry(hash);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> treeMap.firstEntry().getValue();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> entry.getValue();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    String[] nodes = &#123; <span class="string">"127.0.0.1:1111"</span>, <span class="string">"221.226.0.1:2222"</span>, <span class="string">"10.211.0.1:3333"</span> &#125;;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodes.length; i++)</div><div class="line">      System.out.println(<span class="string">"["</span> + nodes[i] + <span class="string">"]çš„hashå€¼ä¸º"</span> + getHash(nodes[i]) + <span class="string">", è¢«è·¯ç”±åˆ°ç»“ç‚¹["</span> + getServer(nodes[i]) + <span class="string">"]"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æµ‹è¯•ç»“æœ:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[192.168.0.0:111]åŠ å…¥é›†åˆä¸­, å…¶Hashå€¼ä¸º771739798</div><div class="line">[192.168.0.1:111]åŠ å…¥é›†åˆä¸­, å…¶Hashå€¼ä¸º770816277</div><div class="line">[192.168.0.2:111]åŠ å…¥é›†åˆä¸­, å…¶Hashå€¼ä¸º769892756</div><div class="line">[192.168.0.3:111]åŠ å…¥é›†åˆä¸­, å…¶Hashå€¼ä¸º768969235</div><div class="line">[192.168.0.4:111]åŠ å…¥é›†åˆä¸­, å…¶Hashå€¼ä¸º768045714</div><div class="line"></div><div class="line">[127.0.0.1:1111]çš„hashå€¼ä¸º35944419, è¢«è·¯ç”±åˆ°ç»“ç‚¹[192.168.0.4:111]</div><div class="line">[221.226.0.1:2222]çš„hashå€¼ä¸º973393028, è¢«è·¯ç”±åˆ°ç»“ç‚¹[192.168.0.4:111]</div><div class="line">[10.211.0.1:3333]çš„hashå€¼ä¸º561068530, è¢«è·¯ç”±åˆ°ç»“ç‚¹[192.168.0.4:111]</div></pre></td></tr></table></figure>
<p>ä»è¿è¡Œç»“æœæ¥çœ‹ï¼Œä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œä¸‰ä¸ªç‚¹è·¯ç”±åˆ°çš„éƒ½æ˜¯é¡ºæ—¶é’ˆç¦»ä»–ä»¬Hashå€¼æœ€è¿‘çš„é‚£å°æœåŠ¡å™¨ä¸Šã€‚</p>
<ul>
<li><strong>ä¸€è‡´æ€§Hashç®—æ³•å®ç°ç‰ˆæœ¬2ï¼šå¸¦è™šæ‹ŸèŠ‚ç‚¹</strong></li>
</ul>
<p>ç¼–ç¨‹æ–¹é¢éœ€è¦è€ƒè™‘çš„é—®é¢˜æ˜¯ï¼š</p>
<ol>
<li>ä¸€ä¸ªçœŸå®ç»“ç‚¹å¦‚ä½•å¯¹åº”æˆä¸ºå¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Ÿ</li>
<li>è™šæ‹ŸèŠ‚ç‚¹æ‰¾åˆ°åå¦‚ä½•è¿˜åŸä¸ºçœŸå®ç»“ç‚¹ï¼Ÿ</li>
</ol>
<p>è¿™ä¸¤ä¸ªé—®é¢˜å…¶å®æœ‰å¾ˆå¤šè§£å†³åŠæ³•ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸€ç§ç®€å•çš„åŠæ³•ï¼Œç»™æ¯ä¸ªçœŸå®ç»“ç‚¹åé¢æ ¹æ®è™šæ‹ŸèŠ‚ç‚¹åŠ ä¸Šåç¼€å†å–Hashå€¼ï¼Œæ¯”å¦‚â€192.168.0.0:111â€å°±æŠŠå®ƒå˜æˆâ€192.168.0.0:111&amp;&amp;VN0â€åˆ°â€192.168.0.0:111&amp;&amp;VN4â€ï¼ŒVNå°±æ˜¯Virtual Nodeçš„ç¼©å†™ï¼Œè¿˜åŸçš„æ—¶å€™åªéœ€è¦ä»å¤´æˆªå–å­—ç¬¦ä¸²åˆ°â€&amp;&amp;â€çš„ä½ç½®å°±å¯ä»¥äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.ConsistentHash;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.LinkedList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.Map.Entry;</div><div class="line"><span class="keyword">import</span> java.util.TreeMap;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * å¸¦è™šæ‹ŸèŠ‚ç‚¹çš„ä¸€è‡´æ€§Hashç®—æ³•</div><div class="line"> * </div><div class="line"> * <span class="doctag">@author</span> David</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsistentHashingWithVirtualNode</span> </span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line">   * å¾…æ·»åŠ å…¥Hashç¯çš„æœåŠ¡å™¨åˆ—è¡¨</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> String[] servers = &#123; <span class="string">"192.168.0.0:111"</span>, <span class="string">"192.168.0.1:111"</span>, <span class="string">"192.168.0.2:111"</span>, <span class="string">"192.168.0.3:111"</span>,</div><div class="line">      <span class="string">"192.168.0.4:111"</span> &#125;;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * çœŸå®ç»“ç‚¹åˆ—è¡¨,è€ƒè™‘åˆ°æœåŠ¡å™¨ä¸Šçº¿ã€ä¸‹çº¿çš„åœºæ™¯ï¼Œå³æ·»åŠ ã€åˆ é™¤çš„åœºæ™¯ä¼šæ¯”è¾ƒé¢‘ç¹ï¼Œè¿™é‡Œä½¿ç”¨LinkedListä¼šæ›´å¥½</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; realNodes = <span class="keyword">new</span> LinkedList&lt;String&gt;();</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * è™šæ‹ŸèŠ‚ç‚¹ï¼Œkeyè¡¨ç¤ºè™šæ‹ŸèŠ‚ç‚¹çš„hashå€¼ï¼Œvalueè¡¨ç¤ºè™šæ‹ŸèŠ‚ç‚¹çš„åç§°</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> TreeMap&lt;Integer, String&gt; virtualNodes = <span class="keyword">new</span> TreeMap&lt;Integer, String&gt;();</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * è™šæ‹ŸèŠ‚ç‚¹çš„æ•°ç›®ï¼Œè¿™é‡Œå†™æ­»ï¼Œä¸ºäº†æ¼”ç¤ºéœ€è¦ï¼Œä¸€ä¸ªçœŸå®ç»“ç‚¹å¯¹åº”5ä¸ªè™šæ‹ŸèŠ‚ç‚¹</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VIRTUAL_NODES = <span class="number">5</span>;</div><div class="line"></div><div class="line">  <span class="keyword">static</span> &#123;</div><div class="line">    <span class="comment">// å…ˆæŠŠåŸå§‹çš„æœåŠ¡å™¨æ·»åŠ åˆ°çœŸå®ç»“ç‚¹åˆ—è¡¨ä¸­</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; servers.length; i++)</div><div class="line">      realNodes.add(servers[i]);</div><div class="line"></div><div class="line">    <span class="comment">// å†æ·»åŠ è™šæ‹ŸèŠ‚ç‚¹ï¼Œéå†LinkedListä½¿ç”¨foreachå¾ªç¯æ•ˆç‡ä¼šæ¯”è¾ƒé«˜</span></div><div class="line">    <span class="keyword">for</span> (String str : realNodes) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; VIRTUAL_NODES; i++) &#123;</div><div class="line">        String virtualNodeName = str + <span class="string">"&amp;&amp;VN"</span> + String.valueOf(i);</div><div class="line">        <span class="keyword">int</span> hash = getHash(virtualNodeName);</div><div class="line">        System.out.println(<span class="string">"è™šæ‹ŸèŠ‚ç‚¹["</span> + virtualNodeName + <span class="string">"]è¢«æ·»åŠ , hashå€¼ä¸º"</span> + hash);</div><div class="line">        virtualNodes.put(hash, virtualNodeName);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    System.out.println();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * ç®€å•èµ·è§ï¼Œå¤ç”¨Stringçš„hashCodeç®—æ³•;å®é™…hashç®—æ³•å¯ä»¥é‡‡ç”¨MurmurHash</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getHash</span><span class="params">(String str)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> hash = str.hashCode();</div><div class="line">    <span class="comment">// Stringçš„hashCode()æ–¹æ³•å´ä¼šäº§ç”Ÿè´Ÿæ•°ï¼Œå–ç»å¯¹å€¼</span></div><div class="line">    <span class="keyword">return</span> Math.abs(hash);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * å¾—åˆ°åº”å½“è·¯ç”±åˆ°çš„ç»“ç‚¹</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getServer</span><span class="params">(String node)</span> </span>&#123;</div><div class="line">    <span class="comment">// å¾—åˆ°å¸¦è·¯ç”±çš„ç»“ç‚¹çš„Hashå€¼</span></div><div class="line">    <span class="keyword">int</span> hash = getHash(node);</div><div class="line">    <span class="comment">// è·å–å¤§äºæˆ–ç­‰äºæŒ‡å®škeyçš„æœ€å°mapé”®ç›¸å…³è”çš„mapé”®å€¼å¯¹</span></div><div class="line">    Entry&lt;Integer, String&gt; entry = virtualNodes.ceilingEntry(hash);</div><div class="line"></div><div class="line">    String virtualNode = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">      virtualNode = virtualNodes.firstEntry().getValue();</div><div class="line">    &#125;</div><div class="line">    virtualNode = entry.getValue();</div><div class="line">    <span class="keyword">return</span> virtualNode.substring(<span class="number">0</span>, virtualNode.indexOf(<span class="string">"&amp;&amp;"</span>));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    String[] nodes = &#123; <span class="string">"127.0.0.1:1111"</span>, <span class="string">"221.226.0.1:2222"</span>, <span class="string">"10.211.0.1:3333"</span> &#125;;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodes.length; i++)</div><div class="line">      System.out.println(<span class="string">"["</span> + nodes[i] + <span class="string">"]çš„hashå€¼ä¸º"</span> + getHash(nodes[i]) + <span class="string">", è¢«è·¯ç”±åˆ°ç»“ç‚¹["</span> + getServer(nodes[i]) + <span class="string">"]"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æµ‹è¯•ç»“æœ:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.0:111&amp;&amp;VN0]è¢«æ·»åŠ , hashå€¼ä¸º1490088590</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.0:111&amp;&amp;VN1]è¢«æ·»åŠ , hashå€¼ä¸º1490088591</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.0:111&amp;&amp;VN2]è¢«æ·»åŠ , hashå€¼ä¸º1490088592</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.0:111&amp;&amp;VN3]è¢«æ·»åŠ , hashå€¼ä¸º1490088593</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.0:111&amp;&amp;VN4]è¢«æ·»åŠ , hashå€¼ä¸º1490088594</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.1:111&amp;&amp;VN0]è¢«æ·»åŠ , hashå€¼ä¸º1293575085</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.1:111&amp;&amp;VN1]è¢«æ·»åŠ , hashå€¼ä¸º1293575086</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.1:111&amp;&amp;VN2]è¢«æ·»åŠ , hashå€¼ä¸º1293575087</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.1:111&amp;&amp;VN3]è¢«æ·»åŠ , hashå€¼ä¸º1293575088</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.1:111&amp;&amp;VN4]è¢«æ·»åŠ , hashå€¼ä¸º1293575089</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.2:111&amp;&amp;VN0]è¢«æ·»åŠ , hashå€¼ä¸º1097061580</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.2:111&amp;&amp;VN1]è¢«æ·»åŠ , hashå€¼ä¸º1097061581</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.2:111&amp;&amp;VN2]è¢«æ·»åŠ , hashå€¼ä¸º1097061582</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.2:111&amp;&amp;VN3]è¢«æ·»åŠ , hashå€¼ä¸º1097061583</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.2:111&amp;&amp;VN4]è¢«æ·»åŠ , hashå€¼ä¸º1097061584</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.3:111&amp;&amp;VN0]è¢«æ·»åŠ , hashå€¼ä¸º900548075</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.3:111&amp;&amp;VN1]è¢«æ·»åŠ , hashå€¼ä¸º900548076</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.3:111&amp;&amp;VN2]è¢«æ·»åŠ , hashå€¼ä¸º900548077</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.3:111&amp;&amp;VN3]è¢«æ·»åŠ , hashå€¼ä¸º900548078</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.3:111&amp;&amp;VN4]è¢«æ·»åŠ , hashå€¼ä¸º900548079</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.4:111&amp;&amp;VN0]è¢«æ·»åŠ , hashå€¼ä¸º704034570</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.4:111&amp;&amp;VN1]è¢«æ·»åŠ , hashå€¼ä¸º704034571</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.4:111&amp;&amp;VN2]è¢«æ·»åŠ , hashå€¼ä¸º704034572</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.4:111&amp;&amp;VN3]è¢«æ·»åŠ , hashå€¼ä¸º704034573</div><div class="line">è™šæ‹ŸèŠ‚ç‚¹[192.168.0.4:111&amp;&amp;VN4]è¢«æ·»åŠ , hashå€¼ä¸º704034574</div><div class="line"></div><div class="line">[127.0.0.1:1111]çš„hashå€¼ä¸º35944419, è¢«è·¯ç”±åˆ°ç»“ç‚¹[192.168.0.4:111]</div><div class="line">[221.226.0.1:2222]çš„hashå€¼ä¸º973393028, è¢«è·¯ç”±åˆ°ç»“ç‚¹[192.168.0.2:111]</div><div class="line">[10.211.0.1:3333]çš„hashå€¼ä¸º561068530, è¢«è·¯ç”±åˆ°ç»“ç‚¹[192.168.0.4:111]</div></pre></td></tr></table></figure>
<p>ä»è¿è¡Œç»“æœçœ‹ï¼Œæ¯ä¸ªç‚¹è·¯ç”±åˆ°çš„æœåŠ¡å™¨éƒ½æ˜¯Hashå€¼é¡ºæ—¶é’ˆç¦»å®ƒæœ€è¿‘çš„é‚£ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚</p>
<p>é€šè¿‡é‡‡å–è™šæ‹ŸèŠ‚ç‚¹çš„æ–¹æ³•ï¼Œä¸€ä¸ªçœŸå®ç»“ç‚¹ä¸å†å›ºå®šåœ¨Hashæ¢ä¸Šçš„æŸä¸ªç‚¹ï¼Œè€Œæ˜¯å¤§é‡åœ°åˆ†å¸ƒåœ¨æ•´ä¸ªHashç¯ä¸Šï¼Œè¿™æ ·å³ä½¿ä¸Šçº¿ã€ä¸‹çº¿æœåŠ¡å™¨ï¼Œä¹Ÿä¸ä¼šé€ æˆæ•´ä½“çš„è´Ÿè½½ä¸å‡è¡¡ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://blog.codinglabs.org/articles/consistent-hashing.html" target="_blank" rel="external">ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•åŠå…¶åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åº”ç”¨</a></p>
<p><a href="http://www.cnblogs.com/xrq730/p/5186728.html" target="_blank" rel="external">å¯¹ä¸€è‡´æ€§Hashç®—æ³•ï¼ŒJavaä»£ç å®ç°çš„æ·±å…¥ç ”ç©¶</a></p>
<p><a href="http://afghl.github.io/2016/11/19/implement-consistent-hashing.html" target="_blank" rel="external">å®ç°ä¸€è‡´æ€§å“ˆå¸Œjavaç‰ˆæœ¬</a></p>
<p><a href="http://calvin1978.blogcn.com/articles/murmur.html" target="_blank" rel="external">é™Œç”Ÿä½†é»˜é»˜ä¸€ç»Ÿæ±Ÿæ¹–çš„MurmurHash</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Semaphoreä¿¡å·é‡]]></title>
      <url>http://zsr.github.io/2017/06/01/Semaphore%E4%BF%A1%E5%8F%B7%E9%87%8F/</url>
      <content type="html"><![CDATA[<h3 id="æ¦‚è¦"><a href="#æ¦‚è¦" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h3><p>â€‹    <code>Semaphore</code>å½“å‰åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è¢«æ‰©æ”¾ä½¿ç”¨ï¼Œæ“ä½œç³»ç»Ÿçš„ä¿¡å·é‡æ˜¯ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œåœ¨è¿›ç¨‹æ§åˆ¶æ–¹é¢éƒ½æœ‰åº”ç”¨ã€‚Java å¹¶å‘åº“çš„<code>Semaphore</code>å¯ä»¥å¾ˆè½»æ¾å®Œæˆä¿¡å·é‡æ§åˆ¶ï¼Œ<code>Semaphore</code>å¯ä»¥æ§åˆ¶æŸä¸ªèµ„æºå¯è¢«åŒæ—¶è®¿é—®çš„ä¸ªæ•°ï¼Œé€šè¿‡ <code>acquire()</code>è·å–ä¸€ä¸ªè®¸å¯ï¼Œå¦‚æœæ²¡æœ‰å°±ç­‰å¾…ï¼Œè€Œ<code>release()</code>é‡Šæ”¾ä¸€ä¸ªè®¸å¯ã€‚ç”¨æ¥æ§åˆ¶èµ„æºåŒæ—¶è®¿é—®ä¸ªæ•°</p>
<p>â€‹      ä»¥ä¸€ä¸ªåœè½¦åœºè¿ä½œä¸ºä¾‹ã€‚å‡è®¾åœè½¦åœºåªæœ‰ä¸‰ä¸ªè½¦ä½ï¼Œä¸€å¼€å§‹ä¸‰ä¸ªè½¦ä½éƒ½æ˜¯ç©ºçš„ã€‚è¿™æ—¶å¦‚æœåŒæ—¶æ¥äº†äº”è¾†è½¦ï¼Œçœ‹é—¨äººå…è®¸å…¶ä¸­ä¸‰è¾†ä¸å—é˜»ç¢çš„è¿›å…¥ï¼Œç„¶åæ”¾ä¸‹è½¦æ‹¦ï¼Œå‰©ä¸‹çš„è½¦åˆ™å¿…é¡»åœ¨å…¥å£ç­‰å¾…ï¼Œæ­¤åæ¥çš„è½¦ä¹Ÿéƒ½ä¸å¾—ä¸åœ¨å…¥å£å¤„ç­‰å¾…ã€‚è¿™æ—¶ï¼Œæœ‰ä¸€è¾†è½¦ç¦»å¼€åœè½¦åœºï¼Œçœ‹é—¨äººå¾—çŸ¥åï¼Œæ‰“å¼€è½¦æ‹¦ï¼Œæ”¾å…¥ä¸€è¾†ï¼Œå¦‚æœåˆç¦»å¼€ä¸¤è¾†ï¼Œåˆ™åˆå¯ä»¥æ”¾å…¥ä¸¤è¾†ï¼Œå¦‚æ­¤å¾€å¤ã€‚</p>
<h3 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h3><p><code>Semaphore</code>æä¾›äº†ä¸€ä¸ªå¸¦æœ‰<code>boolean</code>å‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œ<code>true</code>ä»£è¡¨å…¬å¹³é”ï¼Œ<code>false</code>ä»£è¡¨éå…¬å¹³é”ï¼Œé»˜è®¤å®ç°æ˜¯éå…¬å¹³é”ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Semaphore</span><span class="params">(<span class="keyword">int</span> permits)</span></span>; <span class="comment">// åˆ›å»ºå…·æœ‰ç»™å®šè®¸å¯æ•°çš„éå…¬å¹³Semaphore</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Semaphore</span><span class="params">(<span class="keyword">int</span> permits, <span class="keyword">boolean</span> fair)</span></span>; <span class="comment">//åˆ›å»ºå…·æœ‰ç»™å®šè®¸å¯æ•°çš„å…¬å¹³(true)æˆ–éå…¬å¹³(false) Semaphore</span></div></pre></td></tr></table></figure>
<h3 id="æ™®é€šæ–¹æ³•"><a href="#æ™®é€šæ–¹æ³•" class="headerlink" title="æ™®é€šæ–¹æ³•"></a>æ™®é€šæ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">()</span> <span class="comment">//ä»æ­¤ä¿¡å·é‡è·å–ä¸€ä¸ªè®¸å¯ï¼Œåœ¨æä¾›ä¸€ä¸ªè®¸å¯å‰ä¸€ç›´å°†çº¿ç¨‹é˜»å¡ï¼Œå¦åˆ™çº¿ç¨‹è¢«ä¸­æ–­</span></span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> permits)</span> <span class="comment">//ä»æ­¤ä¿¡å·é‡è·å–ç»™å®šæ•°ç›®çš„è®¸å¯ï¼Œåœ¨æä¾›è¿™äº›è®¸å¯å‰ä¸€ç›´å°†çº¿ç¨‹é˜»å¡ï¼Œæˆ–è€…çº¿ç¨‹å·²è¢«ä¸­æ–­</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> <span class="comment">//é‡Šæ”¾ä¸€ä¸ªè®¸å¯ï¼Œå°†å¯ç”¨çš„è®¸å¯æ•°å¢åŠ 1</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> permits)</span> <span class="comment">//é‡Šæ”¾ç»™å®šæ•°ç›®çš„è®¸å¯ï¼Œå°†å…¶è¿”å›åˆ°ä¿¡å·é‡</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFair</span><span class="params">()</span> <span class="comment">//å¦‚æœæ­¤ä¿¡å·é‡çš„å…¬å¹³è®¾ç½®ä¸ºtrueï¼Œåˆ™è¿”å› true</span></div></pre></td></tr></table></figure>
<h3 id="åœè½¦æ¡ˆä¾‹"><a href="#åœè½¦æ¡ˆä¾‹" class="headerlink" title="åœè½¦æ¡ˆä¾‹"></a>åœè½¦æ¡ˆä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.Semaphore;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Semaphore parkingspace;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> carNo;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * <span class="doctag">@param</span> parkingspace</div><div class="line">   * <span class="doctag">@param</span> carNo</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Car</span><span class="params">(Semaphore parkingspace, <span class="keyword">int</span> carNo)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.parkingspace = parkingspace;</div><div class="line">    <span class="keyword">this</span>.carNo = carNo;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      parkingspace.acquire();</div><div class="line">      parking();</div><div class="line">      Thread.sleep(<span class="number">300</span>);</div><div class="line">      parkingspace.release();</div><div class="line">      leaving();</div><div class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parking</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(String.format(<span class="string">"%då·è½¦æ³Šè½¦"</span>, carNo));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">leaving</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(String.format(<span class="string">"%då·è½¦ç¦»å¼€è½¦ä½"</span>, carNo));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParkingCars</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NUMBER_OF_CARS = <span class="number">5</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NUMBER_OF_PARKING_SPACE = <span class="number">3</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    </div><div class="line">    Semaphore parkingSpace = <span class="keyword">new</span> Semaphore(NUMBER_OF_PARKING_SPACE, <span class="keyword">true</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> carNo = <span class="number">1</span>; carNo &lt;= NUMBER_OF_CARS; carNo++) &#123;</div><div class="line">      <span class="keyword">new</span> Thread(<span class="keyword">new</span> Car(parkingSpace, carNo)).start();</div><div class="line">    &#125;</div><div class="line">    Thread.sleep(<span class="number">3000</span>);</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * è¾“å‡ºè¿˜æœ‰å‡ ä¸ªå¯ä»¥ç”¨çš„èµ„æºæ•°</div><div class="line">     */</div><div class="line">    System.out.println(parkingSpace.availablePermits() + <span class="string">" ä¸ªåœè½¦ä½å¯ä»¥ç”¨!"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="number">2</span>å·è½¦æ³Šè½¦</div><div class="line"><span class="number">1</span>å·è½¦æ³Šè½¦</div><div class="line"><span class="number">3</span>å·è½¦æ³Šè½¦</div><div class="line"><span class="number">2</span>å·è½¦ç¦»å¼€è½¦ä½</div><div class="line"><span class="number">4</span>å·è½¦æ³Šè½¦</div><div class="line"><span class="number">3</span>å·è½¦ç¦»å¼€è½¦ä½</div><div class="line"><span class="number">1</span>å·è½¦ç¦»å¼€è½¦ä½</div><div class="line"><span class="number">5</span>å·è½¦æ³Šè½¦</div><div class="line"><span class="number">4</span>å·è½¦ç¦»å¼€è½¦ä½</div><div class="line"><span class="number">5</span>å·è½¦ç¦»å¼€è½¦ä½</div><div class="line"><span class="number">3</span> ä¸ªåœè½¦ä½å¯ä»¥ç”¨!</div></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è®¾è®¡æ¨¡å¼-å•ä¾‹æ¨¡å¼]]></title>
      <url>http://zsr.github.io/2017/05/19/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[è®¾è®¡æ¨¡å¼-å»ºé€ è€…æ¨¡å¼]]></title>
      <url>http://zsr.github.io/2017/05/18/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<p>â€‹       åœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œå­˜åœ¨å¤§é‡ç±»ä¼¼æ±½è½¦ä¸€æ ·çš„å¤æ‚å¯¹è±¡ï¼Œå®ƒä»¬æ‹¥æœ‰ä¸€ç³»åˆ—æˆå‘˜å±æ€§ï¼Œè¿™äº›æˆå‘˜å±æ€§ä¸­æœ‰äº›æ˜¯å¼•ç”¨ç±»å‹çš„æˆå‘˜å¯¹è±¡ã€‚è€Œä¸”åœ¨è¿™äº›å¤æ‚å¯¹è±¡ä¸­ï¼Œè¿˜å¯èƒ½å­˜åœ¨ä¸€äº›é™åˆ¶æ¡ä»¶ï¼Œå¦‚æŸäº›å±æ€§æ²¡æœ‰èµ‹å€¼åˆ™å¤æ‚å¯¹è±¡ä¸èƒ½ä½œä¸ºä¸€ä¸ªå®Œæ•´çš„äº§å“ä½¿ç”¨ï¼›æœ‰äº›å±æ€§çš„èµ‹å€¼å¿…é¡»æŒ‰ç…§æŸä¸ªé¡ºåºï¼Œä¸€ä¸ªå±æ€§æ²¡æœ‰èµ‹å€¼ä¹‹å‰ï¼Œå¦ä¸€ä¸ªå±æ€§å¯èƒ½æ— æ³•èµ‹å€¼ç­‰ã€‚</p>
<p>å¤æ‚å¯¹è±¡ç›¸å½“äºä¸€è¾†æœ‰å¾…å»ºé€ çš„æ±½è½¦ï¼Œè€Œå¯¹è±¡çš„å±æ€§ç›¸å½“äºæ±½è½¦çš„éƒ¨ä»¶ï¼Œå»ºé€ äº§å“çš„è¿‡ç¨‹å°±ç›¸å½“äºç»„åˆéƒ¨ä»¶çš„è¿‡ç¨‹ã€‚ç”±äºç»„åˆéƒ¨ä»¶çš„è¿‡ç¨‹å¾ˆå¤æ‚ï¼Œå› æ­¤ï¼Œè¿™äº›éƒ¨ä»¶çš„ç»„åˆè¿‡ç¨‹å¾€å¾€è¢«â€œå¤–éƒ¨åŒ–â€åˆ°ä¸€ä¸ªç§°ä½œå»ºé€ è€…çš„å¯¹è±¡é‡Œï¼Œå»ºé€ è€…è¿”è¿˜ç»™å®¢æˆ·ç«¯çš„æ˜¯ä¸€ä¸ªå·²ç»å»ºé€ å®Œæ¯•çš„å®Œæ•´äº§å“å¯¹è±¡ï¼Œè€Œç”¨æˆ·æ— é¡»å…³å¿ƒè¯¥å¯¹è±¡æ‰€åŒ…å«çš„å±æ€§ä»¥åŠå®ƒä»¬çš„ç»„è£…æ–¹å¼ï¼Œè¿™å°±æ˜¯å»ºé€ è€…æ¨¡å¼çš„æ¨¡å¼åŠ¨æœºã€‚</p>
<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>â€‹      å»ºé€ è€…æ¨¡å¼æ˜¯è¾ƒä¸ºå¤æ‚çš„åˆ›å»ºå‹æ¨¡å¼ï¼Œå®ƒå°†å®¢æˆ·ç«¯ä¸åŒ…å«å¤šä¸ªç»„æˆéƒ¨åˆ†ï¼ˆæˆ–éƒ¨ä»¶ï¼‰çš„å¤æ‚å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹åˆ†ç¦»ï¼Œå®¢æˆ·ç«¯æ— é¡»çŸ¥é“å¤æ‚å¯¹è±¡çš„å†…éƒ¨ç»„æˆéƒ¨åˆ†ä¸è£…é…æ–¹å¼ï¼Œåªéœ€è¦çŸ¥é“æ‰€éœ€å»ºé€ è€…çš„ç±»å‹å³å¯ã€‚å®ƒå…³æ³¨å¦‚ä½•ä¸€æ­¥ä¸€æ­¥åˆ›å»ºä¸€ä¸ªçš„å¤æ‚å¯¹è±¡ï¼Œä¸åŒçš„å…·ä½“å»ºé€ è€…å®šä¹‰äº†ä¸åŒçš„åˆ›å»ºè¿‡ç¨‹ï¼Œä¸”å…·ä½“å»ºé€ è€…ç›¸äº’ç‹¬ç«‹ï¼Œå¢åŠ æ–°çš„å»ºé€ è€…éå¸¸æ–¹ä¾¿ï¼Œæ— é¡»ä¿®æ”¹å·²æœ‰ä»£ç ï¼Œç³»ç»Ÿå…·æœ‰è¾ƒå¥½çš„æ‰©å±•æ€§ã€‚</p>
<h3 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">å»ºé€ è€…æ¨¡å¼(Builder Pattern)ï¼šå°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚å»ºé€ è€…æ¨¡å¼æ˜¯ä¸€ç§å¯¹è±¡åˆ›å»ºå‹æ¨¡å¼ã€‚</div></pre></td></tr></table></figure>
<p>å»ºé€ è€…æ¨¡å¼ä¸€æ­¥ä¸€æ­¥åˆ›å»ºä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ï¼Œå®ƒå…è®¸ç”¨æˆ·åªé€šè¿‡æŒ‡å®šå¤æ‚å¯¹è±¡çš„ç±»å‹å’Œå†…å®¹å°±å¯ä»¥æ„å»ºå®ƒä»¬ï¼Œç”¨æˆ·ä¸éœ€è¦çŸ¥é“å†…éƒ¨çš„å…·ä½“æ„å»ºç»†èŠ‚ã€‚</p>
<h3 id="ç»“æ„å›¾"><a href="#ç»“æ„å›¾" class="headerlink" title="ç»“æ„å›¾"></a>ç»“æ„å›¾</h3><p><img src="http://design-patterns.readthedocs.io/zh_CN/latest/_images/Builder.jpg" alt="img"></p>
<h3 id="è§’è‰²"><a href="#è§’è‰²" class="headerlink" title="è§’è‰²"></a>è§’è‰²</h3><p>åœ¨å»ºé€ è€…æ¨¡å¼ç»“æ„å›¾ä¸­åŒ…å«å¦‚ä¸‹å‡ ä¸ªè§’è‰²ï¼š</p>
<ul>
<li><strong>Builderï¼ˆæŠ½è±¡å»ºé€ è€…ï¼‰ï¼š</strong>å®ƒä¸ºåˆ›å»ºä¸€ä¸ªäº§å“Productå¯¹è±¡çš„å„ä¸ªéƒ¨ä»¶æŒ‡å®šæŠ½è±¡æ¥å£ï¼Œåœ¨è¯¥æ¥å£ä¸­ä¸€èˆ¬å£°æ˜ä¸¤ç±»æ–¹æ³•ï¼Œä¸€ç±»æ–¹æ³•æ˜¯buildPartX()ï¼Œå®ƒä»¬ç”¨äºåˆ›å»ºå¤æ‚å¯¹è±¡çš„å„ä¸ªéƒ¨ä»¶ï¼›å¦ä¸€ç±»æ–¹æ³•æ˜¯getResult()ï¼Œå®ƒä»¬ç”¨äºè¿”å›å¤æ‚å¯¹è±¡ã€‚Builderæ—¢å¯ä»¥æ˜¯æŠ½è±¡ç±»ï¼Œä¹Ÿå¯ä»¥æ˜¯æ¥å£ã€‚</li>
<li><strong>ConcreteBuilderï¼ˆå…·ä½“å»ºé€ è€…ï¼‰ï¼š</strong>å®ƒå®ç°äº†Builderæ¥å£ï¼Œå®ç°å„ä¸ªéƒ¨ä»¶çš„å…·ä½“æ„é€ å’Œè£…é…æ–¹æ³•ï¼Œå®šä¹‰å¹¶æ˜ç¡®å®ƒæ‰€åˆ›å»ºçš„å¤æ‚å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æä¾›ä¸€ä¸ªæ–¹æ³•è¿”å›åˆ›å»ºå¥½çš„å¤æ‚äº§å“å¯¹è±¡ã€‚</li>
<li><strong>Productï¼ˆäº§å“è§’è‰²ï¼‰ï¼š</strong>å®ƒæ˜¯è¢«æ„å»ºçš„å¤æ‚å¯¹è±¡ï¼ŒåŒ…å«å¤šä¸ªç»„æˆéƒ¨ä»¶ï¼Œå…·ä½“å»ºé€ è€…åˆ›å»ºè¯¥äº§å“çš„å†…éƒ¨è¡¨ç¤ºå¹¶å®šä¹‰å®ƒçš„è£…é…è¿‡ç¨‹ã€‚</li>
<li><strong>Directorï¼ˆæŒ‡æŒ¥è€…ï¼‰ï¼š</strong>æŒ‡æŒ¥è€…åˆç§°ä¸ºå¯¼æ¼”ç±»ï¼Œå®ƒè´Ÿè´£å®‰æ’å¤æ‚å¯¹è±¡çš„å»ºé€ æ¬¡åºï¼ŒæŒ‡æŒ¥è€…ä¸æŠ½è±¡å»ºé€ è€…ä¹‹é—´å­˜åœ¨å…³è”å…³ç³»ï¼Œå¯ä»¥åœ¨å…¶construct()å»ºé€ æ–¹æ³•ä¸­è°ƒç”¨å»ºé€ è€…å¯¹è±¡çš„éƒ¨ä»¶æ„é€ ä¸è£…é…æ–¹æ³•ï¼Œå®Œæˆå¤æ‚å¯¹è±¡çš„å»ºé€ ã€‚å®¢æˆ·ç«¯ä¸€èˆ¬åªéœ€è¦ä¸æŒ‡æŒ¥è€…è¿›è¡Œäº¤äº’ï¼Œåœ¨å®¢æˆ·ç«¯ç¡®å®šå…·ä½“å»ºé€ è€…çš„ç±»å‹ï¼Œå¹¶å®ä¾‹åŒ–å…·ä½“å»ºé€ è€…å¯¹è±¡ï¼ˆä¹Ÿå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶å’Œåå°„æœºåˆ¶ï¼‰ï¼Œç„¶åé€šè¿‡æŒ‡æŒ¥è€…ç±»çš„æ„é€ å‡½æ•°æˆ–è€…Setteræ–¹æ³•å°†è¯¥å¯¹è±¡ä¼ å…¥æŒ‡æŒ¥è€…ç±»ä¸­ã€‚</li>
</ul>
<a id="more"></a>
<h3 id="æ—¶åºå›¾"><a href="#æ—¶åºå›¾" class="headerlink" title="æ—¶åºå›¾"></a>æ—¶åºå›¾</h3><p><img src="http://design-patterns.readthedocs.io/zh_CN/latest/_images/seq_Builder.jpg" alt="img"></p>
<h3 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h3><p>å¤æ‚å¯¹è±¡ç±»ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Class Product  &#123;</div><div class="line">       <span class="keyword">private</span>  String partA; <span class="comment">//å®šä¹‰éƒ¨ä»¶ï¼Œéƒ¨ä»¶å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼ŒåŒ…æ‹¬å€¼ç±»å‹å’Œå¼•ç”¨ç±»å‹</span></div><div class="line">       <span class="keyword">private</span>  String partB;</div><div class="line">       <span class="keyword">private</span>  String partC;</div><div class="line">       <span class="comment">//partAçš„Getteræ–¹æ³•å’ŒSetteræ–¹æ³•çœç•¥</span></div><div class="line">       <span class="comment">//partBçš„Getteræ–¹æ³•å’ŒSetteræ–¹æ³•çœç•¥</span></div><div class="line">       <span class="comment">//partCçš„Getteræ–¹æ³•å’ŒSetteræ–¹æ³•çœç•¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨æŠ½è±¡å»ºé€ è€…ç±»ä¸­å®šä¹‰äº†äº§å“çš„åˆ›å»ºæ–¹æ³•å’Œè¿”å›æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</div><div class="line">       <span class="comment">//åˆ›å»ºäº§å“å¯¹è±¡</span></div><div class="line">       <span class="keyword">protected</span> Product product=<span class="keyword">new</span> Product();</div><div class="line">      </div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildPartA</span><span class="params">()</span></span>;</div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildPartB</span><span class="params">()</span></span>;</div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildPartC</span><span class="params">()</span></span>;</div><div class="line">      </div><div class="line">       <span class="comment">//è¿”å›äº§å“å¯¹è±¡</span></div><div class="line">       <span class="function"><span class="keyword">public</span> Product <span class="title">getResult</span><span class="params">()</span> </span>&#123;</div><div class="line">              <span class="keyword">return</span> product;</div><div class="line">       &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨æŠ½è±¡ç±»<code>Builder</code>ä¸­å£°æ˜äº†ä¸€ç³»åˆ—æŠ½è±¡çš„<code>buildPartX()</code>æ–¹æ³•ç”¨äºåˆ›å»ºå¤æ‚äº§å“çš„å„ä¸ªéƒ¨ä»¶ï¼Œå…·ä½“å»ºé€ è¿‡ç¨‹åœ¨<code>ConcreteBuilder</code>ä¸­å®ç°ï¼Œæ­¤å¤–è¿˜æä¾›äº†å·¥å‚æ–¹æ³•<code>getResult()</code>ï¼Œç”¨äºè¿”å›ä¸€ä¸ªå»ºé€ å¥½çš„å®Œæ•´äº§å“ã€‚</p>
<p>â€‹      åœ¨<code>ConcreteBuilder</code>ä¸­å®ç°äº†<code>buildPartX()</code>æ–¹æ³•ï¼Œé€šè¿‡è°ƒç”¨<code>Product</code>çš„<code>setPartX()</code>æ–¹æ³•å¯ä»¥ç»™äº§å“å¯¹è±¡çš„æˆå‘˜å±æ€§è®¾å€¼ã€‚ä¸åŒçš„å…·ä½“å»ºé€ è€…åœ¨å®ç°<code>buildPartX()</code>æ–¹æ³•æ—¶å°†æœ‰æ‰€åŒºåˆ«ï¼Œå¦‚<code>setPartX()</code>æ–¹æ³•çš„å‚æ•°å¯èƒ½ä¸ä¸€æ ·ï¼Œåœ¨æœ‰äº›å…·ä½“å»ºé€ è€…ç±»ä¸­æŸäº›<code>setPartX()</code>æ–¹æ³•æ— é¡»å®ç°ï¼ˆæä¾›ä¸€ä¸ªç©ºå®ç°ï¼‰ã€‚è€Œè¿™äº›å¯¹äºå®¢æˆ·ç«¯æ¥è¯´éƒ½æ— é¡»å…³å¿ƒï¼Œå®¢æˆ·ç«¯åªéœ€çŸ¥é“å…·ä½“å»ºé€ è€…ç±»å‹å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildPartA</span><span class="params">()</span> </span>&#123;</div><div class="line">      product.setPartA(<span class="string">"A"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildPartB</span><span class="params">()</span> </span>&#123;</div><div class="line">      product.setPartB(<span class="string">"B"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildPartC</span><span class="params">()</span> </span>&#123;</div><div class="line">      product.setPartC(<span class="string">"C"</span>);</div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>â€‹      åœ¨å»ºé€ è€…æ¨¡å¼çš„ç»“æ„ä¸­è¿˜å¼•å…¥äº†ä¸€ä¸ªæŒ‡æŒ¥è€…ç±»<code>Director</code>ï¼Œè¯¥ç±»ä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼šä¸€æ–¹é¢å®ƒéš”ç¦»äº†å®¢æˆ·ä¸åˆ›å»ºè¿‡ç¨‹ï¼›å¦ä¸€æ–¹é¢å®ƒæ§åˆ¶äº§å“çš„åˆ›å»ºè¿‡ç¨‹ï¼ŒåŒ…æ‹¬æŸä¸ª<code>buildPartX()</code>æ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨ä»¥åŠå¤šä¸ª<code>buildPartX()</code>æ–¹æ³•è°ƒç”¨çš„å…ˆåæ¬¡åºç­‰ã€‚æŒ‡æŒ¥è€…é’ˆå¯¹æŠ½è±¡å»ºé€ è€…ç¼–ç¨‹ï¼Œå®¢æˆ·ç«¯åªéœ€è¦çŸ¥é“å…·ä½“å»ºé€ è€…çš„ç±»å‹ï¼Œå³å¯é€šè¿‡æŒ‡æŒ¥è€…ç±»è°ƒç”¨å»ºé€ è€…çš„ç›¸å…³æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªå®Œæ•´çš„äº§å“å¯¹è±¡ã€‚åœ¨å®é™…ç”Ÿæ´»ä¸­ä¹Ÿå­˜åœ¨ç±»ä¼¼æŒ‡æŒ¥è€…ä¸€æ ·çš„è§’è‰²ï¼Œå¦‚ä¸€ä¸ªå®¢æˆ·å»è´­ä¹°ç”µè„‘ï¼Œç”µè„‘é”€å”®äººå‘˜ç›¸å½“äºæŒ‡æŒ¥è€…ï¼Œåªè¦å®¢æˆ·ç¡®å®šç”µè„‘çš„ç±»å‹ï¼Œç”µè„‘é”€å”®äººå‘˜å¯ä»¥é€šçŸ¥ç”µè„‘ç»„è£…äººå‘˜ç»™å®¢æˆ·ç»„è£…ä¸€å°ç”µè„‘ã€‚æŒ‡æŒ¥è€…ç±»çš„ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Director</span> </span>&#123;</div><div class="line">       <span class="keyword">private</span>  Builder builder;</div><div class="line">      </div><div class="line">       <span class="function"><span class="keyword">public</span>  <span class="title">Director</span><span class="params">(Builder builder)</span> </span>&#123;</div><div class="line">              <span class="keyword">this</span>.builder=builder;</div><div class="line">       &#125;</div><div class="line">      </div><div class="line">       <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">setBuilder</span><span class="params">(Builder builder)</span> </span>&#123;</div><div class="line">              <span class="keyword">this</span>.builder=builer;</div><div class="line">       &#125;</div><div class="line">      </div><div class="line">      <span class="comment">//äº§å“æ„å»ºä¸ç»„è£…æ–¹æ³•</span></div><div class="line">       <span class="function"><span class="keyword">public</span> Product <span class="title">construct</span><span class="params">()</span> </span>&#123;</div><div class="line">              builder.buildPartA();</div><div class="line">              builder.buildPartB();</div><div class="line">              builder.buildPartC();</div><div class="line">              <span class="keyword">return</span> builder.getResult();</div><div class="line">       &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨æŒ‡æŒ¥è€…ç±»ä¸­å¯ä»¥æ³¨å…¥ä¸€ä¸ªæŠ½è±¡å»ºé€ è€…ç±»å‹çš„å¯¹è±¡ï¼Œå…¶æ ¸å¿ƒåœ¨äºæä¾›äº†ä¸€ä¸ªå»ºé€ æ–¹æ³•construct()ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨äº†builderå¯¹è±¡çš„æ„é€ éƒ¨ä»¶çš„æ–¹æ³•ï¼Œæœ€åè¿”å›ä¸€ä¸ªäº§å“å¯¹è±¡ã€‚</p>
<p>å¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œåªéœ€å…³å¿ƒå…·ä½“çš„å»ºé€ è€…å³å¯ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ç±»ä»£ç ç‰‡æ®µå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Builder  builder = <span class="keyword">new</span> ConcreteBuilder(); <span class="comment">//å¯é€šè¿‡é…ç½®æ–‡ä»¶å®ç°</span></div><div class="line">Director director = <span class="keyword">new</span> Director(builder);</div><div class="line">Product product = director.construct();</div></pre></td></tr></table></figure>
<p>å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ¥å­˜å‚¨å…·ä½“å»ºé€ è€…ç±»ConcreteBuilderçš„ç±»åï¼Œä½¿å¾—æ›´æ¢æ–°çš„å»ºé€ è€…æ—¶æ— é¡»ä¿®æ”¹æºä»£ç ï¼Œç³»ç»Ÿæ‰©å±•æ›´ä¸ºæ–¹ä¾¿ã€‚åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ï¼Œæ— é¡»å…³å¿ƒäº§å“å¯¹è±¡çš„å…·ä½“ç»„è£…è¿‡ç¨‹ï¼Œåªéœ€æŒ‡å®šå…·ä½“å»ºé€ è€…çš„ç±»å‹å³å¯ã€‚</p>
<h3 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><ul>
<li>åœ¨å»ºé€ è€…æ¨¡å¼ä¸­ï¼Œ <strong>å®¢æˆ·ç«¯ä¸å¿…çŸ¥é“äº§å“å†…éƒ¨ç»„æˆçš„ç»†èŠ‚ï¼Œå°†äº§å“æœ¬èº«ä¸äº§å“çš„åˆ›å»ºè¿‡ç¨‹è§£è€¦ï¼Œä½¿å¾—ç›¸åŒçš„åˆ›å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„äº§å“å¯¹è±¡ã€‚</strong></li>
<li>æ¯ä¸€ä¸ªå…·ä½“å»ºé€ è€…éƒ½ç›¸å¯¹ç‹¬ç«‹ï¼Œè€Œä¸å…¶ä»–çš„å…·ä½“å»ºé€ è€…æ— å…³ï¼Œå› æ­¤å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ›¿æ¢å…·ä½“å»ºé€ è€…æˆ–å¢åŠ æ–°çš„å…·ä½“å»ºé€ è€…ï¼Œ <strong>ç”¨æˆ·ä½¿ç”¨ä¸åŒçš„å…·ä½“å»ºé€ è€…å³å¯å¾—åˆ°ä¸åŒçš„äº§å“å¯¹è±¡</strong> ã€‚</li>
<li><strong>å¯ä»¥æ›´åŠ ç²¾ç»†åœ°æ§åˆ¶äº§å“çš„åˆ›å»ºè¿‡ç¨‹</strong> ã€‚å°†å¤æ‚äº§å“çš„åˆ›å»ºæ­¥éª¤åˆ†è§£åœ¨ä¸åŒçš„æ–¹æ³•ä¸­ï¼Œä½¿å¾—åˆ›å»ºè¿‡ç¨‹æ›´åŠ æ¸…æ™°ï¼Œä¹Ÿæ›´æ–¹ä¾¿ä½¿ç”¨ç¨‹åºæ¥æ§åˆ¶åˆ›å»ºè¿‡ç¨‹ã€‚</li>
<li><strong>å¢åŠ æ–°çš„å…·ä½“å»ºé€ è€…æ— é¡»ä¿®æ”¹åŸæœ‰ç±»åº“çš„ä»£ç ï¼ŒæŒ‡æŒ¥è€…ç±»é’ˆå¯¹æŠ½è±¡å»ºé€ è€…ç±»ç¼–ç¨‹ï¼Œç³»ç»Ÿæ‰©å±•æ–¹ä¾¿ï¼Œç¬¦åˆâ€œå¼€é—­åŸåˆ™â€ã€‚</strong></li>
</ul>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ul>
<li>å»ºé€ è€…æ¨¡å¼æ‰€åˆ›å»ºçš„äº§å“ä¸€èˆ¬å…·æœ‰è¾ƒå¤šçš„å…±åŒç‚¹ï¼Œå…¶ç»„æˆéƒ¨åˆ†ç›¸ä¼¼ï¼Œå¦‚æœäº§å“ä¹‹é—´çš„å·®å¼‚æ€§å¾ˆå¤§ï¼Œåˆ™ä¸é€‚åˆä½¿ç”¨å»ºé€ è€…æ¨¡å¼ï¼Œå› æ­¤å…¶ä½¿ç”¨èŒƒå›´å—åˆ°ä¸€å®šçš„é™åˆ¶ã€‚</li>
<li>å¦‚æœäº§å“çš„å†…éƒ¨å˜åŒ–å¤æ‚ï¼Œå¯èƒ½ä¼šå¯¼è‡´éœ€è¦å®šä¹‰å¾ˆå¤šå…·ä½“å»ºé€ è€…ç±»æ¥å®ç°è¿™ç§å˜åŒ–ï¼Œå¯¼è‡´ç³»ç»Ÿå˜å¾—å¾ˆåºå¤§ã€‚</li>
</ul>
<h3 id="é€‚ç”¨åœºæ™¯"><a href="#é€‚ç”¨åœºæ™¯" class="headerlink" title="é€‚ç”¨åœºæ™¯"></a><strong>é€‚ç”¨åœºæ™¯</strong></h3><p>â€‹      åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å¯ä»¥è€ƒè™‘ä½¿ç”¨å»ºé€ è€…æ¨¡å¼ï¼š</p>
<ol>
<li>éœ€è¦ç”Ÿæˆçš„äº§å“å¯¹è±¡æœ‰å¤æ‚çš„å†…éƒ¨ç»“æ„ï¼Œè¿™äº›äº§å“å¯¹è±¡é€šå¸¸åŒ…å«å¤šä¸ªæˆå‘˜å±æ€§ã€‚</li>
<li>éœ€è¦ç”Ÿæˆçš„äº§å“å¯¹è±¡çš„å±æ€§ç›¸äº’ä¾èµ–ï¼Œéœ€è¦æŒ‡å®šå…¶ç”Ÿæˆé¡ºåºã€‚</li>
<li>å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ç‹¬ç«‹äºåˆ›å»ºè¯¥å¯¹è±¡çš„ç±»ã€‚åœ¨å»ºé€ è€…æ¨¡å¼ä¸­é€šè¿‡å¼•å…¥äº†æŒ‡æŒ¥è€…ç±»ï¼Œå°†åˆ›å»ºè¿‡ç¨‹å°è£…åœ¨æŒ‡æŒ¥è€…ç±»ä¸­ï¼Œè€Œä¸åœ¨å»ºé€ è€…ç±»å’Œå®¢æˆ·ç±»ä¸­ã€‚</li>
<li>éš”ç¦»å¤æ‚å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨ï¼Œå¹¶ä½¿å¾—ç›¸åŒçš„åˆ›å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„äº§å“ã€‚</li>
</ol>
<h3 id="æ¨¡å¼åº”ç”¨"><a href="#æ¨¡å¼åº”ç”¨" class="headerlink" title="æ¨¡å¼åº”ç”¨"></a>æ¨¡å¼åº”ç”¨</h3><p>åœ¨å¾ˆå¤šæ¸¸æˆè½¯ä»¶ä¸­ï¼Œåœ°å›¾åŒ…æ‹¬å¤©ç©ºã€åœ°é¢ã€èƒŒæ™¯ç­‰ç»„æˆéƒ¨åˆ†ï¼Œäººç‰©è§’è‰²åŒ…æ‹¬äººä½“ã€æœè£…ã€è£…å¤‡ç­‰ç»„æˆéƒ¨åˆ†ï¼Œå¯ä»¥ä½¿ç”¨å»ºé€ è€…æ¨¡å¼å¯¹å…¶è¿›è¡Œè®¾è®¡ï¼Œé€šè¿‡ä¸åŒçš„å…·ä½“å»ºé€ è€…åˆ›å»ºä¸åŒç±»å‹çš„åœ°å›¾æˆ–äººç‰©ã€‚</p>
<h3 id="æ¨¡å¼æ‰©å±•"><a href="#æ¨¡å¼æ‰©å±•" class="headerlink" title="æ¨¡å¼æ‰©å±•"></a>æ¨¡å¼æ‰©å±•</h3><p>å»ºé€ è€…æ¨¡å¼çš„ç®€åŒ–:</p>
<ul>
<li><strong>çœç•¥æŠ½è±¡å»ºé€ è€…è§’è‰²ï¼š</strong>å¦‚æœç³»ç»Ÿä¸­åªéœ€è¦ä¸€ä¸ªå…·ä½“å»ºé€ è€…çš„è¯ï¼Œå¯ä»¥çœç•¥æ‰æŠ½è±¡å»ºé€ è€…ã€‚</li>
<li><strong>çœç•¥æŒ‡æŒ¥è€…è§’è‰²ï¼š</strong>åœ¨å…·ä½“å»ºé€ è€…åªæœ‰ä¸€ä¸ªçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæŠ½è±¡å»ºé€ è€…è§’è‰²å·²ç»è¢«çœç•¥æ‰ï¼Œé‚£ä¹ˆè¿˜å¯ä»¥çœç•¥æŒ‡æŒ¥è€…è§’è‰²ï¼Œè®©<code>Builder</code>è§’è‰²æ‰®æ¼”æŒ‡æŒ¥è€…ä¸å»ºé€ è€…åŒé‡è§’è‰²ã€‚</li>
</ul>
<p>å»ºé€ è€…æ¨¡å¼ä¸æŠ½è±¡å·¥å‚æ¨¡å¼çš„æ¯”è¾ƒ:</p>
<ul>
<li>ä¸æŠ½è±¡å·¥å‚æ¨¡å¼ç›¸æ¯”ï¼Œ <strong>å»ºé€ è€…æ¨¡å¼è¿”å›ä¸€ä¸ªç»„è£…å¥½çš„å®Œæ•´äº§å“</strong> ï¼Œè€Œ <strong>æŠ½è±¡å·¥å‚æ¨¡å¼è¿”å›ä¸€ç³»åˆ—ç›¸å…³çš„äº§å“ï¼Œè¿™äº›äº§å“ä½äºä¸åŒçš„äº§å“ç­‰çº§ç»“æ„ï¼Œæ„æˆäº†ä¸€ä¸ªäº§å“æ—ã€‚</strong></li>
<li>åœ¨æŠ½è±¡å·¥å‚æ¨¡å¼ä¸­ï¼Œå®¢æˆ·ç«¯å®ä¾‹åŒ–å·¥å‚ç±»ï¼Œç„¶åè°ƒç”¨å·¥å‚æ–¹æ³•è·å–æ‰€éœ€äº§å“å¯¹è±¡ï¼Œè€Œåœ¨å»ºé€ è€…æ¨¡å¼ä¸­ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä¸ç›´æ¥è°ƒç”¨å»ºé€ è€…çš„ç›¸å…³æ–¹æ³•ï¼Œè€Œæ˜¯é€šè¿‡æŒ‡æŒ¥è€…ç±»æ¥æŒ‡å¯¼å¦‚ä½•ç”Ÿæˆå¯¹è±¡ï¼ŒåŒ…æ‹¬å¯¹è±¡çš„ç»„è£…è¿‡ç¨‹å’Œå»ºé€ æ­¥éª¤ï¼Œå®ƒä¾§é‡äºä¸€æ­¥æ­¥æ„é€ ä¸€ä¸ªå¤æ‚å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªå®Œæ•´çš„å¯¹è±¡ã€‚</li>
<li>å¦‚æœå°†æŠ½è±¡å·¥å‚æ¨¡å¼çœ‹æˆ <strong>æ±½è½¦é…ä»¶ç”Ÿäº§å·¥å‚</strong> ï¼Œç”Ÿäº§ä¸€ä¸ªäº§å“æ—çš„äº§å“ï¼Œé‚£ä¹ˆå»ºé€ è€…æ¨¡å¼å°±æ˜¯ä¸€ä¸ª <strong>æ±½è½¦ç»„è£…å·¥å‚</strong> ï¼Œé€šè¿‡å¯¹éƒ¨ä»¶çš„ç»„è£…å¯ä»¥è¿”å›ä¸€è¾†å®Œæ•´çš„æ±½è½¦ã€‚</li>
</ul>
<h3 id="å»ºé€ è€…ç®€åŒ–"><a href="#å»ºé€ è€…ç®€åŒ–" class="headerlink" title="å»ºé€ è€…ç®€åŒ–"></a>å»ºé€ è€…ç®€åŒ–</h3><ul>
<li>é¦–å…ˆåˆ›å»ºä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼ŒæŠŠå¤–éƒ¨ç±»çš„æ‰€æœ‰å±æ€§æ‹·è´åˆ°é™æ€å†…éƒ¨ç±»é‡Œé¢ï¼ŒåŒæ—¶ä¸ºäº†éµå¾ªå‘½åçš„è§„èŒƒï¼Œæˆ‘ä»¬ä»¥ç±»åBuilderæ¥å‘½åå†…éƒ¨ç±»ã€‚</li>
<li>é™æ€å†…éƒ¨ç±»åŒ…å«ä¸€ä¸ªpublicçš„æ„é€ å‡½æ•°ï¼Œæ‰€æœ‰å¿…éœ€ä¼ é€’çš„å‚æ•°ä½œä¸ºæ„é€ å‡½æ•°çš„å‚æ•°ã€‚</li>
<li>é™æ€å†…éƒ¨ç±»åº”è¯¥æä¾›è®¾ç½®å¯é€‰å‚æ•°çš„å…¥å£ï¼Œå³å¯é€‰å‚æ•°å¯¹åº”çš„setæ–¹æ³•åŒæ—¶å½“è¿ç»­è°ƒç”¨å¤šä¸ªå±æ€§çš„setæ–¹æ³•ä¹‹åï¼Œåº”è¯¥ä¿è¯è¿”å›çš„æ˜¯åŒä¸€ä¸ªbuilderå¯¹è±¡ã€‚</li>
<li>æœ€åä¸€æ­¥è¦åœ¨é™æ€å†…éƒ¨ç±»ä¸­å®ç°ä¸€ä¸ªbuilderæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¿”å›å¤–éƒ¨ç±»çš„å¯¹è±¡ã€‚é€šè¿‡åœ¨å¤–éƒ¨ç±»ä¸­å®ç°ä¸€ä¸ªprivateçš„ç§æœ‰æ„é€ å‡½æ•°ï¼Œé™æ€å†…éƒ¨ç±»ä½œä¸ºå‚æ•°æ¥å®ç°ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Computer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//required parameters</span></div><div class="line">    <span class="keyword">private</span> String HDD;</div><div class="line">    <span class="keyword">private</span> String RAM;</div><div class="line"></div><div class="line">    <span class="comment">//optional parameters</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isGraphicsCardEnabled;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isBluetoothEnabled;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHDD</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> HDD;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRAM</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> RAM;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isGraphicsCardEnabled</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> isGraphicsCardEnabled;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isBluetoothEnabled</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> isBluetoothEnabled;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Computer</span><span class="params">(ComputerBuilder builder)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.HDD = builder.HDD;</div><div class="line">        <span class="keyword">this</span>.RAM = builder.RAM;</div><div class="line">        <span class="keyword">this</span>.isGraphicsCardEnabled = builder.isGraphicsCardEnabled;</div><div class="line">        <span class="keyword">this</span>.isBluetoothEnabled = builder.isBluetoothEnabled;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Computer [HDD="</span> + HDD + <span class="string">", RAM="</span> + RAM + <span class="string">", isGraphicsCardEnabled="</span></div><div class="line">               + isGraphicsCardEnabled + <span class="string">", isBluetoothEnabled="</span> + isBluetoothEnabled + <span class="string">"]"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//Builder Class</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ComputerBuilder</span> </span>&#123;</div><div class="line">        <span class="comment">// required parameters</span></div><div class="line">        <span class="keyword">private</span> String  HDD;</div><div class="line">        <span class="keyword">private</span> String  RAM;</div><div class="line">        <span class="comment">// optional parameters</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> isGraphicsCardEnabled;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> isBluetoothEnabled;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ComputerBuilder</span><span class="params">(String hdd, String ram)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.HDD = hdd;</div><div class="line">            <span class="keyword">this</span>.RAM = ram;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> ComputerBuilder <span class="title">setGraphicsCardEnabled</span><span class="params">(<span class="keyword">boolean</span> isGraphicsCardEnabled)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.isGraphicsCardEnabled = isGraphicsCardEnabled;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> ComputerBuilder <span class="title">setBluetoothEnabled</span><span class="params">(<span class="keyword">boolean</span> isBluetoothEnabled)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.isBluetoothEnabled = isBluetoothEnabled;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> Computer <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Computer(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸€èˆ¬å¼€å‘ä¸­éƒ½éœ€è¦è‡ªå·±æ‰‹åŠ¨å»ºé€ äº§å“ï¼Œæˆå‘˜å±æ€§çš„å€¼æ˜¯å¯å˜çš„ã€‚</p>
<p>jdkä¸­å»ºé€ è€…æ¨¡å¼ï¼š<code>java.lang.StringBuilder#append()</code></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://design-patterns.readthedocs.io/zh_CN/latest/creational_patterns/builder.html#id16" target="_blank" rel="external">å»ºé€ è€…æ¨¡å¼</a></p>
<p><a href="http://blog.csdn.net/lovelion/article/details/7426015" target="_blank" rel="external">å»ºé€ è€…æ¨¡å¼</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è®¾è®¡æ¨¡å¼-æŠ½è±¡å·¥å‚æ¨¡å¼]]></title>
      <url>http://zsr.github.io/2017/05/18/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<p>â€‹       å·¥å‚æ–¹æ³•æ¨¡å¼é€šè¿‡å¼•å…¥å·¥å‚ç­‰çº§ç»“æ„ï¼Œè§£å†³äº†ç®€å•å·¥å‚æ¨¡å¼ä¸­å·¥å‚ç±»èŒè´£å¤ªé‡çš„é—®é¢˜ï¼Œä½†ç”±äºå·¥å‚æ–¹æ³•æ¨¡å¼ä¸­çš„æ¯ä¸ªå·¥å‚åªç”Ÿäº§ä¸€ç±»äº§å“ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿä¸­å­˜åœ¨å¤§é‡çš„å·¥å‚ç±»ï¼ŒåŠ¿å¿…ä¼šå¢åŠ ç³»ç»Ÿçš„å¼€é”€ã€‚æ­¤æ—¶ï¼Œå¯ä»¥è€ƒè™‘<strong>å°†ä¸€äº›ç›¸å…³çš„äº§å“ç»„æˆä¸€ä¸ªâ€œäº§å“æ—â€ï¼Œç”±åŒä¸€ä¸ªå·¥å‚æ¥ç»Ÿä¸€ç”Ÿäº§</strong>ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æœ¬æ–‡å°†è¦å­¦ä¹ çš„æŠ½è±¡å·¥å‚æ¨¡å¼çš„åŸºæœ¬æ€æƒ³ã€‚</p>
<h3 id="äº§å“ç­‰çº§ç»“æ„ä¸äº§å“æ—"><a href="#äº§å“ç­‰çº§ç»“æ„ä¸äº§å“æ—" class="headerlink" title="äº§å“ç­‰çº§ç»“æ„ä¸äº§å“æ—"></a>äº§å“ç­‰çº§ç»“æ„ä¸äº§å“æ—</h3><ul>
<li>åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ä¸­å…·ä½“å·¥å‚è´Ÿè´£ç”Ÿäº§å…·ä½“çš„äº§å“ï¼Œæ¯ä¸€ä¸ªå…·ä½“å·¥å‚å¯¹åº”ä¸€ç§å…·ä½“äº§å“ï¼Œå·¥å‚æ–¹æ³•å…·æœ‰å”¯ä¸€æ€§ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå…·ä½“å·¥å‚ä¸­åªæœ‰ä¸€ä¸ªæˆ–è€…ä¸€ç»„é‡è½½çš„å·¥å‚æ–¹æ³•ã€‚ä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›ä¸€ä¸ªå·¥å‚å¯ä»¥æä¾›å¤šä¸ªäº§å“å¯¹è±¡ï¼Œè€Œä¸æ˜¯å•ä¸€çš„äº§å“å¯¹è±¡ï¼Œå¦‚ä¸€ä¸ªç”µå™¨å·¥å‚ï¼Œå®ƒå¯ä»¥ç”Ÿäº§ç”µè§†æœºã€ç”µå†°ç®±ã€ç©ºè°ƒç­‰å¤šç§ç”µå™¨ï¼Œè€Œä¸æ˜¯åªç”Ÿäº§æŸä¸€ç§ç”µå™¨ã€‚ä¸ºäº†æ›´å¥½åœ°ç†è§£æŠ½è±¡å·¥å‚æ¨¡å¼ï¼Œå…ˆå¼•å…¥ä¸¤ä¸ªæ¦‚å¿µï¼š<ol>
<li><strong>äº§å“ç­‰çº§ç»“æ„</strong>ï¼š<strong>äº§å“ç­‰çº§ç»“æ„å³äº§å“çš„ç»§æ‰¿ç»“æ„</strong>ï¼Œå¦‚ä¸€ä¸ªæŠ½è±¡ç±»æ˜¯ç”µè§†æœºï¼Œå…¶å­ç±»æœ‰æµ·å°”ç”µè§†æœºã€æµ·ä¿¡ç”µè§†æœºã€TCLç”µè§†æœºï¼Œåˆ™æŠ½è±¡ç”µè§†æœºä¸å…·ä½“å“ç‰Œçš„ç”µè§†æœºä¹‹é—´æ„æˆäº†ä¸€ä¸ªäº§å“ç­‰çº§ç»“æ„ï¼ŒæŠ½è±¡ç”µè§†æœºæ˜¯çˆ¶ç±»ï¼Œè€Œå…·ä½“å“ç‰Œçš„ç”µè§†æœºæ˜¯å…¶å­ç±»ã€‚**</li>
<li><strong>äº§å“æ—</strong>ï¼šåœ¨æŠ½è±¡å·¥å‚æ¨¡å¼ä¸­ï¼Œ<strong>äº§å“æ—æ˜¯æŒ‡ç”±åŒä¸€ä¸ªå·¥å‚ç”Ÿäº§çš„ï¼Œä½äºä¸åŒäº§å“ç­‰çº§ç»“æ„ä¸­çš„ä¸€ç»„äº§å“</strong>ï¼Œå¦‚æµ·å°”ç”µå™¨å·¥å‚ç”Ÿäº§çš„æµ·å°”ç”µè§†æœºã€æµ·å°”ç”µå†°ç®±ï¼Œæµ·å°”ç”µè§†æœºä½äºç”µè§†æœºäº§å“ç­‰çº§ç»“æ„ä¸­ï¼Œæµ·å°”ç”µå†°ç®±ä½äºç”µå†°ç®±äº§å“ç­‰çº§ç»“æ„ä¸­ï¼Œæµ·å°”ç”µè§†æœºã€æµ·å°”ç”µå†°ç®±æ„æˆäº†ä¸€ä¸ªäº§å“æ—ã€‚</li>
</ol>
</li>
<li>å½“ç³»ç»Ÿæ‰€æä¾›çš„å·¥å‚æ‰€éœ€ç”Ÿäº§çš„å…·ä½“äº§å“å¹¶ä¸æ˜¯ä¸€ä¸ªç®€å•çš„å¯¹è±¡ï¼Œè€Œæ˜¯å¤šä¸ªä½äºä¸åŒäº§å“ç­‰çº§ç»“æ„ä¸­å±äºä¸åŒç±»å‹çš„å…·ä½“äº§å“æ—¶éœ€è¦ä½¿ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼ã€‚</li>
<li>æŠ½è±¡å·¥å‚æ¨¡å¼æ˜¯æ‰€æœ‰å½¢å¼çš„å·¥å‚æ¨¡å¼ä¸­æœ€ä¸ºæŠ½è±¡å’Œæœ€å…·ä¸€èˆ¬æ€§çš„ä¸€ç§å½¢æ€ã€‚</li>
<li>æŠ½è±¡å·¥å‚æ¨¡å¼ä¸å·¥å‚æ–¹æ³•æ¨¡å¼æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼Œ<strong>å·¥å‚æ–¹æ³•æ¨¡å¼é’ˆå¯¹çš„æ˜¯ä¸€ä¸ªäº§å“ç­‰çº§ç»“æ„ï¼Œè€ŒæŠ½è±¡å·¥å‚æ¨¡å¼åˆ™éœ€è¦é¢å¯¹å¤šä¸ªäº§å“ç­‰çº§ç»“æ„</strong>ï¼Œä¸€ä¸ªå·¥å‚ç­‰çº§ç»“æ„å¯ä»¥è´Ÿè´£å¤šä¸ªä¸åŒäº§å“ç­‰çº§ç»“æ„ä¸­çš„äº§å“å¯¹è±¡çš„åˆ›å»º ã€‚å½“ä¸€ä¸ªå·¥å‚ç­‰çº§ç»“æ„å¯ä»¥åˆ›å»ºå‡ºåˆ†å±äºä¸åŒäº§å“ç­‰çº§ç»“æ„çš„ä¸€ä¸ªäº§å“æ—ä¸­çš„æ‰€æœ‰å¯¹è±¡æ—¶ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼æ¯”å·¥å‚æ–¹æ³•æ¨¡å¼æ›´ä¸ºç®€å•ã€æœ‰æ•ˆç‡ã€‚</li>
</ul>
<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>æŠ½è±¡å·¥å‚æ¨¡å¼ä¸ºåˆ›å»ºä¸€ç»„å¯¹è±¡æä¾›äº†ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚ä¸å·¥å‚æ–¹æ³•æ¨¡å¼ç›¸æ¯”ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼ä¸­çš„å…·ä½“å·¥å‚ä¸åªæ˜¯åˆ›å»ºä¸€ç§äº§å“ï¼Œå®ƒè´Ÿè´£åˆ›å»ºä¸€æ—äº§å“ã€‚</p>
<h3 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">æŠ½è±¡å·¥å‚æ¨¡å¼(Abstract Factory Pattern)ï¼šæä¾›ä¸€ä¸ªåˆ›å»ºä¸€ç³»åˆ—ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡çš„æ¥å£ï¼Œè€Œæ— é¡»æŒ‡å®šå®ƒä»¬å…·ä½“çš„ç±»ã€‚æŠ½è±¡å·¥å‚æ¨¡å¼åˆç§°ä¸ºKitæ¨¡å¼ï¼Œå®ƒæ˜¯ä¸€ç§å¯¹è±¡åˆ›å»ºå‹æ¨¡å¼ã€‚</div></pre></td></tr></table></figure>
<h3 id="ç»“æ„å›¾"><a href="#ç»“æ„å›¾" class="headerlink" title="ç»“æ„å›¾"></a>ç»“æ„å›¾</h3><p><img src="http://design-patterns.readthedocs.io/zh_CN/latest/_images/AbatractFactory.jpg" alt="img"></p>
<h3 id="è§’è‰²"><a href="#è§’è‰²" class="headerlink" title="è§’è‰²"></a>è§’è‰²</h3><p>åœ¨æŠ½è±¡å·¥å‚æ¨¡å¼ç»“æ„å›¾ä¸­åŒ…å«å¦‚ä¸‹å‡ ä¸ªè§’è‰²ï¼š</p>
<ul>
<li><strong>AbstractFactoryï¼ˆæŠ½è±¡å·¥å‚ï¼‰ï¼š</strong>å®ƒå£°æ˜äº†ä¸€ç»„ç”¨äºåˆ›å»ºä¸€æ—äº§å“çš„æ–¹æ³•ï¼Œæ¯ä¸€ä¸ªæ–¹æ³•å¯¹åº”ä¸€ç§äº§å“ã€‚</li>
<li><strong>ConcreteFactoryï¼ˆå…·ä½“å·¥å‚ï¼‰ï¼š</strong>å®ƒå®ç°äº†åœ¨æŠ½è±¡å·¥å‚ä¸­å£°æ˜çš„åˆ›å»ºäº§å“çš„æ–¹æ³•ï¼Œç”Ÿæˆä¸€ç»„å…·ä½“äº§å“ï¼Œè¿™äº›äº§å“æ„æˆäº†ä¸€ä¸ªäº§å“æ—ï¼Œæ¯ä¸€ä¸ªäº§å“éƒ½ä½äºæŸä¸ªäº§å“ç­‰çº§ç»“æ„ä¸­ã€‚</li>
<li><strong>AbstractProductï¼ˆæŠ½è±¡äº§å“ï¼‰ï¼š</strong>å®ƒä¸ºæ¯ç§äº§å“å£°æ˜æ¥å£ï¼Œåœ¨æŠ½è±¡äº§å“ä¸­å£°æ˜äº†äº§å“æ‰€å…·æœ‰çš„ä¸šåŠ¡æ–¹æ³•ã€‚</li>
<li><strong>ConcreteProductï¼ˆå…·ä½“äº§å“ï¼‰ï¼š</strong>å®ƒå®šä¹‰å…·ä½“å·¥å‚ç”Ÿäº§çš„å…·ä½“äº§å“å¯¹è±¡ï¼Œå®ç°æŠ½è±¡äº§å“æ¥å£ä¸­å£°æ˜çš„ä¸šåŠ¡æ–¹æ³•ã€‚</li>
</ul>
<a id="more"></a>
<h3 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h3><p> åœ¨æŠ½è±¡å·¥å‚ä¸­å£°æ˜äº†å¤šä¸ªå·¥å‚æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºä¸åŒç±»å‹çš„äº§å“ï¼ŒæŠ½è±¡å·¥å‚å¯ä»¥æ˜¯æ¥å£ï¼Œä¹Ÿå¯ä»¥æ˜¯æŠ½è±¡ç±»æˆ–è€…å…·ä½“ç±»ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractFactory</span> </span>&#123;  </div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> AbstractProductA <span class="title">createProductA</span><span class="params">()</span></span>; <span class="comment">//å·¥å‚æ–¹æ³•ä¸€  </span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> AbstractProductB <span class="title">createProductB</span><span class="params">()</span></span>; <span class="comment">//å·¥å‚æ–¹æ³•äºŒ   </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…·ä½“å·¥å‚å®ç°äº†æŠ½è±¡å·¥å‚ï¼Œæ¯ä¸€ä¸ªå…·ä½“çš„å·¥å‚æ–¹æ³•å¯ä»¥è¿”å›ä¸€ä¸ªç‰¹å®šçš„äº§å“å¯¹è±¡ï¼Œè€ŒåŒä¸€ä¸ªå…·ä½“å·¥å‚æ‰€åˆ›å»ºçš„äº§å“å¯¹è±¡æ„æˆäº†ä¸€ä¸ªäº§å“æ—ã€‚å¯¹äºæ¯ä¸€ä¸ªå…·ä½“å·¥å‚ç±»ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteFactory1</span> <span class="keyword">extends</span> <span class="title">AbstractFactory</span> </span>&#123;  </div><div class="line">    <span class="comment">//å·¥å‚æ–¹æ³•ä¸€  </span></div><div class="line">    <span class="function"><span class="keyword">public</span> AbstractProductA <span class="title">createProductA</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConcreteProductA1();  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">//å·¥å‚æ–¹æ³•äºŒ  </span></div><div class="line">    <span class="function"><span class="keyword">public</span> AbstractProductB <span class="title">createProductB</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConcreteProductB1();  </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> ä¸å·¥å‚æ–¹æ³•æ¨¡å¼ä¸€æ ·ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼ä¹Ÿå¯ä¸ºæ¯ä¸€ç§äº§å“æä¾›ä¸€ç»„é‡è½½çš„å·¥å‚æ–¹æ³•ï¼Œä»¥ä¸åŒçš„æ–¹å¼å¯¹äº§å“å¯¹è±¡è¿›è¡Œåˆ›å»ºã€‚</p>
<p>åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ï¼Œåªéœ€å…³å¿ƒå·¥å‚ç±»å³å¯ï¼Œä¸åŒçš„å…·ä½“å·¥å‚å¯ä»¥åˆ›å»ºä¸åŒçš„äº§å“ï¼Œå®¢æˆ·ç«¯ç±»ä»£ç ç‰‡æ®µå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;  </div><div class="line">		AbstractFactory factory = <span class="keyword">new</span> ConcreteFactory1(); <span class="comment">//å¯é€šè¿‡é…ç½®æ–‡ä»¶å®ç°  </span></div><div class="line">		ConcreteProductA1 productA1 = factory.createProductA();  </div><div class="line">        ConcreteProductB1 productB1 = factory.createProductA();  </div><div class="line"> 	&#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><ul>
<li>æŠ½è±¡å·¥å‚æ¨¡å¼éš”ç¦»äº†å…·ä½“ç±»çš„ç”Ÿæˆï¼Œä½¿å¾—å®¢æˆ·å¹¶ä¸éœ€è¦çŸ¥é“ä»€ä¹ˆè¢«åˆ›å»ºã€‚ç”±äºè¿™ç§éš”ç¦»ï¼Œæ›´æ¢ä¸€ä¸ªå…·ä½“å·¥å‚å°±å˜å¾—ç›¸å¯¹å®¹æ˜“ã€‚æ‰€æœ‰çš„å…·ä½“å·¥å‚éƒ½å®ç°äº†æŠ½è±¡å·¥å‚ä¸­å®šä¹‰çš„é‚£äº›å…¬å…±æ¥å£ï¼Œå› æ­¤åªéœ€æ”¹å˜å…·ä½“å·¥å‚çš„å®ä¾‹ï¼Œå°±å¯ä»¥åœ¨æŸç§ç¨‹åº¦ä¸Šæ”¹å˜æ•´ä¸ªè½¯ä»¶ç³»ç»Ÿçš„è¡Œä¸ºã€‚å¦å¤–ï¼Œåº”ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼å¯ä»¥å®ç°é«˜å†…èšä½è€¦åˆçš„è®¾è®¡ç›®çš„ï¼Œå› æ­¤æŠ½è±¡å·¥å‚æ¨¡å¼å¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ã€‚</li>
<li>å½“ä¸€ä¸ªäº§å“æ—ä¸­çš„å¤šä¸ªå¯¹è±¡è¢«è®¾è®¡æˆä¸€èµ·å·¥ä½œæ—¶ï¼Œå®ƒèƒ½å¤Ÿä¿è¯å®¢æˆ·ç«¯å§‹ç»ˆåªä½¿ç”¨åŒä¸€ä¸ªäº§å“æ—ä¸­çš„å¯¹è±¡ã€‚è¿™å¯¹ä¸€äº›éœ€è¦æ ¹æ®å½“å‰ç¯å¢ƒæ¥å†³å®šå…¶è¡Œä¸ºçš„è½¯ä»¶ç³»ç»Ÿæ¥è¯´ï¼Œæ˜¯ä¸€ç§éå¸¸å®ç”¨çš„è®¾è®¡æ¨¡å¼ã€‚</li>
<li>å¢åŠ æ–°çš„å…·ä½“å·¥å‚å’Œäº§å“æ—å¾ˆæ–¹ä¾¿ï¼Œæ— é¡»ä¿®æ”¹å·²æœ‰ç³»ç»Ÿï¼Œç¬¦åˆâ€œå¼€é—­åŸåˆ™â€ã€‚</li>
</ul>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ul>
<li>åœ¨æ·»åŠ æ–°çš„äº§å“å¯¹è±¡æ—¶ï¼Œéš¾ä»¥æ‰©å±•æŠ½è±¡å·¥å‚æ¥ç”Ÿäº§æ–°ç§ç±»çš„äº§å“ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æŠ½è±¡å·¥å‚è§’è‰²ä¸­è§„å®šäº†æ‰€æœ‰å¯èƒ½è¢«åˆ›å»ºçš„äº§å“é›†åˆï¼Œè¦æ”¯æŒæ–°ç§ç±»çš„äº§å“å°±æ„å‘³ç€è¦å¯¹è¯¥æ¥å£è¿›è¡Œæ‰©å±•ï¼Œè€Œè¿™å°†æ¶‰åŠåˆ°å¯¹æŠ½è±¡å·¥å‚è§’è‰²åŠå…¶æ‰€æœ‰å­ç±»çš„ä¿®æ”¹ï¼Œæ˜¾ç„¶ä¼šå¸¦æ¥è¾ƒå¤§çš„ä¸ä¾¿ï¼Œè¿èƒŒäº†â€œå¼€é—­åŸåˆ™â€ã€‚</li>
<li>å¼€é—­åŸåˆ™çš„å€¾æ–œæ€§ï¼ˆå¢åŠ æ–°çš„å·¥å‚å’Œäº§å“æ—å®¹æ˜“ï¼Œå¢åŠ æ–°çš„äº§å“ç­‰çº§ç»“æ„éº»çƒ¦ï¼‰ã€‚</li>
</ul>
<h3 id="é€‚ç”¨åœºæ™¯"><a href="#é€‚ç”¨åœºæ™¯" class="headerlink" title="é€‚ç”¨åœºæ™¯"></a>é€‚ç”¨åœºæ™¯</h3><p>â€‹       åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å¯ä»¥è€ƒè™‘ä½¿ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼ï¼š</p>
<ol>
<li>ä¸€ä¸ªç³»ç»Ÿä¸åº”å½“ä¾èµ–äºäº§å“ç±»å®ä¾‹å¦‚ä½•è¢«åˆ›å»ºã€ç»„åˆå’Œè¡¨è¾¾çš„ç»†èŠ‚ï¼Œè¿™å¯¹äºæ‰€æœ‰ç±»å‹çš„å·¥å‚æ¨¡å¼éƒ½æ˜¯å¾ˆé‡è¦çš„ï¼Œç”¨æˆ·æ— é¡»å…³å¿ƒå¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå°†å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨è§£è€¦ã€‚</li>
<li>ç³»ç»Ÿä¸­æœ‰å¤šäºä¸€ä¸ªçš„äº§å“æ—ï¼Œè€Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­æŸä¸€äº§å“æ—ã€‚å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ç­‰æ–¹å¼æ¥ä½¿å¾—ç”¨æˆ·å¯ä»¥åŠ¨æ€æ”¹å˜äº§å“æ—ï¼Œä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¢åŠ æ–°çš„äº§å“æ—ã€‚</li>
<li>å±äºåŒä¸€ä¸ªäº§å“æ—çš„äº§å“å°†åœ¨ä¸€èµ·ä½¿ç”¨ï¼Œè¿™ä¸€çº¦æŸå¿…é¡»åœ¨ç³»ç»Ÿçš„è®¾è®¡ä¸­ä½“ç°å‡ºæ¥ã€‚åŒä¸€ä¸ªäº§å“æ—ä¸­çš„äº§å“å¯ä»¥æ˜¯æ²¡æœ‰ä»»ä½•å…³ç³»çš„å¯¹è±¡ï¼Œä½†æ˜¯å®ƒä»¬éƒ½å…·æœ‰ä¸€äº›å…±åŒçš„çº¦æŸï¼Œå¦‚åŒä¸€æ“ä½œç³»ç»Ÿä¸‹çš„æŒ‰é’®å’Œæ–‡æœ¬æ¡†ï¼ŒæŒ‰é’®ä¸æ–‡æœ¬æ¡†ä¹‹é—´æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œä½†å®ƒä»¬éƒ½æ˜¯å±äºæŸä¸€æ“ä½œç³»ç»Ÿçš„ï¼Œæ­¤æ—¶å…·æœ‰ä¸€ä¸ªå…±åŒçš„çº¦æŸæ¡ä»¶ï¼šæ“ä½œç³»ç»Ÿçš„ç±»å‹ã€‚</li>
<li>äº§å“ç­‰çº§ç»“æ„ç¨³å®šï¼Œè®¾è®¡å®Œæˆä¹‹åï¼Œä¸ä¼šå‘ç³»ç»Ÿä¸­å¢åŠ æ–°çš„äº§å“ç­‰çº§ç»“æ„æˆ–è€…åˆ é™¤å·²æœ‰çš„äº§å“ç­‰çº§ç»“æ„ã€‚</li>
</ol>
<h3 id="æ¨¡å¼åº”ç”¨"><a href="#æ¨¡å¼åº”ç”¨" class="headerlink" title="æ¨¡å¼åº”ç”¨"></a>æ¨¡å¼åº”ç”¨</h3><p>åœ¨å¾ˆå¤šè½¯ä»¶ç³»ç»Ÿä¸­éœ€è¦æ›´æ¢ç•Œé¢ä¸»é¢˜ï¼Œè¦æ±‚ç•Œé¢ä¸­çš„æŒ‰é’®ã€æ–‡æœ¬æ¡†ã€èƒŒæ™¯è‰²ç­‰ä¸€èµ·å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼è¿›è¡Œè®¾è®¡ã€‚</p>
<h3 id="æ¨¡å¼æ‰©å±•"><a href="#æ¨¡å¼æ‰©å±•" class="headerlink" title="æ¨¡å¼æ‰©å±•"></a>æ¨¡å¼æ‰©å±•</h3><p>â€œå¼€é—­åŸåˆ™â€çš„å€¾æ–œæ€§</p>
<ul>
<li>â€œå¼€é—­åŸåˆ™â€è¦æ±‚ç³»ç»Ÿå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­ï¼Œé€šè¿‡æ‰©å±•è¾¾åˆ°å¢å¼ºå…¶åŠŸèƒ½çš„ç›®çš„ã€‚å¯¹äºæ¶‰åŠåˆ°å¤šä¸ªäº§å“æ—ä¸å¤šä¸ªäº§å“ç­‰çº§ç»“æ„çš„ç³»ç»Ÿï¼Œå…¶åŠŸèƒ½å¢å¼ºåŒ…æ‹¬ä¸¤æ–¹é¢ï¼š<ul>
<li>å¢åŠ äº§å“æ—ï¼šå¯¹äºå¢åŠ æ–°çš„äº§å“æ—ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼å¾ˆå¥½çš„æ”¯æŒäº†â€œå¼€é—­åŸåˆ™â€ï¼Œå¯¹äºæ–°å¢åŠ çš„äº§å“æ—ï¼Œåªéœ€è¦å¯¹åº”å¢åŠ ä¸€ä¸ªæ–°çš„å…·ä½“å·¥å‚å³å¯ï¼Œå¯¹å·²æœ‰ä»£ç æ— é¡»åšä»»ä½•ä¿®æ”¹ã€‚å¢åŠ æ–°çš„äº§å“ç­‰çº§ç»“æ„ï¼šå¯¹äºå¢åŠ æ–°çš„äº§å“ç­‰çº§ç»“æ„ï¼Œéœ€è¦ä¿®æ”¹æ‰€æœ‰çš„å·¥å‚è§’è‰²ï¼ŒåŒ…æ‹¬æŠ½è±¡å·¥å‚ç±»ï¼Œåœ¨æ‰€æœ‰çš„å·¥å‚ç±»ä¸­éƒ½éœ€è¦å¢åŠ ç”Ÿäº§æ–°äº§å“çš„æ–¹æ³•ï¼Œä¸èƒ½å¾ˆå¥½åœ°æ”¯æŒâ€œå¼€é—­åŸåˆ™â€ã€‚</li>
<li>æŠ½è±¡å·¥å‚æ¨¡å¼çš„è¿™ç§æ€§è´¨ç§°ä¸ºâ€œå¼€é—­åŸåˆ™â€çš„å€¾æ–œæ€§ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼ä»¥ä¸€ç§å€¾æ–œçš„æ–¹å¼æ”¯æŒå¢åŠ æ–°çš„äº§å“ï¼Œå®ƒä¸ºæ–°äº§å“æ—çš„å¢åŠ æä¾›æ–¹ä¾¿ï¼Œä½†ä¸èƒ½ä¸ºæ–°çš„äº§å“ç­‰çº§ç»“æ„çš„å¢åŠ æä¾›è¿™æ ·çš„æ–¹ä¾¿ã€‚</li>
</ul>
</li>
</ul>
<p>å·¥å‚æ¨¡å¼çš„é€€åŒ–</p>
<ul>
<li>å½“æŠ½è±¡å·¥å‚æ¨¡å¼ä¸­æ¯ä¸€ä¸ªå…·ä½“å·¥å‚ç±»åªåˆ›å»ºä¸€ä¸ªäº§å“å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯åªå­˜åœ¨ä¸€ä¸ªäº§å“ç­‰çº§ç»“æ„æ—¶ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼é€€åŒ–æˆå·¥å‚æ–¹æ³•æ¨¡å¼ï¼›å½“å·¥å‚æ–¹æ³•æ¨¡å¼ä¸­æŠ½è±¡å·¥å‚ä¸å…·ä½“å·¥å‚åˆå¹¶ï¼Œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„å·¥å‚æ¥åˆ›å»ºäº§å“å¯¹è±¡ï¼Œå¹¶å°†åˆ›å»ºå¯¹è±¡çš„å·¥å‚æ–¹æ³•è®¾è®¡ä¸ºé™æ€æ–¹æ³•æ—¶ï¼Œå·¥å‚æ–¹æ³•æ¨¡å¼é€€åŒ–æˆç®€å•å·¥å‚æ¨¡å¼ã€‚</li>
</ul>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://design-patterns.readthedocs.io/zh_CN/latest/creational_patterns/abstract_factory.html#id17" target="_blank" rel="external">æŠ½è±¡å·¥å‚æ¨¡å¼(Abstract Factory)</a></p>
<p><a href="http://blog.csdn.net/lovelion/article/details/9319423" target="_blank" rel="external">å·¥å‚ä¸‰å…„å¼Ÿä¹‹æŠ½è±¡å·¥å‚æ¨¡å¼</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è®¾è®¡æ¨¡å¼-å·¥å‚æ–¹æ³•æ¨¡å¼]]></title>
      <url>http://zsr.github.io/2017/05/18/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<p>â€‹       ç®€å•å·¥å‚æ¨¡å¼è™½ç„¶ç®€å•ï¼Œä½†å­˜åœ¨ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ã€‚<strong>å½“ç³»ç»Ÿä¸­éœ€è¦å¼•å…¥æ–°äº§å“æ—¶ï¼Œç”±äºé™æ€å·¥å‚æ–¹æ³•é€šè¿‡æ‰€ä¼ å…¥å‚æ•°çš„ä¸åŒæ¥åˆ›å»ºä¸åŒçš„äº§å“ï¼Œè¿™å¿…å®šè¦ä¿®æ”¹å·¥å‚ç±»çš„æºä»£ç ï¼Œå°†è¿èƒŒâ€œå¼€é—­åŸåˆ™â€ï¼Œå¦‚ä½•å®ç°å¢åŠ æ–°äº§å“è€Œä¸å½±å“å·²æœ‰ä»£ç ï¼Ÿ</strong>å·¥å‚æ–¹æ³•æ¨¡å¼åº”è¿è€Œç”Ÿï¼Œæœ¬æ–‡å°†ä»‹ç»ç¬¬äºŒç§å·¥å‚æ¨¡å¼â€”å·¥å‚æ–¹æ³•æ¨¡å¼ã€‚</p>
<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>â€‹       åœ¨ç®€å•å·¥å‚æ¨¡å¼ä¸­åªæä¾›ä¸€ä¸ªå·¥å‚ç±»ï¼Œè¯¥å·¥å‚ç±»å¤„äºå¯¹äº§å“ç±»è¿›è¡Œå®ä¾‹åŒ–çš„ä¸­å¿ƒä½ç½®ï¼Œå®ƒéœ€è¦çŸ¥é“æ¯ä¸€ä¸ªäº§å“å¯¹è±¡çš„åˆ›å»ºç»†èŠ‚ï¼Œå¹¶å†³å®šä½•æ—¶å®ä¾‹åŒ–å“ªä¸€ä¸ªäº§å“ç±»ã€‚ç®€å•å·¥å‚æ¨¡å¼æœ€å¤§çš„ç¼ºç‚¹æ˜¯å½“æœ‰æ–°äº§å“è¦åŠ å…¥åˆ°ç³»ç»Ÿä¸­æ—¶ï¼Œå¿…é¡»ä¿®æ”¹å·¥å‚ç±»ï¼Œéœ€è¦åœ¨å…¶ä¸­åŠ å…¥å¿…è¦çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿™è¿èƒŒäº†â€œå¼€é—­åŸåˆ™â€ã€‚æ­¤å¤–ï¼Œåœ¨ç®€å•å·¥å‚æ¨¡å¼ä¸­ï¼Œæ‰€æœ‰çš„äº§å“éƒ½ç”±åŒä¸€ä¸ªå·¥å‚åˆ›å»ºï¼Œå·¥å‚ç±»èŒè´£è¾ƒé‡ï¼Œä¸šåŠ¡é€»è¾‘è¾ƒä¸ºå¤æ‚ï¼Œå…·ä½“äº§å“ä¸å·¥å‚ç±»ä¹‹é—´çš„è€¦åˆåº¦é«˜ï¼Œä¸¥é‡å½±å“äº†ç³»ç»Ÿçš„çµæ´»æ€§å’Œæ‰©å±•æ€§ï¼Œè€Œå·¥å‚æ–¹æ³•æ¨¡å¼åˆ™å¯ä»¥å¾ˆå¥½åœ°è§£å†³è¿™ä¸€é—®é¢˜ã€‚</p>
<p>åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬<strong>ä¸å†æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å·¥å‚ç±»æ¥åˆ›å»ºæ‰€æœ‰çš„äº§å“å¯¹è±¡ï¼Œè€Œæ˜¯é’ˆå¯¹ä¸åŒçš„äº§å“æä¾›ä¸åŒçš„å·¥å‚ï¼Œç³»ç»Ÿæä¾›ä¸€ä¸ªä¸äº§å“ç­‰çº§ç»“æ„å¯¹åº”çš„å·¥å‚ç­‰çº§ç»“æ„</strong>ã€‚</p>
<h3 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">å·¥å‚æ–¹æ³•æ¨¡å¼(Factory Method Pattern)ï¼šå®šä¹‰ä¸€ä¸ªç”¨äºåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å­ç±»å†³å®šå°†å“ªä¸€ä¸ªç±»å®ä¾‹åŒ–ã€‚å·¥å‚æ–¹æ³•æ¨¡å¼è®©ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–å»¶è¿Ÿåˆ°å…¶å­ç±»ã€‚å·¥å‚æ–¹æ³•æ¨¡å¼åˆç®€ç§°ä¸ºå·¥å‚æ¨¡å¼(Factory Pattern)ï¼Œåˆå¯ç§°ä½œè™šæ‹Ÿæ„é€ å™¨æ¨¡å¼(Virtual Constructor Pattern)æˆ–å¤šæ€å·¥å‚æ¨¡å¼(Polymorphic Factory Pattern)ã€‚å·¥å‚æ–¹æ³•æ¨¡å¼æ˜¯ä¸€ç§ç±»åˆ›å»ºå‹æ¨¡å¼ã€‚</div></pre></td></tr></table></figure>
<h3 id="ç»“æ„å›¾"><a href="#ç»“æ„å›¾" class="headerlink" title="ç»“æ„å›¾"></a>ç»“æ„å›¾</h3><p><img src="http://design-patterns.readthedocs.io/zh_CN/latest/_images/FactoryMethod.jpg" alt="img"></p>
<h3 id="è§’è‰²ï¼š"><a href="#è§’è‰²ï¼š" class="headerlink" title="è§’è‰²ï¼š"></a>è§’è‰²ï¼š</h3><ul>
<li><strong>Productï¼ˆæŠ½è±¡äº§å“ï¼‰ï¼š</strong>å®ƒæ˜¯å®šä¹‰äº§å“çš„æ¥å£ï¼Œæ˜¯å·¥å‚æ–¹æ³•æ¨¡å¼æ‰€åˆ›å»ºå¯¹è±¡çš„è¶…ç±»å‹ï¼Œä¹Ÿå°±æ˜¯äº§å“å¯¹è±¡çš„å…¬å…±çˆ¶ç±»ã€‚</li>
<li><strong>ConcreteProductï¼ˆå…·ä½“äº§å“ï¼‰ï¼š</strong>å®ƒå®ç°äº†æŠ½è±¡äº§å“æ¥å£ï¼ŒæŸç§ç±»å‹çš„å…·ä½“äº§å“ç”±ä¸“é—¨çš„å…·ä½“å·¥å‚åˆ›å»ºï¼Œå…·ä½“å·¥å‚å’Œå…·ä½“äº§å“ä¹‹é—´ä¸€ä¸€å¯¹åº”ã€‚</li>
<li><strong>Factoryï¼ˆæŠ½è±¡å·¥å‚ï¼‰ï¼š</strong>åœ¨æŠ½è±¡å·¥å‚ç±»ä¸­ï¼Œå£°æ˜äº†å·¥å‚æ–¹æ³•(Factory Method)ï¼Œç”¨äºè¿”å›ä¸€ä¸ªäº§å“ã€‚æŠ½è±¡å·¥å‚æ˜¯å·¥å‚æ–¹æ³•æ¨¡å¼çš„æ ¸å¿ƒï¼Œæ‰€æœ‰åˆ›å»ºå¯¹è±¡çš„å·¥å‚ç±»éƒ½å¿…é¡»å®ç°è¯¥æ¥å£ã€‚</li>
<li><strong>ConcreteFactoryï¼ˆå…·ä½“å·¥å‚ï¼‰ï¼š</strong>å®ƒæ˜¯æŠ½è±¡å·¥å‚ç±»çš„å­ç±»ï¼Œå®ç°äº†æŠ½è±¡å·¥å‚ä¸­å®šä¹‰çš„å·¥å‚æ–¹æ³•ï¼Œå¹¶å¯ç”±å®¢æˆ·ç«¯è°ƒç”¨ï¼Œè¿”å›ä¸€ä¸ªå…·ä½“äº§å“ç±»çš„å®ä¾‹ã€‚</li>
</ul>
<a id="more"></a>
<h3 id="æ—¶åºå›¾"><a href="#æ—¶åºå›¾" class="headerlink" title="æ—¶åºå›¾"></a>æ—¶åºå›¾</h3><p><img src="http://design-patterns.readthedocs.io/zh_CN/latest/_images/seq_FactoryMethod.jpg" alt="img"></p>
<h3 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h3><p><strong>ä¸ç®€å•å·¥å‚æ¨¡å¼ç›¸æ¯”ï¼Œå·¥å‚æ–¹æ³•æ¨¡å¼æœ€é‡è¦çš„åŒºåˆ«æ˜¯å¼•å…¥äº†æŠ½è±¡å·¥å‚è§’è‰²ï¼Œ</strong>æŠ½è±¡å·¥å‚å¯ä»¥æ˜¯æ¥å£ï¼Œä¹Ÿå¯ä»¥æ˜¯æŠ½è±¡ç±»æˆ–è€…å…·ä½“ç±»ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Factory</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">factoryMethod</span><span class="params">()</span></span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨æŠ½è±¡å·¥å‚ä¸­å£°æ˜äº†å·¥å‚æ–¹æ³•ä½†å¹¶æœªå®ç°å·¥å‚æ–¹æ³•ï¼Œå…·ä½“äº§å“å¯¹è±¡çš„åˆ›å»ºç”±å…¶å­ç±»è´Ÿè´£ï¼Œå®¢æˆ·ç«¯é’ˆå¯¹æŠ½è±¡å·¥å‚ç¼–ç¨‹ï¼Œå¯åœ¨è¿è¡Œæ—¶å†æŒ‡å®šå…·ä½“å·¥å‚ç±»ï¼Œå…·ä½“å·¥å‚ç±»å®ç°äº†å·¥å‚æ–¹æ³•ï¼Œä¸åŒçš„å…·ä½“å·¥å‚å¯ä»¥åˆ›å»ºä¸åŒçš„å…·ä½“äº§å“ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteFactory</span> <span class="keyword">implements</span> <span class="title">Factory</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">factoryMethod</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConcreteProduct();  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œå…·ä½“å·¥å‚ç±»åœ¨å®ç°å·¥å‚æ–¹æ³•æ—¶é™¤äº†åˆ›å»ºå…·ä½“äº§å“å¯¹è±¡ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è´Ÿè´£äº§å“å¯¹è±¡çš„åˆå§‹åŒ–å·¥ä½œä»¥åŠä¸€äº›èµ„æºå’Œç¯å¢ƒé…ç½®å·¥ä½œï¼Œä¾‹å¦‚è¿æ¥æ•°æ®åº“ã€åˆ›å»ºæ–‡ä»¶ç­‰ã€‚</p>
<p>åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ï¼Œåªéœ€å…³å¿ƒå·¥å‚ç±»å³å¯ï¼Œä¸åŒçš„å…·ä½“å·¥å‚å¯ä»¥åˆ›å»ºä¸åŒçš„äº§å“ï¼Œå®¢æˆ·ç«¯ç±»ä»£ç ç‰‡æ®µå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;  </div><div class="line">		Factory factory = <span class="keyword">new</span> ConcreteFactory(); <span class="comment">//å¯é€šè¿‡é…ç½®æ–‡ä»¶å®ç°  </span></div><div class="line">		Product product = factory.factoryMethod();  </div><div class="line"> 	&#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ¥å­˜å‚¨å…·ä½“å·¥å‚ç±»ConcreteFactoryçš„ç±»åï¼Œæ›´æ¢æ–°çš„å…·ä½“å·¥å‚æ—¶æ— é¡»ä¿®æ”¹æºä»£ç ï¼Œç³»ç»Ÿæ‰©å±•æ›´ä¸ºæ–¹ä¾¿ã€‚</p>
<h3 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><ul>
<li>åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ä¸­ï¼Œå·¥å‚æ–¹æ³•ç”¨æ¥åˆ›å»ºå®¢æˆ·æ‰€éœ€è¦çš„äº§å“ï¼ŒåŒæ—¶è¿˜å‘å®¢æˆ·éšè—äº†å“ªç§å…·ä½“äº§å“ç±»å°†è¢«å®ä¾‹åŒ–è¿™ä¸€ç»†èŠ‚ï¼Œç”¨æˆ·åªéœ€è¦å…³å¿ƒæ‰€éœ€äº§å“å¯¹åº”çš„å·¥å‚ï¼Œæ— é¡»å…³å¿ƒåˆ›å»ºç»†èŠ‚ï¼Œç”šè‡³æ— é¡»çŸ¥é“å…·ä½“äº§å“ç±»çš„ç±»åã€‚</li>
<li>åŸºäºå·¥å‚è§’è‰²å’Œäº§å“è§’è‰²çš„å¤šæ€æ€§è®¾è®¡æ˜¯å·¥å‚æ–¹æ³•æ¨¡å¼çš„å…³é”®ã€‚å®ƒèƒ½å¤Ÿä½¿å·¥å‚å¯ä»¥è‡ªä¸»ç¡®å®šåˆ›å»ºä½•ç§äº§å“å¯¹è±¡ï¼Œè€Œå¦‚ä½•åˆ›å»ºè¿™ä¸ªå¯¹è±¡çš„ç»†èŠ‚åˆ™å®Œå…¨å°è£…åœ¨å…·ä½“å·¥å‚å†…éƒ¨ã€‚å·¥å‚æ–¹æ³•æ¨¡å¼ä¹‹æ‰€ä»¥åˆè¢«ç§°ä¸ºå¤šæ€å·¥å‚æ¨¡å¼ï¼Œæ˜¯å› ä¸ºæ‰€æœ‰çš„å…·ä½“å·¥å‚ç±»éƒ½å…·æœ‰åŒä¸€æŠ½è±¡çˆ¶ç±»ã€‚</li>
<li>ä½¿ç”¨å·¥å‚æ–¹æ³•æ¨¡å¼çš„å¦ä¸€ä¸ªä¼˜ç‚¹æ˜¯åœ¨ç³»ç»Ÿä¸­åŠ å…¥æ–°äº§å“æ—¶ï¼Œæ— é¡»ä¿®æ”¹æŠ½è±¡å·¥å‚å’ŒæŠ½è±¡äº§å“æä¾›çš„æ¥å£ï¼Œæ— é¡»ä¿®æ”¹å®¢æˆ·ç«¯ï¼Œä¹Ÿæ— é¡»ä¿®æ”¹å…¶ä»–çš„å…·ä½“å·¥å‚å’Œå…·ä½“äº§å“ï¼Œè€Œ<strong>åªè¦æ·»åŠ ä¸€ä¸ªå…·ä½“å·¥å‚å’Œå…·ä½“äº§å“å°±å¯ä»¥äº†</strong>ã€‚è¿™æ ·ï¼Œç³»ç»Ÿçš„å¯æ‰©å±•æ€§ä¹Ÿå°±å˜å¾—éå¸¸å¥½ï¼Œå®Œå…¨ç¬¦åˆâ€œå¼€é—­åŸåˆ™â€ã€‚</li>
</ul>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ul>
<li>åœ¨æ·»åŠ æ–°äº§å“æ—¶ï¼Œéœ€è¦ç¼–å†™æ–°çš„å…·ä½“äº§å“ç±»ï¼Œè€Œä¸”è¿˜è¦æä¾›ä¸ä¹‹å¯¹åº”çš„å…·ä½“å·¥å‚ç±»ï¼Œç³»ç»Ÿä¸­ç±»çš„ä¸ªæ•°å°†æˆå¯¹å¢åŠ ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œæœ‰æ›´å¤šçš„ç±»éœ€è¦ç¼–è¯‘å’Œè¿è¡Œï¼Œä¼šç»™ç³»ç»Ÿå¸¦æ¥ä¸€äº›é¢å¤–çš„å¼€é”€ã€‚</li>
<li>ç”±äºè€ƒè™‘åˆ°ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ï¼Œéœ€è¦å¼•å…¥æŠ½è±¡å±‚ï¼Œåœ¨å®¢æˆ·ç«¯ä»£ç ä¸­å‡ä½¿ç”¨æŠ½è±¡å±‚è¿›è¡Œå®šä¹‰ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„æŠ½è±¡æ€§å’Œç†è§£éš¾åº¦ï¼Œä¸”åœ¨å®ç°æ—¶å¯èƒ½éœ€è¦ç”¨åˆ°DOMã€åå°„ç­‰æŠ€æœ¯ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å®ç°éš¾åº¦ã€‚</li>
</ul>
<h3 id="é€‚ç”¨åœºæ™¯"><a href="#é€‚ç”¨åœºæ™¯" class="headerlink" title="é€‚ç”¨åœºæ™¯"></a>é€‚ç”¨åœºæ™¯</h3><p>â€‹       åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å¯ä»¥è€ƒè™‘ä½¿ç”¨å·¥å‚æ–¹æ³•æ¨¡å¼ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯ä¸çŸ¥é“å®ƒæ‰€éœ€è¦çš„å¯¹è±¡çš„ç±»ã€‚åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ä¸­ï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦çŸ¥é“å…·ä½“äº§å“ç±»çš„ç±»åï¼Œåªéœ€è¦çŸ¥é“æ‰€å¯¹åº”çš„å·¥å‚å³å¯ï¼Œå…·ä½“çš„äº§å“å¯¹è±¡ç”±å…·ä½“å·¥å‚ç±»åˆ›å»ºï¼Œå¯å°†å…·ä½“å·¥å‚ç±»çš„ç±»åå­˜å‚¨åœ¨é…ç½®æ–‡ä»¶æˆ–æ•°æ®åº“ä¸­ã€‚</li>
<li>æŠ½è±¡å·¥å‚ç±»é€šè¿‡å…¶å­ç±»æ¥æŒ‡å®šåˆ›å»ºå“ªä¸ªå¯¹è±¡ã€‚åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ä¸­ï¼Œå¯¹äºæŠ½è±¡å·¥å‚ç±»åªéœ€è¦æä¾›ä¸€ä¸ªåˆ›å»ºäº§å“çš„æ¥å£ï¼Œè€Œç”±å…¶å­ç±»æ¥ç¡®å®šå…·ä½“è¦åˆ›å»ºçš„å¯¹è±¡ï¼Œåˆ©ç”¨é¢å‘å¯¹è±¡çš„å¤šæ€æ€§å’Œé‡Œæ°ä»£æ¢åŸåˆ™ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œå­ç±»å¯¹è±¡å°†è¦†ç›–çˆ¶ç±»å¯¹è±¡ï¼Œä»è€Œä½¿å¾—ç³»ç»Ÿæ›´å®¹æ˜“æ‰©å±•ã€‚</li>
<li>å°†åˆ›å»ºå¯¹è±¡çš„ä»»åŠ¡å§”æ‰˜ç»™å¤šä¸ªå·¥å‚å­ç±»ä¸­çš„æŸä¸€ä¸ªï¼Œå®¢æˆ·ç«¯åœ¨ä½¿ç”¨æ—¶å¯ä»¥æ— é¡»å…³å¿ƒæ˜¯å“ªä¸€ä¸ªå·¥å‚å­ç±»åˆ›å»ºäº§å“å­ç±»ï¼Œéœ€è¦æ—¶å†åŠ¨æ€æŒ‡å®šï¼Œå¯å°†å…·ä½“å·¥å‚ç±»çš„ç±»åå­˜å‚¨åœ¨é…ç½®æ–‡ä»¶æˆ–æ•°æ®åº“ä¸­ã€‚</li>
</ol>
<h3 id="æ¨¡å¼åº”ç”¨"><a href="#æ¨¡å¼åº”ç”¨" class="headerlink" title="æ¨¡å¼åº”ç”¨"></a>æ¨¡å¼åº”ç”¨</h3><p>JDBCä¸­çš„å·¥å‚æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Connection æŠ½è±¡å·¥å‚æ¥å£ï¼Œå…ˆé€šè¿‡getConnectionè·å–å…·ä½“çš„å·¥å‚ç±»</span></div><div class="line">Connection conn=DriverManager.getConnection(<span class="string">"jdbc:microsoft:sqlserver://localhost:1433; DatabaseName=DB;user=sa;password="</span>);</div><div class="line"><span class="comment">// connä¸ºå…·ä½“çš„å·¥å‚ç±»ï¼Œstatementä¸ºå…·ä½“äº§å“</span></div><div class="line">Statement statement=conn.createStatement();</div><div class="line">ResultSet rs=statement.executeQuery(<span class="string">"select * from UserInfo"</span>);</div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://blog.csdn.net/lovelion/article/details/9306745" target="_blank" rel="external">å·¥å‚æ–¹æ³•æ¨¡å¼</a></p>
<p><a href="http://design-patterns.readthedocs.io/zh_CN/latest/creational_patterns/factory_method.html#id15" target="_blank" rel="external">å·¥å‚æ–¹æ³•æ¨¡å¼(Factory Method Pattern)</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è®¾è®¡æ¨¡å¼-ç®€å•å·¥å‚æ¨¡å¼]]></title>
      <url>http://zsr.github.io/2017/05/18/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>â€‹       <strong>ç®€å•å·¥å‚æ¨¡å¼</strong>å¹¶ä¸å±äºGoF 23ä¸ªç»å…¸è®¾è®¡æ¨¡å¼ï¼Œä½†é€šå¸¸å°†å®ƒä½œä¸ºå­¦ä¹ å…¶ä»–å·¥å‚æ¨¡å¼çš„åŸºç¡€ï¼Œå®ƒçš„è®¾è®¡æ€æƒ³å¾ˆç®€å•ï¼Œå…¶åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>â€‹       é¦–å…ˆå°†éœ€è¦åˆ›å»ºçš„å„ç§ä¸åŒå¯¹è±¡çš„ç›¸å…³ä»£ç å°è£…åˆ°ä¸åŒçš„ç±»ä¸­ï¼Œè¿™äº›ç±»ç§°ä¸º<strong>å…·ä½“äº§å“ç±»</strong>ï¼Œè€Œå°†å®ƒä»¬å…¬å…±çš„ä»£ç è¿›è¡ŒæŠ½è±¡å’Œæå–åå°è£…åœ¨ä¸€ä¸ª<strong>æŠ½è±¡äº§å“ç±»</strong>ä¸­ï¼Œæ¯ä¸€ä¸ªå…·ä½“äº§å“ç±»éƒ½æ˜¯æŠ½è±¡äº§å“ç±»çš„å­ç±»ï¼›ç„¶åæä¾›ä¸€ä¸ª<strong>å·¥å‚ç±»</strong>ç”¨äºåˆ›å»ºå„ç§äº§å“ï¼Œåœ¨å·¥å‚ç±»ä¸­æä¾›ä¸€ä¸ªåˆ›å»ºäº§å“çš„å·¥å‚æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥æ ¹æ®æ‰€ä¼ å…¥çš„å‚æ•°ä¸åŒåˆ›å»ºä¸åŒçš„å…·ä½“äº§å“å¯¹è±¡ï¼›å®¢æˆ·ç«¯åªéœ€è°ƒç”¨å·¥å‚ç±»çš„å·¥å‚æ–¹æ³•å¹¶ä¼ å…¥ç›¸åº”çš„å‚æ•°å³å¯å¾—åˆ°ä¸€ä¸ªäº§å“å¯¹è±¡ã€‚</p>
<h3 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ç®€å•å·¥å‚æ¨¡å¼(Simple Factory Pattern)ï¼šå®šä¹‰ä¸€ä¸ªå·¥å‚ç±»ï¼Œå®ƒå¯ä»¥æ ¹æ®å‚æ•°çš„ä¸åŒè¿”å›ä¸åŒç±»çš„å®ä¾‹ï¼Œè¢«åˆ›å»ºçš„å®ä¾‹é€šå¸¸éƒ½å…·æœ‰å…±åŒçš„çˆ¶ç±»ã€‚å› ä¸ºåœ¨ç®€å•å·¥å‚æ¨¡å¼ä¸­ç”¨äºåˆ›å»ºå®ä¾‹çš„æ–¹æ³•æ˜¯é™æ€(static)æ–¹æ³•ï¼Œå› æ­¤ç®€å•å·¥å‚æ¨¡å¼åˆè¢«ç§°ä¸ºé™æ€å·¥å‚æ–¹æ³•(Static Factory Method)æ¨¡å¼ï¼Œå®ƒå±äºç±»åˆ›å»ºå‹æ¨¡å¼ã€‚</div></pre></td></tr></table></figure>
<h3 id="ç»“æ„å›¾"><a href="#ç»“æ„å›¾" class="headerlink" title="ç»“æ„å›¾"></a>ç»“æ„å›¾</h3><p>ç®€å•å·¥å‚æ¨¡å¼çš„è¦ç‚¹åœ¨äºï¼š<strong>å½“ä½ éœ€è¦ä»€ä¹ˆï¼Œåªéœ€è¦ä¼ å…¥ä¸€ä¸ªæ­£ç¡®çš„å‚æ•°ï¼Œå°±å¯ä»¥è·å–ä½ æ‰€éœ€è¦çš„å¯¹è±¡ï¼Œè€Œæ— é¡»çŸ¥é“å…¶åˆ›å»ºç»†èŠ‚ã€‚</strong>ç®€å•å·¥å‚æ¨¡å¼ç»“æ„æ¯”è¾ƒç®€å•ï¼Œå…¶æ ¸å¿ƒæ˜¯å·¥å‚ç±»çš„è®¾è®¡ï¼Œå…¶ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://design-patterns.readthedocs.io/zh_CN/latest/_images/SimpleFactory.jpg" alt="img"></p>
<h3 id="è§’è‰²"><a href="#è§’è‰²" class="headerlink" title="è§’è‰²"></a>è§’è‰²</h3><p>  åœ¨ç®€å•å·¥å‚æ¨¡å¼ç»“æ„å›¾ä¸­åŒ…å«å¦‚ä¸‹å‡ ä¸ªè§’è‰²ï¼š</p>
<ul>
<li><strong>Factoryï¼ˆå·¥å‚è§’è‰²ï¼‰ï¼š</strong>å·¥å‚è§’è‰²å³å·¥å‚ç±»ï¼Œå®ƒæ˜¯ç®€å•å·¥å‚æ¨¡å¼çš„æ ¸å¿ƒï¼Œè´Ÿè´£å®ç°åˆ›å»ºæ‰€æœ‰äº§å“å®ä¾‹çš„å†…éƒ¨é€»è¾‘ï¼›å·¥å‚ç±»å¯ä»¥è¢«å¤–ç•Œç›´æ¥è°ƒç”¨ï¼Œåˆ›å»ºæ‰€éœ€çš„äº§å“å¯¹è±¡ï¼›åœ¨å·¥å‚ç±»ä¸­æä¾›äº†é™æ€çš„å·¥å‚æ–¹æ³•factoryMethod()ï¼Œå®ƒçš„è¿”å›ç±»å‹ä¸ºæŠ½è±¡äº§å“ç±»å‹Productã€‚</li>
<li><strong>Productï¼ˆæŠ½è±¡äº§å“è§’è‰²ï¼‰ï¼š</strong>å®ƒæ˜¯å·¥å‚ç±»æ‰€åˆ›å»ºçš„æ‰€æœ‰å¯¹è±¡çš„çˆ¶ç±»ï¼Œå°è£…äº†å„ç§äº§å“å¯¹è±¡çš„å…¬æœ‰æ–¹æ³•ï¼Œå®ƒçš„å¼•å…¥å°†æé«˜ç³»ç»Ÿçš„çµæ´»æ€§ï¼Œä½¿å¾—åœ¨å·¥å‚ç±»ä¸­åªéœ€å®šä¹‰ä¸€ä¸ªé€šç”¨çš„å·¥å‚æ–¹æ³•ï¼Œå› ä¸ºæ‰€æœ‰åˆ›å»ºçš„å…·ä½“äº§å“å¯¹è±¡éƒ½æ˜¯å…¶å­ç±»å¯¹è±¡ã€‚</li>
<li><strong>ConcreteProductï¼ˆå…·ä½“äº§å“è§’è‰²ï¼‰ï¼š</strong>å®ƒæ˜¯ç®€å•å·¥å‚æ¨¡å¼çš„åˆ›å»ºç›®æ ‡ï¼Œæ‰€æœ‰è¢«åˆ›å»ºçš„å¯¹è±¡éƒ½å……å½“è¿™ä¸ªè§’è‰²çš„æŸä¸ªå…·ä½“ç±»çš„å®ä¾‹ã€‚æ¯ä¸€ä¸ªå…·ä½“äº§å“è§’è‰²éƒ½ç»§æ‰¿äº†æŠ½è±¡äº§å“è§’è‰²ï¼Œéœ€è¦å®ç°åœ¨æŠ½è±¡äº§å“ä¸­å£°æ˜çš„æŠ½è±¡æ–¹æ³•ã€‚</li>
</ul>
<p>åœ¨ç®€å•å·¥å‚æ¨¡å¼ä¸­ï¼Œå®¢æˆ·ç«¯é€šè¿‡å·¥å‚ç±»æ¥åˆ›å»ºä¸€ä¸ªäº§å“ç±»çš„å®ä¾‹ï¼Œè€Œæ— é¡»ç›´æ¥ä½¿ç”¨newå…³é”®å­—æ¥åˆ›å»ºå¯¹è±¡ï¼Œå®ƒæ˜¯å·¥å‚æ¨¡å¼å®¶æ—ä¸­æœ€ç®€å•çš„ä¸€å‘˜ã€‚</p>
<a id="more"></a>
<h3 id="æ—¶åºå›¾"><a href="#æ—¶åºå›¾" class="headerlink" title="æ—¶åºå›¾"></a>æ—¶åºå›¾</h3><p><img src="http://design-patterns.readthedocs.io/zh_CN/latest/_images/seq_SimpleFactory.jpg" alt="img"></p>
<h3 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h3><p>æŠ½è±¡äº§å“ç±»ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;  </div><div class="line">    <span class="comment">//æ‰€æœ‰äº§å“ç±»çš„å…¬å…±ä¸šåŠ¡æ–¹æ³•  </span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">methodSame</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="comment">//å…¬å…±æ–¹æ³•çš„å®ç°  </span></div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">//å£°æ˜æŠ½è±¡ä¸šåŠ¡æ–¹æ³•  </span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">methodDiff</span><span class="params">()</span></span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨å…·ä½“äº§å“ç±»ä¸­å®ç°äº†æŠ½è±¡äº§å“ç±»ä¸­å£°æ˜çš„æŠ½è±¡ä¸šåŠ¡æ–¹æ³•ï¼Œä¸åŒçš„å…·ä½“äº§å“ç±»å¯ä»¥æä¾›ä¸åŒçš„å®ç°ï¼Œå…·ä½“äº§å“ç±»ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteProduct</span> <span class="keyword">extends</span> <span class="title">Product</span> </span>&#123;  </div><div class="line">    <span class="comment">//å®ç°è‡ªå·±çš„ä¸šåŠ¡æ–¹æ³•  </span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">methodDiff</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="comment">//ä¸šåŠ¡æ–¹æ³•çš„å®ç°  </span></div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç®€å•å·¥å‚æ¨¡å¼çš„æ ¸å¿ƒæ˜¯å·¥å‚ç±»ï¼Œåœ¨æ²¡æœ‰å·¥å‚ç±»ä¹‹å‰ï¼Œå®¢æˆ·ç«¯ä¸€èˆ¬ä¼šä½¿ç”¨newå…³é”®å­—æ¥ç›´æ¥åˆ›å»ºäº§å“å¯¹è±¡ï¼Œè€Œåœ¨å¼•å…¥å·¥å‚ç±»ä¹‹åï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡å·¥å‚ç±»æ¥åˆ›å»ºäº§å“ï¼Œåœ¨ç®€å•å·¥å‚æ¨¡å¼ä¸­ï¼Œå·¥å‚ç±»æä¾›äº†ä¸€ä¸ªé™æ€å·¥å‚æ–¹æ³•ä¾›å®¢æˆ·ç«¯ä½¿ç”¨ï¼Œæ ¹æ®æ‰€ä¼ å…¥çš„å‚æ•°ä¸åŒå¯ä»¥åˆ›å»ºä¸åŒçš„äº§å“å¯¹è±¡ï¼Œå·¥å‚ç±»ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Factory</span> </span>&#123;  </div><div class="line">    <span class="comment">//é™æ€å·¥å‚æ–¹æ³•  </span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Product <span class="title">createProduct</span><span class="params">(String arg)</span> </span>&#123;  </div><div class="line">        Product product = <span class="keyword">null</span>;  </div><div class="line">        <span class="keyword">if</span> (arg.equalsIgnoreCase(<span class="string">"A"</span>)) &#123;  </div><div class="line">            product = <span class="keyword">new</span> ConcreteProductA();  </div><div class="line">            <span class="comment">//åˆå§‹åŒ–è®¾ç½®product  </span></div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (arg.equalsIgnoreCase(<span class="string">"B"</span>)) &#123;  </div><div class="line">            product = <span class="keyword">new</span> ConcreteProductB();  </div><div class="line">            <span class="comment">//åˆå§‹åŒ–è®¾ç½®product  </span></div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">return</span> product;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨å·¥å‚ç±»çš„å·¥å‚æ–¹æ³•å³å¯å¾—åˆ°äº§å“å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;  </div><div class="line">        Product product = Factory.getProduct(<span class="string">"A"</span>); <span class="comment">//é€šè¿‡å·¥å‚ç±»åˆ›å»ºäº§å“å¯¹è±¡  </span></div><div class="line">        product.methodSame();  </div><div class="line">        product.methodDiff();  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><ul>
<li>å·¥å‚ç±»å«æœ‰å¿…è¦çš„åˆ¤æ–­é€»è¾‘ï¼Œå¯ä»¥å†³å®šåœ¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºå“ªä¸€ä¸ªäº§å“ç±»çš„å®ä¾‹ï¼Œå®¢æˆ·ç«¯å¯ä»¥å…é™¤ç›´æ¥åˆ›å»ºäº§å“å¯¹è±¡çš„è´£ä»»ï¼Œè€Œä»…ä»…â€œæ¶ˆè´¹â€äº§å“ï¼›ç®€å•å·¥å‚æ¨¡å¼é€šè¿‡è¿™ç§åšæ³•å®ç°äº†å¯¹è´£ä»»çš„åˆ†å‰²ï¼Œå®ƒæä¾›äº†ä¸“é—¨çš„å·¥å‚ç±»ç”¨äºåˆ›å»ºå¯¹è±¡ã€‚</li>
<li>å®¢æˆ·ç«¯æ— é¡»çŸ¥é“æ‰€åˆ›å»ºçš„å…·ä½“äº§å“ç±»çš„ç±»åï¼Œåªéœ€è¦çŸ¥é“å…·ä½“äº§å“ç±»æ‰€å¯¹åº”çš„å‚æ•°å³å¯ï¼Œå¯¹äºä¸€äº›å¤æ‚çš„ç±»åï¼Œé€šè¿‡ç®€å•å·¥å‚æ¨¡å¼å¯ä»¥å‡å°‘ä½¿ç”¨è€…çš„è®°å¿†é‡ã€‚</li>
<li>é€šè¿‡å¼•å…¥é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹ä»»ä½•å®¢æˆ·ç«¯ä»£ç çš„æƒ…å†µä¸‹æ›´æ¢å’Œå¢åŠ æ–°çš„å…·ä½“äº§å“ç±»ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šæé«˜äº†ç³»ç»Ÿçš„çµæ´»æ€§ã€‚</li>
</ul>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ul>
<li>ç”±äºå·¥å‚ç±»é›†ä¸­äº†æ‰€æœ‰äº§å“åˆ›å»ºé€»è¾‘ï¼Œä¸€æ—¦ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œæ•´ä¸ªç³»ç»Ÿéƒ½è¦å—åˆ°å½±å“ã€‚</li>
<li>ä½¿ç”¨ç®€å•å·¥å‚æ¨¡å¼å°†ä¼šå¢åŠ ç³»ç»Ÿä¸­ç±»çš„ä¸ªæ•°ï¼Œåœ¨ä¸€å®šç¨‹åºä¸Šå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦å’Œç†è§£éš¾åº¦ã€‚</li>
<li>ç³»ç»Ÿæ‰©å±•å›°éš¾ï¼Œä¸€æ—¦æ·»åŠ æ–°äº§å“å°±ä¸å¾—ä¸ä¿®æ”¹å·¥å‚é€»è¾‘ï¼Œåœ¨äº§å“ç±»å‹è¾ƒå¤šæ—¶ï¼Œæœ‰å¯èƒ½é€ æˆå·¥å‚é€»è¾‘è¿‡äºå¤æ‚ï¼Œä¸åˆ©äºç³»ç»Ÿçš„æ‰©å±•å’Œç»´æŠ¤ã€‚</li>
<li>ç®€å•å·¥å‚æ¨¡å¼ç”±äºä½¿ç”¨äº†é™æ€å·¥å‚æ–¹æ³•ï¼Œé€ æˆå·¥å‚è§’è‰²æ— æ³•å½¢æˆåŸºäºç»§æ‰¿çš„ç­‰çº§ç»“æ„ã€‚</li>
</ul>
<h3 id="é€‚ç”¨åœºæ™¯"><a href="#é€‚ç”¨åœºæ™¯" class="headerlink" title="é€‚ç”¨åœºæ™¯"></a>é€‚ç”¨åœºæ™¯</h3><p>â€‹       åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å¯ä»¥è€ƒè™‘ä½¿ç”¨ç®€å•å·¥å‚æ¨¡å¼ï¼š</p>
<ol>
<li>å·¥å‚ç±»è´Ÿè´£åˆ›å»ºçš„å¯¹è±¡æ¯”è¾ƒå°‘ï¼Œç”±äºåˆ›å»ºçš„å¯¹è±¡è¾ƒå°‘ï¼Œä¸ä¼šé€ æˆå·¥å‚æ–¹æ³•ä¸­çš„ä¸šåŠ¡é€»è¾‘å¤ªè¿‡å¤æ‚ã€‚</li>
<li>å®¢æˆ·ç«¯åªçŸ¥é“ä¼ å…¥å·¥å‚ç±»çš„å‚æ•°ï¼Œå¯¹äºå¦‚ä½•åˆ›å»ºå¯¹è±¡å¹¶ä¸å…³å¿ƒã€‚</li>
</ol>
<h3 id="æ¨¡å¼åº”ç”¨"><a href="#æ¨¡å¼åº”ç”¨" class="headerlink" title="æ¨¡å¼åº”ç”¨"></a>æ¨¡å¼åº”ç”¨</h3><ol>
<li>JDKç±»åº“ä¸­å¹¿æ³›ä½¿ç”¨äº†ç®€å•å·¥å‚æ¨¡å¼ï¼Œå¦‚å·¥å…·ç±»java.text.DateFormatï¼Œå®ƒç”¨äºæ ¼å¼åŒ–ä¸€ä¸ªæœ¬åœ°æ—¥æœŸæˆ–è€…æ—¶é—´ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> DateFormat <span class="title">getDateInstance</span><span class="params">(<span class="keyword">int</span> style)</span></span>;</div></pre></td></tr></table></figure>
<ol>
<li>JavaåŠ å¯†æŠ€æœ¯</li>
</ol>
<p>è·å–ä¸åŒåŠ å¯†ç®—æ³•çš„å¯†é’¥ç”Ÿæˆå™¨:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">KeyGenerator keyGen=KeyGenerator.getInstance(<span class="string">"DESede"</span>);</div></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Spring MVC è¯·æ±‚å‚æ•°ç»‘å®š]]></title>
      <url>http://zsr.github.io/2017/05/15/Spring-MVC-%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E7%BB%91%E5%AE%9A/</url>
      <content type="html"><![CDATA[<p>åœ¨åš<code>Spring MVC</code>æ—¶ï¼Œæˆ‘ä»¬åªéœ€ç”¨<code>@Controllor</code>æ¥æ ‡è®°<code>Controllor</code>çš„beanï¼Œå†ç”¨<code>@RequestMapping</code>æ¥æ ‡è®°éœ€è¦æ¥å—è¯·æ±‚çš„æ–¹æ³•ï¼Œå°±å¯ä»¥æ ¹æ®ç½‘é¡µè¯·æ±‚ä¸­çš„å‚æ•°åï¼Œè‡ªåŠ¨ç»‘å®šåˆ°POJOå¯¹è±¡çš„å±æ€§åï¼Œè¿™æ˜¯ç›¸å½“æ–¹ä¾¿çš„ã€‚å…¶ä¸­çš„åŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<h3 id="å‰ç»"><a href="#å‰ç»" class="headerlink" title="å‰ç»"></a>å‰ç»</h3><p>é€šè¿‡Spring MVCè¯·æ±‚è°ƒç”¨é“¾ï¼Œå®é™…æ˜¯ç”±<code>ServletInvocableHandlerMethod.invokeAndHandle(webRequest, mavContainer)</code>æ–¹æ³•æ‰§è¡Œå¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line"> * Invokes the method and handles the return value through a registered</div><div class="line"> * &#123;<span class="doctag">@link</span> HandlerMethodReturnValueHandler&#125;.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> webRequest the current request</div><div class="line"> * <span class="doctag">@param</span> mavContainer the ModelAndViewContainer for this request</div><div class="line"> * <span class="doctag">@param</span> providedArgs "given" arguments matched by type, not resolved</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invokeAndHandle</span><span class="params">(ServletWebRequest webRequest,</span></span></div><div class="line">		ModelAndViewContainer mavContainer, Object... providedArgs) <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">       <span class="comment">// æ‰§è¡Œè¯·æ±‚æ–¹æ³•ï¼Œè¿”å›ç»“æœã€‚ã€‚ã€‚</span></div><div class="line">	Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);</div><div class="line"></div><div class="line">	setResponseStatus(webRequest);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (returnValue == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (isRequestNotModified(webRequest) || hasResponseStatus() || mavContainer.isRequestHandled()) &#123;</div><div class="line">			mavContainer.setRequestHandled(<span class="keyword">true</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.responseReason)) &#123;</div><div class="line">		mavContainer.setRequestHandled(<span class="keyword">true</span>);</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	mavContainer.setRequestHandled(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">this</span>.returnValueHandlers.handleReturnValue(returnValue, getReturnValueType(returnValue), mavContainer, webRequest);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</div><div class="line">			logger.trace(getReturnValueHandlingErrorMessage(<span class="string">"Error handling return value"</span>, returnValue), ex);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">throw</span> ex;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<a id="more"></a>
<p><code>webRequest</code>ä¸º<code>httpRequest</code>åŒ…è£…åçš„ç±»ï¼Œæ·»åŠ äº†uriæˆå‘˜ï¼Œæ ‡è®°è¯·æ±‚uriä»¥ä¾¿æ–¹ä¾¿åˆ†é…ã€‚<code>mavContainer</code>ä¸º<code>ModelAndViewContainer</code>ç±»å¯¹è±¡ï¼Œç”¨äºç»‘å®šæ¨¡å—ï¼ˆPOJOï¼‰å’Œè§†å›¾ï¼ˆviewå³ç½‘é¡µï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line"> * Invoke the method after resolving its argument values in the context of the given request. &lt;p&gt;Argument</div><div class="line"> * values are commonly resolved through &#123;<span class="doctag">@link</span> HandlerMethodArgumentResolver&#125;s. The &#123;<span class="doctag">@code</span> provideArgs&#125;</div><div class="line"> * parameter however may supply argument values to be used directly, i.e. without argument resolution.</div><div class="line"> * Examples of provided argument values include a &#123;<span class="doctag">@link</span> WebDataBinder&#125;, a &#123;<span class="doctag">@link</span> SessionStatus&#125;, or</div><div class="line"> * a thrown exception instance. Provided argument values are checked before argument resolvers.</div><div class="line"> * <span class="doctag">@param</span> request the current request</div><div class="line"> * <span class="doctag">@param</span> mavContainer the ModelAndViewContainer for this request</div><div class="line"> * <span class="doctag">@param</span> providedArgs "given" arguments matched by type, not resolved</div><div class="line"> * <span class="doctag">@return</span> the raw value returned by the invoked method</div><div class="line"> * <span class="doctag">@exception</span> Exception raised if no suitable argument resolver can be found, or the method raised an exception</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title">invokeForRequest</span><span class="params">(NativeWebRequest request, ModelAndViewContainer mavContainer,</span></span></div><div class="line">		Object... providedArgs) <span class="keyword">throws</span> Exception &#123;</div><div class="line">       </div><div class="line">       <span class="comment">// ç»‘å®šå‚æ•°ï¼Œé‡ç‚¹ã€‚ã€‚ã€‚ã€‚ã€‚</span></div><div class="line">	Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);</div><div class="line">	<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</div><div class="line">		StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">"Invoking ["</span>);</div><div class="line">		sb.append(getBeanType().getSimpleName()).append(<span class="string">"."</span>);</div><div class="line">		sb.append(getMethod().getName()).append(<span class="string">"] method with arguments "</span>);</div><div class="line">		sb.append(Arrays.asList(args));</div><div class="line">		logger.trace(sb.toString());</div><div class="line">	&#125;</div><div class="line">	Object returnValue = invoke(args);</div><div class="line">	<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</div><div class="line">		logger.trace(<span class="string">"Method ["</span> + getMethod().getName() + <span class="string">"] returned ["</span> + returnValue + <span class="string">"]"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> returnValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨<code>invokeForRequest</code>æ–¹æ³•ä¸­ï¼Œ<code>Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs)</code>;è¯¥æ–¹æ³•è·å–æ¯ä¸ªè¯·æ±‚å‚æ•°ä¸å¯¹åº”çš„å€¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">/**</span></div><div class="line">	 * Get the method argument values for the current request.</div><div class="line">	 */</div><div class="line"><span class="keyword">private</span> Object[] getMethodArgumentValues(NativeWebRequest request, ModelAndViewContainer mavContainer,</div><div class="line">            Object... providedArgs) <span class="keyword">throws</span> Exception &#123;</div><div class="line">        <span class="comment">// è·å–æ‰€æœ‰å‚æ•°æ‰€å±çš„ç±»</span></div><div class="line">        MethodParameter[] parameters = getMethodParameters();</div><div class="line">        Object[] args = <span class="keyword">new</span> Object[parameters.length];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameters.length; i++) &#123;</div><div class="line">            MethodParameter parameter = parameters[i];</div><div class="line">            parameter.initParameterNameDiscovery(<span class="keyword">this</span>.parameterNameDiscoverer);</div><div class="line">            GenericTypeResolver.resolveParameterType(parameter, getBean().getClass());</div><div class="line">            args[i] = resolveProvidedArgument(parameter, providedArgs);</div><div class="line">            <span class="keyword">if</span> (args[i] != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.argumentResolvers.supportsParameter(parameter)) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    args[i] = <span class="keyword">this</span>.argumentResolvers.resolveArgument(</div><div class="line">                            parameter, mavContainer, request, <span class="keyword">this</span>.dataBinderFactory);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">                    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</div><div class="line">                        logger.trace(getArgumentResolutionErrorMessage(<span class="string">"Error resolving argument"</span>, i), ex);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">throw</span> ex;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (args[i] == <span class="keyword">null</span>) &#123;</div><div class="line">                String msg = getArgumentResolutionErrorMessage(<span class="string">"No suitable resolver for argument"</span>, i);</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> args;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getArgumentResolutionErrorMessage</span><span class="params">(String message, <span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">        MethodParameter param = getMethodParameters()[index];</div><div class="line">        message += <span class="string">" ["</span> + index + <span class="string">"] [type="</span> + param.getParameterType().getName() + <span class="string">"]"</span>;</div><div class="line">        <span class="keyword">return</span> getDetailedErrorMessage(message);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•ä¹Ÿè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå¾ªç¯éå†è¯·æ±‚å‚æ•°ï¼Œç„¶åå§”æ‰˜ç»™<code>HandlerMethodArgumentResolver</code>æ¥å£çš„æ–¹æ³• <code>resolveArgument</code>å»è¿›è¡Œå‚æ•°å€¼è§£æã€‚</p>
<h3 id="ç»‘å®šå‚æ•°å"><a href="#ç»‘å®šå‚æ•°å" class="headerlink" title="ç»‘å®šå‚æ•°å"></a>ç»‘å®šå‚æ•°å</h3><p>è¿™é‡Œé¢å¯¹<code>ParameterNameDiscovery</code>åˆå§‹åŒ–ï¼Œç”¨æ¥æŸ¥æ‰¾å‚æ•°åï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ParameterNameDiscoverer parameterNameDiscoverer = <span class="keyword">new</span> LocalVariableTableParameterNameDiscoverer();</div><div class="line"><span class="comment">// ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚çœç•¥</span></div><div class="line">methodParam.initParameterNameDiscovery(<span class="keyword">this</span>.parameterNameDiscoverer);</div></pre></td></tr></table></figure>
<p>ä½äºjava1.8ä½¿ç”¨<code>new LocalVariableTableParameterNameDiscoverer()</code>æ¥è§£æå‚æ•°åã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> String[] getParameterNames(Method method) &#123;</div><div class="line">		Method originalMethod = BridgeMethodResolver.findBridgedMethod(method);</div><div class="line">		Class&lt;?&gt; declaringClass = originalMethod.getDeclaringClass();</div><div class="line">		Map&lt;Member, String[]&gt; map = <span class="keyword">this</span>.parameterNamesCache.get(declaringClass);</div><div class="line">		<span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</div><div class="line">			map = inspectClass(declaringClass);</div><div class="line">			<span class="keyword">this</span>.parameterNamesCache.put(declaringClass, map);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (map != NO_DEBUG_INFO_MAP) &#123;</div><div class="line">			<span class="keyword">return</span> map.get(originalMethod);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡<code>map = inspectClass(declaringClass);</code>è·å–åç§°mapã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">	 * Inspects the target class. Exceptions will be logged and a maker map returned</div><div class="line">	 * to indicate the lack of debug information.</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> Map&lt;Member, String[]&gt; inspectClass(Class&lt;?&gt; clazz) &#123;</div><div class="line">		InputStream is = clazz.getResourceAsStream(ClassUtils.getClassFileName(clazz));</div><div class="line">		<span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// We couldn't load the class file, which is not fatal as it</span></div><div class="line">			<span class="comment">// simply means this method of discovering parameter names won't work.</span></div><div class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">				logger.debug(<span class="string">"Cannot find '.class' file for class ["</span> + clazz +</div><div class="line">						<span class="string">"] - unable to determine constructor/method parameter names"</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> NO_DEBUG_INFO_MAP;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			ClassReader classReader = <span class="keyword">new</span> ClassReader(is);</div><div class="line">			Map&lt;Member, String[]&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;Member, String[]&gt;(<span class="number">32</span>);</div><div class="line">			classReader.accept(<span class="keyword">new</span> ParameterNameDiscoveringVisitor(clazz, map), <span class="number">0</span>);</div><div class="line">			<span class="keyword">return</span> map;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">				logger.debug(<span class="string">"Exception thrown while reading '.class' file for class ["</span> + clazz +</div><div class="line">						<span class="string">"] - unable to determine constructor/method parameter names"</span>, ex);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">				logger.debug(<span class="string">"ASM ClassReader failed to parse class file ["</span> + clazz +</div><div class="line">						<span class="string">"], probably due to a new Java class file version that isn't supported yet "</span> +</div><div class="line">						<span class="string">"- unable to determine constructor/method parameter names"</span>, ex);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">finally</span> &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				is.close();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">				<span class="comment">// ignore</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> NO_DEBUG_INFO_MAP;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p><code>ClassReader</code>ä½äº<code>org.springframework.asm</code>åŒ…ä¸­ï¼Œæ˜¯Springç”¨äºåç¼–è¯‘çš„åŒ…ï¼Œè¯»å–classä¿¡æ¯ï¼Œclassä¿¡æ¯ä¸­æ˜¯åŒ…å«å‚æ•°åçš„ï¼ˆå¯ä»¥ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ä¸€ä¸ªclassæ–‡ä»¶æŸ¥çœ‹ï¼Œè™½ç„¶æœ‰ä¹±ç ï¼Œä½†æ˜¯æ–¹æ³•çš„å‚æ•°åè¿˜åœ¨ï¼‰ã€‚</p>
<p>é€šè¿‡acceptå¡«å……mapå¯¹è±¡ï¼Œmapçš„é”®ä¸ºæˆå‘˜å(æ–¹æ³•åæˆ–è€…å‚æ•°å)ï¼Œå€¼ä¸ºå‚æ•°åˆ—è¡¨(å­—ç¬¦ä¸²æ•°ç»„)ã€‚</p>
<p>ç”±æ­¤å¯è§ï¼ŒSpringæ˜¯ç›´æ¥è¯»å–classæ–‡ä»¶æ¥è¯»å–å‚æ•°åçš„.</p>
<p>æ³¨æ„ï¼š<code>this.parameterNamesCache.put(declaringClass, map);</code>ä½¿ç”¨äº†<code>ConcurrentHashMap</code>è®¾ç½®æ–¹æ³•åç¼“å­˜ã€‚é¿å…æ¯ä¸€æ¬¡è°ƒç”¨éƒ½è¦åç¼–è¯‘classæ–‡ä»¶ã€‚</p>
<h3 id="è§£æå‚æ•°å€¼"><a href="#è§£æå‚æ•°å€¼" class="headerlink" title="è§£æå‚æ•°å€¼"></a>è§£æå‚æ•°å€¼</h3><p>è¦ç»™å‚æ•°æ³¨å…¥å‚æ•°çš„å€¼ï¼Œæœ€ç»ˆæ˜¯é€šè¿‡<code>HandlerMethodArgumentResolver</code>æ¥å£çš„å®ç°ç±»<code>HandlerMethodArgumentResolverComposite</code>å®ç°çš„ã€‚<code>HandlerMethodArgumentResolverComposite</code>ç±»å®ç°æ˜¯é‡‡ç”¨çš„ç»„åˆæ¨¡å¼çš„è®¾è®¡ç­–ç•¥ï¼Œå¯ä»¥åœ¨ç±»<code>RequestMappingHandlerAdapter</code>ä¸­çš„æ–¹æ³•<code>afterPropertiesSet</code>æ–¹æ³•ä¸­çœ‹åˆ°<code>HandlerMethodArgumentResolverComposite</code>ä¸­çš„resovlerçš„åˆå§‹åŒ–ä»£ç ã€‚</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.argumentResolvers == <span class="keyword">null</span>) &#123;</div><div class="line">			List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultArgumentResolvers();</div><div class="line">			<span class="keyword">this</span>.argumentResolvers = <span class="keyword">new</span> HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.initBinderArgumentResolvers == <span class="keyword">null</span>) &#123;</div><div class="line">			List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultInitBinderArgumentResolvers();</div><div class="line">			<span class="keyword">this</span>.initBinderArgumentResolvers = <span class="keyword">new</span> HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.returnValueHandlers == <span class="keyword">null</span>) &#123;</div><div class="line">			List&lt;HandlerMethodReturnValueHandler&gt; handlers = getDefaultReturnValueHandlers();</div><div class="line">			<span class="keyword">this</span>.returnValueHandlers = <span class="keyword">new</span> HandlerMethodReturnValueHandlerComposite().addHandlers(handlers);</div><div class="line">		&#125;</div><div class="line">		initControllerAdviceCache();</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡è¿™ä¸ª<code>afterPropertiesSet</code>æ–¹æ³•å¢åŠ é»˜è®¤çš„å‚æ•°è§£æå™¨ï¼Œé»˜è®¤çš„å‚æ•°è§£æå™¨å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">	 * Return the list of argument resolvers to use including built-in resolvers</div><div class="line">	 * and custom resolvers provided via &#123;<span class="doctag">@link</span> #setCustomArgumentResolvers&#125;.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> List&lt;HandlerMethodArgumentResolver&gt; <span class="title">getDefaultArgumentResolvers</span><span class="params">()</span> </span>&#123;</div><div class="line">		List&lt;HandlerMethodArgumentResolver&gt; resolvers = <span class="keyword">new</span> ArrayList&lt;HandlerMethodArgumentResolver&gt;();</div><div class="line"></div><div class="line">		<span class="comment">// Annotation-based argument resolution</span></div><div class="line">        <span class="comment">// æ”¯æŒå¸¦æœ‰@RequestParamæ³¨è§£çš„å‚æ•°</span></div><div class="line">		resolvers.add(<span class="keyword">new</span> RequestParamMethodArgumentResolver(getBeanFactory(), <span class="keyword">false</span>));</div><div class="line">		resolvers.add(<span class="keyword">new</span> RequestParamMapMethodArgumentResolver());</div><div class="line">		resolvers.add(<span class="keyword">new</span> PathVariableMethodArgumentResolver());</div><div class="line">		resolvers.add(<span class="keyword">new</span> PathVariableMapMethodArgumentResolver());</div><div class="line">		resolvers.add(<span class="keyword">new</span> MatrixVariableMethodArgumentResolver());</div><div class="line">		resolvers.add(<span class="keyword">new</span> MatrixVariableMapMethodArgumentResolver());</div><div class="line">		resolvers.add(<span class="keyword">new</span> ServletModelAttributeMethodProcessor(<span class="keyword">false</span>));</div><div class="line">        <span class="comment">// @RequestBodyæ³¨è§£çš„å‚æ•°è§£æå™¨</span></div><div class="line">		resolvers.add(<span class="keyword">new</span> RequestResponseBodyMethodProcessor(getMessageConverters()));</div><div class="line">		resolvers.add(<span class="keyword">new</span> RequestPartMethodArgumentResolver(getMessageConverters()));</div><div class="line">		resolvers.add(<span class="keyword">new</span> RequestHeaderMethodArgumentResolver(getBeanFactory()));</div><div class="line">		resolvers.add(<span class="keyword">new</span> RequestHeaderMapMethodArgumentResolver());</div><div class="line">		resolvers.add(<span class="keyword">new</span> ServletCookieValueMethodArgumentResolver(getBeanFactory()));</div><div class="line">		resolvers.add(<span class="keyword">new</span> ExpressionValueMethodArgumentResolver(getBeanFactory()));</div><div class="line"></div><div class="line">		<span class="comment">// Type-based argument resolution</span></div><div class="line">        <span class="comment">// å‚æ•°ç±»å‹æ˜¯å®ç°æˆ–ç»§æ‰¿æˆ–æ˜¯WebRequestã€ServletRequestè¿™äº›ç±»ã€‚</span></div><div class="line">		resolvers.add(<span class="keyword">new</span> ServletRequestMethodArgumentResolver());</div><div class="line">		resolvers.add(<span class="keyword">new</span> ServletResponseMethodArgumentResolver());</div><div class="line">		resolvers.add(<span class="keyword">new</span> HttpEntityMethodProcessor(getMessageConverters()));</div><div class="line">		resolvers.add(<span class="keyword">new</span> RedirectAttributesMethodArgumentResolver());</div><div class="line">		resolvers.add(<span class="keyword">new</span> ModelMethodProcessor());</div><div class="line">		resolvers.add(<span class="keyword">new</span> MapMethodProcessor());</div><div class="line">		resolvers.add(<span class="keyword">new</span> ErrorsMethodArgumentResolver());</div><div class="line">		resolvers.add(<span class="keyword">new</span> SessionStatusMethodArgumentResolver());</div><div class="line">		resolvers.add(<span class="keyword">new</span> UriComponentsBuilderMethodArgumentResolver());</div><div class="line"></div><div class="line">		<span class="comment">// Custom arguments</span></div><div class="line">		<span class="keyword">if</span> (getCustomArgumentResolvers() != <span class="keyword">null</span>) &#123;</div><div class="line">			resolvers.addAll(getCustomArgumentResolvers());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Catch-all</span></div><div class="line">		resolvers.add(<span class="keyword">new</span> RequestParamMethodArgumentResolver(getBeanFactory(), <span class="keyword">true</span>));</div><div class="line">		resolvers.add(<span class="keyword">new</span> ServletModelAttributeMethodProcessor(<span class="keyword">true</span>));</div><div class="line"></div><div class="line">		<span class="keyword">return</span> resolvers;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>å¸¸ç”¨çš„å‚æ•°è§£æå™¨ç”±<code>RequestParamMethodArgumentResolver</code>ï¼Œ <code>RequestResponseBodyMethodProcessor</code>(è¿™ä¸ªç±»ä¹Ÿå®ç°äº†<code>HandlerMethodReturnValueHandler</code>æ¥å£)ç­‰ã€‚</p>
<p>å‚æ•°è§£ææºç è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¦‚æœæœ‰æä¾›çš„å‚æ•°å€¼ï¼Œç›´æ¥è¿”å›æä¾›çš„å‚æ•°å€¼</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">args[i] = resolveProvidedArgument(parameter, providedArgs);</div><div class="line"><span class="keyword">if</span> (args[i] != <span class="keyword">null</span>) &#123;</div><div class="line">	 <span class="keyword">continue</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æ£€å¯Ÿå‚æ•°ç±»å‹æ˜¯å¦æ”¯æŒ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.argumentResolvers.supportsParameter(parameter)</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HandlerMethodArgumentResolverCompositeç±»</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsParameter</span><span class="params">(MethodParameter parameter)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> getArgumentResolver(parameter) != <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">	 * Find a registered &#123;<span class="doctag">@link</span> HandlerMethodArgumentResolver&#125; that supports the given method parameter.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> HandlerMethodArgumentResolver <span class="title">getArgumentResolver</span><span class="params">(MethodParameter parameter)</span> </span>&#123;</div><div class="line">		HandlerMethodArgumentResolver result = <span class="keyword">this</span>.argumentResolverCache.get(parameter);</div><div class="line">		<span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">for</span> (HandlerMethodArgumentResolver methodArgumentResolver : <span class="keyword">this</span>.argumentResolvers) &#123;</div><div class="line">				<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</div><div class="line">					logger.trace(<span class="string">"Testing if argument resolver ["</span> + methodArgumentResolver + <span class="string">"] supports ["</span> +</div><div class="line">							parameter.getGenericParameterType() + <span class="string">"]"</span>);</div><div class="line">				&#125;</div><div class="line">                <span class="comment">// æ£€å¯Ÿå‚æ•°ç±»å‹æ˜¯å¦æ”¯æŒ(æ¯ä¸€ä¸ªHandlerMethodArgumentResolveréƒ½æœ‰ä¸€ä¸ªsupportsParameteræ–¹æ³•åˆ¤æ–­æ˜¯å¦æ”¯æŒå‚æ•°ç±»å‹)</span></div><div class="line">				<span class="keyword">if</span> (methodArgumentResolver.supportsParameter(parameter)) &#123;</div><div class="line">					result = methodArgumentResolver;</div><div class="line">					<span class="keyword">this</span>.argumentResolverCache.put(parameter, result);</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æŸ¥è¯¢å‚æ•°è§£æå™¨ï¼Œæ‰¾åˆ°åå§”æ‰˜ç»™å‚æ•°è§£æå™¨è§£æ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">args[i] = <span class="keyword">this</span>.argumentResolvers.resolveArgument(</div><div class="line">							parameter, mavContainer, request, <span class="keyword">this</span>.dataBinderFactory);</div><div class="line">					<span class="keyword">continue</span>;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HandlerMethodArgumentResolverå®ç°ç±»(è¿™é‡Œæ˜¯RequestResponseBodyMethodProcessor)</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, ModelAndViewContainer mavContainer,</span></span></div><div class="line">			NativeWebRequest webRequest, WebDataBinderFactory binderFactory) <span class="keyword">throws</span> Exception &#123;</div><div class="line">		Object arg = readWithMessageConverters(webRequest, parameter, parameter.getGenericParameterType());</div><div class="line">		String name = Conventions.getVariableNameForParameter(parameter);</div><div class="line">		WebDataBinder binder = binderFactory.createBinder(webRequest, arg, name);</div><div class="line">		<span class="keyword">if</span> (arg != <span class="keyword">null</span>) &#123;</div><div class="line">			validate(binder, parameter);</div><div class="line">		&#125;</div><div class="line">		mavContainer.addAttribute(BindingResult.MODEL_KEY_PREFIX + name, binder.getBindingResult());</div><div class="line">		<span class="keyword">return</span> arg;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">	<span class="keyword">protected</span> &lt;T&gt; <span class="function">Object <span class="title">readWithMessageConverters</span><span class="params">(NativeWebRequest webRequest, MethodParameter methodParam,</span></span></div><div class="line">			Type paramType) <span class="keyword">throws</span> IOException, HttpMediaTypeNotSupportedException &#123;</div><div class="line"></div><div class="line">		HttpServletRequest servletRequest = webRequest.getNativeRequest(HttpServletRequest.class);</div><div class="line">		HttpInputMessage inputMessage = <span class="keyword">new</span> ServletServerHttpRequest(servletRequest);</div><div class="line"></div><div class="line">        <span class="comment">// æŸ¥çœ‹å‚æ•°æ˜¯å¦æœ‰@RequestBodyæ³¨è§£</span></div><div class="line">		RequestBody ann = methodParam.getParameterAnnotation(RequestBody.class);</div><div class="line">		<span class="keyword">if</span> (!ann.required()) &#123;</div><div class="line">			InputStream inputStream = inputMessage.getBody();</div><div class="line">			<span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (inputStream.markSupported()) &#123;</div><div class="line">				inputStream.mark(<span class="number">1</span>);</div><div class="line">				<span class="keyword">if</span> (inputStream.read() == -<span class="number">1</span>) &#123;</div><div class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">				&#125;</div><div class="line">				inputStream.reset();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">final</span> PushbackInputStream pushbackInputStream = <span class="keyword">new</span> PushbackInputStream(inputStream);</div><div class="line">				<span class="keyword">int</span> b = pushbackInputStream.read();</div><div class="line">				<span class="keyword">if</span> (b == -<span class="number">1</span>) &#123;</div><div class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">else</span> &#123;</div><div class="line">					pushbackInputStream.unread(b);</div><div class="line">				&#125;</div><div class="line">				inputMessage = <span class="keyword">new</span> ServletServerHttpRequest(servletRequest) &#123;</div><div class="line">					<span class="meta">@Override</span></div><div class="line">					<span class="function"><span class="keyword">public</span> InputStream <span class="title">getBody</span><span class="params">()</span> </span>&#123;</div><div class="line">						<span class="comment">// Form POST should not get here</span></div><div class="line">						<span class="keyword">return</span> pushbackInputStream;</div><div class="line">					&#125;</div><div class="line">				&#125;;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.readWithMessageConverters(inputMessage, methodParam, paramType);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åä¼šæ‰§è¡Œçˆ¶ç±»(AbstractMessageConverterMethodArgumentResolver)çš„readWithMessageConvertersæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">	 * Create the method argument value of the expected parameter type by reading</div><div class="line">	 * from the given HttpInputMessage.</div><div class="line">	 * <span class="doctag">@param</span> &lt;T&gt; the expected type of the argument value to be created</div><div class="line">	 * <span class="doctag">@param</span> inputMessage the HTTP input message representing the current request</div><div class="line">	 * <span class="doctag">@param</span> methodParam the method argument</div><div class="line">	 * <span class="doctag">@param</span> targetType the type of object to create, not necessarily the same as</div><div class="line">	 * the method parameter type (e.g. for &#123;<span class="doctag">@code</span> HttpEntity&lt;String&gt;&#125; method</div><div class="line">	 * parameter the target type is String)</div><div class="line">	 * <span class="doctag">@return</span> the created method argument value</div><div class="line">	 * <span class="doctag">@throws</span> IOException if the reading from the request fails</div><div class="line">	 * <span class="doctag">@throws</span> HttpMediaTypeNotSupportedException if no suitable message converter is found</div><div class="line">	 */</div><div class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">	<span class="keyword">protected</span> &lt;T&gt; <span class="function">Object <span class="title">readWithMessageConverters</span><span class="params">(HttpInputMessage inputMessage,</span></span></div><div class="line">			MethodParameter methodParam, Type targetType) <span class="keyword">throws</span> IOException, HttpMediaTypeNotSupportedException &#123;</div><div class="line"></div><div class="line">		MediaType contentType;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			contentType = inputMessage.getHeaders().getContentType();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (InvalidMediaTypeException ex) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> HttpMediaTypeNotSupportedException(ex.getMessage());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (contentType == <span class="keyword">null</span>) &#123;</div><div class="line">			contentType = MediaType.APPLICATION_OCTET_STREAM;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Class&lt;?&gt; contextClass = methodParam.getDeclaringClass();</div><div class="line">		Map&lt;TypeVariable, Type&gt; map = GenericTypeResolver.getTypeVariableMap(contextClass);</div><div class="line">		Class&lt;T&gt; targetClass = (Class&lt;T&gt;) GenericTypeResolver.resolveType(targetType, map);</div><div class="line"></div><div class="line">		<span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; converter : <span class="keyword">this</span>.messageConverters) &#123;</div><div class="line">			<span class="keyword">if</span> (converter <span class="keyword">instanceof</span> GenericHttpMessageConverter) &#123;</div><div class="line">				GenericHttpMessageConverter genericConverter = (GenericHttpMessageConverter) converter;</div><div class="line">				<span class="keyword">if</span> (genericConverter.canRead(targetType, contextClass, contentType)) &#123;</div><div class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">						logger.debug(<span class="string">"Reading ["</span> + targetType + <span class="string">"] as \""</span> +</div><div class="line">								contentType + <span class="string">"\" using ["</span> + converter + <span class="string">"]"</span>);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">return</span> genericConverter.read(targetType, contextClass, inputMessage);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (targetClass != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (converter.canRead(targetClass, contentType)) &#123;</div><div class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">						logger.debug(<span class="string">"Reading ["</span> + targetClass.getName() + <span class="string">"] as \""</span> +</div><div class="line">								contentType + <span class="string">"\" using ["</span> + converter + <span class="string">"]"</span>);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">return</span> ((HttpMessageConverter&lt;T&gt;) converter).read(targetClass, inputMessage);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> HttpMediaTypeNotSupportedException(contentType, <span class="keyword">this</span>.allSupportedMediaTypes);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæ˜¯ç”¨äº†æ¶ˆæ¯è½¬æ¢å™¨<code>HttpMessageConverter</code></p>
<ul>
<li>å¦‚æœæœªæ‰¾åˆ°æŠ›å‡ºå¼‚å¸¸</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (args[i] == <span class="keyword">null</span>) &#123;</div><div class="line">				String msg = getArgumentResolutionErrorMessage(<span class="string">"No suitable resolver for argument"</span>, i);</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.cnblogs.com/guangshan/p/4660564.html" target="_blank" rel="external">åå°„è·å–ä¸€ä¸ªæ–¹æ³•ä¸­çš„å‚æ•°å(ä¸æ˜¯ç±»å‹)</a></p>
<p><a href="http://www.cnblogs.com/guangshan/p/4431800.html" target="_blank" rel="external">Springæºç ç ”ç©¶ï¼šæ•°æ®ç»‘å®š</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Servlet 3 ä¸­çš„å¼‚æ­¥å¤„ç†]]></title>
      <url>http://zsr.github.io/2017/05/09/Servlet-3-%E4%B8%AD%E7%9A%84%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86/</url>
      <content type="html"><![CDATA[<p><strong><a href="http://www.cnblogs.com/davenkin/p/async-servlet.html" target="_blank" rel="external">è½¬è½½</a></strong></p>
<p>åœ¨<code>Servlet 3.0</code>ä¹‹å‰ï¼Œ<code>Servlet</code>é‡‡ç”¨<code>Thread-Per-Request</code>çš„æ–¹å¼å¤„ç†è¯·æ±‚ï¼Œå³æ¯ä¸€æ¬¡<code>Http</code>è¯·æ±‚éƒ½ç”±æŸä¸€ä¸ªçº¿ç¨‹ä»å¤´åˆ°å°¾è´Ÿè´£å¤„ç†ã€‚å¦‚æœä¸€ä¸ªè¯·æ±‚éœ€è¦è¿›è¡ŒIOæ“ä½œï¼Œæ¯”å¦‚è®¿é—®æ•°æ®åº“ã€è°ƒç”¨ç¬¬ä¸‰æ–¹æœåŠ¡æ¥å£ç­‰ï¼Œé‚£ä¹ˆå…¶æ‰€å¯¹åº”çš„çº¿ç¨‹å°†åŒæ­¥åœ°ç­‰å¾…IOæ“ä½œå®Œæˆï¼Œ è€ŒIOæ“ä½œæ˜¯éå¸¸æ…¢çš„ï¼Œæ‰€ä»¥æ­¤æ—¶çš„çº¿ç¨‹å¹¶ä¸èƒ½åŠæ—¶åœ°é‡Šæ”¾å›çº¿ç¨‹æ± ä»¥ä¾›åç»­ä½¿ç”¨ï¼Œåœ¨å¹¶å‘é‡è¶Šæ¥è¶Šå¤§çš„æƒ…å†µä¸‹ï¼Œè¿™å°†å¸¦æ¥ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚å³ä¾¿æ˜¯åƒ<code>Spring</code>ã€<code>Struts</code>è¿™æ ·çš„é«˜å±‚æ¡†æ¶ä¹Ÿè„±ç¦»ä¸äº†è¿™æ ·çš„æ¡æ¢ï¼Œå› ä¸ºä»–ä»¬éƒ½æ˜¯å»ºç«‹åœ¨<code>Servlet</code>ä¹‹ä¸Šçš„ã€‚ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œ<code>Servlet 3.0</code>å¼•å…¥äº†å¼‚æ­¥å¤„ç†ï¼Œç„¶ååœ¨<code>Servlet 3.1</code>ä¸­åˆå¼•å…¥äº†éé˜»å¡IOæ¥è¿›ä¸€æ­¥å¢å¼ºå¼‚æ­¥å¤„ç†çš„æ€§èƒ½ã€‚</p>
<p>åœ¨<code>Servlet 3.0</code>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä»<code>HttpServletRequest</code>å¯¹è±¡ä¸­è·å¾—ä¸€ä¸ª<code>AsyncContext</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ„æˆäº†å¼‚æ­¥å¤„ç†çš„ä¸Šä¸‹æ–‡ï¼Œ<code>Request</code>å’Œ<code>Response</code>å¯¹è±¡éƒ½å¯ä»ä¸­è·å–ã€‚<code>AsyncContext</code>å¯ä»¥ä»å½“å‰çº¿ç¨‹ä¼ ç»™å¦å¤–çš„çº¿ç¨‹ï¼Œå¹¶åœ¨æ–°çš„çº¿ç¨‹ä¸­å®Œæˆå¯¹è¯·æ±‚çš„å¤„ç†å¹¶è¿”å›ç»“æœç»™å®¢æˆ·ç«¯ï¼Œåˆå§‹çº¿ç¨‹ä¾¿å¯ä»¥è¿˜å›ç»™å®¹å™¨çº¿ç¨‹æ± ä»¥å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚å¦‚æ­¤ï¼Œé€šè¿‡å°†è¯·æ±‚ä»ä¸€ä¸ªçº¿ç¨‹ä¼ ç»™å¦ä¸€ä¸ªçº¿ç¨‹å¤„ç†çš„è¿‡ç¨‹ä¾¿æ„æˆäº†<code>Servlet 3.0</code>ä¸­çš„å¼‚æ­¥å¤„ç†ã€‚</p>
<h3 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> davenkin.servlet;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="meta">@WebServlet</span>(<span class="string">"/syncHello"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncHelloServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request,</span></span></div><div class="line">                         HttpServletResponse response) <span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line">        <span class="keyword">new</span> LongRunningProcess().run();</div><div class="line">        response.getWriter().write(<span class="string">"Hello World!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸ºäº†æ¨¡æ‹Ÿé•¿æ—¶å¤„ç†è¿‡ç¨‹ï¼Œåˆ›å»ºäº†ä¸€ä¸ª<code>LongRunningProcess</code>ç±»ï¼Œå…¶<code>run()</code>æ–¹æ³•å°†éšæœºåœ°ç­‰å¾…2ç§’ä¹‹å†…çš„ä¸€ä¸ªæ—¶é—´ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> davenkin.servlet;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.ThreadLocalRandom;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by yteng on 3/14/17.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LongRunningProcess</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">            <span class="keyword">int</span> millis = ThreadLocalRandom.current().nextInt(<span class="number">2000</span>);</div><div class="line">            String currentThread = Thread.currentThread().getName();</div><div class="line">            System.out.println(currentThread + <span class="string">" sleep for "</span> + millis + <span class="string">" milliseconds."</span>);</div><div class="line">            Thread.sleep(millis);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ­¤æ—¶çš„<code>SyncHelloServlet</code>å°†é¡ºåºåœ°å…ˆæ‰§è¡Œ<code>LongRunningProcess</code>çš„<code>run()</code>æ–¹æ³•ï¼Œç„¶åå°†å°†<code>HelloWorld</code>è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„åŒæ­¥è¿‡ç¨‹ã€‚</p>
<a id="more"></a>
<p>åœ¨<code>Servlet 3.0</code>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆå†™æ¥è¾¾åˆ°å¼‚æ­¥å¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> davenkin.servlet;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.AsyncContext;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="meta">@WebServlet</span>(value = <span class="string">"/simpleAsync"</span>, asyncSupported = <span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleAsyncHelloServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line">        AsyncContext asyncContext = request.startAsync();</div><div class="line"></div><div class="line">        asyncContext.start(() -&gt; &#123;</div><div class="line">            <span class="keyword">new</span> LongRunningProcess().run();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                asyncContext.getResponse().getWriter().write(<span class="string">"Hello World!"</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            asyncContext.complete();</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡<code>request.startAsync()</code>è·å–åˆ°è¯¥è¯·æ±‚å¯¹åº”çš„<code>AsyncContext</code>ï¼Œç„¶åè°ƒç”¨<code>AsyncContext</code>çš„<code>start()</code>æ–¹æ³•è¿›è¡Œå¼‚æ­¥å¤„ç†ï¼Œå¤„ç†å®Œæ¯•åéœ€è¦è°ƒç”¨<code>complete()</code>æ–¹æ³•å‘ŠçŸ¥<code>Servlet</code>å®¹å™¨ã€‚<code>start()</code>æ–¹æ³•ä¼šå‘<code>Servlet</code>å®¹å™¨å¦å¤–ç”³è¯·ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼ˆå¯ä»¥æ˜¯ä»<code>Servlet</code>å®¹å™¨ä¸­å·²æœ‰çš„ä¸»çº¿ç¨‹æ± è·å–ï¼Œä¹Ÿå¯ä»¥å¦å¤–ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä¸åŒå®¹å™¨å®ç°å¯èƒ½ä¸ä¸€æ ·ï¼‰ï¼Œç„¶ååœ¨è¿™ä¸ªæ–°çš„çº¿ç¨‹ä¸­ç»§ç»­å¤„ç†è¯·æ±‚ï¼Œè€ŒåŸå…ˆçš„çº¿ç¨‹å°†è¢«å›æ”¶åˆ°ä¸»çº¿ç¨‹æ± ä¸­ã€‚<strong>äº‹å®ä¸Šï¼Œè¿™ç§æ–¹å¼å¯¹æ€§èƒ½çš„æ”¹è¿›ä¸å¤§ï¼Œå› ä¸ºå¦‚æœæ–°çš„çº¿ç¨‹å’Œåˆå§‹çº¿ç¨‹å…±äº«åŒä¸€ä¸ªçº¿ç¨‹æ± çš„è¯ï¼Œç›¸å½“äºé—²ç½®ä¸‹äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†åŒæ—¶åˆå ç”¨äº†å¦ä¸€ä¸ªçº¿ç¨‹ã€‚</strong></p>
<p>å½“ç„¶ï¼Œé™¤äº†è°ƒç”¨<code>AsyncContext</code>çš„<code>start()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼æ¥å®ç°å¼‚æ­¥å¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> davenkin.servlet;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.AsyncContext;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="meta">@WebServlet</span>(value = <span class="string">"/newThreadAsync"</span>, asyncSupported = <span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewThreadAsyncHelloServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line"></div><div class="line">        AsyncContext asyncContext = request.startAsync();</div><div class="line"></div><div class="line">        Runnable runnable = () -&gt; &#123;</div><div class="line">            <span class="keyword">new</span> LongRunningProcess().run();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                asyncContext.getResponse().getWriter().write(<span class="string">"Hello World!"</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            asyncContext.complete();</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        <span class="keyword">new</span> Thread(runnable).start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>è‡ªå·±æ‰‹åŠ¨åˆ›å»ºæ–°çº¿ç¨‹ä¸€èˆ¬æ˜¯ä¸è¢«é¼“åŠ±çš„ï¼Œå¹¶ä¸”æ­¤æ—¶çº¿ç¨‹ä¸èƒ½é‡ç”¨ã€‚å› æ­¤ï¼Œä¸€ç§æ›´å¥½çš„åŠæ³•æ˜¯æˆ‘ä»¬è‡ªå·±ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹æ± ã€‚è¿™ä¸ªçº¿ç¨‹æ± ä¸åŒäº<code>Servlet</code>å®¹å™¨çš„ä¸»çº¿ç¨‹æ± </strong>ï¼Œå¦‚ä¸‹å›¾ï¼š </p>
<p><img src="http://images2015.cnblogs.com/blog/341412/201703/341412-20170314155524776-1999546106.png" alt="img"> </p>
<p> åœ¨ä¸Šå›¾ä¸­ï¼Œç”¨æˆ·å‘èµ·çš„è¯·æ±‚é¦–å…ˆäº¤ç”±<code>Servlet</code>å®¹å™¨ä¸»çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¤„ç†ï¼Œåœ¨è¯¥çº¿ç¨‹ä¸­ï¼Œæˆ‘ä»¬è·å–åˆ°<code>AsyncContext</code>ï¼Œç„¶åå°†å…¶äº¤ç»™å¼‚æ­¥å¤„ç†çº¿ç¨‹æ± ã€‚å¯ä»¥é€šè¿‡<code>Java</code>æä¾›çš„<code>Executor</code>æ¡†æ¶æ¥åˆ›å»ºçº¿ç¨‹æ± ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> davenkin.servlet;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.AsyncContext;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="meta">@WebServlet</span>(value = <span class="string">"/threadPoolAsync"</span>, asyncSupported = <span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolAsyncHelloServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadPoolExecutor executor = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">100</span>, <span class="number">200</span>, <span class="number">50000L</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">100</span>));</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line"></div><div class="line">        AsyncContext asyncContext = request.startAsync();</div><div class="line"></div><div class="line">        executor.execute(() -&gt; &#123;</div><div class="line"></div><div class="line">            <span class="keyword">new</span> LongRunningProcess().run();</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                asyncContext.getResponse().getWriter().write(<span class="string">"Hello World!"</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            asyncContext.complete();</div><div class="line"></div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Servlet 3.0</code>å¯¹è¯·æ±‚çš„å¤„ç†è™½ç„¶æ˜¯å¼‚æ­¥çš„ï¼Œä½†æ˜¯å¯¹<code>InputStream</code>å’Œ<code>OutputStream</code>çš„IOæ“ä½œå´ä¾ç„¶æ˜¯é˜»å¡çš„ï¼Œå¯¹äºæ•°æ®é‡å¤§çš„è¯·æ±‚ä½“æˆ–è€…è¿”å›ä½“ï¼Œé˜»å¡IOä¹Ÿå°†å¯¼è‡´ä¸å¿…è¦çš„ç­‰å¾…ã€‚å› æ­¤åœ¨<code>Servlet 3.1</code>ä¸­å¼•å…¥äº†éé˜»å¡IOï¼Œé€šè¿‡åœ¨<code>HttpServletRequest</code>å’Œ<code>HttpServletResponse</code>ä¸­åˆ†åˆ«æ·»åŠ <code>ReadListener</code>å’Œ<code>WriterListener</code>æ–¹å¼ï¼Œåªæœ‰åœ¨IOæ•°æ®æ»¡è¶³ä¸€å®šæ¡ä»¶æ—¶ï¼ˆæ¯”å¦‚æ•°æ®å‡†å¤‡å¥½æ—¶ï¼‰ï¼Œæ‰è¿›è¡Œåç»­çš„æ“ä½œã€‚</p>
<p><img src="http://images2015.cnblogs.com/blog/341412/201703/341412-20170314164534432-1636480194.png" alt="img"></p>
<p>å¯¹åº”çš„ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> davenkin.servlet;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.AsyncContext;</div><div class="line"><span class="keyword">import</span> javax.servlet.ReadListener;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletInputStream;</div><div class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="meta">@WebServlet</span>(value = <span class="string">"/nonBlockingThreadPoolAsync"</span>, asyncSupported = <span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NonBlockingAsyncHelloServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadPoolExecutor executor = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">100</span>, <span class="number">200</span>, <span class="number">50000L</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">100</span>));</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line"></div><div class="line">        AsyncContext asyncContext = request.startAsync();</div><div class="line"></div><div class="line">        ServletInputStream inputStream = request.getInputStream();</div><div class="line"></div><div class="line">        inputStream.setReadListener(<span class="keyword">new</span> ReadListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataAvailable</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAllDataRead</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                executor.execute(() -&gt; &#123;</div><div class="line">                    <span class="keyword">new</span> LongRunningProcess().run();</div><div class="line"></div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        asyncContext.getResponse().getWriter().write(<span class="string">"Hello World!"</span>);</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    asyncContext.complete();</div><div class="line"></div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                asyncContext.complete();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ä¸Šä¾‹ä¸­ï¼Œä¸º<code>ServletInputStream</code>æ·»åŠ äº†ä¸€ä¸ª<code>ReadListener</code>ï¼Œå¹¶åœ¨<code>ReadListener</code>çš„<code>onAllDataRead()</code>æ–¹æ³•ä¸­å®Œæˆäº†é•¿æ—¶å¤„ç†è¿‡ç¨‹ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Spring MVC å¤„ç†å“åº”è¿”å›å€¼]]></title>
      <url>http://zsr.github.io/2017/05/08/Spring-MVC-%E5%93%8D%E5%BA%94%E8%BF%94%E5%9B%9E%E5%80%BC%E5%A4%84%E7%90%86/</url>
      <content type="html"><![CDATA[<p><code>HandlerMethodReturnValueHandler</code>æ˜¯<code>RequestMappingHandlerAdapter</code>ç”¨æ¥å¤„ç†å½“å«æœ‰<code>@RequestMapping</code>çš„æ–¹æ³•è°ƒåº¦å®Œæˆåï¼Œåé¢è¦è¿›è¡Œçš„äº‹æƒ…ã€‚<br>é¦–å…ˆæ˜¯<code>HandlerMethodReturnValueHandler</code>çš„è‡ªå®šä¹‰æ³¨å†Œï¼š </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span>  </div><div class="line">        <span class="tag">&lt;<span class="name">mvc:return-value-handlers</span>&gt;</span>  </div><div class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.mvc.method.annotation.ModelAndViewMethodReturnValueHandler"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </div><div class="line">        <span class="tag">&lt;/<span class="name">mvc:return-value-handlers</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></div></pre></td></tr></table></figure>
<p>åœ¨å¯åŠ¨<code>AnnotationDrivenBeanDefinitionParser</code>æ¥è§£æ<code>mvc:annotation-driven</code>æ ‡ç­¾çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ³¨å†Œæˆ‘ä»¬æ‰€é…ç½®çš„<code>HandlerMethodReturnValueHandler</code>ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ManagedList&lt;?&gt; returnValueHandlers = getReturnValueHandlers(element, parserContext);</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ManagedList&lt;?&gt; getReturnValueHandlers(Element element, ParserContext parserContext) &#123;  </div><div class="line">        Element handlersElement = DomUtils.getChildElementByTagName(element, <span class="string">"return-value-handlers"</span>);  </div><div class="line">        <span class="keyword">if</span> (handlersElement != <span class="keyword">null</span>) &#123;  </div><div class="line">            <span class="keyword">return</span> extractBeanSubElements(handlersElement, parserContext);  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><strong>ç„¶åå°†ä¼šè¿™äº›è‡ªå®šä¹‰çš„<code>HandlerMethodReturnValueHandler</code>è®¾ç½®åˆ°<code>RequestMappingHandlerAdapter</code>çš„<code>customReturnValueHandlers</code>å±æ€§ä¸­</strong></p>
<p><code>RequestMappingHandlerAdapter</code>çš„ä¸¤ä¸ªé‡è¦å±æ€§ï¼š </p>
<ul>
<li><code>customReturnValueHandlers</code>ï¼šå­˜æ”¾æˆ‘ä»¬è‡ªå®šä¹‰çš„<code>HandlerMethodReturnValueHandler</code></li>
<li><code>returnValueHandlers</code>ï¼šå­˜æ”¾æœ€ç»ˆæ‰€æœ‰çš„<code>HandlerMethodReturnValueHandler</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestMappingHandlerAdapter</span> <span class="keyword">extends</span> <span class="title">AbstractHandlerMethodAdapter</span>  </span></div><div class="line">        <span class="keyword">implements</span> <span class="title">BeanFactoryAware</span>, <span class="title">InitializingBean</span> &#123;  </div><div class="line">  </div><div class="line">    <span class="keyword">private</span> List&lt;HandlerMethodArgumentResolver&gt; customArgumentResolvers;  </div><div class="line">  </div><div class="line">    <span class="keyword">private</span> HandlerMethodArgumentResolverComposite argumentResolvers;  </div><div class="line">  </div><div class="line">    <span class="keyword">private</span> HandlerMethodArgumentResolverComposite initBinderArgumentResolvers;  </div><div class="line">    <span class="comment">//...</span></div><div class="line">    <span class="keyword">private</span> List&lt;HandlerMethodReturnValueHandler&gt; customReturnValueHandlers;  </div><div class="line">    <span class="comment">//...</span></div><div class="line">    <span class="keyword">private</span> HandlerMethodReturnValueHandlerComposite returnValueHandlers;</div></pre></td></tr></table></figure>
<p><code>returnValueHandlers</code>çš„å±æ€§ç±»å‹ä¸º<code>HandlerMethodReturnValueHandlerComposite</code>ï¼Œé‡Œé¢ä¹Ÿæœ‰ä¸€ä¸ªlisté›†åˆï¼Œæ¥å­˜æ”¾æ‰€æœ‰çš„<code>HandlerMethodReturnValueHandler</code>ã€‚ </p>
<a id="more"></a>
<p>é»˜è®¤çš„<code>returnValueHandlers</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;HandlerMethodReturnValueHandler&gt; <span class="title">getDefaultReturnValueHandlers</span><span class="params">()</span> </span>&#123;</div><div class="line">		List&lt;HandlerMethodReturnValueHandler&gt; handlers = <span class="keyword">new</span> ArrayList&lt;HandlerMethodReturnValueHandler&gt;();</div><div class="line"></div><div class="line">		<span class="comment">// Single-purpose return value types</span></div><div class="line">        <span class="comment">// è¿”å›å€¼ç±»å‹æ˜¯ModelAndViewæˆ–å…¶å­ç±»</span></div><div class="line">		handlers.add(<span class="keyword">new</span> ModelAndViewMethodReturnValueHandler());</div><div class="line">        <span class="comment">// è¿”å›å€¼ç±»å‹æ˜¯Modelæˆ–å…¶å­ç±»</span></div><div class="line">		handlers.add(<span class="keyword">new</span> ModelMethodProcessor());</div><div class="line">        <span class="comment">// è¿”å›å€¼ç±»å‹æ˜¯Viewæˆ–å…¶å­ç±» </span></div><div class="line">		handlers.add(<span class="keyword">new</span> ViewMethodReturnValueHandler());</div><div class="line">        <span class="comment">// ç”¨æ¥å¤„ç†è¿”å›å€¼ç±»å‹æ˜¯HttpEntityçš„æ–¹æ³•</span></div><div class="line">		handlers.add(<span class="keyword">new</span> HttpEntityMethodProcessor(getMessageConverters(), <span class="keyword">this</span>.contentNegotiationManager));</div><div class="line">		handlers.add(<span class="keyword">new</span> CallableMethodReturnValueHandler());</div><div class="line">		handlers.add(<span class="keyword">new</span> DeferredResultMethodReturnValueHandler());</div><div class="line">		handlers.add(<span class="keyword">new</span> AsyncTaskMethodReturnValueHandler(<span class="keyword">this</span>.beanFactory));</div><div class="line"></div><div class="line">		<span class="comment">// Annotation-based return value types</span></div><div class="line">        <span class="comment">// è¿”å›å€¼æœ‰@ModelAttributeæ³¨è§£</span></div><div class="line">		handlers.add(<span class="keyword">new</span> ModelAttributeMethodProcessor(<span class="keyword">false</span>));</div><div class="line">		handlers.add(<span class="keyword">new</span> RequestResponseBodyMethodProcessor(getMessageConverters(), <span class="keyword">this</span>.contentNegotiationManager));</div><div class="line"></div><div class="line">		<span class="comment">// Multi-purpose return value types</span></div><div class="line">        <span class="comment">// è¿”å›å€¼æ˜¯voidæˆ–String, å°†è¿”å›çš„å­—ç¬¦ä¸²ä½œä¸ºviewè§†å›¾çš„åå­—</span></div><div class="line">		handlers.add(<span class="keyword">new</span> ViewNameMethodReturnValueHandler());</div><div class="line">		handlers.add(<span class="keyword">new</span> MapMethodProcessor());</div><div class="line"></div><div class="line">		<span class="comment">// Custom return value types</span></div><div class="line">        <span class="comment">//è¿™é‡Œè¿™é‡Œä¼šä»customReturnValueHandlerså±æ€§ä¸­è·å–æˆ‘ä»¬è‡ªå®šçš„HandlerMethodReturnValueHandler  </span></div><div class="line">		<span class="keyword">if</span> (getCustomReturnValueHandlers() != <span class="keyword">null</span>) &#123;</div><div class="line">			handlers.addAll(getCustomReturnValueHandlers());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Catch-all</span></div><div class="line">		<span class="keyword">if</span> (!CollectionUtils.isEmpty(getModelAndViewResolvers())) &#123;</div><div class="line">			handlers.add(<span class="keyword">new</span> ModelAndViewResolverMethodReturnValueHandler(getModelAndViewResolvers()));</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			handlers.add(<span class="keyword">new</span> ModelAttributeMethodProcessor(<span class="keyword">true</span>));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> handlers;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p><strong>ä½¿ç”¨<code>@ResponseBody</code>æ³¨è§£çš„è¯æœ€ç»ˆè¿”å›å€¼ä¼šè¢«<code>RequestResponseBodyMethodProcessor</code>è¿™ä¸ª<code>HandlerMethodReturnValueHandler</code>å®ç°ç±»å¤„ç†ã€‚</strong></p>
<p>è‡³æ­¤ï¼Œæ‰€æœ‰çš„<code>HandlerMethodReturnValueHandler</code>çš„æ³¨å†Œå·²ç»å®Œæˆã€‚</p>
<h3 id="æ‰§è¡Œæµç¨‹"><a href="#æ‰§è¡Œæµç¨‹" class="headerlink" title="æ‰§è¡Œæµç¨‹"></a>æ‰§è¡Œæµç¨‹</h3><ul>
<li>ç¬¬ä¸€æ­¥ï¼šè·å–åˆé€‚çš„HandlerAdapterï¼Œå½“æ–¹æ³•å«æœ‰@RequestMappingæ³¨é‡Šçš„æ—¶å€™ï¼Œä¾¿é€‰æ‹©RequestMappingHandlerAdapteræ¥è¿›è¡Œæ–¹æ³•çš„è°ƒåº¦å¤„ç† </li>
<li>ç¬¬äºŒæ­¥ï¼šæ–¹æ³•çš„è°ƒåº¦å¤„ç†è¿‡ç¨‹ä¸ºï¼šé¦–å…ˆæ‰§è¡Œæ–¹æ³•ä½“ï¼Œç„¶åæ ¹æ®è¿”å›å€¼æ¥é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„HandlerMethodReturnValueHandlerï¼Œå¦‚ä¸‹ä»£ç ï¼š </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">// RequestMappingHandlerAdapterç±»</span></div><div class="line">  <span class="comment">/**</span></div><div class="line"> * Invoke the &#123;<span class="doctag">@link</span> RequestMapping&#125; handler method preparing a &#123;<span class="doctag">@link</span> ModelAndView&#125;</div><div class="line"> * if view resolution is required.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> ModelAndView <span class="title">invokeHandleMethod</span><span class="params">(HttpServletRequest request,</span></span></div><div class="line">		HttpServletResponse response, HandlerMethod handlerMethod) <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">	ServletWebRequest webRequest = <span class="keyword">new</span> ServletWebRequest(request, response);</div><div class="line"></div><div class="line">	WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);</div><div class="line">	ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);</div><div class="line">    <span class="comment">// åˆ›å»º ServletInvocableHandlerMethod ï¼ˆHandlerMethod çš„å­ç±»ï¼‰ï¼Œå¹¶ç»‘å®šç›¸å…³å±æ€§	</span></div><div class="line">       ServletInvocableHandlerMethod requestMappingMethod = createRequestMappingMethod(handlerMethod, binderFactory);</div><div class="line"></div><div class="line">	ModelAndViewContainer mavContainer = <span class="keyword">new</span> ModelAndViewContainer();</div><div class="line">	mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));</div><div class="line">	modelFactory.initModel(webRequest, mavContainer, requestMappingMethod);</div><div class="line">	mavContainer.setIgnoreDefaultModelOnRedirect(<span class="keyword">this</span>.ignoreDefaultModelOnRedirect);</div><div class="line"></div><div class="line">	AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);</div><div class="line">	asyncWebRequest.setTimeout(<span class="keyword">this</span>.asyncRequestTimeout);</div><div class="line"></div><div class="line">	<span class="keyword">final</span> WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</div><div class="line">	asyncManager.setTaskExecutor(<span class="keyword">this</span>.taskExecutor);</div><div class="line">	asyncManager.setAsyncWebRequest(asyncWebRequest);</div><div class="line">	asyncManager.registerCallableInterceptors(<span class="keyword">this</span>.callableInterceptors);</div><div class="line">	asyncManager.registerDeferredResultInterceptors(<span class="keyword">this</span>.deferredResultInterceptors);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (asyncManager.hasConcurrentResult()) &#123;</div><div class="line">		Object result = asyncManager.getConcurrentResult();</div><div class="line">		mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[<span class="number">0</span>];</div><div class="line">		asyncManager.clearConcurrentResult();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">			logger.debug(<span class="string">"Found concurrent result value ["</span> + result + <span class="string">"]"</span>);</div><div class="line">		&#125;</div><div class="line">		requestMappingMethod = requestMappingMethod.wrapConcurrentResult(result);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">       <span class="comment">// æ‰§è¡Œå¤„ç†å™¨çš„æ–¹æ³•, é‡ç‚¹ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚(çœ‹ä¸‹é¢)</span></div><div class="line">	requestMappingMethod.invokeAndHandle(webRequest, mavContainer);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">       <span class="comment">// è¿”å› ModelAndView, é‡ç‚¹ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</span></div><div class="line">	<span class="keyword">return</span> getModelAndView(mavContainer, modelFactory, webRequest);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ServletInvocableHandlerMethodç±»(HandlerMethod çš„å­ç±»)</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invokeAndHandle</span><span class="params">(ServletWebRequest webRequest,  </span></span></div><div class="line">            ModelAndViewContainer mavContainer, Object... providedArgs) <span class="keyword">throws</span> Exception &#123;  </div><div class="line">        <span class="comment">// æ‰§è¡Œè¯¥è¯·æ±‚å¤„ç†æ–¹æ³•(åŒ…å«äº†è·å–è¯¥è¯·æ±‚å¤„ç†æ–¹æ³•å‚æ•°å€¼)ï¼Œå–å¾—è¿”å›å€¼</span></div><div class="line">        Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);  </div><div class="line">  </div><div class="line">        setResponseStatus(webRequest);  </div><div class="line">  </div><div class="line">        <span class="keyword">if</span> (returnValue == <span class="keyword">null</span>) &#123;  </div><div class="line">            <span class="keyword">if</span> (isRequestNotModified(webRequest) || hasResponseStatus() || mavContainer.isRequestHandled()) &#123;  </div><div class="line">                mavContainer.setRequestHandled(<span class="keyword">true</span>);  </div><div class="line">                <span class="keyword">return</span>;  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.responseReason)) &#123;  </div><div class="line">            mavContainer.setRequestHandled(<span class="keyword">true</span>);  </div><div class="line">            <span class="keyword">return</span>;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        mavContainer.setRequestHandled(<span class="keyword">false</span>);  </div><div class="line">        </div><div class="line">        <span class="keyword">try</span> &#123;  </div><div class="line">            <span class="comment">// é‡ç‚¹ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</span></div><div class="line">            <span class="keyword">this</span>.returnValueHandlers.handleReturnValue(returnValue, getReturnValueType(returnValue), mavContainer, webRequest);  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">catch</span> (Exception ex) &#123;  </div><div class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;  </div><div class="line">                logger.trace(getReturnValueHandlingErrorMessage(<span class="string">"Error handling return value"</span>, returnValue), ex);  </div><div class="line">            &#125;  </div><div class="line">            <span class="keyword">throw</span> ex;  </div><div class="line">        &#125;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><code>this.returnValueHandlers.handleReturnValue(returnValue, getReturnValueType(returnValue), mavContainer, webRequest)</code>ä¼šéå†æ‰€æœ‰çš„å·²æ³¨å†Œçš„<code>HandlerMethodReturnValueHandler</code>åˆ¤æ–­ä»–ä»¬æ”¯ä¸æ”¯æŒ<code>returnValue</code>çš„è¿”å›ç±»å‹ã€‚å¦‚ä¸‹ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HandlerMethodReturnValueHandlerCompositeç±»(åŒ…å«äº†æ‰€æœ‰çš„HandlerMethodReturnValueHandler)</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(  </span></span></div><div class="line">            Object returnValue, MethodParameter returnType,  </div><div class="line">            ModelAndViewContainer mavContainer, NativeWebRequest webRequest)  </div><div class="line">            <span class="keyword">throws</span> Exception &#123;  </div><div class="line">  </div><div class="line">        HandlerMethodReturnValueHandler handler = getReturnValueHandler(returnType);  </div><div class="line">        Assert.notNull(handler, <span class="string">"Unknown return value type ["</span> + returnType.getParameterType().getName() + <span class="string">"]"</span>);  </div><div class="line">        handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">/** </span></div><div class="line">     * Find a registered &#123;<span class="doctag">@link</span> HandlerMethodReturnValueHandler&#125; that supports the given return type. </div><div class="line">     */  </div><div class="line">    <span class="function"><span class="keyword">private</span> HandlerMethodReturnValueHandler <span class="title">getReturnValueHandler</span><span class="params">(MethodParameter returnType)</span> </span>&#123;  </div><div class="line">        <span class="keyword">for</span> (HandlerMethodReturnValueHandler returnValueHandler : returnValueHandlers) &#123;  </div><div class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;  </div><div class="line">                logger.trace(<span class="string">"Testing if return value handler ["</span> + returnValueHandler + <span class="string">"] supports ["</span> +  </div><div class="line">                        returnType.getGenericParameterType() + <span class="string">"]"</span>);  </div><div class="line">            &#125;  </div><div class="line">            <span class="keyword">if</span> (returnValueHandler.supportsReturnType(returnType)) &#123;  </div><div class="line">                <span class="keyword">return</span> returnValueHandler;  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æ‰¾åˆ°æ”¯æŒçš„<code>HandlerMethodReturnValueHandler</code>åï¼Œå°±è¦æ‰§è¡Œå®ƒçš„<code>handleReturnValue</code>æ–¹æ³•ã€‚å‡è®¾ä½¿ç”¨äº†ï½€<code>@ResponseBody</code>æ³¨è§£ï¼Œåˆ™ç”±<code>RequestResponseBodyMethodProcessor</code>ç±»å¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType,</span></span></div><div class="line">			ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</div><div class="line">			<span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException &#123;</div><div class="line"></div><div class="line">		mavContainer.setRequestHandled(<span class="keyword">true</span>);</div><div class="line">		<span class="keyword">if</span> (returnValue != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// ç”±è¿™é‡Œå¤„ç†è¿”å›ï¼Œæ¶‰åŠåˆ°HttpMessageConverterå¤„ç†</span></div><div class="line">			writeWithMessageConverters(returnValue, returnType, webRequest);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„è¿™é‡Œè®¾ç½®<code>mavContainer.setRequestHandled(true)</code>ï¼Œè¡¨ç¤ºè¯·æ±‚å·²è¢«å¤„ç†ï¼Œä¸éœ€è¦è¿”å›<code>ModelAndView</code>ã€‚çœ‹ä»£ç ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"># RequestMappingHandlerAdapter</div><div class="line">private ModelAndView getModelAndView(ModelAndViewContainer mavContainer,</div><div class="line">			ModelFactory modelFactory, NativeWebRequest webRequest) throws Exception &#123;</div><div class="line"></div><div class="line">		modelFactory.updateModel(webRequest, mavContainer);</div><div class="line">        // å¦‚æœisRequestHandled()ä¸ºtrueï¼Œä¸éœ€è¦å†åšå¤„ç†</div><div class="line">		if (mavContainer.isRequestHandled()) &#123;</div><div class="line">			return null;</div><div class="line">		&#125;</div><div class="line">		ModelMap model = mavContainer.getModel();</div><div class="line">		ModelAndView mav = new ModelAndView(mavContainer.getViewName(), model);</div><div class="line">		if (!mavContainer.isViewReference()) &#123;</div><div class="line">			mav.setView((View) mavContainer.getView());</div><div class="line">		&#125;</div><div class="line">		if (model instanceof RedirectAttributes) &#123;</div><div class="line">			Map&lt;String, ?&gt; flashAttributes = ((RedirectAttributes) model).getFlashAttributes();</div><div class="line">			HttpServletRequest request = webRequest.getNativeRequest(HttpServletRequest.class);</div><div class="line">			RequestContextUtils.getOutputFlashMap(request).putAll(flashAttributes);</div><div class="line">		&#125;</div><div class="line">		return mav;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Spring MVC åº”ç”¨ä¸Šä¸‹æ–‡]]></title>
      <url>http://zsr.github.io/2017/05/08/Spring-MVC-%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87/</url>
      <content type="html"><![CDATA[<p>å…ˆçœ‹ä¸Šæ–‡ï¼š<a href="https://zsr.github.io/2016/08/16/ApplicationContext/">Spring MVC ApplicationContext</a></p>
<h3 id="ServletContext"><a href="#ServletContext" class="headerlink" title="ServletContext"></a>ServletContext</h3><p><code>javaee</code>æ ‡å‡†è§„å®šäº†ï¼Œ<code>servlet</code>å®¹å™¨éœ€è¦åœ¨åº”ç”¨é¡¹ç›®å¯åŠ¨æ—¶ï¼Œç»™åº”ç”¨é¡¹ç›®åˆå§‹åŒ–ä¸€ä¸ª<code>ServletContext</code>ä½œä¸ºå…¬å…±ç¯å¢ƒå®¹å™¨å­˜æ”¾å…¬å…±ä¿¡æ¯ã€‚<code>ServletContext</code>ä¸­çš„ä¿¡æ¯éƒ½æ˜¯ç”±å®¹å™¨æä¾›çš„ã€‚</p>
<h4 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h4><p>é€šè¿‡è‡ªå®šä¹‰<code>contextListener</code>è·å–<code>web.xml</code>ä¸­é…ç½®çš„å‚æ•°</p>
<ol>
<li>å®¹å™¨å¯åŠ¨æ—¶ï¼Œæ‰¾åˆ°é…ç½®æ–‡ä»¶ä¸­çš„<code>context-param</code>ä½œä¸ºé”®å€¼å¯¹æ”¾åˆ°<code>ServletContext</code>ä¸­</li>
<li>ç„¶åæ‰¾åˆ°<code>listener</code>ï¼Œå®¹å™¨è°ƒç”¨å®ƒçš„<code>contextInitialized(ServletContextEvent event)</code>æ–¹æ³•ï¼Œæ‰§è¡Œå…¶ä¸­çš„æ“ä½œ</li>
</ol>
<p>ä¾‹å¦‚ï¼šåœ¨web.xmlä¸­é…ç½®</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>key<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span> </div><div class="line">   <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>com.zsr.contextlistener.listener.ContextListenerTest<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div></pre></td></tr></table></figure>
<p>é…ç½®å¥½ä¹‹åï¼Œåœ¨è¯¥ç±»ä¸­è·å–å¯¹åº”çš„å‚æ•°ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.contextlistener.listener;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.ServletContext;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletContextEvent;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletContextListener;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextListenerTest</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent event)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"*************destroy ContextListener*************"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent event)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"*************init ContextListener*************"</span>);</div><div class="line">        ServletContext servletContext = event.getServletContext();</div><div class="line">        System.out.println(<span class="string">"key:"</span>+servletContext.getInitParameter(<span class="string">"key"</span>));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="æ‰§è¡Œæµç¨‹"><a href="#æ‰§è¡Œæµç¨‹" class="headerlink" title="æ‰§è¡Œæµç¨‹"></a>æ‰§è¡Œæµç¨‹</h4><p>ã€€ã€€<strong><code>web.xml</code>åœ¨<code>&lt;context-param&gt;&lt;/context-param&gt;</code>æ ‡ç­¾ä¸­å£°æ˜<code>åº”ç”¨èŒƒå›´å†…</code>çš„åˆå§‹åŒ–å‚æ•°</strong></p>
<ol>
<li>å¯åŠ¨ä¸€ä¸ªWEBé¡¹ç›®çš„æ—¶å€™,å®¹å™¨(å¦‚:<code>Tomcat</code>)ä¼šå»è¯»å®ƒçš„é…ç½®æ–‡ä»¶<code>web.xml</code>.è¯»ä¸¤ä¸ªèŠ‚ç‚¹: <code>&lt;listener&gt;&lt;/listener&gt;</code>å’Œ <code>&lt;context-param&gt;&lt;/context-param&gt;</code></li>
<li>ç´§æ¥ç€,å®¹å™¨åˆ›å»ºä¸€ä¸ª<code>ServletContext</code>(ä¸Šä¸‹æ–‡)ã€‚åœ¨è¯¥åº”ç”¨å†…å…¨å±€å…±äº«ã€‚</li>
<li>å®¹å™¨å°†<code>&lt;context-param&gt;&lt;/context-param&gt;</code>è½¬åŒ–ä¸ºé”®å€¼å¯¹,å¹¶äº¤ç»™<code>ServletContext</code>.</li>
<li>å®¹å™¨åˆ›å»º<code>&lt;listener&gt;&lt;/listener&gt;</code>ä¸­çš„ç±»å®ä¾‹,å³åˆ›å»ºç›‘å¬.è¯¥ç›‘å¬å™¨å¿…é¡»å®ç°è‡ª<strong><code>ServletContextListener</code></strong>æ¥å£</li>
<li>åœ¨ç›‘å¬ä¸­ä¼šæœ‰<code>contextInitialized(ServletContextEvent event)</code>åˆå§‹åŒ–æ–¹æ³•</li>
<li>å¾—åˆ°è¿™ä¸ª<code>context-param</code>çš„å€¼ä¹‹å,ä½ å°±å¯ä»¥åšä¸€äº›æ“ä½œäº†.æ³¨æ„,è¿™ä¸ªæ—¶å€™ä½ çš„WEBé¡¹ç›®è¿˜æ²¡æœ‰å®Œå…¨å¯åŠ¨å®Œæˆ.è¿™ä¸ªåŠ¨ä½œä¼šæ¯”æ‰€æœ‰çš„Servletéƒ½è¦æ—©.æ¢å¥è¯è¯´,è¿™ä¸ªæ—¶å€™,<strong>å¯¹<code>&lt;context-param&gt;</code>ä¸­çš„é”®å€¼åšçš„æ“ä½œ,å°†åœ¨ä½ çš„WEBé¡¹ç›®å®Œå…¨å¯åŠ¨ä¹‹å‰è¢«æ‰§è¡Œ</strong>.</li>
</ol>
<p><code>web.xml</code>ä¸­å¯ä»¥å®šä¹‰ä¸¤ç§å‚æ•°ï¼š</p>
<ul>
<li>å…¨å±€å‚æ•°(<code>ServletContext</code>)ï¼Œé€šè¿‡<code>&lt;context-param&gt;</code>å£°æ˜</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>key<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></div></pre></td></tr></table></figure>
<p> å‚æ•°åœ¨<code>servlet</code>é‡Œé¢å¯ä»¥é€šè¿‡<code>getServletContext().getInitParameter(&quot;key&quot;)</code>å¾—åˆ°</p>
<ul>
<li><p><code>servlet</code>å‚æ•°ï¼Œé€šè¿‡åœ¨<code>servlet</code>ä¸­å£°æ˜    ã€€ã€€ </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>param1<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>avalible in servlet init()<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>   </div><div class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>å‚æ•°åªèƒ½åœ¨<code>servlet</code>çš„<code>init()</code>æ–¹æ³•ä¸­é€šè¿‡<code>this.getInitParameter(&quot;param1&quot;)</code>å–å¾—</p>
<h3 id="Springä¸Šä¸‹æ–‡å®¹å™¨é…ç½®"><a href="#Springä¸Šä¸‹æ–‡å®¹å™¨é…ç½®" class="headerlink" title="Springä¸Šä¸‹æ–‡å®¹å™¨é…ç½®"></a>Springä¸Šä¸‹æ–‡å®¹å™¨é…ç½®</h3><p>ã€€Springæä¾›äº†å®ç°<code>ServletContextListener</code>æ¥å£çš„ä¸Šä¸‹æ–‡åˆå§‹åŒ–ç›‘å¬å™¨ï¼š<code>org.springframework.web.context.ContextLoaderListener</code></p>
<p>   Springä¸ºæˆ‘ä»¬æä¾›çš„IOCå®¹å™¨ï¼Œéœ€è¦æˆ‘ä»¬æŒ‡å®šå®¹å™¨çš„é…ç½®æ–‡ä»¶ï¼Œç„¶åç”±è¯¥ç›‘å¬å™¨åˆå§‹åŒ–å¹¶åˆ›å»ºè¯¥å®¹å™¨ã€‚è¦æ±‚ä½ æŒ‡å®šé…ç½®æ–‡ä»¶çš„åœ°å€åŠæ–‡ä»¶åç§°ï¼Œä¸€å®šè¦ä½¿ç”¨ï¼š<code>contextConfigLocation</code>ä½œä¸ºå‚æ•°åç§°ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:web-context.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div></pre></td></tr></table></figure>
<p>è¯¥ç›‘å¬å™¨ï¼Œé»˜è®¤è¯»å–<code>/WEB-INF/</code>ä¸‹çš„<code>web-context.xml</code>æ–‡ä»¶ã€‚ä½†æ˜¯é€šè¿‡<code>context-param</code>æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„åï¼Œä¾¿ä¼šå»ä½ æŒ‡å®šçš„è·¯å¾„ä¸‹è¯»å–å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œå¹¶è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<h4 id="æ‰§è¡Œæµç¨‹-1"><a href="#æ‰§è¡Œæµç¨‹-1" class="headerlink" title="æ‰§è¡Œæµç¨‹"></a>æ‰§è¡Œæµç¨‹</h4><p><code>ServletContext</code>æ˜¯ç”±<code>Servlet</code>å®¹å™¨åˆå§‹åŒ–çš„ï¼Œé‚£Springçš„<code>ContextLoaderListener</code>åˆåšäº†ä»€ä¹ˆåˆå§‹åŒ–å‘¢ï¼Ÿ</p>
<ol>
<li><code>servlet</code>å®¹å™¨å¯åŠ¨ï¼Œä¸ºåº”ç”¨åˆ›å»ºä¸€ä¸ªâ€œå…¨å±€ä¸Šä¸‹æ–‡ç¯å¢ƒâ€ï¼š<code>ServletContext</code></li>
<li>å®¹å™¨è°ƒç”¨<code>web.xml</code>ä¸­é…ç½®çš„<code>contextLoaderListener</code>ï¼Œåˆå§‹åŒ–<code>WebApplicationContext</code>ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ˆå³IOCå®¹å™¨ï¼‰ï¼ŒåŠ è½½<code>context-param</code>æŒ‡å®šçš„é…ç½®æ–‡ä»¶ä¿¡æ¯åˆ°IOCå®¹å™¨ä¸­ã€‚<code>WebApplicationContext</code>åœ¨<code>ServletContext</code>ä¸­ä»¥é”®å€¼å¯¹çš„å½¢å¼ä¿å­˜</li>
<li>å®¹å™¨åˆå§‹åŒ–<code>web.xml</code>ä¸­é…ç½®çš„<code>servlet</code>ï¼Œä¸ºå…¶åˆå§‹åŒ–è‡ªå·±çš„ä¸Šä¸‹æ–‡ä¿¡æ¯<code>servletContext</code>ï¼Œå¹¶åŠ è½½å…¶è®¾ç½®çš„é…ç½®ä¿¡æ¯åˆ°è¯¥ä¸Šä¸‹æ–‡ä¸­ã€‚<strong>å°†WebApplicationContextè®¾ç½®ä¸ºå®ƒçš„çˆ¶å®¹å™¨ã€‚</strong></li>
<li><p>æ­¤åçš„æ‰€æœ‰<code>servlet</code>çš„åˆå§‹åŒ–éƒ½æŒ‰ç…§3æ­¥ä¸­æ–¹å¼åˆ›å»ºï¼Œåˆå§‹åŒ–è‡ªå·±çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå°†<code>WebApplicationContext</code>è®¾ç½®ä¸ºè‡ªå·±çš„çˆ¶ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚</p>
<p><img src="http://images.cnitblog.com/blog/698747/201502/011528042224276.png" alt="img"></p>
</li>
</ol>
<p>â€‹       <strong>å¯¹äºä½œç”¨èŒƒå›´è€Œè¨€ï¼Œåœ¨<code>DispatcherServlet</code>ä¸­å¯ä»¥å¼•ç”¨ç”±<code>ContextLoaderListener</code>æ‰€åˆ›å»ºçš„<code>ApplicationContext</code>ä¸­çš„å†…å®¹ï¼Œè€Œåè¿‡æ¥ä¸è¡Œã€‚</strong></p>
<p>â€‹       å½“Springåœ¨æ‰§è¡Œ<code>ApplicationContext</code>çš„<code>getBean(BeanName)</code>æ—¶ï¼Œå¦‚æœåœ¨è‡ªå·±<code>context</code>ä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„beanï¼Œåˆ™ä¼šåœ¨çˆ¶<code>ApplicationContext</code>ä¸­å»æ‰¾ã€‚è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨<code>DispatcherServlet</code>ä¸­è·å–åˆ°ç”±<code>ContextLoaderListener</code>å¯¹åº”çš„<code>ApplicationContextä¸­çš„bean</code>ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.cnblogs.com/brolanda/p/4265597.html" target="_blank" rel="external">Spring-MVCç†è§£ä¹‹ä¸€ï¼šåº”ç”¨ä¸Šä¸‹æ–‡webApplicationContext</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[init-methodã€@PostConstructã€afterPropertiesSetå­°å…ˆå­°å]]></title>
      <url>http://zsr.github.io/2017/05/08/Spring-bean-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%BA%E5%BA%8F/</url>
      <content type="html"><![CDATA[<p>Spring å…è®¸åœ¨ Bean åœ¨åˆå§‹åŒ–å®Œæˆåä»¥åŠ Bean é”€æ¯å‰æ‰§è¡Œç‰¹å®šçš„æ“ä½œï¼Œå¸¸ç”¨çš„è®¾å®šæ–¹å¼æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</p>
<ul>
<li>é€šè¿‡å®ç° <code>InitializingBean/DisposableBean</code> æ¥å£æ¥å®šåˆ¶åˆå§‹åŒ–ä¹‹å/é”€æ¯ä¹‹å‰çš„æ“ä½œæ–¹æ³•ï¼›</li>
<li>é€šè¿‡<code>&lt;bean&gt;</code> å…ƒç´ çš„<code>init-method/destroy-method</code>å±æ€§æŒ‡å®šåˆå§‹åŒ–ä¹‹å /é”€æ¯ä¹‹å‰è°ƒç”¨çš„æ“ä½œæ–¹æ³•ï¼›</li>
<li>åœ¨æŒ‡å®šæ–¹æ³•ä¸ŠåŠ ä¸Š<code>@PostConstruct/@PreDestroy</code>æ³¨è§£æ¥åˆ¶å®šè¯¥æ–¹æ³•æ˜¯åœ¨åˆå§‹åŒ–ä¹‹åè¿˜æ˜¯é”€æ¯ä¹‹å‰è°ƒç”¨ã€‚ </li>
</ul>
<p>è¿™ä¸‰ç§æ–¹å¼æ˜¯å®Œå…¨ç­‰åŒçš„å—ï¼Œå­°å…ˆå­°åï¼Ÿ</p>
<h3 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h3><p>ç¼–å†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitSequenceBean</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;  </div><div class="line">   </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InitSequenceBean</span><span class="params">()</span> </span>&#123;  </div><div class="line">       System.out.println(<span class="string">"InitSequenceBean: constructor"</span>);  </div><div class="line">    &#125;  </div><div class="line">     </div><div class="line">    <span class="meta">@PostConstruct</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postConstruct</span><span class="params">()</span> </span>&#123;  </div><div class="line">       System.out.println(<span class="string">"InitSequenceBean: postConstruct"</span>);  </div><div class="line">    &#125;  </div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initMethod</span><span class="params">()</span> </span>&#123;  </div><div class="line">       System.out.println(<span class="string">"InitSequenceBean: init-method"</span>);  </div><div class="line">    &#125;  </div><div class="line">     </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">       System.out.println(<span class="string">"InitSequenceBean: afterPropertiesSet"</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¹¶ä¸”åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹Beanå®šä¹‰ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"InitSequenceBean"</span> <span class="attr">init-method</span>=<span class="string">"initMethod"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<p>å¯åŠ¨Springå®¹å™¨ï¼Œè§‚å¯Ÿè¾“å‡ºç»“æœï¼Œå°±å¯çŸ¥é“ä¸‰è€…çš„å…ˆåé¡ºåºäº†ï¼š</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">InitSequenceBean: constructor</div><div class="line">InitSequenceBean: postConstruct</div><div class="line">InitSequenceBean: afterPropertiesSet</div><div class="line">InitSequenceBean: init-method</div></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸Šè¿°è¾“å‡ºç»“æœï¼Œä¸‰è€…çš„å…ˆåé¡ºåºä¹Ÿå°±ä¸€ç›®äº†ç„¶äº†ï¼š</p>
<p><strong><code>Constructor</code> &gt; <code>@PostConstruct</code> &gt; <code>InitializingBean</code> &gt; <code>init-method</code></strong></p>
<p><code>PostConstruct</code>ä¸ºä½•ç‡å…ˆäº<code>InitializingBean</code>æ‰§è¡Œå‘¢ï¼Ÿ</p>
<h3 id="CommonAnnotationBeanPostProcessor"><a href="#CommonAnnotationBeanPostProcessor" class="headerlink" title="CommonAnnotationBeanPostProcessor"></a>CommonAnnotationBeanPostProcessor</h3><p>é€šè¿‡Debugå¹¶æŸ¥çœ‹è°ƒç”¨æ ˆï¼Œå‘ç°äº†è¿™ä¸ªç±»<code>org.springframework.context.annotation.CommonAnnotationBeanPostProcessor</code>ï¼Œä»å‘½åä¸Šï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°æŸäº›ä¿¡æ¯â€”è¿™æ˜¯ä¸€ä¸ª<code>BeanPostProcessor</code>ã€‚<code>BeanPostProcessor</code>çš„<code>postProcessBeforeInitialization</code>æ˜¯åœ¨Beanç”Ÿå‘½å‘¨æœŸä¸­<code>afterPropertiesSet</code>å’Œ<code>init-method</code>ä¹‹å‰æ‰§è¢«è°ƒç”¨çš„ã€‚ </p>
<p><code>CommonAnnotationBeanPostProcessor</code>è¿™ä¸ªç±»ï¼Œç»§æ‰¿è‡ª<code>InitDestroyAnnotationBeanPostProcessor</code>ã€‚<code>InitDestroyAnnotationBeanPostProcessor</code>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åœ¨Beanåˆå§‹åŒ–å’Œé”€æ¯çš„æ—¶å€™æ‰€ä½œçš„ä¸€ä¸ªå‰ç½®/åç½®å¤„ç†å™¨ã€‚</p>
<p>æŸ¥çœ‹<code>InitDestroyAnnotationBeanPostProcessor</code>ç±»ä¸‹çš„<code>postProcessBeforeInitialization</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;  </div><div class="line">       LifecycleMetadata metadata = findLifecycleMetadata(bean.getClass());  </div><div class="line">       <span class="keyword">try</span> &#123;  </div><div class="line">           metadata.invokeInitMethods(bean, beanName);  </div><div class="line">       &#125;  </div><div class="line">       <span class="keyword">catch</span> (InvocationTargetException ex) &#123;  </div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName, <span class="string">"Invocation of init method failed"</span>, ex.getTargetException());  </div><div class="line">       &#125;  </div><div class="line">       <span class="keyword">catch</span> (Throwable ex) &#123;  </div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName, <span class="string">"Couldn't invoke init method"</span>, ex);  </div><div class="line">       &#125;  </div><div class="line">        <span class="keyword">return</span> bean;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æŸ¥çœ‹<code>findLifecycleMetadata</code>æ–¹æ³•ï¼Œç»§è€Œæˆ‘ä»¬è·Ÿè¸ªåˆ°<code>buildLifecycleMetadata</code>è¿™ä¸ªæ–¹æ³•ä½“ä¸­ï¼Œçœ‹ä¸‹<code>buildLifecycleMetadata</code>è¿™ä¸ªæ–¹æ³•ä½“çš„å†…å®¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> LifecycleMetadata <span class="title">buildLifecycleMetadata</span><span class="params">(<span class="keyword">final</span> Class clazz)</span> </span>&#123;  </div><div class="line">       <span class="keyword">final</span> LifecycleMetadata newMetadata = <span class="keyword">new</span> LifecycleMetadata();  </div><div class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> debug = logger.isDebugEnabled();  </div><div class="line">       ReflectionUtils.doWithMethods(clazz, <span class="keyword">new</span> ReflectionUtils.MethodCallback() &#123;  </div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWith</span><span class="params">(Method method)</span> </span>&#123;  </div><div class="line">              <span class="keyword">if</span> (initAnnotationType != <span class="keyword">null</span>) &#123;  </div><div class="line">                  <span class="keyword">if</span> (method.getAnnotation(initAnnotationType) != <span class="keyword">null</span>) &#123;  </div><div class="line">                     newMetadata.addInitMethod(method);  </div><div class="line">                     <span class="keyword">if</span> (debug) &#123;  </div><div class="line">                         logger.debug(<span class="string">"Found init method on class ["</span> + clazz.getName() + <span class="string">"]: "</span> + method);  </div><div class="line">                     &#125;  </div><div class="line">                  &#125;  </div><div class="line">              &#125;  </div><div class="line">              <span class="keyword">if</span> (destroyAnnotationType != <span class="keyword">null</span>) &#123;  </div><div class="line">                  <span class="keyword">if</span> (method.getAnnotation(destroyAnnotationType) != <span class="keyword">null</span>) &#123;  </div><div class="line">                     newMetadata.addDestroyMethod(method);  </div><div class="line">                     <span class="keyword">if</span> (debug) &#123;  </div><div class="line">                         logger.debug(<span class="string">"Found destroy method on class ["</span> + clazz.getName() + <span class="string">"]: "</span> + method);  </div><div class="line">                     &#125;  </div><div class="line">                  &#125;  </div><div class="line">              &#125;  </div><div class="line">           &#125;  </div><div class="line">       &#125;);  </div><div class="line">       <span class="keyword">return</span> newMetadata;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œä¼šå»åˆ¤æ–­æŸæ–¹æ³•æœ‰æ²¡æœ‰è¢«<code>initAnnotationType/destroyAnnotationType</code>æ³¨é‡Šï¼Œå¦‚æœæœ‰ï¼Œåˆ™æ·»åŠ åˆ°init/destroyé˜Ÿåˆ—ä¸­ï¼Œåç»­ä¸€ä¸€æ‰§è¡Œã€‚</p>
<p><code>initAnnotationType/destroyAnnotationType</code>æ³¨é‡Šæ˜¯ä»€ä¹ˆ?æˆ‘ä»¬åœ¨<code>CommonAnnotationBeanPostProcessor</code>çš„æ„é€ å‡½æ•°ä¸­çœ‹åˆ°ä¸‹é¢è¿™æ®µä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">CommonAnnotationBeanPostProcessor</span><span class="params">()</span> </span>&#123;  </div><div class="line">       setOrder(Ordered.LOWEST_PRECEDENCE - <span class="number">3</span>);  </div><div class="line">       setInitAnnotationType(PostConstruct.class);  </div><div class="line">       setDestroyAnnotationType(PreDestroy.class);  </div><div class="line">       ignoreResourceType(<span class="string">"javax.xml.ws.WebServiceContext"</span>);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸€è¨€ä»¥è”½ä¹‹ï¼Œ<code>@PostConstruct</code>æ³¨è§£åçš„æ–¹æ³•åœ¨<code>BeanPostProcessor</code>å‰ç½®å¤„ç†å™¨ä¸­å°±è¢«æ‰§è¡Œäº†ï¼Œæ‰€ä»¥å½“ç„¶è¦å…ˆäº<code>InitializingBean</code>å’Œ<code>init-method</code>æ‰§è¡Œäº†ã€‚</p>
<h3 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a>å‚è€ƒï¼š</h3><p><a href="http://sexycoding.iteye.com/blog/1046993" target="_blank" rel="external">æºç è§£æï¼šinit-methodã€@PostConstructã€afterPropertiesSetå­°å…ˆå­°å</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Spring Bean ç”Ÿå‘½å‘¨æœŸ]]></title>
      <url>http://zsr.github.io/2017/05/05/Spring-Bean-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</url>
      <content type="html"><![CDATA[<h1 id="Spring-Bean-ç”Ÿå‘½å‘¨æœŸ"><a href="#Spring-Bean-ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Spring Bean ç”Ÿå‘½å‘¨æœŸ"></a>Spring Bean ç”Ÿå‘½å‘¨æœŸ</h1><hr>
<p><code>BeanFactory</code>å’Œ<code>ApplicationContext</code>æ˜¯<code>Spring</code>ä¸¤ç§å¾ˆé‡è¦çš„å®¹å™¨,å‰è€…æä¾›äº†æœ€åŸºæœ¬çš„ä¾èµ–æ³¨å…¥çš„æ”¯æŒï¼Œè€Œåè€…åœ¨ç»§æ‰¿å‰è€…çš„åŸºç¡€è¿›è¡Œäº†åŠŸèƒ½çš„æ‹“å±•ï¼Œä¾‹å¦‚å¢åŠ äº†äº‹ä»¶ä¼ æ’­ï¼Œèµ„æºè®¿é—®å’Œå›½é™…åŒ–çš„æ¶ˆæ¯è®¿é—®ç­‰åŠŸèƒ½ã€‚</p>
<p>æ¦‚æ‹¬æ¥è¯´ä¸»è¦æœ‰å››ä¸ªé˜¶æ®µï¼šå®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–ï¼Œä½¿ç”¨ï¼Œé”€æ¯ã€‚</p>
<h3 id="Bean-ä½œç”¨èŒƒå›´"><a href="#Bean-ä½œç”¨èŒƒå›´" class="headerlink" title="Bean ä½œç”¨èŒƒå›´"></a>Bean ä½œç”¨èŒƒå›´</h3><p>å¸¸ç”¨çš„<code>Bean</code>ä½œç”¨èŒƒå›´ï¼š<code>singleton</code>å’Œ<code>prototype</code></p>
<ul>
<li><code>singleton</code></li>
</ul>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹,<code>Spring</code>çš„<code>ApplicationContext</code>å®¹å™¨åœ¨å¯åŠ¨æ—¶,è‡ªåŠ¨å®ä¾‹åŒ–æ‰€æœ‰<code>singleton</code>çš„<code>Bean</code>å¹¶ç¼“å­˜äºå®¹å™¨ä¸­.è™½ç„¶å¯åŠ¨æ—¶ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´,ä½†å¸¦æ¥ä¸¤ä¸ªå¥½å¤„:é¦–å…ˆå¯¹<code>Bean</code>æå‰çš„å®ä¾‹åŒ–æ“ä½œä¼šåŠæ—©å‘ç°ä¸€äº›æ½œåœ¨çš„é…ç½®é—®é¢˜.å…¶æ¬¡<code>Bean</code>ä»¥ç¼“å­˜çš„æ–¹å¼ä¿å­˜,å½“è¿è¡Œæ—¶ä½¿ç”¨åˆ°è¯¥<code>Bean</code>æ—¶å°±æ— é¡»å†å®ä¾‹åŒ–äº†,åŠ å¿«äº†è¿è¡Œæ•ˆç‡.å¦‚æœç”¨æˆ·ä¸å¸Œæœ›åœ¨å®¹å™¨å¯åŠ¨æ—¶æå‰å®ä¾‹åŒ–<code>singleton</code>çš„<code>Bean</code>,å¯ä»¥é€šè¿‡<code>lazy-init</code>å±æ€§è¿›è¡Œæ§åˆ¶.</p>
<ul>
<li><code>prototype</code></li>
</ul>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹,<code>Spring</code>å®¹å™¨åœ¨å¯åŠ¨æ—¶ä¸å®ä¾‹åŒ–<code>prototype</code>çš„<code>Bean</code>.æ­¤å¤–,<code>Spring</code>å®¹å™¨å°†<code>prototype</code>çš„<code>Bean</code>äº¤ç»™è°ƒç”¨è€…å,å°±ä¸å†ç®¡ç†å®ƒçš„ç”Ÿå‘½å‘¨æœŸ.</p>
<h3 id="ApplicationContext-Beanç”Ÿå‘½å‘¨æœŸï¼š"><a href="#ApplicationContext-Beanç”Ÿå‘½å‘¨æœŸï¼š" class="headerlink" title="ApplicationContext Beanç”Ÿå‘½å‘¨æœŸï¼š"></a>ApplicationContext Beanç”Ÿå‘½å‘¨æœŸï¼š</h3><p><code>Spring Bean</code>çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸä»åˆ›å»º<code>Spring</code>å®¹å™¨å¼€å§‹ï¼Œç›´åˆ°æœ€ç»ˆ<code>Spring</code>å®¹å™¨é”€æ¯<code>Bean</code>ï¼Œè¿™å…¶ä¸­åŒ…å«äº†ä¸€ç³»åˆ—å…³é”®ç‚¹ã€‚</p>
<h4 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h4><p><img src="http://xfhnever.com/images/post/spring5-2.jpg" alt="img"></p>
<p>è‹¥å®¹å™¨æ³¨å†Œäº†ä»¥ä¸Šå„ç§æ¥å£ï¼Œç¨‹åºé‚£ä¹ˆå°†ä¼šæŒ‰ç…§ä»¥ä¸Šçš„æµç¨‹è¿›è¡Œã€‚ä¸‹é¢å°†ä»”ç»†è®²è§£å„æ¥å£ä½œç”¨ã€‚</p>
<a id="more"></a>
<h4 id="å„ç§æ¥å£æ–¹æ³•åˆ†ç±»"><a href="#å„ç§æ¥å£æ–¹æ³•åˆ†ç±»" class="headerlink" title="å„ç§æ¥å£æ–¹æ³•åˆ†ç±»"></a>å„ç§æ¥å£æ–¹æ³•åˆ†ç±»</h4><p><code>Bean</code>çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç»å†äº†å„ç§æ–¹æ³•è°ƒç”¨ï¼Œè¿™äº›æ–¹æ³•å¯ä»¥åˆ’åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š</p>
<p>1ã€<code>Bean</code>è‡ªèº«çš„æ–¹æ³•ï¼šè¿™ä¸ªåŒ…æ‹¬äº†<code>Bean</code>æœ¬èº«è°ƒç”¨çš„æ–¹æ³•å’Œé€šè¿‡é…ç½®æ–‡ä»¶ä¸­<code>&lt;bean&gt;</code>çš„<code>init-method</code>å’Œ<code>destroy-method</code>æŒ‡å®šçš„æ–¹æ³•</p>
<p>2ã€<code>Bean</code>çº§ç”Ÿå‘½å‘¨æœŸæ¥å£æ–¹æ³•ï¼šè¿™ä¸ªåŒ…æ‹¬äº†<code>BeanNameAware</code>ã€<code>BeanFactoryAware</code>ã€<code>InitializingBean</code>å’Œ<code>DiposableBean</code>è¿™äº›æ¥å£çš„æ–¹æ³•</p>
<p>3ã€<code>å®¹å™¨çº§</code>ç”Ÿå‘½å‘¨æœŸæ¥å£æ–¹æ³•ï¼šè¿™ä¸ªåŒ…æ‹¬äº†<code>InstantiationAwareBeanPostProcessor</code>å’Œ <code>BeanPostProcessor</code>è¿™ä¸¤ä¸ªæ¥å£å®ç°ï¼Œä¸€èˆ¬ç§°å®ƒä»¬çš„å®ç°ç±»ä¸ºâ€œåå¤„ç†å™¨â€ã€‚å®¹å™¨ä¸­æ¯ä¸ª<code>bean</code>åˆå§‹åŒ–éƒ½è¦ç»è¿‡è¿™ä¸€æ­¥ã€‚</p>
<p>4ã€å·¥å‚åå¤„ç†å™¨æ¥å£<code>BeanFactoryPostProcessor</code>æ–¹æ³•ï¼šè¿™ä¸ªåŒ…æ‹¬äº†<code>AspectJWeavingEnabler</code>, <code>ConfigurationClassPostProcessor</code>, <code>CustomAutowireConfigurer</code>ç­‰ç­‰éå¸¸æœ‰ç”¨çš„å·¥å‚åå¤„ç†å™¨æ¥å£çš„æ–¹æ³•ã€‚å·¥å‚åå¤„ç†å™¨ä¹Ÿæ˜¯å®¹å™¨çº§çš„ï¼Œåœ¨åº”ç”¨ä¸Šä¸‹æ–‡è£…é…é…ç½®æ–‡ä»¶ä¹‹åç«‹å³è°ƒç”¨ã€‚</p>
<h4 id="æµç¨‹è¯´æ˜"><a href="#æµç¨‹è¯´æ˜" class="headerlink" title="æµç¨‹è¯´æ˜"></a>æµç¨‹è¯´æ˜</h4><ol>
<li>é¦–å…ˆå®¹å™¨å¯åŠ¨åï¼Œä¼šå¯¹<code>scope</code>ä¸º<code>singleton</code>ä¸”éæ‡’åŠ è½½(<code>lazy-init=false</code>)çš„<code>bean</code>è¿›è¡Œå®ä¾‹åŒ–ï¼Œ</li>
<li>æŒ‰ç…§<code>Bean</code>å®šä¹‰ä¿¡æ¯é…ç½®ä¿¡æ¯ï¼Œæ³¨å…¥æ‰€æœ‰çš„å±æ€§</li>
<li>å¦‚æœ<code>Bean</code>å®ç°äº†<code>BeanNameAware</code>æ¥å£ï¼Œä¼šå›è°ƒè¯¥æ¥å£çš„<code>setBeanName()</code>æ–¹æ³•ï¼Œä¼ å…¥è¯¥<code>Bean</code>çš„idï¼Œæ­¤æ—¶è¯¥<code>Bean</code>å°±è·å¾—äº†è‡ªå·±åœ¨é…ç½®æ–‡ä»¶ä¸­çš„id</li>
<li>å¦‚æœ<code>Bean</code>å®ç°äº†<code>BeanFactoryAware</code>æ¥å£,ä¼šå›è°ƒè¯¥æ¥å£çš„<code>setBeanFactory()</code>æ–¹æ³•ï¼Œä¼ å…¥è¯¥<code>Bean</code>çš„<code>BeanFactory</code>ï¼Œè¿™æ ·è¯¥<code>Bean</code>å°±è·å¾—äº†è‡ªå·±æ‰€åœ¨çš„<code>BeanFactory</code></li>
<li><strong>å¦‚æœ<code>Bean</code>å®ç°äº†<code>ApplicationContextAware</code>æ¥å£,ä¼šå›è°ƒè¯¥æ¥å£çš„<code>setApplicationContext()</code>æ–¹æ³•ï¼Œä¼ å…¥è¯¥<code>Bean</code>çš„<code>ApplicationContext</code>ï¼Œè¿™æ ·è¯¥<code>Bean</code>å°±è·å¾—äº†è‡ªå·±æ‰€åœ¨çš„<code>ApplicationContext</code></strong></li>
<li>å¦‚æœæœ‰<code>Bean</code>å®ç°äº†<code>BeanPostProcessor</code>æ¥å£ï¼Œåˆ™ä¼šå›è°ƒè¯¥æ¥å£çš„<code>postProcessBeforeInitialzation()</code>æ–¹æ³•</li>
<li>å¦‚æœ<code>Bean</code>å®ç°äº†<code>InitializingBean</code>æ¥å£ï¼Œåˆ™ä¼šå›è°ƒè¯¥æ¥å£çš„<code>afterPropertiesSet()</code>æ–¹æ³•</li>
<li>å¦‚æœ<code>Bean</code>é…ç½®äº†<code>init-method</code>æ–¹æ³•ï¼Œåˆ™ä¼šæ‰§è¡Œ<code>init-method</code>é…ç½®çš„æ–¹æ³•</li>
<li>å¦‚æœæœ‰<code>Bean</code>å®ç°äº†<code>BeanPostProcessor</code>æ¥å£ï¼Œåˆ™ä¼šå›è°ƒè¯¥æ¥å£çš„<code>postProcessAfterInitialization()</code>æ–¹æ³•</li>
<li>ç»è¿‡æµç¨‹9ä¹‹åï¼Œå°±å¯ä»¥æ­£å¼ä½¿ç”¨è¯¥<code>Bean</code>äº†,å¯¹äº<code>scope</code>ä¸º<code>singleton</code>çš„<code>Bean</code>,Springçš„iocå®¹å™¨ä¸­ä¼šç¼“å­˜ä¸€ä»½è¯¥<code>bean</code>çš„å®ä¾‹ï¼Œè€Œå¯¹äº<code>scope</code>ä¸º<code>prototype</code>çš„<code>Bean</code>,æ¯æ¬¡è¢«è°ƒç”¨éƒ½ä¼šnewä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œç”Ÿå‘½å‘¨æœŸå°±äº¤ç»™è°ƒç”¨æ–¹ç®¡ç†äº†ï¼Œä¸å†æ˜¯Springå®¹å™¨è¿›è¡Œç®¡ç†äº†</li>
<li>å®¹å™¨å…³é—­åï¼Œå¦‚æœ<code>Bean</code>å®ç°äº†<code>DisposableBean</code>æ¥å£ï¼Œåˆ™ä¼šå›è°ƒè¯¥æ¥å£çš„<code>destroy()</code>æ–¹æ³•</li>
<li>å¦‚æœ<code>Bean</code>é…ç½®äº†<code>destroy-method</code>æ–¹æ³•ï¼Œåˆ™ä¼šæ‰§è¡Œ<code>destroy-method</code>é…ç½®çš„æ–¹æ³•ï¼Œè‡³æ­¤ï¼Œæ•´ä¸ª<code>Bean</code>çš„ç”Ÿå‘½å‘¨æœŸç»“æŸ</li>
</ol>
<h3 id="BeanFactory-Beanç”Ÿå‘½å‘¨æœŸ"><a href="#BeanFactory-Beanç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="BeanFactory Beanç”Ÿå‘½å‘¨æœŸ"></a>BeanFactory Beanç”Ÿå‘½å‘¨æœŸ</h3><p><code>BeanFactoty</code>å®¹å™¨ä¸­, <code>Bean</code>çš„ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸<code>ApplicationContext</code>ç›¸æ¯”ï¼Œæœ‰å¦‚ä¸‹å‡ ç‚¹ä¸åŒ:</p>
<p>1.<code>BeanFactory</code>å®¹å™¨ä¸­ï¼Œä¸ä¼šè°ƒç”¨<code>ApplicationContextAware</code>æ¥å£çš„<code>setApplicationContext()</code>æ–¹æ³•</p>
<p>2.<code>BeanPostProcessor</code>æ¥å£çš„<code>postProcessBeforeInitialzation()</code>æ–¹æ³•å’Œ<code>postProcessAfterInitialization()</code>æ–¹æ³•ä¸ä¼šè‡ªåŠ¨è°ƒç”¨ï¼Œå¿…é¡»è‡ªå·±é€šè¿‡ä»£ç æ‰‹åŠ¨æ³¨å†Œ</p>
<p>3.<code>BeanFactory</code>å®¹å™¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¸ä¼šå»å®ä¾‹åŒ–æ‰€æœ‰<code>Bean</code>,åŒ…æ‹¬æ‰€æœ‰<code>scope</code>ä¸º<code>singleton</code>ä¸”éæ‡’åŠ è½½çš„<code>Bean</code>ä¹Ÿæ˜¯ä¸€æ ·ï¼Œè€Œæ˜¯åœ¨è°ƒç”¨çš„æ—¶å€™å»å®ä¾‹åŒ–ã€‚</p>
<h4 id="æµç¨‹å›¾-1"><a href="#æµç¨‹å›¾-1" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h4><p><img src="http://xfhnever.com/images/post/spring5-1.jpg" alt="img"></p>
<h4 id="æµç¨‹è¯´æ˜-1"><a href="#æµç¨‹è¯´æ˜-1" class="headerlink" title="æµç¨‹è¯´æ˜"></a>æµç¨‹è¯´æ˜</h4><ol>
<li>å½“è°ƒç”¨è€…é€šè¿‡ <code>getBean(name)</code>å‘ å®¹å™¨å¯»æ‰¾<code>Bean</code>æ—¶ï¼Œå¦‚æœå®¹å™¨æ³¨å†Œäº†<code>org.springframework.beans.factory.config.InstantiationAwareBeanPostProcessor</code>æ¥å£ï¼Œåœ¨å®ä¾‹<code>bean</code>ä¹‹å‰ï¼Œå°†è°ƒç”¨è¯¥æ¥å£çš„ <code>postProcessBeforeInstantiation()</code>æ–¹æ³•</li>
<li>å®¹å™¨å¯»æ‰¾<code>Bean</code>çš„å®šä¹‰ä¿¡æ¯ï¼Œå¹¶å°†å…¶å®ä¾‹åŒ–</li>
<li>ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œ<code>Spring</code>æŒ‰ç…§<code>Bean</code>å®šä¹‰ä¿¡æ¯é…ç½®<code>Bean</code>çš„æ‰€æœ‰å±æ€§</li>
<li>å¦‚æœ<code>Bean</code>å®ç°äº†<code>BeanNameAware</code>æ¥å£ï¼Œå·¥å‚è°ƒç”¨<code>Bean</code>çš„<code>setBeanName()</code>æ–¹æ³•ä¼ é€’<code>Bean</code>çš„id</li>
<li>å¦‚æœå®ç°äº†<code>BeanFactoryAware</code>æ¥å£ï¼Œå·¥å‚è°ƒç”¨<code>setBeanFactory()</code>æ–¹æ³•ä¼ å…¥å·¥å‚è‡ªèº«</li>
<li>å¦‚æœ<code>BeanPostProcessor</code>å’Œ<code>Bean</code>å…³è”ï¼Œé‚£ä¹ˆå®ƒä»¬çš„<code>postProcessBeforeInitialization()</code>æ–¹æ³•å°†è¢«è°ƒç”¨ï¼ˆéœ€è¦æ‰‹åŠ¨è¿›è¡Œæ³¨å†Œï¼ï¼‰</li>
<li>å¦‚æœ<code>Bean</code>å®ç°äº†<code>InitializingBean</code>æ¥å£ï¼Œåˆ™ä¼šå›è°ƒè¯¥æ¥å£çš„<code>afterPropertiesSet()</code>æ–¹æ³•</li>
<li>å¦‚æœ<code>Bean</code>æŒ‡å®šäº†<code>init-method</code>æ–¹æ³•ï¼Œå°±ä¼šè°ƒç”¨<code>init-method</code>æ–¹æ³•</li>
<li>å¦‚æœ<code>BeanPostProcessor</code>å’Œ<code>Bean</code>å…³è”ï¼Œé‚£ä¹ˆå®ƒçš„<code>postProcessAfterInitialization()</code>æ–¹æ³•å°†è¢«è°ƒç”¨ï¼ˆéœ€è¦æ‰‹åŠ¨æ³¨å†Œï¼ï¼‰</li>
<li>ç°åœ¨<code>Bean</code>å·²ç»å¯ä»¥ä½¿ç”¨äº†<ol>
<li><code>scope</code>ä¸º<code>singleton</code>çš„<code>Bean</code>ç¼“å­˜åœ¨Spring IOCå®¹å™¨ä¸­</li>
<li><code>scope</code>ä¸º<code>prototype</code>çš„<code>Bean</code>ç”Ÿå‘½å‘¨æœŸäº¤ç»™å®¢æˆ·ç«¯</li>
</ol>
</li>
<li>é”€æ¯<ol>
<li>å¦‚æœ<code>Bean</code>å®ç°äº†<code>DisposableBean</code>æ¥å£ï¼Œ<code>destory()</code>æ–¹æ³•å°†ä¼šè¢«è°ƒç”¨</li>
<li>å¦‚æœé…ç½®äº†<code>destory-method</code>æ–¹æ³•ï¼Œå°±è°ƒç”¨è¿™ä¸ªæ–¹æ³•</li>
</ol>
</li>
</ol>
<h3 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h3><p>ç”¨ä¸€ä¸ªç®€å•çš„<code>Spring Bean</code>æ¥æ¼”ç¤ºä¸€ä¸‹<code>Spring Bean</code>çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>1ã€é¦–å…ˆæ˜¯ä¸€ä¸ªç®€å•çš„<code>Spring Bean</code>ï¼Œè°ƒç”¨Beanè‡ªèº«çš„æ–¹æ³•å’ŒBeançº§ç”Ÿå‘½å‘¨æœŸæ¥å£æ–¹æ³•ï¼Œä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œå®ƒå®ç°äº†<code>BeanNameAware</code>ã€<code>BeanFactoryAware</code>ã€<code>InitializingBean</code>å’Œ<code>DiposableBean</code>è¿™4ä¸ªæ¥å£ï¼ŒåŒæ—¶æœ‰2ä¸ªæ–¹æ³•ï¼Œå¯¹åº”é…ç½®æ–‡ä»¶ä¸­<code>&lt;bean&gt;</code>çš„<code>init-method</code>å’Œ<code>destroy-method</code>ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.spring.bean;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanFactory;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanFactoryAware;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanNameAware;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.DisposableBean;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">BeanFactoryAware</span>, <span class="title">BeanNameAware</span>, <span class="title">InitializingBean</span>, <span class="title">DisposableBean</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> String name;</div><div class="line">  <span class="keyword">private</span> String address;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> phone;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> BeanFactory beanFactory;</div><div class="line">  <span class="keyword">private</span> String beanName;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"ã€æ„é€ å™¨ã€‘è°ƒç”¨Personçš„æ„é€ å™¨å®ä¾‹åŒ–"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"ã€æ³¨å…¥å±æ€§ã€‘æ³¨å…¥å±æ€§name"</span>);</div><div class="line">    <span class="keyword">this</span>.name = name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getAddress</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> address;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAddress</span><span class="params">(String address)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"ã€æ³¨å…¥å±æ€§ã€‘æ³¨å…¥å±æ€§address"</span>);</div><div class="line">    <span class="keyword">this</span>.address = address;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPhone</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> phone;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPhone</span><span class="params">(<span class="keyword">int</span> phone)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"ã€æ³¨å…¥å±æ€§ã€‘æ³¨å…¥å±æ€§phone"</span>);</div><div class="line">    <span class="keyword">this</span>.phone = phone;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"Person [address="</span> + address + <span class="string">", name="</span> + name + <span class="string">", phone="</span> + phone + <span class="string">"]"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// è¿™æ˜¯BeanFactoryAwareæ¥å£æ–¹æ³•</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">    System.out.println(<span class="string">"ã€BeanFactoryAwareæ¥å£ã€‘è°ƒç”¨BeanFactoryAware.setBeanFactory()"</span>);</div><div class="line">    <span class="keyword">this</span>.beanFactory = beanFactory;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// è¿™æ˜¯BeanNameAwareæ¥å£æ–¹æ³•</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"ã€BeanNameAwareæ¥å£ã€‘è°ƒç”¨BeanNameAware.setBeanName()"</span>);</div><div class="line">    <span class="keyword">this</span>.beanName = name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// è¿™æ˜¯InitializingBeanæ¥å£æ–¹æ³•</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    System.out.println(<span class="string">"ã€InitializingBeanæ¥å£ã€‘è°ƒç”¨InitializingBean.afterPropertiesSet()"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// è¿™æ˜¯DiposibleBeanæ¥å£æ–¹æ³•</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    System.out.println(<span class="string">"ã€DiposibleBeanæ¥å£ã€‘è°ƒç”¨DiposibleBean.destory()"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// é€šè¿‡&lt;bean&gt;çš„init-methodå±æ€§æŒ‡å®šçš„åˆå§‹åŒ–æ–¹æ³•</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">myInit</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"ã€init-methodã€‘è°ƒç”¨&lt;bean&gt;çš„init-methodå±æ€§æŒ‡å®šçš„åˆå§‹åŒ–æ–¹æ³•"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// é€šè¿‡&lt;bean&gt;çš„destroy-methodå±æ€§æŒ‡å®šçš„åˆå§‹åŒ–æ–¹æ³•</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">myDestory</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"ã€destroy-methodã€‘è°ƒç”¨&lt;bean&gt;çš„destroy-methodå±æ€§æŒ‡å®šçš„åˆå§‹åŒ–æ–¹æ³•"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2ã€æ¥ä¸‹æ¥æ˜¯æ¼”ç¤ºBeanPostProcessoræ¥å£çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.spring.bean;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.BeanPostProcessor;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MyBeanPostProcessor</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>();</div><div class="line">    System.out.println(<span class="string">"è¿™æ˜¯BeanPostProcessorå®ç°ç±»æ„é€ å™¨ï¼ï¼"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">    System.out.println(<span class="string">"BeanPostProcessoræ¥å£æ–¹æ³•postProcessBeforeInitializationå¯¹å±æ€§è¿›è¡Œæ›´æ”¹ï¼"</span>);</div><div class="line">    <span class="keyword">return</span> bean;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">    System.out.println(<span class="string">"BeanPostProcessoræ¥å£æ–¹æ³•postProcessAfterInitializationå¯¹å±æ€§è¿›è¡Œæ›´æ”¹ï¼"</span>);</div><div class="line">    <span class="keyword">return</span> bean;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚ä¸Šï¼Œ<code>BeanPostProcessor</code>æ¥å£åŒ…æ‹¬2ä¸ªæ–¹æ³•<code>postProcessAfterInitialization</code>å’Œ<code>postProcessBeforeInitialization</code>ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯è¦å¤„ç†çš„Beanå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°éƒ½æ˜¯Beançš„nameã€‚è¿”å›å€¼ä¹Ÿéƒ½æ˜¯è¦å¤„ç†çš„Beanå¯¹è±¡ã€‚</p>
<p>3ã€<strong><code>InstantiationAwareBeanPostProcessor</code> æ¥å£æœ¬è´¨æ˜¯<code>BeanPostProcessor</code>çš„å­æ¥å£</strong>ï¼Œä¸€èˆ¬æˆ‘ä»¬ç»§æ‰¿Springä¸ºå…¶æä¾›çš„é€‚é…å™¨ç±»<code>InstantiationAwareBeanPostProcessorAdapter</code>æ¥ä½¿ç”¨å®ƒï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.spring.bean;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.beans.PropertyDescriptor;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.PropertyValues;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.InstantiationAwareBeanPostProcessorAdapter;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInstantiationAwareBeanPostProcessor</span> <span class="keyword">extends</span> <span class="title">InstantiationAwareBeanPostProcessorAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MyInstantiationAwareBeanPostProcessor</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>();</div><div class="line">    System.out.println(<span class="string">"è¿™æ˜¯InstantiationAwareBeanPostProcessorAdapterå®ç°ç±»æ„é€ å™¨ï¼ï¼"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// æ¥å£æ–¹æ³•ã€å®ä¾‹åŒ–Beanä¹‹å‰è°ƒç”¨</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInstantiation</span><span class="params">(Class beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">    System.out.println(<span class="string">"InstantiationAwareBeanPostProcessorè°ƒç”¨postProcessBeforeInstantiationæ–¹æ³•"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// æ¥å£æ–¹æ³•ã€å®ä¾‹åŒ–Beanä¹‹åè°ƒç”¨</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">    System.out.println(<span class="string">"InstantiationAwareBeanPostProcessorè°ƒç”¨postProcessAfterInitializationæ–¹æ³•"</span>);</div><div class="line">    <span class="keyword">return</span> bean;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// æ¥å£æ–¹æ³•ã€è®¾ç½®æŸä¸ªå±æ€§æ—¶è°ƒç”¨</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> PropertyValues <span class="title">postProcessPropertyValues</span><span class="params">(PropertyValues pvs, PropertyDescriptor[] pds, Object bean,</span></span></div><div class="line">      String beanName) <span class="keyword">throws</span> BeansException &#123;</div><div class="line">    System.out.println(<span class="string">"InstantiationAwareBeanPostProcessorè°ƒç”¨postProcessPropertyValuesæ–¹æ³•"</span>);</div><div class="line">    <span class="keyword">return</span> pvs;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæœ‰3ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªæ–¹æ³•<code>postProcessAfterInitialization</code>å°±æ˜¯é‡å†™äº†<code>BeanPostProcessor</code>çš„æ–¹æ³•ã€‚ç¬¬ä¸‰ä¸ªæ–¹æ³•<code>postProcessPropertyValues</code>ç”¨æ¥æ“ä½œå±æ€§ï¼Œè¿”å›å€¼ä¹Ÿåº”è¯¥æ˜¯<code>PropertyValues</code>å¯¹è±¡ã€‚</p>
<p>4ã€å·¥å‚åå¤„ç†å™¨æ¥å£æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.spring.bean;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.BeanDefinition;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.BeanFactoryPostProcessor;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MyBeanFactoryPostProcessor</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>();</div><div class="line">    System.out.println(<span class="string">"è¿™æ˜¯BeanFactoryPostProcessorå®ç°ç±»æ„é€ å™¨ï¼ï¼"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">    System.out.println(<span class="string">"BeanFactoryPostProcessorè°ƒç”¨postProcessBeanFactoryæ–¹æ³•"</span>);</div><div class="line">    BeanDefinition bd = arg0.getBeanDefinition(<span class="string">"person"</span>);</div><div class="line">    bd.getPropertyValues().addPropertyValue(<span class="string">"phone"</span>, <span class="string">"110"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>BeanFactoryPostProcessor</code> å¯ä»¥ä¿®æ”¹ <code>bean</code> çš„é…ç½®ä¿¡æ¯è€Œ <code>BeanPostProcessor</code> ä¸èƒ½</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span></span></div><div class="line">                <span class="keyword">throws</span> BeansException &#123;</div><div class="line">            <span class="comment">//BeanFactoryPostProcessorå¯ä»¥ä¿®æ”¹BEANçš„é…ç½®ä¿¡æ¯è€ŒBeanPostProcessorä¸èƒ½</span></div><div class="line">            <span class="comment">//æˆ‘ä»¬åœ¨è¿™é‡Œä¿®æ”¹postProcessorBeançš„usernameæ³¨å…¥å±æ€§</span></div><div class="line">            BeanDefinition bd = beanFactory.getBeanDefinition(<span class="string">"postProcessorBean"</span>);</div><div class="line">            MutablePropertyValues pv =  bd.getPropertyValues();</div><div class="line">            <span class="keyword">if</span>(pv.contains(<span class="string">"username"</span>))</div><div class="line">            &#123;</div><div class="line">                pv.addPropertyValue(<span class="string">"username"</span>, <span class="string">"xiaojun"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>5ã€é…ç½®æ–‡ä»¶å¦‚ä¸‹<code>beans.xml</code>ï¼Œä½¿ç”¨<code>ApplicationContext</code>,å¤„ç†å™¨ä¸ç”¨æ‰‹åŠ¨æ³¨å†Œï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></div><div class="line">    <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span> <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></div><div class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></div><div class="line">            http://www.springframework.org/schema/beans </div><div class="line">            http://www.springframework.org/schema/beans/spring-beans-3.2.xsd"&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"beanPostProcessor"</span> <span class="attr">class</span>=<span class="string">"springBeanTest.MyBeanPostProcessor"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"instantiationAwareBeanPostProcessor"</span> <span class="attr">class</span>=<span class="string">"springBeanTest.MyInstantiationAwareBeanPostProcessor"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"beanFactoryPostProcessor"</span> <span class="attr">class</span>=<span class="string">"springBeanTest.MyBeanFactoryPostProcessor"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"person"</span> <span class="attr">class</span>=<span class="string">"springBeanTest.Person"</span> <span class="attr">init-method</span>=<span class="string">"myInit"</span></span></div><div class="line">        <span class="attr">destroy-method</span>=<span class="string">"myDestory"</span> <span class="attr">scope</span>=<span class="string">"singleton"</span> <span class="attr">p:name</span>=<span class="string">"å¼ ä¸‰"</span> <span class="attr">p:address</span>=<span class="string">"å¹¿å·"</span></div><div class="line">        <span class="attr">p:phone</span>=<span class="string">"15900000000"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>6ã€æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.spring.bean;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</div><div class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanLifeCycleTest</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"></div><div class="line">    System.out.println(<span class="string">"ç°åœ¨å¼€å§‹åˆå§‹åŒ–å®¹å™¨"</span>);</div><div class="line"></div><div class="line">    ApplicationContext factory = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"beans.xml"</span>);</div><div class="line">    System.out.println(<span class="string">"å®¹å™¨åˆå§‹åŒ–æˆåŠŸ"</span>);</div><div class="line">    <span class="comment">// å¾—åˆ°Presonï¼Œå¹¶ä½¿ç”¨</span></div><div class="line">    Person person = factory.getBean(<span class="string">"person"</span>, Person.class);</div><div class="line">    System.out.println(person);</div><div class="line"></div><div class="line">    System.out.println(<span class="string">"ç°åœ¨å¼€å§‹å…³é—­å®¹å™¨ï¼"</span>);</div><div class="line">    ((ClassPathXmlApplicationContext) factory).registerShutdownHook();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…³é—­å®¹å™¨ä½¿ç”¨çš„æ˜¯å®é™…æ˜¯<code>AbstractApplicationContext</code>çš„é’©å­æ–¹æ³•ã€‚</p>
<p>7ã€ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">ç°åœ¨å¼€å§‹åˆå§‹åŒ–å®¹å™¨</div><div class="line">[location]15:15:33 100  INFO (org.springframework.context.support.ClassPathXmlApplicationContext:510) - Refreshing org.springframework.context.support.ClassPathXmlApplicationContext@75a70476: startup date [Mon May 08 15:15:33 CST 2017]; root of context hierarchy</div><div class="line">[location]15:15:33 194  INFO (org.springframework.beans.factory.xml.XmlBeanDefinitionReader:315) - Loading XML bean definitions from class path resource [beans.xml]</div><div class="line">è¿™æ˜¯BeanFactoryPostProcessorå®ç°ç±»æ„é€ å™¨ï¼ï¼</div><div class="line">BeanFactoryPostProcessorè°ƒç”¨postProcessBeanFactoryæ–¹æ³•</div><div class="line">è¿™æ˜¯BeanPostProcessorå®ç°ç±»æ„é€ å™¨ï¼ï¼</div><div class="line">è¿™æ˜¯InstantiationAwareBeanPostProcessorAdapterå®ç°ç±»æ„é€ å™¨ï¼ï¼</div><div class="line">[location]15:15:33 695  INFO (org.springframework.beans.factory.support.DefaultListableBeanFactory:596) - Pre-instantiating singletons in org.springframework.beans.factory.support.DefaultListableBeanFactory@461d434f: defining beans [beanPostProcessor,instantiationAwareBeanPostProcessor,beanFactoryPostProcessor,person]; root of factory hierarchy</div><div class="line">InstantiationAwareBeanPostProcessorè°ƒç”¨postProcessBeforeInstantiationæ–¹æ³•</div><div class="line">ã€æ„é€ å™¨ã€‘è°ƒç”¨Personçš„æ„é€ å™¨å®ä¾‹åŒ–</div><div class="line">InstantiationAwareBeanPostProcessorè°ƒç”¨postProcessPropertyValuesæ–¹æ³•</div><div class="line">ã€æ³¨å…¥å±æ€§ã€‘æ³¨å…¥å±æ€§address</div><div class="line">ã€æ³¨å…¥å±æ€§ã€‘æ³¨å…¥å±æ€§name</div><div class="line">ã€æ³¨å…¥å±æ€§ã€‘æ³¨å…¥å±æ€§phone</div><div class="line">ã€BeanNameAwareæ¥å£ã€‘è°ƒç”¨BeanNameAware.setBeanName()</div><div class="line">ã€BeanFactoryAwareæ¥å£ã€‘è°ƒç”¨BeanFactoryAware.setBeanFactory()</div><div class="line">BeanPostProcessoræ¥å£æ–¹æ³•postProcessBeforeInitializationå¯¹å±æ€§è¿›è¡Œæ›´æ”¹ï¼</div><div class="line">ã€InitializingBeanæ¥å£ã€‘è°ƒç”¨InitializingBean.afterPropertiesSet()</div><div class="line">ã€init-methodã€‘è°ƒç”¨&lt;bean&gt;çš„init-methodå±æ€§æŒ‡å®šçš„åˆå§‹åŒ–æ–¹æ³•</div><div class="line">BeanPostProcessoræ¥å£æ–¹æ³•postProcessAfterInitializationå¯¹å±æ€§è¿›è¡Œæ›´æ”¹ï¼</div><div class="line">InstantiationAwareBeanPostProcessorè°ƒç”¨postProcessAfterInitializationæ–¹æ³•</div><div class="line">å®¹å™¨åˆå§‹åŒ–æˆåŠŸ</div><div class="line">Person [address=å¹¿å·, name=å¼ ä¸‰, phone=110]</div><div class="line">ç°åœ¨å¼€å§‹å…³é—­å®¹å™¨ï¼</div><div class="line">[location]15:15:33 752  INFO (org.springframework.context.support.ClassPathXmlApplicationContext:1042) - Closing org.springframework.context.support.ClassPathXmlApplicationContext@75a70476: startup date [Mon May 08 15:15:33 CST 2017]; root of context hierarchy</div><div class="line">[location]15:15:33 752  INFO (org.springframework.beans.factory.support.DefaultListableBeanFactory:444) - Destroying singletons in org.springframework.beans.factory.support.DefaultListableBeanFactory@461d434f: defining beans [beanPostProcessor,instantiationAwareBeanPostProcessor,beanFactoryPostProcessor,person]; root of factory hierarchy</div><div class="line">ã€DiposibleBeanæ¥å£ã€‘è°ƒç”¨DiposibleBean.destory()</div><div class="line">ã€destroy-methodã€‘è°ƒç”¨&lt;bean&gt;çš„destroy-methodå±æ€§æŒ‡å®šçš„åˆå§‹åŒ–æ–¹æ³•</div></pre></td></tr></table></figure>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>Beançš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸä» spring å®¹å™¨å¼€å§‹å®ä¾‹åŒ– bean å¼€å§‹ï¼Œåˆ°é”€æ¯ã€‚å¯ä»¥ä»ä¸‰ç‚¹æ¥ç†è§£</p>
<p>1ã€<code>bean</code>è‡ªèº«çš„æ–¹æ³•ï¼šåŒ…æ‹¬æ„é€ æ–¹æ³•ã€ set æ–¹æ³•ã€ init-method æŒ‡å®šçš„æ–¹æ³•ã€ destroy-method æŒ‡å®šçš„æ–¹æ³•</p>
<p>2ã€<code>bean</code>çº§ç”Ÿå‘½å‘¨æœŸæ¥å£æ–¹æ³•ï¼šå¦‚<code>BeanNameAware</code> ã€ <code>BeanFactoryAware</code> ç­‰è¿™äº›æ¥å£æ–¹æ³•ç”± beanç±»å®ç°</p>
<p>3ã€å®¹å™¨çº§ç”Ÿå‘½å‘¨æœŸæ¥å£æ–¹æ³•ï¼šæœ‰<code>InstantiationAwareBeanPostProcessor</code> ã€ <code>BeanPostProcessor</code>ç­‰ã€‚ä¸€èˆ¬ç§°ä¸ºåå¤„ç†å™¨ã€‚ä»–ä»¬ä¸€èˆ¬ä¸ç”±bean æœ¬èº«å®ç°ï¼Œç‹¬ç«‹å­˜åœ¨ï¼Œæ³¨å†Œåˆ° spring å®¹å™¨ä¸­ã€‚ Spring é€šè¿‡æ¥å£åå°„é¢„å…ˆçŸ¥é“ï¼Œå½“ spring å®¹å™¨åˆ›å»ºä»»ä½• bean æ—¶ï¼Œè¿™äº›åå¤„ç†å™¨éƒ½ä¼šå‘ç”Ÿä½œç”¨ã€‚æ‰€ä»¥ä»–ä»¬æ˜¯å…¨å±€çš„ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç¼–ç å¯¹åªæ„Ÿå…´è¶£çš„ bean è¿›è¡Œå¤„ç†</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.cnblogs.com/zrtqsk/p/3735273.html" target="_blank" rel="external">Spring Beançš„ç”Ÿå‘½å‘¨æœŸ</a></p>
<p><a href="http://www.jianshu.com/p/3944792a5fff" target="_blank" rel="external">Spring Beanç”Ÿå‘½å‘¨æœŸ</a></p>
<p><a href="https://my.oschina.net/u/1246663/blog/207450" target="_blank" rel="external">Spring beanç”Ÿå‘½å‘¨æœŸè¯¦è§£</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ThreadPoolExecutor]]></title>
      <url>http://zsr.github.io/2017/05/03/ThreadPoolExecutor/</url>
      <content type="html"><![CDATA[<h1 id="ThreadPoolExecutorçº¿ç¨‹æ± -å®ç°åŸç†"><a href="#ThreadPoolExecutorçº¿ç¨‹æ± -å®ç°åŸç†" class="headerlink" title="ThreadPoolExecutorçº¿ç¨‹æ±  å®ç°åŸç†"></a>ThreadPoolExecutorçº¿ç¨‹æ±  å®ç°åŸç†</h1><hr>
<h3 id="ç±»ç»“æ„"><a href="#ç±»ç»“æ„" class="headerlink" title="ç±»ç»“æ„"></a>ç±»ç»“æ„</h3><p>é¦–å…ˆè¦å…ˆäº†è§£ä¸€ä¸‹ç±»ç»“æ„ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://kael-aiur.com/static/img/blog/java-thread-pool/images/class_struts.png" alt="enter description here"></p>
<ul>
<li><code>Executor</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åªæœ‰ä¸€ä¸ªæ¥å£ï¼Œä¼ å…¥ä¸€ä¸ª<code>Runnable</code>å¯¹è±¡ï¼Œçº¿ç¨‹æ± å°±ä¼šå¸®ä½ æ‰§è¡Œè¿™ä¸ªæŒ‡ä»¤ã€‚</p>
<ul>
<li><code>ExecutorService</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExecutorService</span> <span class="keyword">extends</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">List&lt;Runnable&gt; <span class="title">shutdownNow</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isShutdown</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isTerminated</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">awaitTermination</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException</span>;</div><div class="line">    &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span></span>;</div><div class="line">    &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Runnable task, T result)</span></span>;</div><div class="line"> </div><div class="line">    .......çœç•¥........</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ¥å£æ˜¯æ‰§è¡Œå™¨æœåŠ¡æ¥å£ï¼Œå£°æ˜äº†å…³äºæ‰§è¡Œå™¨çš„è®¸å¤šç®¡ç†æ–¹æ³•ã€‚</p>
<ul>
<li><code>AbstractExecutorService</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractExecutorService</span> <span class="keyword">implements</span> <span class="title">ExecutorService</span> </span>&#123;</div><div class="line">  </div><div class="line">  .......çœç•¥........</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</div><div class="line">        <span class="keyword">if</span> (task == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">        RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, <span class="keyword">null</span>);</div><div class="line">        execute(ftask);</div><div class="line">        <span class="keyword">return</span> ftask;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Runnable task, T result)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (task == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">        RunnableFuture&lt;T&gt; ftask = newTaskFor(task, result);</div><div class="line">        execute(ftask);</div><div class="line">        <span class="keyword">return</span> ftask;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (task == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">        RunnableFuture&lt;T&gt; ftask = newTaskFor(task);</div><div class="line">        execute(ftask);</div><div class="line">        <span class="keyword">return</span> ftask;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line"> .......çœç•¥........</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæŠ½è±¡ç±»å®ç°äº†<code>ExecutorService</code>æ¥å£ä¸­çš„å¤§éƒ¨åˆ†æ–¹æ³•ï¼Œä¸è¿‡å¤§éƒ¨åˆ†çš„å®ç°éƒ½ä¾èµ–äº<code>Executor</code>æ¥å£å£°æ˜çš„<code>execute</code>æ–¹æ³•ï¼Œè€Œè¿™é‡Œå¹¶æ²¡æœ‰å®ç°è¿™ä¸ªå…³é”®çš„æ–¹æ³•ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªæ–¹æ³•çš„å®ç°äº¤ç»™äº†å­ç±»ï¼Œä¹Ÿå°±æ˜¯<code>java.util.concurrent.ThreadPoolExecutor</code>æ¥å®ç°äº†ã€‚</p>
<a id="more"></a>
<ul>
<li><code>Worker</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ThreadPoolExecutorå†…éƒ¨ç±»</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></div><div class="line">&#123;</div><div class="line">   Worker(Runnable firstTask) &#123;</div><div class="line">            setState(-<span class="number">1</span>); <span class="comment">// inhibit interrupts until runWorker</span></div><div class="line">            <span class="keyword">this</span>.firstTask = firstTask;</div><div class="line">            <span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Delegates main run loop to outer runWorker  */</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            runWorker(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Worker</code>ï¼Œæ¯ä¸€ä¸ª<code>Worker</code>å¯¹è±¡ä»£è¡¨äº†ä¸€ä¸ªçº¿ç¨‹ï¼ŒåŒæ—¶ä¹Ÿæ˜¯çœŸæ­£è´Ÿè´£æ‰§è¡Œä»»åŠ¡çš„å¯¹è±¡ã€‚</p>
<h3 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></div><div class="line">                              <span class="keyword">int</span> maximumPoolSize,</div><div class="line">                              <span class="keyword">long</span> keepAliveTime,</div><div class="line">                              TimeUnit unit,</div><div class="line">                              BlockingQueue&lt;Runnable&gt; workQueue) &#123;</div><div class="line">        <span class="keyword">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</div><div class="line">             Executors.defaultThreadFactory(), defaultHandler);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">.......çœç•¥........</div><div class="line">   </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></div><div class="line">                              <span class="keyword">int</span> maximumPoolSize,</div><div class="line">                              <span class="keyword">long</span> keepAliveTime,</div><div class="line">                              TimeUnit unit,</div><div class="line">                              BlockingQueue&lt;Runnable&gt; workQueue,</div><div class="line">                              ThreadFactory threadFactory,</div><div class="line">                              RejectedExecutionHandler handler) &#123;</div><div class="line">        <span class="keyword">if</span> (corePoolSize &lt; <span class="number">0</span> ||</div><div class="line">            maximumPoolSize &lt;= <span class="number">0</span> ||</div><div class="line">            maximumPoolSize &lt; corePoolSize ||</div><div class="line">            keepAliveTime &lt; <span class="number">0</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</div><div class="line">        <span class="keyword">if</span> (workQueue == <span class="keyword">null</span> || threadFactory == <span class="keyword">null</span> || handler == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">        <span class="keyword">this</span>.corePoolSize = corePoolSize;</div><div class="line">        <span class="keyword">this</span>.maximumPoolSize = maximumPoolSize;</div><div class="line">        <span class="keyword">this</span>.workQueue = workQueue;</div><div class="line">        <span class="keyword">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</div><div class="line">        <span class="keyword">this</span>.threadFactory = threadFactory;</div><div class="line">        <span class="keyword">this</span>.handler = handler;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>corePoolSize</code>ï¼šæ ¸å¿ƒæ± çš„å¤§å°ï¼Œåœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ± ä¸­å¹¶æ²¡æœ‰ä»»ä½•çº¿ç¨‹ï¼Œè€Œæ˜¯ç­‰å¾…æœ‰ä»»åŠ¡åˆ°æ¥æ‰åˆ›å»ºçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œå½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®è¾¾åˆ°<code>corePoolSize</code>åï¼Œå°±ä¼šæŠŠåˆ°è¾¾çš„ä»»åŠ¡æ”¾åˆ°ç¼“å­˜é˜Ÿåˆ—å½“ä¸­ã€‚åªæœ‰å½“å·¥ä½œé˜Ÿåˆ—æ»¡äº†çš„æƒ…å†µä¸‹æ‰ä¼šåˆ›å»ºè¶…å‡ºè¿™ä¸ªæ•°é‡çš„çº¿ç¨‹ã€‚å¦‚æœæŸä¸ªçº¿ç¨‹çš„ç©ºé—²æ—¶é—´è¶…è¿‡äº†æ´»åŠ¨æ—¶é—´ï¼Œé‚£ä¹ˆå°†æ ‡è®°ä¸ºå¯å›æ”¶ï¼Œå¹¶ä¸”åªæœ‰å½“çº¿ç¨‹æ± çš„å½“å‰å¤§å°è¶…è¿‡<code>corePoolSize</code>æ—¶è¯¥çº¿ç¨‹æ‰ä¼šè¢«ç»ˆæ­¢ã€‚ç”¨æˆ·å¯è°ƒç”¨<code>prestartAllCoreThreads()</code>æˆ–è€…<code>prestartCoreThread()</code>æ–¹æ³•é¢„å…ˆåˆ›å»ºçº¿ç¨‹ï¼Œå³åœ¨æ²¡æœ‰ä»»åŠ¡åˆ°æ¥ä¹‹å‰å°±åˆ›å»º<code>corePoolSize</code>ä¸ªçº¿ç¨‹æˆ–è€…ä¸€ä¸ªçº¿ç¨‹ã€‚</li>
<li><code>maximumPoolSize</code>ï¼šçº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°ï¼Œè¿™ä¸ªå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å‚æ•°ï¼Œå®ƒè¡¨ç¤ºåœ¨çº¿ç¨‹æ± ä¸­æœ€å¤šèƒ½åˆ›å»ºå¤šå°‘ä¸ªçº¿ç¨‹ï¼›å½“å¤§äºäº†è¿™ä¸ªå€¼å°±ä¼šå°†<code>Thread</code>ç”±ä¸€ä¸ªä¸¢å¼ƒå¤„ç†æœºåˆ¶æ¥å¤„ç†ã€‚</li>
<li><code>keepAliveTime</code>ï¼šè¡¨ç¤ºçº¿ç¨‹æ²¡æœ‰ä»»åŠ¡æ‰§è¡Œæ—¶æœ€å¤šä¿æŒå¤šä¹…æ—¶é—´ä¼šç»ˆæ­¢ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å¤§äº<code>corePoolSize</code>æ—¶ï¼Œ<code>keepAliveTime</code>æ‰ä¼šèµ·ä½œç”¨ï¼Œç›´åˆ°çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸å¤§äº<code>corePoolSize</code>ï¼Œå³å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å¤§äº<code>corePoolSize</code>æ—¶ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹ç©ºé—²çš„æ—¶é—´è¾¾åˆ°<code>keepAliveTime</code>ï¼Œåˆ™ä¼šç»ˆæ­¢ï¼Œç›´åˆ°çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸è¶…è¿‡<code>corePoolSize</code>ã€‚ä½†æ˜¯å¦‚æœè°ƒç”¨äº†<code>allowCoreThreadTimeOut(boolean)</code>æ–¹æ³•ï¼Œåœ¨çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸å¤§äº<code>corePoolSize</code>æ—¶ï¼Œ<code>keepAliveTime</code>å‚æ•°ä¹Ÿä¼šèµ·ä½œç”¨ï¼Œç›´åˆ°çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸º0ï¼›</li>
<li><code>Unit</code>ï¼šå‚æ•°<code>keepAliveTime</code>çš„æ—¶é—´å•ä½ï¼Œæœ‰7ç§å–å€¼ï¼Œåœ¨<code>TimeUnit</code>ç±»ä¸­æœ‰7ç§é™æ€å±æ€§ã€‚</li>
<li><code>workQueue</code>ï¼šä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜å‚¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®è¾¾åˆ°<code>corePoolSize</code>åï¼Œå°±ä¼šæŠŠåˆ°è¾¾çš„ä»»åŠ¡æ”¾åˆ°ç¼“å­˜é˜Ÿåˆ—å½“ä¸­ã€‚</li>
<li><code>threadFactory</code>ï¼šçº¿ç¨‹å·¥å‚ï¼Œä¸»è¦ç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼›</li>
<li><code>handler</code>ï¼šè¡¨ç¤ºå½“æ‹’ç»å¤„ç†ä»»åŠ¡æ—¶çš„ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯å‚æ•°<code>maximumPoolSize</code>è¾¾åˆ°åä¸¢å¼ƒå¤„ç†çš„æ–¹æ³•ã€‚æœ‰ä»¥ä¸‹å››ç§å–å€¼ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ThreadPoolExecutor.AbortPolicy:ä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸ã€‚ </div><div class="line">ThreadPoolExecutor.DiscardPolicyï¼šä¹Ÿæ˜¯ä¸¢å¼ƒä»»åŠ¡ï¼Œä½†æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸ã€‚ </div><div class="line">ThreadPoolExecutor.DiscardOldestPolicyï¼šä¸¢å¼ƒé˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡ï¼Œç„¶åé‡æ–°å°è¯•æ‰§è¡Œä»»åŠ¡ï¼ˆé‡å¤æ­¤è¿‡ç¨‹ï¼‰</div><div class="line">ThreadPoolExecutor.CallerRunsPolicyï¼šç”±è°ƒç”¨çº¿ç¨‹å¤„ç†è¯¥ä»»åŠ¡</div></pre></td></tr></table></figure>
<p>ç”¨æˆ·ä¹Ÿå¯ä»¥å®ç°æ¥å£<code>RejectedExecutionHandler</code>å®šåˆ¶è‡ªå·±çš„ç­–ç•¥ã€‚</p>
<h3 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h3><p>æŒ‰ç…§ä¸‹é¢çš„å‡ ä¸ªæ–¹é¢æ¥é˜…è¯»jdkçš„æºç ï¼š</p>
<ol>
<li>çº¿ç¨‹æ± çš„çŠ¶æ€</li>
<li>çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œ</li>
<li>çº¿ç¨‹æ± å…³é—­</li>
<li>çº¿ç¨‹å®¹é‡åŠ¨æ€è°ƒæ•´</li>
</ol>
<h4 id="çº¿ç¨‹æ± çš„çŠ¶æ€"><a href="#çº¿ç¨‹æ± çš„çŠ¶æ€" class="headerlink" title="çº¿ç¨‹æ± çš„çŠ¶æ€"></a>çº¿ç¨‹æ± çš„çŠ¶æ€</h4><p>è·Ÿçº¿ç¨‹æ± çŠ¶æ€æœ‰å…³çš„å‡ ä¸ªå±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">AtomicInteger ctl; <span class="comment">// çŠ¶æ€è®¡æ•°å™¨</span></div><div class="line"><span class="keyword">int</span> RUNNING; <span class="comment">// è¿è¡ŒçŠ¶æ€</span></div><div class="line"><span class="keyword">int</span> SHUTDOWN ;<span class="comment">// å…³é—­çŠ¶æ€</span></div><div class="line"><span class="keyword">int</span> STOP; <span class="comment">// åœæ­¢çŠ¶æ€</span></div><div class="line"><span class="keyword">int</span> TIDYING; <span class="comment">// æ•´ç†çŠ¶æ€</span></div><div class="line"><span class="keyword">int</span> TERMINATED; <span class="comment">//ç»“æŸçŠ¶æ€</span></div></pre></td></tr></table></figure>
<ul>
<li><code>ctl</code>ï¼šæ ‡è¯†çº¿ç¨‹æ± å½“å‰çŠ¶æ€å’Œçº¿ç¨‹æ•°çš„ï¼Œè¿™é‡Œè¦ç‰¹åˆ«æ³¨æ„ï¼Œè¿™ä¸ªå±æ€§æŠŠä¸¤ä¸ªå˜é‡æ‰“åŒ…æˆä¸€ä¸ªå˜é‡äº†ï¼Œé€šè¿‡è¿™ä¸ªå±æ€§å¯ä»¥è®¡ç®—å¾—å‡ºç›®å‰çš„çº¿ç¨‹æ•°å’Œçº¿ç¨‹æ± å½“å‰çš„çŠ¶æ€ã€‚</li>
<li><p><code>RUNNING</code>ï¼šæ­£åœ¨å¤„ç†ä»»åŠ¡å’Œæ¥å—é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</p>
</li>
<li><p><code>SHUTDOWN</code>ï¼šä¸å†æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä¼šç»§ç»­å¤„ç†å®Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</p>
</li>
</ul>
<ul>
<li><code>STOP</code>ï¼šä¸å†æ¥å—æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸ç»§ç»­å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¼šä¸­æ­¢æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ã€‚</li>
</ul>
<ul>
<li><code>TIDYING</code>ï¼šæ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»å¤„ç†ç»“æŸï¼Œç›®å‰<code>worker</code>æ•°ä¸º0ï¼Œå½“çº¿ç¨‹æ± è¿›å…¥è¿™ä¸ªçŠ¶æ€çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨<code>terminated()</code>æ–¹æ³•ã€‚</li>
</ul>
<ul>
<li><code>TERMINATED</code>ï¼šçº¿ç¨‹æ± å·²ç»å…¨éƒ¨ç»“æŸï¼Œå¹¶ä¸”<code>terminated()</code>æ–¹æ³•æ‰§è¡Œå®Œæˆã€‚</li>
</ul>
<h4 id="çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œ"><a href="#çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œ" class="headerlink" title="çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œ"></a>çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (command == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Proceed in 3 steps:</div><div class="line">         *</div><div class="line">         * 1. If fewer than corePoolSize threads are running, try to</div><div class="line">         * start a new thread with the given command as its first</div><div class="line">         * task.  The call to addWorker atomically checks runState and</div><div class="line">         * workerCount, and so prevents false alarms that would add</div><div class="line">         * threads when it shouldn't, by returning false.</div><div class="line">         *</div><div class="line">         * 2. If a task can be successfully queued, then we still need</div><div class="line">         * to double-check whether we should have added a thread</div><div class="line">         * (because existing ones died since last checking) or that</div><div class="line">         * the pool shut down since entry into this method. So we</div><div class="line">         * recheck state and if necessary roll back the enqueuing if</div><div class="line">         * stopped, or start a new thread if there are none.</div><div class="line">         *</div><div class="line">         * 3. If we cannot queue task, then we try to add a new</div><div class="line">         * thread.  If it fails, we know we are shut down or saturated</div><div class="line">         * and so reject the task.</div><div class="line">         */</div><div class="line">        <span class="keyword">int</span> c = ctl.get();</div><div class="line">        <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</div><div class="line">            <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            c = ctl.get();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</div><div class="line">            <span class="keyword">int</span> recheck = ctl.get();</div><div class="line">            <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</div><div class="line">                reject(command);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</div><div class="line">                addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</div><div class="line">            reject(command);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆåˆ¤æ–­äº†ä¼ å…¥çš„æŒ‡ä»¤å¯¹è±¡æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºå°±ä¸ç”¨æ‰§è¡Œäº†ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœæŒ‡ä»¤å¯¹è±¡ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆå°±çœŸæ­£è¿›å…¥çº¿ç¨‹ä»»åŠ¡çš„é€»è¾‘ï¼Œä¸€å…±åˆ†ä¸º3æ­¥æ¥å¤„ç†ï¼š</p>
<ul>
<li>æ£€æŸ¥å½“å‰çº¿ç¨‹æ€»æ•°ï¼Œå¦‚æœä½äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œè¿™ä¸ªä»»åŠ¡</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> c = ctl.get();</div><div class="line"><span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</div><div class="line">    <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</div><div class="line">    	<span class="keyword">return</span>;</div><div class="line">    c = ctl.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œ<code>workerCountOf(c)</code>å¯ä»¥ä»è®¡æ•°å™¨(clt)çš„ç»“æœä¸­è®¡ç®—å‡ºå½“å‰çº¿ç¨‹æ•°ã€‚</p>
<p><code>addWorker(command, true)</code>ä¼šæ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€å’Œæ€»çº¿ç¨‹æ•°ï¼Œå¹¶ç¡®å®šæ˜¯å¦åˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¦‚æœåˆ›å»ºäº†æ–°çº¿ç¨‹æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œåˆ™è¿”å›trueï¼Œå¦‚æœæ²¡æœ‰åˆ›å»ºæ–°çº¿ç¨‹ï¼Œåˆ™è¿”å›falseã€‚</p>
<ul>
<li>å°è¯•æŠŠä»»åŠ¡æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¹¶ä¸”é‡æ–°æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± å·²ç»ä¸æ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œåˆ™ç§»é™¤è¿™ä¸ªä»»åŠ¡ï¼Œå¹¶è½¬å…¥æ‹’ç»ç­–ç•¥ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</div><div class="line">	<span class="keyword">int</span> recheck = ctl.get();</div><div class="line">	<span class="keyword">if</span> (!isRunning(recheck) &amp;&amp; remove(command))</div><div class="line">		reject(command);</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</div><div class="line">	addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬¬äºŒæ­¥å…ˆæ£€æŸ¥äº†çº¿ç¨‹æ± å½“å‰æ˜¯å¦è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœæ˜¯è¿è¡ŒçŠ¶æ€çš„è¯ï¼Œåˆ™æ‰§è¡Œ<code>workQueue.offer(command)</code>æŠŠä»»åŠ¡æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚</p>
<p>ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ä¹‹åï¼Œä¼šå¤æŸ¥çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦RUNNINGï¼Œè¿™é‡Œéœ€è¦åšå¤æŸ¥çš„ä¸»è¦åŸå› æ˜¯åœ¨å‰é¢çš„æ£€æŸ¥ä¸­æ²¡æœ‰åŠ é”ï¼Œå› æ­¤å¯èƒ½åœ¨æ·»åŠ ä»»åŠ¡é˜Ÿåˆ—çš„è¿‡ç¨‹ï¼Œå…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†çº¿ç¨‹æ± çš„çŠ¶æ€ã€‚</p>
<p>å¦‚æœè¿™ä¸ªæ—¶å€™çº¿ç¨‹æ± çŠ¶æ€è¢«ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆå°±ä¼šæŠŠè¿™æ¬¡æ·»åŠ çš„ä»»åŠ¡ç§»é™¤<code>remove(command)</code>ï¼ŒåŒæ—¶å¯åŠ¨æ‹’ç»ç­–ç•¥<code>reject(command)</code>ã€‚</p>
<p>å¦‚æœçº¿ç¨‹æ± çŠ¶æ€æ²¡æœ‰è¢«æ”¹å˜ï¼Œåˆ™é‡æ–°æ£€æŸ¥å½“å‰æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœä¸º0åˆ™è°ƒç”¨<code>addWorker(null, false)</code>å»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡å¹¶æ‰§è¡Œï¼Œå¦‚æœä¸ä¸º0ï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œï¼Œç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œå½“å‰ä»»åŠ¡åè‡ªåŠ¨å»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–æ–°çš„ä»»åŠ¡å¹¶æ‰§è¡Œã€‚</p>
<ul>
<li>å¦‚æœä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™å°è¯•æ·»åŠ ä¸´æ—¶çº¿ç¨‹ï¼Œå¹¶æŠŠå½“ç„¶ä»»åŠ¡äº¤ç»™ä¸´æ—¶çº¿ç¨‹å¤„ç†ï¼Œå¦‚æœä¸´æ—¶çº¿ç¨‹ä¹Ÿæ»¡äº†ï¼Œåˆ™å¯åŠ¨æ‹’ç»ç­–ç•¥</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</div><div class="line">            reject(command);</div></pre></td></tr></table></figure>
<p>è¿™é‡Œå…ˆé€šè¿‡<code>addWorker(command, false)</code>å°è¯•æ·»åŠ ä¸´æ—¶çº¿ç¨‹ï¼Œå¦‚æœä¸´æ—¶çº¿ç¨‹åˆ›å»ºæˆåŠŸåˆ™ç”±ä¸´æ—¶çº¿ç¨‹æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œå¦‚æœä¸´æ—¶çº¿ç¨‹åˆ›å»ºå¤±è´¥ï¼Œåˆ™ä¼šè¿”å›falseï¼Œå¹¶è½¬å…¥æ‹’ç»ç­–ç•¥<code>reject(command)</code>ã€‚</p>
<h5 id="addWorker"><a href="#addWorker" class="headerlink" title="addWorker"></a><code>addWorker</code></h5><p>è¿™é‡Œæœ‰ä¸€ä¸ªé‡è¦çš„æ–¹æ³•<code>addWorker(Runnable firstTask, boolean core)</code>ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>&#123;</div><div class="line">        retry:</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">int</span> c = ctl.get();</div><div class="line">            <span class="keyword">int</span> rs = runStateOf(c);</div><div class="line"></div><div class="line">            <span class="comment">/** è¿™é‡Œè¿”å›falseæœ‰ä»¥ä¸‹å¯èƒ½ï¼š</span></div><div class="line">              * 1 çº¿ç¨‹æ± çŠ¶æ€å¤§äºSHUTDOWN</div><div class="line">              * 2 çº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWNï¼Œä½†firstTaskä¸ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯è¯´çº¿ç¨‹æ± å·²ç»SHUTDOWNï¼Œæ‹’ç»æ·»åŠ æ–°ä»»åŠ¡</div><div class="line">              * 3 çº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWNä¸”firstTaskä¸ºç©ºï¼Œä½†workQueueä¸ºç©ºï¼Œå³æ— ä»»åŠ¡éœ€è¦æ‰§è¡Œ</div><div class="line">              */</div><div class="line">            <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</div><div class="line">                ! (rs == SHUTDOWN &amp;&amp;</div><div class="line">                   firstTask == <span class="keyword">null</span> &amp;&amp;</div><div class="line">                   ! workQueue.isEmpty()))</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (;;) &#123;</div><div class="line">                <span class="keyword">int</span> wc = workerCountOf(c);</div><div class="line">                <span class="comment">/** è¿”å›falseæœ‰ä»¥ä¸‹å¯èƒ½ï¼š</span></div><div class="line">                  * 1 å·¥ä½œçº¿ç¨‹æ•°é‡è¶…è¿‡æœ€å¤§å®¹é‡</div><div class="line">                  * 2 coreä¸ºtrueï¼Œå·¥ä½œçº¿ç¨‹æ•°é‡è¶…è¿‡è¾¹ç•ŒcorePoolSize</div><div class="line">                  * 3 coreä¸ºfalse,å·¥ä½œçº¿ç¨‹æ•°é‡è¶…è¿‡è¾¹ç•ŒmaximumPoolSize</div><div class="line">                  */</div><div class="line">                <span class="keyword">if</span> (wc &gt;= CAPACITY ||</div><div class="line">                    wc &gt;= (core ? corePoolSize : maximumPoolSize))</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</div><div class="line">                    <span class="keyword">break</span> retry;<span class="comment">//ç›´æ¥è·³å‡ºæœ€å¤–å±‚å¾ªç¯</span></div><div class="line">                c = ctl.get();  <span class="comment">// Re-read ctl</span></div><div class="line">                <span class="keyword">if</span> (runStateOf(c) != rs)<span class="comment">//çº¿ç¨‹æ± çŠ¶æ€å‘ç”Ÿæ”¹å˜åˆ™ä»æœ€å¤–å±‚å¾ªç¯é‡æ–°å¼€å§‹</span></div><div class="line">                    <span class="keyword">continue</span> retry;</div><div class="line">                <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Worker w = <span class="keyword">new</span> Worker(firstTask);</div><div class="line">        Thread t = w.thread;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">        mainLock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// æŒæœ‰é”ä¹‹åéœ€è¦é‡æ–°æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼Œé˜²æ­¢ThreadFactoryè¿”å›å¤±è´¥æˆ–çº¿ç¨‹æ± åœ¨åŠ é”ä¹‹å‰è¢«å…³é—­</span></div><div class="line">            <span class="keyword">int</span> c = ctl.get();</div><div class="line">            <span class="keyword">int</span> rs = runStateOf(c);</div><div class="line">             <span class="comment">/** è¿”å›falseæœ‰ä»¥ä¸‹å¯èƒ½ï¼š</span></div><div class="line">               * 1 tä¸ºnull,è¯´æ˜ThreadFactoryåˆ›å»ºçº¿ç¨‹å¤±è´¥ï¼Œå¯èƒ½å‘ç”ŸOutOfMemoryError</div><div class="line">               * 2 çº¿ç¨‹æ± çŠ¶æ€å¤§äºSHUTDOWN</div><div class="line">               * 3 çº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWNï¼Œä½†firstTaskä¸ä¸ºç©º</div><div class="line">               */</div><div class="line">            <span class="keyword">if</span> (t == <span class="keyword">null</span> ||</div><div class="line">                (rs &gt;= SHUTDOWN &amp;&amp;</div><div class="line">                 ! (rs == SHUTDOWN &amp;&amp;</div><div class="line">                    firstTask == <span class="keyword">null</span>))) &#123;</div><div class="line">                decrementWorkerCount();</div><div class="line">                tryTerminate();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            workers.add(w);</div><div class="line"></div><div class="line">            <span class="keyword">int</span> s = workers.size();</div><div class="line">            <span class="keyword">if</span> (s &gt; largestPoolSize)</div><div class="line">                largestPoolSize = s;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            mainLock.unlock();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        t.start();</div><div class="line">        <span class="comment">// åœ¨çº¿ç¨‹æ± å˜ä¸ºstopæœŸé—´ï¼Œçº¿ç¨‹å¯èƒ½å·²ç»è¢«æ·»åŠ åˆ°workersï¼Œä½†è¿˜æœªè¢«å¯åŠ¨ï¼ˆè¯¥ç°è±¡ä¸å¤ªå¯èƒ½å‘ç”Ÿï¼Œè¿™å¯èƒ½</span></div><div class="line">        <span class="comment">// å¯¼è‡´ç½•è§çš„ä¸¢å¤±ä¸­æ–­ï¼Œå› ä¸ºThread.interruptä¸èƒ½ä¿è¯å¯¹éå¯åŠ¨çŠ¶æ€çš„çº¿ç¨‹æœ‰æ•ˆ</span></div><div class="line">        <span class="keyword">if</span> (runStateOf(ctl.get()) == STOP &amp;&amp; ! t.isInterrupted())</div><div class="line">            t.interrupt();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>addWorkeré¦–å…ˆä¼šæ£€æŸ¥å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€å’Œç»™å®šçš„è¾¹ç•Œæ˜¯å¦å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„workerï¼Œåœ¨æ­¤æœŸé—´ä¼šå¯¹workersçš„æ•°é‡è¿›è¡Œé€‚å½“è°ƒæ•´ï¼›å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œå°†åˆ›å»ºä¸€ä¸ªæ–°çš„workerå¹¶å¯åŠ¨ï¼Œä»¥å‚æ•°ä¸­çš„firstTaskä½œä¸ºworkerçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ã€‚</p>
<ul>
<li><code>addWorker</code>æ–¹æ³•å‚æ•°ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Runnable firstTask; // è¡¨ç¤ºæ–°å»ºçš„çº¿ç¨‹çš„ç¬¬ä¸€ä¸ªä»»åŠ¡</div><div class="line">boolean core; // æ˜¯å¦ä»¥æ ¸å¿ƒçº¿ç¨‹æ•°ä¸ºè¾¹ç•Œï¼Œå¦‚æœä¼ å…¥trueï¼Œè¡¨ç¤ºä»¥æ ¸å¿ƒçº¿ç¨‹æ•°ä¸ºè¾¹ç•Œï¼Œå½“å‰çº¿ç¨‹è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°åˆ™ä¸åˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¦‚æœä¸ä½¿ç”¨æ ¸å¿ƒçº¿ç¨‹æ•°ä¸ºè¾¹ç•Œï¼Œåˆ™ä¼šä»¥æœ€å¤§çº¿ç¨‹æ•°ä¸ºè¾¹ç•Œ</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬ä¸€æ­¥å°±æ˜¯æ£€æŸ¥çº¿ç¨‹æ± å½“å‰çš„çŠ¶æ€:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> c = ctl.get();</div><div class="line"><span class="keyword">int</span> rs = runStateOf(c);</div><div class="line"></div><div class="line"><span class="comment">// Check if queue empty only if necessary.</span></div><div class="line"><span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</div><div class="line">	! (rs == SHUTDOWN &amp;&amp;</div><div class="line">		firstTask == <span class="keyword">null</span> &amp;&amp;</div><div class="line">		! workQueue.isEmpty()))</div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div></pre></td></tr></table></figure>
<p>å¦‚æœå·²ç»ä¸å…è®¸æ¥å—æ–°ä»»åŠ¡äº†ï¼Œè¿™é‡Œå°±ç›´æ¥è¿”å›äº†ï¼Œå¦‚æœå…è®¸æ¥å—æ–°ä»»åŠ¡çš„è¯ï¼Œä¼šç»§ç»­æ‰§è¡Œ</p>
<ul>
<li>æ£€æŸ¥æ˜¯å¦è¦æ±‚ä½¿ç”¨æ ¸å¿ƒçº¿ç¨‹æ•°ä¸ºè¾¹ç•Œï¼Œå¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œåˆ™ç›´æ¥è¿”å›false</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (;;) &#123;</div><div class="line">	<span class="keyword">int</span> wc = workerCountOf(c);</div><div class="line">	<span class="keyword">if</span> (wc &gt;= CAPACITY ||</div><div class="line">		wc &gt;= (core ? corePoolSize : maximumPoolSize))</div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</div><div class="line">		<span class="keyword">break</span> retry;</div><div class="line">	c = ctl.get();  <span class="comment">// Re-read ctl</span></div><div class="line">	<span class="keyword">if</span> (runStateOf(c) != rs)</div><div class="line">		<span class="keyword">continue</span> retry;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œåˆ™ä¼šæ‰§è¡Œ<code>compareAndIncrementWorkerCount(c)</code>ç»™è®¡æ•°å™¨åŠ 1ï¼ŒåŒæ—¶è·³å‡ºå¾ªç¯ï¼Œæ‰§è¡Œä¸‹ä¸€æ­¥ï¼Œå¦‚æœè®¡æ•°å™¨æ·»åŠ å¤±è´¥ï¼Œä¼šå†æ¬¡è®¡ç®—çº¿ç¨‹æ± å½“å‰çŠ¶æ€æ˜¯å¦RUNNINGï¼Œå¦‚æœçº¿ç¨‹æ± è¿˜åœ¨RUNNINGçŠ¶æ€ï¼Œåˆ™ç»§ç»­é‡è¯•ã€‚</p>
<ul>
<li>å‰é¢å·²ç»æ·»åŠ äº†çº¿ç¨‹æ•°äº†ï¼Œé‚£ä¹ˆä¸‹ä¸€æ­¥å°±å¼€å§‹åˆ›å»ºæ–°çº¿ç¨‹äº†ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">w = <span class="keyword">new</span> Worker(firstTask);</div><div class="line"><span class="keyword">final</span> Thread t = w.thread;</div></pre></td></tr></table></figure>
<p>ä¸€ä¸ª<code>Worker</code>å¯¹è±¡è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯åˆ›å»ºä¸€ä¸ª<code>Worker</code>å¯¹è±¡ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œå¹¶ä»¥è‡ªå·±ä½œä¸ºçº¿ç¨‹çš„è¿è¡Œå¯¹è±¡(<code>Worker</code>è‡ªå·±ä¹Ÿæ˜¯<code>Runnable</code>çš„å®ç°ç±»)ã€‚</p>
<ul>
<li>åˆ›å»ºäº†<code>Worker</code>å¯¹è±¡ä¹‹åï¼Œéœ€è¦å¯¹çº¿ç¨‹æ± åšä¸€ç³»åˆ—çš„æ£€æŸ¥ï¼Œå¹¶å°†è¿™ä¸ªå¯¹è±¡åŠ å…¥åˆ°çº¿ç¨‹æ± ä¸­</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">mainLock.lock();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">	<span class="keyword">int</span> rs = runStateOf(ctl.get());</div><div class="line">	<span class="keyword">if</span> (rs &lt; SHUTDOWN ||</div><div class="line">	(rs == SHUTDOWN &amp;&amp; firstTask == <span class="keyword">null</span>)) &#123;</div><div class="line">		<span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</div><div class="line">		workers.add(w);</div><div class="line">		<span class="keyword">int</span> s = workers.size();</div><div class="line">		<span class="keyword">if</span> (s &gt; largestPoolSize)</div><div class="line">			largestPoolSize = s;</div><div class="line">		workerAdded = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">	mainLock.unlock();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œé¦–å…ˆè·å–çº¿ç¨‹æ± çš„ä¸»é”ï¼Œä¿è¯åœ¨æ·»åŠ çº¿ç¨‹çš„è¿‡ç¨‹ä¸å—å…¶ä»–çº¿ç¨‹å¹²æ‰°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mainLock.lock();</div></pre></td></tr></table></figure>
<p>ç„¶åæ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€å’Œçº¿ç¨‹çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± å„ä¸ªçŠ¶æ€éƒ½æ˜¯æ­£å¸¸çš„ï¼Œå¯ä»¥æŠŠçº¿ç¨‹åŠ å…¥åˆ°çº¿ç¨‹æ± ä¸­ï¼Œåˆ™ä¼šæŠŠçº¿ç¨‹æ± åŠ å…¥çº¿ç¨‹æ± ï¼Œå¹¶å°†çº¿ç¨‹æ·»åŠ çŠ¶æ€è®¾ç½®ä¸ºtrue:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">workers.add(w);</div><div class="line"><span class="comment">// ... çœç•¥è‹¥å¹²ä»£ç </span></div><div class="line">workerAdded = <span class="keyword">true</span>;</div></pre></td></tr></table></figure>
<p>æœ€åé‡Šæ”¾é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">finally</span> &#123;</div><div class="line">	mainLock.unlock();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œè¦ç‰¹åˆ«æ³¨æ„ï¼Œé”ä¸€å®šè¦åœ¨<code>finally</code>ä»£ç å—ä¸­é‡Šæ”¾ï¼Œä¸ç„¶å¾ˆå®¹æ˜“é€ æˆæ­»é”ã€‚</p>
<ul>
<li>æœ€åï¼Œåˆ¤æ–­çº¿ç¨‹æ˜¯å¦å·²ç»åŠ å…¥çº¿ç¨‹æ± ä¸­ï¼Œå¦‚æœå·²ç»åŠ å…¥çº¿ç¨‹æ± ä¸­ï¼Œåˆ™å¯åŠ¨çº¿ç¨‹ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (workerAdded) &#123;</div><div class="line">	t.start();</div><div class="line">	workerStarted = <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>åœ¨æœ€ååˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¯åŠ¨ï¼Œå¦‚æœçº¿ç¨‹æ²¡æœ‰å¯åŠ¨ï¼Œåˆ™ä¼šåšå›æ»šï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">finally</span> &#123;</div><div class="line">	<span class="keyword">if</span> (!workerStarted)</div><div class="line">		addWorkerFailed(w);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="reject"><a href="#reject" class="headerlink" title="reject"></a><code>reject</code></h5><p>è¿™ä¸ªæ–¹æ³•æ˜¯è°ƒç”¨çº¿ç¨‹æ± çš„æ‹’ç»å¤„ç†ç­–ç•¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">final void reject(Runnable command) &#123;</div><div class="line">        handler.rejectedExecution(command, this);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“ç„¶è¿™ä¸ªç­–ç•¥å¯ä»¥é€šè¿‡æˆ‘ä»¬è‡ªå·±ä¼ å…¥çš„å¯¹è±¡æ¥å¤„ç†ï¼Œé»˜è®¤ä½¿ç”¨<code>AbortPolicy</code>å¤„ç†ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<h5 id="workerçº¿ç¨‹è¿è¡Œ"><a href="#workerçº¿ç¨‹è¿è¡Œ" class="headerlink" title="workerçº¿ç¨‹è¿è¡Œ"></a><code>worker</code>çº¿ç¨‹è¿è¡Œ</h5><p>è¿™é‡Œå°±æ¶‰åŠåˆ°<code>Worker</code>çš„<code>run</code>æ–¹æ³•å®ç°äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">	runWorker(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†<code>java.util.concurrent.ThreadPoolExecutor</code>çš„<code>runWorker(Worker w)</code>æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>&#123;</div><div class="line">        Thread wt = Thread.currentThread();</div><div class="line">        Runnable task = w.firstTask;</div><div class="line">        w.firstTask = <span class="keyword">null</span>;</div><div class="line">        w.unlock(); <span class="comment">// allow interrupts</span></div><div class="line">        <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) &#123;</div><div class="line">                w.lock();</div><div class="line">                <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</div><div class="line">                     (Thread.interrupted() &amp;&amp;</div><div class="line">                      runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</div><div class="line">                    !wt.isInterrupted())</div><div class="line">                    wt.interrupt();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    beforeExecute(wt, task);</div><div class="line">                    Throwable thrown = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        task.run();</div><div class="line">                    &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</div><div class="line">                        thrown = x; <span class="keyword">throw</span> x;</div><div class="line">                    &#125; <span class="keyword">catch</span> (Error x) &#123;</div><div class="line">                        thrown = x; <span class="keyword">throw</span> x;</div><div class="line">                    &#125; <span class="keyword">catch</span> (Throwable x) &#123;</div><div class="line">                        thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        afterExecute(task, thrown);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    task = <span class="keyword">null</span>;</div><div class="line">                    w.completedTasks++;</div><div class="line">                    w.unlock();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            completedAbruptly = <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            processWorkerExit(w, completedAbruptly);</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œé¦–å…ˆè°ƒç”¨Workerçš„unlock()æ–¹æ³•ï¼Œå…è®¸è¿™ä¸ªçº¿ç¨‹è¢«ä¸­æ–­ï¼Œç„¶åè¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯å†…éƒ¨åšäº†å‡ ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>è·å–è¦æ‰§è¡Œçš„ä»»åŠ¡</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>)</div></pre></td></tr></table></figure>
<p>è¿™é‡Œåˆ¤æ–­æ˜¯å¦æœ‰ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œå¦‚æœæœ‰ç¬¬ä¸€ä¸ªä»»åŠ¡åˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œå¦‚æœæ²¡æœ‰ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œåˆ™ä½¿ç”¨<code>getTask()</code>è·å¾—æ–°ä»»åŠ¡ï¼Œ<strong><code>getTask()</code>æ˜¯ä¸€ä¸ªé‡è¦çš„æ–¹æ³•ï¼Œå¦‚æœè·å–ä¸åˆ°ä»»åŠ¡çš„è¯ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šé˜»å¡å¹¶ç­‰å¾…ä»»åŠ¡</strong>ï¼Œåè¾¹è¯¦ç»†çœ‹è¿™ä¸ªæ–¹æ³•ã€‚</p>
<ul>
<li>è·å–å½“å‰çº¿ç¨‹çš„é”ï¼Œæ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦å…è®¸è¿è¡Œ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">w.lock();</div><div class="line"><span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</div><div class="line">                     (Thread.interrupted() &amp;&amp;</div><div class="line">                      runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</div><div class="line">                    !wt.isInterrupted())</div><div class="line">                    wt.interrupt();</div></pre></td></tr></table></figure>
<ul>
<li>æ‰€æœ‰æ£€æŸ¥é€šè¿‡ä¹‹åï¼Œç¡®è®¤å½“å‰ä»»åŠ¡å¯ä»¥æ‰§è¡Œäº†ï¼Œå°±å¼€å§‹æ‰§è¡Œä»»åŠ¡</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">	beforeExecute(wt, task);</div><div class="line">	Throwable thrown = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		task.run();</div><div class="line">	&#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</div><div class="line">		thrown = x; <span class="keyword">throw</span> x;</div><div class="line">	&#125; <span class="keyword">catch</span> (Error x) &#123;</div><div class="line">		thrown = x; <span class="keyword">throw</span> x;</div><div class="line">	&#125; <span class="keyword">catch</span> (Throwable x) &#123;</div><div class="line">		thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		afterExecute(task, thrown);</div><div class="line">	&#125;</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">	task = <span class="keyword">null</span>;	</div><div class="line">	w.completedTasks++;</div><div class="line">	w.unlock();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰§è¡Œä»»åŠ¡çš„è¿‡ç¨‹ï¼Œå…ˆè°ƒç”¨äº†<code>beforeExecute(wt, task)</code>åšæ‰§è¡Œå‰å¤„ç†ï¼Œä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œè°ƒç”¨<code>afterExecute(task, thrown)</code>åšæ‰§è¡Œå®Œæˆåå¤„ç†ï¼Œè¿™é‡Œä¸»è¦æ˜¯ç•™ç»™å¼€å‘è€…æ‰©å±•ç”¨çš„ï¼Œé»˜è®¤ä¸åšä»»ä½•å¤„ç†ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦åšä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚è®¡ç®—ä»»åŠ¡æ‰§è¡Œæ—¶é—´ä¸€ç±»çš„ï¼Œå¯ä»¥é€šè¿‡ç»§æ‰¿<code>java.util.concurrent.ThreadPoolExecutor</code>å¹¶é‡å†™è¿™ä¸¤ä¸ªæ–¹æ³•æ¥å®ç°ã€‚</p>
<p>ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œåœ¨finallyä¸­é‡Šæ”¾äº†é”å¹¶ç»™å®Œæˆä»»åŠ¡è®¡æ•°å™¨åŠ 1ã€‚</p>
<h6 id="getTask"><a href="#getTask" class="headerlink" title="getTask()"></a>getTask()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Runnable <span class="title">getTask</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> timedOut = <span class="keyword">false</span>; <span class="comment">// Did the last poll() time out?</span></div><div class="line"></div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">int</span> c = ctl.get();</div><div class="line">            <span class="keyword">int</span> rs = runStateOf(c);</div><div class="line"></div><div class="line">            <span class="comment">// Check if queue empty only if necessary.</span></div><div class="line">            <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</div><div class="line">                decrementWorkerCount();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">int</span> wc = workerCountOf(c);</div><div class="line"></div><div class="line">            <span class="comment">// Are workers subject to culling?</span></div><div class="line">            <span class="keyword">boolean</span> timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</div><div class="line">                &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</div><div class="line">                <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Runnable r = timed ?</div><div class="line">                    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</div><div class="line">                    workQueue.take();</div><div class="line">                <span class="keyword">if</span> (r != <span class="keyword">null</span>)</div><div class="line">                    <span class="keyword">return</span> r;</div><div class="line">                timedOut = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</div><div class="line">                timedOut = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç®€å•è€Œè¨€å°±æ˜¯æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼Œåªè¦çº¿ç¨‹æ± è¿˜æ²¡æœ‰ç»ˆæ­¢ï¼Œè¿™é‡Œå°±å°±ä¼šæ— é™å¾ªç¯çŸ¥é“æŠ›å‡ºå¼‚å¸¸æˆ–è€…çº¿ç¨‹æ± ç»ˆæ­¢ï¼Œçº¿ç¨‹çš„é˜»å¡æ˜¯ç”¨<code>workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS)</code>æˆ–<code>workQueue.take()</code>å®ç°çš„ã€‚</p>
<h4 id="çº¿ç¨‹æ± å…³é—­"><a href="#çº¿ç¨‹æ± å…³é—­" class="headerlink" title="çº¿ç¨‹æ± å…³é—­"></a>çº¿ç¨‹æ± å…³é—­</h4><p>åœ¨<code>java.util.concurrent.ExecutorService</code>æ¥å£ä¸­æä¾›äº†å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>; <span class="comment">// ä¸ä¼šç«‹å³ç»ˆæ­¢çº¿ç¨‹æ± ï¼Œè€Œæ˜¯è¦ç­‰æ‰€æœ‰ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œåæ‰ç»ˆæ­¢ï¼Œä½†å†ä¹Ÿä¸ä¼šæ¥å—æ–°çš„ä»»åŠ¡</span></div><div class="line"><span class="function">List&lt;Runnable&gt; <span class="title">shutdownNow</span><span class="params">()</span></span>; <span class="comment">// ç«‹å³ç»ˆæ­¢çº¿ç¨‹æ± ï¼Œå¹¶å°è¯•æ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶ä¸”æ¸…ç©ºä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—ï¼Œè¿”å›å°šæœªæ‰§è¡Œçš„ä»»åŠ¡</span></div></pre></td></tr></table></figure>
<h4 id="çº¿ç¨‹æ± å®¹é‡çš„åŠ¨æ€è°ƒæ•´"><a href="#çº¿ç¨‹æ± å®¹é‡çš„åŠ¨æ€è°ƒæ•´" class="headerlink" title="çº¿ç¨‹æ± å®¹é‡çš„åŠ¨æ€è°ƒæ•´"></a>çº¿ç¨‹æ± å®¹é‡çš„åŠ¨æ€è°ƒæ•´</h4><p>åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å®¹é‡ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹æˆ‘ä»¬å·²ç»çŸ¥é“äº†ï¼Œåªè¦æ”¹å˜æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setCorePoolSize</span><span class="params">(<span class="keyword">int</span> corePoolSize)</span></span>;<span class="comment">// è°ƒæ•´æ ¸å¿ƒçº¿ç¨‹æ•°</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setMaximumPoolSize</span><span class="params">(<span class="keyword">int</span> maximumPoolSize)</span> </span>; <span class="comment">// è°ƒæ•´åŠ¨æ€çº¿ç¨‹æ•°</span></div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://kael-aiur.com/java/jdk%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0-ThreadPoolExecutor.html" target="_blank" rel="external">jdkçš„çº¿ç¨‹æ± å®ç°-ThreadPoolExecutor</a></p>
<p><a href="https://my.oschina.net/7001/blog/889931" target="_blank" rel="external">Javaçº¿ç¨‹æ± æ ¸å¿ƒå®ç°åŸç†å’Œæºç è§£æ</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[LinkedHashMap]]></title>
      <url>http://zsr.github.io/2017/04/27/LinkedHashMap/</url>
      <content type="html"><![CDATA[<h1 id="LinkedHashMap-æºç é˜…è¯»"><a href="#LinkedHashMap-æºç é˜…è¯»" class="headerlink" title="LinkedHashMap æºç é˜…è¯»"></a>LinkedHashMap æºç é˜…è¯»</h1><hr>
<h3 id="æ¦‚è¦"><a href="#æ¦‚è¦" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h3><ul>
<li>ç±»ç»§æ‰¿å…³ç³»</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public class LinkedHashMap&lt;K,V&gt;</div><div class="line">       extends HashMap&lt;K,V&gt;</div><div class="line">       implements Map&lt;K,V&gt;</div></pre></td></tr></table></figure>
<p><code>LinkedHashMap</code>ç»§æ‰¿è‡ª<code>HashMap</code></p>
<ul>
<li>æ ¸å¿ƒæˆå‘˜å˜é‡</li>
</ul>
<p>jdk 7:(ä¸‹æ–‡éƒ½æ˜¯è¯¥ç¯å¢ƒ)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * The head of the doubly linked list.</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Entry&lt;K,V&gt; header;   <span class="comment">//é“¾è¡¨å¤´ç»“ç‚¹</span></div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> accessOrder;   <span class="comment">//æŒ‰å…ƒç´ æ’å…¥é¡ºåº(é»˜è®¤)æˆ–å…ƒç´ æœ€è¿‘è®¿é—®é¡ºåº(LRU)æ’åˆ—</span></div></pre></td></tr></table></figure>
<p>jdk 8:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">transient</span> LinkedHashMap.Entry&lt;K,V&gt; head;   <span class="comment">//é“¾è¡¨å¤´ç»“ç‚¹</span></div><div class="line"></div><div class="line"><span class="keyword">transient</span> LinkedHashMap.Entry&lt;K,V&gt; tail;  <span class="comment">//é“¾è¡¨å°¾èŠ‚ç‚¹</span></div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> accessOrder;</div></pre></td></tr></table></figure>
<p>jdk 8ä¸­æ–°å¢äº†ä¸€ä¸ª<code>é“¾è¡¨å°¾èŠ‚ç‚¹</code></p>
<ul>
<li>ç‰¹ç‚¹</li>
</ul>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨çš„Mapä¸­çš„keyæ— åºï¼Œé€‰æ‹©<code>HashMap</code>ï¼›å¦‚æœè¦æ±‚keyæœ‰åºï¼Œåˆ™é€‰æ‹©<code>TreeMap</code>ã€‚<br>ä½†æ˜¯é€‰æ‹©<code>TreeMap</code>å°±ä¼šæœ‰æ€§èƒ½é—®é¢˜ï¼Œå› ä¸º<code>TreeMap</code>çš„getæ“ä½œçš„æ—¶é—´å¤æ‚åº¦æ˜¯<code>O(log(n))</code>çš„ï¼Œç›¸æ¯”äº<code>HashMap</code>çš„<code>O(1)</code>è¿˜æ˜¯å·®ä¸å°‘çš„ï¼Œ<code>LinkedHashMap</code>çš„å‡ºç°å°±æ˜¯ä¸ºäº†å¹³è¡¡è¿™äº›å› ç´ ï¼Œä½¿å¾—</p>
<blockquote>
<p>èƒ½å¤Ÿä»¥<code>O(1)</code>æ—¶é—´å¤æ‚åº¦å¢åŠ æŸ¥æ‰¾å…ƒç´ ï¼Œåˆèƒ½å¤Ÿä¿è¯keyçš„æœ‰åºæ€§</p>
</blockquote>
<p>æ­¤å¤–ï¼Œ<code>LinkedHashMap</code>æä¾›äº†ä¸¤ç§keyçš„é¡ºåºï¼š</p>
<blockquote>
<p>è®¿é—®é¡ºåºï¼ˆaccess orderï¼‰ï¼šéå¸¸å®ç”¨ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§é¡ºåºå®ç°LRUï¼ˆLeast Recently Usedï¼‰ç¼“å­˜</p>
<p>æ’å…¥é¡ºåºï¼ˆinsertion ordeï¼‰ï¼šåŒä¸€keyçš„å¤šæ¬¡æ’å…¥ï¼Œå¹¶ä¸ä¼šå½±å“å…¶é¡ºåº</p>
</blockquote>
<a id="more"></a>
<h3 id="è®¾è®¡åŸç†"><a href="#è®¾è®¡åŸç†" class="headerlink" title="è®¾è®¡åŸç†"></a>è®¾è®¡åŸç†</h3><ul>
<li><code>ç¯å‹åŒå‘é“¾è¡¨</code></li>
</ul>
<p><img src="https://img.alicdn.com/imgextra/i1/581166664/TB27MP7fXXXXXb6XXXXXXXXXXXX_!!581166664.png" alt="ç¯å‹åŒå‘é“¾è¡¨"></p>
<p><code>LinkedHashMap</code>ä¸­é‡‡ç”¨å°±æ˜¯è¿™ç§<code>ç¯å‹åŒå‘é“¾è¡¨</code></p>
<ul>
<li><code>LinkedHashMap</code> ç»“æ„å›¾</li>
</ul>
<p><img src="http://images2015.cnblogs.com/blog/939998/201605/939998-20160528192537725-909052596.png" alt="LinkedHashMap_base.png"></p>
<p>é‡‡ç”¨åŒå‘é“¾è¡¨ï¼ˆdoubly-linked listï¼‰çš„å½¢å¼å°†æ‰€æœ‰entryè¿æ¥èµ·æ¥ï¼Œè¿™æ ·æ˜¯ä¸ºä¿è¯å…ƒç´ çš„è¿­ä»£é¡ºåºè·Ÿæ’å…¥é¡ºåºç›¸åŒ;<code>header</code>æŒ‡å‘åŒå‘é“¾è¡¨çš„å¤´éƒ¨ï¼ˆæ˜¯ä¸€ä¸ªå“‘å…ƒï¼‰ï¼Œè¯¥åŒå‘é“¾è¡¨çš„è¿­ä»£é¡ºåºå°±æ˜¯entryçš„æ’å…¥é¡ºåºã€‚</p>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><ul>
<li>æ„é€ å‡½æ•°</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//accessOrderä¸ºtrueè¡¨ç¤ºè¯¥LinkedHashMapçš„keyä¸ºè®¿é—®é¡ºåº</span></div><div class="line"><span class="comment">//accessOrderä¸ºfalseè¡¨ç¤ºè¯¥LinkedHashMapçš„keyä¸ºæ’å…¥é¡ºåº</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> accessOrder;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(initialCapacity, loadFactor);</div><div class="line">    <span class="comment">//é»˜è®¤ä¸ºfalseï¼Œä¹Ÿå°±æ˜¯æ’å…¥é¡ºåº</span></div><div class="line">    accessOrder = <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(initialCapacity);</div><div class="line">    accessOrder = <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>();</div><div class="line">    accessOrder = <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(m);</div><div class="line">    accessOrder = <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></div><div class="line">                     <span class="keyword">float</span> loadFactor,</div><div class="line">                     <span class="keyword">boolean</span> accessOrder) &#123;</div><div class="line">    <span class="keyword">super</span>(initialCapacity, loadFactor);</div><div class="line">    <span class="keyword">this</span>.accessOrder = accessOrder;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Called by superclass constructors and pseudoconstructors (clone,</div><div class="line"> * readObject) before any entries are inserted into the map.  Initializes</div><div class="line"> * the chain.</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">    header = <span class="keyword">new</span> Entry&lt;&gt;(-<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">    <span class="comment">//é€šè¿‡è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼ŒLinkedHashMapé‡‡ç”¨çš„æ˜¯ç¯å‹çš„åŒå‘é“¾è¡¨</span></div><div class="line">    header.before = header.after = header;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å†…éƒ¨èŠ‚ç‚¹</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMap</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">// These fields comprise the doubly linked list used for iteration.</span></div><div class="line">    <span class="comment">//æ¯ä¸ªèŠ‚ç‚¹åŒ…å«ä¸¤ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å‰ç»§èŠ‚ç‚¹ä¸åç»§èŠ‚ç‚¹</span></div><div class="line">    Entry&lt;K,V&gt; before, after;</div><div class="line">    Entry(<span class="keyword">int</span> hash, K key, V value, HashMap.Entry&lt;K,V&gt; next) &#123;</div><div class="line">        <span class="keyword">super</span>(hash, key, value, next);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Removes this entry from the linked list.</div><div class="line">     */</div><div class="line">    <span class="comment">//åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œéœ€è¦æŠŠ</span></div><div class="line">    <span class="comment">//1. å‰ç»§èŠ‚ç‚¹çš„åç»§æŒ‡é’ˆ æŒ‡å‘ è¦åˆ é™¤èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></div><div class="line">    <span class="comment">//2. åç»§èŠ‚ç‚¹çš„å‰ç»§æŒ‡é’ˆ æŒ‡å‘ è¦åˆ é™¤èŠ‚ç‚¹çš„å‰ç»§èŠ‚ç‚¹</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</div><div class="line">        before.after = after;</div><div class="line">        after.before = before;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Inserts this entry before the specified existing entry in the list.</div><div class="line">     */</div><div class="line">    <span class="comment">//åœ¨æŸèŠ‚ç‚¹å‰æ’å…¥èŠ‚ç‚¹</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addBefore</span><span class="params">(Entry&lt;K,V&gt; existingEntry)</span> </span>&#123;</div><div class="line">        after  = existingEntry;</div><div class="line">        before = existingEntry.before;</div><div class="line">        before.after = <span class="keyword">this</span>;</div><div class="line">        after.before = <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * This method is invoked by the superclass whenever the value</div><div class="line">     * of a pre-existing entry is read by Map.get or modified by Map.set.</div><div class="line">     * If the enclosing Map is access-ordered, it moves the entry</div><div class="line">     * to the end of the list; otherwise, it does nothing.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">recordAccess</span><span class="params">(HashMap&lt;K,V&gt; m)</span> </span>&#123;</div><div class="line">        LinkedHashMap&lt;K,V&gt; lm = (LinkedHashMap&lt;K,V&gt;)m;</div><div class="line">        <span class="comment">// å¦‚æœéœ€è¦keyçš„è®¿é—®é¡ºåºï¼Œéœ€è¦æŠŠ</span></div><div class="line">        <span class="comment">// å½“å‰è®¿é—®çš„èŠ‚ç‚¹åˆ é™¤ï¼Œå¹¶æŠŠå®ƒæ’å…¥åˆ°åŒå‘é“¾è¡¨çš„å°¾éƒ¨</span></div><div class="line">        <span class="keyword">if</span> (lm.accessOrder) &#123;</div><div class="line">            lm.modCount++;</div><div class="line">            remove();</div><div class="line">            addBefore(lm.header);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">recordRemoval</span><span class="params">(HashMap&lt;K,V&gt; m)</span> </span>&#123;</div><div class="line">        remove();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Entry</code>ç»§æ‰¿è‡ª<code>HashMap.Entry</code>ï¼ŒåŒæ—¶å¢åŠ äº†æŒ‡å‘å‰ä¸€ä¸ªå’Œåä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨ã€‚</p>
<ul>
<li><code>put</code>æ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.addEntry(hash, key, value, bucketIndex);</div><div class="line">    <span class="comment">// Remove eldest entry if instructed</span></div><div class="line">    Entry&lt;K,V&gt; eldest = header.after;</div><div class="line">    <span class="comment">//å¦‚æœæœ‰å¿…è¦ç§»é™¤æœ€è€çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå°±ç§»é™¤ã€‚LinkedHashMapé»˜è®¤removeEldestEntryæ€»æ˜¯è¿”å›false</span></div><div class="line">    <span class="comment">//ä¹Ÿå°±æ˜¯è¿™é‡Œifé‡Œé¢çš„è¯­å¥æ°¸è¿œä¸ä¼šæ‰§è¡Œ</span></div><div class="line">    <span class="comment">//è¿™é‡ŒremoveEldestEntryä¸»è¦æ˜¯ç»™LinkedHashMapçš„å­ç±»ç•™ä¸‹çš„ä¸€ä¸ªé’©å­</span></div><div class="line">    <span class="comment">//å­ç±»å®Œå…¨å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦é‡å†™removeEldestEntryã€‚å¯ä»¥çœ‹ä¸‹æ–‡LRU cacheå®ç°ä¾‹å­</span></div><div class="line">    <span class="keyword">if</span> (removeEldestEntry(eldest)) &#123;</div><div class="line">        <span class="comment">//ä»è¿™é‡Œçœ‹ï¼Œæœ€ä¹…æœªè®¿é—®çš„èŠ‚ç‚¹æ˜¯å¤´éƒ¨èŠ‚ç‚¹</span></div><div class="line">        removeEntryForKey(eldest.key);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">createEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</div><div class="line">    HashMap.Entry&lt;K,V&gt; old = table[bucketIndex];</div><div class="line">    Entry&lt;K,V&gt; e = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, old);</div><div class="line">    table[bucketIndex] = e;</div><div class="line">    <span class="comment">//è¿™é‡ŒæŠŠæ–°å¢çš„EntryåŠ åˆ°äº†åŒå‘é“¾è¡¨çš„headerçš„å‰é¢ï¼Œæˆä¸ºæ–°çš„header</span></div><div class="line">    e.addBefore(header);</div><div class="line">    size++;</div><div class="line">&#125;   </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;K,V&gt; eldest)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢æ˜¯<code>LinkedHashMap</code>ä¸­é‡å†™äº†<code>HashMap</code>çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œå½“è°ƒç”¨<code>put</code>æ—¶æ·»åŠ <code>Entry</code>ï¼ˆæ–°å¢Entryä¹‹å‰ä¸å­˜åœ¨ï¼‰æ•´ä¸ªæ–¹æ³•è°ƒç”¨é“¾æ˜¯è¿™æ ·çš„ï¼š</p>
<blockquote>
<p><code>HashMap.put</code> -&gt; <code>LinkedHashMap.addEntry</code> -&gt;<br><code>HashMap.addEntry</code> -&gt; <code>LinkedHashMap.createEntry</code></p>
</blockquote>
<p>æ³¨æ„ï¼Œé€šè¿‡<code>addEntry()</code>æ–¹æ³•æ’å…¥æ–°çš„<code>entry</code>ï¼Œè¿™é‡Œçš„<strong>æ’å…¥æœ‰ä¸¤é‡å«ä¹‰</strong>ï¼š</p>
<ol>
<li>ä»<code>table</code>çš„è§’åº¦çœ‹ï¼Œæ–°çš„<code>entry</code>éœ€è¦æ’å…¥åˆ°å¯¹åº”çš„<code>bucket</code>é‡Œï¼Œå½“æœ‰å“ˆå¸Œå†²çªæ—¶ï¼Œé‡‡ç”¨å¤´æ’æ³•å°†æ–°çš„<code>entry</code>æ’å…¥åˆ°å†²çªé“¾è¡¨çš„å¤´éƒ¨ã€‚</li>
<li>ä»<code>header</code>çš„è§’åº¦çœ‹ï¼Œæ–°çš„<code>entry</code>éœ€è¦æ’å…¥åˆ°åŒå‘é“¾è¡¨çš„å°¾éƒ¨ã€‚</li>
</ol>
<p>ä¸Šè¿°ä»£ç ä¸­ç”¨åˆ°äº†<code>addBefore()</code>æ–¹æ³•å°†æ–°<code>entry e</code>æ’å…¥åˆ°åŒå‘é“¾è¡¨å¤´å¼•ç”¨<code>header</code>çš„å‰é¢ï¼Œè¿™æ ·<code>e</code>å°±æˆä¸ºåŒå‘é“¾è¡¨ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚<strong>å¤´ç»“ç‚¹ä»£è¡¨æœ€ä¹…æœªè®¿é—®çš„èŠ‚ç‚¹</strong>ã€‚</p>
<p><img src="http://images2015.cnblogs.com/blog/939998/201605/939998-20160528192545084-2117175891.png" alt="LinkedHashMap_addEntry.png"></p>
<ul>
<li><code>get</code>æ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">        Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)getEntry(key);</div><div class="line">        <span class="keyword">if</span> (e == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        <span class="comment">// å¦‚æœæ˜¯keyçš„è®¿é—®é¡ºåºï¼Œéœ€è¦æŠŠ</span></div><div class="line">        <span class="comment">// å½“å‰è®¿é—®çš„èŠ‚ç‚¹åˆ é™¤ï¼Œå¹¶æŠŠå®ƒæ’å…¥åˆ°åŒå‘é“¾è¡¨çš„å°¾éƒ¨</span></div><div class="line">        e.recordAccess(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">return</span> e.value;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="LRU-Cache"><a href="#LRU-Cache" class="headerlink" title="LRU Cache"></a>LRU Cache</h3><p>åˆ©ç”¨<code>LinkedHashMap</code>ç®€å•è§†çº¿LRU cache.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LRUCache</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> capacity;</div><div class="line">    <span class="keyword">private</span> Map&lt;Integer, Integer&gt; cache;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LRUCache</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.capacity = capacity;</div><div class="line">        <span class="comment">// access_orderä¸ºtrueï¼ŒæŒ‰è®¿é—®é¡ºåºæ’åº</span></div><div class="line">        <span class="keyword">this</span>.cache = <span class="keyword">new</span> java.util.LinkedHashMap&lt;Integer, Integer&gt; (capacity, <span class="number">0.75f</span>, <span class="keyword">true</span>) &#123;</div><div class="line">            <span class="comment">// å®šä¹‰putåçš„ç§»é™¤è§„åˆ™ï¼Œå¤§äºå®¹é‡å°±åˆ é™¤eldest</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;Integer, Integer&gt; eldest)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> size() &gt; capacity;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (cache.containsKey(key)) &#123;</div><div class="line">            <span class="keyword">return</span> cache.get(key);</div><div class="line">        &#125; <span class="keyword">else</span></div><div class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span> key, <span class="keyword">int</span> value)</span> </span>&#123;</div><div class="line">        cache.put(key, value);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[spring-rabbité…ç½®å¤šconnect-factory]]></title>
      <url>http://zsr.github.io/2017/04/12/spring-rabbit%E9%85%8D%E7%BD%AE%E5%A4%9Aconnect-factory/</url>
      <content type="html"><![CDATA[<p><strong>å¤šconnect-factoryæ—¶é…ç½®exchangeï¼Œ queueéœ€ä½¿ç”¨declared-by</strong></p>
<h3 id="èƒŒæ™¯ï¼š"><a href="#èƒŒæ™¯ï¼š" class="headerlink" title="èƒŒæ™¯ï¼š"></a>èƒŒæ™¯ï¼š</h3><p>é¡¹ç›®ä¸­éœ€è¦ç›‘å¬å¤šä¸ª<code>rabbitmq</code>æœåŠ¡å™¨æˆ–è€…å‘æ¶ˆæ¯åˆ°å¤šä¸ª<code>rabbitmq</code>æœåŠ¡å™¨ï¼Œé¡¹ç›®å¯åŠ¨æŠ¥é”™ã€‚ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Caused by: com.rabbitmq.client.ShutdownSignalException: channel error; protocol method: #method&lt;channel.close&gt;(reply-code=406, reply-text=PRECONDITION_FAILED - cannot redeclare exchange &apos;lamia.live.start&apos; in vhost &apos;/&apos; with different type, durable, internal or autodelete value, class-id=40, method-id=10)</div><div class="line">at com.rabbitmq.client.impl.ChannelN.asyncShutdown(ChannelN.java:478)</div><div class="line">at com.rabbitmq.client.impl.ChannelN.processAsync(ChannelN.java:315)</div><div class="line">at com.rabbitmq.client.impl.AMQChannel.handleCompleteInboundCommand(AMQChannel.java:144)</div><div class="line">at com.rabbitmq.client.impl.AMQChannel.handleFrame(AMQChannel.java:91)</div><div class="line">at com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:550)</div><div class="line">... 1 more</div></pre></td></tr></table></figure>
<p>é—®é¢˜åŸå› ï¼šä»é”™è¯¯æ¥çœ‹ï¼Œå¤§æ¦‚æ„æ€æ˜¯é‡å¤å£°æ˜äº†â€œexchangeâ€ã€‚ç ”ç©¶äº†ä¸‹spring-rabbitä¸­â€œexchangeâ€çš„é…ç½®ã€‚</p>
<h3 id="åŸºæœ¬ä¿¡æ¯ï¼š"><a href="#åŸºæœ¬ä¿¡æ¯ï¼š" class="headerlink" title="åŸºæœ¬ä¿¡æ¯ï¼š"></a>åŸºæœ¬ä¿¡æ¯ï¼š</h3><p><code>Broker</code>ï¼šç®€å•æ¥è¯´å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å®ä½“ï¼Œå¯ä»¥æŠŠä¸€ä¸ªrabbitmq serverå½“ä½œä¸€ä¸ªbrokerã€‚</p>
<p><code>vhost</code>è™šæ‹Ÿä¸»æœºï¼šä¸€ä¸ªbrokeré‡Œå¯ä»¥å¼€è®¾å¤šä¸ªvhostï¼Œç”¨ä½œä¸åŒç”¨æˆ·çš„æƒé™åˆ†ç¦»ï¼Œä¹Ÿå¯ä»¥æŠŠä»–çœ‹ä½œæ˜åç©ºé—´ã€‚vhostä¹‹é—´ç›¸äº’å®Œå…¨éš”ç¦»ï¼Œä¸åŒVhostä¹‹é—´æ— æ³•å…±äº«Exchangeå’ŒQueueã€‚(å¦‚æœä¸æŒ‡å®švhost,é»˜è®¤æ˜¯â€/â€œ)</p>
<p><code>Exchange</code>ï¼šExchangeæ˜¯å±äºVhostçš„ã€‚åŒä¸€ä¸ªvhostä¸èƒ½æœ‰é‡å¤çš„Exchangeåç§°(è¿™ä¸ªå°±æ˜¯é”™è¯¯åŸå› )ã€‚</p>
<p><code>Channel</code>ï¼šæ¶ˆæ¯é€šé“ï¼Œåœ¨å®¢æˆ·ç«¯çš„æ¯ä¸ªè¿æ¥é‡Œï¼Œå¯å»ºç«‹å¤šä¸ªchannelï¼Œæ¯ä¸ªchannelä»£è¡¨ä¸€ä¸ªä¼šè¯ä»»åŠ¡ã€‚</p>
<a id="more"></a>
<h3 id="é¡¹ç›®é…ç½®"><a href="#é¡¹ç›®é…ç½®" class="headerlink" title="é¡¹ç›®é…ç½®"></a>é¡¹ç›®é…ç½®</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- å£°æ˜æ¶ˆæ¯è½¬æ¢å™¨ä¸ºSimpleMessageConverter --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"messageConverter"</span></span></div><div class="line">        <span class="attr">class</span>=<span class="string">"org.springframework.amqp.support.converter.SimpleMessageConverter"</span>&gt;</div><div class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span> </div><div class="line"></div><div class="line">  <span class="comment">&lt;!-- 2) æ¨é€APN --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"notificationConnectionFactory"</span></span></div><div class="line">                           <span class="attr">host</span>=<span class="string">"$&#123;push.apn.rabbit.connect.host&#125;"</span> </div><div class="line">                           <span class="attr">port</span>=<span class="string">"$&#123;push.apn.rabbit.connect.port&#125;"</span></div><div class="line">                           <span class="attr">username</span>=<span class="string">"$&#123;push.apn.rabbit.connect.username&#125;"</span> </div><div class="line">                           <span class="attr">password</span>=<span class="string">"$&#123;push.apn.rabbit.connect.password&#125;"</span></div><div class="line">                           <span class="attr">channel-cache-size</span>=<span class="string">"$&#123;push.apn.rabbitmq.connect.channelCacheSize&#125;"</span> /&gt;</div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">id</span>=<span class="string">"notificationRabbitAdmin"</span> </span></div><div class="line">                <span class="attr">connection-factory</span>=<span class="string">"notificationConnectionFactory"</span> /&gt;</div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">"notificationRabbitTemplate"</span></span></div><div class="line">                   <span class="attr">connection-factory</span>=<span class="string">"notificationConnectionFactory"</span> </div><div class="line">                   <span class="attr">exchange</span>=<span class="string">"$&#123;pns-push.notification.topic&#125;"</span> /&gt;</div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">"clockedNotificationRabbitTemplate"</span></span></div><div class="line">                   <span class="attr">connection-factory</span>=<span class="string">"notificationConnectionFactory"</span> </div><div class="line">                   <span class="attr">routing-key</span>=<span class="string">"$&#123;pns-push.clockedMsg.queue&#125;"</span> /&gt;</div><div class="line"></div><div class="line">  <span class="comment">&lt;!-- 3) æ¨é€å¾®ä¿¡æœåŠ¡å· --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"wechatConnectionFactory"</span></span></div><div class="line">                           <span class="attr">host</span>=<span class="string">"$&#123;push.wx.rabbit.connect.host&#125;"</span> </div><div class="line">                           <span class="attr">port</span>=<span class="string">"$&#123;push.wx.rabbit.connect.port&#125;"</span></div><div class="line">                           <span class="attr">username</span>=<span class="string">"$&#123;push.wx.rabbit.connect.username&#125;"</span> </div><div class="line">                           <span class="attr">password</span>=<span class="string">"$&#123;push.wx.rabbit.connect.password&#125;"</span> /&gt;</div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">"wechatRabbitTemplate"</span></span></div><div class="line">                   <span class="attr">connection-factory</span>=<span class="string">"wechatConnectionFactory"</span> /&gt;</div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">id</span>=<span class="string">"wechatRabbitAdmin"</span> <span class="attr">connection-factory</span>=<span class="string">"wechatConnectionFactory"</span> /&gt;</span></div><div class="line"></div><div class="line">  <span class="comment">&lt;!-- å¾®ä¿¡ æ¨é€é¢„çº¦æé†’topic --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">rabbit:topic-exchange</span> <span class="attr">name</span>=<span class="string">"lamia.live.start"</span> <span class="attr">durable</span>=<span class="string">"true"</span> /&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li><code>rabbit:connection-factory</code></li>
</ul>
<p>åœ¨<code>spring-rabbit</code>ä¸­ï¼Œç®¡ç†æ¶ˆæ¯åå•†å™¨(broker)è¿æ¥çš„æ ¸å¿ƒç»„ä»¶æ˜¯<code>ConnectionFactory</code>è¿™ä¸ªæ¥å£ã€‚ <code>ConnectionFactory</code>æä¾›äº† <code>org.springframework.amqp.rabbit.connection.Connection</code>(<code>com.rabbitmq.client.Connection</code>çš„åŒ…è£…ç±»)å®ä¾‹çš„è¿æ¥ä¸ç®¡ç†ã€‚</p>
<p><code>CachingConnectionFactory</code>ï¼šæ˜¯<code>ConnectionFactory</code>çš„åœ¨Spring AMQPä¸­å”¯ä¸€å®ç°ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªè¿æ¥ä»£ç†ï¼Œä½¿ç¨‹åºå¯ä»¥å…±äº«è¿æ¥ã€‚</p>
<p><code>Connection</code> æä¾›ä¸€ä¸ª<code>createChannel</code>çš„æ–¹æ³•ã€‚<code>CachingConnectionFactory</code> çš„å®ç°èƒ½æ”¯æŒ<code>channels</code>çš„ç¼“å­˜,å¹¶ä¸”èƒ½æ ¹æ®åŒºåˆ†æ˜¯äº‹åŠ¡æ€§æˆ–éäº‹åŠ¡æ€§å„è‡ªç‹¬ç«‹ã€‚åŒæ—¶ï¼Œ<code>CachingConnectionFactory</code>ä¹Ÿæä¾›<code>hostname</code>çš„æ„é€ å‡½æ•°ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®<code>username</code>ã€<code>password</code>ã€<code>setChannelCacheSize</code>ç­‰æ–¹æ³•ã€‚<code>CachingConnectionFactory</code>  é»˜è®¤<code>channel cache</code> å¤§å°ä¸º1ï¼Œå¦‚æœæƒ³æ”¹å˜å¯ä»¥ç”¨<code>setChannelCacheSize</code>è®¾ç½® <code>channel-cache-size</code>çš„å¤§å°ã€‚</p>
<ul>
<li><code>rabbit:template</code></li>
</ul>
<p>Spring AMQPæä¾›äº†ä¸€ä¸ªå‘é€å’Œæ¥æ”¶æ¶ˆæ¯çš„æ“ä½œæ¨¡æ¿ç±»<code>AmqpTemplate</code>ã€‚ AmqpTemplateå®ƒå®šä¹‰åŒ…å«äº†å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ç­‰çš„ä¸€äº›åŸºæœ¬çš„æ“ä½œåŠŸèƒ½ã€‚<code>RabbitTemplate</code>æ˜¯AmqpTemplateçš„ä¸€ä¸ªå®ç°ã€‚</p>
<p><code>RabbitTemplate</code>æ”¯æŒæ¶ˆæ¯çš„ç¡®è®¤ä¸è¿”å›ï¼Œä¸ºäº†è¿”å›æ¶ˆæ¯ï¼Œ<code>RabbitTemplate</code> éœ€è¦è®¾ç½®<code>mandatory</code> å±æ€§ä¸ºtrue,å¹¶ä¸”<code>CachingConnectionFactory</code> çš„<code>publisherReturns</code>å±æ€§ä¹Ÿéœ€è¦è®¾ç½®ä¸ºtrueã€‚è¿”å›çš„æ¶ˆæ¯ä¼šæ ¹æ®å®ƒæ³¨å†Œçš„<code>RabbitTemplate.ReturnCallback setReturnCallback</code> å›è°ƒå‘é€åˆ°ç»™å®¢æˆ·ç«¯ï¼Œä¸€ä¸ª<code>RabbitTemplate</code>ä»…èƒ½æ”¯æŒä¸€ä¸ª<code>ReturnCallback</code>ã€‚</p>
<p>ä¸ºäº†ç¡®è®¤Confirmsæ¶ˆæ¯, <code>CachingConnectionFactory</code> çš„<code>publisherConfirms</code> å±æ€§ä¹Ÿéœ€è¦è®¾ç½®ä¸ºtrueï¼Œç¡®è®¤çš„æ¶ˆæ¯ä¼šæ ¹æ®å®ƒæ³¨å†Œçš„<code>RabbitTemplate.ConfirmCallback setConfirmCallback</code>å›è°ƒå‘é€åˆ°ç»™å®¢æˆ·ç«¯ã€‚ä¸€ä¸ª<code>RabbitTemplate</code>ä¹Ÿä»…èƒ½æ”¯æŒä¸€ä¸ª<code>ConfirmCallback</code>.</p>
<ul>
<li><code>messageConverter</code></li>
</ul>
<p>AmqpTemplate å®šä¹‰æä¾›äº†å„ç§å‘é€å’Œæ¥æ”¶å§”æ‹–ç»™<code>MessageConverter</code>è½¬åŒ–å¯¹è±¡æ¶ˆæ¯çš„æ–¹æ³•ã€‚<code>MessageConverter</code> æœ¬èº«æ¯”è¾ƒç®€å•ï¼Œå®ƒæä¾›äº†æ¶ˆæ¯å¯¹è±¡çš„è½¬åŒ–,å¯å°†objectè½¬åŒ–æˆMessage å¯¹è±¡ï¼Œæˆ–è€…å°†Message å¯¹è±¡è½¬åŒ–æˆObjectå¯¹è±¡ã€‚å®ƒæä¾›äº†é»˜è®¤çš„<code>SimpleMessageConverter</code>å®ç°ï¼Œä»¥åŠç¬¬ä¸‰æ–¹çš„<code>MessageConverter</code>ï¼Œå¦‚<code>Jackson2JsonMessageConverter</code>ï¼Œ<code>MarshallingMessageConverter</code>ç­‰ï¼Œæ¥å¤„ç†æ¶ˆæ¯ä¸å¯¹è±¡ä¹‹é—´çš„è½¬æ¢ã€‚</p>
<ul>
<li><code>rabbit:admin</code></li>
</ul>
<p>å½“<code>CachingConnectionFactory</code> ç¼“å­˜æ¨¡å¼æ˜¯<code>CHANNEL</code> æ—¶(é»˜è®¤çš„),  <code>RabbitAdmin</code> å®ç°ä¼šåœ¨åŒä¸€ä¸ª<code>ApplicationContext</code>ä¸­è‡ªåŠ¨å»¶è¿Ÿå£°æ˜ <code>Queues</code>,<code>Exchanges</code> å’Œ <code>Bindings</code>.</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰<code>queues</code>, <code>exchanges</code>,å’Œ<code>bindings</code> éƒ½å¯é€šè¿‡åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰<code>RabbitAdmin</code> å®ä¾‹æ¥å£°æ˜(è®¾ç½®äº†<code>auto-startup=&quot;true&quot;</code>).</p>
<p>ä»ï¼‘.ï¼’ç‰ˆæœ¬å¼€å§‹ï¼Œå¯ä»¥æœ‰æ¡ä»¶åœ°å£°æ˜å…ƒç´ .å½“ç¨‹åºè¿æ¥äº†å¤šä¸ª<code>brokers</code>ï¼Œå¹¶éœ€è¦åœ¨å“ªäº›<code>brokers</code>ä¸Šå£°æ˜ç‰¹å®šå…ƒç´ æ—¶ï¼Œç‰¹åˆ«æœ‰ç”¨ï¼</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰æä¾›<code>declared-by</code>(æˆ–æ˜¯ç©ºçš„)ï¼Œ <code>auto-declare</code> å±æ€§åˆ™ä¸ºtrueï¼Œé‚£ä¹ˆæ‰€æœ‰<code>RabbitAdmin</code>å°†å£°æ˜å¯¹è±¡(åªè¦adminçš„<code>auto-startup</code> å±æ€§ä¸ºtrueï¼Œé»˜è®¤å€¼)</p>
<p>é”™è¯¯åŸå› ï¼šåœ¨è¿™ä¸ªä¾‹å­ä¸­<code>RabbitAdminæœ‰2ä¸ªï¼Œå¹¶ä¸”</code>exchange<code>â€˜lamia.live.start&#39; æ²¡æœ‰æä¾›</code>declared-by<code>å£°æ˜ã€‚æ•…æ­¤ï¼Œè¯¥</code>exchange<code>è¢«è¿™2ä¸ª</code>RabbitAdmin<code>éƒ½å£°æ˜äº†ä¸€æ¬¡ã€‚è€Œä¸”åˆšå¥½è¿™2ä¸ªRabbitAdminä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªæœåŠ¡å™¨ä¸Šé¢çš„åŒä¸€ä¸ª</code>vhost<code>. åŒä¸€ä¸ª</code>vhost<code>ä¸èƒ½æœ‰é‡å¤çš„</code>Exchange`åç§°ã€‚æ‰€ä»¥ï¼Œé¡¹ç›®å¯åŠ¨æŠ¥é”™ã€‚</p>
<h3 id="æ­£ç¡®å§¿åŠ¿"><a href="#æ­£ç¡®å§¿åŠ¿" class="headerlink" title="æ­£ç¡®å§¿åŠ¿"></a>æ­£ç¡®å§¿åŠ¿</h3><p>åœ¨<code>exchange</code>å’Œ<code>queue</code>ä¸Šé¢åŠ ä¸Š<code>declared-by</code>.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 2) æ¨é€APN --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"notificationConnectionFactory"</span></span></div><div class="line">		                       <span class="attr">host</span>=<span class="string">"$&#123;push.apn.rabbit.connect.host&#125;"</span> </div><div class="line">		                       <span class="attr">port</span>=<span class="string">"$&#123;push.apn.rabbit.connect.port&#125;"</span></div><div class="line">		                       <span class="attr">username</span>=<span class="string">"$&#123;push.apn.rabbit.connect.username&#125;"</span> </div><div class="line">		                       <span class="attr">password</span>=<span class="string">"$&#123;push.apn.rabbit.connect.password&#125;"</span></div><div class="line">		                       <span class="attr">channel-cache-size</span>=<span class="string">"$&#123;push.apn.rabbitmq.connect.channelCacheSize&#125;"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">id</span>=<span class="string">"notificationRabbitAdmin"</span></span></div><div class="line">		<span class="attr">connection-factory</span>=<span class="string">"notificationConnectionFactory"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">"notificationRabbitTemplate"</span></span></div><div class="line">		<span class="attr">connection-factory</span>=<span class="string">"notificationConnectionFactory"</span> <span class="attr">exchange</span>=<span class="string">"$&#123;pns-push.notification.topic&#125;"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">"clockedNotificationRabbitTemplate"</span></span></div><div class="line">		<span class="attr">connection-factory</span>=<span class="string">"notificationConnectionFactory"</span> <span class="attr">routing-key</span>=<span class="string">"$&#123;pns-push.clockedMsg.queue&#125;"</span> /&gt;</div><div class="line">	</div><div class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"produceService"</span> <span class="attr">class</span>=<span class="string">"com.ximalaya.pns.device.service.impl.ProduceService"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- 3) æ¨é€å¾®ä¿¡æœåŠ¡å· --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"wechatConnectionFactory"</span></span></div><div class="line">		                       <span class="attr">host</span>=<span class="string">"$&#123;push.wx.rabbit.connect.host&#125;"</span> </div><div class="line">		                       <span class="attr">port</span>=<span class="string">"$&#123;push.wx.rabbit.connect.port&#125;"</span></div><div class="line">		                       <span class="attr">username</span>=<span class="string">"$&#123;push.wx.rabbit.connect.username&#125;"</span> </div><div class="line">		                       <span class="attr">password</span>=<span class="string">"$&#123;push.wx.rabbit.connect.password&#125;"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">"wechatRabbitTemplate"</span></span></div><div class="line">		<span class="attr">connection-factory</span>=<span class="string">"wechatConnectionFactory"</span> /&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">id</span>=<span class="string">"wechatRabbitAdmin"</span> <span class="attr">connection-factory</span>=<span class="string">"wechatConnectionFactory"</span> /&gt;</span></div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- å¾®ä¿¡ æ¨é€é¢„çº¦æé†’topic --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">rabbit:topic-exchange</span> <span class="attr">name</span>=<span class="string">"$&#123;push.wx.live.start.topic&#125;"</span> <span class="attr">durable</span>=<span class="string">"true"</span> <span class="attr">declared-by</span>=<span class="string">"wechatRabbitAdmin"</span> /&gt;</span></div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://o-u-u.com/?p=1535" target="_blank" rel="external">spring-rabbité…ç½®å¤švhostï¼Œå¤šconnect-factory</a></p>
<p>[<a href="http://www.cnblogs.com/wade-luffy/p/6004219.html" target="_blank" rel="external">Spring AMQP</a>]</p>
<p><a href="http://www.blogjava.net/qbna350816/archive/2016/08/13/431561.html" target="_blank" rel="external">Spring AMQP 1.6å®Œæ•´å‚è€ƒæŒ‡å—-ç¬¬äºŒéƒ¨åˆ†</a></p>
<p><a href="http://www.blogjava.net/qbna350816/archive/2016/08/13/431567.html" target="_blank" rel="external">Spring AMQP 1.6å®Œæ•´å‚è€ƒæŒ‡å—-ç¬¬å…­éƒ¨åˆ†</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Binlog]]></title>
      <url>http://zsr.github.io/2017/03/28/Binlog/</url>
      <content type="html"><![CDATA[<h3 id="ä»€ä¹ˆæ˜¯-Binlog"><a href="#ä»€ä¹ˆæ˜¯-Binlog" class="headerlink" title="ä»€ä¹ˆæ˜¯ Binlog"></a>ä»€ä¹ˆæ˜¯ Binlog</h3><p><code>MySQL Server</code>æœ‰å››ç§ç±»å‹çš„æ—¥å¿—â€”â€”<code>Error Log</code>ã€<code>General Query Log</code>ã€<code>Binary Log</code> å’Œ <code>Slow Query Log</code>ã€‚</p>
<p>ã€€ã€€ç¬¬ä¸€ä¸ªæ˜¯é”™è¯¯æ—¥å¿—ï¼Œè®°å½• <code>mysqld</code> (<code>mysql daemon</code>)çš„ä¸€äº›é”™è¯¯ã€‚ç¬¬äºŒä¸ªæ˜¯ä¸€èˆ¬æŸ¥è¯¢æ—¥å¿—ï¼Œè®°å½• <code>mysqld</code> æ­£åœ¨åšçš„äº‹æƒ…ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯çš„è¿æ¥å’Œæ–­å¼€ã€æ¥è‡ªå®¢æˆ·ç«¯æ¯æ¡ <code>Sql Statement</code> è®°å½•ä¿¡æ¯ï¼›å¦‚æœä½ æƒ³çŸ¥é“å®¢æˆ·ç«¯åˆ°åº•ä¼ äº†ä»€ä¹ˆç»™æœåŠ¡ç«¯ï¼Œè¿™ä¸ªæ—¥å¿—å°±éå¸¸ç®¡ç”¨äº†ï¼Œä¸è¿‡å®ƒéå¸¸å½±å“æ€§èƒ½ã€‚ç¬¬å››ä¸ªæ˜¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œè®°å½•ä¸€äº›æŸ¥è¯¢æ¯”è¾ƒæ…¢çš„ <code>SQL</code> è¯­å¥â€”â€”è¿™ç§æ—¥å¿—éå¸¸å¸¸ç”¨ï¼Œä¸»è¦æ˜¯ç»™å¼€å‘è€…è°ƒä¼˜ç”¨çš„ã€‚</p>
<p>ã€€ã€€ç¬¬ä¸‰ç§å°±æ˜¯ <code>Binlog</code> äº†ï¼Œ<code>binlog</code>æ˜¯mysqlçš„äºŒè¿›åˆ¶æ—¥å¿—ï¼ŒåŒ…å«äº†ä¸€äº›äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶æè¿°äº†æ•°æ®åº“çš„æ”¹åŠ¨ï¼Œå¦‚å»ºè¡¨ã€æ•°æ®æ”¹åŠ¨ç­‰ï¼Œä¹ŸåŒ…æ‹¬ä¸€äº›æ½œåœ¨æ”¹åŠ¨ï¼Œæ¯”å¦‚ <code>DELETE FROM ran WHERE bing = luan</code>ï¼Œç„¶è€Œä¸€æ¡æ•°æ®éƒ½æ²¡è¢«åˆ æ‰çš„è¿™ç§æƒ…å†µã€‚é™¤éä½¿ç”¨ <code>Row-based logging</code>ï¼Œå¦åˆ™ä¼šåŒ…å«æ‰€æœ‰æ”¹åŠ¨æ•°æ®çš„ <code>SQL Statement</code>ã€‚</p>
<p>æ³¨æ„ï¼š<code>binlog</code>ä¸»è¦æœ‰<code>statement-based</code>ã€<code>row-based logging</code>å’Œ<code>mixed logging</code> ä¸‰ç§æ ¼å¼ï¼Œ<code>row-based</code>çš„è®°å½•ä¸­ä¸åŒ…æ‹¬æ½œåœ¨æ›´æ–°è®°å½•ã€‚</p>
<p>ã€€ã€€ <code>Binlog</code> æœ‰ä¸¤ä¸ªé‡è¦çš„ç”¨é€”â€”â€”å¤åˆ¶å’Œæ¢å¤ã€‚æ¯”å¦‚ä¸»ä»è¡¨çš„å¤åˆ¶ï¼Œå’Œå¤‡ä»½æ¢å¤ã€‚</p>
<p>æ³¨ï¼š<code>mysqld</code>æ˜¯<code>MySQL</code>æœåŠ¡å™¨çš„å®ˆæŠ¤è¿›ç¨‹ã€‚</p>
<h3 id="binlogæ ¼å¼"><a href="#binlogæ ¼å¼" class="headerlink" title="binlogæ ¼å¼"></a>binlogæ ¼å¼</h3><p>å¯ä»¥æŒ‡å®šä¸‰ç§binary logçš„æ ¼å¼(å¯åŠ¨æ—¶æŒ‡å®š)ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">--binlog-format=STATEMENT</div><div class="line">--binlog-format=ROW</div><div class="line">--binlog-format=MIXED</div></pre></td></tr></table></figure>
<ul>
<li><code>statement-based logging</code>ï¼š åŸºäºSQLè¯­å¥ï¼ŒMysql5.6é»˜è®¤ï¼ŒæŸäº›è¯­å¥å’Œå‡½æ•°å¦‚UUID, LOAD DATA INFILEç­‰åœ¨å¤åˆ¶è¿‡ç¨‹å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ç”šè‡³å‡ºé”™ã€‚</li>
<li><code>row-based logging</code>ï¼šåŸºäºè¡Œï¼Œè®°å½•å½±å“tableä¸­æ¯ä¸€è¡Œçš„äº‹åŠ¡ï¼Œå¾ˆå®‰å…¨ã€‚æ‰€ä»¥ä¸€æ¡è¯­å¥å¯èƒ½ä¼šå¯¹åº”0-Nä¸ªäº‹ä»¶ï¼Œè®°å½•å¾ˆè¯¦ç»†ï¼Œæ•°æ®åŒæ­¥çš„æ”¯æŒæ¯”<code>STATEMENT</code>æ–¹å¼è¦å¥½ã€‚ä½†æ˜¯<code>binlog</code>ä¼šæ¯”å…¶ä»–ä¸¤ç§æ¨¡å¼å¤§å¾ˆå¤šï¼Œåœ¨ä¸€äº›å¤§è¡¨ä¸­æ¸…é™¤å¤§é‡æ•°æ®æ—¶åœ¨<code>binlog</code>ä¸­ä¼šç”Ÿæˆå¾ˆå¤šæ¡è¯­å¥ï¼Œå¯èƒ½å¯¼è‡´ä»åº“å»¶è¿Ÿå˜å¤§ã€‚</li>
<li><code>mixed logging</code>ï¼šä½¿ç”¨<code>statement-based logging</code>ä½œä¸ºé»˜è®¤ï¼Œä½†æ˜¯æ—¥å¿—æ¨¡å¼å¯èƒ½ä¼šåœ¨æŸäº›æƒ…å†µä¸‹è‡ªåŠ¨åˆ‡æ¢åˆ°<code>row-based logging</code>ã€‚</li>
</ul>
<a id="more"></a>
<h3 id="å¯ç”¨-Binlog"><a href="#å¯ç”¨-Binlog" class="headerlink" title="å¯ç”¨ Binlog"></a>å¯ç”¨ Binlog</h3><p>é€šå¸¸æƒ…å†µ <code>MySQL</code> æ˜¯é»˜è®¤å…³é—­ <code>Binlog</code> çš„ï¼Œéœ€è¦åœ¨<code>my.cnf</code>ä¸­æ‰‹åŠ¨é…ç½®å¯ç”¨å®ƒã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># log-bin æ˜¯æŒ‡ä»¥åç”Ÿæˆå„ Binlog æ–‡ä»¶çš„å‰ç¼€ï¼Œæ¯”å¦‚ä¸Šè¿°ä½¿ç”¨ master-binï¼Œé‚£ä¹ˆæ–‡ä»¶å°±å°†ä¼šæ˜¯ </div><div class="line"># master-bin.000001ã€master-bin.000002 ç­‰</div><div class="line">log-bin=master-bin</div><div class="line"></div><div class="line"># log-bin-index åˆ™æŒ‡ binlog index æ–‡ä»¶çš„åç§°ï¼Œè¿™é‡Œæˆ‘ä»¬è®¾ç½®ä¸º master-bin.indexã€‚</div><div class="line">log-bin-index=master-bin.index</div></pre></td></tr></table></figure>
<p>å¯åŠ¨<code>MySQL</code>æœåŠ¡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mysqld_safeæ˜¯ä¸€ä¸ªå¯åŠ¨è„šæœ¬ï¼Œè¯¥è„šæœ¬ä¼šè°ƒç”¨mysqldå¯åŠ¨ï¼Œå¦‚æœå¯åŠ¨å‡ºé”™ï¼Œä¼šå°†é”™è¯¯ä¿¡æ¯è®°å½•åˆ°é”™è¯¯æ—¥å¿—ä¸­</span></div><div class="line">$ ./mysqld_safe &amp;</div><div class="line"><span class="comment"># ç¬¦å·â€œ&amp;â€è¡¨ç¤ºåœ¨åå°å¯åŠ¨</span></div></pre></td></tr></table></figure>
<p>å¯åŠ¨<code>MySQL</code>å®¢æˆ·ç«¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mysql -u <span class="variable">$USERNAME</span> -p <span class="variable">$PASSWORD</span></div></pre></td></tr></table></figure>
<p>åœ¨å®¢æˆ·ç«¯ç»ˆç«¯é‡Œé¢è¾“å…¥ä¸‹é¢ä¸€å¥ <code>SQL</code>è¯­å¥ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ SHOW VARIABLES LIKE <span class="string">'%log_bin%'</span>;</div></pre></td></tr></table></figure>
<p>æ˜¾ç¤ºç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">+---------------------------------+---------------------------------------+</div><div class="line">| Variable_name                   | Value                                 |</div><div class="line">+---------------------------------+---------------------------------------+</div><div class="line">| <span class="built_in">log</span>_bin                         | ON                                    |</div><div class="line">| <span class="built_in">log</span>_bin_basename                | /usr/<span class="built_in">local</span>/var/mysql/master-bin       |</div><div class="line">| <span class="built_in">log</span>_bin_index                   | /usr/<span class="built_in">local</span>/var/mysql/master-bin.index |</div><div class="line">| <span class="built_in">log</span>_bin_trust_<span class="keyword">function</span>_creators | OFF                                   |</div><div class="line">| <span class="built_in">log</span>_bin_use_v1_row_events       | OFF                                   |</div><div class="line">| sql_<span class="built_in">log</span>_bin                     | ON                                    |</div><div class="line">+---------------------------------+---------------------------------------+</div><div class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div></pre></td></tr></table></figure>
<h3 id="ç»“æ„è§£æ"><a href="#ç»“æ„è§£æ" class="headerlink" title="ç»“æ„è§£æ"></a>ç»“æ„è§£æ</h3><h4 id="ç´¢å¼•æ–‡ä»¶"><a href="#ç´¢å¼•æ–‡ä»¶" class="headerlink" title="ç´¢å¼•æ–‡ä»¶"></a>ç´¢å¼•æ–‡ä»¶</h4><p>ã€€ã€€ç´¢å¼•æ–‡ä»¶å°±æ˜¯ <code>master-bin.index</code> æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªæ™®é€šçš„æ–‡æœ¬æ–‡ä»¶ï¼Œä»¥æ¢è¡Œä¸ºé—´éš”ï¼Œä¸€è¡Œä¸€ä¸ªæ–‡ä»¶åã€‚æ¯”å¦‚å®ƒå¯èƒ½æ˜¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">master-bin.000001</div><div class="line">master-bin.000002</div><div class="line">master-bin.000003</div></pre></td></tr></table></figure>
<p>ã€€ã€€ç„¶åå¯¹åº”çš„æ¯è¡Œæ–‡ä»¶å°±æ˜¯ä¸€ä¸ª <code>Binlog</code>å®ä½“æ–‡ä»¶äº†ã€‚</p>
<h4 id="Binlog-æ–‡ä»¶"><a href="#Binlog-æ–‡ä»¶" class="headerlink" title="Binlog æ–‡ä»¶"></a>Binlog æ–‡ä»¶</h4><p>ã€€ã€€<code>Binlog</code> çš„æ–‡ä»¶ç»“æ„å¤§è‡´ç”±å¦‚ä¸‹å‡ ä¸ªæ–¹é¢ç»„æˆã€‚</p>
<h4 id="æ–‡ä»¶å¤´"><a href="#æ–‡ä»¶å¤´" class="headerlink" title="æ–‡ä»¶å¤´"></a>æ–‡ä»¶å¤´</h4><p>ã€€ã€€æ–‡ä»¶å¤´ç”±ä¸€ä¸ªå››å­—èŠ‚ <code>Magic Number</code>ï¼Œå…¶å€¼ä¸º <code>1852400382</code>ï¼Œåœ¨å†…å­˜ä¸­å°±æ˜¯ <code>&quot;\xfe\x62\x69\x6e&quot;</code>.</p>
<p>ã€€ã€€ä¸å¹³å¸¸äºŒè¿›åˆ¶ä¸€æ ·ï¼Œé€šå¸¸éƒ½æœ‰ä¸€ä¸ª <code>Magic Number</code> è¿›è¡Œæ–‡ä»¶è¯†åˆ«ï¼Œå¦‚æœ <code>Magic Number</code>ä¸å»åˆä¸Šè¿°çš„å€¼é‚£ä¹ˆè¿™ä¸ªæ–‡ä»¶å°±ä¸æ˜¯ä¸€ä¸ªæ­£å¸¸çš„ <code>Binlog</code>ã€‚</p>
<h4 id="äº‹ä»¶"><a href="#äº‹ä»¶" class="headerlink" title="äº‹ä»¶"></a>äº‹ä»¶</h4><p>ã€€ã€€åœ¨æ–‡ä»¶å¤´ä¹‹åï¼Œè·Ÿéšçš„æ˜¯ä¸€ä¸ªä¸ªäº‹ä»¶ä¾æ¬¡æ’åˆ—ã€‚æ¯ä¸ªäº‹ä»¶éƒ½ç”±ä¸€ä¸ªäº‹ä»¶å¤´å’Œäº‹ä»¶ä½“ç»„æˆã€‚</p>
<p>ã€€ã€€äº‹ä»¶å¤´é‡Œé¢çš„å†…å®¹åŒ…å«äº†è¿™ä¸ªäº‹ä»¶çš„ç±»å‹ï¼ˆå¦‚æ–°å¢ã€åˆ é™¤ç­‰ï¼‰ã€äº‹ä»¶æ‰§è¡Œæ—¶é—´ä»¥åŠæ˜¯å“ªä¸ªæœåŠ¡å™¨æ‰§è¡Œçš„äº‹ä»¶ç­‰ä¿¡æ¯ã€‚</p>
<p>ã€€ã€€ç¬¬ä¸€ä¸ªäº‹ä»¶æ˜¯ä¸€ä¸ªäº‹ä»¶æè¿°ç¬¦ï¼Œæè¿°äº†è¿™ä¸ª <code>Binlog</code> æ–‡ä»¶æ ¼å¼çš„ç‰ˆæœ¬ã€‚æ¥ä¸‹å»çš„ä¸€å †äº‹ä»¶å°†ä¼šæŒ‰ç…§ç¬¬ä¸€ä¸ªäº‹ä»¶æè¿°ç¬¦æ‰€æè¿°çš„ç»“æ„ç‰ˆæœ¬è¿›è¡Œè§£è¯»ã€‚æœ€åä¸€ä¸ªäº‹ä»¶æ˜¯ä¸€ä¸ªè¡”æ¥äº‹ä»¶ï¼ŒæŒ‡å®šäº†ä¸‹ä¸€ä¸ª <code>Binlog</code> æ–‡ä»¶åâ€”â€”æœ‰ç‚¹ç±»ä¼¼äºé“¾è¡¨é‡Œé¢çš„ <code>next</code> æŒ‡é’ˆã€‚</p>
<h5 id="äº‹ä»¶å¤´"><a href="#äº‹ä»¶å¤´" class="headerlink" title="äº‹ä»¶å¤´"></a>äº‹ä»¶å¤´</h5><p>ã€€ã€€ä¸€ä¸ªäº‹ä»¶å¤´æœ‰ 19 å­—èŠ‚ï¼Œä¾æ¬¡æ’åˆ—ä¸ºå››å­—èŠ‚çš„æ—¶é—´æˆ³ã€ä¸€å­—èŠ‚çš„å½“å‰äº‹ä»¶ç±»å‹ã€å››å­—èŠ‚çš„æœåŠ¡ç«¯ IDã€å››å­—èŠ‚çš„å½“å‰äº‹ä»¶é•¿åº¦æè¿°ã€å››å­—èŠ‚çš„ä¸‹ä¸ªäº‹ä»¶ä½ç½®ï¼ˆæ–¹ä¾¿è·³è½¬ï¼‰ä»¥åŠä¸¤å­—èŠ‚çš„æ ‡è¯†ã€‚</p>
<p><code>Header</code>çš„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">|---------|---------|--------|-----------|----------------------|-----|</div><div class="line">|  4byte  |  1byte  | 4byte  |   4byte   |         4byte        |2byte|</div><div class="line">|timestamp|EventType|serverId|data-length|nextEventStartPosition|flag |</div></pre></td></tr></table></figure>
<h5 id="äº‹ä»¶ä½“"><a href="#äº‹ä»¶ä½“" class="headerlink" title="äº‹ä»¶ä½“"></a>äº‹ä»¶ä½“</h5><p>ã€€ã€€äº‹å®ä¸Šåœ¨ <code>Binlog</code> äº‹ä»¶ä¸­åº”è¯¥æ˜¯æœ‰ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼Œ<code>header</code>ã€<code>post-header</code> å’Œ <code>payload</code>ï¼Œä¸è¿‡é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬æŠŠ <code>post-header</code> å’Œ <code>payload</code> éƒ½å½’ç»“ä¸ºäº‹ä»¶ä½“ï¼Œå®é™…ä¸Šè¿™ä¸ª <code>post-header</code> é‡Œé¢æ”¾çš„æ˜¯ä¸€äº›å®šé•¿çš„æ•°æ®.</p>
<p>å®é™…ä¸Šä¸€ä¸ªçœŸæ­£çš„äº‹ä»¶ä½“ç”±ä¸¤éƒ¨åˆ†ç»„æˆ:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">+=====================================+</div><div class="line">| event  | fixed part (post-header)   |</div><div class="line">| data   +----------------------------+</div><div class="line">|        | variable part (payload)    |</div><div class="line">+=====================================+</div></pre></td></tr></table></figure>
<p>è€Œè¿™ä¸ª <code>post-header</code> å¯¹äºä¸åŒç±»å‹çš„äº‹ä»¶æ¥è¯´é•¿åº¦æ˜¯ä¸ä¸€æ ·çš„ï¼ŒåŒç§ç±»å‹æ¥è¯´æ˜¯ä¸€æ ·çš„ï¼Œè€Œè¿™ä¸ªé•¿åº¦çš„é¢„å…ˆè§„å®šå°†ä¼šåœ¨ä¸€ä¸ªâ€œæ ¼å¼æè¿°äº‹ä»¶â€ä¸­å®šå¥½ã€‚</p>
<ul>
<li><a href="https://github.com/shyiko/mysql-binlog-connector-java/blob/master/src/main/java/com/github/shyiko/mysql/binlog/event/deserialization/QueryEventDataDeserializer.java" target="_blank" rel="external">QUERY</a></li>
</ul>
<p>æ ‡è¯†æ›´æ–°æ“ä½œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">|------------------post-header------------------|--------payload------ --|</div><div class="line">|--------|-------------|-------------|----------|-------|---------------|--------|</div><div class="line">|  4byte |    4byte    |    1byte    |   2byte  | 2byte |     nbyte     |  nbyte |</div><div class="line">|ThreadId|ExecutionTime|DbNameLength |error code| status|    database   |   Sql  |</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://github.com/shyiko/mysql-binlog-connector-java/blob/master/src/main/java/com/github/shyiko/mysql/binlog/event/deserialization/WriteRowsEventDataDeserializer.java" target="_blank" rel="external">WRITE_ROWS_EVENT</a></li>
</ul>
<p>æ ‡è¯†å†™å…¥æ“ä½œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">|---post-header--|---------payload------------|</div><div class="line">|-------|--------|---- --|--- ---|------------|</div><div class="line">| 6byte | 2byte  | byte  | nbyte |   nbyte    |</div><div class="line">|tableId|Reserved|col_num|map_col|insert_value|</div></pre></td></tr></table></figure>
<p><code>col_num</code>:  ä»£è¡¨å­—æ®µçš„ä¸ªæ•°å ç”¨å­—èŠ‚æ•°æ˜¯å¯å˜çš„ï¼Œä¸€èˆ¬ä¸€å­—èŠ‚å°±å¤Ÿäº†ï¼Œ1å­—èŠ‚/2çš„å…«æ¬¡æ–¹ ä¸€èˆ¬ä¹Ÿå¾ˆéš¾æœ‰è¡¨æœ‰å‡ ç™¾ä¸ªå­—æ®µ</p>
<p><code>map_col</code>: è¿™ä¸ªä»£è¡¨å­—æ®µæ˜¯å¦ä¸ºç©º,æ¯ä¸€ä½æ˜ å°„ä¸€ä¸ªåˆ—ï¼Œæè¿°æ˜¯å¦è¢«ä½¿ç”¨ï¼Œ Nåˆ—çš„å¯¹åº”çš„size=int((N+7)/8)bytes</p>
<p><code>insert_value</code>ï¼šè¿™ä¸ªå°±æ˜¯å…·ä½“çš„è®°å½•å†…å®¹ã€‚</p>
<ul>
<li><a href="https://github.com/shyiko/mysql-binlog-connector-java/blob/master/src/main/java/com/github/shyiko/mysql/binlog/event/deserialization/RotateEventDataDeserializer.java" target="_blank" rel="external">ROTATE</a></li>
</ul>
<p>æ ‡è¯†binlogæ–‡ä»¶ç»“æŸï¼Œä»¥åŠæ–°çš„binlogæ–‡ä»¶çš„åç§°å’Œä½ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">|---post-header--|-----payload-----|</div><div class="line">|----------------|-----------------|</div><div class="line">|      8byte     |      nbyte      |</div><div class="line">| BinlogPosition | BinlogFilename  |</div></pre></td></tr></table></figure>
<h5 id="æ ¼å¼æè¿°äº‹ä»¶"><a href="#æ ¼å¼æè¿°äº‹ä»¶" class="headerlink" title="æ ¼å¼æè¿°äº‹ä»¶"></a>æ ¼å¼æè¿°äº‹ä»¶</h5><p>â€‹       åœ¨ <code>Magic Number</code> ä¹‹åè·Ÿç€çš„æ˜¯ä¸€ä¸ªæ ¼å¼æè¿°äº‹ä»¶ï¼Œå…¶å®è¿™åªæ˜¯åœ¨ v4 ç‰ˆæœ¬ä¸­çš„ç§°å‘¼ï¼Œåœ¨ä»¥å‰çš„ç‰ˆæœ¬é‡Œé¢å«èµ·å§‹äº‹ä»¶ã€‚</p>
<ul>
<li>v1ï¼Œç”¨äº MySQL 3.2.3</li>
<li>v3ï¼Œç”¨äº MySQL 4.0.2 ä»¥åŠ 4.1.0</li>
<li>v4ï¼Œç”¨äº MySQL 5.0 ä»¥åŠæ›´é«˜ç‰ˆæœ¬</li>
</ul>
<p>åœ¨ v4 ç‰ˆæœ¬ä¸­è¿™ä¸ªäº‹ä»¶çš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">+=====================================+</div><div class="line">| event  | timestamp         0 : 4    |</div><div class="line">| header +----------------------------+</div><div class="line">|        | type_code         4 : 1    | = FORMAT_DESCRIPTION_EVENT = 15</div><div class="line">|        +----------------------------+</div><div class="line">|        | server_id         5 : 4    |</div><div class="line">|        +----------------------------+</div><div class="line">|        | event_length      9 : 4    | &gt;= 91</div><div class="line">|        +----------------------------+</div><div class="line">|        | next_position    13 : 4    |</div><div class="line">|        +----------------------------+</div><div class="line">|        | flags            17 : 2    |</div><div class="line">+=====================================+</div><div class="line">| event  | binlog_version   19 : 2    | = 4</div><div class="line">| data   +----------------------------+</div><div class="line">|        | server_version   21 : 50   |</div><div class="line">|        +----------------------------+</div><div class="line">|        | create_timestamp 71 : 4    |</div><div class="line">|        +----------------------------+</div><div class="line">|        | header_length    75 : 1    |</div><div class="line">|        +----------------------------+</div><div class="line">|        | post-header      76 : n    | = array of n bytes, one byte per event</div><div class="line">|        | lengths for all            |   type that the server knows about</div><div class="line">|        | event types                |</div><div class="line">+=====================================+</div></pre></td></tr></table></figure>
<p>ã€€è¿™ä¸ªäº‹ä»¶çš„ <code>type_code</code> æ˜¯ 15ï¼Œç„¶å <code>event_length</code> æ˜¯å¤§äºç­‰äº 91 çš„å€¼çš„ï¼Œè¿™ä¸ªä¸»è¦å–å†³äºæ‰€æœ‰äº‹ä»¶ç±»å‹æ•°ã€‚</p>
<p>ã€€ã€€å› ä¸ºä»ç¬¬ 76 å­—èŠ‚å¼€å§‹åé¢çš„äºŒè¿›åˆ¶å°±ä»£è¡¨ä¸€ä¸ªå­—èŠ‚ç±»å‹çš„æ•°ç»„äº†ï¼Œä¸€ä¸ªå­—èŠ‚ä»£è¡¨ä¸€ä¸ªäº‹ä»¶ç±»å‹çš„ <code>post-header</code> é•¿åº¦ï¼Œå³æ¯ä¸ªäº‹ä»¶ç±»å‹å›ºå®šæ•°æ®çš„é•¿åº¦ã€‚</p>
<h5 id="æ ¡éªŒå’Œ"><a href="#æ ¡éªŒå’Œ" class="headerlink" title="æ ¡éªŒå’Œ"></a>æ ¡éªŒå’Œ</h5><p>â€‹       ä»5.6å¼€å§‹ï¼Œå¦‚æœæœåŠ¡å™¨è®¾ç½®äº§ç”Ÿæ£€éªŒå’Œçš„å‰æï¼Œäº‹ä»¶æœ«å°¾å°±å¤šä¸€ä¸ªæ£€éªŒå’Œå­—æ®µï¼Œæ˜¯ä¸€ä¸ª32ä½æ•´å‹æ•°ï¼Œç”¨æ¥æ£€æŸ¥æ—¶é—´å†™å…¥åæ˜¯å¦æœ‰æŸå</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://blog.csdn.net/jolly10/article/details/13998761" target="_blank" rel="external">mysqlçš„binlogåˆæ¢</a></p>
<p><a href="https://github.com/jaywcjlove/mysql-tutorial/blob/master/chapter2/2.3.md" target="_blank" rel="external">å¯åŠ¨æœåŠ¡å¹¶ç™»å½•MySQLæ•°æ®åº“</a></p>
<p><a href="http://blog.csdn.net/kang_nian/article/details/12954547" target="_blank" rel="external">Linuxç³»ç»Ÿä¸‹MySQLçš„å¯åŠ¨æ–¹å¼</a></p>
<p><a href="https://dev.mysql.com/doc/internals/en/event-data-for-specific-event-types.html" target="_blank" rel="external">binlog äº‹ä»¶ä½“</a></p>
<p><a href="http://blog.chinaunix.net/attachment/attach/25/95/31/492595314929396a8f65b2a242d02be206411d0d92.txt" target="_blank" rel="external">binlog ç»“æ„è¯¦è§£</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[CopyOnWriteArrayListè®¾è®¡åŸç†]]></title>
      <url>http://zsr.github.io/2017/03/15/CopyOnWriteArrayList%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<p>è½¬è½½ï¼š<a href="http://xiajunhust.github.io/2016/08/06/CopyOnWriteArrayList%E4%B8%8EJMM/" target="_blank" rel="external">CopyOnWriteArrayListä¸JMM</a></p>
<h3 id="1-ä»€ä¹ˆæ˜¯CopyOnWriteArrayList"><a href="#1-ä»€ä¹ˆæ˜¯CopyOnWriteArrayList" class="headerlink" title="1 ä»€ä¹ˆæ˜¯CopyOnWriteArrayList"></a>1 ä»€ä¹ˆæ˜¯CopyOnWriteArrayList</h3><p><code>CopyOnWriteArrayList</code>ç›¸å½“äºçº¿ç¨‹å®‰å…¨çš„<code>ArrayList</code>ï¼Œæ˜¯ä¸€ä¸ªå¯å˜æ•°ç»„ã€‚å®ƒå…·æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>æ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
<li>å†™æ“ä½œä¼šå¤åˆ¶æ•´ä¸ªåŸºç¡€æ•°ç»„ï¼Œå› æ­¤å†™æ“ä½œå¼€é”€å¾ˆå¤§</li>
<li>é€‚ç”¨äºå¦‚ä¸‹æƒ…å†µï¼šæ•°ç»„å¤§å°è¾ƒå°ï¼Œå¹¶ä¸”è¯»æ“ä½œæ¯”å†™æ“ä½œå¤šå¾ˆå¤šçš„æƒ…å½¢</li>
</ul>
<h3 id="2-CopyOnWriteArrayListçš„è®¾è®¡åŸç†ä¸JMM"><a href="#2-CopyOnWriteArrayListçš„è®¾è®¡åŸç†ä¸JMM" class="headerlink" title="2 CopyOnWriteArrayListçš„è®¾è®¡åŸç†ä¸JMM"></a>2 CopyOnWriteArrayListçš„è®¾è®¡åŸç†ä¸JMM</h3><p>ä¸‹é¢åˆ†æCopyOnWriteArrayListçš„è®¾è®¡åŸç†ï¼Œç»“åˆJMMçš„åŸºç¡€çŸ¥è¯†ï¼Œåˆ†æCopyOnWriteArrayListæ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>é¦–å…ˆçœ‹ç”¨æ¥å®é™…ä¿å­˜æ•°æ®çš„æ•°ç»„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** The array, accessed only via getArray/setArray. */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Object[] array;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°arrayæ•°ç»„å‰é¢ä½¿ç”¨äº†volatileå˜é‡æ¥ä¿®é¥°ã€‚volatileä¸»è¦ç”¨æ¥è§£å†³å†…å­˜å¯è§æ€§é—®é¢˜ã€‚å…³äºvolatileçš„è¯¦ç»†å®ç°åŸç†å¯ä»¥å‚è€ƒã€Š<a href="http://o8sltkx20.bkt.clouddn.com/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.pdf" target="_blank" rel="external">æ·±å…¥ç†è§£javaå†…å­˜æ¨¡å‹.pdf</a>ã€‹ä»¥åŠ<a href="http://www.cnblogs.com/dolphin0520/p/3920373.html" target="_blank" rel="external">Javaå¹¶å‘ç¼–ç¨‹ï¼švolatileå…³é”®å­—è§£æ-åšå®¢å›­-æµ·å­</a>ã€‚</p>
<h4 id="2-1-CopyOnWriteArrayListçš„è¯»æ–¹æ³•"><a href="#2-1-CopyOnWriteArrayListçš„è¯»æ–¹æ³•" class="headerlink" title="2.1 CopyOnWriteArrayListçš„è¯»æ–¹æ³•"></a>2.1 CopyOnWriteArrayListçš„è¯»æ–¹æ³•</h4><p>è¯»æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä»arrayä¸­è·å–å¯¹åº”ç´¢å¼•çš„å€¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line">*</div><div class="line">* <span class="doctag">@throws</span> IndexOutOfBoundsException &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"></div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> get(getArray(), index);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line"><span class="function"><span class="keyword">private</span> E <span class="title">get</span><span class="params">(Object[] a, <span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> (E) a[index];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* Gets the array. Non-private so as to also be accessible</div><div class="line">* from CopyOnWriteArraySet class.</div><div class="line">*/</div><div class="line"><span class="keyword">final</span> Object[] getArray() &#123;</div><div class="line"><span class="keyword">return</span> array;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-2-CopyOnWriteArrayListçš„å†™æ–¹æ³•"><a href="#2-2-CopyOnWriteArrayListçš„å†™æ–¹æ³•" class="headerlink" title="2.2 CopyOnWriteArrayListçš„å†™æ–¹æ³•"></a>2.2 CopyOnWriteArrayListçš„å†™æ–¹æ³•</h4><ul>
<li><strong>setæ–¹æ³•</strong><br>â€‹</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Replaces the element at the specified position in this list with the</div><div class="line"> * specified element.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> IndexOutOfBoundsException &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">set</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</div><div class="line">    lock.lock();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Object[] elements = getArray();</div><div class="line">        E oldValue = get(elements, index);</div><div class="line">        <span class="keyword">if</span> (oldValue != element) &#123;</div><div class="line">            <span class="keyword">int</span> len = elements.length;</div><div class="line">            Object[] newElements = Arrays.copyOf(elements, len);</div><div class="line">            newElements[index] = element;</div><div class="line">            setArray(newElements);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Not quite a no-op; ensures volatile write semantics</span></div><div class="line">            setArray(elements);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> oldValue;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        lock.unlock();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Sets the array.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setArray</span><span class="params">(Object[] a)</span> </span>&#123;</div><div class="line">    array = a;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>setæ–¹æ³•çš„åŠŸèƒ½æ˜¯å°†å¯¹åº”ç´¢å¼•çš„å…ƒç´ ç½®ä¸ºä¸€ä¸ªæ–°å€¼ã€‚æ‰§è¡Œæµç¨‹ï¼š<br>ï¼ˆ1ï¼‰åŠ é”<br>ï¼ˆ2ï¼‰è·å–å¯¹åº”ç´¢å¼•å·²æœ‰çš„å€¼<br>ï¼ˆ3ï¼‰æ¯”è¾ƒå·²æœ‰çš„å€¼å’Œæ–°å€¼ï¼Œå¦‚æœä¸ç›¸ç­‰ï¼Œè½¬4ï¼Œå¦åˆ™è½¬5<br>ï¼ˆ4ï¼‰åˆ›å»ºæ–°çš„æ•°ç»„ï¼Œå¤åˆ¶åŸæ•°ç»„çš„å…ƒç´ ï¼Œå¹¶å°†å¯¹åº”ç´¢å¼•ç½®ä¸ºæ–°å€¼ã€‚ç„¶åå°†æ–°æ•°ç»„èµ‹ç»™arrayï¼ˆsetArrayï¼‰<br>ï¼ˆ5ï¼‰setArray:å°†arrayèµ‹ç»™array</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªæ¯”è¾ƒå¥‡æ€ªçš„ç‚¹ï¼Œä¸ºä»€ä¹ˆå·²æœ‰çš„å€¼å’Œæ–°å€¼ç›¸ç­‰çš„æ—¶å€™ï¼Œè¿˜è¦æ‰§è¡ŒsetArrayå‘¢ï¼Ÿæœ¬è´¨ä¸ŠsetArrayä¹Ÿæ²¡æœ‰åšä»€ä¹ˆäº‹æƒ…ã€‚</p>
<p><strong>è¿™æ®µä»£ç æ··åˆä½¿ç”¨äº†é”ä»¥åŠvolatileã€‚é”çš„ç”¨æ³•æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œå®ƒåœ¨ä½¿ç”¨åŒä¸€ä¸ªé”çš„ä¸åŒçº¿ç¨‹ä¹‹é—´ä¿è¯å†…å­˜é¡ºåºæ€§ï¼Œä»£ç ç»“å°¾çš„é‡Šæ”¾é”çš„æ“ä½œæä¾›äº†æœ¬çº¿ç¨‹å’Œå…¶ä»–æ¬²è·å–ç›¸åŒçš„é”çš„çº¿ç¨‹ä¹‹é—´çš„happens-beforeè¯­ä¹‰ã€‚ä½†æ˜¯CopyOnWriteArrayListç±»ä¸­å…¶ä»–ä»£ç ï¼Œä¸ä¸€å®šä¼šä½¿ç”¨åˆ°è¿™æŠŠé”ï¼Œå› æ­¤ï¼Œå‰é¢æ‰€è¿°çš„é”å¸¦æ¥çš„å†…å­˜æ¨¡å‹å«ä¹‰å¯¹è¿™éƒ¨åˆ†ä»£ç æ‰§è¡Œæ˜¯ä¸é€‚ç”¨çš„ã€‚å…¶ä»–æ²¡ç”¨åˆ°è¿™æŠŠé”çš„ä»£ç ï¼Œè¯»å†™æ˜¯volatileè¯»å’Œvolatileå†™ï¼ˆå› ä¸ºarrayå‰é¢ä½¿ç”¨volatileå…³é”®å­—ä¿®é¥°ï¼‰ã€‚ç”±volatileæ¥ä¿è¯happens-beforeè¯­ä¹‰ã€‚</strong></p>
<hr>
<p><strong>volatileçš„ç‰¹æ€§åŠåŸç†</strong></p>
<p>volatile å˜é‡è‡ªèº«å…·æœ‰ä¸‹åˆ—ç‰¹æ€§:<br>ï¼ˆ1ï¼‰å¯è§æ€§ã€‚å¯¹ä¸€ä¸ªvolatile å˜é‡çš„è¯»,æ€»æ˜¯èƒ½çœ‹åˆ°(ä»»æ„çº¿ç¨‹)å¯¹è¿™ä¸ªvolatileå˜é‡æœ€åçš„å†™å…¥ã€‚<br>ï¼ˆ2ï¼‰åŸå­æ€§:å¯¹ä»»æ„å•ä¸ªvolatile å˜é‡çš„è¯»/å†™å…·æœ‰åŸå­æ€§,ä½†ç±»ä¼¼äºvolatile++è¿™ç§å¤åˆæ“ä½œä¸å…·æœ‰åŸå­æ€§ã€‚</p>
<p>volatile å†™å’Œé”çš„é‡Šæ”¾æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ã€‚</p>
<p>ä¸ºäº†å®ç° volatile çš„å†…å­˜è¯­ä¹‰,ç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶,ä¼šåœ¨æŒ‡ä»¤åºåˆ—ä¸­æ’å…¥å†…å­˜å±éšœæ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚</p>
<hr>
<p>è¿™é‡Œè°ƒç”¨setArrayçš„åŸå› æ˜¯ï¼Œç¡®ä¿setæ–¹æ³•å¯¹arrayæ‰§è¡Œçš„æ°¸è¿œæ˜¯volatileå†™ã€‚è¿™å°±å’Œå…¶ä»–å¯¹arrayæ‰§è¡Œvolatileè¯»çš„çº¿ç¨‹ä¹‹é—´å»ºç«‹äº†happens-beforeè¯­ä¹‰ã€‚éå¸¸é‡è¦çš„ä¸€ç‚¹ï¼š<strong>volatileè¯»/å†™è¯­ä¹‰é’ˆå¯¹çš„æ˜¯è¯»å†™æ“ä½œï¼Œè€Œä¸æ˜¯ä½¿ç”¨volatileä¿®é¥°çš„å˜é‡æœ¬èº«ã€‚</strong>è¿™æ ·è¯´æ›´ç›´ç™½ä¸€ç‚¹ï¼šåœ¨ä¸€ä¸ªvolatileå†™æ“ä½œä¹‹å‰çš„å¯¹å…¶ä»–évolatileå˜é‡çš„å†™ï¼Œhappens-beforeäºåŒä¸€ä¸ªvolatileå˜é‡è¯»æ“ä½œä¹‹åçš„å¯¹å…¶ä»–å˜é‡çš„è¯»ã€‚è¿™å¥è¯æ¯”è¾ƒç»•ï¼Œçœ‹ä¸‹é¢ä¸€ä¸ªä¾‹å­å°±æ¯”è¾ƒæ˜“æ‡‚äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// initial conditions</span></div><div class="line"><span class="keyword">int</span> nonVolatileField = <span class="number">0</span>;</div><div class="line">CopyOnWriteArrayList&lt;String&gt; list = <span class="comment">/* a single String */</span></div><div class="line"><span class="comment">// Thread 1</span></div><div class="line">nonVolatileField = <span class="number">1</span>;                 <span class="comment">// (1)</span></div><div class="line">list.set(<span class="number">0</span>, <span class="string">"x"</span>);                     <span class="comment">// (2)</span></div><div class="line"><span class="comment">// Thread 2</span></div><div class="line">String s = list.get(<span class="number">0</span>);               <span class="comment">// (3)</span></div><div class="line"><span class="keyword">if</span> (s == <span class="string">"x"</span>) &#123;</div><div class="line">    <span class="keyword">int</span> localVar = nonVolatileField;  <span class="comment">// (4)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç°åœ¨å‡è®¾åŸå§‹æ•°ç»„ä¸­æ— å…ƒç´ â€œxâ€ï¼Œè¿™æ ·(2)æˆåŠŸè®¾ç½®äº†å…ƒç´ â€xâ€ï¼Œ(3)å¤„å¯ä»¥æˆåŠŸè·å–åˆ°å…ƒç´ â€xâ€ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œ(4)ä¸€å®šä¼šè¯»å–åˆ°(1)å¤„è®¾ç½®çš„å€¼1.å› ä¸º(2)å¤„çš„volatileå†™ä»¥åŠåœ¨æ­¤ä¹‹å‰çš„ä»»ä½•å†™æ“ä½œéƒ½happens-before(3)å¤„çš„è¯»ä»¥åŠä¹‹åçš„æ‰€æœ‰è¯»ã€‚</p>
<p>ä½†æ˜¯ï¼Œå‡è®¾ä¸€å¼€å§‹æ•°ç»„ä¸­å°±æœ‰äº†å…ƒç´ â€xâ€ï¼Œå¦‚æœelseä¸è°ƒç”¨setArrayï¼Œé‚£ä¹ˆ(2)å¤„çš„å†™å°±ä¸æ˜¯volatileå†™ï¼Œ(4)å¤„çš„è¯»å°±ä¸ä¸€å®šèƒ½è¯»åˆ°(1)å¤„è®¾ç½®çš„å€¼ï¼</p>
<p>å¾ˆæ˜¾ç„¶æˆ‘ä»¬ä¸æƒ³è®©å†…å­˜å¯è§æ€§ä¾èµ–äºlistä¸­å·²æœ‰çš„å€¼ï¼Œä¸ºäº†ç¡®ä¿ä»»ä½•æƒ…å†µä¸‹çš„å†…å­˜å¯è§æ€§ï¼Œsetæ–¹æ³•å¿…é¡»æ°¸è¿œéƒ½æ˜¯ä¸€ä¸ªvolatileå†™ï¼Œè¿™å°±æ˜¯ä¸ºä½•è¦åœ¨elseä»£ç å—ä¸­è°ƒç”¨setArrayçš„åŸå› ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[mysqlä¼˜åŒ–]]></title>
      <url>http://zsr.github.io/2017/03/07/mysql%E4%BC%98%E5%8C%96/</url>
      <content type="html"></content>
    </entry>
    
    <entry>
      <title><![CDATA[Threadä¸­start()å’Œrun()çš„åŒºåˆ«]]></title>
      <url>http://zsr.github.io/2017/03/03/Thread%E4%B8%ADstart-%E5%92%8Crun-%E7%9A%84%E5%8C%BA%E5%88%AB/</url>
      <content type="html"><![CDATA[<h3 id="start-å’Œ-run-çš„åŒºåˆ«ç¤ºä¾‹"><a href="#start-å’Œ-run-çš„åŒºåˆ«ç¤ºä¾‹" class="headerlink" title="start() å’Œ run()çš„åŒºåˆ«ç¤ºä¾‹"></a>start() å’Œ run()çš„åŒºåˆ«ç¤ºä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æœ€å¸¸è§çš„ä¸¤ç§æ–¹æ³•å¯åŠ¨æ–°çš„çº¿ç¨‹</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startThread</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// 1) è¦†ç›– run æ–¹æ³•</span></div><div class="line">    <span class="keyword">new</span> Thread() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">// è€—æ—¶æ“ä½œ</span></div><div class="line">        &#125;</div><div class="line">    &#125;.start();</div><div class="line"></div><div class="line">    <span class="comment">// 2) ä¼ å…¥ Runnable å¯¹è±¡</span></div><div class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">// è€—æ—¶æ“ä½œ</span></div><div class="line">        &#125;</div><div class="line">    &#125;).start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="start-å’Œ-run-ç›¸å…³æºç "><a href="#start-å’Œ-run-ç›¸å…³æºç " class="headerlink" title="start() å’Œ run()ç›¸å…³æºç "></a>start() å’Œ run()ç›¸å…³æºç </h3><p>Thread.javaä¸­start()æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// å¦‚æœçº¿ç¨‹ä¸æ˜¯"å°±ç»ªçŠ¶æ€"ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼</span></div><div class="line">    <span class="keyword">if</span> (threadStatus != <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</div><div class="line"></div><div class="line">    <span class="comment">// å°†çº¿ç¨‹æ·»åŠ åˆ°ThreadGroupä¸­</span></div><div class="line">    group.add(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// é€šè¿‡start0()å¯åŠ¨çº¿ç¨‹</span></div><div class="line">        start0();</div><div class="line">        <span class="comment">// è®¾ç½®startedæ ‡è®°</span></div><div class="line">        started = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (!started) &#123;</div><div class="line">                group.threadStartFailed(<span class="keyword">this</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯´æ˜ï¼šstart()å®é™…ä¸Šæ˜¯é€šè¿‡æœ¬åœ°æ–¹æ³•start0()å¯åŠ¨çº¿ç¨‹çš„ã€‚è€Œstart0()ä¼šæ–°è¿è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œæ–°çº¿ç¨‹ä¼šè°ƒç”¨run()æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">start0</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure>
<p>Thread.javaä¸­run()çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</div><div class="line">        target.run();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯´æ˜ï¼štargetæ˜¯ä¸€ä¸ªRunnableå¯¹è±¡ã€‚run()å°±æ˜¯ç›´æ¥è°ƒç”¨Threadçº¿ç¨‹çš„Runnableæˆå‘˜çš„run()æ–¹æ³•ï¼Œå¹¶ä¸ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<h3 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a>å‚è€ƒï¼š</h3><p><a href="https://github.com/xcc3641/hexo_blog/blob/master/source/_posts/Review-Java-Thread-1.md" target="_blank" rel="external">https://github.com/xcc3641/hexo_blog/blob/master/source/_posts/Review-Java-Thread-1.md</a></p>
<p><a href="http://www.jianshu.com/p/81a56497e073" target="_blank" rel="external">http://www.jianshu.com/p/81a56497e073</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Java8ç¯å¢ƒä¸‹çš„Maven javadocæ’ä»¶çš„é…ç½®]]></title>
      <url>http://zsr.github.io/2017/03/02/Java8%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84Maven-javadoc%E6%8F%92%E4%BB%B6%E7%9A%84%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a><strong>é—®é¢˜</strong></h3><p>ç”¨mavenåœ¨mvn clean packageæ—¶ï¼Œå‡ºç°æ–°çš„é—®é¢˜ï¼šç”Ÿæˆjavadocå‡ºç°å¼‚å¸¸ï¼Œå¯¼è‡´æ‰“åŒ…å¤±è´¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ERROR] Failed to execute goal org.apache.maven.plugins:maven-javadoc-plugin:2.10.1:jar (default) on project ticket-business: MavenReportException: Error while creating archive:</div><div class="line">[ERROR] Exit code: 1 - /Users/nali/Documents/workspace/ticket/ticket-business/src/main/java/com/ximalaya/ticket/business/dao/ticket/TicketProductMapper.java:13: é”™è¯¯: æœªçŸ¥æ ‡è®°: mbg.generated</div><div class="line">[ERROR] * @mbg.generated Wed Mar 01 20:02:30 CST 2017</div><div class="line">[ERROR] ^</div><div class="line">[ERROR] /Users/nali/Documents/workspace/ticket/ticket-business/src/main/java/com/ximalaya/ticket/business/dao/ticket/TicketProductMapper.java:15: è­¦å‘Š: exampleæ²¡æœ‰ @param</div><div class="line">[ERROR] long countByExample(TicketProductExample example);</div></pre></td></tr></table></figure>
<h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a><strong>é…ç½®</strong></h3><p>javadocçš„æ’ä»¶pom.xmlé…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-javadoc-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>javadoc<span class="tag">&lt;/<span class="name">goal</span>&gt;</span>        </div><div class="line">      <span class="tag">&lt;/<span class="name">goals</span>&gt;</span>       </div><div class="line">      <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">executions</span>&gt;</span>                  </div><div class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a><strong>æ’æŸ¥</strong></h3><p>å›é€€javaç‰ˆæœ¬åˆ°java7, ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[WARNING] /Users/nali/Documents/workspace/ticket/ticket-business/src/main/java/com/ximalaya/ticket/business/model/TicketUser.java:172: è­¦å‘Š - @mbg.generatedæ˜¯æœªçŸ¥æ ‡è®°ã€‚</div></pre></td></tr></table></figure>
<p>å¯ä»¥å‘ç°åœ¨java7ä¸­æ˜¯å¯ä»¥é€šè¿‡çš„ï¼Œè€Œåœ¨java8ä¸­åˆ™ä¼šæŠ¥é”™ã€‚</p>
<p>åº”è¯¥æ˜¯java8åŠ äº†å¯¹javadocçš„æ–°çš„ç‰¹æ€§ï¼ŒæŸ¥çœ‹<a href="http://openjdk.java.net/projects/jdk8/features" target="_blank" rel="external">Java8çš„ç‰¹æ€§åˆ—è¡¨</a>å§ã€‚æœç„¶ï¼ŒJava8æ·»åŠ äº†ä¸€ä¸ªJavadocæ³¨é‡Šå†…å®¹æ£€æŸ¥çš„ç‰¹æ€§<a href="http://openjdk.java.net/jeps/172" target="_blank" rel="external">DocLint</a>ã€‚</p>
<p><code>DocLint</code>æä¾›äº†ä¸€ç§æ–¹æ³•æ¥æ£€æµ‹Javadocçš„æ³¨é‡Šä¸­çš„é”™è¯¯ï¼Œå¸Œæœ›èƒ½å¤Ÿåœ¨å¼€å‘å‘¨æœŸçš„æ—©æœŸå’Œå®¹æ˜“é“¾æ¥å›æºä»£ç çš„æ–¹å¼ã€‚</p>
<h2 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h2><p>1) å¿½ç•¥æ³¨é‡Šé”™è¯¯</p>
<p>å¦‚æœæƒ³å¿½ç•¥<code>DocLint</code>çš„ä½¿ç”¨ï¼Œå¯ä»¥åœ¨<code>maven-javadoc-plugin</code>çš„é…ç½®ä¸­åŠ ä¸Šå¯¹<code>DocLint</code>çš„å¿½ç•¥ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-javadoc-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>javadoc<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">additionalparam</span>&gt;</span>-Xdoclint:none<span class="tag">&lt;/<span class="name">additionalparam</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div></pre></td></tr></table></figure>
<p>æˆ–è€…åœ¨æ§åˆ¶å°è¾“å‡º:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn clean install -Dadditionalparam=-Xdoclint:none</div></pre></td></tr></table></figure>
<p>2) è·³è¿‡javadocç”Ÿæˆ</p>
<p>æ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn clean install -Dmaven.javadoc.skip=true</div></pre></td></tr></table></figure>
<p>å‚è€ƒ:</p>
<p><a href="https://tonydeng.github.io/2015/10/21/maven-Javadoc-plugin-in-java8-exception-resolution/" target="_blank" rel="external">https://tonydeng.github.io/2015/10/21/maven-Javadoc-plugin-in-java8-exception-resolution/</a></p>
<p><a href="http://openjdk.java.net/jeps/172" target="_blank" rel="external">http://openjdk.java.net/jeps/172</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Quartz åŸç†]]></title>
      <url>http://zsr.github.io/2017/02/28/Quartz-%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€Quartz-åŸºæœ¬ä»‹ç»"><a href="#ä¸€ã€Quartz-åŸºæœ¬ä»‹ç»" class="headerlink" title="ä¸€ã€Quartz åŸºæœ¬ä»‹ç»"></a>ä¸€ã€Quartz åŸºæœ¬ä»‹ç»</h2><h3 id="1-1-Quartzç‰¹ç‚¹"><a href="#1-1-Quartzç‰¹ç‚¹" class="headerlink" title="1.1 Quartzç‰¹ç‚¹"></a>1.1 Quartzç‰¹ç‚¹</h3><p>â€‹       <code>Quartz</code> å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li>å¼ºå¤§çš„è°ƒåº¦åŠŸèƒ½ï¼Œä¾‹å¦‚æ”¯æŒä¸°å¯Œå¤šæ ·çš„è°ƒåº¦æ–¹æ³•ï¼Œå¯ä»¥æ»¡è¶³å„ç§å¸¸è§„åŠç‰¹æ®Šéœ€æ±‚ï¼›</li>
<li>çµæ´»çš„åº”ç”¨æ–¹å¼ï¼Œä¾‹å¦‚æ”¯æŒä»»åŠ¡å’Œè°ƒåº¦çš„å¤šç§ç»„åˆæ–¹å¼ï¼Œæ”¯æŒè°ƒåº¦æ•°æ®çš„å¤šç§å­˜å‚¨æ–¹å¼ï¼›</li>
<li>åˆ†å¸ƒå¼å’Œé›†ç¾¤èƒ½åŠ›ï¼ŒTerracotta æ”¶è´­ååœ¨åŸæ¥åŠŸèƒ½åŸºç¡€ä¸Šä½œäº†è¿›ä¸€æ­¥æå‡ã€‚</li>
</ol>
<p>â€‹      å¦å¤–ï¼Œä½œä¸º Spring é»˜è®¤çš„è°ƒåº¦æ¡†æ¶ï¼ŒQuartz å¾ˆå®¹æ˜“ä¸ Spring é›†æˆå®ç°çµæ´»å¯é…ç½®çš„è°ƒåº¦åŠŸèƒ½ã€‚</p>
<p><strong>quartzè°ƒåº¦æ ¸å¿ƒå…ƒç´ </strong>ï¼š</p>
<ol>
<li><strong>Scheduler</strong>: ä»»åŠ¡è°ƒåº¦å™¨ï¼Œæ˜¯å®é™…æ‰§è¡Œä»»åŠ¡è°ƒåº¦çš„æ§åˆ¶å™¨ã€‚åœ¨springä¸­é€šè¿‡<code>SchedulerFactoryBean</code>å°è£…èµ·æ¥ã€‚</li>
<li><strong>Trigger</strong>ï¼šè§¦å‘å™¨ï¼Œç”¨äºå®šä¹‰ä»»åŠ¡è°ƒåº¦çš„æ—¶é—´è§„åˆ™ï¼Œæœ‰<code>SimpleTrigger</code>,<code>CronTrigger</code>ï¼Œå…¶ä¸­CronTriggerç”¨çš„æ¯”è¾ƒå¤šã€‚CronTriggeråœ¨springä¸­å°è£…åœ¨CronTriggerFactoryBeanä¸­ã€‚</li>
<li><strong>JobDetail</strong>: ç”¨æ¥æè¿°Jobå®ç°ç±»åŠå…¶å®ƒç›¸å…³çš„é™æ€ä¿¡æ¯ï¼Œå¦‚Jobåå­—ã€å…³è”ç›‘å¬å™¨ç­‰ä¿¡æ¯ã€‚åœ¨springä¸­æœ‰<code>JobDetailFactoryBean</code>å’Œ <code>MethodInvokingJobDetailFactoryBean</code>ä¸¤ç§å®ç°ï¼Œå¦‚æœä»»åŠ¡è°ƒåº¦åªéœ€è¦æ‰§è¡ŒæŸä¸ªç±»çš„æŸä¸ªæ–¹æ³•ï¼Œå°±å¯ä»¥é€šè¿‡<code>MethodInvokingJobDetailFactoryBean</code>æ¥è°ƒç”¨ã€‚</li>
<li><strong>Job</strong>: æ˜¯ä¸€ä¸ªæ¥å£ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•<code>void execute(JobExecutionContext context)</code>,å¼€å‘è€…å®ç°è¯¥æ¥å£å®šä¹‰è¿è¡Œä»»åŠ¡ï¼Œ<code>JobExecutionContext</code>ç±»æä¾›äº†è°ƒåº¦ä¸Šä¸‹æ–‡çš„å„ç§ä¿¡æ¯ã€‚Jobè¿è¡Œæ—¶çš„ä¿¡æ¯ä¿å­˜åœ¨<code>JobDataMap</code>å®ä¾‹ä¸­ã€‚å®ç°Jobæ¥å£çš„ä»»åŠ¡ï¼Œé»˜è®¤æ˜¯æ— çŠ¶æ€çš„ï¼Œè‹¥è¦å°†Jobè®¾ç½®æˆæœ‰çŠ¶æ€çš„ï¼Œåœ¨quartzä¸­æ˜¯ç»™å®ç°çš„Jobæ·»åŠ <code>@DisallowConcurrentExecution</code>æ³¨è§£ï¼ˆä»¥å‰æ˜¯å®ç°StatefulJobæ¥å£ï¼Œç°åœ¨å·²è¢«Deprecatedï¼‰,åœ¨ä¸springç»“åˆä¸­å¯ä»¥åœ¨springé…ç½®æ–‡ä»¶çš„job detailä¸­é…ç½®concurrentå‚æ•°ã€‚</li>
<li><strong>QuartzSchedulerResources</strong>:ç›¸å½“äºè°ƒåº¦çš„èµ„æºå­˜æ”¾å™¨ï¼ŒåŒ…å«äº†JobStore, ThreadPoolç­‰èµ„æºï¼Œè°ƒåº¦éƒ½æ˜¯é€šè¿‡                QuartzSchedulerResourcesè·å–ç›¸å…³å±æ€§çš„ã€‚</li>
</ol>
<p>å®ç°ä¸€ä¸ªæœ€ç®€å•çš„ Quartz å®šæ—¶ä»»åŠ¡ï¼ˆä¸æ”¯æŒå¤šæœºï¼‰ï¼Œæœ‰å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>åˆ›å»º Jobã€‚</li>
<li>åˆ›å»º JobBuilderã€‚é¡¾åæ€ä¹‰ï¼Œå¯ä»¥ç”¨äºç”Ÿæˆ JobDetail ã€‚</li>
<li>åˆ›å»º TriggerBuilderã€‚ä½œç”¨ï¼šé…ç½®å®šæ—¶æ—¶é—´,å¯ä»¥ç”¨äºç”Ÿæˆ Trigger ã€‚</li>
<li>åˆ›å»º Schedulerã€‚ä½œç”¨ï¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">    System.out.println(<span class="string">"Hello World"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    JobDetail job = JobBuilder.newJob(HelloJob.class).withIdentity(<span class="string">"dummyJobName"</span>, <span class="string">"group1"</span>).build();</div><div class="line"></div><div class="line">    Trigger trigger = TriggerBuilder.newTrigger().withIdentity(<span class="string">"dummyTriggerName"</span>, <span class="string">"group1"</span>)</div><div class="line">        .withSchedule(CronScheduleBuilder.cronSchedule(<span class="string">"0/5 * * * * ?"</span>)).build();</div><div class="line"></div><div class="line">    Scheduler scheduler = <span class="keyword">new</span> StdSchedulerFactory().getScheduler();</div><div class="line">    scheduler.start();</div><div class="line">    scheduler.scheduleJob(job, trigger);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="1-2-Quartz-é›†ç¾¤é…ç½®"><a href="#1-2-Quartz-é›†ç¾¤é…ç½®" class="headerlink" title="1.2 Quartz é›†ç¾¤é…ç½®"></a>1.2 Quartz é›†ç¾¤é…ç½®</h3><p><code>quartz</code>é›†ç¾¤æ˜¯é€šè¿‡æ•°æ®åº“è¡¨æ¥æ„ŸçŸ¥å…¶ä»–çš„åº”ç”¨çš„ï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´å¹¶æ²¡æœ‰ç›´æ¥çš„é€šä¿¡ã€‚åªæœ‰ä½¿ç”¨æŒä¹…çš„JobStoreæ‰èƒ½å®ŒæˆQuartzé›†ç¾¤ã€‚<br>æ•°æ®åº“è¡¨ï¼šä»¥å‰æœ‰12å¼ è¡¨ï¼Œç°åœ¨åªæœ‰11å¼ è¡¨ï¼Œç°åœ¨æ²¡æœ‰å­˜å‚¨listenerç›¸å…³çš„è¡¨ï¼Œå¤šäº†<code>QRTZ_SIMPROP_TRIGGERS</code>è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th>Table name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>QRTZ_CALENDARS</td>
<td>å­˜å‚¨Quartzçš„Calendarä¿¡æ¯</td>
</tr>
<tr>
<td>QRTZ_CRON_TRIGGERS</td>
<td>å­˜å‚¨CronTriggerï¼ŒåŒ…æ‹¬Cronè¡¨è¾¾å¼å’Œæ—¶åŒºä¿¡æ¯</td>
</tr>
<tr>
<td>QRTZ_FIRED_TRIGGERS</td>
<td>å­˜å‚¨ä¸å·²è§¦å‘çš„Triggerç›¸å…³çš„çŠ¶æ€ä¿¡æ¯ï¼Œä»¥åŠç›¸è”Jobçš„æ‰§è¡Œä¿¡æ¯</td>
</tr>
<tr>
<td>QRTZ_PAUSED_TRIGGER_GRPS</td>
<td>å­˜å‚¨å·²æš‚åœçš„Triggerç»„çš„ä¿¡æ¯</td>
</tr>
<tr>
<td>QRTZ_SCHEDULER_STATE</td>
<td>å­˜å‚¨å°‘é‡çš„æœ‰å…³Schedulerçš„çŠ¶æ€ä¿¡æ¯ï¼Œå’Œåˆ«çš„Schedulerå®ä¾‹</td>
</tr>
<tr>
<td><strong>QRTZ_LOCKS</strong></td>
<td>å­˜å‚¨ç¨‹åºçš„æ‚²è§‚é”çš„ä¿¡æ¯</td>
</tr>
<tr>
<td>QRTZ_JOB_DETAILS</td>
<td>å­˜å‚¨æ¯ä¸€ä¸ªå·²é…ç½®çš„Jobçš„è¯¦ç»†ä¿¡æ¯</td>
</tr>
<tr>
<td>QRTZ_SIMPLE_TRIGGERS</td>
<td>å­˜å‚¨ç®€å•çš„Triggerï¼ŒåŒ…æ‹¬é‡å¤æ¬¡æ•°ã€é—´éš”ã€ä»¥åŠå·²è§¦çš„æ¬¡æ•°</td>
</tr>
<tr>
<td>QRTZ_BLOG_TRIGGERS</td>
<td>Triggerä½œä¸ºBlobç±»å‹å­˜å‚¨</td>
</tr>
<tr>
<td>QRTZ_TRIGGERS</td>
<td>å­˜å‚¨å·²é…ç½®çš„Triggerçš„ä¿¡æ¯</td>
</tr>
<tr>
<td>QRTZ_SIMPROP_TRIGGERS</td>
</tr>
</tbody>
</table>
<p><code>QRTZ_LOCKS</code>å°±æ˜¯Quartzé›†ç¾¤å®ç°åŒæ­¥æœºåˆ¶çš„è¡Œé”è¡¨,åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªé”ï¼š<code>CALENDAR_ACCESS</code> ã€<code>JOB_ACCESS</code>ã€<code>MISFIRE_ACCESS</code> ã€<code>STATE_ACCESS</code> ã€<code>TRIGGER_ACCESS</code>ã€‚</p>
<a id="more"></a>
<h2 id="äºŒã€Quartz-åŸç†åŠæµç¨‹"><a href="#äºŒã€Quartz-åŸç†åŠæµç¨‹" class="headerlink" title="äºŒã€Quartz åŸç†åŠæµç¨‹"></a>äºŒã€Quartz åŸç†åŠæµç¨‹</h2><h3 id="2-1-quartzåŸºæœ¬åŸç†"><a href="#2-1-quartzåŸºæœ¬åŸç†" class="headerlink" title="2.1 quartzåŸºæœ¬åŸç†"></a>2.1 quartzåŸºæœ¬åŸç†</h3><p>Quartzæ˜¯é€šè¿‡å¯¹ç”¨æˆ·æš´éœ²å‡ºScheduleræ¥è¿›è¡Œä»»åŠ¡çš„æ“ä½œï¼Œå®ƒå¯ä»¥æŠŠä»»åŠ¡JobDetailå’Œè§¦å‘å™¨TriggeråŠ å…¥ä»»åŠ¡æ± ä¸­ï¼Œå¯ä»¥æŠŠä»»åŠ¡åˆ é™¤ï¼Œä¹Ÿå¯ä»¥æŠŠä»»åŠ¡åœæ­¢ï¼ŒscheduleræŠŠè¿™äº›ä»»åŠ¡å’Œè§¦å‘å™¨æ”¾åˆ°ä¸€ä¸ªJobStoreä¸­ï¼Œè¿™é‡ŒjobStoreæœ‰å†…å­˜å½¢å¼çš„ä¹Ÿæœ‰æŒä¹…åŒ–å½¢å¼çš„.</p>
<p>å®ƒå†…éƒ¨ä¼šé€šè¿‡ä¸€ä¸ªè°ƒåº¦çº¿ç¨‹<code>QuartzSchedulerThread</code>ä¸æ–­åˆ°<code>JobStore</code>ä¸­æ‰¾å‡ºä¸‹æ¬¡éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶æŠŠè¿™äº›ä»»åŠ¡å°è£…æ”¾åˆ°ä¸€ä¸ªçº¿ç¨‹æ± <code>ThreadPool</code>ä¸­è¿è¡Œ.</p>
<p>åœ¨ Quartz ä¸­ï¼Œ scheduler ç”± scheduler å·¥å‚åˆ›å»ºï¼š<code>DirectSchedulerFactory</code> æˆ–è€… <code>StdSchedulerFactory</code>ã€‚ ç¬¬äºŒç§å·¥å‚ StdSchedulerFactory ä½¿ç”¨è¾ƒå¤šï¼Œå› ä¸º DirectSchedulerFactory ä½¿ç”¨èµ·æ¥ä¸å¤Ÿæ–¹ä¾¿ï¼Œéœ€è¦ä½œè®¸å¤šè¯¦ç»†çš„æ‰‹å·¥ç¼–ç è®¾ç½®ã€‚ Scheduler ä¸»è¦æœ‰ä¸‰ç§ï¼š<code>RemoteMBeanScheduler</code>ï¼Œ <code>RemoteScheduler</code> å’Œ <code>StdScheduler</code>ã€‚ä»¥æœ€å¸¸ç”¨çš„ <code>StdScheduler</code> ä¸ºä¾‹è®²è§£ã€‚</p>
<p>Quartz æ ¸å¿ƒå…ƒç´ ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p>å›¾ 1. Quartz æ ¸å¿ƒå…ƒç´ å…³ç³»å›¾</p>
<p><img src="/images/quartz å›¾2-1.gif"></p>
<p><strong>çº¿ç¨‹è§†å›¾</strong></p>
<p>åœ¨ Quartz ä¸­ï¼Œæœ‰ä¸¤ç±»çº¿ç¨‹ï¼Œ<code>Scheduler</code> è°ƒåº¦çº¿ç¨‹å’Œä»»åŠ¡æ‰§è¡Œçº¿ç¨‹ï¼Œå…¶ä¸­ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹é€šå¸¸ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ± ç»´æŠ¤ä¸€ç»„çº¿ç¨‹ã€‚</p>
<p>å›¾ 2. Quartz çº¿ç¨‹è§†å›¾</p>
<p><img src="/images/quartz å›¾2-2.gif"></p>
<p>Scheduler è°ƒåº¦çº¿ç¨‹ä¸»è¦æœ‰ä¸¤ä¸ªï¼š æ‰§è¡Œå¸¸è§„è°ƒåº¦çš„çº¿ç¨‹ï¼Œå’Œæ‰§è¡Œ misfired trigger çš„çº¿ç¨‹ã€‚å¸¸è§„è°ƒåº¦çº¿ç¨‹è½®è¯¢å­˜å‚¨çš„æ‰€æœ‰ triggerï¼Œå¦‚æœæœ‰éœ€è¦è§¦å‘çš„ triggerï¼Œå³åˆ°è¾¾äº†ä¸‹ä¸€æ¬¡è§¦å‘çš„æ—¶é—´ï¼Œåˆ™ä»ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹æ± è·å–ä¸€ä¸ªç©ºé—²çº¿ç¨‹ï¼Œæ‰§è¡Œä¸è¯¥ trigger å…³è”çš„ä»»åŠ¡ã€‚Misfire çº¿ç¨‹æ˜¯æ‰«ææ‰€æœ‰çš„ triggerï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ misfired triggerï¼Œå¦‚æœæœ‰çš„è¯æ ¹æ® misfire çš„ç­–ç•¥åˆ†åˆ«å¤„ç†ã€‚ä¸‹å›¾æè¿°äº†è¿™ä¸¤ä¸ªçº¿ç¨‹çš„åŸºæœ¬æµç¨‹ï¼š</p>
<p>å›¾ 3. Quartz è°ƒåº¦çº¿ç¨‹æµç¨‹å›¾</p>
<p><img src="/images/quartz å›¾2-3.png"></p>
<p>å›¾ 4. Quartz è°ƒåº¦æ‰§è¡Œæ—¶åºå›¾</p>
<p><img src="http://p.blog.csdn.net/images/p_blog_csdn_net/cutesource/EntryImages/20091208/quartz1.jpg" alt="img"></p>
<h3 id="2-2-quartzæºç åˆ†æ"><a href="#2-2-quartzæºç åˆ†æ" class="headerlink" title="2.2 quartzæºç åˆ†æ"></a>2.2 quartzæºç åˆ†æ</h3><ul>
<li><code>StdSchedulerFactory.getScheduler()</code>æºç </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Scheduler <span class="title">getScheduler</span><span class="params">()</span> <span class="keyword">throws</span> SchedulerException </span>&#123;</div><div class="line">        <span class="comment">// è¯»å–quartzé…ç½®æ–‡ä»¶ï¼ŒæœªæŒ‡å®šåˆ™é¡ºåºéå†å„ä¸ªpathä¸‹çš„quartz.propertiesæ–‡ä»¶</span></div><div class="line">        <span class="comment">// è§£æå‡ºquartzé…ç½®å†…å®¹å’Œç¯å¢ƒå˜é‡ï¼Œå­˜å…¥PropertiesParserå¯¹è±¡</span></div><div class="line">        <span class="comment">// PropertiesParserç»„åˆäº†Propertiesï¼ˆç»§æ‰¿Hashtableï¼‰ï¼Œå®šä¹‰äº†ä¸€ç³»åˆ—å¯¹Propertiesçš„æ“ä½œæ–¹æ³•ï¼Œæ¯”å¦‚getPropertyGroup()æ‰¹é‡è·å–ç›¸åŒå‰ç¼€çš„é…ç½®ã€‚é…ç½®å†…å®¹å’Œç¯å¢ƒå˜é‡å­˜æ”¾åœ¨Propertiesæˆå‘˜å˜é‡ä¸­</span></div><div class="line">        <span class="keyword">if</span> (cfg == <span class="keyword">null</span>) &#123;</div><div class="line">            initialize();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// è·å–è°ƒåº¦å™¨æ± ï¼Œé‡‡ç”¨äº†å•ä¾‹æ¨¡å¼</span></div><div class="line">        <span class="comment">// å…¶å®ï¼Œè°ƒåº¦å™¨æ± çš„æ ¸å¿ƒå˜é‡å°±æ˜¯ä¸€ä¸ªhashmapï¼Œæ¯ä¸ªå…ƒç´ keyæ˜¯scheduleråï¼Œvalueæ˜¯schedulerå®ä¾‹</span></div><div class="line">        <span class="comment">// getInstance()ç”¨synchronizedé˜²æ­¢å¹¶å‘åˆ›å»º</span></div><div class="line">        SchedulerRepository schedRep = SchedulerRepository.getInstance();</div><div class="line"></div><div class="line">        <span class="comment">// ä»è°ƒåº¦å™¨æ± ä¸­å–å‡ºå½“å‰é…ç½®æ‰€ç”¨çš„è°ƒåº¦å™¨</span></div><div class="line">        Scheduler sched = schedRep.lookup(getSchedulerName());</div><div class="line"></div><div class="line">        ......</div><div class="line"></div><div class="line">        <span class="comment">// å¦‚æœè°ƒåº¦å™¨æ± ä¸­æ²¡æœ‰å½“å‰é…ç½®çš„è°ƒåº¦å™¨ï¼Œåˆ™å®ä¾‹åŒ–ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œä¸»è¦åŠ¨ä½œåŒ…æ‹¬ï¼š</span></div><div class="line">        <span class="comment">// 1ï¼‰åˆå§‹åŒ–threadPool(çº¿ç¨‹æ± )ï¼šå¼€å‘è€…å¯ä»¥é€šè¿‡org.quartz.threadPool.classé…ç½®æŒ‡å®šä½¿ç”¨å“ªä¸ªçº¿ç¨‹æ± ç±»ï¼Œæ¯”å¦‚SimpleThreadPoolã€‚å…ˆclass loadçº¿ç¨‹æ± ç±»ï¼Œæ¥ç€åŠ¨æ€ç”Ÿæˆçº¿ç¨‹æ± å®ä¾‹beanï¼Œç„¶åé€šè¿‡åå°„ï¼Œä½¿ç”¨setXXX()æ–¹æ³•å°†ä»¥org.quartz.threadPoolå¼€å¤´çš„é…ç½®å†…å®¹èµ‹å€¼ç»™beanæˆå‘˜å˜é‡ï¼›</span></div><div class="line">        <span class="comment">// 2ï¼‰åˆå§‹åŒ–jobStore(ä»»åŠ¡å­˜å‚¨æ–¹å¼)ï¼šå¼€å‘è€…å¯ä»¥é€šè¿‡org.quartz.jobStore.classé…ç½®æŒ‡å®šä½¿ç”¨å“ªä¸ªä»»åŠ¡å­˜å‚¨ç±»ï¼Œæ¯”å¦‚RAMJobStoreã€‚å…ˆclass loadä»»åŠ¡å­˜å‚¨ç±»ï¼Œæ¥ç€åŠ¨æ€ç”Ÿæˆå®ä¾‹beanï¼Œç„¶åé€šè¿‡åå°„ï¼Œä½¿ç”¨setXXX()æ–¹æ³•å°†ä»¥org.quartz.jobStoreå¼€å¤´çš„é…ç½®å†…å®¹èµ‹å€¼ç»™beanæˆå‘˜å˜é‡ï¼›</span></div><div class="line">        <span class="comment">// 3ï¼‰åˆå§‹åŒ–dataSource(æ•°æ®æº)ï¼šå¼€å‘è€…å¯ä»¥é€šè¿‡org.quartz.dataSourceé…ç½®æŒ‡å®šæ•°æ®æºè¯¦æƒ…ï¼Œæ¯”å¦‚å“ªä¸ªæ•°æ®åº“ã€è´¦å·ã€å¯†ç ç­‰ã€‚jobStoreè¦æŒ‡å®šä¸ºJDBCJobStoreï¼ŒdataSourceæ‰ä¼šæœ‰æ•ˆï¼›</span></div><div class="line">        <span class="comment">// 4ï¼‰åˆå§‹åŒ–å…¶ä»–é…ç½®ï¼šåŒ…æ‹¬SchedulerPluginsã€JobListenersã€TriggerListenersç­‰ï¼›</span></div><div class="line">        <span class="comment">// 5ï¼‰åˆå§‹åŒ–threadExecutor(çº¿ç¨‹æ‰§è¡Œå™¨)ï¼šé»˜è®¤ä¸ºDefaultThreadExecutorï¼›</span></div><div class="line">        <span class="comment">// 6ï¼‰åˆ›å»ºå·¥ä½œçº¿ç¨‹ï¼šæ ¹æ®é…ç½®åˆ›å»ºNä¸ªå·¥ä½œthreadï¼Œæ‰§è¡Œstart()å¯åŠ¨threadï¼Œå¹¶å°†Nä¸ªthreadé¡ºåºaddè¿›threadPoolå®ä¾‹çš„ç©ºé—²çº¿ç¨‹åˆ—è¡¨availWorkersä¸­ï¼›</span></div><div class="line">        <span class="comment">// 7ï¼‰åˆ›å»ºè°ƒåº¦å™¨çº¿ç¨‹ï¼šåˆ›å»ºQuartzSchedulerThreadå®ä¾‹ï¼Œå¹¶é€šè¿‡threadExecutor.execute(å®ä¾‹)å¯åŠ¨è°ƒåº¦å™¨çº¿ç¨‹ï¼›</span></div><div class="line">        <span class="comment">// 8ï¼‰åˆ›å»ºè°ƒåº¦å™¨ï¼šåˆ›å»ºStdSchedulerå®ä¾‹ï¼Œå°†ä¸Šé¢æ‰€æœ‰é…ç½®å’Œå¼•ç”¨ç»„åˆè¿›å®ä¾‹ä¸­ï¼Œå¹¶å°†å®ä¾‹å­˜å…¥è°ƒåº¦å™¨æ± ä¸­</span></div><div class="line">        sched = instantiate();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> sched;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢æœ‰ä¸ªè¿‡ç¨‹æ˜¯åˆå§‹åŒ–jobStoreï¼Œè¡¨ç¤ºä½¿ç”¨å“ªç§æ–¹å¼å­˜å‚¨schedulerç›¸å…³æ•°æ®ã€‚quartzæœ‰ä¸¤å¤§jobStoreï¼š<code>RAMJobStore</code>å’Œ<code>JDBCJobStore</code>ã€‚<code>RAMJobStore</code>æŠŠæ•°æ®å­˜å…¥å†…å­˜ï¼Œæ€§èƒ½æœ€é«˜ï¼Œé…ç½®ä¹Ÿç®€å•ï¼Œä½†ç¼ºç‚¹æ˜¯ç³»ç»ŸæŒ‚äº†éš¾ä»¥æ¢å¤æ•°æ®ã€‚<code>JDBCJobStore</code>ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“ï¼Œä¿è¯æ•°æ®çš„å¯æ¢å¤æ€§ï¼Œä½†æ€§èƒ½è¾ƒå·®ä¸”é…ç½®å¤æ‚ã€‚</p>
<ul>
<li><code>QuartzScheduler.scheduleJob(JobDetail, Trigger)</code>æºç </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Date <span class="title">scheduleJob</span><span class="params">(JobDetail jobDetail,</span></span></div><div class="line">            Trigger trigger) <span class="keyword">throws</span> SchedulerException &#123;</div><div class="line">        <span class="comment">// æ£€æŸ¥è°ƒåº¦å™¨æ˜¯å¦å¼€å¯ï¼Œå¦‚æœå…³é—­åˆ™throwå¼‚å¸¸åˆ°ä¸Šå±‚</span></div><div class="line">        validateState();</div><div class="line">        ......</div><div class="line">        <span class="comment">// è·å–triggeré¦–æ¬¡è§¦å‘jobçš„æ—¶é—´ï¼Œä»¥æ­¤æ—¶é—´ä¸ºèµ·ç‚¹ï¼Œæ¯éš”ä¸€æ®µæŒ‡å®šçš„æ—¶é—´è§¦å‘job</span></div><div class="line">        Date ft = trig.computeFirstFireTime(cal);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ft == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SchedulerException(</div><div class="line">                    <span class="string">"Based on configured schedule, the given trigger '"</span> + trigger.getKey() + <span class="string">"' will never fire."</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// æŠŠjobå’Œtriggeræ³¨å†Œè¿›è°ƒåº¦å™¨çš„jobStore</span></div><div class="line">        resources.getJobStore().storeJobAndTrigger(jobDetail, trig);</div><div class="line">        <span class="comment">// é€šçŸ¥jobç›‘å¬è€…</span></div><div class="line">        notifySchedulerListenersJobAdded(jobDetail);                </div><div class="line">        <span class="comment">// é€šçŸ¥è°ƒåº¦å™¨çº¿ç¨‹</span></div><div class="line">        notifySchedulerThread(trigger.getNextFireTime().getTime());</div><div class="line">        <span class="comment">// é€šçŸ¥triggerç›‘å¬è€…</span></div><div class="line">        notifySchedulerListenersSchduled(trigger);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> ft;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>QuartzScheduler.start()</code>æºç </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> SchedulerException </span>&#123;</div><div class="line">        ......</div><div class="line">        <span class="comment">// è¿™å¥æœ€å…³é”®ï¼Œä½œç”¨æ˜¯ä½¿è°ƒåº¦å™¨çº¿ç¨‹è·³å‡ºä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå¼€å§‹è½®è¯¢æ‰€æœ‰triggerè§¦å‘job</span></div><div class="line">        <span class="comment">// åŸç†è¯¦è§â€œå¦‚ä½•é‡‡ç”¨å¤šçº¿ç¨‹è¿›è¡Œä»»åŠ¡è°ƒåº¦â€</span></div><div class="line">        schedThread.togglePause(<span class="keyword">false</span>);</div><div class="line">        ......</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="å¦‚ä½•é‡‡ç”¨å¤šçº¿ç¨‹è¿›è¡Œä»»åŠ¡è°ƒåº¦"><a href="#å¦‚ä½•é‡‡ç”¨å¤šçº¿ç¨‹è¿›è¡Œä»»åŠ¡è°ƒåº¦" class="headerlink" title="å¦‚ä½•é‡‡ç”¨å¤šçº¿ç¨‹è¿›è¡Œä»»åŠ¡è°ƒåº¦"></a>å¦‚ä½•é‡‡ç”¨å¤šçº¿ç¨‹è¿›è¡Œä»»åŠ¡è°ƒåº¦</h3><ul>
<li><code>QuartzSchedulerThread.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è°ƒåº¦å™¨çº¿ç¨‹ä¸€æ—¦å¯åŠ¨ï¼Œå°†ä¸€ç›´è¿è¡Œæ­¤æ–¹æ³•</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">  ......</div><div class="line">  <span class="comment">// while()æ— é™å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯å–å‡ºæ—¶é—´å°†åˆ°çš„triggerï¼Œè§¦å‘å¯¹åº”çš„jobï¼Œç›´åˆ°è°ƒåº¦å™¨çº¿ç¨‹è¢«å…³é—­</span></div><div class="line">  <span class="comment">// haltedæ˜¯ä¸€ä¸ªAtomicBooleanç±»å˜é‡ï¼Œæœ‰ä¸ªvolatile intå˜é‡valueï¼Œå…¶get()æ–¹æ³•ä»…ä»…ç®€å•çš„ä¸€å¥return value != 0ï¼Œget()è¿”å›ç»“æœè¡¨ç¤ºè°ƒåº¦å™¨çº¿ç¨‹æ˜¯å¦å¼€å…³</span></div><div class="line">  <span class="comment">// volatileä¿®é¥°çš„å˜é‡ï¼Œå­˜å–å¿…é¡»èµ°å†…å­˜ï¼Œä¸èƒ½é€šè¿‡cpuç¼“å­˜ï¼Œè¿™æ ·ä¸€æ¥getæ€»èƒ½è·å¾—setçš„æœ€æ–°çœŸå®å€¼ï¼Œå› æ­¤volatileå˜é‡é€‚åˆç”¨æ¥å­˜æ”¾ç®€å•çš„çŠ¶æ€ä¿¡æ¯</span></div><div class="line">  <span class="comment">// é¡¾åæ€ä¹‰ï¼ŒAtomicBooleanè¦è§£å†³åŸå­æ€§é—®é¢˜ï¼Œä½†volatileå¹¶ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œè¯¦è§http://blog.csdn.net/wxwzy738/article/details/43238089</span></div><div class="line">  <span class="keyword">while</span> (!halted.get()) &#123;</div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// check if we're supposed to pause...</span></div><div class="line">        <span class="comment">// sigLockæ˜¯ä¸ªObjectå¯¹è±¡ï¼Œè¢«ç”¨äºåŠ é”åŒæ­¥</span></div><div class="line">        <span class="comment">// éœ€è¦ç”¨åˆ°wait()ï¼Œå¿…é¡»åŠ åˆ°synchronizedå—å†…</span></div><div class="line">        <span class="keyword">synchronized</span> (sigLock) &#123;</div><div class="line">            <span class="keyword">while</span> (paused &amp;&amp; !halted.get()) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="comment">// wait until togglePause(false) is called...</span></div><div class="line">                    <span class="comment">// è¿™é‡Œä¼šä¸æ–­å¾ªç¯ç­‰å¾…ï¼Œç›´åˆ°QuartzScheduler.start()è°ƒç”¨äº†togglePause(false)</span></div><div class="line">                    <span class="comment">// è°ƒç”¨wait()ï¼Œè°ƒåº¦å™¨çº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼ŒåŒæ—¶sigLocké”è¢«é‡Šæ”¾</span></div><div class="line">                    <span class="comment">// togglePause(false)è·å¾—sigLocké”ï¼Œå°†pausedç½®ä¸ºfalseï¼Œä½¿è°ƒåº¦å™¨çº¿ç¨‹èƒ½å¤Ÿé€€å‡ºæ­¤å¾ªç¯ï¼ŒåŒæ—¶æ‰§è¡ŒsigLock.notifyAll()å”¤é†’è°ƒåº¦å™¨çº¿ç¨‹</span></div><div class="line">                    sigLock.wait(<span class="number">1000L</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123;&#125;</div><div class="line">            &#125;</div><div class="line">            ......</div><div class="line">        &#125;</div><div class="line">        ......</div><div class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹ä¸ªæ•° &gt; 0</span></div><div class="line">        <span class="keyword">if</span>(availThreadCount &gt; <span class="number">0</span>) &#123;</div><div class="line">            ......</div><div class="line">            <span class="comment">// è·å–é©¬ä¸Šåˆ°æ—¶é—´çš„trigger</span></div><div class="line">            <span class="comment">// å…è®¸å–å‡ºçš„triggerä¸ªæ•°ä¸èƒ½è¶…è¿‡ä¸€ä¸ªé˜€å€¼ï¼Œè¿™ä¸ªé˜€å€¼æ˜¯çº¿ç¨‹æ± ä¸ªæ•°ä¸org.quartz.scheduler.batchTriggerAcquisitionMaxCounté…ç½®å€¼é—´çš„æœ€å°è€…</span></div><div class="line">            triggers = qsRsrcs.getJobStore().acquireNextTriggers(</div><div class="line">                now + idleWaitTime, Math.min(availThreadCount, qsRsrcs.getMaxBatchSize()), qsRsrcs.getBatchTimeWindow());</div><div class="line">            ......</div><div class="line">            <span class="comment">// æ‰§è¡Œä¸triggerç»‘å®šçš„job</span></div><div class="line">            <span class="comment">// shellæ˜¯JobRunShellå¯¹è±¡ï¼Œå®ç°äº†Runnableæ¥å£</span></div><div class="line">            <span class="comment">// SimpleThreadPool.runInThread(Runnable)ä»çº¿ç¨‹æ± ç©ºé—²åˆ—è¡¨ä¸­å–å‡ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹</span></div><div class="line">            <span class="comment">// å·¥ä½œçº¿ç¨‹æ‰§è¡ŒWorkerThread.run(Runnable)ï¼Œè¯¦è§ä¸‹æ–¹WorkerThreadçš„è®²è§£</span></div><div class="line">            <span class="keyword">if</span> (qsRsrcs.getThreadPool().runInThread(shell) == <span class="keyword">false</span>) &#123; ...... &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;......&#125;</div><div class="line">        ......</div><div class="line">    &#125; <span class="keyword">catch</span>(RuntimeException re) &#123;......&#125;</div><div class="line">  &#125; <span class="comment">// while (!halted)</span></div><div class="line">  ......</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>WorkerThread.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Runnable newRunnable)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span>(lock) &#123;</div><div class="line">            <span class="keyword">if</span>(runnable != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already running a Runnable!"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            runnable = newRunnable;</div><div class="line">            lock.notifyAll();</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// å·¥ä½œçº¿ç¨‹ä¸€æ—¦å¯åŠ¨ï¼Œå°†ä¸€ç›´è¿è¡Œæ­¤æ–¹æ³•</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> ran = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="comment">// å·¥ä½œçº¿ç¨‹ä¸€ç›´å¾ªç¯ç­‰å¾…jobï¼Œç›´åˆ°çº¿ç¨‹è¢«å…³é—­ï¼ŒåŸç†åŒQuartzSchedulerThread.run()ä¸­çš„halted.get()</span></div><div class="line">        <span class="keyword">while</span> (run.get()) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">               <span class="comment">// åŸç†åŒQuartzSchedulerThread.run()ä¸­çš„synchronized (sigLock)</span></div><div class="line">               <span class="comment">// é”ä½lockï¼Œä¸æ–­å¾ªç¯ç­‰å¾…jobï¼Œå½“jobè¦è¢«æ‰§è¡Œæ—¶ï¼ŒWorkerThread.run(Runnable)è¢«è°ƒç”¨ï¼Œjobè¿è¡Œç¯å¢ƒè¢«èµ‹å€¼ç»™runnable</span></div><div class="line">                <span class="keyword">synchronized</span>(lock) &#123;</div><div class="line">                    <span class="keyword">while</span> (runnable == <span class="keyword">null</span> &amp;&amp; run.get()) &#123;</div><div class="line">                        lock.wait(<span class="number">500</span>);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// å¼€å§‹æ‰§è¡Œjob</span></div><div class="line">                    <span class="keyword">if</span> (runnable != <span class="keyword">null</span>) &#123;</div><div class="line">                        ran = <span class="keyword">true</span>;</div><div class="line">                        <span class="comment">// runnable.run()å°†è§¦å‘è¿è¡Œjobå®ç°ç±»ï¼ˆæ¯”å¦‚JobImpl.execute()ï¼‰</span></div><div class="line">                        runnable.run();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException unblock) &#123;</div><div class="line">             ......</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ......</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ ¸å¿ƒä»£ç å°±æ˜¯åœ¨whileå¾ªç¯ä¸­è°ƒç”¨<code>Object.wait()</code>ï¼Œç­‰å¾…å¯ä»¥è·³å‡ºwhileå¾ªç¯çš„æ¡ä»¶æˆç«‹ï¼Œå½“æ¡ä»¶æˆç«‹æ—¶ï¼Œç«‹é©¬è°ƒåº¦<code>Object.notifyAll()</code>ä½¿çº¿ç¨‹è·³å‡ºwhileã€‚é€šè¿‡è¿™æ ·çš„ä»£ç ï¼Œå¯ä»¥å®ç°è°ƒåº¦å™¨çº¿ç¨‹ç­‰å¾…å¯åŠ¨ã€å·¥ä½œçº¿ç¨‹ç­‰å¾…jobç­‰åŠŸèƒ½ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.jianshu.com/p/bab8e4e329520" target="_blank" rel="external">quartzåŸç†æ­ç§˜å’Œæºç è§£è¯»</a></p>
<p><a href="https://my.oschina.net/songhongxu/blog/802574" target="_blank" rel="external">quartz (ä»åŸç†åˆ°åº”ç”¨)è¯¦è§£ç¯‡</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Mockito æºç è§£æ]]></title>
      <url>http://zsr.github.io/2017/02/24/Mockito-%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<p><a href="http://site.mockito.org/" target="_blank" rel="external">Mockito</a>æ˜¯Javaå¹³å°ä¸Šè¶…ç«çš„Mockæ¡†æ¶ï¼Œå› ä¸ºå…¶ä¾¿æ·çš„APIï¼Œæ·±å—å¹¿å¤§å¼€å‘è€…å–œçˆ±ã€‚æœ¬æ–‡å°†ä»æºç çš„è§’åº¦ï¼Œæ¥åˆ†æMockitoçš„è¿è¡Œæµç¨‹ã€‚</p>
<h3 id="Mockito-ç®€ä»‹"><a href="#Mockito-ç®€ä»‹" class="headerlink" title="Mockito ç®€ä»‹"></a>Mockito ç®€ä»‹</h3><p>Mockitoç±»ç›¸å½“äºæ•´ä¸ªæ¡†æ¶çš„é—¨é¢ï¼Œè´Ÿè´£å¯¹å¤–æä¾›è°ƒç”¨æ¥å£ã€‚å¸¸ç”¨çš„æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š</p>
<ul>
<li><p><strong>mock</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">List list = Mockito.mock(List.class);   æ­¤æ—¶ï¼Œ listå°±æ˜¯è¢«Mockitoæ‰€mockåç”Ÿæˆçš„å®ä¾‹ï¼ŒMockitoä¼šè®°ä½å®ƒæ‰€mockå¯¹è±¡çš„æ‰€æœ‰è°ƒç”¨ï¼Œä¸ºåé¢çš„éªŒè¯åšå‡†å¤‡ã€‚</div></pre></td></tr></table></figure>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œè°ƒç”¨mockå¯¹è±¡çš„å¸¦è¿”å›å€¼çš„æ–¹æ³•ä¼šè¿”å›é»˜è®¤çš„å€¼ï¼Œæ¯”å¦‚è¿”å›nullã€0å€¼æˆ–è€…falseç­‰ã€‚</li>
<li>å…è®¸å¤šæ¬¡ä»£ç†mockå¯¹è±¡çš„åŒä¸€ä¸ªæ–¹æ³•ï¼Œä½†å…·ä½“çš„è¡Œä¸ºå–å†³äºè¯¥æ–¹æ³•æœ€è¿‘çš„ä¸€æ¬¡ä»£ç†è¡Œä¸ºã€‚</li>
<li>mockå¯¹è±¡çš„ä»£ç†æ–¹æ³•ï¼Œå…è®¸å¤šæ¬¡è°ƒç”¨ï¼Œåªæœ‰ä¸è¦†ç›–å®ƒçš„ä»£ç†è¡Œä¸ºï¼Œé‚£ä¹ˆæ¯æ¬¡è°ƒç”¨çš„æ‰§è¡Œç›¸åŒçš„è¡Œä¸ºæˆ–è€…è¿”å›ç›¸åŒçš„å€¼</li>
<li>ç›¸åŒçš„æ–¹æ³•å’Œå‚æ•°å”¯ä¸€ç¡®è®¤ä¸€ä¸ªä»£ç†ã€‚æ¯”å¦‚ä½ å¯ä»¥åˆ†åˆ«ä»£ç†get(int)æ–¹æ³•åœ¨å‚æ•°åˆ†åˆ«ä¸º0å’Œ1æ—¶çš„ä¸åŒè¡Œä¸ºã€‚</li>
</ul>
</li>
<li><p><strong>when</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Mockito.when(list.size()).thenReturn(1);</div></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç è¡¨ç¤ºï¼Œå½“å¯¹listå¯¹è±¡è°ƒç”¨size()æ–¹æ³•æ—¶ï¼Œä¼šè¿”å›1.è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è‡ªå®šä¹‰mockå¯¹è±¡çš„è¡Œä¸ºäº†ã€‚</p>
<p>java ä¸­çš„ç¨‹åºè°ƒç”¨æ˜¯ä»¥æ ˆçš„å½¢å¼å®ç°çš„ï¼Œå¯¹äº when æ–¹æ³•ï¼Œlist.size() æ–¹æ³•çš„è°ƒç”¨å¯¹å®ƒæ˜¯ä¸å¯è§çš„ã€‚when èƒ½æ¥æ”¶åˆ°çš„ï¼Œåªæœ‰ list.size() çš„è¿”å›å€¼ã€‚</p>
</li>
<li><p><strong>verify</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Mockito.verify(list).add(Matchers.anyObject());</div></pre></td></tr></table></figure>
<p>verifyæ˜¯è´Ÿè´£éªŒè¯çš„å‡½æ•°ï¼Œæ¥å—çš„å‚æ•°æ˜¯ä¸€ä¸ªè¢«mockçš„å¯¹è±¡ï¼Œè¡¨ç¤ºéªŒè¯å…¶æ˜¯å¦æ‰§è¡Œäº†åé¢çš„æ–¹æ³•ã€‚</p>
</li>
</ul>
<h3 id="Mockito-å®ç°"><a href="#Mockito-å®ç°" class="headerlink" title="Mockito å®ç°"></a>Mockito å®ç°</h3><p>Mock ä½¿ç”¨äº†ä»£ç†æ¨¡å¼ã€‚æˆ‘ä»¬æ“ä½œçš„listï¼Œå®é™…ä¸Šæ˜¯ç»§æ‰¿äº†<code>List</code>çš„ä»£ç†ç±»çš„å®ä¾‹ï¼Œæˆ‘ä»¬æŠŠå®ƒç§°ä¸º proxy å¯¹è±¡ã€‚å› æ­¤å¯¹äºlist çš„æ‰€æœ‰æ“ä½œï¼Œéƒ½ä¼šå…ˆç»è¿‡ proxy å¯¹è±¡ã€‚</p>
<p>Mocktio å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ‹¦æˆªåˆ°äº†list çš„æ‰€æœ‰æ“ä½œã€‚åªè¦åœ¨è°ƒç”¨list çš„æ–¹æ³•æ—¶ï¼Œå°†è¯¥æ–¹æ³•å­˜æ”¾èµ·æ¥ï¼Œç„¶ååœ¨è°ƒç”¨ thenReturn ä¸ºå…¶è®¾ç½®è¿”å›å€¼å°±å¯ä»¥äº†ã€‚</p>
<h4 id="ç±»å›¾"><a href="#ç±»å›¾" class="headerlink" title="ç±»å›¾"></a>ç±»å›¾</h4><p><img src="http://7rf34y.com2.z0.glb.qiniucdn.com/c/ca500a410275d01ec697437e54a09f2e" alt="img"></p>
<p>å‡ ä¸ªä¸»è¦çš„ç±»å·²ç”¨çº¢é¢œè‰²æ ‡å‡ºï¼Œå®ƒä»¬å°†ä¼šæ˜¯Mockitoçš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯ä¸‹æ–‡ä¸»è¦ä»‹ç»çš„å¯¹è±¡ã€‚æ¥ä¸‹æ¥ï¼Œå°±æ·±å…¥Mockitoçš„æºç æ¥ä¸€æ¢ç©¶ç«Ÿã€‚</p>
<a id="more"></a>
<h4 id="Mock"><a href="#Mock" class="headerlink" title="Mock"></a>Mock</h4><p>Mockitoç±»ä¸­æœ‰å‡ ä¸ªmockå‡½æ•°çš„é‡è½½ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒåˆ°mock(Class<t> classToMock, MockSettings mockSettings)ï¼Œæ¥å—ä¸€ä¸ª<code>Class</code>ç±»å‹ä¸ä¸€ä¸ª<code>MockSettings</code>ï¼Œclasså°±æ˜¯æˆ‘ä»¬éœ€è¦mockå¯¹è±¡çš„ç±»å‹ï¼Œè€ŒmockSettingsåˆ™è®°å½•ç€æ­¤æ¬¡mockçš„ä¸€äº›ä¿¡æ¯ã€‚mockçš„è¡Œä¸ºå®åˆ™è½¬äº¤ä¸ª<code>MockitoCore</code>ï¼š</t></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MOCKITO_CORE.mock(classToMock, mockSettings)</div></pre></td></tr></table></figure>
<p>åœ¨<code>MockitoCore</code>ä¸­ä¸€æ˜¯åšäº†ä¸€ä¸‹åˆå§‹åŒ–å·¥ä½œï¼ŒäºŒæ˜¯ç»§ç»­è½¬äº¤ç»™<code>MockUtil</code>å¤„ç†:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">MockSettingsImpl impl = MockSettingsImpl.class.cast(settings);</div><div class="line">MockCreationSettings&lt;T&gt; creationSettings = impl.confirm(typeToMock);</div><div class="line">T mock = mockUtil.createMock(creationSettings);</div><div class="line">mockingProgress.mockingStarted(mock, typeToMock);</div></pre></td></tr></table></figure>
<p>åœ¨<code>MockUtil</code>ä¸­åˆ™ä½œäº†ä¸¤ä»¶éå¸¸å…³é”®çš„äº‹æƒ…:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">MockHandler mockHandler =  createMockHandler(settings);</div><div class="line">T mock = mockMaker.createMock(settings, mockHandler);</div></pre></td></tr></table></figure>
<p>ä¸€æ˜¯åˆ›å»ºäº†MockHandlerå¯¹è±¡ï¼ŒMockHandleræ˜¯ä¸€ä¸ªæ¥å£ï¼Œé€šè¿‡createMockHandlerå‡½æ•°æˆ‘ä»¬å¯ä»¥æ¸…æ¥šï¼ŒMockHandlerå¯¹è±¡çš„å®ä¾‹æ˜¯InvocationNotifierHandlerç±»å‹ï¼Œä½†å®ƒåªæ˜¯è´Ÿè´£å¯¹å¤–çš„åŒ…è£…ï¼Œå†…éƒ¨å®é™…èµ·ä½œç”¨çš„æ˜¯MockHandlerImplè¿™ä¸ªå®¶ä¼™ï¼Œä¹Ÿæ˜¯ä¸Šæ–‡ç±»å›¾å³ä¸‹è§’çš„é‚£ä½ï¼Œè¿™ä¸ªç±»å¯è°“æ‰¿è½½äº†Mockitoçš„ä¸»è¦é€»è¾‘ï¼Œæˆ‘ä»¬åé¢ä¼šè¯¦ç»†çš„æ¥è¯´æ˜ã€‚</p>
<p>æ¥ç€ä¼šè°ƒç”¨mockMakeræ¥åˆ›å»ºæœ€ç»ˆçš„å®ä¾‹ï¼Œè¿™ä¸ª<code>MockMaker</code>ä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶å®ç°ä¸º<code>ByteBuddyMockMaker</code>ï¼Œæˆ‘ä»¬è¿½è¿›å»çœ‹ä¸€ä¸‹createMockå‡½æ•°ï¼ˆçœç•¥å¼‚å¸¸å¤„ç†ä»£ç ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">createMock</span><span class="params">(MockCreationSettings&lt;T&gt; settings, MockHandler handler)</span></span>&#123;</div><div class="line">    Class&lt;T&gt; mockedProxyType = createProxyClass(mockWithFeaturesFrom(settings));</div><div class="line">    Instantiator instantiator = Plugins.getInstantiatorProvider().getInstantiator(settings);</div><div class="line">    T mockInstance = <span class="keyword">null</span>;</div><div class="line">    mockInstance = instantiator.newInstance(mockedProxyType);</div><div class="line">    MockAccess mockAccess = (MockAccess) mockInstance;</div><div class="line">    mockAccess.setMockitoInterceptor(<span class="keyword">new</span> MockMethodInterceptor(asInternalMockHandler(handler), settings));</div><div class="line">    <span class="keyword">return</span> ensureMockIsAssignableToMockedType(settings, mockInstance);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆå‡½æ•°å†…çš„ç¬¬ä¸€è¡Œä»£ç å°±æ¯”è¾ƒå¼•äººæ³¨ç›®ï¼šcreateProxyClassï¼Œè¦åˆ›å»ºä¸€ä¸ªä»£ç†ç±», ä½†æ²¡æœ‰åˆ›å»ºå‡ºç›®æ ‡ç±»çš„å®ä¾‹ã€‚æ‰€ä»¥å¾€ä¸‹çœ‹ï¼Œè¿™ä¸ªé‡æ‹…å°±äº¤åœ¨äº†è¿™ä¸‰è¡Œä»£ç ä¸Š:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Instantiator instantiator = Plugins.getInstantiatorProvider().getInstantiator(settings);</div><div class="line">T mockInstance = <span class="keyword">null</span>;</div><div class="line">mockInstance = instantiator.newInstance(mockedProxyType);</div></pre></td></tr></table></figure>
<p>è¿™ä¸ª<code>Instantiator</code>ä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒæœ‰ä¸¤ä¸ªå®ç°ï¼Œä¸€æ˜¯<code>ObjenesisInstantiator</code>,å¦å¤–ä¸€ä¸ªæ˜¯<code>ConstructorInstantiator</code>ï¼Œ é»˜è®¤æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯åœ¨ä½¿ç”¨<code>ObjenesisInstantiator</code>ï¼Œ æ‰€ä»¥æˆ‘ä»¬è¿™é‡ŒåªæŸ¥çœ‹<code>ObjenesisInstantiator</code>ï¼Œå¹¶ä¸”<code>ObjenesisInstantiator</code>ä¹Ÿæ˜¯ä¸Šè¿°UMLå›¾ä¸­çš„ä¸€ä¸ªæ ‡çº¢çš„ç±»ï¼Œå› ä¸ºå®ƒæ‰¿è½½ç”Ÿæˆå¯¹è±¡çš„å·¥ä½œã€‚çœ‹å…¶newInstanceæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">newInstance</span><span class="params">(Class&lt;T&gt; cls)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> objenesis.newInstance(cls);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œè°ƒç”¨äº†objenesis.newInstanceï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„å¹³å°é€‰æ‹©ä¸åŒçš„æ–¹æ³•æ¥newå¯¹è±¡ã€‚æ€»ä¹‹ä¸€å¥è¯ï¼Œåªè¦è¾“å…¥ä¸€ä¸ªclassè¿›å»ï¼Œå®ƒå°±ä¼šè¾“å‡ºå…¶ä¸€ä¸ªå®ä¾‹å¯¹è±¡.å¯ä»¥æŸ¥çœ‹å…¶Github:<a href="https://github.com/easymock/objenesis" target="_blank" rel="external">https://github.com/easymock/objenesis</a>ã€‚</p>
<p>å¦‚æ­¤ï¼Œèµ°åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„mockå¯¹è±¡å°±å·²ç»è¢«ç”Ÿæˆå‡ºæ¥.</p>
<h4 id="When"><a href="#When" class="headerlink" title="When"></a>When</h4><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹Mockitoé‡Œçš„whenæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">OngoingStubbing&lt;T&gt; <span class="title">when</span><span class="params">(T methodCall)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> MOCKITO_CORE.when(methodCall);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åŒæ ·æ˜¯è½¬äº¤åˆ°äº†<code>MOCKITO_CORE</code>è¿™é‡Œ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">OngoingStubbing&lt;T&gt; <span class="title">when</span><span class="params">(T methodCall)</span> </span>&#123;</div><div class="line">    mockingProgress.stubbingStarted();</div><div class="line">    OngoingStubbing&lt;T&gt; stubbing = mockingProgress.pullOngoingStubbing();</div><div class="line">    <span class="keyword">if</span> (stubbing == <span class="keyword">null</span>) &#123;</div><div class="line">        mockingProgress.reset();</div><div class="line">        <span class="keyword">throw</span> missingMethodInvocation();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> stubbing;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šæ–‡è¯´è¿‡ï¼Œmockå¯¹è±¡æ‰€æœ‰çš„æ–¹æ³•æœ€ç»ˆéƒ½ä¼šäº¤ç”±<code>MockHandlerImpl</code>çš„handleæ–¹æ³•å¤„ç†.</p>
<p>åœ¨handleä¸­å’Œwhenæœ‰å…³çš„å‡ å¥ä»£ç æ˜¯:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">handle</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">     ...</div><div class="line">     <span class="comment">// prepare invocation for stubbing</span></div><div class="line">     OngoingStubbingImpl&lt;T&gt; ongoingStubbing = <span class="keyword">new</span> OngoingStubbingImpl&lt;invocationContainerImpl);</div><div class="line">     mockingProgress.reportOngoingStubbing(ongoingStubbing)</div><div class="line">       </div><div class="line">     <span class="comment">// look for existing answer for this invocation</span></div><div class="line">     StubbedInvocationMatcher stubbedInvocation = invocationContainerImpl.findAnswerFor(invocation);</div><div class="line">     <span class="keyword">if</span> (stubbedInvocation != <span class="keyword">null</span>) &#123;</div><div class="line">         stubbedInvocation.captureArgumentsFrom(invocation);</div><div class="line">         <span class="keyword">return</span> stubbedInvocation.answer(invocation);</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">     ...</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>whenè°ƒç”¨çš„åŸºæœ¬å½¢å¼æ˜¯when(mock.doSome()), æ­¤æ—¶ï¼Œå½“mock.doSome()æ—¶å³ä¼šè§¦å‘ä¸Šé¢çš„è¯­å¥ï¼Œ<code>OngoingStubbingImpl</code>è¡¨ç¤ºæ­£åœ¨å¯¹ä¸€ä¸ªæ–¹æ³•æ‰“æ¡©çš„åŒ…è£…ï¼Œ<code>invocationContainerImpl</code> ç›¸å½“äºä¸€ä¸ªmockå¯¹è±¡çš„ç®¡å®¶ï¼Œè®°å½•ç€mockå¯¹è±¡æ–¹æ³•çš„è°ƒç”¨ã€‚åé¢æˆ‘ä»¬è¿˜ä¼šå†è§åˆ°å®ƒã€‚<code>mockingProgress</code>åˆ™å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå’Œçº¿ç¨‹ç›¸å…³çš„è®°å½•å™¨ï¼Œç”¨äºå­˜æ”¾æ¯ä¸ªçº¿ç¨‹æ­£è¦å‡†å¤‡åšçš„ä¸€äº›äº‹æƒ…ï¼Œå®ƒçš„å†…éƒ¨åŒ…å«äº†å‡ ä¸ª<strong>report</strong> å’Œ <strong>pull</strong> è¿™æ ·çš„å‡½æ•°ï¼Œå¦‚ä¸Šæ‰€çœ‹åˆ°ï¼ŒmockingProgressè®°å½•ç€ongoingStubbingå¯¹è±¡ã€‚</p>
<p>å†å›è¿‡å¤´æ¥çœ‹<code>MOCKITO_CORE</code>é‡Œçš„whenæ–¹æ³•å°±ä¼šæ¸…æ™°è®¸å¤šï¼Œå®ƒä¼šå–å‡ºåˆšåˆšå­˜æ”¾åœ¨mockingProgressä¸­çš„ongoingStubbingå¯¹è±¡ã€‚<code>OngoingStubbing&lt;T&gt; stubbing = mockingProgress.pullOngoingStubbing();</code></p>
<p>è€Œæˆ‘ä»¬ç†ŸçŸ¥çš„<code>thenReturn</code>ã€<code>thenThrow</code>åˆ™æ˜¯<code>OngoingStubbing</code>é‡Œçš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æœ€ç»ˆéƒ½ä¼šè°ƒåˆ°å¦‚ä¸‹æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> OngoingStubbing&lt;T&gt; <span class="title">thenAnswer</span><span class="params">(Answer&lt;?&gt; answer)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span>(!invocationContainerImpl.hasInvocationForPotentialStubbing()) &#123;</div><div class="line">          <span class="keyword">throw</span> incorrectUseOfApi();</div><div class="line">      &#125;</div><div class="line">      invocationContainerImpl.addAnswer(answer);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ConsecutiveStubbing&lt;T&gt;(invocationContainerImpl);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>answer</code>å³æ˜¯å¯¹<code>thenReturn</code>ã€<code>thenThrow</code>ä¹‹ç±»çš„åŒ…è£…ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å®šä¹‰answerã€‚æˆ‘ä»¬åˆçœ‹åˆ°äº†<code>invocationContainerImpl</code>ï¼Œå®ƒä¼šå¸®æˆ‘ä»¬ä¿ç®¡è¿™ä¸ª<code>answer</code>ï¼Œå¾…ä»¥åè°ƒç”¨è¯¥æ–¹æ³•æ—¶è¿”å›æ­£ç¡®çš„å€¼ï¼Œä¸ä¹‹å¯¹åº”çš„ä»£ç æ˜¯handleæ–¹æ³•ä¸­å¦‚ä¸‹è¿™å¥ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">StubbedInvocationMatcher stubbedInvocation =     invocationContainerImpl.findAnswerFor(invocation);</div></pre></td></tr></table></figure>
<p>å½“stubbedInvocationä¸ä¸ºç©ºæ—¶ï¼Œå°±ä¼šè°ƒç”¨anwseræ–¹æ³•æ¥å›å»ä¹‹å‰è®¾å®šçš„å€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">stubbedInvocation.answer(invocation)</div></pre></td></tr></table></figure>
<p>å¦‚æ­¤ï¼Œå¯¹äºwhen(mock.doSome()).thenReturn(obj)è¿™æ ·çš„ç”¨æ³•çš„ä¸»è¦é€»è¾‘äº†ã€‚</p>
<h3 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a>å‚è€ƒï¼š</h3><p><a href="https://toutiao.io/posts/b0h8dz/preview" target="_blank" rel="external">Mockito æºç è§£æ</a></p>
<p><a href="https://blog.coding.net/blog/how-to-write-mockito" target="_blank" rel="external">åŠ¨æ‰‹ç¼–å†™ Mockito</a></p>
<p><a href="http://www.devtf.cn/?p=1315" target="_blank" rel="external">Mockito ä¸­æ–‡æ–‡æ¡£</a></p>
<p><a href="http://blog.csdn.net/zhoudaxia/article/details/30591941" target="_blank" rel="external">JavaåŠ¨æ€ä»£ç†ä¸Cglibåº“</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[åŸºäºSpring MVCåšå•å…ƒæµ‹è¯•]]></title>
      <url>http://zsr.github.io/2017/02/23/SpringMVC-Mock/</url>
      <content type="html"><![CDATA[<p>åœ¨Spring 3.2ä¹‹å‰ï¼Œæµ‹è¯•æ—¶ä¸€èˆ¬éƒ½æ˜¯ç›´æ¥newæ§åˆ¶å™¨ï¼Œæ³¨å…¥ä¾èµ–ï¼Œç„¶ååˆ¤æ–­è¿”å›å€¼ã€‚ä½†æ˜¯æˆ‘ä»¬æ— æ³•è¿åŒSpring MVCçš„åŸºç¡€è®¾æ–½ï¼ˆå¦‚DispatcherServletè°ƒåº¦ã€ç±»å‹è½¬æ¢ã€æ•°æ®ç»‘å®šã€æ‹¦æˆªå™¨ç­‰ï¼‰ä¸€èµ·æµ‹è¯•ï¼Œå¦å¤–ä¹Ÿæ²¡æœ‰ç°æˆçš„æ–¹æ³•æµ‹è¯•å¦‚æœ€ç»ˆæ¸²æŸ“çš„è§†å›¾ï¼ˆ@ResponseBodyç”Ÿæˆçš„JSON/XMLã€JSPã€Velocityç­‰ï¼‰å†…å®¹æ˜¯å¦æ­£ç¡®ã€‚ä»Spring 3.2å¼€å§‹è¿™äº›äº‹æƒ…éƒ½å¯ä»¥å®Œæˆäº†ã€‚è€Œä¸”å¯ä»¥æµ‹è¯•å®Œæ•´çš„Spring MVCæµç¨‹ï¼Œå³ä»URLè¯·æ±‚åˆ°æ§åˆ¶å™¨å¤„ç†ï¼Œå†åˆ°è§†å›¾æ¸²æŸ“éƒ½å¯ä»¥æµ‹è¯•ã€‚</p>
<h3 id="æ·»åŠ Mavenä¾èµ–"><a href="#æ·»åŠ Mavenä¾èµ–" class="headerlink" title="æ·»åŠ Mavenä¾èµ– "></a><strong>æ·»åŠ Mavenä¾èµ– </strong></h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>ç‰ˆæœ¬ä¿¡æ¯</strong>ï¼š<spring.version>3.2.6.RELEASE</spring.version></p>
<p>æµ‹è¯•ç›¸å…³çš„ä¾èµ–ï¼ˆ<code>junit</code>ã€<code>hamcrest</code>ã€<code>mockito</code>ã€<code>spring-test</code>ï¼‰</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hamcrest<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hamcrest-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;hamcrest.core.version&#125;/version&gt;  </div><div class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mockito<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mockito-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mockito.core.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jayway.jsonpath<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>json-path<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>ç‰ˆæœ¬ä¿¡æ¯ï¼š</strong><junit.version>4.12</junit.version>ã€<hamcrest.core.version>1.3</hamcrest.core.version>ã€<mockito.core.version>2.2.22</mockito.core.version></p>
<h3 id="Spring-MVCæµ‹è¯•è¯´æ˜"><a href="#Spring-MVCæµ‹è¯•è¯´æ˜" class="headerlink" title="Spring MVCæµ‹è¯•è¯´æ˜"></a><strong>Spring MVCæµ‹è¯•è¯´æ˜</strong></h3><p><strong>é¦–å…ˆæ˜¯Springçš„å‡ ä¸ªAnnotate</strong></p>
<ul>
<li>RunWith(SpringJUnit4ClassRunner.class): è¡¨ç¤ºä½¿ç”¨Spring Testç»„ä»¶è¿›è¡Œå•å…ƒæµ‹è¯•;</li>
<li>WebAppConfiguration: æµ‹è¯•ç¯å¢ƒä½¿ç”¨ï¼Œç”¨æ¥è¡¨ç¤ºæµ‹è¯•ç¯å¢ƒä½¿ç”¨çš„ApplicationContextå°†æ˜¯WebApplicationContextç±»å‹çš„ï¼›valueæŒ‡å®šwebåº”ç”¨çš„æ ¹;</li>
<li>ContextConfiguration: æŒ‡å®šBeançš„é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼Œå¯ä»¥æœ‰å¤šç§æ–¹å¼ï¼Œè¿™ä¸ªä¾‹å­ä½¿ç”¨çš„æ˜¯æ–‡ä»¶è·¯å¾„å½¢å¼ï¼Œå¦‚æœæœ‰å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œå¯ä»¥å°†æ‹¬å·ä¸­çš„ä¿¡æ¯é…ç½®ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„æ¥è¡¨ç¤º;</li>
</ul>
<p><strong>ç„¶åæ˜¯Mockitoçš„Annotate</strong></p>
<ul>
<li>Mock: å¦‚æœè¯¥å¯¹è±¡éœ€è¦mockï¼Œåˆ™åŠ ä¸Šæ­¤Annotate;</li>
<li>InjectMocks: ä½¿mockå¯¹è±¡çš„ä½¿ç”¨ç±»å¯ä»¥æ³¨å…¥mockå¯¹è±¡ï¼Œåœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œmockå¯¹è±¡æ˜¯UserServiceï¼Œä½¿ç”¨äº†UserServiceçš„æ˜¯UserControllerï¼Œæ‰€ä»¥åœ¨ControlleråŠ ä¸Šè¯¥Annotate;</li>
</ul>
<p><strong>Setupæ–¹æ³•</strong></p>
<ul>
<li><code>MockitoAnnotations.initMocks(this)</code>: å°†æ‰“ä¸ŠMockitoæ ‡ç­¾çš„å¯¹è±¡èµ·ä½œç”¨ï¼Œä½¿å¾—Mockçš„ç±»è¢«Mockï¼Œä½¿ç”¨äº†Mockå¯¹è±¡çš„ç±»è‡ªåŠ¨ä¸Mockå¯¹è±¡å…³è”ã€‚</li>
<li><code>mockMvc</code>: è¿™ä¸ªå¯¹è±¡æ˜¯Controllerå•å…ƒæµ‹è¯•çš„å…³é”®ï¼Œå®ƒçš„åˆå§‹åŒ–ä¹Ÿæ˜¯åœ¨setupæ–¹æ³•é‡Œé¢ã€‚</li>
</ul>
<p><strong>Test Case</strong></p>
<ul>
<li>é¦–å…ˆmockäº†UserServiceçš„æ–¹æ³•ï¼Œè®©å…¶è¿”å›ä¸€ä¸ªæˆåŠŸçš„Resultå¯¹è±¡ã€‚</li>
<li><code>mockMvc.perform</code>: å‘èµ·ä¸€ä¸ªhttpè¯·æ±‚ã€‚</li>
<li><code>post(url)</code>: è¡¨ç¤ºä¸€ä¸ªpostè¯·æ±‚ï¼Œurlå¯¹åº”çš„æ˜¯Controllerä¸­è¢«æµ‹æ–¹æ³•çš„Rest urlã€‚</li>
<li><code>param(key, value)</code>: è¡¨ç¤ºä¸€ä¸ªrequest parameterï¼Œæ–¹æ³•å‚æ•°æ˜¯keyå’Œvalueã€‚</li>
<li><code>andDoï¼ˆprint()ï¼‰</code>: è¡¨ç¤ºæ‰“å°å‡ºrequestå’Œresponseçš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•ã€‚</li>
<li><code>andExpectï¼ˆstatus().isOk()ï¼‰</code>: è¡¨ç¤ºæœŸæœ›è¿”å›çš„Response Statusæ˜¯200ã€‚</li>
<li><code>andExpectï¼ˆcontent().string(isï¼ˆexpectstringï¼‰ï¼‰</code>: è¡¨ç¤ºæœŸæœ›è¿”å›çš„Response Bodyå†…å®¹æ˜¯æœŸæœ›çš„å­—ç¬¦ä¸²ã€‚</li>
</ul>
<p>spring mvcæµ‹è¯•æ¡†æ¶æä¾›äº†ä¸¤ç§æ–¹å¼ï¼Œç‹¬ç«‹å®‰è£…å’Œé›†æˆWebç¯å¢ƒæµ‹è¯•ï¼ˆæ­¤ç§æ–¹å¼å¹¶ä¸ä¼šé›†æˆçœŸæ­£çš„webç¯å¢ƒï¼Œè€Œæ˜¯é€šè¿‡ç›¸åº”çš„Mock APIè¿›è¡Œæ¨¡æ‹Ÿæµ‹è¯•ï¼Œæ— é¡»å¯åŠ¨æœåŠ¡å™¨ï¼‰ã€‚</p>
<a id="more"></a>
<h4 id="æ–¹æ¡ˆä¸€ï¼šç‹¬ç«‹å®‰è£…"><a href="#æ–¹æ¡ˆä¸€ï¼šç‹¬ç«‹å®‰è£…" class="headerlink" title="æ–¹æ¡ˆä¸€ï¼šç‹¬ç«‹å®‰è£…"></a>æ–¹æ¡ˆä¸€ï¼šç‹¬ç«‹å®‰è£…</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</div><div class="line"><span class="meta">@ContextConfiguration</span>(&#123; <span class="string">"classpath:test-context.xml"</span> &#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserControllerTest</span> </span>&#123;</div><div class="line">  <span class="meta">@InjectMocks</span></div><div class="line">  <span class="keyword">private</span> UserController userController;</div><div class="line">  <span class="meta">@Mock</span></div><div class="line">  <span class="keyword">private</span> UserServiceImpl userService;</div><div class="line">  <span class="keyword">private</span> MockMvc mockMvc;</div><div class="line">  </div><div class="line">  <span class="meta">@Before</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</div><div class="line">    MockitoAnnotations.initMocks(<span class="keyword">this</span>);</div><div class="line">    mockMvc = MockMvcBuilders.standaloneSetup(userController).build();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>1ã€é¦–å…ˆè‡ªå·±åˆ›å»ºç›¸åº”çš„æ§åˆ¶å™¨ï¼Œæ³¨å…¥ç›¸åº”çš„ä¾èµ–</p>
<p>2ã€é€šè¿‡MockMvcBuilders.standaloneSetupæ¨¡æ‹Ÿä¸€ä¸ªMvcæµ‹è¯•ç¯å¢ƒï¼Œé€šè¿‡buildå¾—åˆ°ä¸€ä¸ªMockMvc </p>
<p><strong>1.1ã€é…ç½®æ–‡ä»¶:</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></div><div class="line">	<span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">	<span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span> <span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span></div><div class="line">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></div><div class="line">       http://www.springframework.org/schema/beans</div><div class="line">       http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</div><div class="line">       http://www.springframework.org/schema/context</div><div class="line">       http://www.springframework.org/schema/context/spring-context-3.2.xsd</div><div class="line">       http://www.springframework.org/schema/mvc</div><div class="line">       http://www.springframework.org/schema/mvc/spring-mvc-3.2.xsd</div><div class="line">	   http://www.springframework.org/schema/util</div><div class="line">	   http://www.springframework.org/schema/util/spring-util-3.2.xsd"&gt;</div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"org.zsr.mvc"</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">mvc:message-converters</span> <span class="attr">register-defaults</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.http.converter.StringHttpMessageConverter"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"UTF-8"</span> /&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"supportedMediaTypes"</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">util:list</span>&gt;</span></div><div class="line">						<span class="tag">&lt;<span class="name">value</span>&gt;</span>application/json<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">					<span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"writeAcceptCharset"</span> <span class="attr">value</span>=<span class="string">"false"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">bean</span></span></div><div class="line">				<span class="attr">class</span>=<span class="string">"com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter"</span>&gt;</div><div class="line">			<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">mvc:message-converters</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>1.2ã€æµ‹è¯•ä»£ç :</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.zsr.mvc.controller;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.hamcrest.Matchers.is;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.put;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.content;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.junit.Before;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</div><div class="line"><span class="keyword">import</span> org.mockito.Mock;</div><div class="line"><span class="keyword">import</span> org.mockito.Mockito;</div><div class="line"><span class="keyword">import</span> org.mockito.MockitoAnnotations;</div><div class="line"><span class="keyword">import</span> org.mockito.invocation.InvocationOnMock;</div><div class="line"><span class="keyword">import</span> org.mockito.stubbing.Answer;</div><div class="line"><span class="keyword">import</span> org.zsr.mvc.domain.User;</div><div class="line"><span class="keyword">import</span> org.zsr.mvc.service.impl.UserServiceImpl;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</div><div class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</div><div class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</div><div class="line"><span class="keyword">import</span> org.springframework.test.context.web.WebAppConfiguration;</div><div class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.MockMvc;</div><div class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.setup.MockMvcBuilders;</div><div class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</div><div class="line"></div><div class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</div><div class="line"><span class="meta">@ContextConfiguration</span>(&#123; <span class="string">"classpath:test-context.xml"</span> &#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserControllerTest</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@InjectMocks</span></div><div class="line">  <span class="keyword">private</span> UserController userController;</div><div class="line">  <span class="meta">@Mock</span></div><div class="line">  <span class="keyword">private</span> UserServiceImpl userService;</div><div class="line">  <span class="keyword">private</span> MockMvc mockMvc;</div><div class="line"></div><div class="line">  <span class="meta">@Before</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</div><div class="line">    MockitoAnnotations.initMocks(<span class="keyword">this</span>);</div><div class="line">    mockMvc = MockMvcBuilders.standaloneSetup(userController).build();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Test</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = <span class="number">3</span>;</div><div class="line"></div><div class="line">    Mockito.when(userService.getUser(userId)).thenAnswer(<span class="keyword">new</span> Answer&lt;User&gt;() &#123;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">public</span> User <span class="title">answer</span><span class="params">(InvocationOnMock invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        User user = <span class="keyword">new</span> User();</div><div class="line">        user.setId(userId);</div><div class="line">        user.setAge(<span class="number">20</span>);</div><div class="line">        user.setFirstName(<span class="string">"bob"</span>);</div><div class="line">        <span class="keyword">return</span> user;</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    mockMvc.perform(get(<span class="string">"/user/"</span> + userId)).andExpect(status().isOk())</div><div class="line">        .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))</div><div class="line">        .andExpect(jsonPath(<span class="string">"$.data.age"</span>, is(<span class="number">20</span>))).andExpect(jsonPath(<span class="string">"$.data.firstName"</span>, is(<span class="string">"bob"</span>)))</div><div class="line">        .andExpect(jsonPath(<span class="string">"$.data.id"</span>, is(userId))).andExpect(jsonPath(<span class="string">"$.success"</span>, is(<span class="keyword">true</span>)));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Test</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSave</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    mockMvc.perform(post(<span class="string">"/user"</span>).contentType(MediaType.APPLICATION_JSON).content(JSON.toJSONString(<span class="keyword">new</span> User())))</div><div class="line">        .andExpect(status().isOk()).andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))</div><div class="line">        .andExpect(jsonPath(<span class="string">"$.success"</span>, is(<span class="keyword">true</span>)));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>æ–¹æ¡ˆäºŒï¼šé›†æˆWebç¯å¢ƒæ–¹å¼</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</div><div class="line"><span class="meta">@WebAppConfiguration</span>(value = <span class="string">"src/main/webapp"</span>)</div><div class="line"><span class="meta">@ContextConfiguration</span>(&#123; <span class="string">"classpath:test-context.xml"</span> &#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserControllerTest</span> </span>&#123;</div><div class="line">  <span class="meta">@Autowired</span></div><div class="line">  <span class="keyword">private</span> WebApplicationContext wac;</div><div class="line">  <span class="keyword">private</span> MockMvc mockMvc;</div><div class="line"></div><div class="line">  <span class="meta">@Before</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</div><div class="line">    MockitoAnnotations.initMocks(<span class="keyword">this</span>);</div><div class="line">    mockMvc = MockMvcBuilders.webAppContextSetup(wac).build();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>1ã€@WebAppConfigurationï¼šæµ‹è¯•ç¯å¢ƒä½¿ç”¨ï¼Œç”¨æ¥è¡¨ç¤ºæµ‹è¯•ç¯å¢ƒä½¿ç”¨çš„ApplicationContextå°†æ˜¯WebApplicationContextç±»å‹çš„ï¼›valueæŒ‡å®šwebåº”ç”¨çš„æ ¹ï¼›</p>
<p>2ã€é€šè¿‡@Autowired WebApplicationContext wacï¼šæ³¨å…¥webç¯å¢ƒçš„ApplicationContextå®¹å™¨ï¼›</p>
<p>3ã€ç„¶åé€šè¿‡MockMvcBuilders.webAppContextSetup(wac).build()åˆ›å»ºä¸€ä¸ªMockMvcè¿›è¡Œæµ‹è¯•ï¼›</p>
<p><strong>æ³¨æ„ï¼š</strong>é›†æˆWebç¯å¢ƒæ–¹å¼æ˜¯æ ¹æ®æŒ‡å®šçš„xmlé…ç½®æ–‡ä»¶(æˆ–è€…Javaæ³¨è§£ç±»)æ„é€ åº”ç”¨ä¸Šä¸‹æ–‡ApplicationContextï¼Œå¦‚æœé…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰å°†ä¾èµ–çš„æœåŠ¡(æœ¬æ¡ˆä¾‹æ˜¯ï¼šuserService)æ¨¡æ‹Ÿå‡ºæ¥ï¼Œåˆ™ä¾èµ–çš„æœåŠ¡æ˜¯çœŸå®çš„ï¼›åœ¨ä½¿ç”¨mockMvcæµ‹è¯•Controllerä¸­çš„Methodæ—¶å€™(å…¶ä¸­æ¶‰åŠuserServiceæ¥å£è°ƒç”¨)ï¼Œä¾èµ–çš„æœåŠ¡userServiceå®é™…ä¸Šä¼šæ‰§è¡Œå…¶ä¸­çš„é€»è¾‘(å¯èƒ½æœ‰å¤æ‚çš„è®¡ç®—æˆ–è€…RPCè°ƒç”¨ç­‰)ã€‚è¿™ç§æƒ…å†µä¸æ˜¯æˆ‘æ‰€é¢„æœŸçš„ï¼Œå®é™…çš„éœ€æ±‚æ˜¯ï¼šæ¨¡æ‹Ÿä¾èµ–çš„æœåŠ¡userServiceè°ƒç”¨æ¥å£ï¼Œè¿”å›è‡ªå®šä¹‰çš„æ•°æ®ã€‚æ€»ç»“ä¸€å¥è¯ï¼šControllerä¾èµ–çš„æ‰€æœ‰æœåŠ¡éƒ½æ˜¯mockçš„ã€‚è§£å†³æ–¹æ³•ï¼š<strong><a href="https://github.com/springockito/springockito" target="_blank" rel="external">springockito</a></strong></p>
<p><strong>2.1ã€é…ç½®æ–‡ä»¶:</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.kubek2k<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springockito<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></div><div class="line">	<span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">	<span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span> <span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span></div><div class="line">	<span class="attr">xmlns:mockito</span>=<span class="string">"http://www.mockito.org/spring/mockito"</span></div><div class="line">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></div><div class="line">       http://www.springframework.org/schema/beans</div><div class="line">       http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</div><div class="line">       http://www.springframework.org/schema/context</div><div class="line">       http://www.springframework.org/schema/context/spring-context-3.2.xsd</div><div class="line">       http://www.springframework.org/schema/mvc</div><div class="line">       http://www.springframework.org/schema/mvc/spring-mvc-3.2.xsd</div><div class="line">	   http://www.springframework.org/schema/util</div><div class="line">	   http://www.springframework.org/schema/util/spring-util-3.2.xsd</div><div class="line">	   http://www.mockito.org/spring/mockito</div><div class="line">       http://www.mockito.org/spring/mockito.xsd"&gt;</div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- &lt;context:component-scan base-package="org.royrusso.mvc" /&gt; --&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">mvc:message-converters</span> <span class="attr">register-defaults</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.http.converter.StringHttpMessageConverter"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"UTF-8"</span> /&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"supportedMediaTypes"</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">util:list</span>&gt;</span></div><div class="line">						<span class="tag">&lt;<span class="name">value</span>&gt;</span>application/json<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">					<span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"writeAcceptCharset"</span> <span class="attr">value</span>=<span class="string">"false"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">bean</span></span></div><div class="line">				<span class="attr">class</span>=<span class="string">"com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter"</span>&gt;</div><div class="line">			<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">mvc:message-converters</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">mockito:mock</span> <span class="attr">id</span>=<span class="string">"userService"</span></span></div><div class="line">		<span class="attr">class</span>=<span class="string">"org.zsr.mvc.service.impl.UserServiceImpl"</span> /&gt;</div><div class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.zsr.mvc.controller.UserController"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>2.2ã€æµ‹è¯•ä»£ç :</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.zsr.mvc.controller;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.hamcrest.Matchers.is;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.put;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.content;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.junit.Before;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</div><div class="line"><span class="keyword">import</span> org.mockito.Mockito;</div><div class="line"><span class="keyword">import</span> org.mockito.MockitoAnnotations;</div><div class="line"><span class="keyword">import</span> org.mockito.invocation.InvocationOnMock;</div><div class="line"><span class="keyword">import</span> org.mockito.stubbing.Answer;</div><div class="line"><span class="keyword">import</span> org.zsr.mvc.domain.User;</div><div class="line"><span class="keyword">import</span> org.zsr.mvc.service.impl.UserServiceImpl;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</div><div class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</div><div class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</div><div class="line"><span class="keyword">import</span> org.springframework.test.context.web.WebAppConfiguration;</div><div class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.MockMvc;</div><div class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.setup.MockMvcBuilders;</div><div class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</div><div class="line"></div><div class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</div><div class="line"><span class="meta">@WebAppConfiguration</span>(value = <span class="string">"src/main/webapp"</span>)</div><div class="line"><span class="meta">@ContextConfiguration</span>(&#123; <span class="string">"classpath:test-context.xml"</span> &#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserControllerTest</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Autowired</span></div><div class="line">  <span class="keyword">private</span> WebApplicationContext wac;</div><div class="line">  <span class="meta">@Autowired</span></div><div class="line">  <span class="keyword">private</span> UserServiceImpl userService;</div><div class="line">  <span class="keyword">private</span> MockMvc mockMvc;</div><div class="line"></div><div class="line">  <span class="meta">@Before</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</div><div class="line">    MockitoAnnotations.initMocks(<span class="keyword">this</span>);</div><div class="line">    mockMvc = MockMvcBuilders.webAppContextSetup(wac).build();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Test</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = <span class="number">3</span>;</div><div class="line"></div><div class="line">    Mockito.when(userService.getUser(userId)).thenAnswer(<span class="keyword">new</span> Answer&lt;User&gt;() &#123;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">public</span> User <span class="title">answer</span><span class="params">(InvocationOnMock invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        User user = <span class="keyword">new</span> User();</div><div class="line">        user.setId(userId);</div><div class="line">        user.setAge(<span class="number">16</span>);</div><div class="line">        user.setFirstName(<span class="string">"bob"</span>);</div><div class="line">        <span class="keyword">return</span> user;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    mockMvc.perform(get(<span class="string">"/user/"</span> + userId)).andExpect(status().isOk())</div><div class="line">        .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))</div><div class="line">        .andExpect(jsonPath(<span class="string">"$.data.age"</span>, is(<span class="number">16</span>))).andExpect(jsonPath(<span class="string">"$.data.firstName"</span>, is(<span class="string">"bob"</span>)))</div><div class="line">        .andExpect(jsonPath(<span class="string">"$.data.id"</span>, is(userId))).andExpect(jsonPath(<span class="string">"$.success"</span>, is(<span class="keyword">true</span>)));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Test</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSave</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    mockMvc.perform(post(<span class="string">"/user"</span>).contentType(MediaType.APPLICATION_JSON).content(JSON.toJSONString(<span class="keyword">new</span> User())))</div><div class="line">        .andExpect(status().isOk()).andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))</div><div class="line">        .andExpect(jsonPath(<span class="string">"$.success"</span>, is(<span class="keyword">true</span>)));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å…¶å®ƒä»£ç "><a href="#å…¶å®ƒä»£ç " class="headerlink" title="å…¶å®ƒä»£ç "></a>å…¶å®ƒä»£ç </h3><h4 id="UserServiceImplç±»"><a href="#UserServiceImplç±»" class="headerlink" title="UserServiceImplç±»"></a>UserServiceImplç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.zsr.mvc.service.impl;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.zsr.mvc.domain.User;</div><div class="line"><span class="keyword">import</span> org.zsr.mvc.service.IUserService;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</div><div class="line"></div><div class="line"><span class="meta">@Service</span>(<span class="string">"userService"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">IUserService</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">    User user = <span class="keyword">new</span> User();</div><div class="line">    <span class="keyword">return</span> user;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</div><div class="line"></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="RestResponseç±»"><a href="#RestResponseç±»" class="headerlink" title="RestResponseç±»"></a>RestResponseç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.zsr.mvc.rest;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestResponse</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</div><div class="line">    <span class="keyword">private</span> String message;</div><div class="line">    <span class="keyword">private</span> T data;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RestResponse</span><span class="params">(<span class="keyword">boolean</span> success, String message, T data)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.success = success;</div><div class="line">        <span class="keyword">this</span>.message = message;</div><div class="line">        <span class="keyword">this</span>.data = data;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="UserControllerç±»"><a href="#UserControllerç±»" class="headerlink" title="UserControllerç±»"></a>UserControllerç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.zsr.mvc.controller;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.zsr.mvc.domain.User;</div><div class="line"><span class="keyword">import</span> org.zsr.mvc.rest.RestResponse;</div><div class="line"><span class="keyword">import</span> org.zsr.mvc.service.IUserService;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</div><div class="line"></div><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Autowired</span></div><div class="line">  <span class="keyword">private</span> IUserService userService;</div><div class="line"></div><div class="line">  <span class="meta">@ResponseBody</span></div><div class="line">  <span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;id&#125;"</span>, method = RequestMethod.GET)</div><div class="line">  <span class="function"><span class="keyword">public</span> RestResponse&lt;User&gt; <span class="title">getUser</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id) </span>&#123;</div><div class="line">    User user = userService.getUser(id);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestResponse&lt;User&gt;(<span class="keyword">true</span>, <span class="string">""</span>, user);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@ResponseBody</span></div><div class="line">  <span class="meta">@RequestMapping</span>(method = RequestMethod.POST)</div><div class="line">  <span class="function"><span class="keyword">public</span> RestResponse <span class="title">saveUser</span><span class="params">(@RequestBody User user)</span> </span>&#123;</div><div class="line">    userService.saveUser(user);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestResponse&lt;String&gt;(<span class="keyword">true</span>, <span class="string">""</span>, <span class="keyword">null</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a><strong>å‚è€ƒï¼š</strong></h3><p><a href="http://zhaozhiming.github.io/blog/2014/06/16/spring-mvc-unit-test-part-1/" target="_blank" rel="external">åŸºäºSpring MVCåšå•å…ƒæµ‹è¯•</a></p>
<p><a href="http://sishuok.com/forum/blogPost/list/7981.html" target="_blank" rel="external">Spring MVCæµ‹è¯•æ¡†æ¶è¯¦è§£</a></p>
<p><a href="http://memorynotfound.com/unit-test-spring-mvc-rest-service-junit-mockito/" target="_blank" rel="external">Unit Test Spring MVC Rest Service</a></p>
<p><a href="https://blog.gmem.cc/ut-with-spring-and-mockito" target="_blank" rel="external">åŸºäºSpring Testå’ŒMockitoè¿›è¡Œå•å…ƒæµ‹è¯•</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[CopyOnWrite]]></title>
      <url>http://zsr.github.io/2017/01/23/CopyOnWrite/</url>
      <content type="html"><![CDATA[<p>Copy-On-Writeç®€ç§°COWï¼Œæ˜¯ä¸€ç§ç”¨äºç¨‹åºè®¾è®¡ä¸­çš„ä¼˜åŒ–ç­–ç•¥ã€‚å…¶åŸºæœ¬æ€è·¯æ˜¯ï¼Œä»ä¸€å¼€å§‹å¤§å®¶éƒ½åœ¨å…±äº«åŒä¸€ä¸ªå†…å®¹ï¼Œå½“æŸä¸ªäººæƒ³è¦ä¿®æ”¹è¿™ä¸ªå†…å®¹çš„æ—¶å€™ï¼Œæ‰ä¼šçœŸæ­£æŠŠå†…å®¹Copyå‡ºå»å½¢æˆä¸€ä¸ªæ–°çš„å†…å®¹ç„¶åå†æ”¹ï¼Œè¿™æ˜¯ä¸€ç§å»¶æ—¶æ‡’æƒ°ç­–ç•¥ã€‚ä»JDK1.5å¼€å§‹Javaå¹¶å‘åŒ…é‡Œæä¾›äº†ä¸¤ä¸ªä½¿ç”¨CopyOnWriteæœºåˆ¶å®ç°çš„å¹¶å‘å®¹å™¨,å®ƒä»¬æ˜¯CopyOnWriteArrayListå’ŒCopyOnWriteArraySetã€‚</p>
<p><strong>ç‰¹ç‚¹:</strong></p>
<ul>
<li>è¯»å–å®‰å…¨ï¼ˆä½†æ˜¯ä¸ä¿è¯ç¼“å­˜ä¸€è‡´æ€§ï¼‰ï¼Œå†™å…¥å®‰å…¨ï¼ˆä»£ä»·æ˜¯åŠ äº†é”ï¼Œè€Œä¸”éœ€è¦å…¨é‡å¤åˆ¶ï¼‰</li>
<li>ä¸å»ºè®®ç”¨äºé¢‘ç¹è¯»å†™åœºæ™¯ä¸‹ï¼Œå…¨é‡å¤åˆ¶å¾ˆå®¹æ˜“é€ æˆGCåœé¡¿ï¼Œå› æ­¤å»ºè®®ä½¿ç”¨å¹³æ—¶çš„ConcurrentåŒ…æ¥å®ç°ã€‚</li>
<li>é€‚ç”¨äºå¯¹è±¡ç©ºé—´å ç”¨å¤§ï¼Œä¿®æ”¹æ¬¡æ•°å°‘ï¼Œè€Œä¸”å¯¹æ•°æ®å®æ•ˆæ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ã€‚</li>
</ul>
<h3 id="ä»€ä¹ˆæ˜¯CopyOnWriteå®¹å™¨"><a href="#ä»€ä¹ˆæ˜¯CopyOnWriteå®¹å™¨" class="headerlink" title="ä»€ä¹ˆæ˜¯CopyOnWriteå®¹å™¨"></a>ä»€ä¹ˆæ˜¯CopyOnWriteå®¹å™¨</h3><p>CopyOnWriteå®¹å™¨å³å†™æ—¶å¤åˆ¶çš„å®¹å™¨ã€‚é€šä¿—çš„ç†è§£æ˜¯å½“æˆ‘ä»¬å¾€ä¸€ä¸ªå®¹å™¨æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œä¸ç›´æ¥å¾€å½“å‰å®¹å™¨æ·»åŠ ï¼Œè€Œæ˜¯å…ˆå°†å½“å‰å®¹å™¨è¿›è¡ŒCopyï¼Œå¤åˆ¶å‡ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œç„¶åæ–°çš„å®¹å™¨é‡Œæ·»åŠ å…ƒç´ ï¼Œæ·»åŠ å®Œå…ƒç´ ä¹‹åï¼Œå†å°†åŸå®¹å™¨çš„å¼•ç”¨æŒ‡å‘æ–°çš„å®¹å™¨ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯æˆ‘ä»¬å¯ä»¥å¯¹CopyOnWriteå®¹å™¨è¿›è¡Œå¹¶å‘çš„è¯»ï¼Œè€Œä¸éœ€è¦åŠ é”ï¼Œå› ä¸ºå½“å‰å®¹å™¨ä¸ä¼šæ·»åŠ ä»»ä½•å…ƒç´ ã€‚æ‰€ä»¥CopyOnWriteå®¹å™¨ä¹Ÿæ˜¯ä¸€ç§è¯»å†™åˆ†ç¦»çš„æ€æƒ³ï¼Œè¯»å’Œå†™ä¸åŒçš„å®¹å™¨ã€‚</p>
<h4 id="CopyOnWriteArrayListçš„å®ç°åŸç†"><a href="#CopyOnWriteArrayListçš„å®ç°åŸç†" class="headerlink" title="CopyOnWriteArrayListçš„å®ç°åŸç†"></a>CopyOnWriteArrayListçš„å®ç°åŸç†</h4><p>ä»¥ä¸‹ä»£ç æ˜¯å‘ArrayListé‡Œæ·»åŠ å…ƒç´ ï¼Œå¯ä»¥å‘ç°åœ¨æ·»åŠ çš„æ—¶å€™æ˜¯éœ€è¦åŠ é”çš„ï¼Œå¦åˆ™å¤šçº¿ç¨‹å†™çš„æ—¶å€™ä¼šCopyå‡ºNä¸ªå‰¯æœ¬å‡ºæ¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¯»å–æ“ä½œ(æ²¡æœ‰åŠ é”)</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;  </div><div class="line">       <span class="keyword">return</span> (E)(getArray()[index]);  </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/** </span></div><div class="line">     *å†™æ“ä½œ(åŠ é”çš„ç›®çš„ï¼šé˜²æ­¢å¹¶å‘é‡å¤§æ—¶ï¼Œäº§ç”Ÿè¿‡å¤šçš„å…ƒæ•°æ®å‰¯æœ¬ï¼Œè€—å†…å­˜) </div><div class="line">     */  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;  </div><div class="line">       <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;  </div><div class="line">       lock.lock();  </div><div class="line">       <span class="keyword">try</span> &#123;  </div><div class="line">          Object[] elements = getArray();  </div><div class="line">          <span class="keyword">int</span> len = elements.length;</div><div class="line">          <span class="comment">// å¯¹å…ƒæ•°æ®è¿›è¡Œæ‹·è´</span></div><div class="line">          Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);  </div><div class="line">          <span class="comment">// æŠŠæ–°å…ƒç´ æ·»åŠ åˆ°æ–°æ•°ç»„é‡Œ </span></div><div class="line">          newElements[len] = e;  </div><div class="line">          <span class="comment">// æŠŠåŸæ•°ç»„å¼•ç”¨æŒ‡å‘æ–°æ•°ç»„</span></div><div class="line">          setArray(newElements);</div><div class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;  </div><div class="line">        &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">          lock.unlock();  </div><div class="line">        &#125;  </div><div class="line">   &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯»çš„æ—¶å€™ä¸éœ€è¦åŠ é”ï¼Œå¦‚æœè¯»çš„æ—¶å€™æœ‰å¤šä¸ªçº¿ç¨‹æ­£åœ¨å‘ArrayListæ·»åŠ æ•°æ®ï¼Œè¯»è¿˜æ˜¯ä¼šè¯»åˆ°æ—§çš„æ•°æ®ï¼Œå› ä¸ºå†™çš„æ—¶å€™ä¸ä¼šé”ä½æ—§çš„ArrayListã€‚</p>
<p>JDKä¸­å¹¶æ²¡æœ‰æä¾›CopyOnWriteMapï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒCopyOnWriteArrayListæ¥å®ç°ä¸€ä¸ªï¼ŒåŸºæœ¬ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Collection;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CopyOnWriteMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt;, <span class="title">Cloneable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Map&lt;K, V&gt; internalMap;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CopyOnWriteMap</span><span class="params">()</span> </span>&#123;</div><div class="line">        internalMap = <span class="keyword">new</span> HashMap&lt;K, V&gt;();</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line"> </div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            Map&lt;K, V&gt; newMap = <span class="keyword">new</span> HashMap&lt;K, V&gt;(internalMap);</div><div class="line">            V val = newMap.put(key, value);</div><div class="line">            internalMap = newMap;</div><div class="line">            <span class="keyword">return</span> val;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> internalMap.get(key);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putAll</span><span class="params">(Map&lt;? extends K, ? extends V&gt; newData)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            Map&lt;K, V&gt; newMap = <span class="keyword">new</span> HashMap&lt;K, V&gt;(internalMap);</div><div class="line">            newMap.putAll(newData);</div><div class="line">            internalMap = newMap;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="CopyOnWriteçš„åº”ç”¨åœºæ™¯"><a href="#CopyOnWriteçš„åº”ç”¨åœºæ™¯" class="headerlink" title="CopyOnWriteçš„åº”ç”¨åœºæ™¯"></a>CopyOnWriteçš„åº”ç”¨åœºæ™¯</h3><p>å†™æ—¶å¤åˆ¶æœ€æ“…é•¿çš„æ˜¯å¹¶å‘è¯»å–åœºæ™¯ï¼Œå³å¤šä¸ªçº¿ç¨‹/è¿›ç¨‹å¯ä»¥é€šè¿‡å¯¹ä¸€ä»½ç›¸åŒå¿«ç…§ï¼Œå»å¤„ç†å®æ•ˆæ€§è¦æ±‚ä¸æ˜¯å¾ˆé«˜ä½†æ˜¯ä»ç„¶è¦åšçš„ä¸šåŠ¡ï¼ˆæ¯”å¦‚å®ç°FS\DBå¤‡ä»½ã€æ—¥å¿—ã€åˆ†æï¼‰ã€‚</p>
<h4 id="1-Unixä¸‹çš„fork-ç³»ç»Ÿè°ƒç”¨"><a href="#1-Unixä¸‹çš„fork-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="1. Unixä¸‹çš„fork()ç³»ç»Ÿè°ƒç”¨"></a>1. Unixä¸‹çš„fork()ç³»ç»Ÿè°ƒç”¨</h4><p>fork()æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºåˆ›å»ºæ–°çš„è¿›ç¨‹(process)ã€‚</p>
<p>forkå†…éƒ¨å®é™…ä¸Šæ˜¯å¯¹clone()ç³»ç»Ÿå‡½æ•°çš„è°ƒç”¨ï¼Œå®ƒçš„å‚æ•°<code>CLONE_FLAG</code>å†³å®šäº†éœ€è¦å…±äº«å“ªäº›æ•°æ®ã€‚åœ¨forkä¸­ï¼Œæ²¡æœ‰<code>CLONE_VM</code>å‚æ•°ï¼Œä¹Ÿå°±æ„å‘³ç€ä¸ä¼šå…±äº«\ç«äº‰åŒä¸€ä¸ªå†…å­˜ï¼Œè€Œæ˜¯å¤åˆ¶ä¸€ä¸ªå†…å­˜å¿«ç…§ç»™å­è¿›ç¨‹ï¼Œè¿™ä¸ªå†…å­˜åœ¨32ä½ä¸‹æ˜¯4Gçš„å¤§å°ï¼Œå ç”¨ç©ºé—´ç›¸å½“çš„å¤§ï¼Œå¦‚æœé€šè¿‡ç±»ä¼¼memcpyè¿›è¡Œå†…å­˜å¤åˆ¶çš„è¯ï¼Œforkè°ƒç”¨çš„è€—æ—¶å°†ç›¸å½“æ˜¾è‘—ï¼Œç”šè‡³é˜»å¡ä¸šåŠ¡ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆåœ¨çœŸæ­£å¼€å‘è°ƒç”¨æ—¶å´æ²¡æœ‰å‘ç”Ÿå‘¢ï¼Ÿå› ä¸ºå†…éƒ¨ä¹Ÿæ˜¯é€šè¿‡COWæœºåˆ¶å®ç°çš„ã€‚</p>
<p><strong>å†…æ ¸å®ç°ï¼š</strong></p>
<p>åœ¨å†…æ ¸ä¾§ï¼Œåœ¨è¿›è¡Œäº†å†…å­˜â€œå¤åˆ¶â€åï¼Œå­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹æŒ‡å‘åŒä¸€ä¸ªåªè¯»çš„Pageåˆ†é¡µã€‚å½“å­è¿›ç¨‹æˆ–è€…çˆ¶è¿›ç¨‹å‘é€ä¿®æ”¹å†…å­˜è¯·æ±‚åï¼Œç”±äºæ˜¯åˆ†é¡µæ˜¯åªè¯»çš„ï¼ŒOSæ­¤æ—¶æ‰å°†å†…å­˜è¿›è¡Œå¤åˆ¶ä¸ºä¸¤ä»½ï¼Œå¹¶å°†è¿™ä¸¤ä»½å†…å­˜è®¾ç½®ä¸ºå¯å†™æƒé™ï¼Œæœ€åå†å¤„ç†åˆšåˆšå‘é€çš„ä¿®æ”¹å†…å­˜è¯·æ±‚ã€‚é€šè¿‡ä¸Šè¿°ç­–ç•¥ï¼Œå®ç°äº†å»¶è¿Ÿå¤åˆ¶.</p>
<h4 id="2-Redisçš„æŒä¹…åŒ–"><a href="#2-Redisçš„æŒä¹…åŒ–" class="headerlink" title="2. Redisçš„æŒä¹…åŒ–"></a>2. Redisçš„æŒä¹…åŒ–</h4><p>Redisæ˜¯ä¸€ä¸ªåŸºäºKVçš„MemCacheæ¡†æ¶ï¼Œå¯ä»¥å°†æ•°æ®å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œç‰¹åˆ«é€‚ç”¨äºæŠ¢è´­ã€çº¢åŒ…ç­‰é«˜å¹¶å‘åœºæ™¯ï¼Œå½“ä½ å¸Œæœ›å¯¹æ•°æ®è¿›è¡Œå…¨é‡Dump(bgsave)åˆ°æ–‡ä»¶ä¸­æˆ–è€…è¿›è¡Œä¸»ä»åŒæ­¥æ—¶ï¼Œå°†è¿›è¡Œä¸‹é¢çš„æ­¥éª¤ã€‚</p>
<ul>
<li>Redis forks. We now have a child and a parent process.</li>
<li>The child starts to write the dataset to a temporary RDB file.</li>
<li>When the child is done writing the new RDB file, it replaces the old one.</li>
</ul>
<p>å¯ä»¥çœ‹å‡ºï¼ŒRedisé€šè¿‡fork()ç³»ç»Ÿè°ƒç”¨å®ç°äº†å†™æ—¶å¤åˆ¶ï¼Œè€Œæ²¡æœ‰è‡ªå·±å»é€ è½®å­.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveBackground</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123;</div><div class="line">    <span class="keyword">pid_t</span> childpid;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> start;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (server.aof_child_pid != <span class="number">-1</span> || server.rdb_child_pid != <span class="number">-1</span>) <span class="keyword">return</span> C_ERR;</div><div class="line"></div><div class="line">    server.dirty_before_bgsave = server.dirty;</div><div class="line">    server.lastbgsave_try = time(<span class="literal">NULL</span>);</div><div class="line"></div><div class="line">    start = ustime();</div><div class="line">    <span class="comment">//æŒ‡å‘å­çº¿ç¨‹çš„pidå¦‚æœä¸º0ï¼Œè¡¨ç¤ºforkæˆåŠŸï¼Œä¸ºæ­£è¡¨ç¤ºä¸ºparentçº¿ç¨‹</span></div><div class="line">    <span class="keyword">if</span> ((childpid = fork()) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">int</span> retval;</div><div class="line"></div><div class="line">        <span class="comment">/* Childè¿›ç¨‹è¦æ‰§è¡Œçš„ä»£ç  */</span></div><div class="line">        closeListeningSockets(<span class="number">0</span>);</div><div class="line">        redisSetProcTitle(<span class="string">"redis-rdb-bgsave"</span>);</div><div class="line">        retval = rdbSave(filename);</div><div class="line">        <span class="keyword">if</span> (retval == C_OK) &#123;</div><div class="line">            <span class="keyword">size_t</span> private_dirty = zmalloc_get_private_dirty();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (private_dirty) &#123;</div><div class="line">                serverLog(LL_NOTICE,</div><div class="line">                    <span class="string">"RDB: %zu MB of memory used by copy-on-write"</span>,</div><div class="line">                    private_dirty/(<span class="number">1024</span>*<span class="number">1024</span>));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        exitFromChild((retval == C_OK) ? <span class="number">0</span> : <span class="number">1</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">/* Parent */</span></div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> C_OK;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> C_OK; <span class="comment">/* unreached */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨rdbSaveä¸­(ç›®å‰å·²ç»ä¸ºå­çº¿ç¨‹ä¸­)ï¼Œå…·ä½“å®ç°å¦‚ä¸‹:</p>
<ol>
<li>åˆ›å»ºäº†ä¸€ä¸ª<code>temp-${getPid()}.rdb</code>çš„æ–‡ä»¶</li>
<li>è°ƒç”¨<code>rioInitWithFile(rio *r, FILE *tmp)</code>ï¼Œå°†<code>r</code>åˆå§‹åŒ–ä¸º<code>rioBufferIO</code></li>
<li>å¯¹å…¨å±€å˜é‡<code>server</code>è¿›è¡ŒforEachååºåˆ—åŒ–ï¼Œå¹¶ä¿æŒåˆ°ç¼“å­˜rä¸­ï¼Œå¹¶å†™å…¥æ–‡ä»¶ï¼Œæ³¨æ„è¿™ä¸ªServeræŒ‡é’ˆå·²ç»ä¸çˆ¶è¿›ç¨‹æ— å…³äº†</li>
<li>è¿›è¡Œfflushã€fsyncã€fcloseç³»ç»Ÿè°ƒç”¨æ¸…é™¤OSçš„FSç¼“å­˜ï¼ˆè¿™ä¹Ÿæ˜¯OSå†…éƒ¨çš„COWä¼˜åŒ–ï¼‰</li>
<li>è¿›è¡Œ<code>rename</code>ç³»ç»Ÿè°ƒç”¨ï¼Œè¿›è¡Œé‡å‘½å</li>
</ol>
<p>å¯ä»¥çœ‹å‡ºï¼Œåœ¨Redisä¸­æ²¡æœ‰memcpyç­‰å†…å­˜å¤åˆ¶è¿‡ç¨‹ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨serveræŒ‡é’ˆè¿›è¡Œè¯»å–å¹¶å†™å…¥æ–‡ä»¶ï¼Œå› ä¸ºåœ¨forkæ—¶ï¼Œå·²ç»duplicatedäº†å¿«ç…§ã€‚</p>
<h3 id="CopyOnWriteå®¹å™¨çš„ç¼ºç‚¹"><a href="#CopyOnWriteå®¹å™¨çš„ç¼ºç‚¹" class="headerlink" title="CopyOnWriteå®¹å™¨çš„ç¼ºç‚¹"></a>CopyOnWriteå®¹å™¨çš„ç¼ºç‚¹</h3><p>CopyOnWriteæœ‰å¾ˆå¤šä¼˜ç‚¹ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿå­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼Œå³å†…å­˜å ç”¨é—®é¢˜å’Œæ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚</p>
<p><strong>å†…å­˜å ç”¨é—®é¢˜</strong>ã€‚å› ä¸ºCopyOnWriteçš„å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œå†…å­˜é‡Œä¼šåŒæ—¶é©»æ‰ä¸¤ä¸ªå¯¹è±¡çš„å†…å­˜ï¼Œæ—§çš„å¯¹è±¡å’Œæ–°å†™å…¥çš„å¯¹è±¡ï¼ˆ<strong>æ³¨æ„:åœ¨å¤åˆ¶çš„æ—¶å€™åªæ˜¯å¤åˆ¶å®¹å™¨é‡Œçš„å¼•ç”¨ï¼Œåªæ˜¯åœ¨å†™çš„æ—¶å€™ä¼šåˆ›å»ºæ–°å¯¹è±¡æ·»åŠ åˆ°æ–°å®¹å™¨é‡Œï¼Œè€Œæ—§å®¹å™¨çš„å¯¹è±¡è¿˜åœ¨ä½¿ç”¨ï¼Œæ‰€ä»¥æœ‰ä¸¤ä»½å¯¹è±¡å†…å­˜</strong>ï¼‰ã€‚å¦‚æœè¿™äº›å¯¹è±¡å ç”¨çš„å†…å­˜æ¯”è¾ƒå¤§ï¼Œæ¯”å¦‚è¯´200Må·¦å³ï¼Œé‚£ä¹ˆå†å†™å…¥100Mæ•°æ®è¿›å»ï¼Œå†…å­˜å°±ä¼šå ç”¨300Mï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å¾ˆæœ‰å¯èƒ½é€ æˆé¢‘ç¹çš„Yong GCå’ŒFull GCã€‚</p>
<p>é’ˆå¯¹å†…å­˜å ç”¨é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡å‹ç¼©å®¹å™¨ä¸­çš„å…ƒç´ çš„æ–¹æ³•æ¥å‡å°‘å¤§å¯¹è±¡çš„å†…å­˜æ¶ˆè€—ï¼Œæ¯”å¦‚ï¼Œå¦‚æœå…ƒç´ å…¨æ˜¯10è¿›åˆ¶çš„æ•°å­—ï¼Œå¯ä»¥è€ƒè™‘æŠŠå®ƒå‹ç¼©æˆ36è¿›åˆ¶æˆ–64è¿›åˆ¶ã€‚æˆ–è€…ä¸ä½¿ç”¨CopyOnWriteå®¹å™¨ï¼Œè€Œä½¿ç”¨å…¶ä»–çš„å¹¶å‘å®¹å™¨ï¼Œå¦‚<a href="http://ifeve.com/concurrenthashmap/" target="_blank" rel="external">ConcurrentHashMap</a>ã€‚</p>
<p><strong>æ•°æ®ä¸€è‡´æ€§é—®é¢˜</strong>ã€‚CopyOnWriteå®¹å™¨åªèƒ½ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸èƒ½ä¿è¯æ•°æ®çš„å®æ—¶ä¸€è‡´æ€§ã€‚æ‰€ä»¥å¦‚æœä½ å¸Œæœ›å†™å…¥çš„çš„æ•°æ®ï¼Œé©¬ä¸Šèƒ½è¯»åˆ°ï¼Œè¯·ä¸è¦ä½¿ç”¨CopyOnWriteå®¹å™¨ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Java8 HashMap]]></title>
      <url>http://zsr.github.io/2016/12/14/Java8-HashMap/</url>
      <content type="html"><![CDATA[<p>JDK1.8å¯¹HashMapåº•å±‚çš„å®ç°è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¾‹å¦‚å¼•å…¥çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„å’Œæ‰©å®¹çš„ä¼˜åŒ–ç­‰.</p>
<h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a><strong>ç®€ä»‹</strong></h3><p>Javaä¸ºæ•°æ®ç»“æ„ä¸­çš„æ˜ å°„å®šä¹‰äº†ä¸€ä¸ªæ¥å£java.util.Mapï¼Œæ­¤æ¥å£ä¸»è¦æœ‰å››ä¸ªå¸¸ç”¨çš„å®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯HashMapã€Hashtableã€LinkedHashMapå’ŒTreeMapï¼Œç±»ç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://tech.meituan.com/img/java-hashmap/java.util.map%E7%B1%BB%E5%9B%BE.png" alt="java.util.mapç±»å›¾"></p>
<p>ä¸‹é¢é’ˆå¯¹å„ä¸ªå®ç°ç±»çš„ç‰¹ç‚¹åšä¸€äº›è¯´æ˜ï¼š</p>
<ul>
<li>(1) HashMapï¼šå®ƒæ ¹æ®é”®çš„hashCodeå€¼å­˜å‚¨æ•°æ®ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥ç›´æ¥å®šä½åˆ°å®ƒçš„å€¼ï¼Œå› è€Œå…·æœ‰å¾ˆå¿«çš„è®¿é—®é€Ÿåº¦ï¼Œä½†éå†é¡ºåºå´æ˜¯ä¸ç¡®å®šçš„ã€‚ HashMapæœ€å¤šåªå…è®¸ä¸€æ¡è®°å½•çš„é”®ä¸ºnullï¼Œå…è®¸å¤šæ¡è®°å½•çš„å€¼ä¸ºnullã€‚HashMapéçº¿ç¨‹å®‰å…¨ï¼Œå³ä»»ä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å†™HashMapï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´ã€‚å¦‚æœéœ€è¦æ»¡è¶³çº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥ç”¨ Collectionsçš„synchronizedMapæ–¹æ³•ä½¿HashMapå…·æœ‰çº¿ç¨‹å®‰å…¨çš„èƒ½åŠ›ï¼Œæˆ–è€…ä½¿ç”¨ConcurrentHashMapã€‚</li>
<li>(2) Hashtableï¼šHashtableæ˜¯é—ç•™ç±»ï¼Œå¾ˆå¤šæ˜ å°„çš„å¸¸ç”¨åŠŸèƒ½ä¸HashMapç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯å®ƒæ‰¿è‡ªDictionaryç±»ï¼Œå¹¶ä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä»»ä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å†™Hashtableï¼Œå¹¶å‘æ€§ä¸å¦‚ConcurrentHashMapï¼Œå› ä¸ºConcurrentHashMapå¼•å…¥äº†åˆ†æ®µé”ã€‚Hashtableä¸å»ºè®®åœ¨æ–°ä»£ç ä¸­ä½¿ç”¨ï¼Œä¸éœ€è¦çº¿ç¨‹å®‰å…¨çš„åœºåˆå¯ä»¥ç”¨HashMapæ›¿æ¢ï¼Œéœ€è¦çº¿ç¨‹å®‰å…¨çš„åœºåˆå¯ä»¥ç”¨ConcurrentHashMapæ›¿æ¢ã€‚</li>
<li>(3) LinkedHashMapï¼šLinkedHashMapæ˜¯HashMapçš„ä¸€ä¸ªå­ç±»ï¼Œä¿å­˜äº†è®°å½•çš„æ’å…¥é¡ºåºï¼Œåœ¨ç”¨Iteratoréå†LinkedHashMapæ—¶ï¼Œå…ˆå¾—åˆ°çš„è®°å½•è‚¯å®šæ˜¯å…ˆæ’å…¥çš„ï¼Œä¹Ÿå¯ä»¥åœ¨æ„é€ æ—¶å¸¦å‚æ•°ï¼ŒæŒ‰ç…§è®¿é—®æ¬¡åºæ’åºã€‚</li>
<li>(4) TreeMapï¼šTreeMapå®ç°SortedMapæ¥å£ï¼Œèƒ½å¤ŸæŠŠå®ƒä¿å­˜çš„è®°å½•æ ¹æ®é”®æ’åºï¼Œé»˜è®¤æ˜¯æŒ‰é”®å€¼çš„å‡åºæ’åºï¼Œä¹Ÿå¯ä»¥æŒ‡å®šæ’åºçš„æ¯”è¾ƒå™¨ï¼Œå½“ç”¨Iteratoréå†TreeMapæ—¶ï¼Œå¾—åˆ°çš„è®°å½•æ˜¯æ’è¿‡åºçš„ã€‚å¦‚æœä½¿ç”¨æ’åºçš„æ˜ å°„ï¼Œå»ºè®®ä½¿ç”¨TreeMapã€‚åœ¨ä½¿ç”¨TreeMapæ—¶ï¼Œkeyå¿…é¡»å®ç°Comparableæ¥å£æˆ–è€…åœ¨æ„é€ TreeMapä¼ å…¥è‡ªå®šä¹‰çš„Comparatorï¼Œå¦åˆ™ä¼šåœ¨è¿è¡Œæ—¶æŠ›å‡ºjava.lang.ClassCastExceptionç±»å‹çš„å¼‚å¸¸ã€‚</li>
</ul>
<p>å¯¹äºä¸Šè¿°å››ç§Mapç±»å‹çš„ç±»ï¼Œè¦æ±‚æ˜ å°„ä¸­çš„keyæ˜¯ä¸å¯å˜å¯¹è±¡ã€‚ä¸å¯å˜å¯¹è±¡æ˜¯è¯¥å¯¹è±¡åœ¨åˆ›å»ºåå®ƒçš„å“ˆå¸Œå€¼ä¸ä¼šè¢«æ”¹å˜ã€‚å¦‚æœå¯¹è±¡çš„å“ˆå¸Œå€¼å‘ç”Ÿå˜åŒ–ï¼ŒMapå¯¹è±¡å¾ˆå¯èƒ½å°±å®šä½ä¸åˆ°æ˜ å°„çš„ä½ç½®äº†ã€‚</p>
<p>é€šè¿‡ä¸Šé¢çš„æ¯”è¾ƒï¼Œæˆ‘ä»¬çŸ¥é“äº†HashMapæ˜¯Javaçš„Mapå®¶æ—ä¸­ä¸€ä¸ªæ™®é€šæˆå‘˜ï¼Œé‰´äºå®ƒå¯ä»¥æ»¡è¶³å¤§å¤šæ•°åœºæ™¯çš„ä½¿ç”¨æ¡ä»¶ï¼Œæ‰€ä»¥æ˜¯ä½¿ç”¨é¢‘åº¦æœ€é«˜çš„ä¸€ä¸ªã€‚</p>
<h3 id="å†…éƒ¨å®ç°"><a href="#å†…éƒ¨å®ç°" class="headerlink" title="å†…éƒ¨å®ç°"></a><strong>å†…éƒ¨å®ç°</strong></h3><p>ææ¸…æ¥šHashMapï¼Œé¦–å…ˆéœ€è¦çŸ¥é“HashMapæ˜¯ä»€ä¹ˆï¼Œå³å®ƒçš„å­˜å‚¨ç»“æ„-å­—æ®µï¼›å…¶æ¬¡å¼„æ˜ç™½å®ƒèƒ½å¹²ä»€ä¹ˆï¼Œå³å®ƒçš„åŠŸèƒ½å®ç°-æ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬é’ˆå¯¹è¿™ä¸¤ä¸ªæ–¹é¢è¯¦ç»†å±•å¼€è®²è§£ã€‚</p>
<h4 id="å­˜å‚¨ç»“æ„-å­—æ®µ"><a href="#å­˜å‚¨ç»“æ„-å­—æ®µ" class="headerlink" title="å­˜å‚¨ç»“æ„-å­—æ®µ"></a>å­˜å‚¨ç»“æ„-å­—æ®µ</h4><p>ä»ç»“æ„å®ç°æ¥è®²ï¼ŒHashMapæ˜¯æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ï¼ˆJDK1.8å¢åŠ äº†çº¢é»‘æ ‘éƒ¨åˆ†ï¼‰å®ç°çš„ï¼Œå¦‚ä¸‹å¦‚æ‰€ç¤ºã€‚</p>
<p><img src="http://tech.meituan.com/img/java-hashmap/hashMap%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84%E5%9B%BE.png" alt="hashMapå†…å­˜ç»“æ„å›¾"></p>
<p>è¿™é‡Œéœ€è¦è®²æ˜ç™½ä¸¤ä¸ªé—®é¢˜ï¼šæ•°æ®åº•å±‚å…·ä½“å­˜å‚¨çš„æ˜¯ä»€ä¹ˆï¼Ÿè¿™æ ·çš„å­˜å‚¨æ–¹å¼æœ‰ä»€ä¹ˆä¼˜ç‚¹å‘¢ï¼Ÿ</p>
<a id="more"></a>
<p>(1) ä»æºç å¯çŸ¥ï¼ŒHashMapç±»ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„å­—æ®µï¼Œå°±æ˜¯ Node[] tableï¼Œå³å“ˆå¸Œæ¡¶æ•°ç»„ï¼Œæ˜æ˜¾å®ƒæ˜¯ä¸€ä¸ªNodeçš„æ•°ç»„ã€‚æˆ‘ä»¬æ¥çœ‹Node[JDK1.8]æ˜¯ä½•ç‰©ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> hash;    <span class="comment">//ç”¨æ¥å®šä½æ•°ç»„ç´¢å¼•ä½ç½®</span></div><div class="line">        <span class="keyword">final</span> K key;</div><div class="line">        V value;</div><div class="line">        Node&lt;K,V&gt; next;   <span class="comment">//é“¾è¡¨çš„ä¸‹ä¸€ä¸ªnode</span></div><div class="line"></div><div class="line">        Node(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123; ... &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span></span>&#123; ... &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span> </span>&#123; ... &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; ... &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123; ... &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">setValue</span><span class="params">(V newValue)</span> </span>&#123; ... &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123; ... &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Nodeæ˜¯HashMapçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œå®ç°äº†Map.Entryæ¥å£ï¼Œæœ¬è´¨æ˜¯å°±æ˜¯ä¸€ä¸ªæ˜ å°„(é”®å€¼å¯¹)ã€‚ä¸Šå›¾ä¸­çš„æ¯ä¸ªé»‘è‰²åœ†ç‚¹å°±æ˜¯ä¸€ä¸ªNodeå¯¹è±¡ã€‚</p>
<p>(2) HashMapå°±æ˜¯ä½¿ç”¨å“ˆå¸Œè¡¨æ¥å­˜å‚¨çš„ã€‚å“ˆå¸Œè¡¨ä¸ºè§£å†³å†²çªï¼Œå¯ä»¥é‡‡ç”¨å¼€æ”¾åœ°å€æ³•å’Œé“¾åœ°å€æ³•ç­‰æ¥è§£å†³é—®é¢˜ï¼ŒJavaä¸­HashMapé‡‡ç”¨äº†é“¾åœ°å€æ³•ã€‚é“¾åœ°å€æ³•ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ•°ç»„åŠ é“¾è¡¨çš„ç»“åˆã€‚åœ¨æ¯ä¸ªæ•°ç»„å…ƒç´ ä¸Šéƒ½ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œå½“æ•°æ®è¢«Hashåï¼Œå¾—åˆ°æ•°ç»„ä¸‹æ ‡ï¼ŒæŠŠæ•°æ®æ”¾åœ¨å¯¹åº”ä¸‹æ ‡å…ƒç´ çš„é“¾è¡¨ä¸Šã€‚ä¾‹å¦‚ç¨‹åºæ‰§è¡Œä¸‹é¢ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">map.put(<span class="string">"hello"</span>,<span class="string">"world"</span>);</div></pre></td></tr></table></figure>
<p>ç³»ç»Ÿå°†è°ƒç”¨â€helloâ€è¿™ä¸ªkeyçš„hashCode()æ–¹æ³•å¾—åˆ°å…¶hashCode å€¼ï¼ˆè¯¥æ–¹æ³•é€‚ç”¨äºæ¯ä¸ªJavaå¯¹è±¡ï¼‰ï¼Œç„¶åå†é€šè¿‡Hashç®—æ³•çš„åä¸¤æ­¥è¿ç®—ï¼ˆé«˜ä½è¿ç®—å’Œå–æ¨¡è¿ç®—ï¼Œä¸‹æ–‡æœ‰ä»‹ç»ï¼‰æ¥å®šä½è¯¥é”®å€¼å¯¹çš„å­˜å‚¨ä½ç½®ï¼Œæœ‰æ—¶ä¸¤ä¸ªkeyä¼šå®šä½åˆ°ç›¸åŒçš„ä½ç½®ï¼Œè¡¨ç¤ºå‘ç”Ÿäº†Hashç¢°æ’ã€‚å½“ç„¶Hashç®—æ³•è®¡ç®—ç»“æœè¶Šåˆ†æ•£å‡åŒ€ï¼ŒHashç¢°æ’çš„æ¦‚ç‡å°±è¶Šå°ï¼Œmapçš„å­˜å–æ•ˆç‡å°±ä¼šè¶Šé«˜ã€‚</p>
<p>å¦‚æœå“ˆå¸Œæ¡¶æ•°ç»„å¾ˆå¤§ï¼Œå³ä½¿è¾ƒå·®çš„Hashç®—æ³•ä¹Ÿä¼šæ¯”è¾ƒåˆ†æ•£ï¼Œå¦‚æœå“ˆå¸Œæ¡¶æ•°ç»„æ•°ç»„å¾ˆå°ï¼Œå³ä½¿å¥½çš„Hashç®—æ³•ä¹Ÿä¼šå‡ºç°è¾ƒå¤šç¢°æ’ï¼Œæ‰€ä»¥å°±éœ€è¦åœ¨ç©ºé—´æˆæœ¬å’Œæ—¶é—´æˆæœ¬ä¹‹é—´æƒè¡¡ï¼Œå…¶å®å°±æ˜¯åœ¨æ ¹æ®å®é™…æƒ…å†µç¡®å®šå“ˆå¸Œæ¡¶æ•°ç»„çš„å¤§å°ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šè®¾è®¡å¥½çš„hashç®—æ³•å‡å°‘Hashç¢°æ’ã€‚é‚£ä¹ˆé€šè¿‡ä»€ä¹ˆæ–¹å¼æ¥æ§åˆ¶mapä½¿å¾—Hashç¢°æ’çš„æ¦‚ç‡åˆå°ï¼Œå“ˆå¸Œæ¡¶æ•°ç»„ï¼ˆNode[] tableï¼‰å ç”¨ç©ºé—´åˆå°‘å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯å¥½çš„Hashç®—æ³•å’Œæ‰©å®¹æœºåˆ¶ã€‚</p>
<p>åœ¨ç†è§£Hashå’Œæ‰©å®¹æµç¨‹ä¹‹å‰ï¼Œæˆ‘ä»¬å¾—å…ˆäº†è§£ä¸‹HashMapçš„å‡ ä¸ªå­—æ®µã€‚ä»HashMapçš„é»˜è®¤æ„é€ å‡½æ•°æºç å¯çŸ¥ï¼Œæ„é€ å‡½æ•°å°±æ˜¯å¯¹ä¸‹é¢å‡ ä¸ªå­—æ®µè¿›è¡Œåˆå§‹åŒ–ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> threshold;             <span class="comment">// æ‰€èƒ½å®¹çº³çš„key-valueå¯¹æé™ </span></div><div class="line"><span class="keyword">final</span> <span class="keyword">float</span> loadFactor;    <span class="comment">// è´Ÿè½½å› å­</span></div><div class="line"><span class="keyword">int</span> modCount;  </div><div class="line"><span class="keyword">int</span> size;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼ŒNode[] tableçš„åˆå§‹åŒ–é•¿åº¦length(é»˜è®¤å€¼æ˜¯16)ï¼ŒLoad factorä¸ºè´Ÿè½½å› å­(é»˜è®¤å€¼æ˜¯0.75)ï¼Œthresholdæ˜¯HashMapæ‰€èƒ½å®¹çº³çš„æœ€å¤§æ•°æ®é‡çš„Node(é”®å€¼å¯¹)ä¸ªæ•°ã€‚threshold = length * Load factorã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ•°ç»„å®šä¹‰å¥½é•¿åº¦ä¹‹åï¼Œè´Ÿè½½å› å­è¶Šå¤§ï¼Œæ‰€èƒ½å®¹çº³çš„é”®å€¼å¯¹ä¸ªæ•°è¶Šå¤šã€‚</p>
<p>ç»“åˆè´Ÿè½½å› å­çš„å®šä¹‰å…¬å¼å¯çŸ¥ï¼Œthresholdå°±æ˜¯åœ¨æ­¤Load factorå’Œlength(æ•°ç»„é•¿åº¦)å¯¹åº”ä¸‹å…è®¸çš„æœ€å¤§å…ƒç´ æ•°ç›®ï¼Œè¶…è¿‡è¿™ä¸ªæ•°ç›®å°±é‡æ–°resize(æ‰©å®¹)ï¼Œæ‰©å®¹åçš„HashMapå®¹é‡æ˜¯ä¹‹å‰å®¹é‡çš„ä¸¤å€ã€‚é»˜è®¤çš„è´Ÿè½½å› å­0.75æ˜¯å¯¹ç©ºé—´å’Œæ—¶é—´æ•ˆç‡çš„ä¸€ä¸ªå¹³è¡¡é€‰æ‹©ï¼Œå»ºè®®å¤§å®¶ä¸è¦ä¿®æ”¹ï¼Œé™¤éåœ¨æ—¶é—´å’Œç©ºé—´æ¯”è¾ƒç‰¹æ®Šçš„æƒ…å†µä¸‹ï¼Œå¦‚æœå†…å­˜ç©ºé—´å¾ˆå¤šè€Œåˆå¯¹æ—¶é—´æ•ˆç‡è¦æ±‚å¾ˆé«˜ï¼Œå¯ä»¥é™ä½è´Ÿè½½å› å­Load factorçš„å€¼ï¼›ç›¸åï¼Œå¦‚æœå†…å­˜ç©ºé—´ç´§å¼ è€Œå¯¹æ—¶é—´æ•ˆç‡è¦æ±‚ä¸é«˜ï¼Œå¯ä»¥å¢åŠ è´Ÿè½½å› å­loadFactorçš„å€¼ï¼Œè¿™ä¸ªå€¼å¯ä»¥å¤§äº1ã€‚</p>
<p>sizeè¿™ä¸ªå­—æ®µå…¶å®å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯HashMapä¸­å®é™…å­˜åœ¨çš„é”®å€¼å¯¹æ•°é‡ã€‚æ³¨æ„å’Œtableçš„é•¿åº¦lengthã€å®¹çº³æœ€å¤§é”®å€¼å¯¹æ•°é‡thresholdçš„åŒºåˆ«ã€‚è€ŒmodCountå­—æ®µä¸»è¦ç”¨æ¥è®°å½•HashMapå†…éƒ¨ç»“æ„å‘ç”Ÿå˜åŒ–çš„æ¬¡æ•°ï¼Œä¸»è¦ç”¨äºè¿­ä»£çš„å¿«é€Ÿå¤±è´¥ã€‚å¼ºè°ƒä¸€ç‚¹ï¼Œå†…éƒ¨ç»“æ„å‘ç”Ÿå˜åŒ–æŒ‡çš„æ˜¯ç»“æ„å‘ç”Ÿå˜åŒ–ï¼Œä¾‹å¦‚putæ–°é”®å€¼å¯¹ï¼Œä½†æ˜¯æŸä¸ªkeyå¯¹åº”çš„valueå€¼è¢«è¦†ç›–ä¸å±äºç»“æ„å˜åŒ–ã€‚</p>
<p>åœ¨HashMapä¸­ï¼Œå“ˆå¸Œæ¡¶æ•°ç»„tableçš„é•¿åº¦lengthå¤§å°å¿…é¡»ä¸º2çš„næ¬¡æ–¹(ä¸€å®šæ˜¯åˆæ•°)ï¼Œè¿™æ˜¯ä¸€ç§éå¸¸è§„çš„è®¾è®¡ï¼Œå¸¸è§„çš„è®¾è®¡æ˜¯æŠŠæ¡¶çš„å¤§å°è®¾è®¡ä¸ºç´ æ•°ã€‚ç›¸å¯¹æ¥è¯´ç´ æ•°å¯¼è‡´å†²çªçš„æ¦‚ç‡è¦å°äºåˆæ•°ï¼Œå…·ä½“è¯æ˜å¯ä»¥å‚è€ƒ<a href="http://blog.csdn.net/liuqiyao_01/article/details/14475159" target="_blank" rel="external">http://blog.csdn.net/liuqiyao_01/article/details/14475159</a>ï¼ŒHashtableåˆå§‹åŒ–æ¡¶å¤§å°ä¸º11ï¼Œå°±æ˜¯æ¡¶å¤§å°è®¾è®¡ä¸ºç´ æ•°çš„åº”ç”¨ï¼ˆHashtableæ‰©å®¹åä¸èƒ½ä¿è¯è¿˜æ˜¯ç´ æ•°ï¼‰ã€‚HashMapé‡‡ç”¨è¿™ç§éå¸¸è§„è®¾è®¡ï¼Œä¸»è¦æ˜¯ä¸ºäº†åœ¨å–æ¨¡å’Œæ‰©å®¹æ—¶åšä¼˜åŒ–ï¼ŒåŒæ—¶ä¸ºäº†å‡å°‘å†²çªï¼ŒHashMapå®šä½å“ˆå¸Œæ¡¶ç´¢å¼•ä½ç½®æ—¶ï¼Œä¹ŸåŠ å…¥äº†é«˜ä½å‚ä¸è¿ç®—çš„è¿‡ç¨‹ã€‚</p>
<p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå³ä½¿è´Ÿè½½å› å­å’ŒHashç®—æ³•è®¾è®¡çš„å†åˆç†ï¼Œä¹Ÿå…ä¸äº†ä¼šå‡ºç°æ‹‰é“¾è¿‡é•¿çš„æƒ…å†µï¼Œä¸€æ—¦å‡ºç°æ‹‰é“¾è¿‡é•¿ï¼Œåˆ™ä¼šä¸¥é‡å½±å“HashMapçš„æ€§èƒ½ã€‚äºæ˜¯ï¼Œåœ¨JDK1.8ç‰ˆæœ¬ä¸­ï¼Œå¯¹æ•°æ®ç»“æ„åšäº†è¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œå¼•å…¥äº†çº¢é»‘æ ‘ã€‚è€Œå½“é“¾è¡¨é•¿åº¦å¤ªé•¿ï¼ˆé»˜è®¤è¶…è¿‡8ï¼‰æ—¶ï¼Œé“¾è¡¨å°±è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œåˆ©ç”¨çº¢é»‘æ ‘å¿«é€Ÿå¢åˆ æ”¹æŸ¥çš„ç‰¹ç‚¹æé«˜HashMapçš„æ€§èƒ½ï¼Œå…¶ä¸­ä¼šç”¨åˆ°çº¢é»‘æ ‘çš„æ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾ç­‰ç®—æ³•ã€‚æœ¬æ–‡ä¸å†å¯¹çº¢é»‘æ ‘å±•å¼€è®¨è®ºï¼Œæƒ³äº†è§£æ›´å¤šçº¢é»‘æ ‘æ•°æ®ç»“æ„çš„å·¥ä½œåŸç†å¯ä»¥å‚è€ƒ<a href="http://blog.csdn.net/v_july_v/article/details/6105630" target="_blank" rel="external">http://blog.csdn.net/v_july_v/article/details/6105630</a>ã€‚</p>
<h3 id="åŠŸèƒ½å®ç°-æ–¹æ³•"><a href="#åŠŸèƒ½å®ç°-æ–¹æ³•" class="headerlink" title="åŠŸèƒ½å®ç°-æ–¹æ³•"></a>åŠŸèƒ½å®ç°-æ–¹æ³•</h3><p>HashMapçš„å†…éƒ¨åŠŸèƒ½å®ç°å¾ˆå¤šï¼Œæœ¬æ–‡ä¸»è¦ä»æ ¹æ®keyè·å–å“ˆå¸Œæ¡¶æ•°ç»„ç´¢å¼•ä½ç½®ã€putæ–¹æ³•çš„è¯¦ç»†æ‰§è¡Œã€æ‰©å®¹è¿‡ç¨‹ä¸‰ä¸ªå…·æœ‰ä»£è¡¨æ€§çš„ç‚¹æ·±å…¥å±•å¼€è®²è§£ã€‚</p>
<h4 id="1-ç¡®å®šå“ˆå¸Œæ¡¶æ•°ç»„ç´¢å¼•ä½ç½®"><a href="#1-ç¡®å®šå“ˆå¸Œæ¡¶æ•°ç»„ç´¢å¼•ä½ç½®" class="headerlink" title="1. ç¡®å®šå“ˆå¸Œæ¡¶æ•°ç»„ç´¢å¼•ä½ç½®"></a>1. ç¡®å®šå“ˆå¸Œæ¡¶æ•°ç»„ç´¢å¼•ä½ç½®</h4><p>ä¸ç®¡å¢åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾é”®å€¼å¯¹ï¼Œå®šä½åˆ°å“ˆå¸Œæ¡¶æ•°ç»„çš„ä½ç½®éƒ½æ˜¯å¾ˆå…³é”®çš„ç¬¬ä¸€æ­¥ã€‚å‰é¢è¯´è¿‡HashMapçš„æ•°æ®ç»“æ„æ˜¯æ•°ç»„å’Œé“¾è¡¨çš„ç»“åˆï¼Œæ‰€ä»¥æˆ‘ä»¬å½“ç„¶å¸Œæœ›è¿™ä¸ªHashMapé‡Œé¢çš„å…ƒç´ ä½ç½®å°½é‡åˆ†å¸ƒå‡åŒ€äº›ï¼Œå°½é‡ä½¿å¾—æ¯ä¸ªä½ç½®ä¸Šçš„å…ƒç´ æ•°é‡åªæœ‰ä¸€ä¸ªï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬ç”¨hashç®—æ³•æ±‚å¾—è¿™ä¸ªä½ç½®çš„æ—¶å€™ï¼Œé©¬ä¸Šå°±å¯ä»¥çŸ¥é“å¯¹åº”ä½ç½®çš„å…ƒç´ å°±æ˜¯æˆ‘ä»¬è¦çš„ï¼Œä¸ç”¨éå†é“¾è¡¨ï¼Œå¤§å¤§ä¼˜åŒ–äº†æŸ¥è¯¢çš„æ•ˆç‡ã€‚HashMapå®šä½æ•°ç»„ç´¢å¼•ä½ç½®ï¼Œç›´æ¥å†³å®šäº†hashæ–¹æ³•çš„ç¦»æ•£æ€§èƒ½ã€‚å…ˆçœ‹çœ‹æºç çš„å®ç°(æ–¹æ³•ä¸€+æ–¹æ³•äºŒ):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">æ–¹æ³•ä¸€ï¼š</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;   <span class="comment">//jdk1.8 &amp; jdk1.7</span></div><div class="line">     <span class="keyword">int</span> h;</div><div class="line">     <span class="comment">// h = key.hashCode() ä¸ºç¬¬ä¸€æ­¥ å–hashCodeå€¼</span></div><div class="line">     <span class="comment">// h ^ (h &gt;&gt;&gt; 16)  ä¸ºç¬¬äºŒæ­¥ é«˜ä½å‚ä¸è¿ç®—</span></div><div class="line">     <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</div><div class="line">&#125;</div><div class="line">æ–¹æ³•äºŒï¼š</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">indexFor</span><span class="params">(<span class="keyword">int</span> h, <span class="keyword">int</span> length)</span> </span>&#123;  <span class="comment">//jdk1.7çš„æºç ï¼Œjdk1.8æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯å®ç°åŸç†ä¸€æ ·çš„</span></div><div class="line">     <span class="keyword">return</span> h &amp; (length-<span class="number">1</span>);  <span class="comment">//ç¬¬ä¸‰æ­¥ å–æ¨¡è¿ç®—</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„Hashç®—æ³•æœ¬è´¨ä¸Šå°±æ˜¯ä¸‰æ­¥ï¼š<strong>å–keyçš„hashCodeå€¼ã€é«˜ä½è¿ç®—ã€å–æ¨¡è¿ç®—</strong>ã€‚</p>
<p>å¯¹äºä»»æ„ç»™å®šçš„å¯¹è±¡ï¼Œåªè¦å®ƒçš„hashCode()è¿”å›å€¼ç›¸åŒï¼Œé‚£ä¹ˆç¨‹åºè°ƒç”¨æ–¹æ³•ä¸€æ‰€è®¡ç®—å¾—åˆ°çš„Hashç å€¼æ€»æ˜¯ç›¸åŒçš„ã€‚æˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯æŠŠhashå€¼å¯¹æ•°ç»„é•¿åº¦å–æ¨¡è¿ç®—ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå…ƒç´ çš„åˆ†å¸ƒç›¸å¯¹æ¥è¯´æ˜¯æ¯”è¾ƒå‡åŒ€çš„ã€‚ä½†æ˜¯ï¼Œæ¨¡è¿ç®—çš„æ¶ˆè€—è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œåœ¨HashMapä¸­æ˜¯è¿™æ ·åšçš„ï¼šè°ƒç”¨æ–¹æ³•äºŒæ¥è®¡ç®—è¯¥å¯¹è±¡åº”è¯¥ä¿å­˜åœ¨tableæ•°ç»„çš„å“ªä¸ªç´¢å¼•å¤„ã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•éå¸¸å·§å¦™ï¼Œå®ƒé€šè¿‡h &amp; (table.length -1)æ¥å¾—åˆ°è¯¥å¯¹è±¡çš„ä¿å­˜ä½ï¼Œè€ŒHashMapåº•å±‚æ•°ç»„çš„é•¿åº¦æ€»æ˜¯2çš„næ¬¡æ–¹ï¼Œè¿™æ˜¯HashMapåœ¨é€Ÿåº¦ä¸Šçš„ä¼˜åŒ–ã€‚å½“lengthæ€»æ˜¯2çš„næ¬¡æ–¹æ—¶ï¼Œh&amp; (length-1)è¿ç®—ç­‰ä»·äºå¯¹lengthå–æ¨¡ï¼Œä¹Ÿå°±æ˜¯h%lengthï¼Œä½†æ˜¯&amp;æ¯”%å…·æœ‰æ›´é«˜çš„æ•ˆç‡ã€‚</p>
<p>åœ¨JDK1.8çš„å®ç°ä¸­ï¼Œä¼˜åŒ–äº†é«˜ä½è¿ç®—çš„ç®—æ³•ï¼Œé€šè¿‡hashCode()çš„é«˜16ä½å¼‚æˆ–ä½16ä½å®ç°çš„ï¼š(h = k.hashCode()) ^ (h &gt;&gt;&gt; 16)ï¼Œä¸»è¦æ˜¯ä»é€Ÿåº¦ã€åŠŸæ•ˆã€è´¨é‡æ¥è€ƒè™‘çš„ï¼Œè¿™ä¹ˆåšå¯ä»¥åœ¨æ•°ç»„tableçš„lengthæ¯”è¾ƒå°çš„æ—¶å€™ï¼Œä¹Ÿèƒ½ä¿è¯è€ƒè™‘åˆ°é«˜ä½ä½éƒ½å‚ä¸åˆ°Hashçš„è®¡ç®—ä¸­ï¼ŒåŒæ—¶ä¸ä¼šæœ‰å¤ªå¤§çš„å¼€é”€ã€‚</p>
<p>ä¸‹é¢ä¸¾ä¾‹è¯´æ˜ä¸‹ï¼Œnä¸ºtableçš„é•¿åº¦ã€‚</p>
<p><img src="http://tech.meituan.com/img/java-hashmap/hashMap%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E4%BE%8B%E5%9B%BE.png" alt="hashMapå“ˆå¸Œç®—æ³•ä¾‹å›¾"></p>
<h4 id="2-åˆ†æHashMapçš„putæ–¹æ³•"><a href="#2-åˆ†æHashMapçš„putæ–¹æ³•" class="headerlink" title="2. åˆ†æHashMapçš„putæ–¹æ³•"></a>2. åˆ†æHashMapçš„putæ–¹æ³•</h4><p>HashMapçš„putæ–¹æ³•æ‰§è¡Œè¿‡ç¨‹å¯ä»¥é€šè¿‡ä¸‹å›¾æ¥ç†è§£ï¼Œè‡ªå·±æœ‰å…´è¶£å¯ä»¥å»å¯¹æ¯”æºç æ›´æ¸…æ¥šåœ°ç ”ç©¶å­¦ä¹ ã€‚</p>
<p><img src="http://tech.meituan.com/img/java-hashmap/hashMap%20put%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="hashMap putæ–¹æ³•æ‰§è¡Œæµç¨‹å›¾"></p>
<p>â‘ .åˆ¤æ–­é”®å€¼å¯¹æ•°ç»„table[i]æ˜¯å¦ä¸ºç©ºæˆ–ä¸ºnullï¼Œå¦åˆ™æ‰§è¡Œresize()è¿›è¡Œæ‰©å®¹ï¼›</p>
<p>â‘¡.æ ¹æ®é”®å€¼keyè®¡ç®—hashå€¼å¾—åˆ°æ’å…¥çš„æ•°ç»„ç´¢å¼•iï¼Œå¦‚æœtable[i]==nullï¼Œç›´æ¥æ–°å»ºèŠ‚ç‚¹æ·»åŠ ï¼Œè½¬å‘â‘¥ï¼Œå¦‚æœtable[i]ä¸ä¸ºç©ºï¼Œè½¬å‘â‘¢ï¼›</p>
<p>â‘¢.åˆ¤æ–­table[i]çš„é¦–ä¸ªå…ƒç´ æ˜¯å¦å’Œkeyä¸€æ ·ï¼Œå¦‚æœç›¸åŒç›´æ¥è¦†ç›–valueï¼Œå¦åˆ™è½¬å‘â‘£ï¼Œè¿™é‡Œçš„ç›¸åŒæŒ‡çš„æ˜¯hashCodeä»¥åŠequalsï¼›</p>
<p>â‘£.åˆ¤æ–­table[i] æ˜¯å¦ä¸ºtreeNodeï¼Œå³table[i] æ˜¯å¦æ˜¯çº¢é»‘æ ‘ï¼Œå¦‚æœæ˜¯çº¢é»‘æ ‘ï¼Œåˆ™ç›´æ¥åœ¨æ ‘ä¸­æ’å…¥é”®å€¼å¯¹ï¼Œå¦åˆ™è½¬å‘â‘¤ï¼›</p>
<p>â‘¤.éå†table[i]ï¼Œåˆ¤æ–­é“¾è¡¨é•¿åº¦æ˜¯å¦å¤§äº8ï¼Œå¤§äº8çš„è¯æŠŠé“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œåœ¨çº¢é»‘æ ‘ä¸­æ‰§è¡Œæ’å…¥æ“ä½œï¼Œå¦åˆ™è¿›è¡Œé“¾è¡¨çš„æ’å…¥æ“ä½œï¼›éå†è¿‡ç¨‹ä¸­è‹¥å‘ç°keyå·²ç»å­˜åœ¨ç›´æ¥è¦†ç›–valueå³å¯ï¼›</p>
<p>â‘¥.æ’å…¥æˆåŠŸåï¼Œåˆ¤æ–­å®é™…å­˜åœ¨çš„é”®å€¼å¯¹æ•°é‡sizeæ˜¯å¦è¶…å¤šäº†æœ€å¤§å®¹é‡thresholdï¼Œå¦‚æœè¶…è¿‡ï¼Œè¿›è¡Œæ‰©å®¹ã€‚</p>
<p>JDK1.8HashMapçš„putæ–¹æ³•æºç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"> <span class="number">1</span> <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>     <span class="comment">// å¯¹keyçš„hashCode()åšhash</span></div><div class="line"> <span class="number">3</span>     <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line"> <span class="number">4</span> &#125;</div><div class="line"> <span class="number">5</span> </div><div class="line"> <span class="number">6</span> <span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></div><div class="line"> <span class="number">7</span>                <span class="keyword">boolean</span> evict) &#123;</div><div class="line"> <span class="number">8</span>     Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</div><div class="line"> <span class="number">9</span>     <span class="comment">// æ­¥éª¤â‘ ï¼štabä¸ºç©ºåˆ™åˆ›å»º</span></div><div class="line"><span class="number">10</span>     <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</div><div class="line"><span class="number">11</span>         n = (tab = resize()).length;</div><div class="line"><span class="number">12</span>     <span class="comment">// æ­¥éª¤â‘¡ï¼šè®¡ç®—indexï¼Œå¹¶å¯¹nullåšå¤„ç† </span></div><div class="line"><span class="number">13</span>     <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>) </div><div class="line"><span class="number">14</span>         tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</div><div class="line"><span class="number">15</span>     <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">16</span>         Node&lt;K,V&gt; e; K k;</div><div class="line"><span class="number">17</span>         <span class="comment">// æ­¥éª¤â‘¢ï¼šèŠ‚ç‚¹keyå­˜åœ¨ï¼Œç›´æ¥è¦†ç›–value</span></div><div class="line"><span class="number">18</span>         <span class="keyword">if</span> (p.hash == hash &amp;&amp;</div><div class="line"><span class="number">19</span>             ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line"><span class="number">20</span>             e = p;</div><div class="line"><span class="number">21</span>         <span class="comment">// æ­¥éª¤â‘£ï¼šåˆ¤æ–­è¯¥é“¾ä¸ºçº¢é»‘æ ‘</span></div><div class="line"><span class="number">22</span>         <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</div><div class="line"><span class="number">23</span>             e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</div><div class="line"><span class="number">24</span>         <span class="comment">// æ­¥éª¤â‘¤ï¼šè¯¥é“¾ä¸ºé“¾è¡¨</span></div><div class="line"><span class="number">25</span>         <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">26</span>             <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</div><div class="line"><span class="number">27</span>                 <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">28</span>                     p.next = newNode(hash, key,value,<span class="keyword">null</span>);</div><div class="line">                        <span class="comment">//é“¾è¡¨é•¿åº¦å¤§äº8è½¬æ¢ä¸ºçº¢é»‘æ ‘è¿›è¡Œå¤„ç†</span></div><div class="line"><span class="number">29</span>                     <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st  </span></div><div class="line"><span class="number">30</span>                         treeifyBin(tab, hash);</div><div class="line"><span class="number">31</span>                     <span class="keyword">break</span>;</div><div class="line"><span class="number">32</span>                 &#125;</div><div class="line">                    <span class="comment">// keyå·²ç»å­˜åœ¨ç›´æ¥è¦†ç›–value</span></div><div class="line"><span class="number">33</span>                 <span class="keyword">if</span> (e.hash == hash &amp;&amp;</div><div class="line"><span class="number">34</span>                     ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) </div><div class="line"><span class="number">35</span>                            <span class="keyword">break</span>;</div><div class="line"><span class="number">36</span>                 p = e;</div><div class="line"><span class="number">37</span>             &#125;</div><div class="line"><span class="number">38</span>         &#125;</div><div class="line"><span class="number">39</span>         </div><div class="line"><span class="number">40</span>         <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></div><div class="line"><span class="number">41</span>             V oldValue = e.value;</div><div class="line"><span class="number">42</span>             <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</div><div class="line"><span class="number">43</span>                 e.value = value;</div><div class="line"><span class="number">44</span>             afterNodeAccess(e);</div><div class="line"><span class="number">45</span>             <span class="keyword">return</span> oldValue;</div><div class="line"><span class="number">46</span>         &#125;</div><div class="line"><span class="number">47</span>     &#125;</div><div class="line"></div><div class="line"><span class="number">48</span>     ++modCount;</div><div class="line"><span class="number">49</span>     <span class="comment">// æ­¥éª¤â‘¥ï¼šè¶…è¿‡æœ€å¤§å®¹é‡ å°±æ‰©å®¹</span></div><div class="line"><span class="number">50</span>     <span class="keyword">if</span> (++size &gt; threshold)</div><div class="line"><span class="number">51</span>         resize();</div><div class="line"><span class="number">52</span>     afterNodeInsertion(evict);</div><div class="line"><span class="number">53</span>     <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">54</span> &#125;</div></pre></td></tr></table></figure>
<h4 id="3-æ‰©å®¹æœºåˆ¶"><a href="#3-æ‰©å®¹æœºåˆ¶" class="headerlink" title="3. æ‰©å®¹æœºåˆ¶"></a>3. æ‰©å®¹æœºåˆ¶</h4><p>æ‰©å®¹(resize)å°±æ˜¯é‡æ–°è®¡ç®—å®¹é‡ï¼Œå‘HashMapå¯¹è±¡é‡Œä¸åœçš„æ·»åŠ å…ƒç´ ï¼Œè€ŒHashMapå¯¹è±¡å†…éƒ¨çš„æ•°ç»„æ— æ³•è£…è½½æ›´å¤šçš„å…ƒç´ æ—¶ï¼Œå¯¹è±¡å°±éœ€è¦æ‰©å¤§æ•°ç»„çš„é•¿åº¦ï¼Œä»¥ä¾¿èƒ½è£…å…¥æ›´å¤šçš„å…ƒç´ ã€‚å½“ç„¶Javaé‡Œçš„æ•°ç»„æ˜¯æ— æ³•è‡ªåŠ¨æ‰©å®¹çš„ï¼Œæ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ªæ–°çš„æ•°ç»„ä»£æ›¿å·²æœ‰çš„å®¹é‡å°çš„æ•°ç»„ï¼Œå°±åƒæˆ‘ä»¬ç”¨ä¸€ä¸ªå°æ¡¶è£…æ°´ï¼Œå¦‚æœæƒ³è£…æ›´å¤šçš„æ°´ï¼Œå°±å¾—æ¢å¤§æ°´æ¡¶ã€‚</p>
<p>æˆ‘ä»¬åˆ†æä¸‹resizeçš„æºç ï¼Œé‰´äºJDK1.8èå…¥äº†çº¢é»‘æ ‘ï¼Œè¾ƒå¤æ‚ï¼Œä¸ºäº†ä¾¿äºç†è§£æˆ‘ä»¬ä»ç„¶ä½¿ç”¨JDK1.7çš„ä»£ç ï¼Œå¥½ç†è§£ä¸€äº›ï¼Œæœ¬è´¨ä¸ŠåŒºåˆ«ä¸å¤§ï¼Œå…·ä½“åŒºåˆ«åæ–‡å†è¯´ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"> <span class="number">1</span> <span class="function"><span class="keyword">void</span> <span class="title">resize</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>&#123;   <span class="comment">//ä¼ å…¥æ–°çš„å®¹é‡</span></div><div class="line"> <span class="number">2</span>     Entry[] oldTable = table;    <span class="comment">//å¼•ç”¨æ‰©å®¹å‰çš„Entryæ•°ç»„</span></div><div class="line"> <span class="number">3</span>     <span class="keyword">int</span> oldCapacity = oldTable.length;         </div><div class="line"> <span class="number">4</span>     <span class="keyword">if</span> (oldCapacity == MAXIMUM_CAPACITY) &#123;  <span class="comment">//æ‰©å®¹å‰çš„æ•°ç»„å¤§å°å¦‚æœå·²ç»è¾¾åˆ°æœ€å¤§(2^30)äº†</span></div><div class="line"> <span class="number">5</span>         threshold = Integer.MAX_VALUE; <span class="comment">//ä¿®æ”¹é˜ˆå€¼ä¸ºintçš„æœ€å¤§å€¼(2^31-1)ï¼Œè¿™æ ·ä»¥åå°±ä¸ä¼šæ‰©å®¹äº†</span></div><div class="line"> <span class="number">6</span>         <span class="keyword">return</span>;</div><div class="line"> <span class="number">7</span>     &#125;</div><div class="line"> <span class="number">8</span>  </div><div class="line"> <span class="number">9</span>     Entry[] newTable = <span class="keyword">new</span> Entry[newCapacity];  <span class="comment">//åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„Entryæ•°ç»„</span></div><div class="line"><span class="number">10</span>     transfer(newTable);                         <span class="comment">//ï¼ï¼å°†æ•°æ®è½¬ç§»åˆ°æ–°çš„Entryæ•°ç»„é‡Œ</span></div><div class="line"><span class="number">11</span>     table = newTable;                           <span class="comment">//HashMapçš„tableå±æ€§å¼•ç”¨æ–°çš„Entryæ•°ç»„</span></div><div class="line"><span class="number">12</span>     threshold = (<span class="keyword">int</span>)(newCapacity * loadFactor);<span class="comment">//ä¿®æ”¹é˜ˆå€¼</span></div><div class="line"><span class="number">13</span> &#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±æ˜¯ä½¿ç”¨ä¸€ä¸ªå®¹é‡æ›´å¤§çš„æ•°ç»„æ¥ä»£æ›¿å·²æœ‰çš„å®¹é‡å°çš„æ•°ç»„ï¼Œtransfer()æ–¹æ³•å°†åŸæœ‰Entryæ•°ç»„çš„å…ƒç´ æ‹·è´åˆ°æ–°çš„Entryæ•°ç»„é‡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"> <span class="number">1</span> <span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Entry[] newTable)</span> </span>&#123;</div><div class="line"> <span class="number">2</span>     Entry[] src = table;                   <span class="comment">//srcå¼•ç”¨äº†æ—§çš„Entryæ•°ç»„</span></div><div class="line"> <span class="number">3</span>     <span class="keyword">int</span> newCapacity = newTable.length;</div><div class="line"> <span class="number">4</span>     <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; src.length; j++) &#123; <span class="comment">//éå†æ—§çš„Entryæ•°ç»„</span></div><div class="line"> <span class="number">5</span>         Entry&lt;K,V&gt; e = src[j];             <span class="comment">//å–å¾—æ—§Entryæ•°ç»„çš„æ¯ä¸ªå…ƒç´ </span></div><div class="line"> <span class="number">6</span>         <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line"> <span class="number">7</span>             src[j] = <span class="keyword">null</span>;<span class="comment">//é‡Šæ”¾æ—§Entryæ•°ç»„çš„å¯¹è±¡å¼•ç”¨ï¼ˆforå¾ªç¯åï¼Œæ—§çš„Entryæ•°ç»„ä¸å†å¼•ç”¨ä»»ä½•å¯¹è±¡ï¼‰</span></div><div class="line"> <span class="number">8</span>             do &#123;</div><div class="line"> <span class="number">9</span>                 Entry&lt;K,V&gt; next = e.next;</div><div class="line"><span class="number">10</span>                 <span class="keyword">int</span> i = indexFor(e.hash, newCapacity); <span class="comment">//ï¼ï¼é‡æ–°è®¡ç®—æ¯ä¸ªå…ƒç´ åœ¨æ•°ç»„ä¸­çš„ä½ç½®</span></div><div class="line"><span class="number">11</span>                 e.next = newTable[i]; <span class="comment">//æ ‡è®°[1]</span></div><div class="line"><span class="number">12</span>                 newTable[i] = e;      <span class="comment">//å°†å…ƒç´ æ”¾åœ¨æ•°ç»„ä¸Š</span></div><div class="line"><span class="number">13</span>                 e = next;             <span class="comment">//è®¿é—®ä¸‹ä¸€ä¸ªEntryé“¾ä¸Šçš„å…ƒç´ </span></div><div class="line"><span class="number">14</span>             &#125; <span class="keyword">while</span> (e != <span class="keyword">null</span>);</div><div class="line"><span class="number">15</span>         &#125;</div><div class="line"><span class="number">16</span>     &#125;</div><div class="line"><span class="number">17</span> &#125;</div></pre></td></tr></table></figure>
<p>newTable[i]çš„å¼•ç”¨èµ‹ç»™äº†e.nextï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨äº†å•é“¾è¡¨çš„å¤´æ’å…¥æ–¹å¼ï¼ŒåŒä¸€ä½ç½®ä¸Šæ–°å…ƒç´ æ€»ä¼šè¢«æ”¾åœ¨é“¾è¡¨çš„å¤´éƒ¨ä½ç½®ï¼›è¿™æ ·å…ˆæ”¾åœ¨ä¸€ä¸ªç´¢å¼•ä¸Šçš„å…ƒç´ ç»ˆä¼šè¢«æ”¾åˆ°Entryé“¾çš„å°¾éƒ¨(å¦‚æœå‘ç”Ÿäº†hashå†²çªçš„è¯ï¼‰ï¼Œè¿™ä¸€ç‚¹å’ŒJdk1.8æœ‰åŒºåˆ«ï¼Œä¸‹æ–‡è¯¦è§£ã€‚åœ¨æ—§æ•°ç»„ä¸­åŒä¸€æ¡Entryé“¾ä¸Šçš„å…ƒç´ ï¼Œé€šè¿‡é‡æ–°è®¡ç®—ç´¢å¼•ä½ç½®åï¼Œæœ‰å¯èƒ½è¢«æ”¾åˆ°äº†æ–°æ•°ç»„çš„ä¸åŒä½ç½®ä¸Šã€‚</p>
<p>ä¸‹é¢ä¸¾ä¸ªä¾‹å­è¯´æ˜ä¸‹æ‰©å®¹è¿‡ç¨‹ã€‚å‡è®¾äº†æˆ‘ä»¬çš„hashç®—æ³•å°±æ˜¯ç®€å•çš„ç”¨key mod ä¸€ä¸‹è¡¨çš„å¤§å°ï¼ˆä¹Ÿå°±æ˜¯æ•°ç»„çš„é•¿åº¦ï¼‰ã€‚å…¶ä¸­çš„å“ˆå¸Œæ¡¶æ•°ç»„tableçš„size=2ï¼Œ æ‰€ä»¥key = 3ã€7ã€5ï¼Œputé¡ºåºä¾æ¬¡ä¸º 5ã€7ã€3ã€‚åœ¨mod 2ä»¥åéƒ½å†²çªåœ¨table[1]è¿™é‡Œäº†ã€‚è¿™é‡Œå‡è®¾è´Ÿè½½å› å­ loadFactor=1ï¼Œå³å½“é”®å€¼å¯¹çš„å®é™…å¤§å°size å¤§äº tableçš„å®é™…å¤§å°æ—¶è¿›è¡Œæ‰©å®¹ã€‚æ¥ä¸‹æ¥çš„ä¸‰ä¸ªæ­¥éª¤æ˜¯å“ˆå¸Œæ¡¶æ•°ç»„ resizeæˆ4ï¼Œç„¶åæ‰€æœ‰çš„Nodeé‡æ–°rehashçš„è¿‡ç¨‹ã€‚</p>
<p><img src="http://tech.meituan.com/img/java-hashmap/jdk1.7%E6%89%A9%E5%AE%B9%E4%BE%8B%E5%9B%BE.png" alt="jdk1.7æ‰©å®¹ä¾‹å›¾"></p>
<p>ä¸‹é¢æˆ‘ä»¬è®²è§£ä¸‹JDK1.8åšäº†å“ªäº›ä¼˜åŒ–ã€‚ç»è¿‡è§‚æµ‹å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯2æ¬¡å¹‚çš„æ‰©å±•(æŒ‡é•¿åº¦æ‰©ä¸ºåŸæ¥2å€)ï¼Œæ‰€ä»¥ï¼Œå…ƒç´ çš„ä½ç½®è¦ä¹ˆæ˜¯åœ¨åŸä½ç½®ï¼Œè¦ä¹ˆæ˜¯åœ¨åŸä½ç½®å†ç§»åŠ¨2æ¬¡å¹‚çš„ä½ç½®ã€‚çœ‹ä¸‹å›¾å¯ä»¥æ˜ç™½è¿™å¥è¯çš„æ„æ€ï¼Œnä¸ºtableçš„é•¿åº¦ï¼Œå›¾ï¼ˆaï¼‰è¡¨ç¤ºæ‰©å®¹å‰çš„key1å’Œkey2ä¸¤ç§keyç¡®å®šç´¢å¼•ä½ç½®çš„ç¤ºä¾‹ï¼Œå›¾ï¼ˆbï¼‰è¡¨ç¤ºæ‰©å®¹åkey1å’Œkey2ä¸¤ç§keyç¡®å®šç´¢å¼•ä½ç½®çš„ç¤ºä¾‹ï¼Œå…¶ä¸­hash1æ˜¯key1å¯¹åº”çš„å“ˆå¸Œä¸é«˜ä½è¿ç®—ç»“æœã€‚</p>
<p><img src="http://tech.meituan.com/img/java-hashmap/hashMap%201.8%20%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E4%BE%8B%E5%9B%BE1.png" alt="hashMap 1.8 å“ˆå¸Œç®—æ³•ä¾‹å›¾1"></p>
<p>å…ƒç´ åœ¨é‡æ–°è®¡ç®—hashä¹‹åï¼Œå› ä¸ºnå˜ä¸º2å€ï¼Œé‚£ä¹ˆn-1çš„maskèŒƒå›´åœ¨é«˜ä½å¤š1bit(çº¢è‰²)ï¼Œå› æ­¤æ–°çš„indexå°±ä¼šå‘ç”Ÿè¿™æ ·çš„å˜åŒ–ï¼š</p>
<p><img src="http://tech.meituan.com/img/java-hashmap/hashMap%201.8%20%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E4%BE%8B%E5%9B%BE2.png" alt="hashMap 1.8 å“ˆå¸Œç®—æ³•ä¾‹å›¾2"></p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ‰©å……HashMapçš„æ—¶å€™ï¼Œä¸éœ€è¦åƒJDK1.7çš„å®ç°é‚£æ ·é‡æ–°è®¡ç®—hashï¼Œåªéœ€è¦çœ‹çœ‹åŸæ¥çš„hashå€¼æ–°å¢çš„é‚£ä¸ªbitæ˜¯1è¿˜æ˜¯0å°±å¥½äº†ï¼Œæ˜¯0çš„è¯ç´¢å¼•æ²¡å˜ï¼Œæ˜¯1çš„è¯ç´¢å¼•å˜æˆâ€œåŸç´¢å¼•+oldCapâ€ï¼Œå¯ä»¥çœ‹çœ‹ä¸‹å›¾ä¸º16æ‰©å……ä¸º32çš„resizeç¤ºæ„å›¾ï¼š</p>
<p><img src="http://tech.meituan.com/img/java-hashmap/jdk1.8%20hashMap%E6%89%A9%E5%AE%B9%E4%BE%8B%E5%9B%BE.png" alt="jdk1.8 hashMapæ‰©å®¹ä¾‹å›¾"></p>
<p>è¿™ä¸ªè®¾è®¡ç¡®å®éå¸¸çš„å·§å¦™ï¼Œæ—¢çœå»äº†é‡æ–°è®¡ç®—hashå€¼çš„æ—¶é—´ï¼Œè€Œä¸”åŒæ—¶ï¼Œç”±äºæ–°å¢çš„1bitæ˜¯0è¿˜æ˜¯1å¯ä»¥è®¤ä¸ºæ˜¯éšæœºçš„ï¼Œå› æ­¤resizeçš„è¿‡ç¨‹ï¼Œå‡åŒ€çš„æŠŠä¹‹å‰çš„å†²çªçš„èŠ‚ç‚¹åˆ†æ•£åˆ°æ–°çš„bucketäº†ã€‚è¿™ä¸€å—å°±æ˜¯JDK1.8æ–°å¢çš„ä¼˜åŒ–ç‚¹ã€‚æœ‰ä¸€ç‚¹æ³¨æ„åŒºåˆ«ï¼ŒJDK1.7ä¸­rehashçš„æ—¶å€™ï¼Œæ—§é“¾è¡¨è¿ç§»æ–°é“¾è¡¨çš„æ—¶å€™ï¼Œå¦‚æœåœ¨æ–°è¡¨çš„æ•°ç»„ç´¢å¼•ä½ç½®ç›¸åŒï¼Œåˆ™é“¾è¡¨å…ƒç´ ä¼šå€’ç½®ï¼Œä½†æ˜¯ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒJDK1.8ä¸ä¼šå€’ç½®ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ç ”ç©¶ä¸‹JDK1.8çš„resizeæºç ï¼Œå†™çš„å¾ˆèµï¼Œå¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"> <span class="number">1</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</div><div class="line"> <span class="number">2</span>     Node&lt;K,V&gt;[] oldTab = table;</div><div class="line"> <span class="number">3</span>     <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</div><div class="line"> <span class="number">4</span>     <span class="keyword">int</span> oldThr = threshold;</div><div class="line"> <span class="number">5</span>     <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</div><div class="line"> <span class="number">6</span>     <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</div><div class="line"> <span class="number">7</span>         <span class="comment">// è¶…è¿‡æœ€å¤§å€¼å°±ä¸å†æ‰©å……äº†ï¼Œå°±åªå¥½éšä½ ç¢°æ’å»å§</span></div><div class="line"> <span class="number">8</span>         <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</div><div class="line"> <span class="number">9</span>             threshold = Integer.MAX_VALUE;</div><div class="line"><span class="number">10</span>             <span class="keyword">return</span> oldTab;</div><div class="line"><span class="number">11</span>         &#125;</div><div class="line"><span class="number">12</span>         <span class="comment">// æ²¡è¶…è¿‡æœ€å¤§å€¼ï¼Œå°±æ‰©å……ä¸ºåŸæ¥çš„2å€</span></div><div class="line"><span class="number">13</span>         <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</div><div class="line"><span class="number">14</span>                  oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</div><div class="line"><span class="number">15</span>             newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></div><div class="line"><span class="number">16</span>     &#125;</div><div class="line"><span class="number">17</span>     <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></div><div class="line"><span class="number">18</span>         newCap = oldThr;</div><div class="line"><span class="number">19</span>     <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></div><div class="line"><span class="number">20</span>         newCap = DEFAULT_INITIAL_CAPACITY;</div><div class="line"><span class="number">21</span>         newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</div><div class="line"><span class="number">22</span>     &#125;</div><div class="line"><span class="number">23</span>     <span class="comment">// è®¡ç®—æ–°çš„resizeä¸Šé™</span></div><div class="line"><span class="number">24</span>     <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</div><div class="line"><span class="number">25</span> </div><div class="line"><span class="number">26</span>         <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</div><div class="line"><span class="number">27</span>         newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</div><div class="line"><span class="number">28</span>                   (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</div><div class="line"><span class="number">29</span>     &#125;</div><div class="line"><span class="number">30</span>     threshold = newThr;</div><div class="line"><span class="number">31</span>     <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>ï¼Œ<span class="string">"unchecked"</span>&#125;)</div><div class="line"><span class="number">32</span>         Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</div><div class="line"><span class="number">33</span>     table = newTab;</div><div class="line"><span class="number">34</span>     <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">35</span>         <span class="comment">// æŠŠæ¯ä¸ªbucketéƒ½ç§»åŠ¨åˆ°æ–°çš„bucketsä¸­</span></div><div class="line"><span class="number">36</span>         <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</div><div class="line"><span class="number">37</span>             Node&lt;K,V&gt; e;</div><div class="line"><span class="number">38</span>             <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">39</span>                 oldTab[j] = <span class="keyword">null</span>;</div><div class="line"><span class="number">40</span>                 <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</div><div class="line"><span class="number">41</span>                     newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</div><div class="line"><span class="number">42</span>                 <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</div><div class="line"><span class="number">43</span>                     ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</div><div class="line"><span class="number">44</span>                 <span class="keyword">else</span> &#123; <span class="comment">// é“¾è¡¨ä¼˜åŒ–é‡hashçš„ä»£ç å—</span></div><div class="line"><span class="number">45</span>                     Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</div><div class="line"><span class="number">46</span>                     Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</div><div class="line"><span class="number">47</span>                     Node&lt;K,V&gt; next;</div><div class="line"><span class="number">48</span>                     do &#123;</div><div class="line"><span class="number">49</span>                         next = e.next;</div><div class="line"><span class="number">50</span>                         <span class="comment">// åŸç´¢å¼•</span></div><div class="line"><span class="number">51</span>                         <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</div><div class="line"><span class="number">52</span>                             <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</div><div class="line"><span class="number">53</span>                                 loHead = e;</div><div class="line"><span class="number">54</span>                             <span class="keyword">else</span></div><div class="line"><span class="number">55</span>                                 loTail.next = e;</div><div class="line"><span class="number">56</span>                             loTail = e;</div><div class="line"><span class="number">57</span>                         &#125;</div><div class="line"><span class="number">58</span>                         <span class="comment">// åŸç´¢å¼•+oldCap</span></div><div class="line"><span class="number">59</span>                         <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">60</span>                             <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</div><div class="line"><span class="number">61</span>                                 hiHead = e;</div><div class="line"><span class="number">62</span>                             <span class="keyword">else</span></div><div class="line"><span class="number">63</span>                                 hiTail.next = e;</div><div class="line"><span class="number">64</span>                             hiTail = e;</div><div class="line"><span class="number">65</span>                         &#125;</div><div class="line"><span class="number">66</span>                     &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</div><div class="line"><span class="number">67</span>                     <span class="comment">// åŸç´¢å¼•æ”¾åˆ°bucketé‡Œ</span></div><div class="line"><span class="number">68</span>                     <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">69</span>                         loTail.next = <span class="keyword">null</span>;</div><div class="line"><span class="number">70</span>                         newTab[j] = loHead;</div><div class="line"><span class="number">71</span>                     &#125;</div><div class="line"><span class="number">72</span>                     <span class="comment">// åŸç´¢å¼•+oldCapæ”¾åˆ°bucketé‡Œ</span></div><div class="line"><span class="number">73</span>                     <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="number">74</span>                         hiTail.next = <span class="keyword">null</span>;</div><div class="line"><span class="number">75</span>                         newTab[j + oldCap] = hiHead;</div><div class="line"><span class="number">76</span>                     &#125;</div><div class="line"><span class="number">77</span>                 &#125;</div><div class="line"><span class="number">78</span>             &#125;</div><div class="line"><span class="number">79</span>         &#125;</div><div class="line"><span class="number">80</span>     &#125;</div><div class="line"><span class="number">81</span>     <span class="keyword">return</span> newTab;</div><div class="line"><span class="number">82</span> &#125;</div></pre></td></tr></table></figure>
<h3 id="çº¿ç¨‹å®‰å…¨æ€§"><a href="#çº¿ç¨‹å®‰å…¨æ€§" class="headerlink" title="çº¿ç¨‹å®‰å…¨æ€§"></a><strong>çº¿ç¨‹å®‰å…¨æ€§</strong></h3><p>åœ¨å¤šçº¿ç¨‹ä½¿ç”¨åœºæ™¯ä¸­ï¼Œåº”è¯¥å°½é‡é¿å…ä½¿ç”¨çº¿ç¨‹ä¸å®‰å…¨çš„HashMapï¼Œè€Œä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„ConcurrentHashMapã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè¯´HashMapæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œä¸‹é¢ä¸¾ä¾‹å­è¯´æ˜åœ¨å¹¶å‘çš„å¤šçº¿ç¨‹ä½¿ç”¨åœºæ™¯ä¸­ä½¿ç”¨HashMapå¯èƒ½é€ æˆæ­»å¾ªç¯ã€‚ä»£ç ä¾‹å­å¦‚ä¸‹(ä¾¿äºç†è§£ï¼Œä»ç„¶ä½¿ç”¨JDK1.7çš„ç¯å¢ƒ)ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public class HashMapInfiniteLoop &#123;  </div><div class="line"></div><div class="line">    private static HashMap&lt;Integer,String&gt; map = new HashMap&lt;Integer,String&gt;(2ï¼Œ0.75f);  </div><div class="line">    public static void main(String[] args) &#123;  </div><div class="line">        map.put(5ï¼Œ "C");  </div><div class="line"></div><div class="line">        new Thread("Thread1") &#123;  </div><div class="line">            public void run() &#123;  </div><div class="line">                map.put(7, "B");  </div><div class="line">                System.out.println(map);  </div><div class="line">            &#125;;  </div><div class="line">        &#125;.start();  </div><div class="line">        new Thread("Thread2") &#123;  </div><div class="line">            public void run() &#123;  </div><div class="line">                map.put(3, "A);  </div><div class="line">                System.out.println(map);  </div><div class="line">            &#125;;  </div><div class="line">        &#125;.start();        </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œmapåˆå§‹åŒ–ä¸ºä¸€ä¸ªé•¿åº¦ä¸º2çš„æ•°ç»„ï¼ŒloadFactor=0.75ï¼Œthreshold=2*0.75=1ï¼Œä¹Ÿå°±æ˜¯è¯´å½“putç¬¬äºŒä¸ªkeyçš„æ—¶å€™ï¼Œmapå°±éœ€è¦è¿›è¡Œresizeã€‚</p>
<p>é€šè¿‡è®¾ç½®æ–­ç‚¹è®©çº¿ç¨‹1å’Œçº¿ç¨‹2åŒæ—¶debugåˆ°transferæ–¹æ³•(3.3å°èŠ‚ä»£ç å—)çš„é¦–è¡Œã€‚æ³¨æ„æ­¤æ—¶ä¸¤ä¸ªçº¿ç¨‹å·²ç»æˆåŠŸæ·»åŠ æ•°æ®ã€‚æ”¾å¼€thread1çš„æ–­ç‚¹è‡³transferæ–¹æ³•çš„â€œEntry next = e.next;â€ è¿™ä¸€è¡Œï¼›ç„¶åæ”¾å¼€çº¿ç¨‹2çš„çš„æ–­ç‚¹ï¼Œè®©çº¿ç¨‹2è¿›è¡Œresizeã€‚ç»“æœå¦‚ä¸‹å›¾ã€‚</p>
<p><img src="http://tech.meituan.com/img/java-hashmap/jdk1.7%20hashMap%E6%AD%BB%E5%BE%AA%E7%8E%AF%E4%BE%8B%E5%9B%BE1.png" alt="jdk1.7 hashMapæ­»å¾ªç¯ä¾‹å›¾1"></p>
<p>æ³¨æ„ï¼ŒThread1çš„ e æŒ‡å‘äº†key(3)ï¼Œè€ŒnextæŒ‡å‘äº†key(7)ï¼Œå…¶åœ¨çº¿ç¨‹äºŒrehashåï¼ŒæŒ‡å‘äº†çº¿ç¨‹äºŒé‡ç»„åçš„é“¾è¡¨ã€‚</p>
<p>çº¿ç¨‹ä¸€è¢«è°ƒåº¦å›æ¥æ‰§è¡Œï¼Œå…ˆæ˜¯æ‰§è¡Œ newTalbe[i] = eï¼Œ ç„¶åæ˜¯e = nextï¼Œå¯¼è‡´äº†eæŒ‡å‘äº†key(7)ï¼Œè€Œä¸‹ä¸€æ¬¡å¾ªç¯çš„next = e.nextå¯¼è‡´äº†nextæŒ‡å‘äº†key(3)ã€‚</p>
<p><img src="http://tech.meituan.com/img/java-hashmap/jdk1.7%20hashMap%E6%AD%BB%E5%BE%AA%E7%8E%AF%E4%BE%8B%E5%9B%BE2.png" alt="jdk1.7 hashMapæ­»å¾ªç¯ä¾‹å›¾2"></p>
<p><img src="http://tech.meituan.com/img/java-hashmap/jdk1.7%20hashMap%E6%AD%BB%E5%BE%AA%E7%8E%AF%E4%BE%8B%E5%9B%BE3.png" alt="jdk1.7 hashMapæ­»å¾ªç¯ä¾‹å›¾3"></p>
<p>e.next = newTable[i] å¯¼è‡´ key(3).next æŒ‡å‘äº† key(7)ã€‚æ³¨æ„ï¼šæ­¤æ—¶çš„key(7).next å·²ç»æŒ‡å‘äº†key(3)ï¼Œ ç¯å½¢é“¾è¡¨å°±è¿™æ ·å‡ºç°äº†ã€‚</p>
<p><img src="http://tech.meituan.com/img/java-hashmap/jdk1.7%20hashMap%E6%AD%BB%E5%BE%AA%E7%8E%AF%E4%BE%8B%E5%9B%BE4.png" alt="jdk1.7 hashMapæ­»å¾ªç¯ä¾‹å›¾4"></p>
<p>äºæ˜¯ï¼Œå½“æˆ‘ä»¬ç”¨çº¿ç¨‹ä¸€è°ƒç”¨map.get(11)æ—¶ï¼Œæ‚²å‰§å°±å‡ºç°äº†â€”â€”Infinite Loopã€‚</p>
<h3 id="JDK1-8ä¸JDK1-7çš„æ€§èƒ½å¯¹æ¯”"><a href="#JDK1-8ä¸JDK1-7çš„æ€§èƒ½å¯¹æ¯”" class="headerlink" title="JDK1.8ä¸JDK1.7çš„æ€§èƒ½å¯¹æ¯”"></a><strong>JDK1.8ä¸JDK1.7çš„æ€§èƒ½å¯¹æ¯”</strong></h3><p>HashMapä¸­ï¼Œå¦‚æœkeyç»è¿‡hashç®—æ³•å¾—å‡ºçš„æ•°ç»„ç´¢å¼•ä½ç½®å…¨éƒ¨ä¸ç›¸åŒï¼Œå³Hashç®—æ³•éå¸¸å¥½ï¼Œé‚£æ ·çš„è¯ï¼ŒgetKeyæ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦å°±æ˜¯O(1)ï¼Œå¦‚æœHashç®—æ³•æŠ€æœ¯çš„ç»“æœç¢°æ’éå¸¸å¤šï¼Œå‡å¦‚Hashç®—æå…¶å·®ï¼Œæ‰€æœ‰çš„Hashç®—æ³•ç»“æœå¾—å‡ºçš„ç´¢å¼•ä½ç½®ä¸€æ ·ï¼Œé‚£æ ·æ‰€æœ‰çš„é”®å€¼å¯¹éƒ½é›†ä¸­åˆ°ä¸€ä¸ªæ¡¶ä¸­ï¼Œæˆ–è€…åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œæˆ–è€…åœ¨ä¸€ä¸ªçº¢é»‘æ ‘ä¸­ï¼Œæ—¶é—´å¤æ‚åº¦åˆ†åˆ«ä¸ºO(n)å’ŒO(lgn)ã€‚ é‰´äºJDK1.8åšäº†å¤šæ–¹é¢çš„ä¼˜åŒ–ï¼Œæ€»ä½“æ€§èƒ½ä¼˜äºJDK1.7ï¼Œä¸‹é¢æˆ‘ä»¬ä»ä¸¤ä¸ªæ–¹é¢ç”¨ä¾‹å­è¯æ˜è¿™ä¸€ç‚¹ã€‚</p>
<h4 id="Hashè¾ƒå‡åŒ€çš„æƒ…å†µ"><a href="#Hashè¾ƒå‡åŒ€çš„æƒ…å†µ" class="headerlink" title="Hashè¾ƒå‡åŒ€çš„æƒ…å†µ"></a>Hashè¾ƒå‡åŒ€çš„æƒ…å†µ</h4><p>ä¸ºäº†ä¾¿äºæµ‹è¯•ï¼Œæˆ‘ä»¬å…ˆå†™ä¸€ä¸ªç±»Keyï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Key</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Key</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</div><div class="line"></div><div class="line">    Key(<span class="keyword">int</span> value) &#123;</div><div class="line">        <span class="keyword">this</span>.value = value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Key o)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Integer.compare(<span class="keyword">this</span>.value, o.value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass())</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        Key key = (Key) o;</div><div class="line">        <span class="keyword">return</span> value == key.value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªç±»å¤å†™äº†equalsæ–¹æ³•ï¼Œå¹¶ä¸”æä¾›äº†ç›¸å½“å¥½çš„hashCodeå‡½æ•°ï¼Œä»»ä½•ä¸€ä¸ªå€¼çš„hashCodeéƒ½ä¸ä¼šç›¸åŒï¼Œå› ä¸ºç›´æ¥ä½¿ç”¨valueå½“åšhashcodeã€‚ä¸ºäº†é¿å…é¢‘ç¹çš„GCï¼Œæˆ‘å°†ä¸å˜çš„Keyå®ä¾‹ç¼“å­˜äº†èµ·æ¥ï¼Œè€Œä¸æ˜¯ä¸€éä¸€éçš„åˆ›å»ºå®ƒä»¬ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Keys</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_KEY = <span class="number">10_000_000</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Key[] KEYS_CACHE = <span class="keyword">new</span> Key[MAX_KEY];</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_KEY; ++i) &#123;</div><div class="line">            KEYS_CACHE[i] = <span class="keyword">new</span> Key(i);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Key <span class="title">of</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> KEYS_CACHE[value];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç°åœ¨å¼€å§‹æˆ‘ä»¬çš„è¯•éªŒï¼Œæµ‹è¯•éœ€è¦åšçš„ä»…ä»…æ˜¯ï¼Œåˆ›å»ºä¸åŒsizeçš„HashMapï¼ˆ1ã€10ã€100ã€â€¦â€¦10000000ï¼‰ï¼Œå±è”½äº†æ‰©å®¹çš„æƒ…å†µï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> mapSize)</span> </span>&#123;</div><div class="line"></div><div class="line">     HashMap&lt;Key, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;Key,Integer&gt;(mapSize);</div><div class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mapSize; ++i) &#123;</div><div class="line">         map.put(Keys.of(i), i);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">long</span> beginTime = System.nanoTime(); <span class="comment">//è·å–çº³ç§’</span></div><div class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mapSize; i++) &#123;</div><div class="line">         map.get(Keys.of(i));</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">long</span> endTime = System.nanoTime();</div><div class="line">     System.out.println(endTime - beginTime);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">     <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">10</span>;i&lt;= <span class="number">1000</span> <span class="number">0000</span>;i*= <span class="number">10</span>)&#123;</div><div class="line">         test(i);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>åœ¨æµ‹è¯•ä¸­ä¼šæŸ¥æ‰¾ä¸åŒçš„å€¼ï¼Œç„¶ååº¦é‡èŠ±è´¹çš„æ—¶é—´ï¼Œä¸ºäº†è®¡ç®—getKeyçš„å¹³å‡æ—¶é—´ï¼Œæˆ‘ä»¬éå†æ‰€æœ‰çš„getæ–¹æ³•ï¼Œè®¡ç®—æ€»çš„æ—¶é—´ï¼Œé™¤ä»¥keyçš„æ•°é‡ï¼Œè®¡ç®—ä¸€ä¸ªå¹³å‡å€¼ï¼Œä¸»è¦ç”¨æ¥æ¯”è¾ƒï¼Œç»å¯¹å€¼å¯èƒ½ä¼šå—å¾ˆå¤šç¯å¢ƒå› ç´ çš„å½±å“ã€‚ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="http://tech.meituan.com/img/java-hashmap/%E6%80%A7%E8%83%BD%E6%AF%94%E8%BE%83%E8%A1%A81.png" alt="æ€§èƒ½æ¯”è¾ƒè¡¨1.png"></p>
<p>é€šè¿‡è§‚æµ‹æµ‹è¯•ç»“æœå¯çŸ¥ï¼ŒJDK1.8çš„æ€§èƒ½è¦é«˜äºJDK1.7 15%ä»¥ä¸Šï¼Œåœ¨æŸäº›sizeçš„åŒºåŸŸä¸Šï¼Œç”šè‡³é«˜äº100%ã€‚ç”±äºHashç®—æ³•è¾ƒå‡åŒ€ï¼ŒJDK1.8å¼•å…¥çš„çº¢é»‘æ ‘æ•ˆæœä¸æ˜æ˜¾ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹Hashä¸å‡åŒ€çš„çš„æƒ…å†µã€‚</p>
<h4 id="Hashæä¸å‡åŒ€çš„æƒ…å†µ"><a href="#Hashæä¸å‡åŒ€çš„æƒ…å†µ" class="headerlink" title="Hashæä¸å‡åŒ€çš„æƒ…å†µ"></a>Hashæä¸å‡åŒ€çš„æƒ…å†µ</h4><p>å‡è®¾æˆ‘ä»¬åˆä¸€ä¸ªéå¸¸å·®çš„Keyï¼Œå®ƒä»¬æ‰€æœ‰çš„å®ä¾‹éƒ½è¿”å›ç›¸åŒçš„hashCodeå€¼ã€‚è¿™æ˜¯ä½¿ç”¨HashMapæœ€åçš„æƒ…å†µã€‚ä»£ç ä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Key</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Key</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//...</span></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ç„¶æ‰§è¡Œmainæ–¹æ³•ï¼Œå¾—å‡ºçš„ç»“æœå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>
<p><img src="http://tech.meituan.com/img/java-hashmap/%E6%80%A7%E8%83%BD%E6%AF%94%E8%BE%83%E8%A1%A82.png" alt="æ€§èƒ½æ¯”è¾ƒè¡¨2.png"></p>
<p>ä»è¡¨ä¸­ç»“æœä¸­å¯çŸ¥ï¼Œéšç€sizeçš„å˜å¤§ï¼ŒJDK1.7çš„èŠ±è´¹æ—¶é—´æ˜¯å¢é•¿çš„è¶‹åŠ¿ï¼Œè€ŒJDK1.8æ˜¯æ˜æ˜¾çš„é™ä½è¶‹åŠ¿ï¼Œå¹¶ä¸”å‘ˆç°å¯¹æ•°å¢é•¿ç¨³å®šã€‚å½“ä¸€ä¸ªé“¾è¡¨å¤ªé•¿çš„æ—¶å€™ï¼ŒHashMapä¼šåŠ¨æ€çš„å°†å®ƒæ›¿æ¢æˆä¸€ä¸ªçº¢é»‘æ ‘ï¼Œè¿™è¯çš„è¯ä¼šå°†æ—¶é—´å¤æ‚åº¦ä»O(n)é™ä¸ºO(logn)ã€‚hashç®—æ³•å‡åŒ€å’Œä¸å‡åŒ€æ‰€èŠ±è´¹çš„æ—¶é—´æ˜æ˜¾ä¹Ÿä¸ç›¸åŒï¼Œè¿™ä¸¤ç§æƒ…å†µçš„ç›¸å¯¹æ¯”è¾ƒï¼Œå¯ä»¥è¯´æ˜ä¸€ä¸ªå¥½çš„hashç®—æ³•çš„é‡è¦æ€§ã€‚</p>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a><strong>å°ç»“</strong></h3><p>(1) æ‰©å®¹æ˜¯ä¸€ä¸ªç‰¹åˆ«è€—æ€§èƒ½çš„æ“ä½œï¼Œæ‰€ä»¥å½“ç¨‹åºå‘˜åœ¨ä½¿ç”¨HashMapçš„æ—¶å€™ï¼Œä¼°ç®—mapçš„å¤§å°ï¼Œåˆå§‹åŒ–çš„æ—¶å€™ç»™ä¸€ä¸ªå¤§è‡´çš„æ•°å€¼ï¼Œé¿å…mapè¿›è¡Œé¢‘ç¹çš„æ‰©å®¹ã€‚</p>
<p>(2) è´Ÿè½½å› å­æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œä¹Ÿå¯ä»¥å¤§äº1ï¼Œä½†æ˜¯å»ºè®®ä¸è¦è½»æ˜“ä¿®æ”¹ï¼Œé™¤éæƒ…å†µéå¸¸ç‰¹æ®Šã€‚</p>
<p>(3) HashMapæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œä¸è¦åœ¨å¹¶å‘çš„ç¯å¢ƒä¸­åŒæ—¶æ“ä½œHashMapï¼Œå»ºè®®ä½¿ç”¨ConcurrentHashMapã€‚</p>
<p>(4) JDK1.8å¼•å…¥çº¢é»‘æ ‘å¤§ç¨‹åº¦ä¼˜åŒ–äº†HashMapçš„æ€§èƒ½ã€‚</p>
<p><a href="http://tech.meituan.com/java-hashmap.html" target="_blank" rel="external">è½¬è½½</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[çº¢é»‘æ ‘]]></title>
      <url>http://zsr.github.io/2016/12/13/%E7%BA%A2%E9%BB%91%E6%A0%91/</url>
      <content type="html"><![CDATA[<p>çº¢é»‘æ ‘æ˜¯å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘çš„ä¸€ç§ã€‚ä¸ºäº†æ·±å…¥ç†è§£çº¢é»‘æ ‘ï¼Œæˆ‘ä»¬éœ€è¦ä»äºŒå‰æŸ¥æ‰¾æ ‘å¼€å§‹è®²èµ·ã€‚</p>
<h2 id="BST"><a href="#BST" class="headerlink" title="BST"></a>BST</h2><p>äºŒå‰æŸ¥æ‰¾æ ‘ï¼ˆBinary Search Treeï¼Œç®€ç§°BSTï¼‰æ˜¯ä¸€æ£µäºŒå‰æ ‘ï¼Œå®ƒçš„å·¦å­èŠ‚ç‚¹çš„å€¼æ¯”çˆ¶èŠ‚ç‚¹çš„å€¼è¦å°ï¼Œå³èŠ‚ç‚¹çš„å€¼è¦æ¯”çˆ¶èŠ‚ç‚¹çš„å€¼å¤§ã€‚å®ƒçš„é«˜åº¦å†³å®šäº†å®ƒçš„æŸ¥æ‰¾æ•ˆç‡ã€‚</p>
<p>åœ¨ç†æƒ³çš„æƒ…å†µä¸‹ï¼ŒäºŒå‰æŸ¥æ‰¾æ ‘å¢åˆ æŸ¥æ”¹çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(logN)ï¼ˆå…¶ä¸­Nä¸ºèŠ‚ç‚¹æ•°ï¼‰ï¼Œæœ€åçš„æƒ…å†µä¸‹ä¸ºO(N)ã€‚å½“å®ƒçš„é«˜åº¦ä¸ºlogN+1æ—¶ï¼Œæˆ‘ä»¬å°±è¯´äºŒå‰æŸ¥æ‰¾æ ‘æ˜¯å¹³è¡¡çš„ã€‚<br><img src="http://tech.meituan.com/img/redblack-tree/tree-all.png" alt="BST"></p>
<h3 id="BSTçš„æŸ¥æ‰¾æ“ä½œ"><a href="#BSTçš„æŸ¥æ‰¾æ“ä½œ" class="headerlink" title="BSTçš„æŸ¥æ‰¾æ“ä½œ"></a>BSTçš„æŸ¥æ‰¾æ“ä½œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">T  key = a search key</div><div class="line">Node root = <span class="function">point to the root of a BST</span></div><div class="line"></div><div class="line"><span class="title">while</span><span class="params">(<span class="keyword">true</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(root==<span class="keyword">null</span>)&#123;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(root.value.equals(key))&#123;</div><div class="line">        <span class="keyword">return</span> root;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(key.compareTo(root.value)&lt;<span class="number">0</span>)&#123;</div><div class="line">        root = root.left;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span>&#123;</div><div class="line">        root = root.right;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div></pre></td></tr></table></figure>
<h3 id="BSTçš„æ’å…¥æ“ä½œ"><a href="#BSTçš„æ’å…¥æ“ä½œ" class="headerlink" title="BSTçš„æ’å…¥æ“ä½œ"></a>BSTçš„æ’å…¥æ“ä½œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">Node node = create a <span class="keyword">new</span> node with specify value</div><div class="line">Node root = point the root node of a BST</div><div class="line">Node parent = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"><span class="comment">//find the parent node to append the new node</span></div><div class="line"><span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</div><div class="line">   <span class="keyword">if</span>(root==<span class="keyword">null</span>)<span class="keyword">break</span>;</div><div class="line">   parent = root;</div><div class="line">   <span class="keyword">if</span>(node.value.compareTo(root.value)&lt;=<span class="number">0</span>)&#123;</div><div class="line">      root = root.left;  </div><div class="line">   &#125;<span class="keyword">else</span>&#123;</div><div class="line">      root = root.right;</div><div class="line">   &#125; </div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(parent!=<span class="keyword">null</span>)&#123;</div><div class="line">   <span class="keyword">if</span>(node.value.compareTo(parent.value)&lt;=<span class="number">0</span>)&#123;<span class="comment">//append to left</span></div><div class="line">      parent.left = node;</div><div class="line">   &#125;<span class="keyword">else</span>&#123;<span class="comment">//append to right</span></div><div class="line">      parent.right = node;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ’å…¥æ“ä½œå…ˆé€šè¿‡å¾ªç¯æŸ¥æ‰¾åˆ°å¾…æ’å…¥çš„èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œå’ŒæŸ¥æ‰¾çˆ¶èŠ‚ç‚¹çš„é€»è¾‘ä¸€æ ·ï¼Œéƒ½æ˜¯æ¯”å¤§å°ï¼Œå°çš„å¾€å·¦ï¼Œå¤§çš„å¾€å³ã€‚æ‰¾åˆ°çˆ¶èŠ‚ç‚¹åï¼Œå¯¹æ¯”çˆ¶èŠ‚ç‚¹ï¼Œå°çš„å°±æ’å…¥åˆ°çˆ¶èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹ï¼Œå¤§å°±æ’å…¥åˆ°çˆ¶èŠ‚ç‚¹çš„å³èŠ‚ç‚¹ä¸Šã€‚</p>
<h3 id="BSTçš„åˆ é™¤æ“ä½œ"><a href="#BSTçš„åˆ é™¤æ“ä½œ" class="headerlink" title="BSTçš„åˆ é™¤æ“ä½œ"></a>BSTçš„åˆ é™¤æ“ä½œ</h3><p>åˆ é™¤æ“ä½œçš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>æŸ¥æ‰¾åˆ°è¦åˆ é™¤çš„èŠ‚ç‚¹ã€‚</li>
<li>å¦‚æœå¾…åˆ é™¤çš„èŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥åˆ é™¤ã€‚</li>
<li>å¦‚æœå¾…åˆ é™¤çš„èŠ‚ç‚¹ä¸æ˜¯å¶å­èŠ‚ç‚¹ï¼Œåˆ™å…ˆæ‰¾åˆ°å¾…åˆ é™¤èŠ‚ç‚¹çš„ä¸­åºéå†çš„åç»§èŠ‚ç‚¹ï¼Œç”¨è¯¥åç»§èŠ‚ç‚¹çš„å€¼æ›¿æ¢å¾…åˆ é™¤çš„èŠ‚ç‚¹çš„å€¼ï¼Œç„¶ååˆ é™¤åç»§èŠ‚ç‚¹ã€‚</li>
</ol>
<p><img src="http://tech.meituan.com/img/redblack-tree/bst-tree-remove.png" alt="BST remove"></p>
<p><strong>BSTå­˜åœ¨çš„é—®é¢˜</strong></p>
<p>BSTå­˜åœ¨çš„ä¸»è¦é—®é¢˜æ˜¯ï¼Œæ•°åœ¨æ’å…¥çš„æ—¶å€™ä¼šå¯¼è‡´æ ‘å€¾æ–œï¼Œä¸åŒçš„æ’å…¥é¡ºåºä¼šå¯¼è‡´æ ‘çš„é«˜åº¦ä¸ä¸€æ ·ï¼Œè€Œæ ‘çš„é«˜åº¦ç›´æ¥çš„å½±å“äº†æ ‘çš„æŸ¥æ‰¾æ•ˆç‡ã€‚ç†æƒ³çš„é«˜åº¦æ˜¯logNï¼Œæœ€åçš„æƒ…å†µæ˜¯æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½åœ¨ä¸€æ¡æ–œçº¿ä¸Šï¼Œè¿™æ ·çš„æ ‘çš„é«˜åº¦ä¸ºNã€‚</p>
<a id="more"></a>
<h2 id="RBTree"><a href="#RBTree" class="headerlink" title="RBTree"></a>RBTree</h2><p>åŸºäºBSTå­˜åœ¨çš„é—®é¢˜ï¼Œä¸€ç§æ–°çš„æ ‘â€”â€”å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘(Balanced BST)äº§ç”Ÿäº†ã€‚å¹³è¡¡æ ‘åœ¨æ’å…¥å’Œåˆ é™¤çš„æ—¶å€™ï¼Œä¼šé€šè¿‡æ—‹è½¬æ“ä½œå°†é«˜åº¦ä¿æŒåœ¨logNã€‚å…¶ä¸­ä¸¤æ¬¾å…·æœ‰ä»£è¡¨æ€§çš„å¹³è¡¡æ ‘åˆ†åˆ«ä¸ºAVLæ ‘å’Œçº¢é»‘æ ‘ã€‚AVLæ ‘ç”±äºå®ç°æ¯”è¾ƒå¤æ‚ï¼Œè€Œä¸”æ’å…¥å’Œåˆ é™¤æ€§èƒ½å·®ï¼Œåœ¨å®é™…ç¯å¢ƒä¸‹çš„åº”ç”¨ä¸å¦‚çº¢é»‘æ ‘ã€‚</p>
<p>çº¢é»‘æ ‘ï¼ˆRed-Black Treeï¼Œä»¥ä¸‹ç®€ç§°RBTreeï¼‰çš„å®é™…åº”ç”¨éå¸¸å¹¿æ³›ï¼Œæ¯”å¦‚Linuxå†…æ ¸ä¸­çš„å®Œå…¨å…¬å¹³è°ƒåº¦å™¨ã€é«˜ç²¾åº¦è®¡æ—¶å™¨ã€ext3æ–‡ä»¶ç³»ç»Ÿç­‰ç­‰ï¼Œå„ç§è¯­è¨€çš„å‡½æ•°åº“å¦‚Javaçš„TreeMapå’ŒTreeSetï¼ŒC++ STLçš„mapã€multimapã€multisetç­‰ã€‚</p>
<p>RBTreeä¹Ÿæ˜¯å‡½æ•°å¼è¯­è¨€ä¸­æœ€å¸¸ç”¨çš„æŒä¹…æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œåœ¨è®¡ç®—å‡ ä½•ä¸­ä¹Ÿæœ‰é‡è¦ä½œç”¨ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒJava 8ä¸­HashMapçš„å®ç°ä¹Ÿå› ä¸ºç”¨RBTreeå–ä»£é“¾è¡¨ï¼Œæ€§èƒ½æœ‰æ‰€æå‡ã€‚</p>
<h3 id="RBTreeçš„å®šä¹‰"><a href="#RBTreeçš„å®šä¹‰" class="headerlink" title="RBTreeçš„å®šä¹‰"></a>RBTreeçš„å®šä¹‰</h3><p>RBTreeçš„å®šä¹‰å¦‚ä¸‹:</p>
<ol>
<li>ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹éƒ½æœ‰é¢œè‰²ï¼Œé»‘è‰²æˆ–è€…çº¢è‰²</li>
<li>æ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²çš„</li>
<li>çˆ¶å­èŠ‚ç‚¹ä¹‹é—´ä¸èƒ½å‡ºç°ä¸¤ä¸ªè¿ç»­çš„çº¢èŠ‚ç‚¹</li>
<li>ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹å‘ä¸‹éå†åˆ°å…¶å­å­™çš„å¶å­èŠ‚ç‚¹ï¼Œæ‰€ç»è¿‡çš„é»‘èŠ‚ç‚¹ä¸ªæ•°å¿…é¡»ç›¸ç­‰</li>
<li>ç©ºèŠ‚ç‚¹è¢«è®¤ä¸ºæ˜¯é»‘è‰²çš„</li>
</ol>
<p>æ•°æ®ç»“æ„è¡¨ç¤ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span>  <span class="title">Node</span>&lt;<span class="title">T</span>&gt;</span>&#123;</div><div class="line">   <span class="keyword">public</span>  T value;</div><div class="line">   <span class="keyword">public</span>   Node&lt;T&gt; parent;</div><div class="line">   <span class="keyword">public</span>   Node&lt;T&gt; left;</div><div class="line">   <span class="keyword">public</span>   Node&lt;T&gt; right;</div><div class="line">   <span class="keyword">public</span>   <span class="keyword">boolean</span> isRed;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>RBTreeåœ¨ç†è®ºä¸Šè¿˜æ˜¯ä¸€æ£µBSTæ ‘ï¼Œä½†æ˜¯å®ƒåœ¨å¯¹BSTçš„æ’å…¥å’Œåˆ é™¤æ“ä½œæ—¶ä¼šç»´æŒæ ‘çš„å¹³è¡¡ï¼Œå³ä¿è¯æ ‘çš„é«˜åº¦åœ¨[logN,logN+1]ï¼ˆç†è®ºä¸Šï¼Œæç«¯çš„æƒ…å†µä¸‹å¯ä»¥å‡ºç°RBTreeçš„é«˜åº¦è¾¾åˆ°2*logNï¼Œä½†å®é™…ä¸Šå¾ˆéš¾é‡åˆ°ï¼‰ã€‚è¿™æ ·RBTreeçš„æŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦å§‹ç»ˆä¿æŒåœ¨O(logN)ä»è€Œæ¥è¿‘äºç†æƒ³çš„BSTã€‚RBTreeçš„åˆ é™¤å’Œæ’å…¥æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¹Ÿæ˜¯O(logN)ã€‚RBTreeçš„æŸ¥æ‰¾æ“ä½œå°±æ˜¯BSTçš„æŸ¥æ‰¾æ“ä½œã€‚</p>
<h3 id="RBTreeçš„æ—‹è½¬æ“ä½œ"><a href="#RBTreeçš„æ—‹è½¬æ“ä½œ" class="headerlink" title="RBTreeçš„æ—‹è½¬æ“ä½œ"></a>RBTreeçš„æ—‹è½¬æ“ä½œ</h3><p>æ—‹è½¬æ“ä½œ(Rotate)çš„ç›®çš„æ˜¯ä½¿èŠ‚ç‚¹é¢œè‰²ç¬¦åˆå®šä¹‰ï¼Œè®©RBTreeçš„é«˜åº¦è¾¾åˆ°å¹³è¡¡ã€‚<br>Rotateåˆ†ä¸ºleft-rotateï¼ˆå·¦æ—‹ï¼‰å’Œright-rotateï¼ˆå³æ—‹ï¼‰ï¼ŒåŒºåˆ†å·¦æ—‹å’Œå³æ—‹çš„æ–¹æ³•æ˜¯ï¼šå¾…æ—‹è½¬çš„èŠ‚ç‚¹ä»å·¦è¾¹ä¸Šå‡åˆ°çˆ¶èŠ‚ç‚¹å°±æ˜¯å³æ—‹ï¼Œå¾…æ—‹è½¬çš„èŠ‚ç‚¹ä»å³è¾¹ä¸Šå‡åˆ°çˆ¶èŠ‚ç‚¹å°±æ˜¯å·¦æ—‹ã€‚</p>
<p><img src="http://tech.meituan.com/img/redblack-tree/rotate-all.png" alt="BST remove"></p>
<h3 id="RBTreeçš„æŸ¥æ‰¾æ“ä½œ"><a href="#RBTreeçš„æŸ¥æ‰¾æ“ä½œ" class="headerlink" title="RBTreeçš„æŸ¥æ‰¾æ“ä½œ"></a>RBTreeçš„æŸ¥æ‰¾æ“ä½œ</h3><p>RBTreeçš„æŸ¥æ‰¾æ“ä½œå’ŒBSTçš„æŸ¥æ‰¾æ“ä½œæ˜¯ä¸€æ ·çš„ã€‚</p>
<h3 id="RBTreeçš„æ’å…¥æ“ä½œ"><a href="#RBTreeçš„æ’å…¥æ“ä½œ" class="headerlink" title="RBTreeçš„æ’å…¥æ“ä½œ"></a>RBTreeçš„æ’å…¥æ“ä½œ</h3><p>RBTreeçš„æ’å…¥ä¸BSTçš„æ’å…¥æ–¹å¼æ˜¯ä¸€è‡´çš„ï¼Œåªä¸è¿‡æ˜¯åœ¨æ’å…¥è¿‡åï¼Œå¯èƒ½ä¼šå¯¼è‡´æ ‘çš„ä¸å¹³è¡¡ï¼Œè¿™æ—¶å°±éœ€è¦å¯¹æ ‘è¿›è¡Œæ—‹è½¬æ“ä½œå’Œé¢œè‰²ä¿®å¤ï¼ˆåœ¨è¿™é‡Œç®€ç§°æ’å…¥ä¿®å¤ï¼‰ï¼Œä½¿å¾—å®ƒç¬¦åˆRBTreeçš„å®šä¹‰ã€‚</p>
<p>æ–°æ’å…¥çš„èŠ‚ç‚¹æ˜¯çº¢è‰²çš„ï¼Œæ’å…¥ä¿®å¤æ“ä½œå¦‚æœé‡åˆ°çˆ¶èŠ‚ç‚¹çš„é¢œè‰²ä¸ºé»‘åˆ™ä¿®å¤æ“ä½œç»“æŸã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰åœ¨çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²èŠ‚ç‚¹çš„æ—¶å€™æ˜¯éœ€è¦æ’å…¥ä¿®å¤æ“ä½œçš„ã€‚</p>
<p>æ’å…¥ä¿®å¤æ“ä½œåˆ†ä¸ºä»¥ä¸‹çš„ä¸‰ç§æƒ…å†µï¼Œè€Œä¸”æ–°æ’å…¥çš„èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹éƒ½æ˜¯çº¢è‰²çš„ï¼š</p>
<ol>
<li>å”å”èŠ‚ç‚¹ä¹Ÿä¸ºçº¢è‰²ã€‚</li>
<li>å”å”èŠ‚ç‚¹ä¸ºç©ºï¼Œä¸”ç¥–çˆ¶èŠ‚ç‚¹ã€çˆ¶èŠ‚ç‚¹å’Œæ–°èŠ‚ç‚¹å¤„äºä¸€æ¡æ–œçº¿ä¸Šã€‚</li>
<li>å”å”èŠ‚ç‚¹ä¸ºç©ºï¼Œä¸”ç¥–çˆ¶èŠ‚ç‚¹ã€çˆ¶èŠ‚ç‚¹å’Œæ–°èŠ‚ç‚¹ä¸å¤„äºä¸€æ¡æ–œçº¿ä¸Šã€‚</li>
</ol>
<h4 id="æ’å…¥æ“ä½œ-case-1"><a href="#æ’å…¥æ“ä½œ-case-1" class="headerlink" title="æ’å…¥æ“ä½œ-case 1"></a>æ’å…¥æ“ä½œ-case 1</h4><p>case 1çš„æ“ä½œæ˜¯å°†çˆ¶èŠ‚ç‚¹å’Œå”å”èŠ‚ç‚¹ä¸ç¥–çˆ¶èŠ‚ç‚¹çš„é¢œè‰²äº’æ¢ï¼Œè¿™æ ·å°±ç¬¦åˆäº†RBTReeçš„å®šä¹‰ã€‚å³ç»´æŒäº†é«˜åº¦çš„å¹³è¡¡ï¼Œä¿®å¤åé¢œè‰²ä¹Ÿç¬¦åˆRBTreeå®šä¹‰çš„ç¬¬ä¸‰æ¡å’Œç¬¬å››æ¡ã€‚ä¸‹å›¾ä¸­ï¼Œæ“ä½œå®ŒæˆåAèŠ‚ç‚¹å˜æˆäº†æ–°çš„èŠ‚ç‚¹ã€‚å¦‚æœAèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸æ˜¯é»‘è‰²çš„è¯ï¼Œåˆ™ç»§ç»­åšä¿®å¤æ“ä½œã€‚<br><img src="http://tech.meituan.com/img/redblack-tree/insert-case1.png" alt="æ’å…¥ä¿®å¤case 1"></p>
<h4 id="æ’å…¥æ“ä½œ-case-2"><a href="#æ’å…¥æ“ä½œ-case-2" class="headerlink" title="æ’å…¥æ“ä½œ-case 2"></a>æ’å…¥æ“ä½œ-case 2</h4><p>case 2çš„æ“ä½œæ˜¯å°†BèŠ‚ç‚¹è¿›è¡Œå³æ—‹æ“ä½œï¼Œå¹¶ä¸”å’Œçˆ¶èŠ‚ç‚¹Aäº’æ¢é¢œè‰²ã€‚é€šè¿‡è¯¥ä¿®å¤æ“ä½œRBTReeçš„é«˜åº¦å’Œé¢œè‰²éƒ½ç¬¦åˆçº¢é»‘æ ‘çš„å®šä¹‰ã€‚å¦‚æœBå’ŒCèŠ‚ç‚¹éƒ½æ˜¯å³èŠ‚ç‚¹çš„è¯ï¼Œåªè¦å°†æ“ä½œå˜æˆå·¦æ—‹å°±å¯ä»¥äº†ã€‚<br><img src="http://tech.meituan.com/img/redblack-tree/insert-case2.png" alt="æ’å…¥ä¿®å¤case 2"></p>
<h4 id="æ’å…¥æ“ä½œ-case-3"><a href="#æ’å…¥æ“ä½œ-case-3" class="headerlink" title="æ’å…¥æ“ä½œ-case 3"></a>æ’å…¥æ“ä½œ-case 3</h4><p>case 3çš„æ“ä½œæ˜¯å°†CèŠ‚ç‚¹è¿›è¡Œå·¦æ—‹ï¼Œè¿™æ ·å°±ä»case 3è½¬æ¢æˆcase 2äº†ï¼Œç„¶åé’ˆå¯¹case 2è¿›è¡Œæ“ä½œå¤„ç†å°±è¡Œäº†ã€‚case 2æ“ä½œåšäº†ä¸€ä¸ªå³æ—‹æ“ä½œå’Œé¢œè‰²äº’æ¢æ¥è¾¾åˆ°ç›®çš„ã€‚å¦‚æœæ ‘çš„ç»“æ„æ˜¯ä¸‹å›¾çš„é•œåƒç»“æ„ï¼Œåˆ™åªéœ€è¦å°†å¯¹åº”çš„å·¦æ—‹å˜æˆå³æ—‹ï¼Œå³æ—‹å˜æˆå·¦æ—‹å³å¯ã€‚<br><img src="http://tech.meituan.com/img/redblack-tree/insert-case3.png" alt="æ’å…¥ä¿®å¤case 3"></p>
<h4 id="æ’å…¥æ“ä½œçš„æ€»ç»“"><a href="#æ’å…¥æ“ä½œçš„æ€»ç»“" class="headerlink" title="æ’å…¥æ“ä½œçš„æ€»ç»“"></a>æ’å…¥æ“ä½œçš„æ€»ç»“</h4><p>æ’å…¥åçš„ä¿®å¤æ“ä½œæ˜¯ä¸€ä¸ªå‘rootèŠ‚ç‚¹å›æº¯çš„æ“ä½œï¼Œä¸€æ—¦ç‰µæ¶‰çš„èŠ‚ç‚¹éƒ½ç¬¦åˆäº†çº¢é»‘æ ‘çš„å®šä¹‰ï¼Œä¿®å¤æ“ä½œç»“æŸã€‚ä¹‹æ‰€ä»¥ä¼šå‘ä¸Šå›æº¯æ˜¯ç”±äºcase 1æ“ä½œä¼šå°†çˆ¶èŠ‚ç‚¹ï¼Œå”å”èŠ‚ç‚¹å’Œç¥–çˆ¶èŠ‚ç‚¹è¿›è¡Œæ¢é¢œè‰²ï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´ç¥–çˆ¶èŠ‚ç‚¹ä¸å¹³è¡¡(çº¢é»‘æ ‘å®šä¹‰3)ã€‚è¿™ä¸ªæ—¶å€™éœ€è¦å¯¹ç¥–çˆ¶èŠ‚ç‚¹ä¸ºèµ·ç‚¹è¿›è¡Œè°ƒèŠ‚ï¼ˆå‘ä¸Šå›æº¯ï¼‰ã€‚</p>
<p>ç¥–çˆ¶èŠ‚ç‚¹è°ƒèŠ‚åå¦‚æœè¿˜æ˜¯é‡åˆ°å®ƒçš„ç¥–çˆ¶é¢œè‰²é—®é¢˜ï¼Œæ“ä½œå°±ä¼šç»§ç»­å‘ä¸Šå›æº¯ï¼Œç›´åˆ°rootèŠ‚ç‚¹ä¸ºæ­¢ï¼Œæ ¹æ®å®šä¹‰rootèŠ‚ç‚¹æ°¸è¿œæ˜¯é»‘è‰²çš„ã€‚åœ¨å‘ä¸Šçš„è¿½æº¯çš„è¿‡ç¨‹ä¸­ï¼Œé’ˆå¯¹æ’å…¥çš„3ä¸­æƒ…å†µè¿›è¡Œè°ƒèŠ‚ã€‚ç›´åˆ°ç¬¦åˆçº¢é»‘æ ‘çš„å®šä¹‰ä¸ºæ­¢ã€‚ç›´åˆ°ç‰µæ¶‰çš„èŠ‚ç‚¹éƒ½ç¬¦åˆäº†çº¢é»‘æ ‘çš„å®šä¹‰ï¼Œä¿®å¤æ“ä½œç»“æŸã€‚</p>
<p>å¦‚æœä¸Šé¢çš„3ä¸­æƒ…å†µå¦‚æœå¯¹åº”çš„æ“ä½œæ˜¯åœ¨å³å­æ ‘ä¸Šï¼Œåšå¯¹åº”çš„é•œåƒæ“ä½œå°±æ˜¯äº†ã€‚</p>
<h3 id="RBTreeçš„åˆ é™¤æ“ä½œ"><a href="#RBTreeçš„åˆ é™¤æ“ä½œ" class="headerlink" title="RBTreeçš„åˆ é™¤æ“ä½œ"></a>RBTreeçš„åˆ é™¤æ“ä½œ</h3><p>åˆ é™¤æ“ä½œé¦–å…ˆéœ€è¦åšçš„ä¹Ÿæ˜¯BSTçš„åˆ é™¤æ“ä½œï¼Œåˆ é™¤æ“ä½œä¼šåˆ é™¤å¯¹åº”çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯å¶å­èŠ‚ç‚¹å°±ç›´æ¥åˆ é™¤ï¼Œå¦‚æœæ˜¯éå¶å­èŠ‚ç‚¹ï¼Œä¼šç”¨å¯¹åº”çš„ä¸­åºéå†çš„åç»§èŠ‚ç‚¹æ¥é¡¶æ›¿è¦åˆ é™¤èŠ‚ç‚¹çš„ä½ç½®ã€‚åˆ é™¤åå°±éœ€è¦åšåˆ é™¤ä¿®å¤æ“ä½œï¼Œä½¿çš„æ ‘ç¬¦åˆçº¢é»‘æ ‘çš„å®šä¹‰ï¼Œç¬¦åˆå®šä¹‰çš„çº¢é»‘æ ‘é«˜åº¦æ˜¯å¹³è¡¡çš„ã€‚</p>
<p>åˆ é™¤ä¿®å¤æ“ä½œåœ¨é‡åˆ°è¢«åˆ é™¤çš„èŠ‚ç‚¹æ˜¯çº¢è‰²èŠ‚ç‚¹æˆ–è€…åˆ°è¾¾rootèŠ‚ç‚¹æ—¶ï¼Œä¿®å¤æ“ä½œå®Œæ¯•ã€‚</p>
<p>åˆ é™¤ä¿®å¤æ“ä½œæ˜¯é’ˆå¯¹åˆ é™¤é»‘è‰²èŠ‚ç‚¹æ‰æœ‰çš„ï¼Œå½“é»‘è‰²èŠ‚ç‚¹è¢«åˆ é™¤åä¼šè®©æ•´ä¸ªæ ‘ä¸ç¬¦åˆRBTreeçš„å®šä¹‰çš„ç¬¬å››æ¡ã€‚éœ€è¦åšçš„å¤„ç†æ˜¯ä»å…„å¼ŸèŠ‚ç‚¹ä¸Šå€Ÿè°ƒé»‘è‰²çš„èŠ‚ç‚¹è¿‡æ¥ï¼Œå¦‚æœå…„å¼ŸèŠ‚ç‚¹æ²¡æœ‰é»‘èŠ‚ç‚¹å¯ä»¥å€Ÿè°ƒçš„è¯ï¼Œå°±åªèƒ½å¾€ä¸Šè¿½æº¯ï¼Œå°†æ¯ä¸€çº§çš„é»‘èŠ‚ç‚¹æ•°å‡å»ä¸€ä¸ªï¼Œä½¿å¾—æ•´æ£µæ ‘ç¬¦åˆçº¢é»‘æ ‘çš„å®šä¹‰ã€‚</p>
<p>åˆ é™¤æ“ä½œçš„æ€»ä½“æ€æƒ³æ˜¯ä»å…„å¼ŸèŠ‚ç‚¹å€Ÿè°ƒé»‘è‰²èŠ‚ç‚¹ä½¿æ ‘ä¿æŒå±€éƒ¨çš„å¹³è¡¡ï¼Œå¦‚æœå±€éƒ¨çš„å¹³è¡¡è¾¾åˆ°äº†ï¼Œå°±çœ‹æ•´ä½“çš„æ ‘æ˜¯å¦æ˜¯å¹³è¡¡çš„ï¼Œå¦‚æœä¸å¹³è¡¡å°±æ¥ç€å‘ä¸Šè¿½æº¯è°ƒæ•´ã€‚</p>
<p>åˆ é™¤ä¿®å¤æ“ä½œåˆ†ä¸ºå››ç§æƒ…å†µ(åˆ é™¤é»‘èŠ‚ç‚¹å)ï¼š</p>
<ol>
<li>å¾…åˆ é™¤çš„èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹æ˜¯çº¢è‰²çš„èŠ‚ç‚¹ã€‚</li>
<li>å¾…åˆ é™¤çš„èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹æ˜¯é»‘è‰²çš„èŠ‚ç‚¹ï¼Œä¸”å…„å¼ŸèŠ‚ç‚¹çš„å­èŠ‚ç‚¹éƒ½æ˜¯é»‘è‰²çš„ã€‚</li>
<li>å¾…è°ƒæ•´çš„èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹æ˜¯é»‘è‰²çš„èŠ‚ç‚¹ï¼Œä¸”å…„å¼ŸèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹æ˜¯çº¢è‰²çš„ï¼Œå³èŠ‚ç‚¹æ˜¯é»‘è‰²çš„(å…„å¼ŸèŠ‚ç‚¹åœ¨å³è¾¹)ï¼Œå¦‚æœå…„å¼ŸèŠ‚ç‚¹åœ¨å·¦è¾¹çš„è¯ï¼Œå°±æ˜¯å…„å¼ŸèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹æ˜¯çº¢è‰²çš„ï¼Œå·¦èŠ‚ç‚¹æ˜¯é»‘è‰²çš„ã€‚</li>
<li>å¾…è°ƒæ•´çš„èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹æ˜¯é»‘è‰²çš„èŠ‚ç‚¹ï¼Œä¸”å³å­èŠ‚ç‚¹æ˜¯æ˜¯çº¢è‰²çš„(å…„å¼ŸèŠ‚ç‚¹åœ¨å³è¾¹)ï¼Œå¦‚æœå…„å¼ŸèŠ‚ç‚¹åœ¨å·¦è¾¹ï¼Œåˆ™å°±æ˜¯å¯¹åº”çš„å°±æ˜¯å·¦èŠ‚ç‚¹æ˜¯çº¢è‰²çš„ã€‚</li>
</ol>
<h4 id="åˆ é™¤æ“ä½œ-case-1"><a href="#åˆ é™¤æ“ä½œ-case-1" class="headerlink" title="åˆ é™¤æ“ä½œ-case 1"></a>åˆ é™¤æ“ä½œ-case 1</h4><p>ç”±äºå…„å¼ŸèŠ‚ç‚¹æ˜¯çº¢è‰²èŠ‚ç‚¹çš„æ—¶å€™ï¼Œæ— æ³•å€Ÿè°ƒé»‘èŠ‚ç‚¹ï¼Œæ‰€ä»¥éœ€è¦å°†å…„å¼ŸèŠ‚ç‚¹æå‡åˆ°çˆ¶èŠ‚ç‚¹ï¼Œç”±äºå…„å¼ŸèŠ‚ç‚¹æ˜¯çº¢è‰²çš„ï¼Œæ ¹æ®RBTreeçš„å®šä¹‰ï¼Œå…„å¼ŸèŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ˜¯é»‘è‰²çš„ï¼Œå°±å¯ä»¥ä»å®ƒçš„å­èŠ‚ç‚¹å€Ÿè°ƒäº†ã€‚</p>
<p>case 1è¿™æ ·è½¬æ¢ä¹‹åå°±ä¼šå˜æˆåé¢çš„case 2ï¼Œcase 3ï¼Œæˆ–è€…case 4è¿›è¡Œå¤„ç†äº†ã€‚ä¸Šå‡æ“ä½œéœ€è¦å¯¹Cåšä¸€ä¸ªå·¦æ—‹æ“ä½œï¼Œå¦‚æœæ˜¯é•œåƒç»“æ„çš„æ ‘åªéœ€è¦åšå¯¹åº”çš„å³æ—‹æ“ä½œå³å¯ã€‚</p>
<p>ä¹‹æ‰€ä»¥è¦åšcase 1æ“ä½œæ˜¯å› ä¸ºå…„å¼ŸèŠ‚ç‚¹æ˜¯çº¢è‰²çš„ï¼Œæ— æ³•å€Ÿåˆ°ä¸€ä¸ªé»‘èŠ‚ç‚¹æ¥å¡«è¡¥åˆ é™¤çš„é»‘èŠ‚ç‚¹ã€‚</p>
<p><img src="http://tech.meituan.com/img/redblack-tree/remove-case1.png" alt="åˆ é™¤æƒ…å†µ1"></p>
<h4 id="åˆ é™¤æ“ä½œ-case-2"><a href="#åˆ é™¤æ“ä½œ-case-2" class="headerlink" title="åˆ é™¤æ“ä½œ-case 2"></a>åˆ é™¤æ“ä½œ-case 2</h4><p>case 2çš„åˆ é™¤æ“ä½œæ˜¯ç”±äºå…„å¼ŸèŠ‚ç‚¹å¯ä»¥æ¶ˆé™¤ä¸€ä¸ªé»‘è‰²èŠ‚ç‚¹ï¼Œå› ä¸ºå…„å¼ŸèŠ‚ç‚¹å’Œå…„å¼ŸèŠ‚ç‚¹çš„å­èŠ‚ç‚¹éƒ½æ˜¯é»‘è‰²çš„ï¼Œæ‰€ä»¥å¯ä»¥å°†å…„å¼ŸèŠ‚ç‚¹å˜çº¢ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯æ ‘çš„å±€éƒ¨çš„é¢œè‰²ç¬¦åˆå®šä¹‰äº†ã€‚è¿™ä¸ªæ—¶å€™éœ€è¦å°†çˆ¶èŠ‚ç‚¹Aå˜æˆæ–°çš„èŠ‚ç‚¹ï¼Œç»§ç»­å‘ä¸Šè°ƒæ•´ï¼Œç›´åˆ°æ•´é¢—æ ‘çš„é¢œè‰²ç¬¦åˆRBTreeçš„å®šä¹‰ä¸ºæ­¢ã€‚</p>
<p>case 2è¿™ç§æƒ…å†µä¸‹ä¹‹æ‰€ä»¥è¦å°†å…„å¼ŸèŠ‚ç‚¹å˜çº¢ï¼Œæ˜¯å› ä¸ºå¦‚æœæŠŠå…„å¼ŸèŠ‚ç‚¹å€Ÿè°ƒè¿‡æ¥ï¼Œä¼šå¯¼è‡´å…„å¼Ÿçš„ç»“æ„ä¸ç¬¦åˆRBTreeçš„å®šä¹‰ï¼Œè¿™æ ·çš„æƒ…å†µä¸‹åªèƒ½æ˜¯å°†å…„å¼ŸèŠ‚ç‚¹ä¹Ÿå˜æˆçº¢è‰²æ¥è¾¾åˆ°é¢œè‰²çš„å¹³è¡¡ã€‚å½“å°†å…„å¼ŸèŠ‚ç‚¹ä¹Ÿå˜çº¢ä¹‹åï¼Œè¾¾åˆ°äº†å±€éƒ¨çš„å¹³è¡¡äº†ï¼Œä½†æ˜¯å¯¹äºç¥–çˆ¶èŠ‚ç‚¹æ¥è¯´æ˜¯ä¸ç¬¦åˆå®šä¹‰4çš„ã€‚è¿™æ ·å°±éœ€è¦å›æº¯åˆ°çˆ¶èŠ‚ç‚¹ï¼Œæ¥ç€è¿›è¡Œä¿®å¤æ“ä½œã€‚</p>
<p><img src="http://tech.meituan.com/img/redblack-tree/remove-case2.png" alt="åˆ é™¤æƒ…å†µ2"></p>
<h4 id="åˆ é™¤æ“ä½œ-case-3"><a href="#åˆ é™¤æ“ä½œ-case-3" class="headerlink" title="åˆ é™¤æ“ä½œ-case 3"></a>åˆ é™¤æ“ä½œ-case 3</h4><p>case 3çš„åˆ é™¤æ“ä½œæ˜¯ä¸€ä¸ªä¸­é—´æ­¥éª¤ï¼Œå®ƒçš„ç›®çš„æ˜¯å°†å·¦è¾¹çš„çº¢è‰²èŠ‚ç‚¹å€Ÿè°ƒè¿‡æ¥ï¼Œè¿™æ ·å°±å¯ä»¥è½¬æ¢æˆcase 4çŠ¶æ€äº†ï¼Œåœ¨case 4çŠ¶æ€ä¸‹å¯ä»¥å°†Dï¼ŒEèŠ‚ç‚¹éƒ½é˜¶æ®µè¿‡æ¥ï¼Œé€šè¿‡å°†ä¸¤ä¸ªèŠ‚ç‚¹å˜æˆé»‘è‰²æ¥ä¿è¯çº¢é»‘æ ‘çš„æ•´ä½“å¹³è¡¡ã€‚</p>
<p>ä¹‹æ‰€ä»¥è¯´case-3æ˜¯ä¸€ä¸ªä¸­é—´çŠ¶æ€ï¼Œæ˜¯å› ä¸ºæ ¹æ®çº¢é»‘æ ‘çš„å®šä¹‰æ¥è¯´ï¼Œä¸‹å›¾å¹¶ä¸æ˜¯å¹³è¡¡çš„ï¼Œä»–æ˜¯é€šè¿‡case 2æ“ä½œå®Œåå‘ä¸Šå›æº¯å‡ºç°çš„çŠ¶æ€ã€‚ä¹‹æ‰€ä»¥ä¼šå‡ºç°case 3å’Œåé¢çš„case 4çš„æƒ…å†µï¼Œæ˜¯å› ä¸ºå¯ä»¥é€šè¿‡å€Ÿç”¨ä¾„å­èŠ‚ç‚¹çš„çº¢è‰²ï¼Œå˜æˆé»‘è‰²æ¥ç¬¦åˆçº¢é»‘æ ‘å®šä¹‰4.<br><img src="http://tech.meituan.com/img/redblack-tree/remove-case3.png" alt="åˆ é™¤æƒ…å†µ3"></p>
<h4 id="åˆ é™¤æ“ä½œ-case-4"><a href="#åˆ é™¤æ“ä½œ-case-4" class="headerlink" title="åˆ é™¤æ“ä½œ-case 4"></a>åˆ é™¤æ“ä½œ-case 4</h4><p>Case 4çš„æ“ä½œæ˜¯çœŸæ­£çš„èŠ‚ç‚¹å€Ÿè°ƒæ“ä½œï¼Œé€šè¿‡å°†å…„å¼ŸèŠ‚ç‚¹ä»¥åŠå…„å¼ŸèŠ‚ç‚¹çš„å³èŠ‚ç‚¹å€Ÿè°ƒè¿‡æ¥ï¼Œå¹¶å°†å…„å¼ŸèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹å˜æˆçº¢è‰²æ¥è¾¾åˆ°å€Ÿè°ƒä¸¤ä¸ªé»‘èŠ‚ç‚¹çš„ç›®çš„ï¼Œè¿™æ ·çš„è¯ï¼Œæ•´æ£µæ ‘è¿˜æ˜¯ç¬¦åˆRBTreeçš„å®šä¹‰çš„ã€‚</p>
<p>Case 4è¿™ç§æƒ…å†µçš„å‘ç”Ÿåªæœ‰åœ¨å¾…åˆ é™¤çš„èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹ä¸ºé»‘ï¼Œä¸”å­èŠ‚ç‚¹ä¸å…¨éƒ¨ä¸ºé»‘ï¼Œæ‰æœ‰å¯èƒ½å€Ÿè°ƒåˆ°ä¸¤ä¸ªèŠ‚ç‚¹æ¥åšé»‘èŠ‚ç‚¹ä½¿ç”¨ï¼Œä»è€Œä¿æŒæ•´æ£µæ ‘éƒ½ç¬¦åˆçº¢é»‘æ ‘çš„å®šä¹‰ã€‚<br><img src="http://tech.meituan.com/img/redblack-tree/remove-case4.png" alt="åˆ é™¤æƒ…å†µ4"></p>
<p><strong>åˆ é™¤æ“ä½œçš„æ€»ç»“</strong></p>
<p>çº¢é»‘æ ‘çš„åˆ é™¤æ“ä½œæ˜¯æœ€å¤æ‚çš„æ“ä½œï¼Œå¤æ‚çš„åœ°æ–¹å°±åœ¨äºå½“åˆ é™¤äº†é»‘è‰²èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¦‚ä½•ä»å…„å¼ŸèŠ‚ç‚¹å»å€Ÿè°ƒèŠ‚ç‚¹ï¼Œä»¥ä¿è¯æ ‘çš„é¢œè‰²ç¬¦åˆå®šä¹‰ã€‚ç”±äºçº¢è‰²çš„å…„å¼ŸèŠ‚ç‚¹æ˜¯æ²¡æ³•å€Ÿè°ƒå‡ºé»‘èŠ‚ç‚¹çš„ï¼Œè¿™æ ·åªèƒ½é€šè¿‡é€‰æ‹©æ“ä½œè®©ä»–ä¸Šå‡åˆ°çˆ¶èŠ‚ç‚¹ï¼Œè€Œç”±äºå®ƒæ˜¯çº¢èŠ‚ç‚¹ï¼Œæ‰€ä»¥å®ƒçš„å­èŠ‚ç‚¹å°±æ˜¯é»‘çš„ï¼Œå¯ä»¥å€Ÿè°ƒã€‚</p>
<p>å¯¹äºå…„å¼ŸèŠ‚ç‚¹æ˜¯é»‘è‰²èŠ‚ç‚¹çš„å¯ä»¥åˆ†æˆ3ç§æƒ…å†µæ¥å¤„ç†ï¼Œå½“æ‰€ä»¥çš„å…„å¼ŸèŠ‚ç‚¹çš„å­èŠ‚ç‚¹éƒ½æ˜¯é»‘è‰²èŠ‚ç‚¹æ—¶ï¼Œå¯ä»¥ç›´æ¥å°†å…„å¼ŸèŠ‚ç‚¹å˜çº¢ï¼Œè¿™æ ·å±€éƒ¨çš„çº¢é»‘æ ‘é¢œè‰²æ˜¯ç¬¦åˆå®šä¹‰çš„ã€‚ä½†æ˜¯æ•´é¢—æ ‘ä¸ä¸€å®šæ˜¯ç¬¦åˆçº¢é»‘æ ‘å®šä¹‰çš„ï¼Œéœ€è¦å¾€ä¸Šè¿½æº¯ç»§ç»­è°ƒæ•´ã€‚</p>
<p>å¯¹äºå…„å¼ŸèŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ºå·¦çº¢å³é»‘æˆ–è€… (å…¨éƒ¨ä¸ºçº¢ï¼Œå³çº¢å·¦é»‘)è¿™ä¸¤ç§æƒ…å†µï¼Œå¯ä»¥å…ˆå°†å‰é¢çš„æƒ…å†µé€šè¿‡é€‰æ‹©è½¬æ¢ä¸ºåä¸€ç§æƒ…å†µï¼Œåœ¨åä¸€ç§æƒ…å†µä¸‹ï¼Œå› ä¸ºå…„å¼ŸèŠ‚ç‚¹ä¸ºé»‘ï¼Œå…„å¼ŸèŠ‚ç‚¹çš„å³èŠ‚ç‚¹ä¸ºçº¢ï¼Œå¯ä»¥å€Ÿè°ƒå‡ºä¸¤ä¸ªèŠ‚ç‚¹å‡ºæ¥åšé»‘èŠ‚ç‚¹ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯åˆ é™¤äº†é»‘èŠ‚ç‚¹ï¼Œæ•´æ£µæ ‘è¿˜æ˜¯ç¬¦åˆçº¢é»‘æ ‘çš„å®šä¹‰çš„ï¼Œå› ä¸ºé»‘è‰²èŠ‚ç‚¹çš„ä¸ªæ•°æ²¡æœ‰æ”¹å˜ã€‚</p>
<p>çº¢é»‘æ ‘çš„åˆ é™¤æ“ä½œæ˜¯é‡åˆ°åˆ é™¤çš„èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼Œæˆ–è€…è¿½æº¯è°ƒæ•´åˆ°äº†rootèŠ‚ç‚¹ï¼Œè¿™æ—¶åˆ é™¤çš„ä¿®å¤æ“ä½œå®Œæ¯•ã€‚</p>
<h3 id="RBTreeçš„Javaå®ç°"><a href="#RBTreeçš„Javaå®ç°" class="headerlink" title="RBTreeçš„Javaå®ç°"></a>RBTreeçš„Javaå®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RBTreeNode</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> T value;<span class="comment">//node value</span></div><div class="line">    <span class="keyword">private</span> RBTreeNode&lt;T&gt; left;<span class="comment">//left child pointer</span></div><div class="line">    <span class="keyword">private</span> RBTreeNode&lt;T&gt; right;<span class="comment">//right child pointer</span></div><div class="line">    <span class="keyword">private</span> RBTreeNode&lt;T&gt; parent;<span class="comment">//parent pointer</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> red;<span class="comment">//color is red or not red</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RBTreeNode</span><span class="params">()</span></span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RBTreeNode</span><span class="params">(T value)</span></span>&#123;<span class="keyword">this</span>.value=value;&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RBTreeNode</span><span class="params">(T value,<span class="keyword">boolean</span> isRed)</span></span>&#123;<span class="keyword">this</span>.value=value;<span class="keyword">this</span>.red = isRed;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getValue</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.value = value;</div><div class="line">    &#125;</div><div class="line">    <span class="function">RBTreeNode&lt;T&gt; <span class="title">getLeft</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> left;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setLeft</span><span class="params">(RBTreeNode&lt;T&gt; left)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.left = left;</div><div class="line">    &#125;</div><div class="line">    <span class="function">RBTreeNode&lt;T&gt; <span class="title">getRight</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> right;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setRight</span><span class="params">(RBTreeNode&lt;T&gt; right)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.right = right;</div><div class="line">    &#125;</div><div class="line">    <span class="function">RBTreeNode&lt;T&gt; <span class="title">getParent</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> parent;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setParent</span><span class="params">(RBTreeNode&lt;T&gt; parent)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.parent = parent;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isRed</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> red;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isBlack</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> !red;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * is leaf node</div><div class="line">    **/</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isLeaf</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> left==<span class="keyword">null</span> &amp;&amp; right==<span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setRed</span><span class="params">(<span class="keyword">boolean</span> red)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.red = red;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">makeRed</span><span class="params">()</span></span>&#123;</div><div class="line">        red=<span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">makeBlack</span><span class="params">()</span></span>&#123;</div><div class="line">        red=<span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> value.toString();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RBTree</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RBTreeNode&lt;T&gt; root;</div><div class="line">    <span class="comment">//node number</span></div><div class="line">    <span class="keyword">private</span> java.util.concurrent.atomic.AtomicLong size = </div><div class="line">                    <span class="keyword">new</span> java.util.concurrent.atomic.AtomicLong(<span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">//in overwrite mode,all node's value can not  has same    value</span></div><div class="line">    <span class="comment">//in non-overwrite mode,node can have same value, suggest don't use non-overwrite mode.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> overrideMode=<span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RBTree</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.root = <span class="keyword">new</span> RBTreeNode&lt;T&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RBTree</span><span class="params">(<span class="keyword">boolean</span> overrideMode)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>();</div><div class="line">        <span class="keyword">this</span>.overrideMode=overrideMode;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isOverrideMode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> overrideMode;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOverrideMode</span><span class="params">(<span class="keyword">boolean</span> overrideMode)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.overrideMode = overrideMode;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * number of tree number</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSize</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> size.get();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * get the root node</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> RBTreeNode&lt;T&gt; <span class="title">getRoot</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> root.getLeft();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * add value to a new node,if this value exist in this tree,</div><div class="line">     * if value exist,it will return the exist value.otherwise return null</div><div class="line">     * if override mode is true,if value exist in the tree,</div><div class="line">     * it will override the old value in the tree</div><div class="line">     * </div><div class="line">     * <span class="doctag">@param</span> value</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">addNode</span><span class="params">(T value)</span></span>&#123;</div><div class="line">        RBTreeNode&lt;T&gt; t = <span class="keyword">new</span> RBTreeNode&lt;T&gt;(value);</div><div class="line">        <span class="keyword">return</span> addNode(t);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * find the value by give value(include key,key used for search,</div><div class="line">     * other field is not used,<span class="doctag">@see</span> compare method).if this value not exist return null</div><div class="line">     * <span class="doctag">@param</span> value</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">find</span><span class="params">(T value)</span></span>&#123;</div><div class="line">        RBTreeNode&lt;T&gt; dataRoot = getRoot();</div><div class="line">        <span class="keyword">while</span>(dataRoot!=<span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">int</span> cmp = dataRoot.getValue().compareTo(value);</div><div class="line">            <span class="keyword">if</span>(cmp&lt;<span class="number">0</span>)&#123;</div><div class="line">                dataRoot = dataRoot.getRight();</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(cmp&gt;<span class="number">0</span>)&#123;</div><div class="line">                dataRoot = dataRoot.getLeft();</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="keyword">return</span> dataRoot.getValue();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * remove the node by give value,if this value not exists in tree return null</div><div class="line">     * <span class="doctag">@param</span> value include search key</div><div class="line">     * <span class="doctag">@return</span> the value contain in the removed node</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">remove</span><span class="params">(T value)</span></span>&#123;</div><div class="line">        RBTreeNode&lt;T&gt; dataRoot = getRoot();</div><div class="line">        RBTreeNode&lt;T&gt; parent = root;</div><div class="line"></div><div class="line">        <span class="keyword">while</span>(dataRoot!=<span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">int</span> cmp = dataRoot.getValue().compareTo(value);</div><div class="line">            <span class="keyword">if</span>(cmp&lt;<span class="number">0</span>)&#123;</div><div class="line">                parent = dataRoot;</div><div class="line">                dataRoot = dataRoot.getRight();</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(cmp&gt;<span class="number">0</span>)&#123;</div><div class="line">                parent = dataRoot;</div><div class="line">                dataRoot = dataRoot.getLeft();</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="keyword">if</span>(dataRoot.getRight()!=<span class="keyword">null</span>)&#123;</div><div class="line">                    RBTreeNode&lt;T&gt; min = removeMin(dataRoot.getRight());</div><div class="line">                    <span class="comment">//x used for fix color balance</span></div><div class="line">                    RBTreeNode&lt;T&gt; x = min.getRight()==<span class="keyword">null</span> ? min.getParent() : min.getRight();</div><div class="line">                    <span class="keyword">boolean</span> isParent = min.getRight()==<span class="keyword">null</span>;</div><div class="line"></div><div class="line">                    min.setLeft(dataRoot.getLeft());</div><div class="line">                    setParent(dataRoot.getLeft(),min);</div><div class="line">                    <span class="keyword">if</span>(parent.getLeft()==dataRoot)&#123;</div><div class="line">                        parent.setLeft(min);</div><div class="line">                    &#125;<span class="keyword">else</span>&#123;</div><div class="line">                        parent.setRight(min);</div><div class="line">                    &#125;</div><div class="line">                    setParent(min,parent);</div><div class="line"></div><div class="line">                    <span class="keyword">boolean</span> curMinIsBlack = min.isBlack();</div><div class="line">                    <span class="comment">//inherit dataRoot's color</span></div><div class="line">                    min.setRed(dataRoot.isRed());</div><div class="line"></div><div class="line">                    <span class="keyword">if</span>(min!=dataRoot.getRight())&#123;</div><div class="line">                        min.setRight(dataRoot.getRight());</div><div class="line">                        setParent(dataRoot.getRight(),min);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//remove a black node,need fix color</span></div><div class="line">                    <span class="keyword">if</span>(curMinIsBlack)&#123;</div><div class="line">                        <span class="keyword">if</span>(min!=dataRoot.getRight())&#123;</div><div class="line">                            fixRemove(x,isParent);</div><div class="line">                        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(min.getRight()!=<span class="keyword">null</span>)&#123;</div><div class="line">                            fixRemove(min.getRight(),<span class="keyword">false</span>);</div><div class="line">                        &#125;<span class="keyword">else</span>&#123;</div><div class="line">                            fixRemove(min,<span class="keyword">true</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;<span class="keyword">else</span>&#123;</div><div class="line">                    setParent(dataRoot.getLeft(),parent);</div><div class="line">                    <span class="keyword">if</span>(parent.getLeft()==dataRoot)&#123;</div><div class="line">                        parent.setLeft(dataRoot.getLeft());</div><div class="line">                    &#125;<span class="keyword">else</span>&#123;</div><div class="line">                        parent.setRight(dataRoot.getLeft());</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//current node is black and tree is not empty</span></div><div class="line">                    <span class="keyword">if</span>(dataRoot.isBlack() &amp;&amp; !(root.getLeft()==<span class="keyword">null</span>))&#123;</div><div class="line">                        RBTreeNode&lt;T&gt; x = dataRoot.getLeft()==<span class="keyword">null</span> </div><div class="line">                                            ? parent :dataRoot.getLeft();</div><div class="line">                        <span class="keyword">boolean</span> isParent = dataRoot.getLeft()==<span class="keyword">null</span>;</div><div class="line">                        fixRemove(x,isParent);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                setParent(dataRoot,<span class="keyword">null</span>);</div><div class="line">                dataRoot.setLeft(<span class="keyword">null</span>);</div><div class="line">                dataRoot.setRight(<span class="keyword">null</span>);</div><div class="line">                <span class="keyword">if</span>(getRoot()!=<span class="keyword">null</span>)&#123;</div><div class="line">                    getRoot().setRed(<span class="keyword">false</span>);</div><div class="line">                    getRoot().setParent(<span class="keyword">null</span>);</div><div class="line">                &#125;</div><div class="line">                size.decrementAndGet();</div><div class="line">                <span class="keyword">return</span> dataRoot.getValue();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * fix remove action</div><div class="line">     * <span class="doctag">@param</span> node</div><div class="line">     * <span class="doctag">@param</span> isParent</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fixRemove</span><span class="params">(RBTreeNode&lt;T&gt; node,<span class="keyword">boolean</span> isParent)</span></span>&#123;</div><div class="line">        RBTreeNode&lt;T&gt; cur = isParent ? <span class="keyword">null</span> : node;</div><div class="line">        <span class="keyword">boolean</span> isRed = isParent ? <span class="keyword">false</span> : node.isRed();</div><div class="line">        RBTreeNode&lt;T&gt; parent = isParent ? node : node.getParent();</div><div class="line"></div><div class="line">        <span class="keyword">while</span>(!isRed &amp;&amp; !isRoot(cur))&#123;</div><div class="line">            RBTreeNode&lt;T&gt; sibling = getSibling(cur,parent);</div><div class="line">            <span class="comment">//sibling is not null,due to before remove tree color is balance</span></div><div class="line"></div><div class="line">            <span class="comment">//if cur is a left node</span></div><div class="line">            <span class="keyword">boolean</span> isLeft = parent.getRight()==sibling;</div><div class="line">            <span class="keyword">if</span>(sibling.isRed() &amp;&amp; !isLeft)&#123;<span class="comment">//case 1</span></div><div class="line">                <span class="comment">//cur in right</span></div><div class="line">                parent.makeRed();</div><div class="line">                sibling.makeBlack();</div><div class="line">                rotateRight(parent);</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(sibling.isRed() &amp;&amp; isLeft)&#123;</div><div class="line">                <span class="comment">//cur in left</span></div><div class="line">                parent.makeRed();</div><div class="line">                sibling.makeBlack();</div><div class="line">                rotateLeft(parent);</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(isBlack(sibling.getLeft()) &amp;&amp; isBlack(sibling.getRight()))&#123;<span class="comment">//case 2</span></div><div class="line">                sibling.makeRed();</div><div class="line">                cur = parent;</div><div class="line">                isRed = cur.isRed();</div><div class="line">                parent=parent.getParent();</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(isLeft &amp;&amp; !isBlack(sibling.getLeft()) </div><div class="line">                                    &amp;&amp; isBlack(sibling.getRight()))&#123;<span class="comment">//case 3</span></div><div class="line">                sibling.makeRed();</div><div class="line">                sibling.getLeft().makeBlack();</div><div class="line">                rotateRight(sibling);</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!isLeft &amp;&amp; !isBlack(sibling.getRight()) </div><div class="line">                                            &amp;&amp; isBlack(sibling.getLeft()) )&#123;</div><div class="line">                sibling.makeRed();</div><div class="line">                sibling.getRight().makeBlack();</div><div class="line">                rotateLeft(sibling);</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(isLeft &amp;&amp; !isBlack(sibling.getRight()))&#123;<span class="comment">//case 4</span></div><div class="line">                sibling.setRed(parent.isRed());</div><div class="line">                parent.makeBlack();</div><div class="line">                sibling.getRight().makeBlack();</div><div class="line">                rotateLeft(parent);</div><div class="line">                cur=getRoot();</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!isLeft &amp;&amp; !isBlack(sibling.getLeft()))&#123;</div><div class="line">                sibling.setRed(parent.isRed());</div><div class="line">                parent.makeBlack();</div><div class="line">                sibling.getLeft().makeBlack();</div><div class="line">                rotateRight(parent);</div><div class="line">                cur=getRoot();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(isRed)&#123;</div><div class="line">            cur.makeBlack();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(getRoot()!=<span class="keyword">null</span>)&#123;</div><div class="line">            getRoot().setRed(<span class="keyword">false</span>);</div><div class="line">            getRoot().setParent(<span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="comment">//get sibling node</span></div><div class="line">    <span class="function"><span class="keyword">private</span> RBTreeNode&lt;T&gt; <span class="title">getSibling</span><span class="params">(RBTreeNode&lt;T&gt; node,RBTreeNode&lt;T&gt; parent)</span></span>&#123;</div><div class="line">        parent = node==<span class="keyword">null</span> ? parent : node.getParent();</div><div class="line">        <span class="keyword">if</span>(node==<span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">return</span> parent.getLeft()==<span class="keyword">null</span> ? parent.getRight() : parent.getLeft();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(node==parent.getLeft())&#123;</div><div class="line">            <span class="keyword">return</span> parent.getRight();</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">return</span> parent.getLeft();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBlack</span><span class="params">(RBTreeNode&lt;T&gt; node)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> node==<span class="keyword">null</span> || node.isBlack();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isRoot</span><span class="params">(RBTreeNode&lt;T&gt; node)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> root.getLeft() == node &amp;&amp; node.getParent()==<span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * find the successor node</div><div class="line">     * <span class="doctag">@param</span> node current node's right node</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> RBTreeNode&lt;T&gt; <span class="title">removeMin</span><span class="params">(RBTreeNode&lt;T&gt; node)</span></span>&#123;</div><div class="line">        <span class="comment">//find the min node</span></div><div class="line">        RBTreeNode&lt;T&gt; parent = node;</div><div class="line">        <span class="keyword">while</span>(node!=<span class="keyword">null</span> &amp;&amp; node.getLeft()!=<span class="keyword">null</span>)&#123;</div><div class="line">            parent = node;</div><div class="line">            node = node.getLeft();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//remove min node</span></div><div class="line">        <span class="keyword">if</span>(parent==node)&#123;</div><div class="line">            <span class="keyword">return</span> node;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        parent.setLeft(node.getRight());</div><div class="line">        setParent(node.getRight(),parent);</div><div class="line"></div><div class="line">        <span class="comment">//don't remove right pointer,it is used for fixed color balance</span></div><div class="line">        <span class="comment">//node.setRight(null);</span></div><div class="line">        <span class="keyword">return</span> node;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> T <span class="title">addNode</span><span class="params">(RBTreeNode&lt;T&gt; node)</span></span>&#123;</div><div class="line">        node.setLeft(<span class="keyword">null</span>);</div><div class="line">        node.setRight(<span class="keyword">null</span>);</div><div class="line">        node.setRed(<span class="keyword">true</span>);</div><div class="line">        setParent(node,<span class="keyword">null</span>);</div><div class="line">        <span class="keyword">if</span>(root.getLeft()==<span class="keyword">null</span>)&#123;</div><div class="line">            root.setLeft(node);</div><div class="line">            <span class="comment">//root node is black</span></div><div class="line">            node.setRed(<span class="keyword">false</span>);</div><div class="line">            size.incrementAndGet();</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            RBTreeNode&lt;T&gt; x = findParentNode(node);</div><div class="line">            <span class="keyword">int</span> cmp = x.getValue().compareTo(node.getValue());</div><div class="line"></div><div class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.overrideMode &amp;&amp; cmp==<span class="number">0</span>)&#123;</div><div class="line">                T v = x.getValue();</div><div class="line">                x.setValue(node.getValue());</div><div class="line">                <span class="keyword">return</span> v;</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(cmp==<span class="number">0</span>)&#123;</div><div class="line">                <span class="comment">//value exists,ignore this node</span></div><div class="line">                <span class="keyword">return</span> x.getValue();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            setParent(node,x);</div><div class="line"></div><div class="line">            <span class="keyword">if</span>(cmp&gt;<span class="number">0</span>)&#123;</div><div class="line">                x.setLeft(node);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                x.setRight(node);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            fixInsert(node);</div><div class="line">            size.incrementAndGet();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * find the parent node to hold node x,if parent value equals x.value return parent.</div><div class="line">     * <span class="doctag">@param</span> x</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> RBTreeNode&lt;T&gt; <span class="title">findParentNode</span><span class="params">(RBTreeNode&lt;T&gt; x)</span></span>&#123;</div><div class="line">        RBTreeNode&lt;T&gt; dataRoot = getRoot();</div><div class="line">        RBTreeNode&lt;T&gt; child = dataRoot;</div><div class="line"></div><div class="line">        <span class="keyword">while</span>(child!=<span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">int</span> cmp = child.getValue().compareTo(x.getValue());</div><div class="line">            <span class="keyword">if</span>(cmp==<span class="number">0</span>)&#123;</div><div class="line">                <span class="keyword">return</span> child;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(cmp&gt;<span class="number">0</span>)&#123;</div><div class="line">                dataRoot = child;</div><div class="line">                child = child.getLeft();</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(cmp&lt;<span class="number">0</span>)&#123;</div><div class="line">                dataRoot = child;</div><div class="line">                child = child.getRight();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> dataRoot;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * red black tree insert fix.</div><div class="line">     * <span class="doctag">@param</span> x</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fixInsert</span><span class="params">(RBTreeNode&lt;T&gt; x)</span></span>&#123;</div><div class="line">        RBTreeNode&lt;T&gt; parent = x.getParent();</div><div class="line"></div><div class="line">        <span class="keyword">while</span>(parent!=<span class="keyword">null</span> &amp;&amp; parent.isRed())&#123;</div><div class="line">            RBTreeNode&lt;T&gt; uncle = getUncle(x);</div><div class="line">            <span class="keyword">if</span>(uncle==<span class="keyword">null</span>)&#123;<span class="comment">//need to rotate</span></div><div class="line">                RBTreeNode&lt;T&gt; ancestor = parent.getParent();</div><div class="line">                <span class="comment">//ancestor is not null due to before before add,tree color is balance</span></div><div class="line">                <span class="keyword">if</span>(parent == ancestor.getLeft())&#123;</div><div class="line">                    <span class="keyword">boolean</span> isRight = x == parent.getRight();</div><div class="line">                    <span class="keyword">if</span>(isRight)&#123;</div><div class="line">                        rotateLeft(parent);</div><div class="line">                    &#125;</div><div class="line">                    rotateRight(ancestor);</div><div class="line"></div><div class="line">                    <span class="keyword">if</span>(isRight)&#123;</div><div class="line">                        x.setRed(<span class="keyword">false</span>);</div><div class="line">                        parent=<span class="keyword">null</span>;<span class="comment">//end loop</span></div><div class="line">                    &#125;<span class="keyword">else</span>&#123;</div><div class="line">                        parent.setRed(<span class="keyword">false</span>);</div><div class="line">                    &#125;</div><div class="line">                    ancestor.setRed(<span class="keyword">true</span>);</div><div class="line">                &#125;<span class="keyword">else</span>&#123;</div><div class="line">                    <span class="keyword">boolean</span> isLeft = x == parent.getLeft();</div><div class="line">                    <span class="keyword">if</span>(isLeft)&#123;</div><div class="line">                        rotateRight(parent);</div><div class="line">                    &#125;</div><div class="line">                    rotateLeft(ancestor);</div><div class="line"></div><div class="line">                    <span class="keyword">if</span>(isLeft)&#123;</div><div class="line">                        x.setRed(<span class="keyword">false</span>);</div><div class="line">                        parent=<span class="keyword">null</span>;<span class="comment">//end loop</span></div><div class="line">                    &#125;<span class="keyword">else</span>&#123;</div><div class="line">                        parent.setRed(<span class="keyword">false</span>);</div><div class="line">                    &#125;</div><div class="line">                    ancestor.setRed(<span class="keyword">true</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;<span class="keyword">else</span>&#123;<span class="comment">//uncle is red</span></div><div class="line">                parent.setRed(<span class="keyword">false</span>);</div><div class="line">                uncle.setRed(<span class="keyword">false</span>);</div><div class="line">                parent.getParent().setRed(<span class="keyword">true</span>);</div><div class="line">                x=parent.getParent();</div><div class="line">                parent = x.getParent();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        getRoot().makeBlack();</div><div class="line">        getRoot().setParent(<span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * get uncle node</div><div class="line">     * <span class="doctag">@param</span> node</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> RBTreeNode&lt;T&gt; <span class="title">getUncle</span><span class="params">(RBTreeNode&lt;T&gt; node)</span></span>&#123;</div><div class="line">        RBTreeNode&lt;T&gt; parent = node.getParent();</div><div class="line">        RBTreeNode&lt;T&gt; ancestor = parent.getParent();</div><div class="line">        <span class="keyword">if</span>(ancestor==<span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(parent == ancestor.getLeft())&#123;</div><div class="line">            <span class="keyword">return</span> ancestor.getRight();</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">return</span> ancestor.getLeft();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rotateLeft</span><span class="params">(RBTreeNode&lt;T&gt; node)</span></span>&#123;</div><div class="line">        RBTreeNode&lt;T&gt; right = node.getRight();</div><div class="line">        <span class="keyword">if</span>(right==<span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> java.lang.IllegalStateException(<span class="string">"right node is null"</span>);</div><div class="line">        &#125;</div><div class="line">        RBTreeNode&lt;T&gt; parent = node.getParent();</div><div class="line">        node.setRight(right.getLeft());</div><div class="line">        setParent(right.getLeft(),node);</div><div class="line"></div><div class="line">        right.setLeft(node);</div><div class="line">        setParent(node,right);</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(parent==<span class="keyword">null</span>)&#123;<span class="comment">//node pointer to root</span></div><div class="line">            <span class="comment">//right  raise to root node</span></div><div class="line">            root.setLeft(right);</div><div class="line">            setParent(right,<span class="keyword">null</span>);</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">if</span>(parent.getLeft()==node)&#123;</div><div class="line">                parent.setLeft(right);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                parent.setRight(right);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//right.setParent(parent);</span></div><div class="line">            setParent(right,parent);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rotateRight</span><span class="params">(RBTreeNode&lt;T&gt; node)</span></span>&#123;</div><div class="line">        RBTreeNode&lt;T&gt; left = node.getLeft();</div><div class="line">        <span class="keyword">if</span>(left==<span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> java.lang.IllegalStateException(<span class="string">"left node is null"</span>);</div><div class="line">        &#125;</div><div class="line">        RBTreeNode&lt;T&gt; parent = node.getParent();</div><div class="line">        node.setLeft(left.getRight());</div><div class="line">        setParent(left.getRight(),node);</div><div class="line"></div><div class="line">        left.setRight(node);</div><div class="line">        setParent(node,left);</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(parent==<span class="keyword">null</span>)&#123;</div><div class="line">            root.setLeft(left);</div><div class="line">            setParent(left,<span class="keyword">null</span>);</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">if</span>(parent.getLeft()==node)&#123;</div><div class="line">                parent.setLeft(left);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                parent.setRight(left);</div><div class="line">            &#125;</div><div class="line">            setParent(left,parent);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setParent</span><span class="params">(RBTreeNode&lt;T&gt; node,RBTreeNode&lt;T&gt; parent)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(node!=<span class="keyword">null</span>)&#123;</div><div class="line">            node.setParent(parent);</div><div class="line">            <span class="keyword">if</span>(parent==root)&#123;</div><div class="line">                node.setParent(<span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * debug method,it used print the given node and its children nodes,</div><div class="line">     * every layer output in one line</div><div class="line">     * <span class="doctag">@param</span> root</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printTree</span><span class="params">(RBTreeNode&lt;T&gt; root)</span></span>&#123;</div><div class="line">        java.util.LinkedList&lt;RBTreeNode&lt;T&gt;&gt; queue =<span class="keyword">new</span> java.util.LinkedList&lt;RBTreeNode&lt;T&gt;&gt;();</div><div class="line">        java.util.LinkedList&lt;RBTreeNode&lt;T&gt;&gt; queue2 =<span class="keyword">new</span> java.util.LinkedList&lt;RBTreeNode&lt;T&gt;&gt;();</div><div class="line">        <span class="keyword">if</span>(root==<span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">return</span> ;</div><div class="line">        &#125;</div><div class="line">        queue.add(root);</div><div class="line">        <span class="keyword">boolean</span> firstQueue = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">while</span>(!queue.isEmpty() || !queue2.isEmpty())&#123;</div><div class="line">            java.util.LinkedList&lt;RBTreeNode&lt;T&gt;&gt; q = firstQueue ? queue : queue2;</div><div class="line">            RBTreeNode&lt;T&gt; n = q.poll();</div><div class="line"></div><div class="line">            <span class="keyword">if</span>(n!=<span class="keyword">null</span>)&#123;</div><div class="line">                String pos = n.getParent()==<span class="keyword">null</span> ? <span class="string">""</span> : ( n == n.getParent().getLeft() </div><div class="line">                                                                        ? <span class="string">" LE"</span> : <span class="string">" RI"</span>);</div><div class="line">                String pstr = n.getParent()==<span class="keyword">null</span> ? <span class="string">""</span> : n.getParent().toString();</div><div class="line">                String cstr = n.isRed()?<span class="string">"R"</span>:<span class="string">"B"</span>;</div><div class="line">                cstr = n.getParent()==<span class="keyword">null</span> ? cstr : cstr+<span class="string">" "</span>;</div><div class="line">                System.out.print(n+<span class="string">"("</span>+(cstr)+pstr+(pos)+<span class="string">")"</span>+<span class="string">"\t"</span>);</div><div class="line">                <span class="keyword">if</span>(n.getLeft()!=<span class="keyword">null</span>)&#123;</div><div class="line">                    (firstQueue ? queue2 : queue).add(n.getLeft());</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span>(n.getRight()!=<span class="keyword">null</span>)&#123;</div><div class="line">                    (firstQueue ? queue2 : queue).add(n.getRight());</div><div class="line">                &#125;</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                System.out.println();</div><div class="line">                firstQueue = !firstQueue;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        RBTree&lt;String&gt; bst = <span class="keyword">new</span> RBTree&lt;String&gt;();</div><div class="line">        bst.addNode(<span class="string">"d"</span>);</div><div class="line">        bst.addNode(<span class="string">"d"</span>);</div><div class="line">        bst.addNode(<span class="string">"c"</span>);</div><div class="line">        bst.addNode(<span class="string">"c"</span>);</div><div class="line">        bst.addNode(<span class="string">"b"</span>);</div><div class="line">        bst.addNode(<span class="string">"f"</span>);</div><div class="line"></div><div class="line">        bst.addNode(<span class="string">"a"</span>);</div><div class="line">        bst.addNode(<span class="string">"e"</span>);</div><div class="line"></div><div class="line">        bst.addNode(<span class="string">"g"</span>);</div><div class="line">        bst.addNode(<span class="string">"h"</span>);</div><div class="line"></div><div class="line"></div><div class="line">        bst.remove(<span class="string">"c"</span>);</div><div class="line"></div><div class="line">        bst.printTree(bst.getRoot());</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºæ ¼å¼å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">d(B)</div><div class="line">b(B d LE) g(R d RI)</div><div class="line">a(R b LE) e(B g LE) h(B g RI)</div><div class="line">f(R e RI)</div></pre></td></tr></table></figure>
<p>æ‹¬å·å·¦è¾¹è¡¨ç¤ºå…ƒç´ çš„å†…å®¹ã€‚æ‹¬å·å†…çš„ç¬¬ä¸€ä¸ªå…ƒç´ è¡¨ç¤ºé¢œè‰²ï¼ŒBè¡¨ç¤ºblackï¼ŒRè¡¨ç¤ºredï¼›ç¬¬äºŒä¸ªå…ƒç´ è¡¨ç¤ºçˆ¶å…ƒç´ çš„å€¼ï¼›ç¬¬ä¸‰ä¸ªå…ƒç´ è¡¨ç¤ºå·¦å³ï¼ŒLEè¡¨ç¤ºåœ¨çˆ¶å…ƒç´ çš„å·¦è¾¹ã€‚RIè¡¨ç¤ºåœ¨çˆ¶å…ƒç´ çš„å³è¾¹ã€‚</p>
<p>ç¬¬ä¸€ä¸ªå…ƒç´ dæ˜¯rootèŠ‚ç‚¹ï¼Œç”±äºå®ƒæ²¡æœ‰çˆ¶èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ‹¬å·å†…åªæœ‰ä¸€ä¸ªå…ƒç´ ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä½œä¸ºå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘é‡Œé¢ä¼—å¤šçš„å®ç°ä¹‹ä¸€ï¼Œçº¢é»‘æ ‘æ— ç–‘æ˜¯æœ€ç®€æ´ã€å®ç°æœ€ä¸ºç®€å•çš„ã€‚çº¢é»‘æ ‘é€šè¿‡å¼•å…¥é¢œè‰²çš„æ¦‚å¿µï¼Œé€šè¿‡é¢œè‰²è¿™ä¸ªçº¦æŸæ¡ä»¶çš„ä½¿ç”¨æ¥ä¿æŒæ ‘çš„é«˜åº¦å¹³è¡¡ã€‚ä½œä¸ºå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ—‹è½¬æ˜¯ä¸€ä¸ªå¿…ä¸å¯å°‘çš„æ“ä½œã€‚é€šè¿‡æ—‹è½¬å¯ä»¥é™ä½æ ‘çš„é«˜åº¦ï¼Œåœ¨çº¢é»‘æ ‘é‡Œé¢è¿˜å¯ä»¥è½¬æ¢é¢œè‰²ã€‚</p>
<p>çº¢é»‘æ ‘é‡Œé¢çš„æ’å…¥å’Œåˆ é™¤çš„æ“ä½œæ¯”è¾ƒéš¾ç†è§£ï¼Œè¿™æ—¶è¦æ³¨æ„è®°ä½ä¸€ç‚¹ï¼šæ“ä½œä¹‹å‰çº¢é»‘æ ‘æ˜¯å¹³è¡¡çš„ï¼Œé¢œè‰²æ˜¯ç¬¦åˆå®šä¹‰çš„ã€‚åœ¨æ“ä½œçš„æ—¶å€™å°±éœ€è¦å‘å…„å¼ŸèŠ‚ç‚¹ã€çˆ¶èŠ‚ç‚¹ã€ä¾„å­èŠ‚ç‚¹å€Ÿè°ƒå’Œäº’æ¢é¢œè‰²ï¼Œè¦è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œå°±éœ€è¦ä¸æ–­çš„è¿›è¡Œæ—‹è½¬ã€‚æ‰€ä»¥çº¢é»‘æ ‘çš„æ’å…¥åˆ é™¤æ“ä½œéœ€è¦ä¸åœçš„æ—‹è½¬ï¼Œä¸€æ—¦å€Ÿè°ƒäº†åˆ«çš„èŠ‚ç‚¹ï¼Œåˆ é™¤å’Œæ’å…¥çš„èŠ‚ç‚¹å°±ä¼šè¾¾åˆ°å±€éƒ¨çš„å¹³è¡¡ï¼ˆå±€éƒ¨ç¬¦åˆçº¢é»‘æ ‘çš„å®šä¹‰ï¼‰ï¼Œä½†æ˜¯è¢«å€Ÿè°ƒçš„èŠ‚ç‚¹å°±ä¸ä¼šå¹³è¡¡äº†ï¼Œè¿™æ—¶å°±éœ€è¦ä»¥è¢«å€Ÿè°ƒçš„èŠ‚ç‚¹ä¸ºèµ·ç‚¹ç»§ç»­è¿›è¡Œè°ƒæ•´ï¼Œç›´åˆ°æ•´æ£µæ ‘éƒ½æ˜¯å¹³è¡¡çš„ã€‚åœ¨æ•´ä¸ªä¿®å¤çš„è¿‡ç¨‹ä¸­ï¼Œæ’å…¥å…·ä½“çš„åˆ†ä¸º3ç§æƒ…å†µï¼Œåˆ é™¤åˆ†ä¸º4ç§æƒ…å†µã€‚</p>
<p>æ•´ä¸ªçº¢é»‘æ ‘çš„æŸ¥æ‰¾ï¼Œæ’å…¥å’Œåˆ é™¤éƒ½æ˜¯O(logN)çš„ï¼ŒåŸå› å°±æ˜¯æ•´ä¸ªçº¢é»‘æ ‘çš„é«˜åº¦æ˜¯logNï¼ŒæŸ¥æ‰¾ä»æ ¹åˆ°å¶ï¼Œèµ°è¿‡çš„è·¯å¾„æ˜¯æ ‘çš„é«˜åº¦ï¼Œåˆ é™¤å’Œæ’å…¥æ“ä½œæ˜¯ä»å¶åˆ°æ ¹çš„ï¼Œæ‰€ä»¥ç»è¿‡çš„è·¯å¾„éƒ½æ˜¯logNã€‚</p>
<p><a href="http://tech.meituan.com/redblack-tree.html" target="_blank" rel="external">è½¬è½½</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[RedisæŒä¹…åŒ–]]></title>
      <url>http://zsr.github.io/2016/12/11/Redis%E6%8C%81%E4%B9%85%E5%8C%96/</url>
      <content type="html"><![CDATA[<h1 id="Redisçš„æŒä¹…åŒ–"><a href="#Redisçš„æŒä¹…åŒ–" class="headerlink" title="Redisçš„æŒä¹…åŒ–"></a>Redisçš„æŒä¹…åŒ–</h1><p>Redisæœ‰ä¸¤ç§æŒä¹…åŒ–çš„æ–¹å¼ï¼šå¿«ç…§ï¼ˆRDBæ–‡ä»¶ï¼‰å’Œè¿½åŠ å¼æ–‡ä»¶ï¼ˆAOFæ–‡ä»¶ï¼‰ï¼š</p>
<ul>
<li>RDBæŒä¹…åŒ–æ–¹å¼ä¼šåœ¨ä¸€ä¸ªç‰¹å®šçš„é—´éš”ä¿å­˜é‚£ä¸ªæ—¶é—´ç‚¹çš„ä¸€ä¸ªæ•°æ®å¿«ç…§ã€‚</li>
<li>AOFæŒä¹…åŒ–æ–¹å¼åˆ™ä¼šè®°å½•æ¯ä¸€ä¸ªæœåŠ¡å™¨æ”¶åˆ°çš„å†™æ“ä½œã€‚åœ¨æœåŠ¡å¯åŠ¨æ—¶ï¼Œè¿™äº›è®°å½•çš„æ“ä½œä¼šé€æ¡æ‰§è¡Œä»è€Œé‡å»ºå‡ºåŸæ¥çš„æ•°æ®ã€‚å†™æ“ä½œå‘½ä»¤è®°å½•çš„æ ¼å¼è·ŸRedisåè®®ä¸€è‡´ï¼Œä»¥è¿½åŠ çš„æ–¹å¼è¿›è¡Œä¿å­˜ã€‚</li>
<li>Redisçš„æŒä¹…åŒ–æ˜¯å¯ä»¥ç¦ç”¨çš„ï¼Œå°±æ˜¯è¯´ä½ å¯ä»¥è®©æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸåªå­˜åœ¨äºæœåŠ¡å™¨çš„è¿è¡Œæ—¶é—´é‡Œã€‚</li>
<li>ä¸¤ç§æ–¹å¼çš„æŒä¹…åŒ–æ˜¯å¯ä»¥åŒæ—¶å­˜åœ¨çš„ï¼Œä½†æ˜¯å½“Redisé‡å¯æ—¶ï¼ŒAOFæ–‡ä»¶ä¼šè¢«ä¼˜å…ˆç”¨äºé‡å»ºæ•°æ®ã€‚</li>
</ul>
<h3 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h3><h4 id="å·¥ä½œåŸç†"><a href="#å·¥ä½œåŸç†" class="headerlink" title="å·¥ä½œåŸç†"></a>å·¥ä½œåŸç†</h4><ul>
<li>Redisè°ƒç”¨fork()ï¼Œäº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹ã€‚</li>
<li>å­è¿›ç¨‹æŠŠæ•°æ®å†™åˆ°ä¸€ä¸ªä¸´æ—¶çš„RDBæ–‡ä»¶ã€‚</li>
<li>å½“å­è¿›ç¨‹å†™å®Œæ–°çš„RDBæ–‡ä»¶åï¼ŒæŠŠæ—§çš„RDBæ–‡ä»¶æ›¿æ¢æ‰ã€‚</li>
</ul>
<h4 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><ul>
<li>RDBæ–‡ä»¶æ˜¯ä¸€ä¸ªå¾ˆç®€æ´çš„å•æ–‡ä»¶ï¼Œå®ƒä¿å­˜äº†æŸä¸ªæ—¶é—´ç‚¹çš„Redisæ•°æ®ï¼Œå¾ˆé€‚åˆç”¨äºåšå¤‡ä»½ã€‚ä½ å¯ä»¥è®¾å®šä¸€ä¸ªæ—¶é—´ç‚¹å¯¹RDBæ–‡ä»¶è¿›è¡Œå½’æ¡£ï¼Œè¿™æ ·å°±èƒ½åœ¨éœ€è¦çš„æ—¶å€™å¾ˆè½»æ˜“çš„æŠŠæ•°æ®æ¢å¤åˆ°ä¸åŒçš„ç‰ˆæœ¬ã€‚</li>
<li>åŸºäºä¸Šé¢æ‰€æè¿°çš„ç‰¹æ€§ï¼ŒRDBå¾ˆé€‚åˆç”¨äºç¾å¤‡ã€‚å•æ–‡ä»¶å¾ˆæ–¹ä¾¿å°±èƒ½ä¼ è¾“åˆ°è¿œç¨‹çš„æœåŠ¡å™¨ä¸Šã€‚</li>
<li>RDBçš„æ€§èƒ½å¾ˆå¥½ï¼Œéœ€è¦è¿›è¡ŒæŒä¹…åŒ–æ—¶ï¼Œä¸»è¿›ç¨‹ä¼šforkä¸€ä¸ªå­è¿›ç¨‹å‡ºæ¥ï¼Œç„¶åæŠŠæŒä¹…åŒ–çš„å·¥ä½œäº¤ç»™å­è¿›ç¨‹ï¼Œè‡ªå·±ä¸ä¼šæœ‰ç›¸å…³çš„I/Oæ“ä½œã€‚</li>
<li>æ¯”èµ·AOFï¼Œåœ¨æ•°æ®é‡æ¯”è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼ŒRDBçš„å¯åŠ¨é€Ÿåº¦æ›´å¿«ã€‚</li>
</ul>
<h4 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><ul>
<li>RDBå®¹æ˜“é€ æˆæ•°æ®çš„ä¸¢å¤±ã€‚å‡è®¾æ¯5åˆ†é’Ÿä¿å­˜ä¸€æ¬¡å¿«ç…§ï¼Œå¦‚æœRediså› ä¸ºæŸäº›åŸå› ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œé‚£ä¹ˆä»ä¸Šæ¬¡äº§ç”Ÿå¿«ç…§åˆ°Rediså‡ºç°é—®é¢˜è¿™æ®µæ—¶é—´çš„æ•°æ®å°±ä¼šä¸¢å¤±äº†ã€‚</li>
<li>RDBä½¿ç”¨fork()äº§ç”Ÿå­è¿›ç¨‹è¿›è¡Œæ•°æ®çš„æŒä¹…åŒ–ï¼Œå¦‚æœæ•°æ®æ¯”è¾ƒå¤§çš„è¯å¯èƒ½å°±ä¼šèŠ±è´¹ç‚¹æ—¶é—´ï¼Œé€ æˆRedisåœæ­¢æœåŠ¡å‡ æ¯«ç§’ã€‚å¦‚æœæ•°æ®é‡å¾ˆå¤§ä¸”CPUæ€§èƒ½ä¸æ˜¯å¾ˆå¥½çš„æ—¶å€™ï¼Œåœæ­¢æœåŠ¡çš„æ—¶é—´ç”šè‡³ä¼šåˆ°1ç§’ã€‚</li>
</ul>
<h4 id="æ–‡ä»¶è·¯å¾„å’Œåç§°"><a href="#æ–‡ä»¶è·¯å¾„å’Œåç§°" class="headerlink" title="æ–‡ä»¶è·¯å¾„å’Œåç§°"></a>æ–‡ä»¶è·¯å¾„å’Œåç§°</h4><p>é»˜è®¤Redisä¼šæŠŠå¿«ç…§æ–‡ä»¶å­˜å‚¨ä¸ºå½“å‰ç›®å½•ä¸‹ä¸€ä¸ªåä¸ºdump.rdbçš„æ–‡ä»¶ã€‚è¦ä¿®æ”¹æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„å’Œåç§°ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶redis.confå®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">RDBæ–‡ä»¶åï¼Œé»˜è®¤ä¸ºdump.rdbã€‚</div><div class="line">dbfilename dump.rdb</div><div class="line"></div><div class="line">æ–‡ä»¶å­˜æ”¾çš„ç›®å½•ï¼ŒAOFæ–‡ä»¶åŒæ ·å­˜æ”¾åœ¨æ­¤ç›®å½•ä¸‹ã€‚é»˜è®¤ä¸ºå½“å‰å·¥ä½œç›®å½•ã€‚</div><div class="line">dir ./</div></pre></td></tr></table></figure>
<h4 id="ä¿å­˜ç‚¹ï¼ˆRDBçš„å¯ç”¨å’Œç¦ç”¨ï¼‰"><a href="#ä¿å­˜ç‚¹ï¼ˆRDBçš„å¯ç”¨å’Œç¦ç”¨ï¼‰" class="headerlink" title="ä¿å­˜ç‚¹ï¼ˆRDBçš„å¯ç”¨å’Œç¦ç”¨ï¼‰"></a>ä¿å­˜ç‚¹ï¼ˆRDBçš„å¯ç”¨å’Œç¦ç”¨ï¼‰</h4><p>å¯ä»¥é…ç½®ä¿å­˜ç‚¹ï¼Œä½¿Rediså¦‚æœåœ¨æ¯Nç§’åæ•°æ®å‘ç”Ÿäº†Mæ¬¡æ”¹å˜å°±ä¿å­˜å¿«ç…§æ–‡ä»¶ã€‚ä¾‹å¦‚ä¸‹é¢è¿™ä¸ªä¿å­˜ç‚¹é…ç½®è¡¨ç¤ºæ¯60ç§’ï¼Œå¦‚æœæ•°æ®å‘ç”Ÿäº†1000æ¬¡ä»¥ä¸Šçš„å˜åŠ¨ï¼ŒRediså°±ä¼šè‡ªåŠ¨ä¿å­˜å¿«ç…§æ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">save 60 1000</div></pre></td></tr></table></figure>
<p>ä¿å­˜ç‚¹å¯ä»¥è®¾ç½®å¤šä¸ªï¼ŒRedisçš„é…ç½®æ–‡ä»¶å°±é»˜è®¤è®¾ç½®äº†3ä¸ªä¿å­˜ç‚¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># æ ¼å¼ä¸ºï¼šsave &lt;seconds&gt; &lt;changes&gt;</div><div class="line"># å¯ä»¥è®¾ç½®å¤šä¸ªã€‚</div><div class="line">save 900 1 #900ç§’åè‡³å°‘1ä¸ªkeyæœ‰å˜åŠ¨</div><div class="line">save 300 10 #300ç§’åè‡³å°‘10ä¸ªkeyæœ‰å˜åŠ¨</div><div class="line">save 60 10000 #60ç§’åè‡³å°‘10000ä¸ªkeyæœ‰å˜åŠ¨</div></pre></td></tr></table></figure>
<p>å¦‚æœæƒ³ç¦ç”¨å¿«ç…§ä¿å­˜çš„åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡æ³¨é‡Šæ‰æ‰€æœ‰â€saveâ€é…ç½®è¾¾åˆ°ï¼Œæˆ–è€…åœ¨æœ€åä¸€æ¡â€saveâ€é…ç½®åæ·»åŠ å¦‚ä¸‹çš„é…ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">save &quot;&quot;</div></pre></td></tr></table></figure>
<h4 id="é”™è¯¯å¤„ç†"><a href="#é”™è¯¯å¤„ç†" class="headerlink" title="é”™è¯¯å¤„ç†"></a>é”™è¯¯å¤„ç†</h4><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœRedisåœ¨åå°ç”Ÿæˆå¿«ç…§çš„æ—¶å€™å¤±è´¥ï¼Œé‚£ä¹ˆå°±ä¼šåœæ­¢æ¥æ”¶æ•°æ®ï¼Œç›®çš„æ˜¯è®©ç”¨æˆ·èƒ½çŸ¥é“æ•°æ®æ²¡æœ‰æŒä¹…åŒ–æˆåŠŸã€‚ä½†æ˜¯å¦‚æœä½ æœ‰å…¶ä»–çš„æ–¹å¼å¯ä»¥ç›‘æ§åˆ°RedisåŠå…¶æŒä¹…åŒ–çš„çŠ¶æ€ï¼Œé‚£ä¹ˆå¯ä»¥æŠŠè¿™ä¸ªåŠŸèƒ½ç¦æ­¢æ‰ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">stop-writes-on-bgsave-error yes</div></pre></td></tr></table></figure>
<h4 id="æ•°æ®å‹ç¼©"><a href="#æ•°æ®å‹ç¼©" class="headerlink" title="æ•°æ®å‹ç¼©"></a>æ•°æ®å‹ç¼©</h4><p>é»˜è®¤Redisä¼šé‡‡ç”¨LZFå¯¹æ•°æ®è¿›è¡Œå‹ç¼©ã€‚å¦‚æœä½ æƒ³èŠ‚çœç‚¹CPUçš„æ€§èƒ½ï¼Œä½ å¯ä»¥æŠŠå‹ç¼©åŠŸèƒ½ç¦ç”¨æ‰ï¼Œä½†æ˜¯æ•°æ®é›†å°±ä¼šæ¯”æ²¡å‹ç¼©çš„æ—¶å€™è¦å¤§ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rdbcompression yes</div></pre></td></tr></table></figure>
<h4 id="æ•°æ®æ ¡éªŒ"><a href="#æ•°æ®æ ¡éªŒ" class="headerlink" title="æ•°æ®æ ¡éªŒ"></a>æ•°æ®æ ¡éªŒ</h4><p>ä»ç‰ˆæœ¬5çš„RDBçš„å¼€å§‹ï¼Œä¸€ä¸ªCRC64çš„æ ¡éªŒç ä¼šæ”¾åœ¨æ–‡ä»¶çš„æœ«å°¾ã€‚è¿™æ ·æ›´èƒ½ä¿è¯æ–‡ä»¶çš„å®Œæ•´æ€§ï¼Œä½†æ˜¯åœ¨ä¿å­˜æˆ–è€…åŠ è½½æ–‡ä»¶æ—¶ä¼šæŸå¤±ä¸€å®šçš„æ€§èƒ½ï¼ˆå¤§æ¦‚10%ï¼‰ã€‚å¦‚æœæƒ³è¿½æ±‚æ›´é«˜çš„æ€§èƒ½ï¼Œå¯ä»¥æŠŠå®ƒç¦ç”¨æ‰ï¼Œè¿™æ ·æ–‡ä»¶åœ¨å†™å…¥æ ¡éªŒç æ—¶ä¼šç”¨0æ›¿ä»£ï¼ŒåŠ è½½çš„æ—¶å€™çœ‹åˆ°0å°±ä¼šç›´æ¥è·³è¿‡æ ¡éªŒã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rdbchecksum yes</div></pre></td></tr></table></figure>
<h4 id="æ‰‹åŠ¨ç”Ÿæˆå¿«ç…§"><a href="#æ‰‹åŠ¨ç”Ÿæˆå¿«ç…§" class="headerlink" title="æ‰‹åŠ¨ç”Ÿæˆå¿«ç…§"></a>æ‰‹åŠ¨ç”Ÿæˆå¿«ç…§</h4><p>Redisæä¾›äº†ä¸¤ä¸ªå‘½ä»¤ç”¨äºæ‰‹åŠ¨ç”Ÿæˆå¿«ç…§:SAVE, BGSAVEã€‚</p>
<h5 id="SAVE"><a href="#SAVE" class="headerlink" title="SAVE"></a>SAVE</h5><p>SAVEå‘½ä»¤ä¼šä½¿ç”¨åŒæ­¥çš„æ–¹å¼ç”ŸæˆRDBå¿«ç…§æ–‡ä»¶ï¼Œè¿™æ„å‘³ç€åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šé˜»å¡æ‰€æœ‰å…¶ä»–å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚å› æ­¤ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨è¿™ä¸ªå‘½ä»¤ï¼Œé™¤éå› ä¸ºæŸç§åŸå› éœ€è¦å»é˜»æ­¢Redisä½¿ç”¨å­è¿›ç¨‹è¿›è¡Œåå°ç”Ÿæˆå¿«ç…§ï¼ˆä¾‹å¦‚è°ƒç”¨fork(2)å‡ºé”™ï¼‰ã€‚</p>
<h5 id="BGSAVE"><a href="#BGSAVE" class="headerlink" title="BGSAVE"></a>BGSAVE</h5><p>BGSAVEå‘½ä»¤ä½¿ç”¨åå°çš„æ–¹å¼ä¿å­˜RDBæ–‡ä»¶ï¼Œè°ƒç”¨æ­¤å‘½ä»¤åï¼Œä¼šç«‹åˆ»è¿”å›OKè¿”å›ç ã€‚Redisä¼šäº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹è¿›è¡Œå¤„ç†å¹¶ç«‹åˆ»æ¢å¤å¯¹å®¢æˆ·ç«¯çš„æœåŠ¡ã€‚åœ¨å®¢æˆ·ç«¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨LASTSAVEå‘½ä»¤æŸ¥çœ‹æ“ä½œæ˜¯å¦æˆåŠŸã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; BGSAVE</div><div class="line">Background saving started</div><div class="line">127.0.0.1:6379&gt; LASTSAVE</div><div class="line">(integer) 1433936394</div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼šé…ç½®æ–‡ä»¶é‡Œç¦ç”¨äº†å¿«ç…§ç”ŸæˆåŠŸèƒ½ä¸å½±å“SAVEå’ŒBGSAVEå‘½ä»¤çš„æ•ˆæœã€‚</strong></p>
<a id="more"></a>
<h3 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h3><p>å¿«ç…§å¹¶ä¸æ˜¯å¾ˆå¯é ã€‚å¦‚æœä½ çš„ç”µè„‘çªç„¶å®•æœºäº†ï¼Œæˆ–è€…ç”µæºæ–­äº†ï¼Œåˆæˆ–è€…ä¸å°å¿ƒæ€æ‰äº†è¿›ç¨‹ï¼Œé‚£ä¹ˆæœ€æ–°çš„æ•°æ®å°±ä¼šä¸¢å¤±ã€‚è€ŒAOFæ–‡ä»¶åˆ™æä¾›äº†ä¸€ç§æ›´ä¸ºå¯é çš„æŒä¹…åŒ–æ–¹å¼ã€‚æ¯å½“Redisæ¥å—åˆ°ä¼šä¿®æ”¹æ•°æ®é›†çš„å‘½ä»¤æ—¶ï¼Œå°±ä¼šæŠŠå‘½ä»¤è¿½åŠ åˆ°AOFæ–‡ä»¶é‡Œï¼Œå½“ä½ é‡å¯Redisæ—¶ï¼ŒAOFé‡Œçš„å‘½ä»¤ä¼šè¢«é‡æ–°æ‰§è¡Œä¸€æ¬¡ï¼Œé‡å»ºæ•°æ®ã€‚</p>
<h4 id="ä¼˜ç‚¹-1"><a href="#ä¼˜ç‚¹-1" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><ul>
<li>æ¯”RDBå¯é ã€‚ä½ å¯ä»¥åˆ¶å®šä¸åŒçš„fsyncç­–ç•¥ï¼šä¸è¿›è¡Œfsyncã€æ¯ç§’fsyncä¸€æ¬¡å’Œæ¯æ¬¡æŸ¥è¯¢è¿›è¡Œfsyncã€‚<strong>é»˜è®¤æ˜¯æ¯ç§’fsyncä¸€æ¬¡ã€‚</strong>è¿™æ„å‘³ç€ä½ æœ€å¤šä¸¢å¤±ä¸€ç§’é’Ÿçš„æ•°æ®ã€‚</li>
<li>AOFæ—¥å¿—æ–‡ä»¶æ˜¯ä¸€ä¸ªçº¯è¿½åŠ çš„æ–‡ä»¶ã€‚å°±ç®—æ˜¯é‡åˆ°çªç„¶åœç”µçš„æƒ…å†µï¼Œä¹Ÿä¸ä¼šå‡ºç°æ—¥å¿—çš„å®šä½æˆ–è€…æŸåé—®é¢˜ã€‚ç”šè‡³å¦‚æœå› ä¸ºæŸäº›åŸå› ï¼ˆä¾‹å¦‚ç£ç›˜æ»¡äº†ï¼‰å‘½ä»¤åªå†™äº†ä¸€åŠåˆ°æ—¥å¿—æ–‡ä»¶é‡Œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨redis-check-aofè¿™ä¸ªå·¥å…·å¾ˆç®€å•çš„è¿›è¡Œä¿®å¤ã€‚</li>
<li>å½“AOFæ–‡ä»¶å¤ªå¤§æ—¶ï¼ŒRedisä¼šè‡ªåŠ¨åœ¨åå°è¿›è¡Œé‡å†™ã€‚é‡å†™å¾ˆå®‰å…¨ï¼Œå› ä¸ºé‡å†™æ˜¯åœ¨ä¸€ä¸ªæ–°çš„æ–‡ä»¶ä¸Šè¿›è¡Œï¼ŒåŒæ—¶Redisä¼šç»§ç»­å¾€æ—§çš„æ–‡ä»¶è¿½åŠ æ•°æ®ã€‚æ–°æ–‡ä»¶ä¸Šä¼šå†™å…¥èƒ½é‡å»ºå½“å‰æ•°æ®é›†çš„æœ€å°æ“ä½œå‘½ä»¤çš„é›†åˆã€‚å½“æ–°æ–‡ä»¶é‡å†™å®Œï¼ŒRedisä¼šæŠŠæ–°æ—§æ–‡ä»¶è¿›è¡Œåˆ‡æ¢ï¼Œç„¶åå¼€å§‹æŠŠæ•°æ®å†™åˆ°æ–°æ–‡ä»¶ä¸Šã€‚</li>
<li>AOFæŠŠæ“ä½œå‘½ä»¤ä»¥ç®€å•æ˜“æ‡‚çš„æ ¼å¼ä¸€æ¡æ¥ä¸€æ¡çš„ä¿å­˜åœ¨æ–‡ä»¶é‡Œï¼Œå¾ˆå®¹æ˜“å¯¼å‡ºæ¥ç”¨äºæ¢å¤æ•°æ®ã€‚ä¾‹å¦‚æˆ‘ä»¬ä¸å°å¿ƒç”¨FLUSHALLå‘½ä»¤æŠŠæ‰€æœ‰æ•°æ®åˆ·æ‰äº†ï¼Œåªè¦æ–‡ä»¶æ²¡æœ‰è¢«é‡å†™ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæœåŠ¡åœæ‰ï¼ŒæŠŠæœ€åé‚£æ¡å‘½ä»¤åˆ æ‰ï¼Œç„¶åé‡å¯æœåŠ¡ï¼Œè¿™æ ·å°±èƒ½æŠŠè¢«åˆ·æ‰çš„æ•°æ®æ¢å¤å›æ¥ã€‚</li>
</ul>
<h4 id="ç¼ºç‚¹-1"><a href="#ç¼ºç‚¹-1" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><ul>
<li>åœ¨ç›¸åŒçš„æ•°æ®é›†ä¸‹ï¼ŒAOFæ–‡ä»¶çš„å¤§å°ä¸€èˆ¬ä¼šæ¯”RDBæ–‡ä»¶å¤§ã€‚</li>
<li>åœ¨æŸäº›fsyncç­–ç•¥ä¸‹ï¼ŒAOFçš„é€Ÿåº¦ä¼šæ¯”RDBæ…¢ã€‚é€šå¸¸fsyncè®¾ç½®ä¸ºæ¯ç§’ä¸€æ¬¡å°±èƒ½è·å¾—æ¯”è¾ƒé«˜çš„æ€§èƒ½ï¼Œè€Œåœ¨ç¦æ­¢fsyncçš„æƒ…å†µä¸‹é€Ÿåº¦å¯ä»¥è¾¾åˆ°RDBçš„æ°´å¹³ã€‚</li>
<li>åœ¨è¿‡å»æ›¾ç»å‘ç°ä¸€äº›å¾ˆç½•è§çš„BUGå¯¼è‡´ä½¿ç”¨AOFé‡å»ºçš„æ•°æ®è·ŸåŸæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</li>
</ul>
<h4 id="å¯ç”¨AOF"><a href="#å¯ç”¨AOF" class="headerlink" title="å¯ç”¨AOF"></a>å¯ç”¨AOF</h4><p>æŠŠé…ç½®é¡¹appendonlyè®¾ä¸ºyesï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">appendonly yes</div></pre></td></tr></table></figure>
<h4 id="æ–‡ä»¶è·¯å¾„å’Œåç§°-1"><a href="#æ–‡ä»¶è·¯å¾„å’Œåç§°-1" class="headerlink" title="æ–‡ä»¶è·¯å¾„å’Œåç§°"></a>æ–‡ä»¶è·¯å¾„å’Œåç§°</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">æ–‡ä»¶å­˜æ”¾ç›®å½•ï¼Œä¸RDBå…±ç”¨ã€‚é»˜è®¤ä¸ºå½“å‰å·¥ä½œç›®å½•ã€‚</div><div class="line">dir ./</div><div class="line"></div><div class="line">é»˜è®¤æ–‡ä»¶åä¸ºappendonly.aof</div><div class="line">appendfilename &quot;appendonly.aof&quot;</div></pre></td></tr></table></figure>
<h4 id="å¯é æ€§"><a href="#å¯é æ€§" class="headerlink" title="å¯é æ€§"></a>å¯é æ€§</h4><p>ä½ å¯ä»¥é…ç½®Redisè°ƒç”¨fsyncçš„é¢‘ç‡ï¼Œæœ‰ä¸‰ä¸ªé€‰é¡¹ï¼š</p>
<ul>
<li>æ¯å½“æœ‰æ–°å‘½ä»¤è¿½åŠ åˆ°AOFçš„æ—¶å€™è°ƒç”¨fsyncã€‚é€Ÿåº¦æœ€æ…¢ï¼Œä½†æ˜¯æœ€å®‰å…¨ã€‚</li>
<li>æ¯ç§’fsyncä¸€æ¬¡ã€‚é€Ÿåº¦å¿«ï¼ˆ2.4ç‰ˆæœ¬è·Ÿå¿«ç…§æ–¹å¼é€Ÿåº¦å·®ä¸å¤šï¼‰ï¼Œå®‰å…¨æ€§ä¸é”™ï¼ˆæœ€å¤šä¸¢å¤±1ç§’çš„æ•°æ®ï¼‰ã€‚</li>
<li>ä»ä¸fsyncï¼Œäº¤ç”±ç³»ç»Ÿå»å¤„ç†ã€‚è¿™ä¸ªæ–¹å¼é€Ÿåº¦æœ€å¿«ï¼Œä½†æ˜¯å®‰å…¨æ€§ä¸€èˆ¬ã€‚</li>
</ul>
<p><strong>æ¨èä½¿ç”¨æ¯ç§’fsyncä¸€æ¬¡çš„æ–¹å¼ï¼ˆé»˜è®¤çš„æ–¹å¼ï¼‰ï¼Œå› ä¸ºå®ƒé€Ÿåº¦å¿«ï¼Œå®‰å…¨æ€§ä¹Ÿä¸é”™ã€‚</strong>ç›¸å…³é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># appendfsync always</div><div class="line">appendfsync everysec</div><div class="line"># appendfsync no</div></pre></td></tr></table></figure>
<h4 id="æ—¥å¿—é‡å†™"><a href="#æ—¥å¿—é‡å†™" class="headerlink" title="æ—¥å¿—é‡å†™"></a>æ—¥å¿—é‡å†™</h4><p>éšç€å†™æ“ä½œçš„ä¸æ–­å¢åŠ ï¼ŒAOFæ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ã€‚ä¾‹å¦‚ä½ é€’å¢ä¸€ä¸ªè®¡æ•°å™¨100æ¬¡ï¼Œé‚£ä¹ˆæœ€ç»ˆç»“æœå°±æ˜¯æ•°æ®é›†é‡Œçš„è®¡æ•°å™¨çš„å€¼ä¸ºæœ€ç»ˆçš„é€’å¢ç»“æœï¼Œä½†æ˜¯AOFæ–‡ä»¶é‡Œå´ä¼šæŠŠè¿™100æ¬¡æ“ä½œå®Œæ•´çš„è®°å½•ä¸‹æ¥ã€‚è€Œäº‹å®ä¸Šè¦æ¢å¤è¿™ä¸ªè®°å½•ï¼Œåªéœ€è¦1ä¸ªå‘½ä»¤å°±è¡Œäº†ï¼Œä¹Ÿå°±æ˜¯è¯´AOFæ–‡ä»¶é‡Œé‚£100æ¡å‘½ä»¤å…¶å®å¯ä»¥ç²¾ç®€ä¸º1æ¡ã€‚æ‰€ä»¥Redisæ”¯æŒè¿™æ ·ä¸€ä¸ªåŠŸèƒ½ï¼šåœ¨ä¸ä¸­æ–­æœåŠ¡çš„æƒ…å†µä¸‹åœ¨åå°é‡å»ºAOFæ–‡ä»¶ã€‚</p>
<p>å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>
<ul>
<li>Redisè°ƒç”¨fork()ï¼Œäº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹ã€‚</li>
<li>å­è¿›ç¨‹æŠŠæ–°çš„AOFå†™åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶é‡Œã€‚</li>
<li>ä¸»è¿›ç¨‹æŒç»­æŠŠæ–°çš„å˜åŠ¨å†™åˆ°å†…å­˜é‡Œçš„bufferï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠè¿™äº›æ–°çš„å˜åŠ¨å†™åˆ°æ—§çš„AOFé‡Œï¼Œè¿™æ ·å³ä½¿é‡å†™å¤±è´¥ä¹Ÿèƒ½ä¿è¯æ•°æ®çš„å®‰å…¨ã€‚</li>
<li>å½“å­è¿›ç¨‹å®Œæˆæ–‡ä»¶çš„é‡å†™åï¼Œä¸»è¿›ç¨‹ä¼šè·å¾—ä¸€ä¸ªä¿¡å·ï¼Œç„¶åæŠŠå†…å­˜é‡Œçš„bufferè¿½åŠ åˆ°å­è¿›ç¨‹ç”Ÿæˆçš„é‚£ä¸ªæ–°AOFé‡Œã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®è®¾ç½®æ—¥å¿—é‡å†™çš„æ¡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Redisä¼šè®°ä½è‡ªä»ä¸Šä¸€æ¬¡é‡å†™åAOFæ–‡ä»¶çš„å¤§å°ï¼ˆå¦‚æœè‡ªRediså¯åŠ¨åè¿˜æ²¡é‡å†™è¿‡ï¼Œåˆ™è®°ä½å¯åŠ¨æ—¶ä½¿ç”¨çš„AOFæ–‡ä»¶çš„å¤§å°ï¼‰ã€‚</div><div class="line">å¦‚æœå½“å‰çš„æ–‡ä»¶å¤§å°æ¯”èµ·è®°ä½çš„é‚£ä¸ªå¤§å°è¶…è¿‡æŒ‡å®šçš„ç™¾åˆ†æ¯”ï¼Œåˆ™ä¼šè§¦å‘é‡å†™ã€‚</div><div class="line">åŒæ—¶éœ€è¦è®¾ç½®ä¸€ä¸ªæ–‡ä»¶å¤§å°æœ€å°å€¼ï¼Œåªæœ‰å¤§äºè¿™ä¸ªå€¼æ–‡ä»¶æ‰ä¼šé‡å†™ï¼Œä»¥é˜²æ–‡ä»¶å¾ˆå°ï¼Œä½†æ˜¯å·²ç»è¾¾åˆ°ç™¾åˆ†æ¯”çš„æƒ…å†µã€‚</div><div class="line"></div><div class="line">auto-aof-rewrite-percentage 100</div><div class="line">auto-aof-rewrite-min-size 64mb</div></pre></td></tr></table></figure>
<p>è¦ç¦ç”¨è‡ªåŠ¨çš„æ—¥å¿—é‡å†™åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç™¾åˆ†æ¯”è®¾ç½®ä¸º0ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">auto-aof-rewrite-percentage 0</div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼šRedis 2.4ä»¥ä¸Šæ‰å¯ä»¥è‡ªåŠ¨è¿›è¡Œæ—¥å¿—é‡å†™ï¼Œä¹‹å‰çš„ç‰ˆæœ¬éœ€è¦æ‰‹åŠ¨è¿è¡ŒBGREWRITEAOFè¿™ä¸ªå‘½ä»¤ã€‚</strong></p>
<h4 id="æ•°æ®æŸåä¿®å¤"><a href="#æ•°æ®æŸåä¿®å¤" class="headerlink" title="æ•°æ®æŸåä¿®å¤"></a>æ•°æ®æŸåä¿®å¤</h4><p>å¦‚æœå› ä¸ºæŸäº›åŸå› ï¼ˆä¾‹å¦‚æœåŠ¡å™¨å´©æºƒï¼‰AOFæ–‡ä»¶æŸåäº†ï¼Œå¯¼è‡´RedisåŠ è½½ä¸äº†ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œä¿®å¤ï¼š</p>
<ul>
<li>å¤‡ä»½AOFæ–‡ä»¶ã€‚</li>
<li>ä½¿ç”¨redis-check-aofå‘½ä»¤ä¿®å¤åŸå§‹çš„AOFæ–‡ä»¶ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ redis-check-aof --fix</div></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥ä½¿ç”¨diff -uå‘½ä»¤çœ‹ä¸‹ä¸¤ä¸ªæ–‡ä»¶çš„å·®å¼‚ã€‚</li>
<li>ä½¿ç”¨ä¿®å¤è¿‡çš„æ–‡ä»¶é‡å¯RedisæœåŠ¡ã€‚</li>
</ul>
<h4 id="ä»RDBåˆ‡æ¢åˆ°AOF"><a href="#ä»RDBåˆ‡æ¢åˆ°AOF" class="headerlink" title="ä»RDBåˆ‡æ¢åˆ°AOF"></a>ä»RDBåˆ‡æ¢åˆ°AOF</h4><p>è¿™é‡Œåªè¯´Redis &gt;= 2.2ç‰ˆæœ¬çš„æ–¹å¼ï¼š</p>
<ul>
<li>å¤‡ä»½ä¸€ä¸ªæœ€æ–°çš„dump.rdbçš„æ–‡ä»¶ï¼Œå¹¶æŠŠå¤‡ä»½æ–‡ä»¶æ”¾åœ¨ä¸€ä¸ªå®‰å…¨çš„åœ°æ–¹ã€‚</li>
<li>è¿è¡Œä»¥ä¸‹ä¸¤æ¡å‘½ä»¤ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ redis-cli config set appendonly yes</div><div class="line">$ redis-cli config set save &quot;&quot;</div></pre></td></tr></table></figure>
<ul>
<li>ç¡®ä¿æ•°æ®è·Ÿåˆ‡æ¢å‰ä¸€è‡´ã€‚</li>
<li>ç¡®ä¿æ•°æ®æ­£ç¡®çš„å†™åˆ°AOFæ–‡ä»¶é‡Œã€‚</li>
</ul>
<p><strong>ç¬¬äºŒæ¡å‘½ä»¤æ˜¯ç”¨æ¥ç¦ç”¨RDBçš„æŒä¹…åŒ–æ–¹å¼ï¼Œä½†æ˜¯è¿™ä¸æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºä½ å¯ä»¥åŒæ—¶å¯ç”¨ä¸¤ç§æŒä¹…åŒ–æ–¹å¼ã€‚</strong><br><strong>è®°å¾—å¯¹é…ç½®æ–‡ä»¶redis.confè¿›è¡Œç¼–è¾‘å¯ç”¨AOFï¼Œå› ä¸ºå‘½ä»¤è¡Œæ–¹å¼ä¿®æ”¹é…ç½®åœ¨é‡å¯Redisåå°±ä¼šå¤±æ•ˆã€‚</strong></p>
<h3 id="å¤‡ä»½"><a href="#å¤‡ä»½" class="headerlink" title="å¤‡ä»½"></a>å¤‡ä»½</h3><p>å»ºè®®çš„å¤‡ä»½æ–¹æ³•ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯å°æ—¶å’Œæ¯å¤©åˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼Œä¿å­˜åœ¨ä¸åŒçš„æ–‡ä»¶å¤¹é‡Œã€‚</li>
<li>å®šæ—¶ä»»åŠ¡è¿è¡Œæ—¶ï¼ŒæŠŠå¤ªæ—§çš„æ–‡ä»¶è¿›è¡Œåˆ é™¤ã€‚ä¾‹å¦‚åªä¿ç•™48å°æ—¶çš„æŒ‰å°æ—¶åˆ›å»ºçš„å¿«ç…§å’Œä¸€åˆ°ä¸¤ä¸ªæœˆçš„æŒ‰å¤©åˆ›å»ºçš„å¿«ç…§ã€‚</li>
<li>æ¯å¤©ç¡®ä¿ä¸€æ¬¡æŠŠå¿«ç…§æ–‡ä»¶ä¼ è¾“åˆ°æ•°æ®ä¸­å¿ƒå¤–çš„åœ°æ–¹è¿›è¡Œä¿å­˜ï¼Œè‡³å°‘ä¸èƒ½ä¿å­˜åœ¨RedisæœåŠ¡æ‰€åœ¨çš„æœåŠ¡å™¨ã€‚</li>
</ul>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://redis.io/topics/persistence" target="_blank" rel="external">redis</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Epollæ¨¡å‹è¯¦è§£]]></title>
      <url>http://zsr.github.io/2016/12/11/Epoll%E6%A8%A1%E5%9E%8B/</url>
      <content type="html"><![CDATA[<p> Linux 2.6å†…æ ¸ä¸­æé«˜ç½‘ç»œI/Oæ€§èƒ½çš„æ–°æ–¹æ³•â€”epoll I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯åœ¨æ¯”è¾ƒå¤šçš„TCPç½‘ç»œæœåŠ¡å™¨ä¸­æœ‰ä½¿ç”¨.</p>
<h3 id="1ã€ä¸ºä»€ä¹ˆselectè½å"><a href="#1ã€ä¸ºä»€ä¹ˆselectè½å" class="headerlink" title="1ã€ä¸ºä»€ä¹ˆselectè½å"></a>1ã€ä¸ºä»€ä¹ˆselectè½å</h3><pre><code>é¦–å…ˆï¼Œåœ¨Linuxå†…æ ¸ä¸­ï¼Œselectæ‰€ç”¨åˆ°çš„`FD_SET`æ˜¯æœ‰é™çš„ï¼Œå³å†…æ ¸ä¸­æœ‰ä¸ªå‚æ•°__FD_SETSIZEå®šä¹‰äº†æ¯ä¸ªFD_SETçš„å¥æŸ„ä¸ªæ•°ï¼Œåœ¨ æˆ‘ç”¨çš„2.6.15-25-386å†…æ ¸ä¸­ï¼Œè¯¥å€¼æ˜¯1024ï¼Œæœç´¢å†…æ ¸æºä»£ç å¾—åˆ°ï¼š
</code></pre><p>include/linux/posix_types.h:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">define <span class="number">__F</span>D_SETSIZEÂ Â Â Â Â Â Â Â  <span class="number">1024</span></div></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæƒ³è¦åŒæ—¶æ£€æµ‹1025ä¸ªå¥æŸ„çš„å¯è¯»çŠ¶æ€æ˜¯ä¸å¯èƒ½ç”¨selectå®ç°çš„ã€‚æˆ–è€… åŒæ—¶æ£€æµ‹1025ä¸ªå¥æŸ„çš„å¯å†™çŠ¶æ€ä¹Ÿæ˜¯ä¸å¯èƒ½çš„ã€‚å…¶æ¬¡ï¼Œå†…æ ¸ä¸­å®ç°<code>select</code>æ˜¯ç”¨è½®è¯¢æ–¹æ³•ï¼Œå³æ¯æ¬¡æ£€æµ‹éƒ½ä¼šéå†æ‰€æœ‰FD_SETä¸­çš„å¥æŸ„ï¼Œæ˜¾ç„¶ï¼Œselectå‡½æ•°æ‰§è¡Œæ—¶é—´ä¸FD_SETä¸­çš„å¥æŸ„ä¸ªæ•°æœ‰ä¸€ä¸ªæ¯”ä¾‹å…³ç³»ï¼Œå³ selectè¦æ£€æµ‹çš„å¥æŸ„æ•°è¶Šå¤šå°±ä¼šè¶Šè´¹æ—¶ã€‚å½“ç„¶ï¼Œåœ¨å‰æ–‡ä¸­æˆ‘å¹¶æ²¡æœ‰æåŠpollæ–¹æ³•ï¼Œäº‹å®ä¸Šç”¨selectçš„æœ‹å‹ä¸€å®šä¹Ÿè¯•è¿‡pollï¼Œæˆ‘ä¸ªäººè§‰å¾— selectå’Œpollå¤§åŒå°å¼‚ï¼Œä¸ªäººåå¥½äºç”¨selectè€Œå·²ã€‚</p>
<h3 id="2ã€å†…æ ¸ä¸­æé«˜I-Oæ€§èƒ½çš„æ–°æ–¹æ³•epoll"><a href="#2ã€å†…æ ¸ä¸­æé«˜I-Oæ€§èƒ½çš„æ–°æ–¹æ³•epoll" class="headerlink" title="2ã€å†…æ ¸ä¸­æé«˜I/Oæ€§èƒ½çš„æ–°æ–¹æ³•epoll"></a>2ã€å†…æ ¸ä¸­æé«˜I/Oæ€§èƒ½çš„æ–°æ–¹æ³•epoll</h3><pre><code>epollæ˜¯ä»€ä¹ˆï¼ŸæŒ‰ç…§manæ‰‹å†Œçš„è¯´æ³•ï¼šæ˜¯ä¸ºå¤„ç†å¤§æ‰¹é‡å¥æŸ„è€Œä½œäº†æ”¹è¿›çš„pollã€‚è¦ä½¿ç”¨epollåªéœ€è¦è¿™ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨ï¼šepoll_create(2)ï¼Œ epoll_ctl(2)ï¼Œ epoll_wait(2)ã€‚
</code></pre><h3 id="3ã€epollçš„ä¼˜ç‚¹"><a href="#3ã€epollçš„ä¼˜ç‚¹" class="headerlink" title="3ã€epollçš„ä¼˜ç‚¹"></a>3ã€epollçš„ä¼˜ç‚¹</h3><ul>
<li><p>æ”¯æŒä¸€ä¸ªè¿›ç¨‹æ‰“å¼€å¤§æ•°ç›®çš„socketæè¿°ç¬¦(FD)</p>
<p>  select æœ€ä¸èƒ½å¿å—çš„æ˜¯ä¸€ä¸ªè¿›ç¨‹æ‰€æ‰“å¼€çš„FDæ˜¯æœ‰ä¸€å®šé™åˆ¶çš„ï¼Œç”±FD_SETSIZEè®¾ç½®ï¼Œé»˜è®¤å€¼æ˜¯2048ã€‚å¯¹äºé‚£äº›éœ€è¦æ”¯æŒçš„ä¸Šä¸‡è¿æ¥æ•°ç›®çš„IMæœåŠ¡å™¨æ¥è¯´æ˜¾ç„¶å¤ªå°‘äº†ã€‚è¿™æ—¶å€™ä½ ä¸€æ˜¯å¯ä»¥é€‰æ‹©ä¿®æ”¹è¿™ä¸ªå®ç„¶åé‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œä¸è¿‡èµ„æ–™ä¹ŸåŒæ—¶æŒ‡å‡ºè¿™æ ·ä¼šå¸¦æ¥ç½‘ç»œæ•ˆç‡çš„ä¸‹é™ï¼ŒäºŒæ˜¯å¯ä»¥é€‰æ‹©å¤šè¿›ç¨‹çš„è§£å†³æ–¹æ¡ˆ(ä¼ ç»Ÿçš„ Apacheæ–¹æ¡ˆ)ï¼Œä¸è¿‡è™½ç„¶linuxä¸Šé¢åˆ›å»ºè¿›ç¨‹çš„ä»£ä»·æ¯”è¾ƒå°ï¼Œä½†ä»æ—§æ˜¯ä¸å¯å¿½è§†çš„ï¼ŒåŠ ä¸Šè¿›ç¨‹é—´æ•°æ®åŒæ­¥è¿œæ¯”ä¸ä¸Šçº¿ç¨‹é—´åŒæ­¥çš„é«˜æ•ˆï¼Œæ‰€ä»¥ä¹Ÿä¸æ˜¯ä¸€ç§å®Œ ç¾çš„æ–¹æ¡ˆã€‚ä¸è¿‡epollåˆ™æ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼Œå®ƒæ‰€æ”¯æŒçš„FDä¸Šé™æ˜¯æœ€å¤§å¯ä»¥æ‰“å¼€æ–‡ä»¶çš„æ•°ç›®ï¼Œè¿™ä¸ªæ•°å­—ä¸€èˆ¬è¿œå¤§äº2048,ä¸¾ä¸ªä¾‹å­,åœ¨1GBå†…å­˜çš„æœºå™¨ä¸Šå¤§çº¦æ˜¯10ä¸‡å·¦ å³ï¼Œå…·ä½“æ•°ç›®å¯ä»¥cat /proc/sys/fs/file-maxå¯Ÿçœ‹,ä¸€èˆ¬æ¥è¯´è¿™ä¸ªæ•°ç›®å’Œç³»ç»Ÿå†…å­˜å…³ç³»å¾ˆå¤§ã€‚</p>
</li>
<li><p>IO æ•ˆç‡ä¸éšFDæ•°ç›®å¢åŠ è€Œçº¿æ€§ä¸‹é™</p>
<p>   ä¼ ç»Ÿçš„<code>select/poll</code>å¦ä¸€ä¸ªè‡´å‘½å¼±ç‚¹å°±æ˜¯å½“ä½ æ‹¥æœ‰ä¸€ä¸ªå¾ˆå¤§çš„socketé›†åˆï¼Œä¸è¿‡ç”±äºç½‘ç»œå»¶æ—¶ï¼Œä»»ä¸€æ—¶é—´åªæœ‰éƒ¨åˆ†çš„socketæ˜¯â€æ´»è·ƒâ€çš„ï¼Œ ä½†æ˜¯select/pollæ¯æ¬¡è°ƒç”¨éƒ½ä¼šçº¿æ€§æ‰«æå…¨éƒ¨çš„é›†åˆï¼Œå¯¼è‡´æ•ˆç‡å‘ˆç°çº¿æ€§ä¸‹é™ã€‚ä½†æ˜¯<code>epoll</code>ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œå®ƒåªä¼šå¯¹â€æ´»è·ƒâ€çš„socketè¿›è¡Œæ“ä½œâ€”è¿™æ˜¯å› ä¸ºåœ¨å†…æ ¸å®ç°ä¸­epollæ˜¯æ ¹æ®æ¯ä¸ªfdä¸Šé¢çš„<code>callback</code>å‡½æ•°å®ç°çš„ã€‚é‚£ä¹ˆï¼Œåªæœ‰â€æ´»è·ƒâ€çš„socketæ‰ä¼šä¸»åŠ¨çš„å»è°ƒç”¨ callbackå‡½æ•°ï¼Œå…¶ä»–idleçŠ¶æ€socketåˆ™ä¸ä¼šï¼Œåœ¨è¿™ç‚¹ä¸Šï¼Œepollå®ç°äº†ä¸€ä¸ªâ€ä¼ªâ€AIOï¼Œå› ä¸ºè¿™æ—¶å€™æ¨åŠ¨åŠ›åœ¨oså†…æ ¸ã€‚åœ¨ä¸€äº› benchmarkä¸­ï¼Œå¦‚æœæ‰€æœ‰çš„socketåŸºæœ¬ä¸Šéƒ½æ˜¯æ´»è·ƒçš„â€”æ¯”å¦‚ä¸€ä¸ªé«˜é€ŸLANç¯å¢ƒï¼Œepollå¹¶ä¸æ¯”select/pollæœ‰ä»€ä¹ˆæ•ˆç‡ï¼Œç›¸åï¼Œå¦‚æœè¿‡å¤šä½¿ç”¨epoll_ctl,æ•ˆç‡ç›¸æ¯”è¿˜æœ‰ç¨å¾®çš„ä¸‹é™ã€‚ä½†æ˜¯ä¸€æ—¦ä½¿ç”¨idle connectionsæ¨¡æ‹ŸWANç¯å¢ƒ,epollçš„æ•ˆç‡å°±è¿œåœ¨select/pollä¹‹ä¸Šäº†ã€‚</p>
</li>
<li><p>ä½¿ç”¨mmapåŠ é€Ÿå†…æ ¸ä¸ç”¨æˆ·ç©ºé—´çš„æ¶ˆæ¯ä¼ é€’ã€‚</p>
<p>  è¿™ç‚¹å®é™…ä¸Šæ¶‰åŠåˆ°epollçš„å…·ä½“å®ç°äº†ã€‚æ— è®ºæ˜¯select,pollè¿˜æ˜¯epolléƒ½éœ€è¦å†…æ ¸æŠŠFDæ¶ˆæ¯é€šçŸ¥ç»™ç”¨æˆ·ç©ºé—´ï¼Œå¦‚ä½•é¿å…ä¸å¿…è¦çš„å†…å­˜æ‹·è´å°±å¾ˆé‡è¦ï¼Œåœ¨è¿™ç‚¹ä¸Šï¼Œepollæ˜¯é€šè¿‡å†…æ ¸ä¸ç”¨æˆ·ç©ºé—´mmap(å†…å­˜æ˜ å°„)åŒä¸€å—å†…å­˜å®ç°çš„ã€‚è€Œå¦‚æœä½ æƒ³æˆ‘ä¸€æ ·ä»2.5å†…æ ¸å°±å…³æ³¨epollçš„è¯ï¼Œä¸€å®šä¸ä¼šå¿˜è®°æ‰‹å·¥ mmapè¿™ä¸€æ­¥çš„ã€‚</p>
</li>
<li><p>å†…æ ¸å¾®è°ƒ</p>
<p>  è¿™ä¸€ç‚¹å…¶å®ä¸ç®—epollçš„ä¼˜ç‚¹äº†ï¼Œè€Œæ˜¯æ•´ä¸ªlinuxå¹³å°çš„ä¼˜ç‚¹ã€‚ä¹Ÿè®¸ä½ å¯ä»¥æ€€ç–‘linuxå¹³å°ï¼Œä½†æ˜¯ä½ æ— æ³•å›é¿linuxå¹³å°èµ‹äºˆä½ å¾®è°ƒå†…æ ¸çš„èƒ½åŠ›ã€‚æ¯”å¦‚ï¼Œå†…æ ¸TCP/IPåè®®æ ˆä½¿ç”¨å†…å­˜æ± ç®¡ç†sk_buffç»“æ„ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨è¿è¡Œæ—¶ æœŸåŠ¨æ€è°ƒæ•´è¿™ä¸ªå†…å­˜pool(skb_head_pool)çš„å¤§å°â€” é€šè¿‡echo XXXX&gt;/proc/sys/net/core/hot_list_lengthå®Œæˆã€‚å†æ¯”å¦‚listenå‡½æ•°çš„ç¬¬2ä¸ªå‚æ•°(TCPå®Œæˆ3æ¬¡æ¡æ‰‹çš„æ•°æ®åŒ…é˜Ÿåˆ—é•¿åº¦)ï¼Œä¹Ÿå¯ä»¥æ ¹æ®ä½ å¹³å°å†…å­˜å¤§å°åŠ¨æ€è°ƒæ•´ã€‚æ›´ç”šè‡³åœ¨ä¸€ä¸ªæ•°æ®åŒ…æ•°ç›®å·¨å¤§ä½†åŒæ—¶æ¯ä¸ªæ•°æ®åŒ…æœ¬èº«å¤§å°å´å¾ˆå°çš„ç‰¹æ®Šç³»ç»Ÿä¸Šå°è¯•æœ€æ–°çš„NAPIç½‘å¡é©±åŠ¨æ¶æ„ã€‚</p>
</li>
</ul>
<h3 id="4ã€epollçš„å·¥ä½œæ¨¡å¼"><a href="#4ã€epollçš„å·¥ä½œæ¨¡å¼" class="headerlink" title="4ã€epollçš„å·¥ä½œæ¨¡å¼"></a>4ã€epollçš„å·¥ä½œæ¨¡å¼</h3><pre><code>ä»¤äººé«˜å…´çš„æ˜¯ï¼Œ2.6å†…æ ¸çš„epollæ¯”å…¶2.5å¼€å‘ç‰ˆæœ¬çš„/dev/epollç®€æ´äº†è®¸å¤šï¼Œæ‰€ä»¥ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¼ºå¤§çš„ä¸œè¥¿å¾€å¾€æ˜¯ç®€å•çš„ã€‚å”¯ä¸€æœ‰ç‚¹éº»çƒ¦æ˜¯epollæœ‰2ç§å·¥ä½œæ–¹å¼:LTå’ŒETã€‚
</code></pre><p>LT(level triggered)æ˜¯ç¼ºçœçš„å·¥ä½œæ–¹å¼ï¼Œå¹¶ä¸”åŒæ—¶æ”¯æŒblockå’Œno-block socket.åœ¨è¿™ç§åšæ³•ä¸­ï¼Œå†…æ ¸å‘Šè¯‰ä½ ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å°±ç»ªäº†ï¼Œç„¶åä½ å¯ä»¥å¯¹è¿™ä¸ªå°±ç»ªçš„fdè¿›è¡ŒIOæ“ä½œã€‚å¦‚æœä½ ä¸ä½œä»»ä½•æ“ä½œï¼Œå†…æ ¸è¿˜æ˜¯ä¼šç»§ç»­é€šçŸ¥ä½  çš„ï¼Œæ‰€ä»¥ï¼Œè¿™ç§æ¨¡å¼ç¼–ç¨‹å‡ºé”™è¯¯å¯èƒ½æ€§è¦å°ä¸€ç‚¹ã€‚ä¼ ç»Ÿçš„select/polléƒ½æ˜¯è¿™ç§æ¨¡å‹çš„ä»£è¡¨ï¼<br>ET (edge-triggered)æ˜¯é«˜é€Ÿå·¥ä½œæ–¹å¼ï¼Œåªæ”¯æŒno-block socketã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå½“æè¿°ç¬¦ä»æœªå°±ç»ªå˜ä¸ºå°±ç»ªæ—¶ï¼Œå†…æ ¸é€šè¿‡epollå‘Šè¯‰ä½ ã€‚ç„¶åå®ƒä¼šå‡è®¾ä½ çŸ¥é“æ–‡ä»¶æè¿°ç¬¦å·²ç»å°±ç»ªï¼Œå¹¶ä¸”ä¸ä¼šå†ä¸ºé‚£ä¸ªæ–‡ä»¶æè¿° ç¬¦å‘é€æ›´å¤šçš„å°±ç»ªé€šçŸ¥ï¼Œç›´åˆ°ä½ åšäº†æŸäº›æ“ä½œå¯¼è‡´é‚£ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸å†ä¸ºå°±ç»ªçŠ¶æ€äº†(æ¯”å¦‚ï¼Œä½ åœ¨å‘é€ï¼Œæ¥æ”¶æˆ–è€…æ¥æ”¶è¯·æ±‚ï¼Œæˆ–è€…å‘é€æ¥æ”¶çš„æ•°æ®å°‘äºä¸€å®šé‡æ—¶å¯¼è‡´ äº†ä¸€ä¸ªEWOULDBLOCK é”™è¯¯ï¼‰ã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œå¦‚æœä¸€ç›´ä¸å¯¹è¿™ä¸ªfdä½œIOæ“ä½œ(ä»è€Œå¯¼è‡´å®ƒå†æ¬¡å˜æˆæœªå°±ç»ª)ï¼Œå†…æ ¸ä¸ä¼šå‘é€æ›´å¤šçš„é€šçŸ¥(only once)ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Redisè®¾è®¡æ€è·¯å­¦ä¹ ä¸æ€»ç»“]]></title>
      <url>http://zsr.github.io/2016/12/11/Redis%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF%E5%AD%A6%E4%B9%A0%E4%B8%8E%E6%80%BB%E7%BB%93/</url>
      <content type="html"><![CDATA[<p>Redisæ˜¯ä¸šç•Œæ™®éåº”ç”¨çš„ç¼“å­˜ç»„ä»¶ï¼Œç ”ç©¶ä¸€ä¸ªç»„ä»¶æ¡†æ¶ï¼Œæœ€ç›´è§‚çš„åŠæ³•å°±æ˜¯ä»åº”ç”¨æ–¹çš„è§’åº¦å‡ºå‘ï¼Œå°†æ¯ä¸ªæ­¥éª¤çš„è€ƒè™‘ä¸€ç•ªï¼Œä»è¿™äº›æ­¥éª¤å…¥æ‰‹å»ç ”ç©¶å¾€å¾€èƒ½å¤Ÿæœ€å¿«çš„ä½“ä¼šåˆ°ä¸€ä¸ªç»„ä»¶æ¡†æ¶çš„è®¾è®¡å“²å­¦ã€‚ä»¥Redisä¸ºä¾‹ï¼Œæ¯å½“å‘èµ·ä¸€æ¡è¯·æ±‚æ—¶ï¼Œredisæ˜¯å¦‚ä½•ç®¡ç†ç®¡ç†ç½‘ç»œè¯·æ±‚ï¼Œæ”¶åˆ°è¯·æ±‚ååˆæ˜¯é€šè¿‡ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„è¿›è¡Œç»„ç»‡å¹¶æ“ä½œå†…å­˜ï¼Œè¿™äº›æ•°æ®åˆæ˜¯å¦‚ä½•dumpåˆ°ç£ç›˜å®ç°æŒä¹…åŒ–ï¼Œå†åˆ°å¤šæœºç¯å¢ƒä¸‹å¦‚ä½•åŒæ­¥å’Œä¿è¯ä¸€è‡´æ€§â€¦â€¦æœ¬æ–‡å°±æ˜¯ä»ç½‘ç»œæ¨¡å‹ã€æ•°æ®ç»“æ„è®¾è®¡ä¸å†…å­˜ç®¡ç†ã€æŒä¹…åŒ–æ–¹æ³•å’Œå¤šæœºå››ä¸ªè§’åº¦ç®€è¦æè¿°äº†redisçš„è®¾è®¡å’Œè‡ªå·±çš„ä¸€ç‚¹ä½“ä¼šã€‚</p>
<h3 id="ä¸€-ç½‘ç»œæ¨¡å‹"><a href="#ä¸€-ç½‘ç»œæ¨¡å‹" class="headerlink" title="ä¸€.ç½‘ç»œæ¨¡å‹"></a>ä¸€.ç½‘ç»œæ¨¡å‹</h3><p>Redisæ˜¯å…¸å‹çš„åŸºäºReactorçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œå•è¿›ç¨‹å•çº¿ç¨‹ï¼Œé«˜æ•ˆçš„æ¡†æ¶æ€»æ˜¯ç±»ä¼¼çš„ã€‚ç½‘ç»œæ¨¡å‹ä¸select,epollå¼‚æ­¥æ¨¡å‹å‡ ä¹ä¸€è‡´ã€‚</p>
<p>Redisæµç¨‹ä¸Šæ•´ä½“åˆ†ä¸º<code>æ¥å—è¯·æ±‚å¤„ç†å™¨</code>ã€<code>å“åº”å¤„ç†å™¨</code>å’Œ<code>åº”ç­”å¤„ç†å™¨</code>ä¸‰ä¸ªåŒæ­¥æ¨¡å—ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚éƒ½æ˜¯è¦ç»å†è¿™ä¸‰ä¸ªéƒ¨åˆ†ã€‚</p>
<p>Redisé›†æˆäº†<code>libevent/epoll/kqueue/select</code>ç­‰å¤šç§äº‹ä»¶ç®¡ç†æœºåˆ¶ï¼Œå¯ä»¥æ ¹æ®æ“ä½œç³»ç»Ÿç‰ˆæœ¬è‡ªç”±é€‰æ‹©åˆé€‚çš„ç®¡ç†æœºåˆ¶ï¼Œå…¶ä¸­libeventæ˜¯æœ€ä¼˜é€‰æ‹©çš„æœºåˆ¶ã€‚</p>
<p>Redisçš„ç½‘ç»œæ¨¡å‹æœ‰ç€æ‰€æœ‰äº‹ä»¶é©±åŠ¨æ¨¡å‹çš„ä¼˜ç‚¹ï¼Œé«˜æ•ˆä½è€—ã€‚ä½†æ˜¯é¢å¯¹è€—æ—¶è¾ƒé•¿çš„æ“ä½œçš„æ—¶å€™ï¼ŒåŒæ ·æ— æ³•å¤„ç†è¯·æ±‚ï¼Œåªèƒ½ç­‰åˆ°äº‹ä»¶å¤„ç†å®Œæ¯•æ‰èƒ½å“åº”ï¼Œæ¯”å¦‚åˆ é™¤redisä¸­å…¨é‡çš„key-valueï¼Œæ•´ä¸ªæ“ä½œæ—¶é—´è¾ƒé•¿ï¼Œæ“ä½œæœŸé—´æ‰€æœ‰çš„è¯·æ±‚éƒ½æ— æ³•å“åº”ã€‚æ‰€ä»¥äº†è§£æ¸…æ¥šç½‘ç»œæ¨¡å‹æœ‰åŠ©äºåœ¨ä¸šåŠ¡ä¸­æ‰¬é•¿é¿çŸ­ï¼Œå‡å°‘é•¿è€—æ—¶çš„è¯·æ±‚ï¼Œå°½å¯èƒ½å¤šä¸€äº›ç®€å•çš„çŸ­è€—æ—¶è¯·æ±‚å‘æŒ¥å¼‚æ­¥æ¨¡å‹çš„æœ€å¤§çš„å¨åŠ›ï¼Œäº‹å®ä¸Šåœ¨Redisçš„è®¾è®¡ä¸­ä¹Ÿå¤šæ¬¡ä½“ç°è¿™ä¸€ç‚¹ã€‚</p>
<h3 id="äºŒ-æ•°æ®ç»“æ„å’Œå†…å­˜ç®¡ç†"><a href="#äºŒ-æ•°æ®ç»“æ„å’Œå†…å­˜ç®¡ç†" class="headerlink" title="äºŒ.æ•°æ®ç»“æ„å’Œå†…å­˜ç®¡ç†"></a>äºŒ.æ•°æ®ç»“æ„å’Œå†…å­˜ç®¡ç†</h3><h4 id="1-å­—ç¬¦ä¸²"><a href="#1-å­—ç¬¦ä¸²" class="headerlink" title="1.å­—ç¬¦ä¸²"></a>1.å­—ç¬¦ä¸²</h4><h5 id="1-1-ç»“æ„"><a href="#1-1-ç»“æ„" class="headerlink" title="1.1 ç»“æ„"></a>1.1 ç»“æ„</h5><p>Redisçš„å­—ç¬¦ä¸²æ˜¯å¯¹Cè¯­è¨€åŸå§‹å­—ç¬¦ä¸²çš„äºŒæ¬¡å°è£…ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> sdshdr &#123;</div><div class="line">    <span class="keyword">long</span> len;</div><div class="line">    <span class="keyword">long</span> <span class="built_in">free</span>;</div><div class="line">    <span class="keyword">char</span> buf[];</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œæ¯å½“å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œé™¤äº†ä¿å­˜å­—ç¬¦çš„ç©ºé—´ï¼ŒRedisè¿˜åˆ†é…äº†é¢å¤–çš„ç©ºé—´ç”¨äºç®¡ç†å±æ€§å­—æ®µã€‚</p>
<h4 id="1-2-å†…å­˜ç®¡ç†æ–¹å¼"><a href="#1-2-å†…å­˜ç®¡ç†æ–¹å¼" class="headerlink" title="1.2 å†…å­˜ç®¡ç†æ–¹å¼"></a>1.2 å†…å­˜ç®¡ç†æ–¹å¼</h4><p>åŠ¨æ€å†…å­˜ç®¡ç†æ–¹å¼ï¼ŒåŠ¨æ€æ–¹å¼æœ€å¤§çš„å¥½å¤„å°±æ˜¯èƒ½å¤Ÿè¾ƒä¸ºå……åˆ†çš„åˆ©ç”¨å†…å­˜ç©ºé—´ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡åŒ–ï¼Œä¸æ­¤åŒæ—¶å¸¦æ¥çš„åŠ£åŠ¿å°±æ˜¯å®¹æ˜“å¼•èµ·é¢‘ç¹çš„å†…å­˜æŠ–åŠ¨ï¼Œé€šå¸¸é‡‡ç”¨â€œç©ºé—´é¢„åˆ†é…â€å’Œâ€œæƒ°æ€§ç©ºé—´é‡Šæ”¾â€ä¸¤ç§ä¼˜åŒ–ç­–ç•¥æ¥å‡å°‘å†…å­˜æŠ–åŠ¨ï¼Œredisä¹Ÿä¸ä¾‹å¤–ã€‚</p>
<p>æ¯æ¬¡ä¿®æ”¹å­—ç¬¦ä¸²å†…å®¹æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥å†…å­˜ç©ºé—´æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œå¦åˆ™å°±æ‰©å¤§2å€æˆ–è€…æŒ‰Må¢é•¿ï¼›å‡å°‘å­—ç¬¦ä¸²å†…å®¹æ—¶ï¼Œå†…å­˜å¹¶ä¸ä¼šç«‹åˆ»å›æ”¶ï¼Œè€Œæ˜¯æŒ‰éœ€å›æ”¶ã€‚</p>
<p>å…³äºå†…å­˜ç®¡ç†çš„ä¼˜åŒ–ï¼Œæœ€åŸºæœ¬çš„å‡ºå‘ç‚¹å°±æ˜¯æµªè´¹ä¸€ç‚¹ç©ºé—´è¿˜æ˜¯ç‰ºç‰²ä¸€äº›æ—¶é—´çš„æƒè¡¡ï¼ŒåƒSTLã€tcmallocã€protobuf3çš„arenaæœºåˆ¶ç­‰é‡‡ç”¨çš„æ ¸å¿ƒæ€è·¯éƒ½æ˜¯â€œé¢„åˆ†é…è¿Ÿå›æ”¶â€ï¼ŒRedisä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p>
<h4 id="1-3-äºŒè¿›åˆ¶å®‰å…¨"><a href="#1-3-äºŒè¿›åˆ¶å®‰å…¨" class="headerlink" title="1.3 äºŒè¿›åˆ¶å®‰å…¨"></a>1.3 äºŒè¿›åˆ¶å®‰å…¨</h4><p>åˆ¤æ–­å­—ç¬¦ä¸²ç»“æŸä¸å¦çš„æ ‡è¯†æ˜¯lenå­—æ®µï¼Œè€Œä¸æ˜¯Cè¯­è¨€çš„â€™\0â€™ï¼Œå› æ­¤æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ã€‚<br>æ”¾å¿ƒçš„å°†pbåºåˆ—åŒ–åçš„äºŒè¿›åˆ¶å­—ç¬¦ä¸²å­˜å…¥redisã€‚<br>ç®€è€Œè¨€ä¹‹ï¼Œé€šè¿‡redisçš„ç®€å•å°è£…ï¼Œredisçš„å­—ç¬¦ä¸²çš„æ“ä½œæ›´åŠ æ–¹ä¾¿ï¼Œæ€§èƒ½æ›´å‹å¥½ï¼Œå¹¶ä¸”å±è”½äº†Cè¯­è¨€å­—ç¬¦ä¸²çš„ä¸€äº›éœ€è¦ç”¨æˆ·å…³å¿ƒçš„é—®é¢˜ã€‚</p>
<h3 id="2-å­—å…¸ï¼ˆå“ˆå¸Œï¼‰"><a href="#2-å­—å…¸ï¼ˆå“ˆå¸Œï¼‰" class="headerlink" title="2.å­—å…¸ï¼ˆå“ˆå¸Œï¼‰"></a>2.å­—å…¸ï¼ˆå“ˆå¸Œï¼‰</h3><p>å­—å…¸çš„åº•å±‚ä¸€å®šæ˜¯hashï¼Œæ¶‰åŠåˆ°hashä¸€å®šä¼šæ¶‰åŠåˆ°hashç®—æ³•ã€å†²çªçš„è§£å†³æ–¹æ³•å’Œhashè¡¨æ‰©å®¹å’Œç¼©å®¹ã€‚</p>
<h4 id="2-1-hashç®—æ³•"><a href="#2-1-hashç®—æ³•" class="headerlink" title="2.1 hashç®—æ³•"></a>2.1 hashç®—æ³•</h4><p>Redisä½¿ç”¨çš„å°±æ˜¯å¸¸ç”¨çš„Murmurhash2ï¼ŒMurmurhashç®—æ³•èƒ½å¤Ÿç»™å‡ºåœ¨ä»»æ„è¾“å…¥åºåˆ—ä¸‹çš„æ•£åˆ—åˆ†å¸ƒæ€§ï¼Œå¹¶ä¸”è®¡ç®—é€Ÿåº¦å¾ˆå¿«ã€‚ä¹‹å‰åšå…±äº«å†…å­˜çš„Local-Cacheçš„éœ€æ±‚æ—¶ä¹Ÿæ­£æ˜¯åˆ©ç”¨äº†Murmurhashçš„ä¼˜åŠ¿ï¼Œè§£å†³äº†åŸæœ‰ç»“æ„çš„hashå‡½æ•°æ•£åˆ—åˆ†å¸ƒæ€§å·®çš„é—®é¢˜ã€‚</p>
<h4 id="2-2-hashå†²çªè§£å†³æ–¹æ³•"><a href="#2-2-hashå†²çªè§£å†³æ–¹æ³•" class="headerlink" title="2.2 hashå†²çªè§£å†³æ–¹æ³•"></a>2.2 hashå†²çªè§£å†³æ–¹æ³•</h4><p>é“¾åœ°å€æ³•è§£å†³hashå†²çªï¼Œé€šç”¨è§£å†³æ–¹æ¡ˆæ²¡ä»€ä¹ˆç‰¹æ®Šçš„ã€‚å¤šè¯´ä¸€å¥ï¼Œå¦‚æœé€‰ç”¨é“¾åœ°å€è§£å†³å†²çªï¼Œé‚£ä¹ˆåŠ¿å¿…è¦æœ‰ä¸€ä¸ªæ•£åˆ—æ€§éå¸¸å¥½çš„hashå‡½æ•°ï¼Œå¦åˆ™hashçš„æ€§èƒ½å°†ä¼šå¤§å¤§æŠ˜æ‰£ã€‚Redisé€‰ç”¨äº†Murmurhashï¼Œæ‰€ä»¥å¯ä»¥æ”¾å¿ƒå¤§èƒ†çš„é‡‡ç”¨é“¾åœ°å€æ–¹æ¡ˆã€‚</p>
<h4 id="2-3-hashæ‰©å®¹å’Œç¼©å®¹"><a href="#2-3-hashæ‰©å®¹å’Œç¼©å®¹" class="headerlink" title="2.3 hashæ‰©å®¹å’Œç¼©å®¹"></a>2.3 hashæ‰©å®¹å’Œç¼©å®¹</h4><p>ç»´æŒhashè¡¨åœ¨ä¸€ä¸ªåˆç†çš„è´Ÿè½½èŒƒå›´ä¹‹å†…ï¼Œç®€ç§°ä¸ºrehashè¿‡ç¨‹ã€‚<br>rehashçš„è¿‡ç¨‹ä¹Ÿæ˜¯ä¸€ä¸ªæƒè¡¡çš„è¿‡ç¨‹ï¼Œåœ¨åšè¯„ä¼°ä¹‹å‰é¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œä¸ç®¡ä¸­é—´é‡‡ç”¨ä»€ä¹ˆæ ·çš„rehashç­–ç•¥ï¼Œrehashåœ¨å®è§‚ä¸Šçœ‹ä¸€å®šæ˜¯ï¼šåˆ†é…ä¸€ä¸ªæ–°çš„å†…å­˜å—ï¼Œè€æ•°æ®æ¬åˆ°æ–°çš„å†…å­˜å—ä¸Šï¼Œé‡Šæ”¾æ—§å†…å­˜å—ã€‚<br>è€æ•°æ®ä½•æ—¶æ¬ï¼Ÿæ€ä¹ˆæ¬ï¼Ÿå°±å˜æˆäº†ä¸€ä¸ªéœ€è¦æƒè¡¡çš„é—®é¢˜ã€‚<br>ç¬¬ä¸€éƒ¨åˆ†çš„ç½‘ç»œæ¨¡å‹ä¸Šæ˜ç¡®çš„æŒ‡å‡ºRedisçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹ç‰¹ç‚¹ï¼Œä¸é€‚åˆç©é•¿è€—æ—¶æ“ä½œã€‚å¦‚æœä¸€ä¸ªhashtableéå¸¸å¤§ï¼Œéœ€è¦è¿›è¡Œæ‰©å®¹å°±ä¸€æ¬¡æ€§æŠŠè€æ•°æ®copyè¿‡å»ï¼Œé‚£å°±ä¼šéå¸¸è€—æ—¶ï¼Œè¿èƒŒäº‹ä»¶é©±åŠ¨çš„ç‰¹ç‚¹ã€‚æ‰€ä»¥Redisä¾æ—§é‡‡ç”¨äº†ä¸€ç§æƒ°æ€§çš„æ–¹æ¡ˆï¼š<br>æ–°ç©ºé—´åˆ†é…å®Œæ¯•åï¼Œå¯åŠ¨rehashidxæ ‡è¯†ç¬¦è¡¨æ˜rehashè¿‡ç¨‹çš„å¼€å§‹ï¼›ä¹‹åæ‰€æœ‰å¢åˆ æ”¹æŸ¥æ¶‰åŠçš„æ“ä½œæ—¶éƒ½ä¼šå°†æ•°æ®è¿ç§»åˆ°æ–°ç©ºé—´ï¼Œç›´åˆ°è€ç©ºé—´æ•°æ®å¤§å°ä¸º0è¡¨æ˜æ•°æ®å·²ç»å…¨éƒ¨åœ¨æ–°ç©ºé—´ï¼Œå°†rehashidxç¦ç”¨ï¼Œè¡¨æ˜rehashç»“æŸã€‚<br>å°†ä¸€æ¬¡æ€§çš„é›†ä¸­é—®é¢˜åˆ†è€Œæ²»ä¹‹ï¼Œåœ¨Redisçš„è®¾è®¡å“²å­¦ä¸­ä½“ç°çš„æ·‹æ¼“å°½è‡´ï¼Œä¸»è¦æ˜¯ä¸ºäº†é¿å…å¤§è€—æ—¶æ“ä½œï¼Œå½±å“Rediså“åº”å®¢æˆ·è¯·æ±‚ã€‚</p>
<h3 id="3-æ•´æ•°é›†åˆ"><a href="#3-æ•´æ•°é›†åˆ" class="headerlink" title="3.æ•´æ•°é›†åˆ"></a>3.æ•´æ•°é›†åˆ</h3><p>å˜é•¿æ•´æ•°å­˜å‚¨ï¼Œæ•´æ•°åˆ†ä¸º16/32/64ä¸‰ä¸ªå˜é•¿å°ºåº¦ï¼Œæ ¹æ®å­˜å…¥çš„æ•°æ®æ‰€å±çš„ç±»å‹ï¼Œè¿›è¡Œè§„åˆ’ã€‚<br>æ¯æ¬¡æ’å…¥æ–°å…ƒç´ éƒ½æœ‰å¯èƒ½å¯¼è‡´å°ºåº¦å‡çº§ï¼ˆä¾‹å¦‚ç”±16ä½æ¶¨åˆ°32ä½ï¼‰ï¼Œå› æ­¤æ’å…¥æ•´æ•°çš„æ—¶é—´å¤æ‚åº¦ä¸ºOï¼ˆnï¼‰ã€‚è¿™é‡Œä¹Ÿæ˜¯ä¸€ä¸ªæƒè¡¡ï¼Œå†…å­˜ç©ºé—´å’Œæ—¶é—´çš„ä¸€ä¸ªæŠ˜ä¸­ï¼Œå°½å¯èƒ½èŠ‚çœå†…å­˜ã€‚</p>
<h3 id="4-è·³è·ƒè¡¨"><a href="#4-è·³è·ƒè¡¨" class="headerlink" title="4.è·³è·ƒè¡¨"></a>4.è·³è·ƒè¡¨</h3><p>Redisçš„skilplistå’Œæ™®é€šçš„skiplistæ²¡ä»€ä¹ˆä¸åŒï¼Œéƒ½æ˜¯å†—ä½™æ•°æ®å®ç°çš„ä»ç²—åˆ°ç»†çš„å¤šå±‚æ¬¡é“¾è¡¨ï¼ŒRedisä¸­åº”ç”¨è·³è¡¨çš„åœ°æ–¹ä¸å¤šï¼Œå¸¸è§çš„å°±æ˜¯æœ‰åºé›†åˆã€‚<br>Redisçš„è·³è¡¨å’Œæ™®é€šskiplistæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šä¹‹å¤„ã€‚</p>
<h3 id="5-é“¾è¡¨"><a href="#5-é“¾è¡¨" class="headerlink" title="5.é“¾è¡¨"></a>5.é“¾è¡¨</h3><p>Redisçš„é“¾è¡¨æ˜¯åŒå‘éå¾ªç¯é“¾è¡¨ï¼Œæ‹¥æœ‰è¡¨å¤´å’Œè¡¨å°¾æŒ‡é’ˆï¼Œå¯¹äºé¦–å°¾çš„æ“ä½œæ—¶é—´å¤æ‚åº¦æ˜¯O(1)ï¼ŒæŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦O(n)ï¼Œæ’å…¥æ—¶é—´å¤æ‚åº¦O(1)ã€‚<br>Redisçš„é“¾è¡¨å’Œæ™®é€šé“¾è¡¨æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šä¹‹å¤„ã€‚</p>
<h3 id="ä¸‰-AOFå’ŒRDBæŒä¹…åŒ–"><a href="#ä¸‰-AOFå’ŒRDBæŒä¹…åŒ–" class="headerlink" title="ä¸‰.AOFå’ŒRDBæŒä¹…åŒ–"></a>ä¸‰.AOFå’ŒRDBæŒä¹…åŒ–</h3><p>AOFæŒä¹…åŒ–æ—¥å¿—ï¼ŒRDBæŒä¹…åŒ–å®ä½“æ•°æ®ï¼ŒAOFä¼˜å…ˆçº§å¤§äºRDBã€‚</p>
<h4 id="1-AOFæŒä¹…åŒ–"><a href="#1-AOFæŒä¹…åŒ–" class="headerlink" title="1.AOFæŒä¹…åŒ–"></a>1.AOFæŒä¹…åŒ–</h4><p>æœºåˆ¶ï¼šé€šè¿‡å®šæ—¶äº‹ä»¶å°†aofç¼“å†²åŒºå†…çš„æ•°æ®å®šæ—¶å†™åˆ°ç£ç›˜ä¸Šã€‚</p>
<h4 id="2-AOFé‡å†™"><a href="#2-AOFé‡å†™" class="headerlink" title="2.AOFé‡å†™"></a>2.AOFé‡å†™</h4><p>ä¸ºäº†å‡å°‘AOFå¤§å°ï¼ŒRedisæä¾›äº†AOFé‡å†™åŠŸèƒ½ï¼Œè¿™ä¸ªé‡å†™åŠŸèƒ½åšçš„å·¥ä½œå°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–°AOFæ–‡ä»¶ä»£æ›¿è€çš„AOFï¼Œå¹¶ä¸”è¿™ä¸ªæ–°çš„AOFæ–‡ä»¶æ²¡æœ‰ä¸€æ¡å†—ä½™æŒ‡ä»¤ã€‚ï¼ˆä¾‹å¦‚å¯¹listå…ˆæ’å…¥A/B/Cï¼Œååˆ é™¤B/Cï¼Œå†æ’å…¥Då…±6æ¡æŒ‡ä»¤ï¼Œæœ€ç»ˆçŠ¶æ€ä¸ºA/Dï¼Œåªéœ€1æ¡æŒ‡ä»¤å°±å¯ä»¥ï¼‰<br>å®ç°åŸç†å°±æ˜¯è¯»ç°æœ‰æ•°æ®åº“çš„çŠ¶æ€ï¼Œæ ¹æ®çŠ¶æ€åæ¨æŒ‡ä»¤ï¼Œè·Ÿä¹‹å‰çš„AOFæ— å…³ã€‚åŒæ ·ï¼Œä¸ºäº†é¿å…é•¿æ—¶é—´è€—æ—¶ï¼Œé‡å†™å·¥ä½œæ”¾åœ¨å­è¿›ç¨‹è¿›è¡Œã€‚</p>
<h4 id="3-RDBæŒä¹…åŒ–"><a href="#3-RDBæŒä¹…åŒ–" class="headerlink" title="3.RDBæŒä¹…åŒ–"></a>3.RDBæŒä¹…åŒ–</h4><p>SAVEå’ŒBGSAVEä¸¤ä¸ªå‘½ä»¤éƒ½æ˜¯ç”¨äºç”ŸæˆRDBæ–‡ä»¶ï¼ŒåŒºåˆ«åœ¨äºBGSAVEä¼šforkå‡ºä¸€ä¸ªå­è¿›ç¨‹å•ç‹¬è¿›è¡Œï¼Œä¸å½±å“Rediså¤„ç†æ­£å¸¸è¯·æ±‚ã€‚<br>å®šæ—¶å’Œå®šæ¬¡æ•°åè¿›è¡ŒæŒä¹…åŒ–æ“ä½œã€‚<br>ç®€è€Œè¨€ä¹‹ï¼ŒRDBçš„è¿‡ç¨‹å…¶å®æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ»¡è¶³æ¡ä»¶åç›´æ¥å»å†™RDBæ–‡ä»¶å°±ç»“æŸäº†ã€‚</p>
<h3 id="å››-å¤šæœºå’Œé›†ç¾¤"><a href="#å››-å¤šæœºå’Œé›†ç¾¤" class="headerlink" title="å››.å¤šæœºå’Œé›†ç¾¤"></a>å››.å¤šæœºå’Œé›†ç¾¤</h3><h4 id="1-ä¸»ä»æœåŠ¡å™¨"><a href="#1-ä¸»ä»æœåŠ¡å™¨" class="headerlink" title="1.ä¸»ä»æœåŠ¡å™¨"></a>1.ä¸»ä»æœåŠ¡å™¨</h4><p>é¿å…å•ç‚¹æ˜¯æ‰€æœ‰æœåŠ¡çš„é€šç”¨é—®é¢˜ï¼ŒRedisä¹Ÿä¸ä¾‹å¤–ã€‚è§£å†³å•ç‚¹å°±è¦æœ‰å¤‡æœºï¼Œæœ‰å¤‡æœºå°±è¦è§£å†³å›ºæœ‰çš„æ•°æ®åŒæ­¥é—®é¢˜ã€‚</p>
<h5 id="1-1-syncâ€”â€”åŸå§‹ç‰ˆä¸»ä»åŒæ­¥"><a href="#1-1-syncâ€”â€”åŸå§‹ç‰ˆä¸»ä»åŒæ­¥" class="headerlink" title="1.1 syncâ€”â€”åŸå§‹ç‰ˆä¸»ä»åŒæ­¥"></a>1.1 syncâ€”â€”åŸå§‹ç‰ˆä¸»ä»åŒæ­¥</h5><p>Redisæœ€åˆçš„åŒæ­¥åšæ³•æ˜¯syncæŒ‡ä»¤ï¼Œé€šè¿‡syncæ¯æ¬¡éƒ½ä¼šå…¨é‡æ•°æ®ï¼Œæ˜¾ç„¶æ¯æ¬¡éƒ½å…¨é‡å¤åˆ¶çš„è®¾è®¡æ¯”è¾ƒæ¶ˆè€—èµ„æºã€‚æ”¹è¿›æ€è·¯ä¹Ÿæ˜¯å¸¸è§„é€»è¾‘ï¼Œç¬¬ä¸€æ¬¡å…¨é‡ï¼Œå‰©ä¸‹çš„å¢é‡ï¼Œè¿™å°±æ˜¯ç°åœ¨çš„psyncæŒ‡ä»¤çš„æ´»ã€‚</p>
<h5 id="1-2-psync"><a href="#1-2-psync" class="headerlink" title="1.2 psync"></a>1.2 psync</h5><p>éƒ¨åˆ†é‡åŒæ­¥å®ç°çš„æŠ€æœ¯æ‰‹æ®µæ˜¯â€œåç§»åºå·+ç§¯å‹ç¼“å†²åŒºâ€ï¼Œå…·ä½“åšæ³•å¦‚ä¸‹ï¼š<br>ï¼ˆ1ï¼‰ä¸»ä»åˆ†åˆ«ç»´æŠ¤ä¸€ä¸ªseqï¼Œä¸»æ¯æ¬¡å®Œæˆä¸€ä¸ªè¯·æ±‚ä¾¿seq+1ï¼Œä»æ¯åŒæ­¥å®Œåæ›´æ–°è‡ªå·±seqï¼›<br>ï¼ˆ2ï¼‰ä»æ¯æ¬¡æ‰“ç®—åŒæ­¥æ—¶éƒ½æ˜¯æºå¸¦ç€è‡ªå·±çš„seqåˆ°ä¸»ï¼Œä¸»å°†è‡ªèº«çš„seqä¸ä»åšå·®ç»“æœä¸ç§¯å‹ç¼“å†²åŒºå¤§å°æ¯”è¾ƒï¼Œå¦‚æœå°äºç§¯å‹ç¼“å†²åŒºå¤§å°ï¼Œç›´æ¥ä»ç§¯å‹ç¼“å†²åŒºå–ç›¸åº”çš„æ“ä½œè¿›è¡Œéƒ¨åˆ†é‡åŒæ­¥ï¼›<br>ï¼ˆ3ï¼‰å¦åˆ™è¯´æ˜ç§¯å‹ç¼“å†²åŒºä¸èƒ½å¤Ÿcoveræ‰ä¸»ä»ä¸ä¸€è‡´çš„æ•°æ®ï¼Œè¿›è¡Œå…¨é‡åŒæ­¥ã€‚<br>æœ¬è´¨åšæ³•ç”¨ç©ºé—´æ¢æ—¶é—´ï¼Œæ˜¾ç„¶åœ¨è¿™é‡Œç‰ºç‰²éƒ¨åˆ†ç©ºé—´æ¢å›é«˜æ•ˆçš„éƒ¨åˆ†é‡åŒæ­¥ï¼Œæ”¶ç›Šæ¯”å¾ˆå¤§ã€‚</p>
<h4 id="2-é›†ç¾¤"><a href="#2-é›†ç¾¤" class="headerlink" title="2.é›†ç¾¤"></a>2.é›†ç¾¤</h4><p>Redisçš„å®˜æ–¹ç‰ˆé›†ç¾¤å°šæœªåœ¨å·¥ä¸šç•Œæ™®åŠèµ·æ¥ï¼Œä¸‹é¢ä¸»è¦ä»‹ç»ä¸€ä¸‹é›†ç¾¤çš„ç®¡ç†ä½“ç³»å’Œè¿è½¬ä½“ç³»ã€‚</p>
<h5 id="2-1-slot-é›†ç¾¤å•ä½"><a href="#2-1-slot-é›†ç¾¤å•ä½" class="headerlink" title="2.1 slot-é›†ç¾¤å•ä½"></a>2.1 slot-é›†ç¾¤å•ä½</h5><p>é›†ç¾¤çš„æ•°æ®åŒºç”±slotç»„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£çš„slotæ˜¯åœ¨é›†ç¾¤å¯åŠ¨æ—¶åˆ†é…çš„ã€‚</p>
<h5 id="2-2-å®¢æˆ·è¯·æ±‚"><a href="#2-2-å®¢æˆ·è¯·æ±‚" class="headerlink" title="2.2 å®¢æˆ·è¯·æ±‚"></a>2.2 å®¢æˆ·è¯·æ±‚</h5><p>å®¢æˆ·è¯·æ±‚æ—¶å¦‚æœç›¸åº”æ•°æ®hashåä¸å±äºè¯·æ±‚èŠ‚ç‚¹æ‰€ç®¡ç†çš„slotsï¼Œä¼šç»™å®¢æˆ·è¿”å›MOVEDé”™è¯¯ï¼Œå¹¶ç»™å‡ºæ­£ç¡®çš„slotsã€‚<br>ä»è¿™ä¸ªå±‚é¢çœ‹ï¼Œredisçš„é›†ç¾¤è¿˜ä¸å¤Ÿå‹å¥½ï¼Œé›†ç¾¤å†…éƒ¨çš„çŠ¶æ€å¿…é¡»ç”±å®¢æˆ·æ„ŸçŸ¥ã€‚</p>
<h5 id="2-3-å®¹ç¾"><a href="#2-3-å®¹ç¾" class="headerlink" title="2.3 å®¹ç¾"></a>2.3 å®¹ç¾</h5><p>ä¸»ä»æœåŠ¡å™¨ï¼Œä»ç”¨äºå¤‡ä»½ä¸»ï¼Œä¸€æ—¦ä¸»æ•…éšœï¼Œä»ä»£æ›¿ä¸»ã€‚</p>
<p>é€šè¿‡Redisçš„ç ”ç©¶ï¼Œæ·±åˆ»ä½“ä¼šåˆ°çš„ä¸€ç‚¹å°±æ˜¯ï¼šæ‰€æœ‰è®¾è®¡çš„è¿‡ç¨‹éƒ½æ˜¯æƒè¡¡å’Œå‰²èˆçš„è¿‡ç¨‹ã€‚åŒæ ·æ”¾åˆ°æ—¥å¸¸çš„å·¥ä½œå’Œå¼€å‘ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¸€å¥ä»£ç å†™çš„å¥½ä¸å¥½ï¼Œä¸€ä¸ªæ¨¡å—è®¾è®¡çš„æ˜¯å¦ç§‘å­¦ï¼Œå°±ä»é€Ÿåº¦å’Œå†…å­˜çš„è§’åº¦å»è¡¡é‡çœ‹æ˜¯å¦éœ€è¦ä¼˜åŒ–ï¼Œå¹¶å»è¯„ä¼°æ¯ä¸€ç§ä¼˜åŒ–ä¼šæ”¶ç›Šåˆ°ä»€ä¹ˆï¼ŒåŒæ—¶ä¼šæŸå¤±ä»€ä¹ˆï¼Œæ”¶ç›Šè¿œå¤§äºæŸå¤±çš„å°±æ˜¯å¥½çš„ä¼˜åŒ–ï¼Œè¿™æ ·å¾€å¾€å¯¹äºå¼€å‘å’Œæå‡æ›´æœ‰é’ˆå¯¹æ€§ï¼Œæ›´èƒ½æé«˜æ•ˆç‡ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Java å•ä¾‹æ¨¡å¼çš„äº”ç§å†™æ³•]]></title>
      <url>http://zsr.github.io/2016/12/10/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<p>å•ä¾‹æ¨¡å¼ä½œä¸ºå¯¹è±¡çš„ä¸€ç§åˆ›å»ºæ¨¡å¼ï¼Œå®ƒçš„ä½œç”¨æ˜¯ç¡®ä¿æŸä¸€ä¸ªç±»åœ¨æ•´ä¸ªç³»ç»Ÿä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œè€Œä¸”è‡ªè¡Œå®ä¾‹åŒ–å¹¶å‘æ•´ä¸ªç³»ç»Ÿæä¾›è¿™ä¸ªå®ä¾‹ã€‚</p>
<p>ç”±æ­¤å¯è§ï¼Œå•ä¾‹æ¨¡å¼å…·æœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š</p>
<ol>
<li>å•ä¾‹ç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ã€‚</li>
<li>å•ä¾‹ç±»å¿…é¡»è‡ªå·±åˆ›å»ºè‡ªå·±çš„å”¯ä¸€çš„å®ä¾‹ã€‚</li>
<li>å•ä¾‹ç±»å¿…é¡»ç»™æ‰€æœ‰å…¶ä»–å¯¹è±¡æä¾›è¿™ä¸€å®ä¾‹ã€‚</li>
</ol>
<p>ç”±äºJavaè¯­è¨€çš„ç‰¹ç‚¹ï¼Œä½¿å¾—å•ä¾‹æ¨¡å¼åœ¨Javaè¯­è¨€çš„å®ç°ä¸Šæœ‰è‡ªå·±çš„ç‰¹ç‚¹ã€‚è¿™äº›ç‰¹ç‚¹ä¸»è¦è¡¨ç°åœ¨å•ä¾‹ç±»å¦‚ä½•å°†è‡ªå·±å®ä¾‹åŒ–ã€‚</p>
<h3 id="é¥¿æ±‰å¼å•ä¾‹ç±»"><a href="#é¥¿æ±‰å¼å•ä¾‹ç±»" class="headerlink" title="é¥¿æ±‰å¼å•ä¾‹ç±»"></a><strong>é¥¿æ±‰å¼å•ä¾‹ç±»</strong></h3><p>é¥¿æ±‰å¼å•ä¾‹ç±»æ˜¯åœ¨Javaè¯­è¨€é‡Œå®ç°èµ·æ¥æœ€ä¸ºç®€ä¾¿çš„å•ä¾‹ç±»ã€‚å…¶æºä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EagerSingleton</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/** é€šè¿‡é™æ€å˜é‡åˆå§‹åŒ–çš„ç±»å®ä¾‹ */</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> EagerSingleton instance = <span class="keyword">new</span> EagerSingleton();</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * ç§æœ‰çš„é»˜è®¤æ„é€ </div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="title">EagerSingleton</span><span class="params">()</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * è·å–å”¯ä¸€ç±»å®ä¾‹çš„é™æ€å·¥å‚æ–¹æ³•</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@return</span></div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EagerSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> instance;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”±Javaè¯­è¨€ç±»çš„åˆå§‹åŒ–é¡ºåºå¯çŸ¥ï¼Œåœ¨è¿™ä¸ªç±»è¢«åŠ è½½æ—¶ï¼Œé™æ€å˜é‡ä¼šè¢«åˆå§‹åŒ–ï¼Œæ­¤æ—¶ç±»çš„ç§æœ‰æ„é€ ä¼šè¢«è°ƒç”¨ã€‚è¿™æ—¶å€™ï¼Œå•ä¾‹ç±»çš„å”¯ä¸€å®ä¾‹å°±è¢«åˆ›å»ºå‡ºæ¥äº†ã€‚</p>
<p><strong>Javaè¯­è¨€ä¸­å•ä¾‹ç±»çš„ä¸€ä¸ªæœ€é‡è¦çš„ç‰¹ç‚¹æ˜¯ç±»çš„æ„é€ æ˜¯ç§æœ‰çš„</strong>ï¼Œä»è€Œé¿å…å¤–ç•Œä½¿ç”¨æ„é€ å­ç›´æ¥åˆ›å»ºå‡ºä»»æ„å¤šè¯¥ç±»çš„å®ä¾‹ã€‚å€¼å¾—æŒ‡å‡ºçš„æ˜¯ï¼Œç”±äºæ„é€ æ˜¯ç§æœ‰çš„ï¼Œå› æ­¤è¯¥ç±»ä¸èƒ½è¢«ç»§æ‰¿ã€‚</p>
<h3 id="æ‡’æ±‰å¼å•ä¾‹ç±»"><a href="#æ‡’æ±‰å¼å•ä¾‹ç±»" class="headerlink" title="æ‡’æ±‰å¼å•ä¾‹ç±»"></a><strong>æ‡’æ±‰å¼å•ä¾‹ç±»</strong></h3><p>ä¸é¥¿æ±‰å¼å•ä¾‹ç±»ç›¸åŒä¹‹å¤„æ˜¯ï¼Œæ‡’æ±‰å¼å•ä¾‹ç±»çš„æ„é€ ä¹Ÿæ˜¯ç§æœ‰çš„ã€‚è€Œä¸é¥¿æ±‰å¼å•ä¾‹ç±»ä¸åŒçš„æ˜¯ï¼Œæ‡’æ±‰å¼å•ä¾‹ç±»åœ¨ç¬¬ä¸€æ¬¡è¢«å¼•ç”¨æ—¶å°†è‡ªå·±å®ä¾‹åŒ–ã€‚åœ¨æ‡’æ±‰å¼å•ä¾‹ç±»è¢«åŠ è½½æ—¶ï¼Œä¸ä¼šå°†è‡ªå·±å®ä¾‹åŒ–ã€‚å…¶æºä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazySingleton</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * æ­¤æ—¶é™æ€å˜é‡ä¸èƒ½å£°æ˜ä¸ºfinalï¼Œå› ä¸ºéœ€è¦åœ¨å·¥å‚æ–¹æ³•ä¸­å¯¹å®ƒè¿›è¡Œå®ä¾‹åŒ–</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> LazySingleton instance;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * ç§æœ‰æ„é€ ï¼Œç¡®ä¿æ— æ³•åœ¨ç±»å¤–å®ä¾‹åŒ–è¯¥ç±»</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="title">LazySingleton</span><span class="params">()</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * synchronizedå…³é”®å­—è§£å†³å¤šä¸ªçº¿ç¨‹çš„åŒæ­¥é—®é¢˜</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> LazySingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">			instance = <span class="keyword">new</span> LazySingleton();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> instance;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹singletonå¯¹è±¡ä½¿ç”¨volatileå…³é”®å­—è¿›è¡Œé™åˆ¶ï¼Œä¿è¯å…¶å¯¹æ‰€æœ‰çº¿ç¨‹çš„å¯è§æ€§ï¼Œå¹¶ä¸”ç¦æ­¢å¯¹å…¶è¿›è¡ŒæŒ‡ä»¤é‡æ’åºä¼˜åŒ–; é™æ€å·¥å‚æ–¹æ³•ä¸­synchronizedå…³é”®å­—æä¾›çš„åŒæ­¥æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®è¯¥æ–¹æ³•æ—¶ï¼Œæ— æ³•ç¡®ä¿è·å¾—çš„æ€»æ˜¯åŒä¸€ä¸ªå®ä¾‹ã€‚ç„¶è€Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°ï¼Œåœ¨æ‰€æœ‰çš„ä»£ç è·¯å¾„ä¸­ï¼Œè™½ç„¶åªæœ‰ç¬¬ä¸€æ¬¡å¼•ç”¨çš„æ—¶å€™éœ€è¦å¯¹instanceå˜é‡è¿›è¡Œå®ä¾‹åŒ–ï¼Œä½†æ˜¯synchronizedåŒæ­¥æœºåˆ¶è¦æ±‚æ‰€æœ‰çš„ä»£ç æ‰§è¡Œè·¯å¾„éƒ½å¿…é¡»å…ˆè·å–ç±»é”ã€‚åœ¨å¹¶å‘è®¿é—®æ¯”è¾ƒä½æ—¶ï¼Œæ•ˆæœå¹¶ä¸æ˜¾è‘—ï¼Œä½†æ˜¯å½“å¹¶å‘è®¿é—®é‡ä¸Šå‡æ—¶ï¼Œè¿™é‡Œæœ‰å¯èƒ½ä¼šæˆä¸ºå¹¶å‘è®¿é—®çš„ç“¶é¢ˆã€‚</p>
<h3 id="åŒé‡æ£€æŸ¥é”"><a href="#åŒé‡æ£€æŸ¥é”" class="headerlink" title="åŒé‡æ£€æŸ¥é”"></a><strong>åŒé‡æ£€æŸ¥é”</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton singleton = <span class="keyword">null</span>;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span></span>&#123;&#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getSingleton</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(singleton == <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">synchronized</span> (Singleton.class)&#123;</div><div class="line">                <span class="keyword">if</span>(singleton == <span class="keyword">null</span>)&#123;</div><div class="line">                    singleton = <span class="keyword">new</span> Singleton();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> singleton;</div><div class="line">    &#125;    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ç§å†™æ³•è¢«ç§°ä¸ºâ€œåŒé‡æ£€æŸ¥é”â€ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åœ¨getSingleton()æ–¹æ³•ä¸­ï¼Œè¿›è¡Œä¸¤æ¬¡nullæ£€æŸ¥ã€‚çœ‹ä¼¼å¤šæ­¤ä¸€ä¸¾ï¼Œä½†å®é™…ä¸Šå´æå¤§æå‡äº†å¹¶å‘åº¦ï¼Œè¿›è€Œæå‡äº†æ€§èƒ½ã€‚ä¸ºä»€ä¹ˆå¯ä»¥æé«˜å¹¶å‘åº¦å‘¢ï¼Ÿå°±åƒä¸Šæ–‡è¯´çš„ï¼Œåœ¨å•ä¾‹ä¸­newçš„æƒ…å†µéå¸¸å°‘ï¼Œç»å¤§å¤šæ•°éƒ½æ˜¯å¯ä»¥å¹¶è¡Œçš„è¯»æ“ä½œã€‚å› æ­¤åœ¨åŠ é”å‰å¤šè¿›è¡Œä¸€æ¬¡nullæ£€æŸ¥å°±å¯ä»¥å‡å°‘ç»å¤§å¤šæ•°çš„åŠ é”æ“ä½œï¼Œæ‰§è¡Œæ•ˆç‡æé«˜çš„ç›®çš„ä¹Ÿå°±è¾¾åˆ°äº†ã€‚</p>
<p><strong>å‘:</strong> volatileè¿™ä¸ªå…³é”®å­—ã€‚å…¶å®è¿™ä¸ªå…³é”®å­—æœ‰ä¸¤å±‚è¯­ä¹‰ã€‚ç¬¬ä¸€å±‚è¯­ä¹‰å°±æ˜¯å¯è§æ€§ã€‚å¯è§æ€§æŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¯¹è¯¥å˜é‡çš„ä¿®æ”¹ä¼šé©¬ä¸Šç”±å·¥ä½œå†…å­˜ï¼ˆWork Memoryï¼‰å†™å›ä¸»å†…å­˜ï¼ˆMain Memoryï¼‰ï¼Œæ‰€ä»¥ä¼šé©¬ä¸Šååº”åœ¨å…¶å®ƒçº¿ç¨‹çš„è¯»å–æ“ä½œä¸­.volatileçš„ç¬¬äºŒå±‚è¯­ä¹‰æ˜¯ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ã€‚æˆ‘ä»¬å†™çš„ä»£ç ï¼ˆå°¤å…¶æ˜¯å¤šçº¿ç¨‹ä»£ç ï¼‰ï¼Œç”±äºç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œåœ¨å®é™…æ‰§è¡Œçš„æ—¶å€™å¯èƒ½ä¸æˆ‘ä»¬ç¼–å†™çš„é¡ºåºä¸åŒã€‚ç¼–è¯‘å™¨åªä¿è¯ç¨‹åºæ‰§è¡Œç»“æœä¸æºä»£ç ç›¸åŒï¼Œå´ä¸ä¿è¯å®é™…æŒ‡ä»¤çš„é¡ºåºä¸æºä»£ç ç›¸åŒ,å¼•å…¥å¤šçº¿ç¨‹è¿™ç§ä¹±åºå°±å¯èƒ½å¯¼è‡´ä¸¥é‡é—®é¢˜.</p>
<p>ç¦æ­¢æŒ‡ä»¤é‡æ’ä¼˜åŒ–è¿™æ¡è¯­ä¹‰ç›´åˆ°jdk1.5ä»¥åæ‰èƒ½æ­£ç¡®å·¥ä½œã€‚æ­¤å‰çš„JDKä¸­å³ä½¿å°†å˜é‡å£°æ˜ä¸ºvolatileä¹Ÿæ— æ³•å®Œå…¨é¿å…é‡æ’åºæ‰€å¯¼è‡´çš„é—®é¢˜ã€‚æ‰€ä»¥ï¼Œåœ¨jdk1.5ç‰ˆæœ¬å‰ï¼ŒåŒé‡æ£€æŸ¥é”å½¢å¼çš„å•ä¾‹æ¨¡å¼æ˜¯æ— æ³•ä¿è¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<h3 id="é™æ€å†…éƒ¨å†…"><a href="#é™æ€å†…éƒ¨å†…" class="headerlink" title="é™æ€å†…éƒ¨å†…"></a><strong>é™æ€å†…éƒ¨å†…</strong></h3><p>è¿™ç§å•ä¾‹æ¨¡å¼çš„å†™æ³•ï¼Œæ˜¯è‘—åçš„ã€ŠJava Concurrency in Practiceã€‹ä¸€ä¹¦ä¸­ä»‹ç»å¯¹è±¡çš„å®‰å…¨å‘å¸ƒæ—¶ä»‹ç»çš„ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹å®ƒçš„æºä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceFactory</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceHolder</span> </span>&#123;</div><div class="line">		<span class="keyword">public</span> <span class="keyword">static</span> Resource resource = <span class="keyword">new</span> Resource();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Resource <span class="title">getResource</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> ResourceHolder.resource;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¦ç†è§£ä¸Šé¢è¿™ç§å•ä¾‹ç±»çš„å†™æ³•ï¼Œä½ éœ€è¦å…ˆå­¦ä¹ ä¸€äº›å…³äºJavaè™šæ‹Ÿæœºå¦‚ä½•åˆå§‹åŒ–ä¸€ä¸ªç±»çš„çŸ¥è¯†ã€‚</p>
<p>åœ¨javaè™šæ‹Ÿæœºä¸­ï¼Œç±»ä»è¢«åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­å¼€å§‹ï¼Œåˆ°å¸è½½å‡ºå†…å­˜ä¸ºæ­¢ï¼Œå®ƒçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬äº†ï¼šåŠ è½½ï¼ˆLoadingï¼‰ã€éªŒè¯ï¼ˆVerificationï¼‰ã€å‡†å¤‡ï¼ˆPreparationï¼‰ã€è§£æï¼ˆResolutionï¼‰ã€åˆå§‹åŒ–ï¼ˆInitializationï¼‰ã€ä½¿ç”¨ï¼ˆUsingï¼‰å’Œå¸è½½ï¼ˆUnloadingï¼‰ä¸ƒä¸ªé˜¶æ®µã€‚å…¶ä¸­ï¼ŒéªŒè¯ã€å‡†å¤‡å’Œè§£æä¸‰ä¸ªéƒ¨åˆ†ç»Ÿç§°ä¸ºè¿æ¥ï¼ˆLinkingï¼‰ã€‚</p>
<p>åŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€åˆå§‹åŒ–å’Œå¸è½½è¿™äº”ä¸ªé˜¶æ®µçš„é¡ºåºæ˜¯ç¡®å®šçš„ï¼Œç±»çš„åŠ è½½è¿‡ç¨‹å¿…é¡»æŒ‰ç…§è¿™ç§é¡ºåºæŒ‰éƒ¨å°±ç­åœ°å¼€å§‹ï¼Œè€Œè§£æé˜¶æ®µåˆ™ä¸ä¸€å®šï¼šå®ƒåœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥åœ¨åˆå§‹åŒ–é˜¶æ®µä¹‹åå†å¼€å§‹ï¼Œè¿™æ˜¯ä¸ºäº†æ”¯æŒJavaè¯­è¨€çš„è¿è¡Œæ—¶ç»‘å®šï¼ˆä¹Ÿè¢«ç§°ä¸ºåŠ¨æ€ç»‘å®šæˆ–æ™šæœŸç»‘å®šï¼‰ã€‚</p>
<p>ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å¼€å§‹ç±»åŠ è½½çš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼šåŠ è½½ã€‚è™šæ‹Ÿæœºè§„èŒƒä¸­å¹¶æ²¡æœ‰è¿›è¡Œå¼ºåˆ¶çº¦æŸï¼Œè¿™ç‚¹å¯ä»¥äº¤ç»™è™šæ‹Ÿæœºçš„å…·ä½“å®ç°æ¥è‡ªç”±æŠŠæ¡ã€‚ä½†æ˜¯å¯¹äºåˆå§‹åŒ–é˜¶æ®µï¼Œè™šæ‹Ÿæœºè§„èŒƒåˆ™æ˜¯ä¸¥æ ¼è§„å®šäº†æœ‰ä¸”åªæœ‰å››ç§æƒ…å†µå¿…é¡»ç«‹å³å¯¹ç±»è¿›è¡Œâ€œåˆå§‹åŒ–â€ï¼ˆè€ŒåŠ è½½ã€éªŒè¯ã€å‡†å¤‡è‡ªç„¶éœ€è¦åœ¨æ­¤ä¹‹å‰å¼€å§‹ï¼‰ï¼š</p>
<p>1ï¼‰é‡åˆ°newã€getstaticã€putstaticæˆ–invokestaticè¿™å››æ¡å­—èŠ‚ç æŒ‡ä»¤æ—¶ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚ç”Ÿæˆè¿™å››æ¡å­—èŠ‚ç æŒ‡ä»¤æœ€å¸¸è§çš„Javaä»£ç åœºæ™¯æ˜¯ï¼šä½¿ç”¨newå…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™ã€è¯»å–æˆ–è®¾ç½®ä¸€ä¸ªç±»çš„é™æ€å­—æ®µï¼ˆè¢«finalä¿®é¥°ã€å·²åœ¨ç¼–è¯‘æœŸæŠŠç»“æœæ”¾å…¥å¸¸é‡æ± çš„é™æ€å­—æ®µé™¤å¤–ï¼‰çš„æ—¶å€™ï¼Œä»¥åŠè°ƒç”¨ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•çš„æ—¶å€™ã€‚</p>
<p>2ï¼‰ä½¿ç”¨java.lang.reflectåŒ…çš„æ–¹æ³•å¯¹ç±»è¿›è¡Œåå°„è°ƒç”¨çš„æ—¶å€™ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚</p>
<p>3ï¼‰å½“åˆå§‹åŒ–ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶çˆ¶ç±»è¿˜æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶çˆ¶ç±»çš„åˆå§‹åŒ–ã€‚</p>
<p>4ï¼‰å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œç”¨æˆ·éœ€è¦æŒ‡å®šä¸€ä¸ªè¦æ‰§è¡Œçš„ä¸»ç±»ï¼ˆåŒ…å«mainï¼ˆï¼‰æ–¹æ³•çš„é‚£ä¸ªç±»ï¼‰ï¼Œè™šæ‹Ÿæœºä¼šå…ˆåˆå§‹åŒ–è¿™ä¸ªä¸»ç±»ã€‚</p>
<p>è¿™å››ç§åœºæ™¯ä¸­çš„è¡Œä¸ºç§°ä¸ºå¯¹ä¸€ä¸ªç±»è¿›è¡Œä¸»åŠ¨å¼•ç”¨ï¼Œé™¤æ­¤ä¹‹å¤–æ‰€æœ‰å¼•ç”¨ç±»çš„æ–¹å¼ï¼Œéƒ½ä¸ä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–ï¼Œè¢«ç§°ä¸ºè¢«åŠ¨å¼•ç”¨ã€‚ä»¥ä¸‹æ˜¯ä¸‰ä¸ªä¾‹å­ï¼š</p>
<p>1ï¼‰é€šè¿‡å­ç±»å¼•ç”¨çˆ¶ç±»çš„é™æ€å­—æ®µï¼Œä¸ä¼šå¯¼è‡´å­ç±»åˆå§‹åŒ–ã€‚</p>
<p>2ï¼‰é€šè¿‡æ•°ç»„å®šä¹‰æ¥å¼•ç”¨ç±»ï¼Œä¸ä¼šè§¦å‘æ­¤ç±»çš„åˆå§‹åŒ–ã€‚</p>
<p>3ï¼‰å¸¸é‡åœ¨ç¼–è¯‘é˜¶æ®µä¼šå­˜å…¥è°ƒç”¨ç±»çš„å¸¸é‡æ± ï¼Œæœ¬è´¨ä¸Šæ²¡æœ‰ç›´æ¥å¼•ç”¨åˆ°å®šä¹‰å¸¸é‡çš„ç±»ï¼Œå› æ­¤ä¸ä¼šè§¦å‘å®šä¹‰å¸¸é‡çš„ç±»çš„åˆå§‹åŒ–ã€‚</p>
<p>ï¼ˆä»¥ä¸Šæ‘˜è‡ªã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ï¼‰</p>
<p>ä»ä¸Šé¢ä»‹ç»çš„çŸ¥è¯†å¯ä»¥çŸ¥é“ï¼ŒJVMå°†æ¨è¿ŸResourceHolderç±»çš„åˆå§‹åŒ–ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªä»£ç è®¿é—®è·¯å¾„è°ƒç”¨getResource()æ–¹æ³•ã€‚æ­¤æ—¶ï¼Œç”±äºResourceHolder.resourceæ˜¯ä¸€ä¸ªè¯»å–é™æ€å­—æ®µçš„ä¸»åŠ¨å¼•ç”¨ï¼Œè™šæ‹Ÿæœºå°†ç¬¬ä¸€æ¬¡åŠ è½½ResourceHolderç±»ï¼Œå¹¶ä¸”é€šè¿‡ä¸€ä¸ªé™æ€å˜é‡æ¥åˆå§‹åŒ–Resourceå®ä¾‹ã€‚è€Œå…¶ä»–è®¿é—®getResource()æ–¹æ³•çš„ä»£ç è·¯å¾„ï¼Œå¹¶ä¸éœ€è¦åŒæ­¥ã€‚</p>
<p>ä¸éœ€è¦é¢å¤–çš„åŒæ­¥ï¼Œä½†æ˜¯åˆèƒ½ç¡®ä¿å¯¹è±¡å¯è§æ€§çš„æ­£ç¡®å‘å¸ƒï¼Œè¿™æ˜¯ç”±Javaçš„è™šæ‹Ÿæœºè§„èŒƒæ‰€å†³å®šçš„ï¼ä¸Šé¢è¿™ç§å•ä¾‹æ¨¡å¼çš„å†™æ³•ï¼Œä½“ç°å‡ºå¯¹è™šæ‹Ÿæœºè§„èŒƒçš„æ·±åˆ»ç†è§£ï¼Œå®åœ¨æ˜¯ä¸“å®¶çº§åˆ«çš„å†™æ³•ã€‚</p>
<p><strong>æ³¨æ„</strong>:ä¸Šé¢æåˆ°çš„æ‰€æœ‰å®ç°æ–¹å¼éƒ½æœ‰ä¸¤ä¸ªå…±åŒçš„ç¼ºç‚¹ï¼š</p>
<ul>
<li>éƒ½éœ€è¦é¢å¤–çš„å·¥ä½œ(Serializableã€transientã€readResolve())æ¥å®ç°åºåˆ—åŒ–ï¼Œå¦åˆ™æ¯æ¬¡ååºåˆ—åŒ–ä¸€ä¸ªåºåˆ—åŒ–çš„å¯¹è±¡å®ä¾‹æ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚</li>
<li>å¯èƒ½ä¼šæœ‰äººä½¿ç”¨åå°„å¼ºè¡Œè°ƒç”¨æˆ‘ä»¬çš„ç§æœ‰æ„é€ å™¨ï¼ˆå¦‚æœè¦é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥ä¿®æ”¹æ„é€ å™¨ï¼Œè®©å®ƒåœ¨åˆ›å»ºç¬¬äºŒä¸ªå®ä¾‹çš„æ—¶å€™æŠ›å¼‚å¸¸ï¼‰ã€‚</li>
</ul>
<h3 id="æšä¸¾å†™æ³•-æ¨è"><a href="#æšä¸¾å†™æ³•-æ¨è" class="headerlink" title="æšä¸¾å†™æ³•(æ¨è)"></a><strong>æšä¸¾å†™æ³•</strong>(æ¨è)</h3><p>åªèƒ½åŒ…å«å•ä¸ªå…ƒç´ çš„æšä¸¾ç±»å‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Singleton &#123;</div><div class="line">    INSTANCE; <span class="comment">//å®šä¹‰ä¸€ä¸ªæšä¸¾çš„å…ƒç´ ï¼Œå°±ä»£è¡¨Singletonçš„ä¸€ä¸ªå®ä¾‹</span></div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨æšä¸¾é™¤äº†çº¿ç¨‹å®‰å…¨å’Œé˜²æ­¢åå°„å¼ºè¡Œè°ƒç”¨æ„é€ å™¨ä¹‹å¤–ï¼Œè¿˜æä¾›äº†è‡ªåŠ¨åºåˆ—åŒ–æœºåˆ¶ï¼Œé˜²æ­¢ååºåˆ—åŒ–çš„æ—¶å€™åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚å› æ­¤ï¼Œ<a href="http://www.amazon.com/gp/product/B000WJOUPA/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B000WJOUPA&amp;linkCode=as2&amp;tag=job0ae-20" target="_blank" rel="external">Effective Java</a>æ¨èå°½å¯èƒ½åœ°ä½¿ç”¨æšä¸¾æ¥å®ç°å•ä¾‹ã€‚</p>
<p>è°ƒç”¨æ–¹å¼ï¼šSingleton.INSTANCE.getName();</p>
<p>æœ€åï¼Œä¸ç®¡é‡‡å–ä½•ç§æ–¹æ¡ˆï¼Œè¯·æ—¶åˆ»ç‰¢è®°å•ä¾‹çš„ä¸‰å¤§è¦ç‚¹ï¼š</p>
<ul>
<li><strong>çº¿ç¨‹å®‰å…¨</strong></li>
<li><strong>å»¶è¿ŸåŠ è½½</strong></li>
<li><strong>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–å®‰å…¨</strong></li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ThreadLocal]]></title>
      <url>http://zsr.github.io/2016/12/10/ThreadLocal/</url>
      <content type="html"><![CDATA[<p><code>Synchronized</code>è¿™ç±»çº¿ç¨‹åŒæ­¥çš„æœºåˆ¶å¯ä»¥è§£å†³å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜ï¼Œåœ¨è¿™ç§è§£å†³æ–¹æ¡ˆä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹è®¿é—®åˆ°çš„ï¼Œéƒ½æ˜¯åŒä¸€ä»½å˜é‡çš„å†…å®¹ã€‚ä¸ºäº†é˜²æ­¢åœ¨å¤šçº¿ç¨‹è®¿é—®çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°çš„å¹¶å‘é”™è¯¯ã€‚ä¸å¾—ä¸å¯¹å¤šä¸ªçº¿ç¨‹çš„è®¿é—®è¿›è¡ŒåŒæ­¥ï¼Œè¿™æ ·ä¹Ÿå°±æ„å‘³ç€ï¼Œå¤šä¸ªçº¿ç¨‹å¿…é¡»å…ˆåå¯¹å˜é‡çš„å€¼è¿›è¡Œè®¿é—®æˆ–è€…ä¿®æ”¹ï¼Œè¿™æ˜¯ä¸€ç§ä»¥å»¶é•¿è®¿é—®æ—¶é—´æ¥æ¢å–çº¿ç¨‹å®‰å…¨æ€§çš„ç­–ç•¥ã€‚</p>
<p>è€Œ<code>ThreadLocal</code>ç±»ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤äº†è‡ªå·±ç‹¬æœ‰çš„å˜é‡æ‹·è´ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰äº†è‡ªå·±ç‹¬ç«‹çš„ä¸€ä¸ªå˜é‡ï¼Œç«äº‰æ¡ä»¶è¢«å½»åº•æ¶ˆé™¤äº†ï¼Œé‚£å°±æ²¡æœ‰ä»»ä½•å¿…è¦å¯¹è¿™äº›çº¿ç¨‹è¿›è¡ŒåŒæ­¥ï¼Œå®ƒä»¬ä¹Ÿèƒ½æœ€å¤§é™åº¦çš„ç”±CPUè°ƒåº¦ï¼Œå¹¶å‘æ‰§è¡Œã€‚å¹¶ä¸”ç”±äºæ¯ä¸ªçº¿ç¨‹åœ¨è®¿é—®è¯¥å˜é‡æ—¶ï¼Œè¯»å–å’Œä¿®æ”¹çš„ï¼Œéƒ½æ˜¯è‡ªå·±ç‹¬æœ‰çš„é‚£ä¸€ä»½å˜é‡æ‹·è´ï¼Œå˜é‡è¢«å½»åº•å°é—­åœ¨æ¯ä¸ªè®¿é—®çš„çº¿ç¨‹ä¸­ï¼Œå¹¶å‘é”™è¯¯å‡ºç°çš„å¯èƒ½ä¹Ÿå®Œå…¨æ¶ˆé™¤äº†ã€‚å¯¹æ¯”å‰ä¸€ç§æ–¹æ¡ˆï¼Œè¿™æ˜¯ä¸€ç§ä»¥ç©ºé—´æ¥æ¢å–çº¿ç¨‹å®‰å…¨æ€§çš„ç­–ç•¥ã€‚</p>
<p>æ¥çœ‹ä¸€ä¸ªè¿ç”¨ThreadLocalæ¥å®ç°æ•°æ®åº“è¿æ¥Connectionå¯¹è±¡çº¿ç¨‹éš”ç¦»çš„ä¾‹å­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.sql.Connection;</div><div class="line"><span class="keyword">import</span> java.sql.DriverManager;</div><div class="line"><span class="keyword">import</span> java.sql.SQLException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionManager</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;Connection&gt; connectionHolder = <span class="keyword">new</span> ThreadLocal&lt;Connection&gt;() &#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> Connection <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">			Connection conn = <span class="keyword">null</span>;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				conn = DriverManager.getConnection(</div><div class="line">						<span class="string">"jdbc:mysql://localhost:3306/test"</span>, <span class="string">"username"</span>,</div><div class="line">						<span class="string">"password"</span>);</div><div class="line">			&#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> conn;</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> connectionHolder.get();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setConnection</span><span class="params">(Connection conn)</span> </span>&#123;</div><div class="line">		connectionHolder.set(conn);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡è°ƒç”¨ConnectionManager.getConnection()æ–¹æ³•ï¼Œæ¯ä¸ªçº¿ç¨‹è·å–åˆ°çš„ï¼Œéƒ½æ˜¯å’Œå½“å‰çº¿ç¨‹ç»‘å®šçš„é‚£ä¸ªConnectionå¯¹è±¡ï¼Œç¬¬ä¸€æ¬¡è·å–æ—¶ï¼Œæ˜¯é€šè¿‡initialValue()æ–¹æ³•çš„è¿”å›å€¼æ¥è®¾ç½®å€¼çš„ã€‚é€šè¿‡ConnectionManager.setConnection(Connection conn)æ–¹æ³•è®¾ç½®çš„Connectionå¯¹è±¡ï¼Œä¹Ÿåªä¼šå’Œå½“å‰çº¿ç¨‹ç»‘å®šã€‚è¿™æ ·å°±å®ç°äº†Connectionå¯¹è±¡åœ¨å¤šä¸ªçº¿ç¨‹ä¸­çš„å®Œå…¨éš”ç¦»ã€‚åœ¨Springå®¹å™¨ä¸­ç®¡ç†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„Connectionå¯¹è±¡æ—¶ï¼Œé‡‡ç”¨çš„æ€è·¯å’Œä»¥ä¸Šä»£ç éå¸¸ç›¸ä¼¼ã€‚</p>
<p>åˆ°åº•ThreadLocalç±»æ˜¯å¦‚ä½•å®ç°è¿™ç§â€œä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ä¸åŒçš„å˜é‡æ‹·è´â€çš„å‘¢ï¼Ÿå…ˆæ¥çœ‹ä¸€ä¸‹ThreadLocalçš„set()æ–¹æ³•çš„æºç æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Â  Â  <span class="comment">/**</span></div><div class="line">Â  Â  Â * Sets the current thread's copy of this thread-local variable</div><div class="line">Â  Â  Â * to the specified value. Â Most subclasses will have no need toÂ </div><div class="line">Â  Â  Â * override this method, relying solely on the &#123;<span class="doctag">@link</span> #initialValue&#125;</div><div class="line">Â  Â  Â * method to set the values of thread-locals.</div><div class="line">Â  Â  Â *</div><div class="line">Â  Â  Â * <span class="doctag">@param</span> value the value to be stored in the current thread's copy of</div><div class="line">Â  Â  Â * Â  Â  Â  Â this thread-local.</div><div class="line">Â  Â  Â */</div><div class="line">Â  Â  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</div><div class="line">Â  Â  Â  Â  Thread t = Thread.currentThread();</div><div class="line">Â  Â  Â  Â  ThreadLocalMap map = getMap(t);</div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (map != <span class="keyword">null</span>)</div><div class="line">Â  Â  Â  Â  Â  Â  map.set(<span class="keyword">this</span>, value);</div><div class="line">Â  Â  Â  Â  <span class="keyword">else</span></div><div class="line">Â  Â  Â  Â  Â  Â  createMap(t, value);</div><div class="line">Â  Â  &#125;</div></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªæ–¹æ³•å†…éƒ¨æˆ‘ä»¬çœ‹åˆ°ï¼Œé¦–å…ˆé€šè¿‡getMap(Thread t)æ–¹æ³•è·å–ä¸€ä¸ªå’Œå½“å‰çº¿ç¨‹ç›¸å…³çš„ThreadLocalMapï¼Œç„¶åå°†å˜é‡çš„å€¼è®¾ç½®åˆ°è¿™ä¸ªThreadLocalMapå¯¹è±¡ä¸­ï¼Œå½“ç„¶å¦‚æœè·å–åˆ°çš„ThreadLocalMapå¯¹è±¡ä¸ºç©ºï¼Œå°±é€šè¿‡createMapæ–¹æ³•åˆ›å»ºã€‚</p>
<p>çº¿ç¨‹éš”ç¦»çš„ç§˜å¯†ï¼Œå°±åœ¨äºThreadLocalMapè¿™ä¸ªç±»ã€‚<strong>ThreadLocalMapæ˜¯ThreadLocalç±»çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œå®ƒå®ç°äº†é”®å€¼å¯¹çš„è®¾ç½®å’Œè·å–ï¼ˆå¯¹æ¯”Mapå¯¹è±¡æ¥ç†è§£ï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ThreadLocalMapå‰¯æœ¬ï¼Œå®ƒæ‰€å­˜å‚¨çš„å€¼ï¼Œåªèƒ½è¢«å½“å‰çº¿ç¨‹è¯»å–å’Œä¿®æ”¹ã€‚ThreadLocalç±»é€šè¿‡æ“ä½œæ¯ä¸€ä¸ªçº¿ç¨‹ç‰¹æœ‰çš„ThreadLocalMapå‰¯æœ¬ï¼Œä»è€Œå®ç°äº†å˜é‡è®¿é—®åœ¨ä¸åŒçº¿ç¨‹ä¸­çš„éš”ç¦»ã€‚å› ä¸ºæ¯ä¸ªçº¿ç¨‹çš„å˜é‡éƒ½æ˜¯è‡ªå·±ç‰¹æœ‰çš„ï¼Œå®Œå…¨ä¸ä¼šæœ‰å¹¶å‘é”™è¯¯ã€‚è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯ï¼ŒThreadLocalMapå­˜å‚¨çš„é”®å€¼å¯¹ä¸­çš„é”®æ˜¯thiså¯¹è±¡æŒ‡å‘çš„ThreadLocalå¯¹è±¡ï¼Œè€Œå€¼å°±æ˜¯ä½ æ‰€è®¾ç½®çš„å¯¹è±¡äº†ã€‚</strong></p>
<p>ä¸ºäº†åŠ æ·±ç†è§£ï¼Œæˆ‘ä»¬æ¥ç€çœ‹ä¸Šé¢ä»£ç ä¸­å‡ºç°çš„getMapå’ŒcreateMapæ–¹æ³•çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> t.threadLocals;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>&#123;</div><div class="line">        t.threadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä»£ç å·²ç»è¯´çš„éå¸¸ç›´ç™½ï¼Œå°±æ˜¯è·å–å’Œè®¾ç½®Threadå†…çš„ä¸€ä¸ªå«threadLocalsçš„å˜é‡ï¼Œè€Œè¿™ä¸ªå˜é‡çš„ç±»å‹å°±æ˜¯ThreadLocalMapï¼Œè¿™æ ·è¿›ä¸€æ­¥éªŒè¯äº†ä¸Šæ–‡ä¸­çš„è§‚ç‚¹ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ThreadLocalMapå¯¹è±¡ã€‚æ‰“å¼€java.lang.Threadç±»çš„æºä»£ç ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°æ›´ç›´è§‚çš„è¯æ˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* ThreadLocal values pertaining to this thread. This map is maintained</span></div><div class="line">     * by the ThreadLocal class. */</div><div class="line">    ThreadLocal.ThreadLocalMap threadLocals = <span class="keyword">null</span>;</div></pre></td></tr></table></figure>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥å†çœ‹ä¸€ä¸‹ThreadLocalç±»ä¸­çš„get()æ–¹æ³•ï¼Œä»£ç æ˜¯è¿™ä¹ˆè¯´çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Returns the value in the current thread's copy of this</div><div class="line">     * thread-local variable.  If the variable has no value for the</div><div class="line">     * current thread, it is first initialized to the value returned</div><div class="line">     * by an invocation of the &#123;<span class="doctag">@link</span> #initialValue&#125; method.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> the current thread's value of this thread-local</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        Thread t = Thread.currentThread();</div><div class="line">        ThreadLocalMap map = getMap(t);</div><div class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">            ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</div><div class="line">            <span class="keyword">if</span> (e != <span class="keyword">null</span>)</div><div class="line">                <span class="keyword">return</span> (T)e.value;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> setInitialValue();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Variant of set() to establish initialValue. Used instead</div><div class="line">     * of set() in case user has overridden the set() method.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> the initial value</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> T <span class="title">setInitialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">        T value = initialValue();</div><div class="line">        Thread t = Thread.currentThread();</div><div class="line">        ThreadLocalMap map = getMap(t);</div><div class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span>)</div><div class="line">            map.set(<span class="keyword">this</span>, value);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            createMap(t, value);</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸¤ä¸ªæ–¹æ³•çš„ä»£ç å‘Šè¯‰æˆ‘ä»¬ï¼Œåœ¨è·å–å’Œå½“å‰çº¿ç¨‹ç»‘å®šçš„å€¼æ—¶ï¼ŒThreadLocalMapå¯¹è±¡æ˜¯ä»¥thisæŒ‡å‘çš„ThreadLocalå¯¹è±¡ä¸ºé”®è¿›è¡ŒæŸ¥æ‰¾çš„ï¼Œè¿™å½“ç„¶å’Œå‰é¢set()æ–¹æ³•çš„ä»£ç æ˜¯ç›¸å‘¼åº”çš„ã€‚</p>
<p>è¿›ä¸€æ­¥åœ°ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸åŒçš„ThreadLocalå®ä¾‹æ¥å®ç°å¤šä¸ªå˜é‡åœ¨ä¸åŒçº¿ç¨‹é—´çš„è®¿é—®éš”ç¦»ï¼Œä¸ºä»€ä¹ˆå¯ä»¥è¿™ä¹ˆåšï¼Ÿå› ä¸ºä¸åŒçš„ThreadLocalå¯¹è±¡ä½œä¸ºä¸åŒé”®ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨çº¿ç¨‹çš„ThreadLocalMapå¯¹è±¡ä¸­è®¾ç½®ä¸åŒçš„å€¼äº†ã€‚é€šè¿‡ThreadLocalå¯¹è±¡ï¼Œåœ¨å¤šçº¿ç¨‹ä¸­å…±äº«ä¸€ä¸ªå€¼å’Œå¤šä¸ªå€¼çš„åŒºåˆ«ï¼Œå°±åƒä½ åœ¨ä¸€ä¸ªHashMapå¯¹è±¡ä¸­å­˜å‚¨ä¸€ä¸ªé”®å€¼å¯¹å’Œå¤šä¸ªé”®å€¼å¯¹ä¸€æ ·ï¼Œä»…æ­¤è€Œå·²ã€‚</p>
<p>è®¾ç½®åˆ°è¿™äº›çº¿ç¨‹ä¸­çš„éš”ç¦»å˜é‡ï¼Œä¼šä¸ä¼šå¯¼è‡´å†…å­˜æ³„æ¼å‘¢ï¼ŸThreadLocalMapå¯¹è±¡ä¿å­˜åœ¨Threadå¯¹è±¡ä¸­ï¼Œå½“æŸä¸ªçº¿ç¨‹ç»ˆæ­¢åï¼Œå­˜å‚¨åœ¨å…¶ä¸­çš„çº¿ç¨‹éš”ç¦»çš„å˜é‡ï¼Œä¹Ÿå°†ä½œä¸ºThreadå®ä¾‹çš„åƒåœ¾è¢«å›æ”¶æ‰ï¼Œæ‰€ä»¥å®Œå…¨ä¸ç”¨æ‹…å¿ƒå†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚åœ¨å¤šä¸ªçº¿ç¨‹ä¸­éš”ç¦»çš„å˜é‡ï¼Œå…‰è£çš„ç”Ÿï¼Œåˆç†çš„æ­»ï¼ŒçœŸæ˜¯åœ†æ»¡ï¼Œä¸æ˜¯ä¹ˆï¼Ÿ</p>
<p>æœ€åå†æä¸€å¥ï¼ŒThreadLocalå˜é‡çš„è¿™ç§éš”ç¦»ç­–ç•¥ï¼Œä¹Ÿä¸æ˜¯ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½ä½¿ç”¨çš„ã€‚å¦‚æœå¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®çš„å¯¹è±¡å®ä¾‹åªå…è®¸ï¼Œä¹Ÿåªèƒ½åˆ›å»ºé‚£ä¹ˆä¸€ä¸ªï¼Œé‚£å°±æ²¡æœ‰åˆ«çš„åŠæ³•äº†ï¼Œè€è€å®å®çš„ä½¿ç”¨åŒæ­¥æœºåˆ¶æ¥è®¿é—®å§ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[mvc:message-converters]]></title>
      <url>http://zsr.github.io/2016/12/10/mvc-message-converters/</url>
      <content type="html"><![CDATA[<p><strong>æ‘˜è¦: SpringMVCä½¿ç”¨æ¶ˆæ¯è½¬æ¢å™¨HttpMessageConverterå®ç°è¯·æ±‚æŠ¥æ–‡å’Œå¯¹è±¡ã€å¯¹è±¡å’Œå“åº”æŠ¥æ–‡ä¹‹é—´çš„è‡ªåŠ¨è½¬æ¢</strong></p>
<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>åœ¨SpringMVCä¸­ï¼Œå¯ä»¥ä½¿ç”¨<code>@RequestBody</code>å’Œ<code>@ResponseBody</code>ä¸¤ä¸ªæ³¨è§£ï¼Œåˆ†åˆ«å®Œæˆè¯·æ±‚æŠ¥æ–‡åˆ°å¯¹è±¡å’Œå¯¹è±¡åˆ°å“åº”æŠ¥æ–‡çš„è½¬æ¢ï¼Œåº•å±‚è¿™ç§çµæ´»çš„æ¶ˆæ¯è½¬æ¢æœºåˆ¶ï¼Œå°±æ˜¯Spring3.xä¸­æ–°å¼•å…¥çš„<code>HttpMessageConverter</code>å³æ¶ˆæ¯è½¬æ¢å™¨æœºåˆ¶ã€‚</p>
<h2 id="Httpè¯·æ±‚çš„æŠ½è±¡"><a href="#Httpè¯·æ±‚çš„æŠ½è±¡" class="headerlink" title="Httpè¯·æ±‚çš„æŠ½è±¡"></a>Httpè¯·æ±‚çš„æŠ½è±¡</h2><p>è¿˜æ˜¯å›åˆ°è¯·æ±‚-å“åº”ï¼Œä¹Ÿå°±æ˜¯è§£æè¯·æ±‚ä½“ï¼Œç„¶åè¿”å›å“åº”æŠ¥æ–‡è¿™ä¸ªæœ€åŸºæœ¬çš„Httpè¯·æ±‚è¿‡ç¨‹ä¸­æ¥ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨servletæ ‡å‡†ä¸­ï¼Œå¯ä»¥ç”¨javax.servlet.ServletRequestæ¥å£ä¸­çš„ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</div></pre></td></tr></table></figure>
<p>æ¥å¾—åˆ°ä¸€ä¸ªServletInputStreamã€‚è¿™ä¸ªServletInputStreamä¸­ï¼Œå¯ä»¥è¯»å–åˆ°ä¸€ä¸ªåŸå§‹è¯·æ±‚æŠ¥æ–‡çš„æ‰€æœ‰å†…å®¹ã€‚åŒæ ·çš„ï¼Œåœ¨javax.servlet.ServletResponseæ¥å£ä¸­ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ServletOutputStream <span class="title">getOutputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</div></pre></td></tr></table></figure>
<p>æ¥å¾—åˆ°ä¸€ä¸ªServletOutputStreamï¼Œè¿™ä¸ªServletOutputSteamï¼Œç»§æ‰¿è‡ªjavaä¸­çš„OutputStreamï¼Œå¯ä»¥è®©ä½ è¾“å‡ºHttpçš„å“åº”æŠ¥æ–‡å†…å®¹ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼ŒHttpè¯·æ±‚å’Œå“åº”æŠ¥æ–‡æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸²å­—ç¬¦ä¸²ï¼Œå½“è¯·æ±‚æŠ¥æ–‡æ¥åˆ°javaä¸–ç•Œï¼Œå®ƒä¼šè¢«å°è£…æˆä¸ºä¸€ä¸ªServletInputStreamçš„è¾“å…¥æµï¼Œä¾›æˆ‘ä»¬è¯»å–æŠ¥æ–‡ã€‚å“åº”æŠ¥æ–‡åˆ™æ˜¯é€šè¿‡ä¸€ä¸ªServletOutputStreamçš„è¾“å‡ºæµï¼Œæ¥è¾“å‡ºå“åº”æŠ¥æ–‡ã€‚</p>
<p>æˆ‘ä»¬ä»æµä¸­ï¼Œåªèƒ½è¯»å–åˆ°åŸå§‹çš„å­—ç¬¦ä¸²æŠ¥æ–‡ï¼ŒåŒæ ·ï¼Œæˆ‘ä»¬å¾€è¾“å‡ºæµä¸­ï¼Œä¹Ÿåªèƒ½å†™åŸå§‹çš„å­—ç¬¦ã€‚è€Œåœ¨javaä¸–ç•Œä¸­ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œéƒ½æ˜¯ä»¥ä¸€ä¸ªä¸ªæœ‰ä¸šåŠ¡æ„ä¹‰çš„<strong>å¯¹è±¡</strong>ä¸ºå¤„ç†ç»´åº¦çš„ï¼Œé‚£ä¹ˆåœ¨æŠ¥æ–‡åˆ°è¾¾SpringMVCå’Œä»SpringMVCå‡ºå»ï¼Œéƒ½å­˜åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²åˆ°javaå¯¹è±¡çš„é˜»æŠ—é—®é¢˜ã€‚è¿™ä¸€è¿‡ç¨‹ï¼Œä¸å¯èƒ½ç”±å¼€å‘è€…æ‰‹å·¥è½¬æ¢ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨Struts2ä¸­ï¼Œé‡‡ç”¨äº†OGNLæ¥åº”å¯¹è¿™ä¸ªé—®é¢˜ï¼Œè€Œåœ¨SpringMVCä¸­ï¼Œå®ƒæ˜¯HttpMessageConverteræœºåˆ¶ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸¤ä¸ªæ¥å£ã€‚</p>
<h3 id="HttpInputMessage"><a href="#HttpInputMessage" class="headerlink" title="HttpInputMessage"></a>HttpInputMessage</h3><p>è¿™ä¸ªç±»æ˜¯SpringMVCå†…éƒ¨å¯¹ä¸€æ¬¡Httpè¯·æ±‚æŠ¥æ–‡çš„æŠ½è±¡ï¼Œåœ¨HttpMessageConverterçš„read()æ–¹æ³•ä¸­ï¼Œæœ‰ä¸€ä¸ªHttpInputMessageçš„å½¢å‚ï¼Œå®ƒæ­£æ˜¯SpringMVCçš„æ¶ˆæ¯è½¬æ¢å™¨æ‰€ä½œç”¨çš„å—ä½“â€œè¯·æ±‚æ¶ˆæ¯â€çš„å†…éƒ¨æŠ½è±¡ï¼Œæ¶ˆæ¯è½¬æ¢å™¨ä»â€œè¯·æ±‚æ¶ˆæ¯â€ä¸­æŒ‰ç…§è§„åˆ™æå–æ¶ˆæ¯ï¼Œè½¬æ¢ä¸ºæ–¹æ³•å½¢å‚ä¸­å£°æ˜çš„å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.springframework.http;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HttpInputMessage</span> <span class="keyword">extends</span> <span class="title">HttpMessage</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">InputStream <span class="title">getBody</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="HttpOutputMessage"><a href="#HttpOutputMessage" class="headerlink" title="HttpOutputMessage"></a>HttpOutputMessage</h3><p>è¿™ä¸ªç±»æ˜¯SpringMVCå†…éƒ¨å¯¹ä¸€æ¬¡Httpå“åº”æŠ¥æ–‡çš„æŠ½è±¡ï¼Œåœ¨HttpMessageConverterçš„write()æ–¹æ³•ä¸­ï¼Œæœ‰ä¸€ä¸ªHttpOutputMessageçš„å½¢å‚ï¼Œå®ƒæ­£æ˜¯SpringMVCçš„æ¶ˆæ¯è½¬æ¢å™¨æ‰€ä½œç”¨çš„å—ä½“â€œå“åº”æ¶ˆæ¯â€çš„å†…éƒ¨æŠ½è±¡ï¼Œæ¶ˆæ¯è½¬æ¢å™¨å°†â€œå“åº”æ¶ˆæ¯â€æŒ‰ç…§ä¸€å®šçš„è§„åˆ™å†™åˆ°å“åº”æŠ¥æ–‡ä¸­ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">package org.springframework.http;</div><div class="line"></div><div class="line">import java.io.IOException;</div><div class="line">import java.io.OutputStream;</div><div class="line"></div><div class="line">public interface HttpOutputMessage extends HttpMessage &#123;</div><div class="line"></div><div class="line">    OutputStream getBody() throws IOException;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="HttpMessageConverter"><a href="#HttpMessageConverter" class="headerlink" title="HttpMessageConverter"></a>HttpMessageConverter</h2><p>å¯¹æ¶ˆæ¯è½¬æ¢å™¨æœ€é«˜å±‚æ¬¡çš„æ¥å£æŠ½è±¡ï¼Œæè¿°äº†ä¸€ä¸ªæ¶ˆæ¯è½¬æ¢å™¨çš„ä¸€èˆ¬ç‰¹å¾ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿™ä¸ªæ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œæ¥é¢†æ‚ŸSpring3.xçš„è®¾è®¡è€…å¯¹è¿™ä¸€æœºåˆ¶çš„æ€è€ƒè¿‡ç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.springframework.http.converter;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.http.HttpInputMessage;</div><div class="line"><span class="keyword">import</span> org.springframework.http.HttpOutputMessage;</div><div class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HttpMessageConverter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">canRead</span><span class="params">(Class&lt;?&gt; clazz, MediaType mediaType)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">canWrite</span><span class="params">(Class&lt;?&gt; clazz, MediaType mediaType)</span></span>;</div><div class="line"></div><div class="line">    <span class="function">List&lt;MediaType&gt; <span class="title">getSupportedMediaTypes</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function">T <span class="title">read</span><span class="params">(Class&lt;? extends T&gt; clazz, HttpInputMessage inputMessage)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException, HttpMessageNotReadableException;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">write</span><span class="params">(T t, MediaType contentType, HttpOutputMessage outputMessage)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException, HttpMessageNotWritableException;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HttpMessageConverteræ¥å£çš„å®šä¹‰å‡ºç°äº†æˆå¯¹çš„canRead()ï¼Œread()å’ŒcanWrite()ï¼Œwrite()æ–¹æ³•ï¼ŒMediaTypeæ˜¯å¯¹è¯·æ±‚çš„Media Typeå±æ€§çš„å°è£…ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå½“æˆ‘ä»¬å£°æ˜äº†ä¸‹é¢è¿™ä¸ªå¤„ç†æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/string"</span>, method=RequestMethod.POST)</div><div class="line"><span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="function">String <span class="title">readString</span><span class="params">(@RequestBody String string)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"Read string '"</span> + string + <span class="string">"'"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨SpringMVCè¿›å…¥readStringæ–¹æ³•å‰ï¼Œä¼šæ ¹æ®@RequestBodyæ³¨è§£é€‰æ‹©é€‚å½“çš„HttpMessageConverterå®ç°ç±»æ¥å°†è¯·æ±‚å‚æ•°è§£æåˆ°stringå˜é‡ä¸­ï¼Œå…·ä½“æ¥è¯´æ˜¯ä½¿ç”¨äº†StringHttpMessageConverterç±»ï¼Œå®ƒçš„canRead()æ–¹æ³•è¿”å›trueï¼Œç„¶åå®ƒçš„read()æ–¹æ³•ä¼šä»è¯·æ±‚ä¸­è¯»å‡ºè¯·æ±‚å‚æ•°ï¼Œç»‘å®šåˆ°readString()æ–¹æ³•çš„stringå˜é‡ä¸­ã€‚</p>
<p>å½“SpringMVCæ‰§è¡ŒreadStringæ–¹æ³•åï¼Œç”±äºè¿”å›å€¼æ ‡è¯†äº†@ResponseBodyï¼ŒSpringMVCå°†ä½¿ç”¨StringHttpMessageConverterçš„write()æ–¹æ³•ï¼Œå°†ç»“æœä½œä¸ºStringå€¼å†™å…¥å“åº”æŠ¥æ–‡ï¼Œå½“ç„¶ï¼Œæ­¤æ—¶canWrite()æ–¹æ³•è¿”å›trueã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„å›¾ï¼Œç®€å•æè¿°ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<p><img src="http://static.oschina.net/uploads/space/2013/1026/091627_zgNV_118997.png" alt="æ¶ˆæ¯è½¬æ¢å›¾"></p>
<h3 id="RequestResponseBodyMethodProcessor"><a href="#RequestResponseBodyMethodProcessor" class="headerlink" title="RequestResponseBodyMethodProcessor"></a>RequestResponseBodyMethodProcessor</h3><p>å°†ä¸Šè¿°è¿‡ç¨‹é›†ä¸­æè¿°çš„ä¸€ä¸ªç±»æ˜¯<code>org.springframework.web.servlet.mvc.method.annotation.RequestResponseBodyMethodProcessor</code>ï¼Œè¿™ä¸ªç±»åŒæ—¶å®ç°äº†<code>HandlerMethodArgumentResolver</code>å’Œ<code>HandlerMethodReturnValueHandler</code>ä¸¤ä¸ªæ¥å£ã€‚å‰è€…æ˜¯å°†è¯·æ±‚æŠ¥æ–‡ç»‘å®šåˆ°å¤„ç†æ–¹æ³•å½¢å‚çš„ç­–ç•¥æ¥å£ï¼Œåè€…åˆ™æ˜¯å¯¹å¤„ç†æ–¹æ³•è¿”å›å€¼è¿›è¡Œå¤„ç†çš„ç­–ç•¥æ¥å£ã€‚ä¸¤ä¸ªæ¥å£çš„æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.springframework.web.method.support;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.core.MethodParameter;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.WebDataBinder;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.support.WebDataBinderFactory;</div><div class="line"><span class="keyword">import</span> org.springframework.web.context.request.NativeWebRequest;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerMethodArgumentResolver</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supportsParameter</span><span class="params">(MethodParameter parameter)</span></span>;</div><div class="line"></div><div class="line">    <span class="function">Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter,</span></span></div><div class="line">                           ModelAndViewContainer mavContainer,</div><div class="line">                           NativeWebRequest webRequest,</div><div class="line">                           WebDataBinderFactory binderFactory) <span class="keyword">throws</span> Exception;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.springframework.web.method.support;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.core.MethodParameter;</div><div class="line"><span class="keyword">import</span> org.springframework.web.context.request.NativeWebRequest;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerMethodReturnValueHandler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supportsReturnType</span><span class="params">(MethodParameter returnType)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue,</span></span></div><div class="line">                           MethodParameter returnType,</div><div class="line">                           ModelAndViewContainer mavContainer,</div><div class="line">                           NativeWebRequest webRequest) <span class="keyword">throws</span> Exception;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>RequestResponseBodyMethodProcessorè¿™ä¸ªç±»ï¼ŒåŒæ—¶å……å½“äº†æ–¹æ³•å‚æ•°è§£æå’Œè¿”å›å€¼å¤„ç†ä¸¤ç§è§’è‰²ã€‚æˆ‘ä»¬ä»å®ƒçš„æºç ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°ä¸Šé¢ä¸¤ä¸ªæ¥å£çš„æ–¹æ³•å®ç°ã€‚</p>
<p>å¯¹<code>HandlerMethodArgumentResolver</code>æ¥å£çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsParameter</span><span class="params">(MethodParameter parameter)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> parameter.hasParameterAnnotation(RequestBody.class);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, ModelAndViewContainer mavContainer,</span></span></div><div class="line">        NativeWebRequest webRequest, WebDataBinderFactory binderFactory) <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">    Object argument = readWithMessageConverters(webRequest, parameter, parameter.getGenericParameterType());</div><div class="line"></div><div class="line">    String name = Conventions.getVariableNameForParameter(parameter);</div><div class="line">    WebDataBinder binder = binderFactory.createBinder(webRequest, argument, name);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (argument != <span class="keyword">null</span>) &#123;</div><div class="line">        validate(binder, parameter);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mavContainer.addAttribute(BindingResult.MODEL_KEY_PREFIX + name, binder.getBindingResult());</div><div class="line"></div><div class="line">    <span class="keyword">return</span> argument;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹<code>HandlerMethodReturnValueHandler</code>æ¥å£çš„å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsReturnType</span><span class="params">(MethodParameter returnType)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> returnType.getMethodAnnotation(ResponseBody.class) != <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType,</span></span></div><div class="line">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</div><div class="line">        <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException &#123;</div><div class="line"></div><div class="line">    mavContainer.setRequestHandled(<span class="keyword">true</span>);</div><div class="line">    <span class="keyword">if</span> (returnValue != <span class="keyword">null</span>) &#123;</div><div class="line">        writeWithMessageConverters(returnValue, returnType, webRequest);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœ‹å®Œä¸Šé¢çš„ä»£ç ï¼Œæ•´ä¸ª<code>HttpMessageConverter</code>æ¶ˆæ¯è½¬æ¢çš„è„‰ç»œå·²ç»éå¸¸æ¸…æ™°ã€‚å› ä¸ºä¸¤ä¸ªæ¥å£çš„å®ç°ï¼Œåˆ†åˆ«æ˜¯ä»¥æ˜¯å¦æœ‰<code>@RequestBody</code>å’Œ<code>@ResponseBody</code>ä¸ºæ¡ä»¶ï¼Œç„¶ååˆ†åˆ«è°ƒç”¨HttpMessageConverteræ¥è¿›è¡Œæ¶ˆæ¯çš„è¯»å†™ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[I/Oæ¨¡å‹]]></title>
      <url>http://zsr.github.io/2016/10/27/I:O%E6%A8%A1%E5%9E%8B/</url>
      <content type="html"><![CDATA[<h3 id="åŒæ­¥ä¸å¼‚æ­¥"><a href="#åŒæ­¥ä¸å¼‚æ­¥" class="headerlink" title="åŒæ­¥ä¸å¼‚æ­¥"></a><strong>åŒæ­¥ä¸å¼‚æ­¥</strong></h3><p><strong><code>åŒæ­¥ä¸å¼‚æ­¥ä¸»è¦æ˜¯ä»æ¶ˆæ¯é€šçŸ¥æœºåˆ¶è§’åº¦æ¥è¯´çš„.</code></strong></p>
<ul>
<li><code>æ‰€è°“åŒæ­¥å°±æ˜¯ä¸€ä¸ªä»»åŠ¡çš„å®Œæˆéœ€è¦ä¾èµ–å¦å¤–ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œåªæœ‰ç­‰å¾…è¢«ä¾èµ–çš„ä»»åŠ¡å®Œæˆåï¼Œä¾èµ–çš„ä»»åŠ¡æ‰èƒ½ç®—å®Œæˆï¼Œè¿™æ˜¯ä¸€ç§å¯é çš„ä»»åŠ¡åºåˆ—</code></li>
<li><code>æ‰€è°“å¼‚æ­¥æ˜¯ä¸éœ€è¦ç­‰å¾…è¢«ä¾èµ–çš„ä»»åŠ¡å®Œæˆï¼Œåªæ˜¯é€šçŸ¥è¢«ä¾èµ–çš„ä»»åŠ¡è¦å®Œæˆä»€ä¹ˆå·¥ä½œï¼Œä¾èµ–çš„ä»»åŠ¡ä¹Ÿç«‹å³æ‰§è¡Œï¼Œåªè¦è‡ªå·±å®Œæˆäº†æ•´ä¸ªä»»åŠ¡å°±ç®—å®Œæˆäº†</code>ã€‚è‡³äºè¢«ä¾èµ–çš„ä»»åŠ¡æœ€ç»ˆæ˜¯å¦çœŸæ­£å®Œæˆï¼Œä¾èµ–å®ƒçš„ä»»åŠ¡æ— æ³•ç¡®å®šï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸å¯é çš„ä»»åŠ¡åºåˆ—ã€‚</li>
</ul>
<h4 id="æ¶ˆæ¯é€šçŸ¥"><a href="#æ¶ˆæ¯é€šçŸ¥" class="headerlink" title="æ¶ˆæ¯é€šçŸ¥"></a><strong>æ¶ˆæ¯é€šçŸ¥</strong></h4><p><code>å¼‚æ­¥çš„æ¦‚å¿µå’ŒåŒæ­¥ç›¸å¯¹</code>ã€‚å½“ä¸€ä¸ªåŒæ­¥è°ƒç”¨å‘å‡ºåï¼Œ<code>è°ƒç”¨è€…è¦ä¸€ç›´ç­‰å¾…è¿”å›æ¶ˆæ¯ï¼ˆç»“æœï¼‰é€šçŸ¥å</code>ï¼Œæ‰èƒ½è¿›è¡Œåç»­çš„æ‰§è¡Œï¼›å½“ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…ä¸èƒ½ç«‹åˆ»å¾—åˆ°è¿”å›æ¶ˆæ¯ï¼ˆç»“æœï¼‰,<code>å®é™…å¤„ç†è¿™ä¸ªè°ƒç”¨çš„éƒ¨ä»¶åœ¨å®Œæˆåï¼Œé€šè¿‡çŠ¶æ€ã€é€šçŸ¥å’Œå›è°ƒæ¥é€šçŸ¥è°ƒç”¨è€…</code>ã€‚</p>
<p>æ‰§è¡Œéƒ¨ä»¶å’Œè°ƒç”¨è€…é€šè¿‡ä¸‰ç§é€”å¾„è¿”å›ç»“æœï¼š<code>çŠ¶æ€ã€é€šçŸ¥å’Œå›è°ƒ</code>ã€‚ä½¿ç”¨å“ªä¸€ç§é€šçŸ¥æœºåˆ¶ï¼Œ<code>ä¾èµ–äºæ‰§è¡Œéƒ¨ä»¶çš„å®ç°</code>ï¼Œé™¤éæ‰§è¡Œéƒ¨ä»¶æä¾›å¤šç§é€‰æ‹©ï¼Œ<code>å¦åˆ™ä¸å—è°ƒç”¨è€…æ§åˆ¶</code>ã€‚</p>
<ul>
<li>å¦‚æœæ‰§è¡Œéƒ¨ä»¶ç”¨çŠ¶æ€æ¥é€šçŸ¥ï¼Œé‚£ä¹ˆè°ƒç”¨è€…å°±éœ€è¦æ¯éš”ä¸€å®šæ—¶é—´æ£€æŸ¥ä¸€æ¬¡ï¼Œæ•ˆç‡å°±å¾ˆä½(Java Future)</li>
<li>å¦‚æœæ˜¯ä½¿ç”¨é€šçŸ¥çš„æ–¹å¼ï¼Œæ•ˆç‡åˆ™å¾ˆé«˜ï¼Œå› ä¸ºæ‰§è¡Œéƒ¨ä»¶å‡ ä¹ä¸éœ€è¦åšé¢å¤–çš„æ“ä½œã€‚è‡³äºå›è°ƒå‡½æ•°ï¼Œå…¶å®å’Œé€šçŸ¥æ²¡å¤ªå¤šåŒºåˆ«(Guava Future)</li>
</ul>
<h3 id="é˜»å¡ä¸éé˜»å¡"><a href="#é˜»å¡ä¸éé˜»å¡" class="headerlink" title="é˜»å¡ä¸éé˜»å¡"></a><strong>é˜»å¡ä¸éé˜»å¡</strong></h3><p><strong>é˜»å¡å’Œéé˜»å¡è¿™ä¸¤ä¸ªæ¦‚å¿µä¸ç¨‹åºï¼ˆçº¿ç¨‹ï¼‰ç­‰å¾…æ¶ˆæ¯é€šçŸ¥(æ— æ‰€è°“åŒæ­¥æˆ–è€…å¼‚æ­¥)æ—¶çš„çŠ¶æ€æœ‰å…³ã€‚ä¹Ÿå°±æ˜¯è¯´<code>é˜»å¡ä¸éé˜»å¡ä¸»è¦æ˜¯ç¨‹åºï¼ˆçº¿ç¨‹ï¼‰ç­‰å¾…æ¶ˆæ¯é€šçŸ¥æ—¶çš„çŠ¶æ€è§’åº¦æ¥è¯´çš„</code>ã€‚</strong></p>
<ul>
<li><code>é˜»å¡è°ƒç”¨æ˜¯æŒ‡è°ƒç”¨ç»“æœè¿”å›ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œä¸€ç›´å¤„äºç­‰å¾…æ¶ˆæ¯é€šçŸ¥ï¼Œä¸èƒ½å¤Ÿæ‰§è¡Œå…¶ä»–ä¸šåŠ¡</code></li>
</ul>
<p>è¿™é‡Œçš„<code>é˜»å¡è°ƒç”¨</code>ä¸<code>åŒæ­¥è°ƒç”¨</code>å®¹æ˜“æ··æ·†ï¼š</p>
<p>å¯¹äºåŒæ­¥è°ƒç”¨æ¥è¯´ï¼Œå¾ˆå¤šæ—¶å€™å½“å‰çº¿ç¨‹å¯èƒ½è¿˜æ˜¯æ¿€æ´»çš„ï¼Œåªæ˜¯ä»é€»è¾‘ä¸Šå½“å‰å‡½æ•°æ²¡æœ‰è¿”å›è€Œå·²ï¼Œæ­¤æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹å¯èƒ½ä¹Ÿä¼šå¤„ç†å…¶ä»–çš„æ¶ˆæ¯</p>
<ul>
<li>éé˜»å¡å’Œé˜»å¡çš„æ¦‚å¿µç›¸å¯¹åº”ï¼Œ<code>æŒ‡åœ¨ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥å‡½æ•°ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œè€Œä¼šç«‹åˆ»è¿”å›</code>ã€‚è™½ç„¶è¡¨é¢ä¸Šçœ‹éé˜»å¡çš„æ–¹å¼å¯ä»¥æ˜æ˜¾çš„æé«˜CPUçš„åˆ©ç”¨ç‡ï¼Œ<code>ä½†æ˜¯ä¹Ÿå¸¦äº†å¦å¤–ä¸€ç§åæœå°±æ˜¯ç³»ç»Ÿçš„çº¿ç¨‹åˆ‡æ¢å¢åŠ </code>ã€‚<code>å¢åŠ çš„CPUæ‰§è¡Œæ—¶é—´èƒ½ä¸èƒ½è¡¥å¿ç³»ç»Ÿçš„åˆ‡æ¢æˆæœ¬éœ€è¦å¥½å¥½è¯„ä¼°</code>ã€‚</li>
</ul>
<h3 id="ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´"><a href="#ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´" class="headerlink" title="ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´"></a><strong>ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´</strong></h3><p>ç°åœ¨æ“ä½œç³»ç»Ÿéƒ½æ˜¯é‡‡ç”¨è™šæ‹Ÿå­˜å‚¨å™¨ï¼Œé‚£ä¹ˆå¯¹32ä½æ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå®ƒçš„å¯»å€ç©ºé—´ï¼ˆè™šæ‹Ÿå­˜å‚¨ç©ºé—´ï¼‰ä¸º4Gï¼ˆ2çš„32æ¬¡æ–¹ï¼‰ã€‚æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯å†…æ ¸ï¼Œç‹¬ç«‹äºæ™®é€šçš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥è®¿é—®å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´ï¼Œä¹Ÿæœ‰è®¿é—®åº•å±‚ç¡¬ä»¶è®¾å¤‡çš„æ‰€æœ‰æƒé™ã€‚ä¸ºäº†ä¿è¯ç”¨æˆ·è¿›ç¨‹ä¸èƒ½ç›´æ¥æ“ä½œå†…æ ¸ï¼ˆkernelï¼‰ï¼Œä¿è¯å†…æ ¸çš„å®‰å…¨ï¼Œæ“å¿ƒç³»ç»Ÿå°†è™šæ‹Ÿç©ºé—´åˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ä¸ºå†…æ ¸ç©ºé—´ï¼Œä¸€éƒ¨åˆ†ä¸ºç”¨æˆ·ç©ºé—´ã€‚é’ˆå¯¹linuxæ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå°†æœ€é«˜çš„1Gå­—èŠ‚ï¼ˆä»è™šæ‹Ÿåœ°å€0xC0000000åˆ°0xFFFFFFFFï¼‰ï¼Œä¾›å†…æ ¸ä½¿ç”¨ï¼Œç§°ä¸ºå†…æ ¸ç©ºé—´ï¼Œè€Œå°†è¾ƒä½çš„3Gå­—èŠ‚ï¼ˆä»è™šæ‹Ÿåœ°å€0x00000000åˆ°0xBFFFFFFFï¼‰ï¼Œä¾›å„ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œç§°ä¸ºç”¨æˆ·ç©ºé—´ã€‚</p>
<h3 id="æ–‡ä»¶æè¿°ç¬¦"><a href="#æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="æ–‡ä»¶æè¿°ç¬¦"></a><strong>æ–‡ä»¶æè¿°ç¬¦</strong></h3><p>æ–‡ä»¶æè¿°ç¬¦ï¼ˆFile descriptorï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­çš„ä¸€ä¸ªæœ¯è¯­ï¼Œæ˜¯ä¸€ä¸ªç”¨äºè¡¨è¿°æŒ‡å‘æ–‡ä»¶çš„å¼•ç”¨çš„æŠ½è±¡åŒ–æ¦‚å¿µã€‚</p>
<p>æ–‡ä»¶æè¿°ç¬¦åœ¨å½¢å¼ä¸Šæ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ã€‚å®é™…ä¸Šï¼Œå®ƒæ˜¯ä¸€ä¸ªç´¢å¼•å€¼ï¼ŒæŒ‡å‘å†…æ ¸ä¸ºæ¯ä¸€ä¸ªè¿›ç¨‹æ‰€ç»´æŠ¤çš„è¯¥è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„è®°å½•è¡¨ã€‚å½“ç¨‹åºæ‰“å¼€ä¸€ä¸ªç°æœ‰æ–‡ä»¶æˆ–è€…åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶æ—¶ï¼Œå†…æ ¸å‘è¿›ç¨‹è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚åœ¨ç¨‹åºè®¾è®¡ä¸­ï¼Œä¸€äº›æ¶‰åŠåº•å±‚çš„ç¨‹åºç¼–å†™å¾€å¾€ä¼šå›´ç»•ç€æ–‡ä»¶æè¿°ç¬¦å±•å¼€ã€‚ä½†æ˜¯æ–‡ä»¶æè¿°ç¬¦è¿™ä¸€æ¦‚å¿µå¾€å¾€åªé€‚ç”¨äºUNIXã€Linuxè¿™æ ·çš„æ“ä½œç³»ç»Ÿã€‚</p>
<h3 id="ç¼“å­˜-I-O"><a href="#ç¼“å­˜-I-O" class="headerlink" title="ç¼“å­˜ I/O"></a><strong>ç¼“å­˜ I/O</strong></h3><p>ç¼“å­˜ I/O åˆè¢«ç§°ä½œæ ‡å‡† I/Oï¼Œå¤§å¤šæ•°æ–‡ä»¶ç³»ç»Ÿçš„é»˜è®¤ I/O æ“ä½œéƒ½æ˜¯ç¼“å­˜ I/Oã€‚åœ¨ Linux çš„ç¼“å­˜ I/O æœºåˆ¶ä¸­ï¼Œæ“ä½œç³»ç»Ÿä¼šå°† I/O çš„æ•°æ®ç¼“å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿçš„é¡µç¼“å­˜ï¼ˆ page cache ï¼‰ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ•°æ®ä¼šå…ˆè¢«æ‹·è´åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„ç¼“å†²åŒºä¸­ï¼Œç„¶åæ‰ä¼šä»æ“ä½œç³»ç»Ÿå†…æ ¸çš„ç¼“å†²åŒºæ‹·è´åˆ°åº”ç”¨ç¨‹åºçš„åœ°å€ç©ºé—´ã€‚</p>
<p><strong>ç¼“å­˜ I/O çš„ç¼ºç‚¹ï¼š</strong></p>
<p>æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­éœ€è¦åœ¨åº”ç”¨ç¨‹åºåœ°å€ç©ºé—´å’Œå†…æ ¸è¿›è¡Œå¤šæ¬¡æ•°æ®æ‹·è´æ“ä½œï¼Œè¿™äº›æ•°æ®æ‹·è´æ“ä½œæ‰€å¸¦æ¥çš„ CPU ä»¥åŠå†…å­˜å¼€é”€æ˜¯éå¸¸å¤§çš„ã€‚</p>
<h3 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a><strong>ç³»ç»Ÿè°ƒç”¨</strong></h3><p>è¿›ç¨‹æƒ³è¦è·å–ç£ç›˜ä¸­çš„æ•°æ®ï¼Œè€Œèƒ½å’Œç¡¬ä»¶æ‰“äº¤é“çš„åªèƒ½æ˜¯å†…æ ¸ï¼Œè¿›ç¨‹é€šçŸ¥å†…æ ¸è¯´æˆ‘è¦ç£ç›˜ä¸­çš„æ•°æ®ï¼Œæ­¤è¿‡ç¨‹å°±æ˜¯ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p><strong>ä¸€æ¬¡I/Oçš„å®Œæˆçš„æ­¥éª¤:</strong></p>
<pre><code>å½“è¿›ç¨‹å‘èµ·ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œè¿™ä¸ªç³»ç»Ÿè°ƒç”¨å°±è¿›å…¥å†…æ ¸æ¨¡å¼ï¼Œç„¶åå¼€å§‹I/Oæ“ä½œ
</code></pre><p><strong>I/Oæ“ä½œåˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤:</strong></p>
<ul>
<li>1ã€ç£ç›˜æŠŠæ•°æ®è£…è½½åˆ°å†…æ ¸çš„å†…å­˜ç©ºé—´ï¼Œ</li>
<li>2ã€å†…æ ¸çš„å†…å­˜ç©ºé—´çš„æ•°æ®copyåˆ°ç”¨æˆ·çš„å†…å­˜ç©ºé—´ä¸­(æ­¤è¿‡ç¨‹æ˜¯I/Oå‘ç”Ÿçš„åœ°æ–¹)</li>
</ul>
<p>å¯¹äºä¸€ä¸ªå¥—æ¥å­—ä¸Šçš„è¾“å…¥æ“ä½œï¼Œç¬¬ä¸€æ­¥é€šå¸¸æ¶‰åŠç­‰å¾…æ•°æ®ä»ç½‘ç»œä¸­åˆ°è¾¾ã€‚å½“æ‰€ç­‰å¾…åˆ†ç»„åˆ°è¾¾æ—¶ï¼Œå®ƒè¢«å¤åˆ¶åˆ°å†…æ ¸æ€»çš„æŸä¸ªç¼“å†²åŒºã€‚ç¬¬äºŒæ­¥å°±æ˜¯æŠŠæ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ç¼“å†²åŒºã€‚</p>
<p><strong>è¿›ç¨‹è·å–æ•°æ®çš„è¯¦ç»†å›¾è§£è¿‡ç¨‹:</strong></p>
<p><a href="http://img1.51cto.com/attachment/201309/205126317.png" target="_blank" rel="external"><img src="http://img1.51cto.com/attachment/201309/205126317.png" alt="0.png"></a></p>
<p>  æ•´ä¸ªè¿‡ç¨‹ï¼šæ­¤è¿›ç¨‹éœ€è¦å¯¹ç£ç›˜ä¸­çš„æ•°æ®è¿›è¡Œæ“ä½œï¼Œåˆ™ä¼šå‘å†…æ ¸å‘èµ·ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åæ­¤è¿›ç¨‹ï¼Œå°†ä¼šè¢«åˆ‡æ¢å‡ºå»ï¼Œæ­¤è¿›ç¨‹ä¼šè¢«æŒ‚èµ·æˆ–è€…è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œä¹Ÿå«ä¸å¯ä¸­æ–­çš„ç¡çœ ï¼Œå› ä¸ºæ•°æ®è¿˜æ²¡æœ‰å¾—åˆ°ï¼Œåªæœ‰ç­‰åˆ°ç³»ç»Ÿè°ƒç”¨çš„ç»“æœå®Œæˆåï¼Œåˆ™è¿›ç¨‹ä¼šè¢«å”¤é†’ï¼Œç»§ç»­æ¥ä¸‹æ¥çš„æ“ä½œï¼Œä»ç³»ç»Ÿè°ƒç”¨çš„å¼€å§‹åˆ°ç³»ç»Ÿè°ƒç”¨ç»“æŸç»è¿‡çš„æ­¥éª¤ï¼š</p>
<p>â‘ è¿›ç¨‹å‘å†…æ ¸å‘èµ·ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œ</p>
<p>â‘¡å†…æ ¸æ¥æ”¶åˆ°ç³»ç»Ÿè°ƒç”¨ï¼ŒçŸ¥é“æ˜¯å¯¹æ–‡ä»¶çš„è¯·æ±‚ï¼Œäºæ˜¯å‘Šè¯‰ç£ç›˜ï¼ŒæŠŠæ–‡ä»¶è¯»å–å‡ºæ¥</p>
<p>â‘¢ç£ç›˜æ¥æ”¶åˆ°æ¥ç€å†…æ ¸çš„å‘½ä»¤åï¼ŒæŠŠæ–‡ä»¶è½½å…¥åˆ°å†…æ ¸çš„å†…å­˜ç©ºé—´é‡Œé¢</p>
<p>â‘£å†…æ ¸çš„å†…å­˜ç©ºé—´æ¥æ”¶åˆ°æ•°æ®ä¹‹åï¼ŒæŠŠæ•°æ®copyåˆ°ç”¨æˆ·è¿›ç¨‹çš„å†…å­˜ç©ºé—´(<strong>æ­¤è¿‡ç¨‹æ˜¯I/Oå‘ç”Ÿçš„åœ°æ–¹</strong>)</p>
<p>â‘¤è¿›ç¨‹å†…å­˜ç©ºé—´å¾—åˆ°æ•°æ®åï¼Œç»™å†…æ ¸å‘é€é€šçŸ¥</p>
<p>â‘¥å†…æ ¸æŠŠæ¥æ”¶åˆ°çš„é€šçŸ¥å›å¤ç»™è¿›ç¨‹ï¼Œæ­¤è¿‡ç¨‹ä¸ºå”¤é†’è¿›ç¨‹ï¼Œç„¶åè¿›ç¨‹å¾—åˆ°æ•°æ®ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ</p>
<a id="more"></a>
<h3 id="äº”ç§I-Oæ¨¡å‹"><a href="#äº”ç§I-Oæ¨¡å‹" class="headerlink" title="äº”ç§I/Oæ¨¡å‹"></a><strong>äº”ç§I/Oæ¨¡å‹</strong></h3><ul>
<li>é˜»å¡ I/Oï¼ˆblocking IOï¼‰</li>
<li>éé˜»å¡ I/Oï¼ˆnonblocking IOï¼‰</li>
<li>I/O å¤šè·¯å¤ç”¨ï¼ˆ IO multiplexingï¼‰</li>
<li>ä¿¡å·é©±åŠ¨ I/Oï¼ˆ signal driven IOï¼‰</li>
<li>å¼‚æ­¥ I/Oï¼ˆasynchronous IOï¼‰</li>
</ul>
<p><strong>I/Oå‘ç”Ÿçš„åœ°æ–¹æ‰ä¼šå‡ºç°é˜»å¡æˆ–éé˜»å¡</strong></p>
<h4 id="é˜»å¡ï¼š"><a href="#é˜»å¡ï¼š" class="headerlink" title="é˜»å¡ï¼š"></a><strong>é˜»å¡ï¼š</strong></h4><p>è¿›ç¨‹å‘èµ·I/Oè°ƒç”¨ï¼Œè¿›ç¨‹åˆä¸å¾—ä¸ç­‰å¾…I/Oçš„å®Œæˆï¼Œæ­¤æ—¶CPUæŠŠè¿›ç¨‹åˆ‡æ¢å‡ºå»ï¼Œè¿›ç¨‹å¤„äºç¡çœ çŠ¶æ€åˆ™æ­¤è¿‡ç¨‹ä¸ºé˜»å¡I/O; I/Oå®Œæˆï¼Œç³»ç»Ÿç›´æ¥é€šçŸ¥è¿›ç¨‹ï¼Œåˆ™è¿›ç¨‹è¢«å”¤é†’</p>
<p><strong>blocking IOçš„ç‰¹ç‚¹å°±æ˜¯åœ¨IOæ‰§è¡Œçš„ä¸¤ä¸ªé˜¶æ®µéƒ½è¢«blockäº†ã€‚</strong></p>
<p>é˜»å¡I/Oçš„å›¾è§£</p>
<p><a href="http://img1.51cto.com/attachment/201309/205500239.png" target="_blank" rel="external"><img src="http://img1.51cto.com/attachment/201309/205500239.png" alt="1.png"></a></p>
<h4 id="éé˜»å¡ï¼š"><a href="#éé˜»å¡ï¼š" class="headerlink" title="éé˜»å¡ï¼š"></a><strong>éé˜»å¡ï¼š</strong></h4><p>è¿›ç¨‹å‘èµ·I/Oè°ƒç”¨ï¼ŒI/Oè‡ªå·±çŸ¥é“éœ€è¿‡ä¸€æ®µæ—¶é—´å®Œæˆï¼Œå°±ç«‹å³é€šçŸ¥è¿›ç¨‹è¿›è¡Œåˆ«çš„æ“ä½œï¼Œåˆ™ä¸ºéé˜»å¡I/O; æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œç”¨æˆ·è¿›ç¨‹é—®å†…æ ¸æ•°æ®æ˜¯å¦å‡†å¤‡å®Œæˆï¼Œç³»ç»Ÿå®Œæˆåï¼Œåˆ™è¿›ç¨‹è·å–æ•°æ®ï¼Œç»§ç»­æ‰§è¡Œ(æ­¤è¿‡ç¨‹ä¹Ÿç§°ç›²ç­‰å¾…)</p>
<p><strong>nonblocking IOçš„ç‰¹ç‚¹æ˜¯ç”¨æˆ·è¿›ç¨‹éœ€è¦ä¸æ–­çš„ä¸»åŠ¨è¯¢é—®kernelæ•°æ®å¥½äº†æ²¡æœ‰ã€‚</strong></p>
<p>éé˜»å¡I/Oçš„å›¾è§£ï¼š</p>
<p><a href="http://img1.51cto.com/attachment/201309/205605819.png" target="_blank" rel="external"><img src="http://img1.51cto.com/attachment/201309/205605819.png" alt="2.png"></a></p>
<h4 id="I-O-å¤šè·¯å¤ç”¨"><a href="#I-O-å¤šè·¯å¤ç”¨" class="headerlink" title="I/O å¤šè·¯å¤ç”¨"></a><strong>I/O å¤šè·¯å¤ç”¨</strong></h4><p><strong>å¤šè·¯å¤ç”¨æ˜¯æŒ‡ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥æ£€æŸ¥å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆSocketï¼‰çš„å°±ç»ªçŠ¶æ€ï¼Œæ¯”å¦‚è°ƒç”¨selectå’Œpollå‡½æ•°ï¼Œä¼ å…¥å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼Œåˆ™è¿”å›ï¼Œå¦åˆ™é˜»å¡ç›´åˆ°è¶…æ—¶ã€‚å¾—åˆ°å°±ç»ªçŠ¶æ€åè¿›è¡ŒçœŸæ­£çš„æ“ä½œå¯ä»¥åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œï¼Œä¹Ÿå¯ä»¥å¯åŠ¨çº¿ç¨‹æ‰§è¡Œï¼ˆæ¯”å¦‚ä½¿ç”¨çº¿ç¨‹æ± ï¼‰ã€‚</strong></p>
<p>æœ‰äº›åœ°æ–¹ä¹Ÿç§°è¿™ç§IOæ–¹å¼ä¸ºevent driven IOã€‚select/epollçš„å¥½å¤„å°±åœ¨äºå•ä¸ªprocesså°±å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªç½‘ç»œè¿æ¥çš„IOã€‚å®ƒçš„åŸºæœ¬åŸç†å°±æ˜¯selectï¼Œpollï¼Œepollè¿™ä¸ªfunctionä¼šä¸æ–­çš„è½®è¯¢æ‰€è´Ÿè´£çš„æ‰€æœ‰socketï¼Œå½“æŸä¸ªsocketæœ‰æ•°æ®åˆ°è¾¾äº†ï¼Œå°±é€šçŸ¥ç”¨æˆ·è¿›ç¨‹ã€‚</p>
<p><img src="https://segmentfault.com/img/bVm1c5" alt="img"></p>
<p><code>å½“ç”¨æˆ·è¿›ç¨‹è°ƒç”¨äº†selectï¼Œé‚£ä¹ˆæ•´ä¸ªè¿›ç¨‹ä¼šè¢«block</code>ï¼Œè€ŒåŒæ—¶ï¼Œkernelä¼šâ€œç›‘è§†â€æ‰€æœ‰selectè´Ÿè´£çš„socketï¼Œå½“ä»»ä½•ä¸€ä¸ªsocketä¸­çš„æ•°æ®å‡†å¤‡å¥½äº†ï¼Œselectå°±ä¼šè¿”å›ã€‚è¿™ä¸ªæ—¶å€™ç”¨æˆ·è¿›ç¨‹å†è°ƒç”¨readæ“ä½œï¼Œå°†æ•°æ®ä»kernelæ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹ã€‚</p>
<p>I/Oå¤ç”¨çš„å›¾è§£ï¼š</p>
<p><a href="http://img1.51cto.com/attachment/201309/205635176.png" target="_blank" rel="external"><img src="http://img1.51cto.com/attachment/201309/205635176.png" alt="3.png"></a></p>
<p>è¿™æ ·åœ¨å¤„ç†1000ä¸ªè¿æ¥æ—¶ï¼Œåªéœ€è¦1ä¸ªçº¿ç¨‹ç›‘æ§å°±ç»ªçŠ¶æ€ï¼Œå¯¹å°±ç»ªçš„æ¯ä¸ªè¿æ¥å¼€ä¸€ä¸ªçº¿ç¨‹å¤„ç†å°±å¯ä»¥äº†ï¼Œè¿™æ ·éœ€è¦çš„çº¿ç¨‹æ•°å¤§å¤§å‡å°‘ï¼Œå‡å°‘äº†å†…å­˜å¼€é”€å’Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„CPUå¼€é”€ã€‚</p>
<p>è¿™ä¸ªå›¾å’Œblocking IOçš„å›¾å…¶å®å¹¶æ²¡æœ‰å¤ªå¤§çš„ä¸åŒï¼Œäº‹å®ä¸Šï¼Œè¿˜æ›´å·®ä¸€äº›ã€‚å› ä¸ºè¿™é‡Œéœ€è¦ä½¿ç”¨ä¸¤ä¸ªsystem call (select å’Œ recvfrom)ï¼Œè€Œblocking IOåªè°ƒç”¨äº†ä¸€ä¸ªsystem call (recvfrom)ã€‚ä½†æ˜¯ï¼Œç”¨selectçš„ä¼˜åŠ¿åœ¨äºå®ƒå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªconnectionã€‚</p>
<p>æ‰€ä»¥ï¼Œå¦‚æœå¤„ç†çš„è¿æ¥æ•°ä¸æ˜¯å¾ˆé«˜çš„è¯ï¼Œä½¿ç”¨select/epollçš„web serverä¸ä¸€å®šæ¯”ä½¿ç”¨multi-threading + blocking IOçš„web serveræ€§èƒ½æ›´å¥½ï¼Œå¯èƒ½å»¶è¿Ÿè¿˜æ›´å¤§ã€‚<strong>select/epollçš„ä¼˜åŠ¿å¹¶ä¸æ˜¯å¯¹äºå•ä¸ªè¿æ¥èƒ½å¤„ç†å¾—æ›´å¿«ï¼Œè€Œæ˜¯åœ¨äºèƒ½å¤„ç†æ›´å¤šçš„è¿æ¥</strong></p>
<h4 id="ä¿¡å·é©±åŠ¨I-O"><a href="#ä¿¡å·é©±åŠ¨I-O" class="headerlink" title="ä¿¡å·é©±åŠ¨I/O"></a><strong>ä¿¡å·é©±åŠ¨I/O</strong></h4><p>é¦–å…ˆï¼Œå…è®¸å¥—æ¥å£è¿›è¡Œä¿¡å·é©±åŠ¨I/Oï¼Œå¹¶å®‰è£…ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¿›ç¨‹ç»§ç»­è¿è¡Œå¹¶ä¸é˜»å¡ã€‚å½“æ•°æ®å‡†å¤‡å¥½æ—¶ï¼Œè¿›ç¨‹ä¼šæ”¶åˆ°ä¸€ä¸ªSIGIOä¿¡å·ï¼Œå¯ä»¥åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨I/Oæ“ä½œå‡½æ•°å¤„ç†æ•°æ®ã€‚</p>
<p><strong>ä¿¡å·é©±åŠ¨ I/O æ¨¡å¼ä¸‹ï¼Œå†…æ ¸å¯ä»¥åœ¨å¤åˆ¶çš„æ—¶å€™é€šçŸ¥ç»™æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå‘é€SIGIO æ¶ˆæ¯ã€‚</strong></p>
<p>å…·ä½“è¿‡ç¨‹å¦‚ä¸‹å›¾:</p>
<p><a href="http://www.toxingwang.com/wp-content/uploads/2013/11/sigio.jpg" target="_blank" rel="external"><img src="http://www.toxingwang.com/wp-content/uploads/2013/11/sigio.jpg" alt="sigio"></a></p>
<h4 id="å¼‚æ­¥I-O"><a href="#å¼‚æ­¥I-O" class="headerlink" title="å¼‚æ­¥I/O"></a><strong>å¼‚æ­¥I/O</strong></h4><p>ç”¨æˆ·è¿›ç¨‹å‘èµ·readæ“ä½œä¹‹åï¼Œç«‹åˆ»å°±å¯ä»¥å¼€å§‹å»åšå…¶å®ƒçš„äº‹ã€‚è€Œå¦ä¸€æ–¹é¢ï¼Œä»kernelçš„è§’åº¦ï¼Œå½“å®ƒå—åˆ°ä¸€ä¸ªasynchronous readä¹‹åï¼Œé¦–å…ˆå®ƒä¼šç«‹åˆ»è¿”å›ï¼Œæ‰€ä»¥ä¸ä¼šå¯¹ç”¨æˆ·è¿›ç¨‹äº§ç”Ÿä»»ä½•blockã€‚ç„¶åï¼Œkernelä¼šç­‰å¾…æ•°æ®å‡†å¤‡å®Œæˆï¼Œç„¶åå°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·å†…å­˜ï¼Œå½“è¿™ä¸€åˆ‡éƒ½å®Œæˆä¹‹åï¼Œkernelä¼šç»™ç”¨æˆ·è¿›ç¨‹å‘é€ä¸€ä¸ªsignalï¼Œå‘Šè¯‰å®ƒreadæ“ä½œå®Œæˆäº†ã€‚</p>
<p>å¼‚æ­¥I/Oçš„å›¾è§£ï¼š</p>
<p><a href="http://img1.51cto.com/attachment/201309/210054915.png" target="_blank" rel="external"><img src="http://img1.51cto.com/attachment/201309/210054915.png" alt="5.png"></a></p>
<p>  <strong>å‰å››ç§I/Oå±äºåŒæ­¥æ“ä½œï¼Œæœ€åçš„ä¸€ç§åˆ™å±äºå¼‚æ­¥æ“ä½œ</strong></p>
<h4 id="äº”ç§I-Oæ¨¡å‹çš„æ¯”è¾ƒï¼š"><a href="#äº”ç§I-Oæ¨¡å‹çš„æ¯”è¾ƒï¼š" class="headerlink" title="äº”ç§I/Oæ¨¡å‹çš„æ¯”è¾ƒï¼š"></a><strong>äº”ç§I/Oæ¨¡å‹çš„æ¯”è¾ƒï¼š</strong></h4><p><img src="https://segmentfault.com/img/bVm1c9" alt="img"></p>
<h3 id="I-O-å¤šè·¯å¤ç”¨ä¹‹selectã€pollã€epollè¯¦è§£"><a href="#I-O-å¤šè·¯å¤ç”¨ä¹‹selectã€pollã€epollè¯¦è§£" class="headerlink" title="I/O å¤šè·¯å¤ç”¨ä¹‹selectã€pollã€epollè¯¦è§£"></a><strong>I/O å¤šè·¯å¤ç”¨ä¹‹selectã€pollã€epollè¯¦è§£</strong></h3><p>selectï¼Œpollï¼Œepolléƒ½æ˜¯IOå¤šè·¯å¤ç”¨çš„æœºåˆ¶ã€‚I/Oå¤šè·¯å¤ç”¨å°±æ˜¯é€šè¿‡ä¸€ç§æœºåˆ¶ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç›‘è§†å¤šä¸ªæè¿°ç¬¦ï¼Œä¸€æ—¦æŸä¸ªæè¿°ç¬¦å°±ç»ªï¼ˆä¸€èˆ¬æ˜¯è¯»å°±ç»ªæˆ–è€…å†™å°±ç»ªï¼‰ï¼Œèƒ½å¤Ÿé€šçŸ¥ç¨‹åºè¿›è¡Œç›¸åº”çš„è¯»å†™æ“ä½œã€‚ä½†selectï¼Œpollï¼Œepollæœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥I/Oï¼Œå› ä¸ºä»–ä»¬éƒ½éœ€è¦åœ¨è¯»å†™äº‹ä»¶å°±ç»ªåè‡ªå·±è´Ÿè´£è¿›è¡Œè¯»å†™ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¯»å†™è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œè€Œå¼‚æ­¥I/Oåˆ™æ— éœ€è‡ªå·±è´Ÿè´£è¿›è¡Œè¯»å†™ï¼Œå¼‚æ­¥I/Oçš„å®ç°ä¼šè´Ÿè´£æŠŠæ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p>
<ul>
<li><strong>select</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span> <span class="params">(<span class="keyword">int</span> n, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, <span class="keyword">struct</span> timeval *timeout)</span></span>;</div></pre></td></tr></table></figure>
<p>select å‡½æ•°ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦åˆ†3ç±»ï¼Œåˆ†åˆ«æ˜¯<code>writefds</code>ã€<code>readfds</code>ã€å’Œ<code>exceptfds</code>ã€‚è°ƒç”¨åselectå‡½æ•°ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æè¿°å‰¯å°±ç»ªï¼ˆæœ‰æ•°æ®å¯è¯»ã€å¯å†™ã€æˆ–è€…æœ‰exceptï¼‰ï¼Œæˆ–è€…è¶…æ—¶ï¼ˆtimeoutæŒ‡å®šç­‰å¾…æ—¶é—´ï¼Œå¦‚æœç«‹å³è¿”å›è®¾ä¸ºnullå³å¯ï¼‰ï¼Œå‡½æ•°è¿”å›ã€‚å½“selectå‡½æ•°è¿”å›åï¼Œå¯ä»¥é€šè¿‡éå†fdsetï¼Œæ¥æ‰¾åˆ°å°±ç»ªçš„æè¿°ç¬¦ã€‚</p>
<p>selectç›®å‰å‡ ä¹åœ¨æ‰€æœ‰çš„å¹³å°ä¸Šæ”¯æŒï¼Œå…¶è‰¯å¥½è·¨å¹³å°æ”¯æŒä¹Ÿæ˜¯å®ƒçš„ä¸€ä¸ªä¼˜ç‚¹ã€‚selectçš„ä¸€ ä¸ªç¼ºç‚¹åœ¨äºå•ä¸ªè¿›ç¨‹èƒ½å¤Ÿç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡å­˜åœ¨æœ€å¤§é™åˆ¶ï¼Œåœ¨Linuxä¸Šä¸€èˆ¬ä¸º1024ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹å®å®šä¹‰ç”šè‡³é‡æ–°ç¼–è¯‘å†…æ ¸çš„æ–¹å¼æå‡è¿™ä¸€é™åˆ¶ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿä¼šé€ æˆæ•ˆç‡çš„é™ä½ã€‚</p>
<ul>
<li><strong>poll</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">poll</span> <span class="params">(<span class="keyword">struct</span> pollfd *fds, <span class="keyword">unsigned</span> <span class="keyword">int</span> nfds, <span class="keyword">int</span> timeout)</span></span>;</div></pre></td></tr></table></figure>
<p>ä¸åŒä¸selectä½¿ç”¨ä¸‰ä¸ªä½å›¾æ¥è¡¨ç¤ºä¸‰ä¸ªfdsetçš„æ–¹å¼ï¼Œpollä½¿ç”¨ä¸€ä¸ª pollfdçš„æŒ‡é’ˆå®ç°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> pollfd &#123;</div><div class="line">    <span class="keyword">int</span> fd; <span class="comment">/* file descriptor */</span></div><div class="line">    <span class="keyword">short</span> events; <span class="comment">/* requested events to watch */</span></div><div class="line">    <span class="keyword">short</span> revents; <span class="comment">/* returned events witnessed */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>pollfdç»“æ„åŒ…å«äº†è¦ç›‘è§†çš„eventå’Œå‘ç”Ÿçš„eventï¼Œä¸å†ä½¿ç”¨selectâ€œå‚æ•°-å€¼â€ä¼ é€’çš„æ–¹å¼ã€‚åŒæ—¶ï¼Œpollfdå¹¶æ²¡æœ‰æœ€å¤§æ•°é‡é™åˆ¶ï¼ˆä½†æ˜¯æ•°é‡è¿‡å¤§åæ€§èƒ½ä¹Ÿæ˜¯ä¼šä¸‹é™ï¼‰ã€‚ å’Œselectå‡½æ•°ä¸€æ ·ï¼Œpollè¿”å›åï¼Œéœ€è¦è½®è¯¢pollfdæ¥è·å–å°±ç»ªçš„æè¿°ç¬¦ã€‚</p>
<p><strong>ä»ä¸Šé¢çœ‹ï¼Œselectå’Œpolléƒ½éœ€è¦åœ¨è¿”å›åï¼Œ<code>é€šè¿‡éå†æ–‡ä»¶æè¿°ç¬¦æ¥è·å–å·²ç»å°±ç»ªçš„socket</code>ã€‚äº‹å®ä¸Šï¼ŒåŒæ—¶è¿æ¥çš„å¤§é‡å®¢æˆ·ç«¯åœ¨ä¸€æ—¶åˆ»å¯èƒ½åªæœ‰å¾ˆå°‘çš„å¤„äºå°±ç»ªçŠ¶æ€ï¼Œå› æ­¤éšç€ç›‘è§†çš„æè¿°ç¬¦æ•°é‡çš„å¢é•¿ï¼Œå…¶æ•ˆç‡ä¹Ÿä¼šçº¿æ€§ä¸‹é™ã€‚</strong></p>
<ul>
<li><strong>epoll</strong></li>
</ul>
<p>epollæ˜¯åœ¨2.6å†…æ ¸ä¸­æå‡ºçš„ï¼Œæ˜¯ä¹‹å‰çš„selectå’Œpollçš„å¢å¼ºç‰ˆæœ¬ã€‚ç›¸å¯¹äºselectå’Œpollæ¥è¯´ï¼Œepollæ›´åŠ çµæ´»ï¼Œæ²¡æœ‰æè¿°ç¬¦é™åˆ¶ã€‚epollä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç®¡ç†å¤šä¸ªæè¿°ç¬¦ï¼Œå°†ç”¨æˆ·å…³ç³»çš„æ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶å­˜æ”¾åˆ°å†…æ ¸çš„ä¸€ä¸ªäº‹ä»¶è¡¨ä¸­ï¼Œè¿™æ ·åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„copyåªéœ€ä¸€æ¬¡ã€‚</p>
<p>epollæ“ä½œè¿‡ç¨‹éœ€è¦ä¸‰ä¸ªæ¥å£ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">int epoll_create(int size)ï¼›//åˆ›å»ºä¸€ä¸ªepollçš„å¥æŸ„ï¼Œsizeç”¨æ¥å‘Šè¯‰å†…æ ¸è¿™ä¸ªç›‘å¬çš„æ•°ç›®ä¸€å…±æœ‰å¤šå¤§</div><div class="line">int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)ï¼›</div><div class="line">int epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout);</div></pre></td></tr></table></figure>
<p>åœ¨<code>select/poll</code>ä¸­ï¼Œè¿›ç¨‹åªæœ‰åœ¨è°ƒç”¨ä¸€å®šçš„æ–¹æ³•åï¼Œå†…æ ¸æ‰å¯¹æ‰€æœ‰ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œæ‰«æï¼Œè€Œ<strong>epolläº‹å…ˆé€šè¿‡epoll_ctl()æ¥æ³¨å†Œä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€æ—¦åŸºäºæŸä¸ªæ–‡ä»¶æè¿°ç¬¦å°±ç»ªæ—¶ï¼Œå†…æ ¸ä¼šé‡‡ç”¨ç±»ä¼¼callbackçš„å›è°ƒæœºåˆ¶ï¼Œè¿…é€Ÿæ¿€æ´»è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå½“è¿›ç¨‹è°ƒç”¨epoll_wait() æ—¶ä¾¿å¾—åˆ°é€šçŸ¥</strong>ã€‚(<code>æ­¤å¤„å»æ‰äº†éå†æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œæ˜¯é€šè¿‡ç›‘å¬å›è°ƒçš„çš„æœºåˆ¶</code>ã€‚è¿™æ­£æ˜¯epollçš„é­…åŠ›æ‰€åœ¨ã€‚)</p>
<p><strong>epollçš„ä¼˜ç‚¹ä¸»è¦æ˜¯ä¸€ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</strong></p>
<ol>
<li>ç›‘è§†çš„æè¿°ç¬¦æ•°é‡ä¸å—é™åˆ¶ï¼Œå®ƒæ‰€æ”¯æŒçš„FDä¸Šé™æ˜¯æœ€å¤§å¯ä»¥æ‰“å¼€æ–‡ä»¶çš„æ•°ç›®ï¼Œè¿™ä¸ªæ•°å­—ä¸€èˆ¬è¿œå¤§äº2048,ä¸¾ä¸ªä¾‹å­,åœ¨1GBå†…å­˜çš„æœºå™¨ä¸Šå¤§çº¦æ˜¯10ä¸‡å·¦ å³ï¼Œå…·ä½“æ•°ç›®å¯ä»¥cat /proc/sys/fs/file-maxå¯Ÿçœ‹,ä¸€èˆ¬æ¥è¯´è¿™ä¸ªæ•°ç›®å’Œç³»ç»Ÿå†…å­˜å…³ç³»å¾ˆå¤§ã€‚selectçš„æœ€å¤§ç¼ºç‚¹å°±æ˜¯è¿›ç¨‹æ‰“å¼€çš„fdæ˜¯æœ‰æ•°é‡é™åˆ¶çš„ã€‚è¿™å¯¹äºè¿æ¥æ•°é‡æ¯”è¾ƒå¤§çš„æœåŠ¡å™¨æ¥è¯´æ ¹æœ¬ä¸èƒ½æ»¡è¶³ã€‚è™½ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©å¤šè¿›ç¨‹çš„è§£å†³æ–¹æ¡ˆ( Apacheå°±æ˜¯è¿™æ ·å®ç°çš„)ï¼Œä¸è¿‡è™½ç„¶linuxä¸Šé¢åˆ›å»ºè¿›ç¨‹çš„ä»£ä»·æ¯”è¾ƒå°ï¼Œä½†ä»æ—§æ˜¯ä¸å¯å¿½è§†çš„ï¼ŒåŠ ä¸Šè¿›ç¨‹é—´æ•°æ®åŒæ­¥è¿œæ¯”ä¸ä¸Šçº¿ç¨‹é—´åŒæ­¥çš„é«˜æ•ˆï¼Œæ‰€ä»¥ä¹Ÿä¸æ˜¯ä¸€ç§å®Œç¾çš„æ–¹æ¡ˆã€‚</li>
<li>IOçš„æ•ˆç‡ä¸ä¼šéšç€ç›‘è§†fdçš„æ•°é‡çš„å¢é•¿è€Œä¸‹é™ã€‚epollä¸åŒäºselectå’Œpollè½®è¯¢çš„æ–¹å¼ï¼Œè€Œæ˜¯é€šè¿‡æ¯ä¸ªfdå®šä¹‰çš„å›è°ƒå‡½æ•°æ¥å®ç°çš„ã€‚åªæœ‰å°±ç»ªçš„fdæ‰ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°ã€‚</li>
</ol>
<p><strong>æ³¨ï¼šå¦‚æœæ²¡æœ‰å¤§é‡çš„idle -connectionæˆ–è€…dead-connectionï¼Œepollçš„æ•ˆç‡å¹¶ä¸ä¼šæ¯”select/pollé«˜å¾ˆå¤šï¼Œä½†æ˜¯å½“é‡åˆ°å¤§é‡çš„idle- connectionï¼Œå°±ä¼šå‘ç°epollçš„æ•ˆç‡å¤§å¤§é«˜äºselect/pollã€‚</strong></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a><strong>å‚è€ƒ</strong></h3><p><a href="http://www.jianshu.com/p/aed6067eeac9" target="_blank" rel="external">åŒæ­¥ã€å¼‚æ­¥ã€é˜»å¡ä¸éé˜»å¡</a></p>
<p><a href="https://segmentfault.com/a/1190000003063859" target="_blank" rel="external">Linux I/Oæ¨¡å‹</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[JAVA NIO]]></title>
      <url>http://zsr.github.io/2016/10/27/JAVA-NIO/</url>
      <content type="html"><![CDATA[<h3 id="NIOä¼˜ç‚¹"><a href="#NIOä¼˜ç‚¹" class="headerlink" title="NIOä¼˜ç‚¹"></a><strong>NIOä¼˜ç‚¹</strong></h3><p>ä¼ ç»ŸæµI/Oæ˜¯åŸºäºå­—èŠ‚çš„ï¼Œæ‰€æœ‰I/Oéƒ½è¢«è§†ä¸ºå•ä¸ªå­—èŠ‚çš„ç§»åŠ¨ï¼›è€ŒNIOæ˜¯åŸºäºå—çš„ï¼ŒNIOçš„æ€§èƒ½è‚¯å®šä¼˜äºæµI/Oã€‚å…¶æ€§èƒ½çš„æé«˜è¦å¾—ç›Šäºå…¶ä½¿ç”¨çš„ç»“æ„æ›´æ¥è¿‘æ“ä½œç³»ç»Ÿæ‰§è¡ŒI/Oçš„æ–¹å¼ï¼šé€šé“å’Œç¼“å†²å™¨ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªç…¤çŸ¿ï¼Œé€šé“æ˜¯ä¸€ä¸ªåŒ…å«ç…¤å±‚ï¼ˆæ•°æ®ï¼‰çš„çŸ¿è—ï¼Œè€Œç¼“å†²å™¨åˆ™æ˜¯æ´¾é€ åˆ°çŸ¿è—çš„å¡è½¦ã€‚å¡è½¦è½½æ»¡ç…¤ç‚­è€Œå½’ï¼Œæˆ‘ä»¬å†ä»å¡è½¦ä¸Šè·å¾—ç…¤ç‚­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ç›´æ¥å’Œé€šé“äº¤äº’ï¼›æˆ‘ä»¬åªæ˜¯å’Œç¼“å†²å™¨äº¤äº’ï¼Œå¹¶æŠŠç¼“å†²å™¨æ´¾é€åˆ°é€šé“ã€‚é€šé“è¦ä¹ˆä»ç¼“å†²å™¨è·å¾—æ•°æ®ï¼Œè¦ä¹ˆå‘ç¼“å†²å™¨å‘é€æ•°æ®ã€‚</p>
<p>I/Oçš„ç»ˆæç›®æ ‡æ˜¯æ•ˆç‡ï¼Œè€Œæ•ˆç‡ç¦»ä¸å¼€åº•å±‚æ“ä½œç³»ç»Ÿå’Œæ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æ€§æ”¯æŒã€‚è¿™äº›ç‰¹æ€§åŒ…æ‹¬ï¼šæ–‡ä»¶é”å®šã€éé˜»å¡I/Oã€å°±ç»ªæ€§é€‰æ‹©ã€å’Œå†…å­˜æ˜ å°„ã€‚å½“ä»Šæ“ä½œç³»ç»Ÿå¤§éƒ½æ”¯æŒè¿™äº›ç‰¹æ€§ï¼Œè€ŒJavaä¼ ç»ŸI/Oæœºåˆ¶å¹¶æ²¡æœ‰æ¨¡æ‹Ÿè¿™äº›é€šç”¨çš„I/OæœåŠ¡ã€‚</p>
<p>NIO çš„åˆ›å»ºç›®çš„æ˜¯ä¸ºäº†è®© Java ç¨‹åºå‘˜å¯ä»¥å®ç°é«˜é€Ÿ I/O è€Œæ— éœ€ç¼–å†™è‡ªå®šä¹‰çš„æœ¬æœºä»£ç ã€‚NIO å°†æœ€è€—æ—¶çš„ I/O æ“ä½œ(å³å¡«å……å’Œæå–ç¼“å†²åŒº)è½¬ç§»å›æ“ä½œç³»ç»Ÿï¼Œå› è€Œå¯ä»¥æå¤§åœ°æé«˜é€Ÿåº¦ã€‚</p>
<h3 id="ç¼“å†²åŒºæ“ä½œ"><a href="#ç¼“å†²åŒºæ“ä½œ" class="headerlink" title="ç¼“å†²åŒºæ“ä½œ"></a><strong>ç¼“å†²åŒºæ“ä½œ</strong></h3><p>ç¼“å†²åŒºæ“ä½œæ˜¯æ‰€æœ‰I/Oçš„åŸºç¡€ï¼Œè¿›ç¨‹æ‰§è¡ŒI/Oæ“ä½œï¼Œå½’ç»“èµ·æ¥å°±æ˜¯å‘æ“ä½œç³»ç»Ÿå‘å‡ºè¯·æ±‚ï¼Œè®©å®ƒè¦ä¹ˆæŠŠç¼“å†²åŒºé‡Œçš„æ•°æ®æ’å¹²ï¼ˆå†™ï¼‰ï¼Œè¦ä¹ˆæŠŠç¼“å†²åŒºå¡«æ»¡ï¼ˆè¯»ï¼‰ã€‚å¦‚ä¸‹å›¾<br><a href="http://img1.tbcdn.cn/L1/461/1/455589f44a7d459c13a3782be5c8173734880bb1" target="_blank" rel="external"><img src="http://img1.tbcdn.cn/L1/461/1/455589f44a7d459c13a3782be5c8173734880bb1" alt="15184210_Xonl"></a></p>
<p>è¿›ç¨‹ä½¿ç”¨<code>read()</code>ç³»ç»Ÿè°ƒç”¨ï¼Œè¦æ±‚å…¶ç¼“å†²åŒºè¢«å¡«æ»¡ã€‚å†…æ ¸éšå³å‘ç£ç›˜æ§åˆ¶ç¡¬ä»¶å‘å‡ºå‘½ä»¤ï¼Œè¦æ±‚å…¶ä»ç£ç›˜è¯»å–æ•°æ®ã€‚ç£ç›˜æ§åˆ¶å™¨æŠŠæ•°æ®ç›´æ¥å†™å…¥å†…æ ¸å†…å­˜ç¼“å†²åŒºï¼Œè¿™ä¸€æ­¥é€šè¿‡ DMA å®Œæˆï¼Œæ— éœ€ä¸»CPUååŠ©ã€‚ä¸€æ—¦ç£ç›˜æ§åˆ¶å™¨æŠŠç¼“å†²åŒºè£…æ»¡ï¼Œå†…æ ¸å³æŠŠæ•°æ®ä»å†…æ ¸ç©ºé—´çš„ä¸´æ—¶ç¼“å†²åŒºæ‹·è´åˆ°è¿›ç¨‹æ‰§è¡Œ<code>read()</code>è°ƒç”¨æ—¶æŒ‡å®šçš„ç¼“å†²åŒºã€‚</p>
<h3 id="JAVA-NIO"><a href="#JAVA-NIO" class="headerlink" title="JAVA NIO"></a><strong>JAVA NIO</strong></h3><p>JAVAçš„NIOæ˜¯åŸºäºIOå¤šè·¯å¤ç”¨æ¨¡å‹ï¼Œåœ¨ä¸åŒå¹³å°ä¸Šæœ‰ä¸åŒçš„å®ç°æ–¹å¼ã€‚Linuxä¸‹é¢ç”¨çš„æ˜¯pollå’Œepollï¼Œåœ¨BSDä¸Šç”¨kqueueï¼Œåœ¨Windowsä¸Šæ˜¯é‡å I/Oã€‚</p>
<h4 id="1-ç¼“å†²åŒº"><a href="#1-ç¼“å†²åŒº" class="headerlink" title="1. ç¼“å†²åŒº"></a><strong>1. ç¼“å†²åŒº</strong></h4><p>é€šé“æ˜¯å¯¹åŸ I/O åŒ…ä¸­çš„æµçš„æ¨¡æ‹Ÿã€‚åˆ°ä»»ä½•ç›®çš„åœ°(æˆ–æ¥è‡ªä»»ä½•åœ°æ–¹)çš„æ‰€æœ‰æ•°æ®éƒ½å¿…é¡»é€šè¿‡ä¸€ä¸ª Channel å¯¹è±¡ã€‚ä¸€ä¸ª Buffer å®è´¨ä¸Šæ˜¯ä¸€ä¸ªå®¹å™¨å¯¹è±¡ã€‚å‘é€ç»™ä¸€ä¸ªé€šé“çš„æ‰€æœ‰å¯¹è±¡éƒ½å¿…é¡»é¦–å…ˆæ”¾åˆ°ç¼“å†²åŒºä¸­ï¼›åŒæ ·åœ°ï¼Œä»é€šé“ä¸­è¯»å–çš„ä»»ä½•æ•°æ®éƒ½è¦è¯»åˆ°ç¼“å†²åŒºä¸­ã€‚</p>
<p>Bufferæ˜¯ä¸€ä¸ªå¯¹è±¡, å®ƒåŒ…å«ä¸€äº›è¦å†™å…¥æˆ–è€…åˆšè¯»å‡ºçš„æ•°æ®ã€‚ åœ¨ NIO ä¸­åŠ å…¥ Buffer å¯¹è±¡ï¼Œä½“ç°äº†æ–°åº“ä¸åŸ I/O çš„ä¸€ä¸ªé‡è¦åŒºåˆ«ã€‚åœ¨é¢å‘æµçš„ I/O ä¸­ï¼Œæ‚¨å°†æ•°æ®ç›´æ¥å†™å…¥æˆ–è€…å°†æ•°æ®ç›´æ¥è¯»åˆ° Stream å¯¹è±¡ä¸­; åœ¨ NIO åº“ä¸­ï¼Œæ‰€æœ‰æ•°æ®éƒ½æ˜¯ç”¨ç¼“å†²åŒºå¤„ç†çš„ã€‚åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå®ƒæ˜¯ç›´æ¥è¯»åˆ°ç¼“å†²åŒºä¸­çš„ã€‚åœ¨å†™å…¥æ•°æ®æ—¶ï¼Œå®ƒæ˜¯å†™å…¥åˆ°ç¼“å†²åŒºä¸­çš„ã€‚ä»»ä½•æ—¶å€™è®¿é—® NIO ä¸­çš„æ•°æ®ï¼Œéƒ½æ˜¯å°†å®ƒæ”¾åˆ°ç¼“å†²åŒºä¸­ã€‚</p>
<p>ç¼“å†²åŒºå®è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä½†å®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç¼“å†²åŒºè¿˜æä¾›äº†å¯¹æ•°æ®çš„ç»“æ„åŒ–è®¿é—®ï¼Œè€Œä¸”è¿˜å¯ä»¥è·Ÿè¸ªç³»ç»Ÿçš„è¯»/å†™è¿›ç¨‹ã€‚</p>
<p>ç¼“å†²åŒºç±»å‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ByteBuffer</div><div class="line">CharBuffer</div><div class="line">ShortBuffer</div><div class="line">IntBuffer</div><div class="line">LongBuffer</div><div class="line">FloatBuffer</div><div class="line">DoubleBuffer</div></pre></td></tr></table></figure>
<h5 id="1-1-ç¼“å†²åŒºåŸºç¡€"><a href="#1-1-ç¼“å†²åŒºåŸºç¡€" class="headerlink" title="1.1 ç¼“å†²åŒºåŸºç¡€"></a><strong>1.1 ç¼“å†²åŒºåŸºç¡€</strong></h5><p>æ‰€æœ‰çš„ç¼“å†²åŒºéƒ½å…·æœ‰å››ä¸ªå±æ€§æ¥æä¾›å…³äºå…¶æ‰€åŒ…å«çš„æ•°æ®å…ƒç´ çš„ä¿¡æ¯ã€‚</p>
<ul>
<li>å®¹é‡ï¼ˆCapacityï¼‰</li>
</ul>
<blockquote>
<p>ç¼“å†²åŒºèƒ½å¤Ÿå®¹çº³çš„æ•°æ®å…ƒç´ çš„æœ€å¤§æ•°é‡ã€‚è¿™ä¸€å®¹é‡åœ¨ç¼“å†²åŒºåˆ›å»ºæ—¶è¢«è®¾å®šï¼Œå¹¶ä¸”æ°¸è¿œä¸èƒ½<br>è¢«æ”¹å˜ã€‚</p>
<p>limit å†³ä¸èƒ½å¤§äº capacityã€‚</p>
</blockquote>
<ul>
<li>ä¸Šç•Œï¼ˆLimitï¼‰</li>
</ul>
<blockquote>
<p>ç¼“å†²åŒºçš„ç¬¬ä¸€ä¸ªä¸èƒ½è¢«è¯»æˆ–å†™çš„å…ƒç´ limit å˜é‡è¡¨æ˜è¿˜æœ‰å¤šå°‘æ•°æ®éœ€è¦å–å‡º(åœ¨ä»ç¼“å†²åŒºå†™å…¥é€šé“æ—¶)ï¼Œæˆ–è€…è¿˜æœ‰å¤šå°‘ç©ºé—´å¯ä»¥æ”¾å…¥æ•°æ®(åœ¨ä»é€šé“è¯»å…¥ç¼“å†²åŒºæ—¶)ã€‚</p>
<p>position æ€»æ˜¯å°äºæˆ–è€…ç­‰äº limitã€‚æˆ–è€…è¯´ï¼Œç¼“å†²åŒºä¸­ç°å­˜å…ƒç´ çš„è®¡æ•°ã€‚</p>
</blockquote>
<ul>
<li>ä½ç½®ï¼ˆPositionï¼‰</li>
</ul>
<blockquote>
<p>ä¸‹ä¸€ä¸ªè¦è¢«è¯»æˆ–å†™çš„å…ƒç´ çš„ç´¢å¼•ã€‚ä½ç½®ä¼šè‡ªåŠ¨ç”±ç›¸åº”çš„get()å’Œput( )æ–¹æ³•æ›´æ–°ã€‚</p>
<p>æ‚¨å¯ä»¥å›æƒ³ä¸€ä¸‹ï¼Œç¼“å†²åŒºå®é™…ä¸Šå°±æ˜¯ç¾åŒ–äº†çš„æ•°ç»„ã€‚åœ¨ä»é€šé“è¯»å–æ—¶ï¼Œæ‚¨å°†æ‰€è¯»å–çš„æ•°æ®æ”¾åˆ°åº•å±‚çš„æ•°ç»„ä¸­ã€‚ position å˜é‡è·Ÿè¸ªå·²ç»å†™äº†å¤šå°‘æ•°æ®ã€‚æ›´å‡†ç¡®åœ°è¯´ï¼Œå®ƒæŒ‡å®šäº†ä¸‹ä¸€ä¸ªå­—èŠ‚å°†æ”¾åˆ°æ•°ç»„çš„å“ªä¸€ä¸ªå…ƒç´ ä¸­ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨ä»é€šé“ä¸­è¯»ä¸‰ä¸ªå­—èŠ‚åˆ°ç¼“å†²åŒºä¸­ï¼Œé‚£ä¹ˆç¼“å†²åŒºçš„ position å°†ä¼šè®¾ç½®ä¸º3ï¼ŒæŒ‡å‘æ•°ç»„ä¸­ç¬¬å››ä¸ªå…ƒç´ ã€‚</p>
<p>åŒæ ·ï¼Œåœ¨å†™å…¥é€šé“æ—¶ï¼Œæ‚¨æ˜¯ä»ç¼“å†²åŒºä¸­è·å–æ•°æ®ã€‚ position å€¼è·Ÿè¸ªä»ç¼“å†²åŒºä¸­è·å–äº†å¤šå°‘æ•°æ®ã€‚æ›´å‡†ç¡®åœ°è¯´ï¼Œå®ƒæŒ‡å®šä¸‹ä¸€ä¸ªå­—èŠ‚æ¥è‡ªæ•°ç»„çš„å“ªä¸€ä¸ªå…ƒç´ ã€‚å› æ­¤å¦‚æœä»ç¼“å†²åŒºå†™äº†5ä¸ªå­—èŠ‚åˆ°é€šé“ä¸­ï¼Œé‚£ä¹ˆç¼“å†²åŒºçš„ position å°†è¢«è®¾ç½®ä¸º5ï¼ŒæŒ‡å‘æ•°ç»„çš„ç¬¬å…­ä¸ªå…ƒç´ ã€‚</p>
</blockquote>
<ul>
<li>æ ‡è®°ï¼ˆMarkï¼‰</li>
</ul>
<blockquote>
<p>ä¸€ä¸ªå¤‡å¿˜ä½ç½®ã€‚è°ƒç”¨mark( )æ¥è®¾å®šmark= postionã€‚è°ƒç”¨reset( )è®¾å®šposition=<br>markã€‚æ ‡è®°åœ¨è®¾å®šå‰æ˜¯æœªå®šä¹‰çš„(undefined)ã€‚</p>
</blockquote>
<p>è¿™å››ä¸ªå±æ€§ä¹‹é—´æ€»æ˜¯éµå¾ªä»¥ä¸‹å…³ç³»ï¼š<code>0 &lt;= mark &lt;= position &lt;= limit &lt;= capacity</code></p>
<a id="more"></a>
<h5 id="1-2-ç¼“å†²åŒºAPI"><a href="#1-2-ç¼“å†²åŒºAPI" class="headerlink" title="1.2 ç¼“å†²åŒºAPI"></a><strong>1.2 ç¼“å†²åŒºAPI</strong></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> java.nio; </div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">     *å…³äºè¿™ä¸ªAPIæœ‰ä¸€ç‚¹è¦æ³¨æ„çš„æ˜¯ï¼Œåƒclear()è¿™ç±»æ–¹æ³•ï¼Œé€šå¸¸åº”å½“è¿”å›voidï¼Œè€Œä¸</div><div class="line">     *æ˜¯Bufferå¼•ç”¨ã€‚è¿™äº›æ–¹æ³•å°†å¼•ç”¨è¿”å›åˆ°å®ƒä»¬åœ¨ï¼ˆthisï¼‰ä¸Šè¢«å¼•ç”¨çš„å¯¹è±¡ã€‚è¿™æ˜¯ä¸€ä¸ªå…è®¸çº§</div><div class="line">     *è”è°ƒç”¨çš„ç±»è®¾è®¡æ–¹æ³•ã€‚çº§è”è°ƒç”¨å…è®¸è¿™ç§ç±»å‹çš„ä»£ç ï¼š</div><div class="line">     *</div><div class="line">     *å¯¹äºAPIè¿˜è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯isReadOnly()æ–¹æ³•ã€‚æ‰€æœ‰çš„ç¼“å†²åŒºéƒ½æ˜¯å¯è¯»çš„ï¼Œä½†å¹¶éæ‰€</div><div class="line">     *æœ‰éƒ½å¯å†™ã€‚</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Buffer</span> </span>&#123; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">capacity</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">position</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">position</span><span class="params">(<span class="keyword">int</span> newPosition)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">limit</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">limit</span><span class="params">(<span class="keyword">int</span> newLimit)</span></span>; </div><div class="line">        <span class="comment">//ç¼“å†²åŒºçš„æ ‡è®°åœ¨mark( )æ–¹æ³•è¢«è°ƒç”¨ä¹‹å‰æ˜¯æœªå®šä¹‰çš„ï¼ˆå€¼ä¸º-1ï¼‰ã€‚ä¸€äº›ç¼“å†²åŒºæ–¹æ³•ä¼šæŠ›å¼ƒå·²ç»è®¾å®šçš„æ ‡è®°ï¼ˆrewind()ï¼Œclear()ï¼Œä»¥åŠflip()æ€»æ˜¯æŠ›å¼ƒæ ‡è®°ï¼‰ã€‚å¦‚æœæ–°è®¾å®šçš„å€¼æ¯”å½“å‰çš„æ ‡è®°å°ï¼Œè°ƒç”¨limit()æˆ–position()å¸¦æœ‰ç´¢å¼•å‚æ•°çš„ç‰ˆæœ¬ä¼šæŠ›å¼ƒæ ‡è®°ã€‚</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">mark</span><span class="params">()</span></span>;</div><div class="line">        <span class="comment">//reset( )æ–¹æ³•å°†ä½ç½®è®¾ä¸ºå½“å‰çš„æ ‡è®°å€¼ã€‚</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">reset</span><span class="params">()</span></span>;</div><div class="line">        <span class="comment">//å°†ä¸Šç•Œè®¾ä¸ºå®¹é‡çš„å€¼ï¼Œå¹¶æŠŠä½ç½®è®¾å›0ï¼Œè¿™ä½¿å¾—ç¼“å†²åŒºå¯ä»¥è¢«é‡æ–°å¡«å…¥ã€‚</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">clear</span><span class="params">()</span></span>;</div><div class="line">        <span class="comment">//ç¿»è½¬ ç›¸å½“äºlimit(buffer.position()).position(0)</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">flip</span><span class="params">()</span></span>;</div><div class="line">        <span class="comment">//ä¸flip()ç›¸ä¼¼ï¼Œä½†ä¸å½±å“ä¸Šç•Œå±æ€§ã€‚å®ƒåªæ˜¯å°†ä½ç½®å€¼è®¾å›0ã€‚æ‚¨å¯ä»¥ä½¿ç”¨rewind()åé€€ï¼Œé‡è¯»å·²ç»è¢«ç¿»è½¬çš„ç¼“å†²åŒºä¸­çš„æ•°æ®ã€‚</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">rewind</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">remaining</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasRemaining</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span>  <span class="keyword">boolean</span> <span class="title">isReadOnly</span><span class="params">()</span></span>; </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢æ‰€åˆ—å‡ºçš„çš„Buffer APIå¹¶æ²¡æœ‰åŒ…æ‹¬get()æˆ–put()æ–¹æ³•ã€‚æ¯ä¸€ä¸ªBufferç±»éƒ½æœ‰è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œä½†å®ƒä»¬æ‰€é‡‡ç”¨çš„å‚æ•°ç±»å‹ï¼Œä»¥åŠå®ƒä»¬è¿”å›çš„æ•°æ®ç±»å‹ï¼Œå¯¹æ¯ä¸ªå­ç±»æ¥è¯´éƒ½æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥å®ƒä»¬ä¸èƒ½åœ¨é¡¶å±‚Bufferç±»ä¸­è¢«æŠ½è±¡åœ°å£°æ˜ã€‚</p>
<h5 id="1-3-å­—èŠ‚ç¼“å†²åŒº"><a href="#1-3-å­—èŠ‚ç¼“å†²åŒº" class="headerlink" title="1.3 å­—èŠ‚ç¼“å†²åŒº"></a><strong>1.3 å­—èŠ‚ç¼“å†²åŒº</strong></h5><p>å­—èŠ‚æ˜¯æ“ä½œç³»ç»ŸåŠå…¶I/Oè®¾å¤‡ä½¿ç”¨çš„åŸºæœ¬æ•°æ®ç±»å‹ã€‚å½“åœ¨JVMå’Œæ“ä½œç³»ç»Ÿé—´ä¼ é€’æ•°æ®æ—¶ï¼Œå°†å…¶ä»–çš„æ•°æ®ç±»å‹æ‹†åˆ†æˆæ„æˆå®ƒä»¬çš„å­—èŠ‚æ˜¯ååˆ†å¿…è¦çš„ã€‚ç³»ç»Ÿå±‚æ¬¡çš„I/Oé¢å‘å­—èŠ‚çš„æ€§è´¨å¯ä»¥åœ¨æ•´ä¸ªç¼“å†²åŒºçš„è®¾è®¡ä»¥åŠå®ƒä»¬äº’ç›¸é…åˆçš„æœåŠ¡ä¸­æ„Ÿå—åˆ°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> java.nio; </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteBuffer</span> <span class="keyword">extends</span> <span class="title">Buffer</span> <span class="keyword">implements</span> <span class="title">Comparable</span> </span></div><div class="line">    &#123; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title">allocate</span> <span class="params">(<span class="keyword">int</span> capacity)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title">allocateDirect</span> <span class="params">(<span class="keyword">int</span> capacity)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span>  <span class="keyword">boolean</span> <span class="title">isDirect</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title">wrap</span> <span class="params">(<span class="keyword">byte</span>[] array, <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title">wrap</span> <span class="params">(<span class="keyword">byte</span>[] array)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">duplicate</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span>  ByteBuffer <span class="title">asReadOnlyBuffer</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span>  ByteBuffer <span class="title">slice</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasArray</span><span class="params">()</span></span>; </div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] array(); </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">arrayOffset</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span>  <span class="keyword">byte</span> <span class="title">get</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">byte</span> <span class="title">get</span> <span class="params">(<span class="keyword">int</span> index)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> ByteBuffer <span class="title">get</span> <span class="params">(<span class="keyword">byte</span>[] dst, <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">put</span> <span class="params">(<span class="keyword">byte</span> b)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">put</span> <span class="params">(<span class="keyword">int</span> index, <span class="keyword">byte</span> b)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> ByteBuffer <span class="title">put</span> <span class="params">(ByteBuffer src)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> ByteBuffer <span class="title">put</span> <span class="params">(<span class="keyword">byte</span>[] src, <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ByteBuffer <span class="title">put</span> <span class="params">(<span class="keyword">byte</span>[] src)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ByteOrder <span class="title">order</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ByteBuffer <span class="title">order</span> <span class="params">(ByteOrder bo)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span>  CharBuffer <span class="title">asCharBuffer</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ShortBuffer <span class="title">asShortBuffer</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span>  IntBuffer <span class="title">asIntBuffer</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> LongBuffer <span class="title">asLongBuffer</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span>  FloatBuffer <span class="title">asFloatBuffer</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> DoubleBuffer <span class="title">asDoubleBuffer</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">char</span> <span class="title">getChar</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">char</span> <span class="title">getChar</span> <span class="params">(<span class="keyword">int</span> index)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">putChar</span> <span class="params">(<span class="keyword">char</span> value)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">putChar</span> <span class="params">(<span class="keyword">int</span> index, <span class="keyword">char</span> value)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">short</span> <span class="title">getShort</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">short</span> <span class="title">getShort</span> <span class="params">(<span class="keyword">int</span> index)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">putShort</span> <span class="params">(<span class="keyword">short</span> value)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">putShort</span> <span class="params">(<span class="keyword">int</span> index, <span class="keyword">short</span> value)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getInt</span> <span class="params">(<span class="keyword">int</span> index)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">putInt</span> <span class="params">(<span class="keyword">int</span> value)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">putInt</span> <span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">getLong</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">getLong</span> <span class="params">(<span class="keyword">int</span> index)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">putLong</span> <span class="params">(<span class="keyword">long</span> value)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">putLong</span> <span class="params">(<span class="keyword">int</span> index, <span class="keyword">long</span> value)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">float</span> <span class="title">getFloat</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">float</span> <span class="title">getFloat</span> <span class="params">(<span class="keyword">int</span> index)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">putFloat</span> <span class="params">(<span class="keyword">float</span> value)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">putFloat</span> <span class="params">(<span class="keyword">int</span> index, <span class="keyword">float</span> value)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">double</span> <span class="title">getDouble</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">double</span> <span class="title">getDouble</span> <span class="params">(<span class="keyword">int</span> index)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">putDouble</span> <span class="params">(<span class="keyword">double</span> value)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">putDouble</span> <span class="params">(<span class="keyword">int</span> index, <span class="keyword">double</span> value)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">compact</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span> <span class="params">(Object ob)</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span> <span class="params">(Object ob)</span></span>;  </div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>; </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li>å­—èŠ‚é¡ºåº</li>
</ul>
<blockquote>
<p>å¤šå­—èŠ‚æ•°å€¼è¢«å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ–¹å¼ä¸€èˆ¬è¢«ç§°ä¸ºendian-nessï¼ˆå­—èŠ‚é¡ºåºï¼‰ã€‚å¦‚æœæ•°å­—æ•°å€¼çš„æœ€é«˜å­—èŠ‚â€”â€”big endï¼ˆå¤§ç«¯ï¼‰ï¼Œä½äºä½ä½åœ°å€ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±æ˜¯å¤§ç«¯å­—èŠ‚é¡ºåºã€‚å­—èŠ‚é¡ºåºå¾ˆå°‘ç”±è½¯ä»¶è®¾è®¡è€…å†³å®šï¼›å®ƒé€šå¸¸å–å†³äºç¡¬ä»¶è®¾è®¡ã€‚å¦‚æœæœ€ä½å­—èŠ‚æœ€å…ˆä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œé‚£ä¹ˆå°ç«¯å­—èŠ‚é¡ºåºã€‚</p>
<p>å½“Internetçš„è®¾è®¡è€…ä¸ºäº’è”å„ç§ç±»å‹çš„è®¡ç®—æœºè€Œè®¾è®¡ç½‘é™…åè®®ï¼ˆIPï¼‰æ—¶ï¼Œä»–ä»¬æ„è¯†åˆ°äº†åœ¨å…·æœ‰ä¸åŒå†…éƒ¨å­—èŠ‚é¡ºåºçš„ç³»ç»Ÿé—´ä¼ é€’æ•°å€¼æ•°æ®çš„é—®é¢˜ã€‚å› æ­¤ï¼ŒIPåè®®è§„å®šäº†ä½¿ç”¨å¤§ç«¯çš„ç½‘ç»œå­—èŠ‚é¡ºåºæ¦‚å¿µã€‚æ‰€æœ‰åœ¨IPåˆ†ç»„æŠ¥æ–‡çš„åè®®éƒ¨åˆ†ä¸­ä½¿ç”¨çš„å¤šå­—èŠ‚æ•°å€¼å¿…é¡»å…ˆåœ¨æœ¬åœ°ä¸»æœºå­—èŠ‚é¡ºåºå’Œé€šç”¨çš„ç½‘ç»œå­—èŠ‚é¡ºåºä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚</p>
</blockquote>
<p>åœ¨java.nioä¸­ï¼Œå­—èŠ‚é¡ºåºç”±ByteOrderç±»å°è£…ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> java.nio; </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteOrder</span> </span></div><div class="line">   &#123; </div><div class="line">       <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ByteOrder BIG_ENDIAN;</div><div class="line">       <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ByteOrder LITTLE_ENDIAN; </div><div class="line">       <span class="comment">//è·å–JVMè¿è¡Œå¹³å°çš„å­—èŠ‚é¡ºåº</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteOrder <span class="title">nativeOrder</span><span class="params">()</span></span>;</div><div class="line">       <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>ByteBufferç±»æœ‰æ‰€ä¸åŒï¼šé»˜è®¤å­—èŠ‚é¡ºåºæ€»æ˜¯ByteBuffer.BIG_ENDIANï¼Œæ— è®ºç³»ç»Ÿçš„å›ºæœ‰å­—èŠ‚é¡ºåºæ˜¯ä»€ä¹ˆã€‚Javaçš„é»˜è®¤å­—èŠ‚é¡ºåºæ˜¯å¤§ç«¯å­—èŠ‚é¡ºåºï¼Œè¿™å…è®¸ç±»æ–‡ä»¶ç­‰ä»¥åŠä¸²è¡ŒåŒ–çš„å¯¹è±¡å¯ä»¥åœ¨ä»»ä½•JVMä¸­å·¥ä½œã€‚å¦‚æœå›ºæœ‰ç¡¬ä»¶å­—èŠ‚é¡ºåºæ˜¯å°ç«¯ï¼Œè¿™ä¼šæœ‰æ€§èƒ½éšæ‚£ã€‚åœ¨ä½¿ç”¨å›ºæœ‰ç¡¬ä»¶å­—èŠ‚é¡ºåºæ—¶ï¼Œå°†ByteBufferçš„å†…å®¹å½“ä½œå…¶ä»–æ•°æ®ç±»å‹å­˜å–å¾ˆå¯èƒ½é«˜æ•ˆå¾—å¤šã€‚</p>
<h4 id="2-é€šé“"><a href="#2-é€šé“" class="headerlink" title="2. é€šé“"></a><strong>2. é€šé“</strong></h4><p>é€šé“ï¼ˆChannelï¼‰æ˜¯java.nioçš„ç¬¬äºŒä¸ªä¸»è¦åˆ›æ–°ã€‚å®ƒä»¬æ—¢ä¸æ˜¯ä¸€ä¸ªæ‰©å±•ä¹Ÿä¸æ˜¯ä¸€é¡¹å¢å¼ºï¼Œè€Œæ˜¯å…¨æ–°ã€æå¥½çš„Java I/Oç¤ºä¾‹ï¼Œæä¾›ä¸I/OæœåŠ¡çš„ç›´æ¥è¿æ¥ã€‚Channelç”¨äºåœ¨å­—èŠ‚ç¼“å†²åŒºå’Œä½äºé€šé“å¦ä¸€ä¾§çš„å®ä½“ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªæ–‡ä»¶æˆ–å¥—æ¥å­—ï¼‰ä¹‹é—´æœ‰æ•ˆåœ°ä¼ è¾“æ•°æ®ã€‚</p>
<h5 id="2-1-é€šé“åŸºç¡€"><a href="#2-1-é€šé“åŸºç¡€" class="headerlink" title="2.1 é€šé“åŸºç¡€"></a><strong>2.1 é€šé“åŸºç¡€</strong></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> java.nio.channels;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Channel</span></span>;</div><div class="line">   &#123;</div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isOpen</span><span class="params">()</span></span>;</div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>é€šé“æ¥å£å…è®¸æ‚¨ä»¥ä¸€ç§å—æ§ä¸”å¯ç§»æ¤çš„æ–¹å¼æ¥è®¿é—®åº•å±‚çš„I/OæœåŠ¡ã€‚</p>
<p>é€šé“æ˜¯è®¿é—®I/OæœåŠ¡çš„å¯¼ç®¡ã€‚I/Oå¯ä»¥åˆ†ä¸ºå¹¿ä¹‰çš„ä¸¤å¤§ç±»åˆ«ï¼šFile I/Oå’ŒStream I/Oã€‚é‚£ä¹ˆç›¸åº”åœ°æœ‰ä¸¤ç§ç±»å‹çš„é€šé“ä¹Ÿå°±ä¸è¶³ä¸ºæ€ªäº†ï¼Œå®ƒä»¬æ˜¯æ–‡ä»¶ï¼ˆfileï¼‰é€šé“å’Œå¥—æ¥å­—ï¼ˆsocketï¼‰é€šé“ â€”â€”â€”â€” ä¸€ä¸ªFileChannelç±»å’Œä¸‰ä¸ªsocketé€šé“ç±»ï¼šSocketChannelã€ServerSocketChannelå’Œ DatagramChannelã€‚</p>
<h5 id="2-2-é€šé“API"><a href="#2-2-é€šé“API" class="headerlink" title="2.2 é€šé“API"></a><strong>2.2 é€šé“API</strong></h5><p>ByteChannelæ¥å£ï¼Œå®ƒåŒæ—¶ç»§æ‰¿äº†ReadableByteChannel å’ŒWritableByteChannelä¸¤ä¸ªæ¥å£ã€‚ByteChannelæ¥å£æœ¬èº«å¹¶ä¸å®šä¹‰æ–°çš„APIæ–¹æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªèšé›†äº†æ‰€ç»§æ‰¿çš„å¤šä¸ªæ¥å£ï¼Œå¹¶é‡æ–°å‘½åçš„ä¾¿æ·æ¥å£ã€‚æ ¹æ®å®šä¹‰ï¼Œå®ç°ByteChannelæ¥å£çš„é€šé“åŒæ—¶ä¹Ÿä¼šå®ç°ReadableByteChannel å’ŒWritableByteChannelä¸¤ä¸ªæ¥å£ï¼Œæ‰€ä»¥æ­¤ç±»é€šé“æ˜¯åŒå‘çš„ã€‚</p>
<p>é€šé“å¯ä»¥ä»¥é˜»å¡ï¼ˆblockingï¼‰æˆ–éé˜»å¡ï¼ˆnon-blockingï¼‰æ¨¡å¼è¿è¡Œã€‚éé˜»å¡æ¨¡å¼çš„é€šé“æ°¸è¿œä¸ä¼šè®©è°ƒç”¨çš„çº¿ç¨‹ä¼‘çœ ã€‚è¯·æ±‚çš„æ“ä½œè¦ä¹ˆç«‹å³å®Œæˆï¼Œè¦ä¹ˆè¿”å›ä¸€ä¸ªç»“æœè¡¨æ˜æœªè¿›è¡Œä»»ä½•æ“ä½œã€‚åªæœ‰é¢å‘æµçš„ï¼ˆstream-orientedï¼‰çš„é€šé“ï¼Œå¦‚socketså’Œpipesæ‰èƒ½ä½¿ç”¨éé˜»å¡æ¨¡å¼ã€‚</p>
<p>socketé€šé“ç±»ç»§æ‰¿äº†SelectableChannelã€‚ç»§æ‰¿SelectableChannelçš„ç±»å¯ä»¥å’ŒSelectorä¸€èµ·ä½¿ç”¨ï¼Œåè€…æ”¯æŒå°±ç»ªé€‰æ‹©ã€‚å°†éé˜»å¡I/Oå’Œé€‰æ‹©å™¨ç»„åˆèµ·æ¥å¯ä»¥ä½¿æ‚¨çš„ç¨‹åºåˆ©ç”¨å¤šè·¯å¤ç”¨I/Oã€‚</p>
<p>ä¸ç¼“å†²åŒºä¸åŒï¼Œé€šé“ä¸èƒ½è¢«é‡å¤ä½¿ç”¨ã€‚ä¸€ä¸ªæ‰“å¼€çš„é€šé“å³ä»£è¡¨ä¸ä¸€ä¸ªç‰¹å®šI/OæœåŠ¡çš„ç‰¹å®šè¿æ¥å¹¶å°è£…è¯¥è¿æ¥çš„çŠ¶æ€ã€‚å½“é€šé“å…³é—­æ—¶ï¼Œé‚£ä¸ªè¿æ¥ä¼šä¸¢å¤±ï¼Œç„¶åé€šé“å°†ä¸å†è¿æ¥ä»»ä½•ä¸œè¥¿ã€‚</p>
<p>è°ƒç”¨é€šé“çš„close( )æ–¹æ³•æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´åœ¨é€šé“å…³é—­åº•å±‚I/OæœåŠ¡çš„è¿‡ç¨‹ä¸­çº¿ç¨‹æš‚æ—¶é˜»å¡ï¼Œå“ªæ€•è¯¥é€šé“å¤„äºéé˜»å¡æ¨¡å¼ã€‚é€šé“å…³é—­æ—¶çš„é˜»å¡è¡Œä¸ºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰æ˜¯é«˜åº¦å–å†³äºæ“ä½œç³»ç»Ÿæˆ–è€…æ–‡ä»¶ç³»ç»Ÿçš„ã€‚åœ¨ä¸€ä¸ªé€šé“ä¸Šå¤šæ¬¡è°ƒç”¨close( )æ–¹æ³•æ˜¯æ²¡æœ‰åå¤„çš„ï¼Œä½†æ˜¯å¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨close( )æ–¹æ³•ä¸­é˜»å¡ï¼Œé‚£ä¹ˆåœ¨å®ƒå®Œæˆå…³é—­é€šé“ä¹‹å‰ï¼Œä»»ä½•å…¶ä»–è°ƒç”¨close( )æ–¹æ³•éƒ½ä¼šé˜»å¡ã€‚åç»­åœ¨è¯¥å·²å…³é—­çš„é€šé“ä¸Šè°ƒç”¨close( )ä¸ä¼šäº§ç”Ÿä»»ä½•æ“ä½œï¼Œåªä¼šç«‹å³è¿”å›ã€‚</p>
<h5 id="2-3-æ–‡ä»¶é€šé“API"><a href="#2-3-æ–‡ä»¶é€šé“API" class="headerlink" title="2.3 æ–‡ä»¶é€šé“API"></a><strong>2.3 æ–‡ä»¶é€šé“API</strong></h5><p>FileChannelç±»å¯ä»¥å®ç°å¸¸ç”¨çš„readï¼Œwriteæ“ä½œ.åŒæ—¶å®ƒä¹Ÿæä¾›äº†å¾ˆå¤šä¸“ç”¨äºæ–‡ä»¶çš„æ–°æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•ä¸­çš„è®¸å¤šéƒ½æ˜¯æˆ‘ä»¬æ‰€ç†Ÿæ‚‰çš„æ–‡ä»¶æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> java.nio.channels;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FileChannel</span> <span class="keyword">extends</span> <span class="title">AbstractChannel</span> <span class="keyword">implements</span> <span class="title">ByteChannel</span>, <span class="title">GatheringByteChannel</span>, <span class="title">ScatteringByteChannel</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">// This is a partial API listing</span></div><div class="line">        <span class="comment">// All methods listed here can throw java.io.IOException</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">read</span> <span class="params">(ByteBuffer dst, <span class="keyword">long</span> position)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">write</span> <span class="params">(ByteBuffer src, <span class="keyword">long</span> position)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">size</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">position</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">position</span> <span class="params">(<span class="keyword">long</span> newPosition)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">truncate</span> <span class="params">(<span class="keyword">long</span> size)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">force</span> <span class="params">(<span class="keyword">boolean</span> metaData)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> FileLock <span class="title">lock</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> FileLock <span class="title">lock</span> <span class="params">(<span class="keyword">long</span> position, <span class="keyword">long</span> size, <span class="keyword">boolean</span> shared)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> FileLock <span class="title">tryLock</span><span class="params">()</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> FileLock <span class="title">tryLock</span> <span class="params">(<span class="keyword">long</span> position, <span class="keyword">long</span> size, <span class="keyword">boolean</span> shared)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> MappedByteBuffer <span class="title">map</span> <span class="params">(MapMode mode, <span class="keyword">long</span> position, <span class="keyword">long</span> size)</span></span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MapMode</span></span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MapMode READ_ONLY;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MapMode READ_WRITE;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MapMode PRIVATE;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">transferTo</span> <span class="params">(<span class="keyword">long</span> position, <span class="keyword">long</span> count, WritableByteChannel target)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">transferFrom</span> <span class="params">(ReadableByteChannel src, <span class="keyword">long</span> position, <span class="keyword">long</span> count)</span></span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[maven é€šè¿‡é…ç½®æ‰“ä¸åŒç¯å¢ƒçš„åŒ…]]></title>
      <url>http://zsr.github.io/2016/10/19/maven-%E9%80%9A%E8%BF%87%E9%85%8D%E7%BD%AE%E6%89%93%E4%B8%8D%E5%90%8C%E7%8E%AF%E5%A2%83%E7%9A%84%E5%8C%85/</url>
      <content type="html"><![CDATA[<h3 id="èƒŒæ™¯ï¼šä¸€"><a href="#èƒŒæ™¯ï¼šä¸€" class="headerlink" title="èƒŒæ™¯ï¼šä¸€"></a><strong>èƒŒæ™¯ï¼šä¸€</strong></h3><p>é¡¹ç›®ç”±ä¸åŒçš„åˆ†æ”¯(å¦‚ï¼šdevï¼Œ test,  product),æ¯ä¸€åˆ†æ”¯å¯¹åº”çš„ç¯å¢ƒå˜é‡æœ‰å·®å¼‚ã€‚éœ€è¦æ ¹æ®mavenæ‰“åŒ…å‘½ä»¤ä¼ å…¥ä¸åŒçš„å‚æ•°(å¦‚ -Ptest)æ¥å®ç°å…·ä½“ä½¿ç”¨å“ªä¸ªåˆ†æ”¯çš„é…ç½®ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<ul>
<li><strong>åœ¨pom.xmlé…ç½®çš„<code>&lt;profiles&gt; &lt;/profiles&gt;</code>ä¸­æ·»åŠ <code>&lt;profile&gt; &lt;/profile&gt;</code></strong></li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">activation</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span> <span class="tag">&lt;<span class="name">!</span> <span class="attr">-</span> <span class="attr">-</span>è¿™é‡Œé»˜è®¤æ˜¯<span class="attr">dev-</span> <span class="attr">-</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">envcfg.dir</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">envcfg.dir</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>test<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">envcfg.dir</span>&gt;</span>test<span class="tag">&lt;/<span class="name">envcfg.dir</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>pro<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">envcfg.dir</span>&gt;</span>product<span class="tag">&lt;/<span class="name">envcfg.dir</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div></pre></td></tr></table></figure>
<p>åœ¨<code>&lt;properties&gt; &lt;/properties&gt;</code>ä¸­é…ç½®ä¸åŒçš„ç¯å¢ƒå‚æ•°(è¿™é‡Œæ˜¯é…ç½®æ–‡ä»¶ç›®å½•å)ã€‚</p>
<ul>
<li><strong>åœ¨pom.xmlæ–‡ä»¶ä¸­é…ç½®build</strong></li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">sourceDirectory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">sourceDirectory</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">testSourceDirectory</span>&gt;</span>src/test/java<span class="tag">&lt;/<span class="name">testSourceDirectory</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>target/classes<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">testOutputDirectory</span>&gt;</span>target/test-classes<span class="tag">&lt;/<span class="name">testOutputDirectory</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">testResources</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">testResource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/test/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">testResource</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">testResources</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!--æ³¨æ„è¿™é‡Œå¼•ç”¨çš„$&#123;envcfg.dir&#125;--&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/conf/$&#123;envcfg.dir&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">directory</span>&gt;</span>target<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure>
<p>åœ¨<code>&lt;build&gt;&lt;/build&gt;</code> é…ç½®ä¸­æ·»åŠ ä¸Šä¸€æ­¥çš„æ–‡ä»¶ç›®å½•åï¼Œè¿™æ ·ä½¿ç”¨maven -Ptest å‘½ä»¤æ‰“åŒ…çš„æ—¶å€™ï¼Œä¼šå°†src/main/conf/testç›®å½•ä¸‹çš„æ–‡ä»¶éƒ½æ·»åŠ åˆ°é¡¹ç›®è·¯å¾„ä¸‹é¢ã€‚</p>
<h3 id="èƒŒæ™¯-äºŒ"><a href="#èƒŒæ™¯-äºŒ" class="headerlink" title="èƒŒæ™¯: äºŒ"></a><strong>èƒŒæ™¯: äºŒ</strong></h3><p>å¦‚æœåªé…ç½®äº†<code>&lt;profiles&gt; &lt;/profiles&gt;</code>ï¼Œåˆ™å½“å‰ä»“åº“ä¸­åŒä¸€ç‰ˆæœ¬åªèƒ½æœ‰ä¸€ä¸ªjaråŒ…ï¼Œè¿™æ ·é€‰æ‹©-Ptestæˆ–è€…-Pproå‘½ä»¤å°±ä¼šè¦†ç›–jaråŒ…ï¼Œå¯¼è‡´å®¢æˆ·ç«¯è°ƒç”¨äº§ç”Ÿé—®é¢˜ï¼ˆæ¯”å¦‚ï¼šlocation-local-0.3.3.jar,è¿™ä¸ªç‰ˆæœ¬å¯èƒ½æ˜¯testæˆ–è€…proï¼Œå®¢æˆ·ç«¯å¦‚æœç”Ÿäº§ç‰ˆæœ¬è°ƒç”¨äº†test jaråŒ…åˆ™ä¼šäº§ç”Ÿå¼‚å¸¸ï¼‰ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ:</strong> åœ¨æ¯ä¸€ä¸ªåˆ†æ”¯jaråŒ…åé¢å¸¦ä¸Šåˆ†æ”¯åç§°ï¼Œå¦‚ï¼šlocation-local-0.3.5-test.jar;è¿™æ ·å®¢æˆ·ç«¯å°±å¯ä»¥é€‰æ‹©ä¸åŒåˆ†æ”¯çš„jaråŒ…ã€‚</p>
<ul>
<li><strong>åœ¨æœåŠ¡ç«¯pom.xmlä¸­å¦‚ä¸‹é…ç½®</strong>ï¼š(æ³¨æ„åŠ **çš„åœ°æ–¹ä¸èƒŒæ™¯ä¸€ä¸åŒ)</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">åœ¨<span class="tag">&lt;<span class="name">build</span>&gt;</span><span class="tag">&lt;/<span class="name">build</span>&gt;</span>æ ‡ç­¾ä¸­é…ç½®ï¼š</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">sourceDirectory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">sourceDirectory</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">testSourceDirectory</span>&gt;</span>src/test/java<span class="tag">&lt;/<span class="name">testSourceDirectory</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>target/classes<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">testOutputDirectory</span>&gt;</span>target/test-classes<span class="tag">&lt;/<span class="name">testOutputDirectory</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">testResources</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">testResource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/test/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">testResource</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">testResources</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/conf/$&#123;envcfg.dir&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">directory</span>&gt;</span>target<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!--æ–°å¢éƒ¨åˆ†é…ç½®--&gt;</span></div><div class="line"> **</div><div class="line">    <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">id</span>&gt;</span>default-jar<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>$&#123;envcfg.classifier&#125;<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line">**</div><div class="line"></div><div class="line">åœ¨<span class="tag">&lt;<span class="name">profile</span>&gt;</span><span class="tag">&lt;/<span class="name">profile</span>&gt;</span>æ ‡ç­¾ä¸­é…ç½®ï¼š</div><div class="line"></div><div class="line">   <span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">activation</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">       ** <span class="tag">&lt;<span class="name">envcfg.classifier</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">envcfg.classifier</span>&gt;</span> **</div><div class="line">        <span class="tag">&lt;<span class="name">envcfg.dir</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">envcfg.dir</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>test<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">       ** <span class="tag">&lt;<span class="name">envcfg.classifier</span>&gt;</span>test<span class="tag">&lt;/<span class="name">envcfg.classifier</span>&gt;</span> **</div><div class="line">        <span class="tag">&lt;<span class="name">envcfg.dir</span>&gt;</span>test<span class="tag">&lt;/<span class="name">envcfg.dir</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>pro<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">       ** <span class="tag">&lt;<span class="name">envcfg.classifier</span>&gt;</span>product<span class="tag">&lt;/<span class="name">envcfg.classifier</span>&gt;</span> **</div><div class="line">        <span class="tag">&lt;<span class="name">envcfg.dir</span>&gt;</span>product<span class="tag">&lt;/<span class="name">envcfg.dir</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>classifier</code>æŒ‡å‘jaråŒ…åç¼€çš„åç§°ã€‚</p>
<ul>
<li><strong>å®¢æˆ·ç«¯pom.xmlå¼•ç”¨é…ç½®å¦‚ä¸‹ï¼š</strong></li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ximalaya.location<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>location-local<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.3.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>test<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>é€šè¿‡<code>classifier</code>å¯ä»¥é€‰æ‹©éœ€è¦å¼•ç”¨çš„jaråŒ…ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Google S2]]></title>
      <url>http://zsr.github.io/2016/10/17/Google-S2/</url>
      <content type="html"><![CDATA[<h3 id="Google-S2ä½œç”¨ï¼š"><a href="#Google-S2ä½œç”¨ï¼š" class="headerlink" title="Google S2ä½œç”¨ï¼š"></a><strong>Google S2ä½œç”¨ï¼š</strong></h3><p>æ ¹æ®å¤šè¾¹å½¢çš„è¾¹ç•ŒåŒºåŸŸæ˜ å°„æˆç”±è®¸å¤šä¸€ç»´æ•°å€¼æ„æˆçš„é›†åˆï¼Œè¿™æ ·å°±å¯ä»¥ç”±è¿™ä¸ªé›†åˆä»£æ›¿å¤šè¾¹å½¢åŒºåŸŸï¼Œä¾¿äºåç»­è®¡ç®—ã€‚<br>å…¸å‹çš„å¯ä»¥å°†ä¸åŒå›½å®¶(æˆ–è€…åœ°åŒº)çš„è¾¹ç•ŒåŒºåŸŸ(ç»çº¬åº¦)è®¡ç®—æˆä¸€ç»´æ•°å€¼çš„é›†åˆï¼Œå¯ä»¥ç”¨äºåˆ¤æ–­è¯¥åŒºåŸŸçš„ä»»ä½•ä¸€ä¸ªåæ ‡æ˜¯å¦åŒ…æ¶µåœ¨å†…ï¼Œç®€å•çš„è¯´å°±æ˜¯åœ°ç†å®šä½ã€‚</p>
<p>s2åº“æä¾›äº†ä¸€ä¸ªCellçš„æ¦‚å¿µï¼Œ<strong>æ¯ä¸ªCellç›¸å½“äºä¸€ä¸ªå•å…ƒæ ¼ï¼Œåœ¨ä¸€ä¸ªå•å…ƒæ ¼å†…çš„æ‰€æœ‰Pointï¼Œéƒ½å¯ä»¥ç®—å‡ºåŒä¸€ä¸ªCellId</strong>ã€‚åŒæ—¶å¯ä»¥è®¤ä¸ºï¼Œä¸€ä¸ªPolygonå¯ä»¥ç”¨ä¸€ä¸ªCellçš„é›†åˆæ¥è¡¨ç¤ºã€‚<br>é‚£ä¹ˆè¿™æ—¶çš„æ­¥éª¤å°±æ˜¯é€šè¿‡åŒºåŸŸçš„åæ ‡ï¼Œæ¥åˆå§‹åŒ–å…¶å†…åŒ…å«çš„æ‰€æœ‰çš„CellIdï¼Œå°†è¿™äº›CellIdçš„idæ”¾å…¥redisä¸­åškeyï¼Œå¯¹åº”çš„valueæ˜¯åŒºåŸŸåç§°(è­¬å¦‚ï¼Œä¸Šæµ·æµ¦ä¸œæ–°åŒº)ï¼Œæ„å»ºå®Œå…¨å›½èŒƒå›´çš„CellIdåï¼ŒæŸ¥è¯¢ç”¨æˆ·çš„åŒºåŸŸå°±å¯ä»¥é€šè¿‡ç”¨æˆ·çš„åæ ‡è·å¾—ä¸€ä¸ªCellIdï¼Œç„¶åå»redisä¸­æŸ¥è¯¢ï¼Œåœ¨ä½¿ç”¨LocalCacheåï¼ŒåŸºæœ¬å°±æ²¡æœ‰ä»€ä¹ˆè®¡ç®—æˆæœ¬ï¼Œå®Œå…¨å¯ä»¥æ»¡è¶³æ€§èƒ½éœ€æ±‚ã€‚</p>
<h3 id="æ“ä½œæ­¥éª¤ï¼š"><a href="#æ“ä½œæ­¥éª¤ï¼š" class="headerlink" title="æ“ä½œæ­¥éª¤ï¼š"></a><strong>æ“ä½œæ­¥éª¤ï¼š</strong></h3><p>1ï¼‰é¦–å…ˆè·å–åœ°åŸŸå›¾å½¢çš„åæ ‡ç‚¹é›†åˆï¼Œå¯ä»¥ä»Natural Earthç½‘ç«™è·å–å…¨çƒçš„åæ ‡å…ƒæ•°æ®(.shpæ–‡ä»¶)ã€‚<br>2ï¼‰è§£æshpæ–‡ä»¶ï¼Œç”ŸæˆåŒºåŸŸåæ ‡é›†åˆï¼Œè¿™é‡Œé€‰æ‹©pyshp(è§£æshpæ–‡ä»¶çš„pythonæ’ä»¶)ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ï¼šåŒä¸€ä¸ªå›½å®¶å¯èƒ½åŒ…æ¶µå¤šä¸ªåŒºåŸŸ(muti Polygon)ï¼Œéœ€è¦åˆ†å¼€å¤„ç†ã€‚ä¸‹è½½åœ°å€ï¼š<a href="https://pypi.python.org/pypi/pyshp/" target="_blank" rel="external">https://pypi.python.org/pypi/pyshp/</a><br>3ï¼‰ä½¿ç”¨Google S2å°†å¤šè¾¹å½¢çš„è¾¹ç•Œåæ ‡é›†åˆè½¬åŒ–ä¸ºä¸€ç»´æ•°å€¼é›†åˆï¼Œä»£è¡¨è¿™ä¸ªå¤šè¾¹å½¢çš„è¦†ç›–åŒºåŸŸã€‚</p>
<h3 id="S2åŸç†ï¼š"><a href="#S2åŸç†ï¼š" class="headerlink" title="S2åŸç†ï¼š"></a><strong>S2åŸç†ï¼š</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">S2RegionCoverer coverer = <span class="keyword">new</span> S2RegionCoverer();</div><div class="line">ArrayList&lt;S2CellId&gt; covering = <span class="keyword">new</span> ArrayList&lt;S2CellId&gt;();</div><div class="line">coverer.setMinLevel(minLevel);</div><div class="line">coverer.setMaxLevel(maxLevel);</div><div class="line">coverer.setMaxCells(<span class="number">1000000</span>);</div><div class="line">S2Polygon s2Polygon = S2Polygon.makePolygon(polygonValue);</div><div class="line"><span class="comment">//getCovering()è¡¨ç¤ºå¯ä»¥æœ€å°ç¨‹åº¦è¦†ç›–æ•´ä¸ªåŒºåŸŸï¼Œå¤–æ¥å¤šè¾¹å½¢</span></div><div class="line">coverer.getCovering(s2Polygon, covering);</div><div class="line"><span class="comment">//getInteriorCovering()è¡¨ç¤ºæœ€å¤§ç¨‹åº¦å¡«å……æ•´ä¸ªåŒºåŸŸï¼Œå†…æ¥å¤šè¾¹å½¢</span></div><div class="line"><span class="comment">// coverer.getInteriorCovering(s2Polygon, covering);</span></div><div class="line">System.out.println(<span class="string">"covering of size:"</span> + covering.size());</div></pre></td></tr></table></figure>
<p>è¿™é‡Œé‡‡ç”¨getCovering()å¤–æ¥å¤šè¾¹å½¢æ¨¡å¼ï¼Œé¿å…å¤šè¾¹å½¢åŒºåŸŸæœ‰ç›²ç‚¹ã€‚MinLevelï¼9ï¼ŒMaxLevelï¼14 </p>
<p><strong>è¯´æ˜ï¼š</strong>MaxLevelæœ€å¤šå¯ä»¥è®¾ç½®30çº§ï¼Œæ¯å‡ä¸€çº§ç²¾åº¦æå‡æ¥è¿‘4å€ï¼Œ14çº§å•ä¸ªCellå¯ä»¥è¡¨ç¤ºèŒƒå›´ï¼š200å¹³ç±³~400å¹³ç±³ï¼Œå±‚çº§è¶Šé«˜ï¼Œæ„å»ºè¶Šæ…¢ã€‚</p>
<p><a href="http://blog.christianperone.com/wp-content/uploads/2015/08/s2_cell_area.png" target="_blank" rel="external"><img src="http://blog.christianperone.com/wp-content/uploads/2015/08/s2_cell_area.png" alt="Cell areas"></a></p>
<p>S2éœ€è¦å°†åœ°ç†ä½ç½®è¡¨ç¤ºä¸ºè®¡ç®—æœºå¯ä»¥ç†è§£çš„æ–¹å¼ï¼Œå³äºŒè¿›åˆ¶ç çš„è¡¨ç¤ºï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯ç”¨äºŒè¿›åˆ¶ç æ¥è¡¨ç¤ºä¸‰ç»´ç©ºé—´ã€‚å¦‚ä½•æ¥åšå‘¢ï¼Ÿéœ€è¦è¿›è¡Œé™ç»´ã€‚</p>
<a id="more"></a>
<p>1) é¦–å…ˆä»ä¸‰ç»´é™åˆ°äºŒç»´ï¼Œæˆ‘ä»¬å°†åœ°çƒæ”¾åœ¨ä¸€ä¸ªæ­£æ–¹ä½“ä¸­ï¼Œå‡è®¾åœ°çƒä¸­å¿ƒå‘å…‰ï¼Œå…‰çº¿ç©¿è¿‡çƒä½“è¡¨é¢åˆ°è¾¾æ­£æ–¹ä½“å¹³é¢çš„ç‚¹å°±æ˜¯çƒä½“è¡¨é¢çš„ç‚¹çš„æŠ•å½±ã€‚äºæ˜¯æˆ‘ä»¬å°±å¯ä»¥å°†åœ°çƒæŠ•å½±åˆ°æ­£æ–¹ä½“çš„å…­ä¸ªæ­£æ–¹å½¢è¡¨é¢ã€‚</p>
<p><img src="https://pic1.zhimg.com/6879b5d273829197535c347f2adddb74_b.png" alt="img"></p>
<p>é€šè¿‡æŠ•å½±æˆ‘ä»¬å¯ä»¥å°†ä¸‰ç»´çƒä½“æ˜ å°„åˆ°äºŒç»´å¹³é¢ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æŠ•å½±é•¿åº¦çš„æ¯”ä¾‹ä¸åŒã€‚æ°´å¹³æ–¹å‘ä¸Šçš„æŠ•å½±é•¿åº¦æ¯”ä¸Šä¸‹ä¸¤ç«¯çš„æŠ•å½±é•¿åº¦å°ï¼Œè¿™å°±é€ æˆäº†æŠ•å°„é¢ç§¯ä¸å‡åŒ€ï¼Œä¼šå½±å“ä»¥åå¯¹åœ°å›¾çš„åˆ‡åˆ†ã€‚è§£å†³æ–¹æ³•å°±æ˜¯å†è¿›è¡Œä¸€æ¬¡åŒºé—´è½¬æ¢ï¼Œå¯¹é•¿åº¦è¿›è¡Œå¾®æŒ‘ï¼Œå°†é•¿çš„æ‹‰çŸ­ï¼ŒçŸ­çš„æ‹‰é•¿ï¼Œå°½é‡ä½¿æŠ•å½±é¢ç§¯åˆ†å¸ƒå‡åŒ€ã€‚</p>
<p><img src="https://pic4.zhimg.com/0e58057b333a6c2935feef0ea27d1ccb_b.png" alt="img"></p>
<p>2) å°†äºŒç»´å˜æˆä¸€ç»´ã€‚æˆ‘ä»¬æœ‰å¾ˆå¤šç‚¹ç»„æˆçš„æ­£æ–¹å½¢å¹³é¢ï¼Œå¦‚ä½•å¯¹è¿™ä¸ªå¹³é¢è¿›è¡Œä¸€ç»´è¡¨ç¤ºå‘¢ï¼Ÿæ–¹æ³•å°±æ˜¯éå†ï¼Œæ¯”å¦‚æˆ‘ä»¬å°±å¯ä»¥ç”¨00 01 10 11æ¥è¡¨ç¤ºä¸‹é¢å››ä¸ªç‚¹ç»„æˆçš„å¹³é¢ã€‚å°†è¿™ç§æ–¹æ³•ä¸æ–­æ‰©å±•åˆ°æé™ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¡«å……æ•´ä¸ªäºŒç»´å¹³é¢çš„ä¸€æ¡æ›²çº¿ï¼Œè¿™å°±æ˜¯è‘—åçš„å¸Œå°”ä¼¯ç‰¹æ›²çº¿ï¼ˆHilbert Curveï¼‰ã€‚å¸Œå°”ä¼¯ç‰¹æ›²çº¿å¯ä»¥æŠŠäºŒç»´å¹³é¢æ˜ å°„åˆ°ä¸€æ¡çº¿æ®µä¸Šï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªä¼˜åŠ¿å°±æ˜¯å¯ä»¥ä¿å­˜å±€éƒ¨æ€§ï¼Œå³ç©ºé—´ä½ç½®ç›¸è¿‘çš„ç‚¹åœ¨å¸Œå°”ä¼¯ç‰¹æ›²çº¿ä¸Šçš„ä½ç½®ä¹Ÿæ˜¯ç›¸è¿‘çš„ã€‚<img src="https://pic4.zhimg.com/8803b4a0d220077891ccaafe55cb430b_b.png" alt="img"></p>
<p> <a href="http://blog.christianperone.com/wp-content/uploads/2015/08/hilbert_middle.png" target="_blank" rel="external"><img src="http://blog.christianperone.com/wp-content/uploads/2015/08/hilbert_middle.png" alt="Hilbert Curve"></a></p>
<p>å¯ä»¥å‘ç°ä½ç½®ç›¸è¿‘çš„äºŒç»´åæ ‡åœ¨ä¸€ç»´çº¿æ®µä¸Šé¢ä¹Ÿæ˜¯é‚»è¿‘çš„ã€‚</p>
<p>3) åˆ›å»ºcellé›†åˆï¼š</p>
<p><strong>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å°†ä¸€ä¸ªèƒ½å®Œæ•´è¦†ç›–å¤šè¾¹å½¢é¢ç§¯çš„cellï¼Œä¸æ–­çš„åˆ’åˆ†(4å—cell)ï¼Œå¦‚æœ4å¿«ä»ç„¶å…¨éƒ¨ä¸å¤šè¾¹å½¢ç›¸äº¤åˆ™ç»§ç»­åˆ’åˆ†ï¼Œå¦åˆ™æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªcellä¸ä¸å¤šè¾¹å½¢ç›¸äº¤åˆ™æŠ›å¼ƒï¼Œç›´è‡³æœ€å¤§åˆ’åˆ†åˆ°maxLevelã€‚</strong>å¯ä»¥å‘ç°å¦‚æœmaxLevelè®¾ç½®çš„è¶Šå¤§ï¼Œåˆ™ç²¾åº¦è¶Šé«˜(æµ‹è¯•æ•ˆç‡æ¥çœ‹ï¼ŒmaxLevelè®¾ç½®ä¸º14ï¼Œ15çº§å·²ç»æ¯”è¾ƒç²¾ç¡®ï¼Œå±‚çº§å¤§äº15çº§éå¸¸å½±å“ç”Ÿæˆcellçš„æ•ˆç‡)ã€‚</p>
<p>è¿™é‡Œå‡è®¾å¤šè¾¹å½¢åŒºåŸŸä¸ºäºŒç»´å›¾å½¢ï¼Œå¦‚æœéœ€è¦å¯¹è¯¥å›¾å½¢è¿›è¡Œè¦†ç›–ï¼Œå¯èƒ½æœ‰ä»¥ä¸‹å¯èƒ½ï¼š</p>
<ul>
<li><p>cellè¢«åŒ…å«åœ¨å¤šè¾¹å½¢å†…éƒ¨</p>
<p><img src="/images/Google_s2_1.png"></p>
</li>
<li><p>cellä¸å¤šè¾¹å½¢ç›¸äº¤(æœ‰ä¸€éƒ¨åˆ†åœ¨å¤–é¢)</p>
<p><img src="/images/Google_s2_2.png"></p>
<p>å›¾ä¸­å¤§çš„cellå’Œå¤šè¾¹å½¢ç›¸äº¤ï¼Œå¦‚æœè¯¥cellçš„levelå·²ç»è¾¾åˆ°maxLevelåˆ™åœæ­¢åˆ’åˆ†ï¼Œå¹¶å°†è¿™ä¸ªcellåŠ å…¥æœ€åé›†åˆï¼›å¦‚æœè¿™æ—¶å€™è¯¥cellçš„levelå°äºmaxLevel,åˆ™ç»§ç»­åˆ’åˆ†ä¸º4å°å—(ä¸ä¸€å®šç­‰åˆ†)ï¼Œå¯ä»¥å‘ç°æœ‰2ä¸ªå°çš„cellä»ç„¶ä¸å¤šè¾¹å½¢ç›¸äº¤ï¼Œå¦‚æœè¿™2ä¸ªcellå±‚çº§å·²ç»è¾¾åˆ°MaxLevelåˆ™å°†è¿™2ä¸ªåŠ å…¥æœ€ç»ˆé›†åˆï¼Œå¦åˆ™ç»§ç»­åˆ’åˆ†ï¼Œå¦å¤–2ä¸ªcellå·²ç»åœ¨å¤šè¾¹å½¢çš„å¤–é¢åˆ™æŠ›å¼ƒï¼Œ</p>
</li>
</ul>
<p>å¦‚æœå¤šè¾¹å½¢å†…éƒ¨å¯ä»¥å®Œæ•´å¡«å……ä¸€ä¸ªcell(æ³¨æ„é™åˆ¶ï¼šminLevelï¼ŒmaxLevel; çº§åˆ«è¶Šå°ï¼Œcellè¶Šå¤§)ï¼Œåˆ™å°†è¯¥cellç›´æ¥æ·»åŠ åˆ°é›†åˆä¸­ã€‚æ¯”å¦‚è¿™é‡Œè®¾ç½®çš„minLevelï¼9(ä¸€èˆ¬åªæœ‰é¢ç§¯éå¸¸å¤§çš„å›½å®¶æ‰ä¼šæœ‰levelï¼9),æ‰€ä»¥å¤šè¾¹å½¢åŒºåŸŸæ‰€èƒ½ç”Ÿæˆçš„æœ€å¤§é¢ç§¯cellåªæœ‰å¯èƒ½æ˜¯levelï¼9.</p>
<p>æ ¹æ®å®é™…æµ‹è¯•æ¥çœ‹ï¼Œåƒç¾å›½ï¼Œä¿„ç½—æ–¯ç›¸å¯¹é¢ç§¯æ¯”è¾ƒå¤§çš„å›½å®¶ï¼Œæœ€å°çš„levelå¯ä»¥è¾¾åˆ°7(ç›®æµ‹åœ°çƒæ‰€æœ‰å›½å®¶ä¸­æœ€å°çš„levelå°±æ˜¯7)ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›å›½å®¶çš„é¢ç§¯å¯ä»¥å†…æ¶µå®Œæ•´çš„level=7çš„cellï¼Œè¿™ä¹ˆåšå¯ä»¥å°†è®¸å¤šé«˜å±‚æ¬¡çš„cellç”±ä¸€ä¸ªä½å±‚æ¬¡çš„cellæ›¿ä»£ï¼Œå‡å°‘äº†ç”Ÿæˆçš„cellæ•°é‡åŒæ—¶è¡¨ç¤ºçš„èŒƒå›´æ²¡æœ‰å˜åŒ–ã€‚</p>
<p>ä¹‹æ‰€ä»¥è¿™é‡Œé€‰æ‹©minLevelï¼9ï¼Œæ˜¯ä¸ºäº†ä»¥åå®šä½æ–¹ä¾¿ï¼Œç›®å‰çš„å®šä½æ˜¯é€šè¿‡ç»çº¬åº¦ç”±Google S2ç”ŸæˆCellIdï¼Œå†ç”±è¿™ä¸ªCellIdæŸ¥è¯¢æ‰€æœ‰çš„CellIdé›†åˆï¼Œå¦‚æœæœ‰åŒ¹é…çš„åˆ™å‘½ä¸­ã€‚åŒ¹é…çš„ä»£ç  å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> minLevel = <span class="number">9</span>;</div><div class="line"><span class="keyword">int</span> maxLevel = <span class="number">14</span>;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = minLevel; i &lt; (maxLevel + <span class="number">1</span>); i++) &#123;</div><div class="line">	paCell = s2cell.parent(i);</div><div class="line">	<span class="keyword">if</span> (cellIds.contains(paCell.id())) &#123;</div><div class="line">		System.out.println(<span class="string">"å‘½ä¸­!!!"</span>);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åŒ¹é…çš„è§„åˆ™ï¼šå…ˆä»æœ€ä½çº§åˆ«åˆ¤æ–­ï¼Œå¦‚æœæ²¡æœ‰è¢«åŒ…å«åœ¨CellIdé›†åˆä¸­åˆ™åˆ¤æ–­å…¶çˆ¶å±‚æ˜¯å¦è¢«åŒ…å«ï¼Œè¿™æ ·é€å±‚é€’å¢ç›´è‡³maxLevelã€‚<strong>æ‰€ä»¥minLevelè®¾ç½®çš„å¤ªå°ä¼šå¢åŠ åˆ¤æ–­æ¬¡æ•°</strong>ï¼Œåœ¨å¹¶å‘æ¯”è¾ƒå¤§çš„æƒ…å†µä¸‹ä¼šå½±å“æ•ˆç‡ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[mvc:interceptors]]></title>
      <url>http://zsr.github.io/2016/10/14/mvc-interceptors/</url>
      <content type="html"><![CDATA[<h3 id="ä¸€-spring-MVC-Interceptor-ä½œç”¨"><a href="#ä¸€-spring-MVC-Interceptor-ä½œç”¨" class="headerlink" title="ä¸€. spring MVC Interceptor ä½œç”¨:"></a><strong>ä¸€. spring MVC Interceptor ä½œç”¨:</strong></h3><p>Spring MVCæ¡†æ¶ä¸­çš„Interceptorï¼Œä¸Servlet APIä¸­çš„Filterååˆ†ç±»ä¼¼ï¼Œç”¨äºå¯¹Webè¯·æ±‚è¿›è¡Œé¢„å¤„ç†/åå¤„ç†ã€‚é€šå¸¸æƒ…å†µä¸‹è¿™äº›é¢„å¤„ç†/åå¤„ç†é€»è¾‘æ˜¯é€šç”¨çš„ï¼Œå¯ä»¥è¢«åº”ç”¨äºæ‰€æœ‰æˆ–å¤šä¸ªWebè¯·æ±‚ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>è®°å½•Webè¯·æ±‚ç›¸å…³æ—¥å¿—ï¼Œå¯ä»¥ç”¨äºåšä¸€äº›ä¿¡æ¯ç›‘æ§ã€ç»Ÿè®¡ã€åˆ†æ</li>
<li>æ£€æŸ¥Webè¯·æ±‚è®¿é—®æƒé™ï¼Œä¾‹å¦‚å‘ç°ç”¨æˆ·æ²¡æœ‰ç™»å½•åï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢</li>
<li>æ‰“å¼€/å…³é—­æ•°æ®åº“è¿æ¥â€”â€”é¢„å¤„ç†æ—¶æ‰“å¼€ï¼Œåå¤„ç†å…³é—­ï¼Œå¯ä»¥é¿å…åœ¨æ‰€æœ‰ä¸šåŠ¡æ–¹æ³•ä¸­éƒ½ç¼–å†™ç±»ä¼¼ä»£ç ï¼Œä¹Ÿä¸ä¼šå¿˜è®°å…³é—­æ•°æ®åº“è¿æ¥</li>
</ul>
<h3 id="äºŒ-æ‹¦æˆªå™¨å’Œè¿‡æ»¤å™¨filterçš„åŒºåˆ«ï¼š"><a href="#äºŒ-æ‹¦æˆªå™¨å’Œè¿‡æ»¤å™¨filterçš„åŒºåˆ«ï¼š" class="headerlink" title="äºŒ. æ‹¦æˆªå™¨å’Œè¿‡æ»¤å™¨filterçš„åŒºåˆ«ï¼š"></a><strong>äºŒ. æ‹¦æˆªå™¨å’Œè¿‡æ»¤å™¨filterçš„åŒºåˆ«ï¼š</strong></h3><ol>
<li>Filteræ˜¯Servletè§„èŒƒè§„å®šçš„ï¼Œåªèƒ½ç”¨äºweb<a href="http://www.xuebuyuan.com/" target="_blank" rel="external">ç¨‹åº</a>ä¸­ã€‚è€Œæ‹¦æˆªå™¨æ—¢å¯ä»¥ç”¨äºwebç¨‹åºï¼Œä¹Ÿå¯ä»¥ç”¨äºApplicationã€Swingç¨‹åºä¸­ã€‚</li>
</ol>
<ol>
<li>Filteræ˜¯åœ¨Servletè§„èŒƒä¸­å®šä¹‰çš„ï¼Œæ˜¯Servletå®¹å™¨æ”¯æŒçš„ã€‚è€Œæ‹¦æˆªå™¨æ˜¯åœ¨Springå®¹å™¨ä¸­çš„ï¼Œæ˜¯Springæ¡†æ¶æ”¯æŒçš„ã€‚</li>
<li>åŒå…¶ä»–ä»£ç å—ä¸€æ ·ï¼Œæ‹¦æˆªå™¨ä¹Ÿæ˜¯ä¸€ä¸ªSpringçš„ç»„ä»¶ï¼Œå½’Springç®¡ç†ï¼Œé…ç½®åœ¨Springæ–‡ä»¶ä¸­ï¼Œå› æ­¤èƒ½ä½¿ç”¨Springé‡Œçš„ä»»ä½•èµ„æºã€å¯¹è±¡ï¼Œä¾‹å¦‚Serviceå¯¹è±¡ã€æ•°æ®æºã€äº‹åŠ¡ç®¡ç†ç­‰ï¼Œé€šè¿‡IoCæ³¨å…¥åˆ°æ‹¦æˆªå™¨å³å¯ï¼›è€ŒFilteråˆ™ä¸èƒ½</li>
<li>Filteråªåœ¨Servletå‰åèµ·ä½œç”¨ã€‚è€Œæ‹¦æˆªå™¨èƒ½å¤Ÿæ·±å…¥å¾—åˆ°æ–¹æ³•å‰åã€å¼‚å¸¸æŠ›å‡ºå‰åç­‰ï¼Œå› ä¸ºæ‹¦æˆªå™¨çš„ä½¿ç”¨å…·æœ‰æ›´å¤§çš„å¼¹æ€§ã€‚æ‰€ä»¥åœ¨Springæ„æ¶çš„ç¨‹åºä¸­ï¼Œè¦ä¼˜å…ˆä½¿ç”¨æ‹¦æˆªå™¨ã€‚</li>
</ol>
<h3 id="ä¸‰-Spring-MVCè¯·æ±‚å¤„ç†æµç¨‹"><a href="#ä¸‰-Spring-MVCè¯·æ±‚å¤„ç†æµç¨‹" class="headerlink" title="ä¸‰. Spring MVCè¯·æ±‚å¤„ç†æµç¨‹"></a><strong>ä¸‰. Spring MVCè¯·æ±‚å¤„ç†æµç¨‹</strong></h3><p><a href="http://assets.tianmaying.com/md-image/97936b6d48e3c678ade5e7307eeb54ba" target="_blank" rel="external"><img src="http://assets.tianmaying.com/md-image/97936b6d48e3c678ade5e7307eeb54ba" alt="alter-text"></a></p>
<p>ä¸Šå›¾æ˜¯Spring MVCæ¡†æ¶å¤„ç†Webè¯·æ±‚çš„åŸºæœ¬æµç¨‹ï¼Œè¯·æ±‚ä¼šç»è¿‡<code>DispatcherServlet</code>çš„åˆ†å‘åï¼Œä¼šæŒ‰é¡ºåºç»è¿‡ä¸€ç³»åˆ—çš„<code>Interceptor</code>å¹¶æ‰§è¡Œå…¶ä¸­çš„é¢„å¤„ç†æ–¹æ³•(preHandle)ï¼Œåœ¨è¯·æ±‚è¿”å›æ—¶åŒæ ·ä¼šæ‰§è¡Œå…¶ä¸­çš„åå¤„ç†æ–¹æ³•(postHandle)ã€‚</p>
<h3 id="å››-æ‹¦æˆªå™¨æ¥å£-HandlerInterceptor"><a href="#å››-æ‹¦æˆªå™¨æ¥å£-HandlerInterceptor" class="headerlink" title="å››. æ‹¦æˆªå™¨æ¥å£-HandlerInterceptor"></a><strong>å››. æ‹¦æˆªå™¨æ¥å£-HandlerInterceptor</strong></h3><p>Spring MVCä¸­æ‹¦æˆªå™¨æ˜¯å®ç°äº†<code>HandlerInterceptor</code>æ¥å£çš„Beanï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerInterceptor</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, </span></span></div><div class="line">                      HttpServletResponse response, </div><div class="line">                      Object handler) <span class="keyword">throws</span> Exception;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, </span></span></div><div class="line">                    HttpServletResponse response, </div><div class="line">                    Object handler, ModelAndView modelAndView) <span class="keyword">throws</span> Exception;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, </span></span></div><div class="line">                         HttpServletResponse response, </div><div class="line">                         Object handler, Exception ex) <span class="keyword">throws</span> Exception;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>HandlerInterceptor</code> æ¥å£ä¸­å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯é€šè¿‡è¿™ä¸‰ä¸ªæ–¹æ³•æ¥å¯¹ç”¨æˆ·çš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªå¤„ç†çš„ã€‚</p>
<ul>
<li>(1). preHandle (HttpServletRequest request, HttpServletResponse response, Object handle) æ–¹æ³•ã€‚<strong>è¯¥æ–¹æ³•å°†åœ¨è¯·æ±‚å¤„ç†ä¹‹å‰è¿›è¡Œè°ƒç”¨</strong>ã€‚SpringMVC ä¸­çš„Interceptor æ˜¯é“¾å¼çš„è°ƒç”¨çš„ï¼Œåœ¨ä¸€ä¸ªåº”ç”¨ä¸­æˆ–è€…è¯´æ˜¯åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªInterceptor ã€‚æ¯ä¸ªInterceptor çš„è°ƒç”¨ä¼šä¾æ®å®ƒçš„å£°æ˜é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œè€Œä¸”æœ€å…ˆæ‰§è¡Œçš„éƒ½æ˜¯Interceptor ä¸­çš„preHandle æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿›è¡Œä¸€äº›å‰ç½®åˆå§‹åŒ–æ“ä½œæˆ–è€…æ˜¯å¯¹å½“å‰è¯·æ±‚çš„ä¸€ä¸ªé¢„å¤„ç†ï¼Œä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿›è¡Œä¸€äº›åˆ¤æ–­æ¥å†³å®šè¯·æ±‚æ˜¯å¦è¦ç»§ç»­è¿›è¡Œä¸‹å»ã€‚è¯¥æ–¹æ³•çš„è¿”å›å€¼æ˜¯å¸ƒå°”å€¼Boolean ç±»å‹çš„ï¼Œå½“å®ƒè¿”å›ä¸ºfalse æ—¶ï¼Œè¡¨ç¤ºè¯·æ±‚ç»“æŸï¼Œåç»­çš„Interceptor å’ŒController éƒ½ä¸ä¼šå†æ‰§è¡Œï¼›å½“è¿”å›å€¼ä¸ºtrue æ—¶å°±ä¼šç»§ç»­è°ƒç”¨ä¸‹ä¸€ä¸ªInterceptor çš„preHandle æ–¹æ³•ï¼Œå¦‚æœå·²ç»æ˜¯æœ€åä¸€ä¸ªInterceptor çš„æ—¶å€™å°±ä¼šæ˜¯è°ƒç”¨å½“å‰è¯·æ±‚çš„Controller æ–¹æ³•ã€‚</li>
</ul>
<ul>
<li>(2). postHandle (HttpServletRequest request, HttpServletResponse response, Object handle, ModelAndView modelAndView) æ–¹æ³•ï¼Œç”±preHandle æ–¹æ³•çš„è§£é‡Šæˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ–¹æ³•åŒ…æ‹¬åé¢è¦è¯´åˆ°çš„afterCompletion æ–¹æ³•éƒ½åªèƒ½æ˜¯åœ¨å½“å‰æ‰€å±çš„Interceptor çš„preHandle æ–¹æ³•çš„è¿”å›å€¼ä¸ºtrue æ—¶æ‰èƒ½è¢«è°ƒç”¨ã€‚<strong>postHandle æ–¹æ³•ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯åœ¨å½“å‰è¯·æ±‚è¿›è¡Œå¤„ç†ä¹‹åï¼Œä¹Ÿå°±æ˜¯Controller æ–¹æ³•è°ƒç”¨ä¹‹åæ‰§è¡Œï¼Œä½†æ˜¯å®ƒä¼šåœ¨DispatcherServlet è¿›è¡Œè§†å›¾è¿”å›æ¸²æŸ“ä¹‹å‰è¢«è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å¯¹Controller å¤„ç†ä¹‹åçš„ModelAndView å¯¹è±¡è¿›è¡Œæ“ä½œ</strong>ã€‚postHandle æ–¹æ³•è¢«è°ƒç”¨çš„æ–¹å‘è·ŸpreHandle æ˜¯ç›¸åçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å…ˆå£°æ˜çš„Interceptor çš„postHandle æ–¹æ³•åè€Œä¼šåæ‰§è¡Œï¼Œè¿™å’ŒStruts2 é‡Œé¢çš„Interceptor çš„æ‰§è¡Œè¿‡ç¨‹æœ‰ç‚¹ç±»å‹ã€‚Struts2 é‡Œé¢çš„Interceptor çš„æ‰§è¡Œè¿‡ç¨‹ä¹Ÿæ˜¯é“¾å¼çš„ï¼Œåªæ˜¯åœ¨Struts2 é‡Œé¢éœ€è¦æ‰‹åŠ¨è°ƒç”¨ActionInvocation çš„invoke æ–¹æ³•æ¥è§¦å‘å¯¹ä¸‹ä¸€ä¸ªInterceptor æˆ–è€…æ˜¯Action çš„è°ƒç”¨ï¼Œç„¶åæ¯ä¸€ä¸ªInterceptor ä¸­åœ¨invoke æ–¹æ³•è°ƒç”¨ä¹‹å‰çš„å†…å®¹éƒ½æ˜¯æŒ‰ç…§å£°æ˜é¡ºåºæ‰§è¡Œçš„ï¼Œè€Œinvoke æ–¹æ³•ä¹‹åçš„å†…å®¹å°±æ˜¯åå‘çš„ã€‚</li>
<li>(3). afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handle, Exception ex) æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¹Ÿæ˜¯éœ€è¦å½“å‰å¯¹åº”çš„Interceptor çš„preHandle æ–¹æ³•çš„è¿”å›å€¼ä¸ºtrue æ—¶æ‰ä¼šæ‰§è¡Œã€‚é¡¾åæ€ä¹‰ï¼Œ<strong>è¯¥æ–¹æ³•å°†åœ¨æ•´ä¸ªè¯·æ±‚ç»“æŸä¹‹åï¼Œä¹Ÿå°±æ˜¯åœ¨DispatcherServlet æ¸²æŸ“äº†å¯¹åº”çš„è§†å›¾ä¹‹åæ‰§è¡Œ</strong>ã€‚è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯ç”¨äºè¿›è¡Œèµ„æºæ¸…ç†å·¥ä½œçš„ã€‚ æˆ‘ä»¬çš„ç³»ç»Ÿæ—¥å¿—çš„æ‹¦æˆªåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå¯ä»¥è®°å½•æ—¥å¿—çš„ç›¸å…³çš„å‚æ•°ï¼Œæ£€æµ‹æ–¹æ³•çš„æ‰§è¡Œã€‚</li>
</ul>
<h3 id="äº”-æ‹¦æˆªå™¨é…ç½®"><a href="#äº”-æ‹¦æˆªå™¨é…ç½®" class="headerlink" title="äº”. æ‹¦æˆªå™¨é…ç½®"></a><strong>äº”. æ‹¦æˆªå™¨é…ç½®</strong></h3><ul>
<li><p><strong><code>DefaultAnnotationHandlerMapping</code></strong></p>
<p>è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨å¯ä»¥é€šè¿‡DefaultAnnotationHandlerMappingæ³¨å…¥åˆ°springæ¡†æ¶ä¸­ã€‚å¯ä»¥æ‰“å¼€org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMappingï¼Œå¯ä»¥çœ‹åˆ°å…·ä½“çš„æ³¨å…¥ç»†èŠ‚ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--Â é€šè¿‡DefaultAnnotationHandlerMappingå°†æ‹¦æˆªå™¨æ³¨å…¥Â --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> Â  Â  Â  Â  Â  <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">property</span>Â <span class="attr">name</span>=<span class="string">"interceptors"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">			<span class="comment">&lt;!--Â è¿™è¾¹å¯ä»¥å®ç°å¤šä¸ªæ‹¦æˆªå™¨Â --&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">ref</span>Â <span class="attr">bean</span>=<span class="string">"DefaultInterceptor"</span>Â  /&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!--Â è‡ªå®šä¹‰çš„defaultçš„æ‹¦æˆªå™¨Â --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span>Â <span class="attr">id</span>=<span class="string">"DefaultInterceptor"</span>Â <span class="attr">class</span>=<span class="string">"com.xxx.test.DefaultInterceptor"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p><strong>é€šè¿‡ <code>&lt;mvc:interceptors&gt;</code> çš„æ–¹å¼é…ç½®ï¼š</strong></p>
<p>Spring MVC interceptorä¸€èˆ¬é…ç½®è¿™ç§æ¨¡å¼ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></div><div class="line">    	<span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">"/api/time/get_time/"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.xxx.test.DefaultInterceptor"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></div></pre></td></tr></table></figure>
<p>â€‹</p>
</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[SSL/TLSåè®®è¿è¡Œæœºåˆ¶]]></title>
      <url>http://zsr.github.io/2016/10/14/SSL-TLS%E5%8D%8F%E8%AE%AE%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/</url>
      <content type="html"><![CDATA[<p>äº’è”ç½‘çš„é€šä¿¡å®‰å…¨ï¼Œå»ºç«‹åœ¨SSL/TLSåè®®ä¹‹ä¸Šã€‚</p>
<h3 id="ä¸€ã€ä½œç”¨"><a href="#ä¸€ã€ä½œç”¨" class="headerlink" title="ä¸€ã€ä½œç”¨"></a><strong>ä¸€ã€ä½œç”¨</strong></h3><p>ä¸ä½¿ç”¨SSL/TLSçš„HTTPé€šä¿¡ï¼Œå°±æ˜¯ä¸åŠ å¯†çš„é€šä¿¡ã€‚æ‰€æœ‰ä¿¡æ¯æ˜æ–‡ä¼ æ’­ï¼Œå¸¦æ¥äº†ä¸‰å¤§é£é™©ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ï¼ˆ1ï¼‰ çªƒå¬é£é™©ï¼ˆeavesdroppingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥è·çŸ¥é€šä¿¡å†…å®¹ã€‚</div><div class="line">ï¼ˆ2ï¼‰ ç¯¡æ”¹é£é™©ï¼ˆtamperingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥ä¿®æ”¹é€šä¿¡å†…å®¹ã€‚</div><div class="line">ï¼ˆ3ï¼‰ å†’å……é£é™©ï¼ˆpretendingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥å†’å……ä»–äººèº«ä»½å‚ä¸é€šä¿¡ã€‚</div></pre></td></tr></table></figure>
<p>SSL/TLSåè®®æ˜¯ä¸ºäº†è§£å†³è¿™ä¸‰å¤§é£é™©è€Œè®¾è®¡çš„ï¼Œå¸Œæœ›è¾¾åˆ°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ï¼ˆ1ï¼‰ æ‰€æœ‰ä¿¡æ¯éƒ½æ˜¯åŠ å¯†ä¼ æ’­ï¼Œç¬¬ä¸‰æ–¹æ— æ³•çªƒå¬ã€‚</div><div class="line">ï¼ˆ2ï¼‰ å…·æœ‰æ ¡éªŒæœºåˆ¶ï¼Œä¸€æ—¦è¢«ç¯¡æ”¹ï¼Œé€šä¿¡åŒæ–¹ä¼šç«‹åˆ»å‘ç°ã€‚</div><div class="line">ï¼ˆ3ï¼‰ é…å¤‡èº«ä»½è¯ä¹¦ï¼Œé˜²æ­¢èº«ä»½è¢«å†’å……ã€‚</div></pre></td></tr></table></figure>
<p>äº’è”ç½‘æ˜¯å¼€æ”¾ç¯å¢ƒï¼Œé€šä¿¡åŒæ–¹éƒ½æ˜¯æœªçŸ¥èº«ä»½ï¼Œè¿™ä¸ºåè®®çš„è®¾è®¡å¸¦æ¥äº†å¾ˆå¤§çš„éš¾åº¦ã€‚è€Œä¸”ï¼Œåè®®è¿˜å¿…é¡»èƒ½å¤Ÿç»å—æ‰€æœ‰åŒªå¤·æ‰€æ€çš„æ”»å‡»ï¼Œè¿™ä½¿å¾—SSL/TLSåè®®å˜å¾—å¼‚å¸¸å¤æ‚ã€‚</p>
<h3 id="äºŒã€å†å²"><a href="#äºŒã€å†å²" class="headerlink" title="äºŒã€å†å²"></a><strong>äºŒã€å†å²</strong></h3><p>äº’è”ç½‘åŠ å¯†é€šä¿¡åè®®çš„å†å²ï¼Œå‡ ä¹ä¸äº’è”ç½‘ä¸€æ ·é•¿ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1994å¹´ï¼ŒNetScapeå…¬å¸è®¾è®¡äº†SSLåè®®ï¼ˆSecure Sockets Layerï¼‰çš„1.0ç‰ˆï¼Œä½†æ˜¯æœªå‘å¸ƒã€‚</div><div class="line">1995å¹´ï¼ŒNetScapeå…¬å¸å‘å¸ƒSSL 2.0ç‰ˆï¼Œå¾ˆå¿«å‘ç°æœ‰ä¸¥é‡æ¼æ´ã€‚</div><div class="line">1996å¹´ï¼ŒSSL 3.0ç‰ˆé—®ä¸–ï¼Œå¾—åˆ°å¤§è§„æ¨¡åº”ç”¨ã€‚</div><div class="line">1999å¹´ï¼Œäº’è”ç½‘æ ‡å‡†åŒ–ç»„ç»‡ISOCæ¥æ›¿NetScapeå…¬å¸ï¼Œå‘å¸ƒäº†SSLçš„å‡çº§ç‰ˆTLS 1.0ç‰ˆã€‚</div><div class="line">2006å¹´å’Œ2008å¹´ï¼ŒTLSè¿›è¡Œäº†ä¸¤æ¬¡å‡çº§ï¼Œåˆ†åˆ«ä¸ºTLS 1.1ç‰ˆå’ŒTLS 1.2ç‰ˆã€‚æœ€æ–°çš„å˜åŠ¨æ˜¯2011å¹´TLS 1.2çš„ä¿®è®¢ç‰ˆã€‚</div></pre></td></tr></table></figure>
<p>ç›®å‰ï¼Œåº”ç”¨æœ€å¹¿æ³›çš„æ˜¯TLS 1.0ï¼Œæ¥ä¸‹æ¥æ˜¯SSL 3.0ã€‚ä½†æ˜¯ï¼Œä¸»æµæµè§ˆå™¨éƒ½å·²ç»å®ç°äº†TLS 1.2çš„æ”¯æŒã€‚</p>
<p>TLS 1.0é€šå¸¸è¢«æ ‡ç¤ºä¸ºSSL 3.1ï¼ŒTLS 1.1ä¸ºSSL 3.2ï¼ŒTLS 1.2ä¸ºSSL 3.3ã€‚</p>
<h3 id="ä¸‰ã€åŸºæœ¬çš„è¿è¡Œè¿‡ç¨‹"><a href="#ä¸‰ã€åŸºæœ¬çš„è¿è¡Œè¿‡ç¨‹" class="headerlink" title="ä¸‰ã€åŸºæœ¬çš„è¿è¡Œè¿‡ç¨‹"></a><strong>ä¸‰ã€åŸºæœ¬çš„è¿è¡Œè¿‡ç¨‹</strong></h3><p>SSL/TLSåè®®çš„åŸºæœ¬æ€è·¯æ˜¯é‡‡ç”¨<a href="http://en.wikipedia.org/wiki/Public-key_cryptography" target="_blank" rel="external">å…¬é’¥åŠ å¯†æ³•</a>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®¢æˆ·ç«¯å…ˆå‘æœåŠ¡å™¨ç«¯ç´¢è¦å…¬é’¥ï¼Œç„¶åç”¨å…¬é’¥åŠ å¯†ä¿¡æ¯ï¼ŒæœåŠ¡å™¨æ”¶åˆ°å¯†æ–‡åï¼Œç”¨è‡ªå·±çš„ç§é’¥è§£å¯†ã€‚</p>
<p>ä½†æ˜¯ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ã€‚</p>
<p><strong>ï¼ˆ1ï¼‰å¦‚ä½•ä¿è¯å…¬é’¥ä¸è¢«ç¯¡æ”¹ï¼Ÿ</strong></p>
<blockquote>
<p>è§£å†³æ–¹æ³•ï¼šå°†å…¬é’¥æ”¾åœ¨<a href="http://en.wikipedia.org/wiki/Digital_certificate" target="_blank" rel="external">æ•°å­—è¯ä¹¦</a>ä¸­ã€‚åªè¦è¯ä¹¦æ˜¯å¯ä¿¡çš„ï¼Œå…¬é’¥å°±æ˜¯å¯ä¿¡çš„ã€‚</p>
</blockquote>
<p><strong>ï¼ˆ2ï¼‰å…¬é’¥åŠ å¯†è®¡ç®—é‡å¤ªå¤§ï¼Œå¦‚ä½•å‡å°‘è€—ç”¨çš„æ—¶é—´ï¼Ÿ</strong></p>
<blockquote>
<p>è§£å†³æ–¹æ³•ï¼šæ¯ä¸€æ¬¡å¯¹è¯ï¼ˆsessionï¼‰ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éƒ½ç”Ÿæˆä¸€ä¸ªâ€å¯¹è¯å¯†é’¥â€ï¼ˆsession keyï¼‰ï¼Œç”¨å®ƒæ¥åŠ å¯†ä¿¡æ¯ã€‚ç”±äºâ€å¯¹è¯å¯†é’¥â€æ˜¯å¯¹ç§°åŠ å¯†ï¼Œæ‰€ä»¥è¿ç®—é€Ÿåº¦éå¸¸å¿«ï¼Œè€ŒæœåŠ¡å™¨å…¬é’¥åªç”¨äºåŠ å¯†â€å¯¹è¯å¯†é’¥â€æœ¬èº«ï¼Œè¿™æ ·å°±å‡å°‘äº†åŠ å¯†è¿ç®—çš„æ¶ˆè€—æ—¶é—´ã€‚</p>
</blockquote>
<p>å› æ­¤ï¼ŒSSL/TLSåè®®çš„åŸºæœ¬è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<blockquote>
<p>ï¼ˆ1ï¼‰ å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯ç´¢è¦å¹¶éªŒè¯å…¬é’¥ã€‚</p>
<p>ï¼ˆ2ï¼‰ åŒæ–¹åå•†ç”Ÿæˆâ€å¯¹è¯å¯†é’¥â€ã€‚</p>
<p>ï¼ˆ3ï¼‰ åŒæ–¹é‡‡ç”¨â€å¯¹è¯å¯†é’¥â€è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚</p>
</blockquote>
<p>ä¸Šé¢è¿‡ç¨‹çš„å‰ä¸¤æ­¥ï¼Œåˆç§°ä¸ºâ€æ¡æ‰‹é˜¶æ®µâ€ï¼ˆhandshakeï¼‰ã€‚</p>
<h3 id="å››ã€æ¡æ‰‹é˜¶æ®µçš„è¯¦ç»†è¿‡ç¨‹"><a href="#å››ã€æ¡æ‰‹é˜¶æ®µçš„è¯¦ç»†è¿‡ç¨‹" class="headerlink" title="å››ã€æ¡æ‰‹é˜¶æ®µçš„è¯¦ç»†è¿‡ç¨‹"></a><strong>å››ã€æ¡æ‰‹é˜¶æ®µçš„è¯¦ç»†è¿‡ç¨‹</strong></h3><p><img src="http://image.beekka.com/blog/201402/bg2014020502.png" alt="img"></p>
<p>â€œæ¡æ‰‹é˜¶æ®µâ€æ¶‰åŠå››æ¬¡é€šä¿¡ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥çœ‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œâ€æ¡æ‰‹é˜¶æ®µâ€çš„æ‰€æœ‰é€šä¿¡éƒ½æ˜¯æ˜æ–‡çš„ã€‚</p>
<h4 id="4-1-å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼ˆClientHelloï¼‰"><a href="#4-1-å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼ˆClientHelloï¼‰" class="headerlink" title="4.1 å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼ˆClientHelloï¼‰"></a><strong>4.1 å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼ˆClientHelloï¼‰</strong></h4><p>é¦–å…ˆï¼Œå®¢æˆ·ç«¯ï¼ˆé€šå¸¸æ˜¯æµè§ˆå™¨ï¼‰å…ˆå‘æœåŠ¡å™¨å‘å‡ºåŠ å¯†é€šä¿¡çš„è¯·æ±‚ï¼Œè¿™è¢«å«åš<code>ClientHello</code>è¯·æ±‚ã€‚</p>
<p>åœ¨è¿™ä¸€æ­¥ï¼Œå®¢æˆ·ç«¯ä¸»è¦å‘æœåŠ¡å™¨æä¾›ä»¥ä¸‹ä¿¡æ¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ï¼ˆ1ï¼‰ æ”¯æŒçš„åè®®ç‰ˆæœ¬ï¼Œæ¯”å¦‚TLS 1.0ç‰ˆã€‚</div><div class="line">ï¼ˆ2ï¼‰ ä¸€ä¸ªå®¢æˆ·ç«¯ç”Ÿæˆçš„éšæœºæ•°ï¼Œç¨åç”¨äºç”Ÿæˆ&quot;å¯¹è¯å¯†é’¥&quot;ã€‚</div><div class="line">ï¼ˆ3ï¼‰ æ”¯æŒçš„åŠ å¯†æ–¹æ³•ï¼Œæ¯”å¦‚RSAå…¬é’¥åŠ å¯†ã€‚</div><div class="line">ï¼ˆ4ï¼‰ æ”¯æŒçš„å‹ç¼©æ–¹æ³•ã€‚</div></pre></td></tr></table></figure>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯ä¹‹ä¸­ä¸åŒ…æ‹¬æœåŠ¡å™¨çš„åŸŸåã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç†è®ºä¸ŠæœåŠ¡å™¨åªèƒ½åŒ…å«ä¸€ä¸ªç½‘ç«™ï¼Œå¦åˆ™ä¼šåˆ†ä¸æ¸…åº”è¯¥å‘å®¢æˆ·ç«¯æä¾›å“ªä¸€ä¸ªç½‘ç«™çš„æ•°å­—è¯ä¹¦ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆé€šå¸¸ä¸€å°æœåŠ¡å™¨åªèƒ½æœ‰ä¸€å¼ æ•°å­—è¯ä¹¦çš„åŸå› ã€‚</p>
<p>å¯¹äºè™šæ‹Ÿä¸»æœºçš„ç”¨æˆ·æ¥è¯´ï¼Œè¿™å½“ç„¶å¾ˆä¸æ–¹ä¾¿ã€‚2006å¹´ï¼ŒTLSåè®®åŠ å…¥äº†ä¸€ä¸ª<a href="http://tools.ietf.org/html/rfc4366" target="_blank" rel="external">Server Name Indicationæ‰©å±•</a>ï¼Œå…è®¸å®¢æˆ·ç«¯å‘æœåŠ¡å™¨æä¾›å®ƒæ‰€è¯·æ±‚çš„åŸŸåã€‚</p>
<h4 id="4-2-æœåŠ¡å™¨å›åº”ï¼ˆSeverHelloï¼‰"><a href="#4-2-æœåŠ¡å™¨å›åº”ï¼ˆSeverHelloï¼‰" class="headerlink" title="4.2 æœåŠ¡å™¨å›åº”ï¼ˆSeverHelloï¼‰"></a><strong>4.2 æœåŠ¡å™¨å›åº”ï¼ˆSeverHelloï¼‰</strong></h4><p>æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åï¼Œå‘å®¢æˆ·ç«¯å‘å‡ºå›åº”ï¼Œè¿™å«åšSeverHelloã€‚æœåŠ¡å™¨çš„å›åº”åŒ…å«ä»¥ä¸‹å†…å®¹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ï¼ˆ1ï¼‰ ç¡®è®¤ä½¿ç”¨çš„åŠ å¯†é€šä¿¡åè®®ç‰ˆæœ¬ï¼Œæ¯”å¦‚TLS 1.0ç‰ˆæœ¬ã€‚å¦‚æœæµè§ˆå™¨ä¸æœåŠ¡å™¨æ”¯æŒçš„ç‰ˆæœ¬ä¸ä¸€è‡´ï¼ŒæœåŠ¡å™¨å…³é—­åŠ å¯†é€šä¿¡ã€‚</div><div class="line">ï¼ˆ2ï¼‰ ä¸€ä¸ªæœåŠ¡å™¨ç”Ÿæˆçš„éšæœºæ•°ï¼Œç¨åç”¨äºç”Ÿæˆ&quot;å¯¹è¯å¯†é’¥&quot;ã€‚</div><div class="line">ï¼ˆ3ï¼‰ ç¡®è®¤ä½¿ç”¨çš„åŠ å¯†æ–¹æ³•ï¼Œæ¯”å¦‚RSAå…¬é’¥åŠ å¯†ã€‚</div><div class="line">ï¼ˆ4ï¼‰ æœåŠ¡å™¨è¯ä¹¦ã€‚</div></pre></td></tr></table></figure>
<p>é™¤äº†ä¸Šé¢è¿™äº›ä¿¡æ¯ï¼Œ<strong>å¦‚æœæœåŠ¡å™¨éœ€è¦ç¡®è®¤å®¢æˆ·ç«¯çš„èº«ä»½ï¼Œå°±ä¼šå†åŒ…å«ä¸€é¡¹è¯·æ±‚ï¼Œè¦æ±‚å®¢æˆ·ç«¯æä¾›â€å®¢æˆ·ç«¯è¯ä¹¦â€</strong>ã€‚æ¯”å¦‚ï¼Œé‡‘èæœºæ„å¾€å¾€åªå…è®¸è®¤è¯å®¢æˆ·è¿å…¥è‡ªå·±çš„ç½‘ç»œï¼Œå°±ä¼šå‘æ­£å¼å®¢æˆ·æä¾›USBå¯†é’¥ï¼Œé‡Œé¢å°±åŒ…å«äº†ä¸€å¼ å®¢æˆ·ç«¯è¯ä¹¦ã€‚</p>
<h4 id="4-3-å®¢æˆ·ç«¯å›åº”"><a href="#4-3-å®¢æˆ·ç«¯å›åº”" class="headerlink" title="4.3 å®¢æˆ·ç«¯å›åº”"></a><strong>4.3 å®¢æˆ·ç«¯å›åº”</strong></h4><p>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨å›åº”ä»¥åï¼Œé¦–å…ˆéªŒè¯æœåŠ¡å™¨è¯ä¹¦ã€‚å¦‚æœè¯ä¹¦ä¸æ˜¯å¯ä¿¡æœºæ„é¢å¸ƒã€æˆ–è€…è¯ä¹¦ä¸­çš„åŸŸåä¸å®é™…åŸŸåä¸ä¸€è‡´ã€æˆ–è€…è¯ä¹¦å·²ç»è¿‡æœŸï¼Œå°±ä¼šå‘è®¿é—®è€…æ˜¾ç¤ºä¸€ä¸ªè­¦å‘Šï¼Œç”±å…¶é€‰æ‹©æ˜¯å¦è¿˜è¦ç»§ç»­é€šä¿¡ã€‚</p>
<p>å¦‚æœè¯ä¹¦æ²¡æœ‰é—®é¢˜ï¼Œå®¢æˆ·ç«¯å°±ä¼šä»è¯ä¹¦ä¸­å–å‡ºæœåŠ¡å™¨çš„å…¬é’¥ã€‚ç„¶åï¼Œå‘æœåŠ¡å™¨å‘é€ä¸‹é¢ä¸‰é¡¹ä¿¡æ¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ï¼ˆ1ï¼‰ ä¸€ä¸ªéšæœºæ•°ã€‚è¯¥éšæœºæ•°ç”¨æœåŠ¡å™¨å…¬é’¥åŠ å¯†ï¼Œé˜²æ­¢è¢«çªƒå¬ã€‚</div><div class="line">ï¼ˆ2ï¼‰ ç¼–ç æ”¹å˜é€šçŸ¥ï¼Œè¡¨ç¤ºéšåçš„ä¿¡æ¯éƒ½å°†ç”¨åŒæ–¹å•†å®šçš„åŠ å¯†æ–¹æ³•å’Œå¯†é’¥å‘é€ã€‚</div><div class="line">ï¼ˆ3ï¼‰ å®¢æˆ·ç«¯æ¡æ‰‹ç»“æŸé€šçŸ¥ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯çš„æ¡æ‰‹é˜¶æ®µå·²ç»ç»“æŸã€‚è¿™ä¸€é¡¹åŒæ—¶ä¹Ÿæ˜¯å‰é¢å‘é€çš„æ‰€æœ‰å†…å®¹çš„hashå€¼ï¼Œç”¨æ¥ä¾›æœåŠ¡å™¨æ ¡éªŒã€‚</div></pre></td></tr></table></figure>
<p>ä¸Šé¢ç¬¬ä¸€é¡¹çš„éšæœºæ•°ï¼Œæ˜¯æ•´ä¸ªæ¡æ‰‹é˜¶æ®µå‡ºç°çš„ç¬¬ä¸‰ä¸ªéšæœºæ•°ï¼Œåˆç§°â€pre-master keyâ€ã€‚æœ‰äº†å®ƒä»¥åï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å°±åŒæ—¶æœ‰äº†ä¸‰ä¸ªéšæœºæ•°ï¼Œæ¥ç€åŒæ–¹å°±ç”¨äº‹å…ˆå•†å®šçš„åŠ å¯†æ–¹æ³•ï¼Œå„è‡ªç”Ÿæˆæœ¬æ¬¡ä¼šè¯æ‰€ç”¨çš„<strong>åŒä¸€æŠŠâ€ä¼šè¯å¯†é’¥â€</strong>ã€‚</p>
<p>è‡³äºä¸ºä»€ä¹ˆä¸€å®šè¦ç”¨ä¸‰ä¸ªéšæœºæ•°ï¼Œæ¥ç”Ÿæˆâ€ä¼šè¯å¯†é’¥â€ï¼Œ<a href="http://blog.csdn.net/dog250/article/details/5717162" target="_blank" rel="external">dog250</a>è§£é‡Šå¾—å¾ˆå¥½ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;ä¸ç®¡æ˜¯å®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡å™¨ï¼Œéƒ½éœ€è¦éšæœºæ•°ï¼Œè¿™æ ·ç”Ÿæˆçš„å¯†é’¥æ‰ä¸ä¼šæ¯æ¬¡éƒ½ä¸€æ ·ã€‚ç”±äºSSLåè®®ä¸­è¯ä¹¦æ˜¯é™æ€çš„ï¼Œå› æ­¤ååˆ†æœ‰å¿…è¦å¼•å…¥ä¸€ç§éšæœºå› ç´ æ¥ä¿è¯åå•†å‡ºæ¥çš„å¯†é’¥çš„éšæœºæ€§ã€‚</div><div class="line">å¯¹äºRSAå¯†é’¥äº¤æ¢ç®—æ³•æ¥è¯´ï¼Œpre-master-keyæœ¬èº«å°±æ˜¯ä¸€ä¸ªéšæœºæ•°ï¼Œå†åŠ ä¸Šhelloæ¶ˆæ¯ä¸­çš„éšæœºï¼Œä¸‰ä¸ªéšæœºæ•°é€šè¿‡ä¸€ä¸ªå¯†é’¥å¯¼å‡ºå™¨æœ€ç»ˆå¯¼å‡ºä¸€ä¸ªå¯¹ç§°å¯†é’¥ã€‚</div><div class="line">pre masterçš„å­˜åœ¨åœ¨äºSSLåè®®ä¸ä¿¡ä»»æ¯ä¸ªä¸»æœºéƒ½èƒ½äº§ç”Ÿå®Œå…¨éšæœºçš„éšæœºæ•°ï¼Œå¦‚æœéšæœºæ•°ä¸éšæœºï¼Œé‚£ä¹ˆpre master secretå°±æœ‰å¯èƒ½è¢«çŒœå‡ºæ¥ï¼Œé‚£ä¹ˆä»…é€‚ç”¨pre master secretä½œä¸ºå¯†é’¥å°±ä¸åˆé€‚äº†ï¼Œå› æ­¤å¿…é¡»å¼•å…¥æ–°çš„éšæœºå› ç´ ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŠ ä¸Špre master secretä¸‰ä¸ªéšæœºæ•°ä¸€åŒç”Ÿæˆçš„å¯†é’¥å°±ä¸å®¹æ˜“è¢«çŒœå‡ºäº†ï¼Œä¸€ä¸ªä¼ªéšæœºå¯èƒ½å®Œå…¨ä¸éšæœºï¼Œå¯æ˜¯æ˜¯ä¸‰ä¸ªä¼ªéšæœºå°±ååˆ†æ¥è¿‘éšæœºäº†ï¼Œæ¯å¢åŠ ä¸€ä¸ªè‡ªç”±åº¦ï¼Œéšæœºæ€§å¢åŠ çš„å¯ä¸æ˜¯ä¸€ã€‚&quot;</div></pre></td></tr></table></figure>
<p><strong>æ­¤å¤–ï¼Œå¦‚æœå‰ä¸€æ­¥ï¼ŒæœåŠ¡å™¨è¦æ±‚å®¢æˆ·ç«¯è¯ä¹¦ï¼Œå®¢æˆ·ç«¯ä¼šåœ¨è¿™ä¸€æ­¥å‘é€è¯ä¹¦åŠç›¸å…³ä¿¡æ¯ã€‚</strong></p>
<p>åŒæ—¶éœ€è¦æ³¨æ„å‰ä¸¤ä¸ªéšæœºæ•°éƒ½æ˜¯æ˜æ–‡ä¼ è¾“çš„ï¼Œçªƒå¬è€…æ˜¯å¯ä»¥è½»æ˜“è·å–åˆ°çš„ï¼Œåªæœ‰æœ€åä¸€ä¸ª<strong>PreMaster Secret æ˜¯åŠ å¯†ä¼ è¾“çš„ï¼Œåªæœ‰æ‹¥æœ‰æœåŠ¡å™¨ç§é’¥æ‰èƒ½è§£å¯†</strong>ï¼Œä¸€æ—¦ PreMaster Secret æ³„éœ²ï¼Œé‚£ä¹ˆæœ¬æ¬¡é€šä¿¡å°±å°±å®Œå…¨å¯è¢«ç ´è§£äº†ã€‚</p>
<ul>
<li><strong>PreMaster Secret è¯´æ˜</strong></li>
</ul>
<p>PreMaster secretæ˜¯åœ¨å®¢æˆ·ç«¯ä½¿ç”¨RSAæˆ–è€…Diffie-Hellmanç­‰åŠ å¯†ç®—æ³•ç”Ÿæˆçš„ã€‚å®ƒå°†ç”¨æ¥è·ŸæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åœ¨Helloé˜¶æ®µäº§ç”Ÿçš„éšæœºæ•°ç»“åˆåœ¨ä¸€èµ·ç”ŸæˆMaster secret(åŒ…å«ä¼šè¯å¯¹ç§°å¯†é’¥)ã€‚åœ¨å®¢æˆ·ç«¯ä½¿ç”¨æœåŠ¡å•çš„å…¬é’¥å¯¹PreMaster secretè¿›è¡ŒåŠ å¯†ä¹‹åä¼ é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å°†ä½¿ç”¨ç§é’¥è¿›è¡Œè§£å¯†å¾—åˆ°PreMaster secretã€‚ä¹Ÿå°±æ˜¯è¯´æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½æœ‰ä¸€ä»½ç›¸åŒçš„PreMaster secretå’Œéšæœºæ•°ã€‚</p>
<p>premaster_secret é•¿åº¦ä¸º 48 ä¸ªå­—èŠ‚ï¼Œå‰ 2 ä¸ªå­—èŠ‚æ˜¯åè®®ç‰ˆæœ¬å·ï¼Œå‰©ä¸‹çš„ 46 ä¸ªå­—èŠ‚å¡«å……ä¸€ä¸ªéšæœºæ•°ã€‚ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Struct &#123;</div><div class="line">	byte Version[2];</div><div class="line">	byte random[46];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>PreMaster secretå‰ä¸¤ä¸ªå­—èŠ‚æ˜¯TLSçš„ç‰ˆæœ¬å·ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„ç”¨æ¥æ ¸å¯¹æ¡æ‰‹æ•°æ®çš„ç‰ˆæœ¬å·ï¼Œå› ä¸ºåœ¨Client Helloé˜¶æ®µï¼Œå®¢æˆ·ç«¯ä¼šå‘é€ä¸€ä»½åŠ å¯†å¥—ä»¶åˆ—è¡¨å’Œå½“å‰æ”¯æŒçš„SSL/TLSçš„ç‰ˆæœ¬å·ç»™æœåŠ¡ç«¯ï¼Œè€Œä¸”æ˜¯ä½¿ç”¨æ˜æ–‡ä¼ é€çš„ï¼Œå¦‚æœæ¡æ‰‹çš„æ•°æ®åŒ…è¢«ç ´è§£ä¹‹åï¼Œæ”»å‡»è€…å¾ˆæœ‰å¯èƒ½ä¸²æ”¹æ•°æ®åŒ…ï¼Œé€‰æ‹©ä¸€ä¸ªå®‰å…¨æ€§è¾ƒä½çš„åŠ å¯†å¥—ä»¶å’Œç‰ˆæœ¬ç»™æœåŠ¡ç«¯ï¼Œä»è€Œå¯¹æ•°æ®è¿›è¡Œç ´è§£ã€‚æ‰€ä»¥ï¼ŒæœåŠ¡ç«¯éœ€è¦å¯¹å¯†æ–‡ä¸­è§£å¯†å‡ºæ¥å¯¹çš„PreMasterç‰ˆæœ¬å·è·Ÿä¹‹å‰Client Helloé˜¶æ®µçš„ç‰ˆæœ¬å·è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœç‰ˆæœ¬å·å˜ä½ï¼Œåˆ™è¯´æ˜è¢«ä¸²æ”¹ï¼Œåˆ™ç«‹å³åœæ­¢å‘é€ä»»ä½•æ¶ˆæ¯ã€‚</p>
<ul>
<li><strong>Master secret è¯´æ˜</strong></li>
</ul>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šé¢æ¡æ‰‹è¿‡ç¨‹ä¸­å­˜åœ¨ä¸‰ä¸ªKey(random_1,random_2,PreMaster Secret)ï¼Œè€Œä¸”æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½ä¿ç•™ç€è¿™ä¸‰ä¸ªå€¼ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é€šè¿‡è¿™ä¸‰ä¸ªå€¼è®¡ç®—å‡ºåŒæ ·çš„Master secretã€‚Master secretæ˜¯ç”±ç³»åˆ—çš„hashå€¼ç»„æˆçš„ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="http://honglu-blog.qiniudn.com/image%2F16%2F01%2F14%2FHTTPS%E6%B5%85%E6%9E%90.png" alt="Master secret ç»“æ„"></p>
<p>å…¶ä¸­ï¼ŒClient/Server write MAC key æ˜¯ç”¨æ¥å¯¹æ•°æ®è¿›è¡ŒéªŒè¯çš„ï¼ŒClient/Server write encryption Key æ˜¯ç”¨æ¥å¯¹æ•°æ®è¿›è¡ŒåŠ è§£å¯†çš„ä¼šè¯å¯†é’¥(session secret)ã€‚</p>
<p>å…³äºMaster Secretçš„è®¡ç®—è¯·å‚è€ƒ<a href="http://www.fenesky.com/blog/2014/07/25/how-session-secret.html" target="_blank" rel="external">ã€ŠHtttps SSL/TLS Session Secret(Key)è®¡ç®—ã€‹</a>ã€‚</p>
<h4 id="4-4-æœåŠ¡å™¨çš„æœ€åå›åº”"><a href="#4-4-æœåŠ¡å™¨çš„æœ€åå›åº”" class="headerlink" title="4.4 æœåŠ¡å™¨çš„æœ€åå›åº”"></a><strong>4.4 æœåŠ¡å™¨çš„æœ€åå›åº”</strong></h4><p>æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„ç¬¬ä¸‰ä¸ªéšæœºæ•°pre-master keyä¹‹åï¼Œè®¡ç®—ç”Ÿæˆæœ¬æ¬¡ä¼šè¯æ‰€ç”¨çš„â€ä¼šè¯å¯†é’¥â€ã€‚ç„¶åï¼Œå‘å®¢æˆ·ç«¯æœ€åå‘é€ä¸‹é¢ä¿¡æ¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ï¼ˆ1ï¼‰ç¼–ç æ”¹å˜é€šçŸ¥ï¼Œè¡¨ç¤ºéšåçš„ä¿¡æ¯éƒ½å°†ç”¨åŒæ–¹å•†å®šçš„åŠ å¯†æ–¹æ³•å’Œå¯†é’¥å‘é€ã€‚</div><div class="line">ï¼ˆ2ï¼‰æœåŠ¡å™¨æ¡æ‰‹ç»“æŸé€šçŸ¥ï¼Œè¡¨ç¤ºæœåŠ¡å™¨çš„æ¡æ‰‹é˜¶æ®µå·²ç»ç»“æŸã€‚è¿™ä¸€é¡¹åŒæ—¶ä¹Ÿæ˜¯å‰é¢å‘é€çš„æ‰€æœ‰å†…å®¹çš„hashå€¼ï¼Œç”¨æ¥ä¾›å®¢æˆ·ç«¯æ ¡éªŒã€‚</div></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œæ•´ä¸ªæ¡æ‰‹é˜¶æ®µå…¨éƒ¨ç»“æŸã€‚æ¥ä¸‹æ¥ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨è¿›å…¥åŠ å¯†é€šä¿¡ï¼Œå°±å®Œå…¨æ˜¯ä½¿ç”¨æ™®é€šçš„HTTPåè®®ï¼Œåªä¸è¿‡ç”¨â€ä¼šè¯å¯†é’¥â€åŠ å¯†å†…å®¹ã€‚</p>
<p><img src="http://image.beekka.com/blog/201402/bg2014020503.gif" alt="img"></p>
<h3 id="äº”ã€åº”ç”¨æ•°æ®ä¼ è¾“"><a href="#äº”ã€åº”ç”¨æ•°æ®ä¼ è¾“" class="headerlink" title="äº”ã€åº”ç”¨æ•°æ®ä¼ è¾“"></a><strong>äº”ã€åº”ç”¨æ•°æ®ä¼ è¾“</strong></h3><p>åœ¨æ‰€æœ‰çš„æ¡æ‰‹é˜¶æ®µéƒ½å®Œæˆä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹ä¼ é€åº”ç”¨æ•°æ®äº†ã€‚åº”ç”¨æ•°æ®åœ¨ä¼ è¾“ä¹‹å‰ï¼Œé¦–å…ˆè¦é™„åŠ ä¸ŠMAC secretï¼Œç„¶åå†å¯¹è¿™ä¸ªæ•°æ®åŒ…ä½¿ç”¨write encryption keyè¿›è¡ŒåŠ å¯†ã€‚åœ¨æœåŠ¡ç«¯æ”¶åˆ°å¯†æ–‡ä¹‹åï¼Œä½¿ç”¨Client write encryption keyè¿›è¡Œè§£å¯†ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯çš„æ•°æ®ä¹‹åä½¿ç”¨Server write encryption keyè¿›è¡Œè§£å¯†ï¼Œç„¶åä½¿ç”¨å„è‡ªçš„write MAC keyå¯¹æ•°æ®çš„å®Œæ•´æ€§åŒ…æ‹¬æ˜¯å¦è¢«ä¸²æ”¹è¿›è¡ŒéªŒè¯ã€‚</p>
<h3 id="å…­ã€å¯¹ç§°åŠ å¯†-amp-éå¯¹ç§°åŠ å¯†"><a href="#å…­ã€å¯¹ç§°åŠ å¯†-amp-éå¯¹ç§°åŠ å¯†" class="headerlink" title="å…­ã€å¯¹ç§°åŠ å¯† &amp; éå¯¹ç§°åŠ å¯†"></a><strong>å…­ã€å¯¹ç§°åŠ å¯† &amp; éå¯¹ç§°åŠ å¯†</strong></h3><p>HTTPS çš„é€šä¿¡è¿‡ç¨‹ä¸­åªåœ¨æ¡æ‰‹é˜¶æ®µä½¿ç”¨äº†éå¯¹ç§°åŠ å¯†ï¼Œåé¢çš„é€šä¿¡è¿‡ç¨‹å‡ä½¿ç”¨çš„å¯¹ç§°åŠ å¯†ã€‚å°½ç®¡éå¯¹ç§°åŠ å¯†ç›¸æ¯”å¯¹ç§°åŠ å¯†æ›´åŠ å®‰å…¨ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸¤ä¸ªæ˜æ˜¾ç¼ºç‚¹ï¼š</p>
<ol>
<li>CPU è®¡ç®—èµ„æºæ¶ˆè€—éå¸¸å¤§ã€‚ä¸€æ¬¡å®Œå…¨ TLS æ¡æ‰‹ï¼Œå¯†é’¥äº¤æ¢æ—¶çš„éå¯¹ç§°è§£å¯†è®¡ç®—é‡å æ•´ä¸ªæ¡æ‰‹è¿‡ç¨‹çš„ 90% ä»¥ä¸Šã€‚è€Œå¯¹ç§°åŠ å¯†çš„è®¡ç®—é‡åªç›¸å½“äºéå¯¹ç§°åŠ å¯†çš„ 0.1%ï¼Œå¦‚æœåº”ç”¨å±‚æ•°æ®ä¹Ÿä½¿ç”¨éå¯¹ç§°åŠ è§£å¯†ï¼Œæ€§èƒ½å¼€é”€å¤ªå¤§ï¼Œæ— æ³•æ‰¿å—ã€‚</li>
<li>éå¯¹ç§°åŠ å¯†ç®—æ³•å¯¹åŠ å¯†å†…å®¹çš„é•¿åº¦æœ‰é™åˆ¶ï¼Œä¸èƒ½è¶…è¿‡å…¬é’¥é•¿åº¦ã€‚æ¯”å¦‚ç°åœ¨å¸¸ç”¨çš„å…¬é’¥é•¿åº¦æ˜¯ 2048 ä½ï¼Œæ„å‘³ç€å¾…åŠ å¯†å†…å®¹ä¸èƒ½è¶…è¿‡ 256 ä¸ªå­—èŠ‚ã€‚</li>
</ol>
<p>æ‰€ä»¥å…¬é’¥åŠ å¯†ç›®å‰åªèƒ½ç”¨æ¥ä½œå¯†é’¥äº¤æ¢æˆ–è€…å†…å®¹ç­¾åï¼Œä¸é€‚åˆç”¨æ¥åšåº”ç”¨å±‚ä¼ è¾“å†…å®¹çš„åŠ è§£å¯†ã€‚</p>
<p>éå¯¹ç§°å¯†é’¥äº¤æ¢ç®—æ³•æ˜¯æ•´ä¸ª HTTPS å¾—ä»¥å®‰å…¨çš„åŸºçŸ³ï¼Œå……åˆ†ç†è§£éå¯¹ç§°å¯†é’¥äº¤æ¢ç®—æ³•æ˜¯ç†è§£ HTTPS åè®®å’ŒåŠŸèƒ½çš„å…³é”®ã€‚</p>
<h3 id="ä¸ƒã€è¯ä¹¦"><a href="#ä¸ƒã€è¯ä¹¦" class="headerlink" title="ä¸ƒã€è¯ä¹¦"></a><strong>ä¸ƒã€è¯ä¹¦</strong></h3><p>ä¸‹é¢æ˜¯ä½¿ç”¨ chrome è®¿é—® Google æ—¶æŸ¥çœ‹çš„è¯ä¹¦è¯¦ç»†ä¿¡æ¯</p>
<p><img src="http://honglu-blog.qiniudn.com/image%2F16%2F01%2F14%2FHTTPS%20%E8%AF%81%E4%B9%A6%E7%BB%93%E6%9E%84.png" alt="Google  HTTPSè¯ä¹¦"></p>
<p>æ•°å­—è¯ä¹¦çš„æ ¼å¼æ™®éé‡‡ç”¨çš„æ˜¯X.509V3å›½é™…æ ‡å‡†ï¼Œä¸€ä¸ªæ ‡å‡†çš„X.509æ•°å­—è¯ä¹¦åŒ…å«ä»¥ä¸‹ä¸€äº›å†…å®¹ï¼š</p>
<ul>
<li>è¯ä¹¦çš„ç‰ˆæœ¬ä¿¡æ¯ï¼›</li>
<li>è¯ä¹¦çš„åºåˆ—å·ï¼Œæ¯ä¸ªè¯ä¹¦éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„è¯ä¹¦åºåˆ—å·ï¼›</li>
<li>è¯ä¹¦æ‰€ä½¿ç”¨çš„ç­¾åç®—æ³•ï¼›</li>
<li>è¯ä¹¦çš„å‘è¡Œæœºæ„åç§°ï¼Œå‘½åè§„åˆ™ä¸€èˆ¬é‡‡ç”¨X.500æ ¼å¼ï¼›</li>
<li>è¯ä¹¦çš„æœ‰æ•ˆæœŸï¼Œé€šç”¨çš„è¯ä¹¦ä¸€èˆ¬é‡‡ç”¨UTCæ—¶é—´æ ¼å¼ï¼Œå®ƒçš„è®¡æ—¶èŒƒå›´ä¸º1950-2049ï¼›</li>
<li>è¯ä¹¦æ‰€æœ‰äººçš„åç§°ï¼Œå‘½åè§„åˆ™ä¸€èˆ¬é‡‡ç”¨X.500æ ¼å¼ï¼›</li>
<li>è¯ä¹¦æ‰€æœ‰äººçš„å…¬é’¥ï¼›</li>
<li>è¯ä¹¦å‘è¡Œè€…å¯¹è¯ä¹¦çš„ç­¾åã€‚</li>
</ul>
<p>è¯ä¹¦ä»¥é“¾çš„å½¢å¼ç»„ç»‡ï¼Œä¸Šçº§æ ‡è¯†è¯¥è¯ä¹¦çš„ç­¾å‘æœºæ„ï¼ŒéªŒè¯è¯ä¹¦çš„æ—¶å€™ä¹Ÿæ˜¯é¡ºç€è¿™ä¸ªé“¾å‘ä¸Šå±‚å±‚éªŒè¯çš„ï¼Œåªæœ‰æ‰€æœ‰è¯ä¹¦éƒ½æ˜¯å—ä¿¡çš„ï¼Œæ•´ä¸ªéªŒè¯ç»“æœæ‰æ˜¯å¯ä¿¡çš„ã€‚é‚£ä¹ˆæ ¹è¯ä¹¦æ˜¯å¦‚ä½•éªŒè¯çš„å‘¢ï¼Ÿæ ¹è¯ä¹¦æ˜¯è‡ªä¿¡ä»»çš„ï¼Œåœ¨æ“ä½œç³»ç»Ÿæˆ–è€…æµè§ˆå…¶ä¸­éƒ½ä¼šé»˜è®¤ä¸€äº›å—ä¿¡ä»»çš„ CA æœºæ„æ ¹è¯ä¹¦ã€‚</p>
<p>é™¤éå¯¹è¿™ä¸ªæ ¹è¯ä¹¦æœ‰ç»å¯¹çš„ä¿¡ä»»æ‰å¯ä»¥åŠ å…¥ä¿¡ä»»åˆ—è¡¨ä¸­ï¼Œå› ä¸ºæ ¹è¯ä¹¦æ˜¯æœ‰æƒç­¾å‘å­è¯ä¹¦çš„ï¼Œå¦‚æœæ ¹è¯ä¹¦å¤±ä¿¡ï¼Œé‚£ä¹ˆå¯¹åº”çš„å­è¯ä¹¦çš„å¯ä¿¡æ€§å°±æ— ä»è°ˆèµ·ï¼Œé‚£ä¹ˆä¸ä½¿ç”¨ç›¸åº”è¯ä¹¦çš„ HTTPS ç½‘ç«™é€šä¿¡çš„å®‰å…¨æ€§å°±å¾—ä¸åˆ°ä¿éšœäº†ã€‚å½“è®¿é—®12306çš„æ—¶å€™ï¼Œç½‘ç«™ä¼šæç¤ºæŠŠå…¶æä¾›çš„æ ¹è¯ä¹¦åŠ å…¥åˆ°å¯ä¿¡ä»»åˆ—è¡¨é‡Œé¢ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè®¸å¤šäººåå¯¹è¿™ç§åšæ³•çš„åŸå› äº†ã€‚å¦å¤–ä¸­å›½äº’è”ç½‘ä¿¡æ¯ä¸­å¿ƒ(CNNIC)ä¹Ÿæ›¾å‘å¸ƒè¿‡ç”¨äºä¸­é—´äººæ”»å‡»è¯ä¹¦ï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="http://www.williamlong.info/archives/4183.html" target="_blank" rel="external">è°·æ­Œç§°CNNICå‘å¸ƒä¼ªé€ CAè¯ä¹¦</a>ã€‚</p>
<p>Mac ç”¨æˆ·å¯ä»¥é€šè¿‡ é’¥åŒ™ä¸²-&gt;ç³»ç»Ÿæ ¹è¯ä¹¦ æŸ¥çœ‹ç³»ç»Ÿé»˜è®¤ä¿¡ä»»çš„æ‰€æœ‰æ ¹è¯ä¹¦ï¼Œå¦‚æœæƒ³å–æ¶ˆä¿¡ä»»(æ¯”å¦‚ CNNICè¯ä¹¦)ï¼Œå¯ä»¥åŒå‡»ï¼Œæ”¹ä¸ºæ°¸ä¸ä¿¡ä»»</p>
<h3 id="å…«ã€å®‰å…¨æ€§"><a href="#å…«ã€å®‰å…¨æ€§" class="headerlink" title="å…«ã€å®‰å…¨æ€§"></a><strong>å…«ã€å®‰å…¨æ€§</strong></h3><p>é’ˆå¯¹ HTTPS çš„æ”»å‡»æœ€ä¸»è¦çš„å°±æ˜¯ SSL åŠ«æŒæ”»å‡»ï¼Œå…¶åˆ†ä¸ºä¸¤ç§ï¼š</p>
<p><strong>HTTPS æ›¿æ¢ä¸º HTTP</strong></p>
<p>è¿™ç§æ–¹å¼å°±æ˜¯æ”»å‡»è€…å……å½“ä¸­é—´äººå’ŒæœåŠ¡å™¨é€šä¿¡ï¼Œç„¶åæŠŠç›¸åº”çš„é€šä¿¡å†…å®¹é€šè¿‡ HTTP åè®®å‘é€ç»™å®¢æˆ·ç«¯ï¼Œç”±äº HTTP åè®®æ˜¯æœªåŠ å¯†çš„ï¼Œäºæ˜¯å°±å¯ä»¥æˆªè·ç”¨æˆ·çš„è®¿é—®æ•°æ®ã€‚</p>
<p>è¿™ç§æ”»å‡»æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡ä»£ç†ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„æŠŠ HTTPS å˜æˆ HTTPï¼Œè¿™ä¸ªä¸€æ–¹é¢éœ€è¦ç”¨æˆ·ç•™æ„ç½‘ç«™æ˜¯å¦æœ‰ä» HTTPS è·³è½¬åˆ° HTTP çš„è¡Œä¸ºï¼Œå¦ä¸€æ–¹é¢æœåŠ¡å™¨ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®å°†æ‰€æœ‰HTTPçš„è¯·æ±‚å¼ºåˆ¶è½¬ç§»åˆ°HTTPSä¸Šã€‚</p>
<p><strong>HTTPS åŠ«æŒ</strong></p>
<p>è¿™ç§æ–¹å¼æ”»å‡»è€…ä¸ºäº†è·å¾— HTTPS çš„æ˜æ–‡ä¼ è¾“å†…å®¹ï¼Œéœ€è¦å……å½“ä¸­é—´äººï¼Œæ›¿æ¢æœåŠ¡å™¨å‘ç»™ç”¨æˆ·çš„åŒ…å«å…¬é’¥çš„è¯ä¹¦ã€‚æ”»å‡»è€…æ—¢å’Œç”¨æˆ·ä¹‹é—´å»ºç«‹äº† HTTPS é“¾æ¥ï¼Œåˆå’ŒæœåŠ¡å™¨å»ºç«‹äº† HTTPS é“¾æ¥ã€‚</p>
<p>åœ¨ä¸Šé¢æ¡æ‰‹å»ºç«‹çš„è¿‡ç¨‹ä¸­ï¼Œç”±äºç”¨æˆ·çš„å…¬é’¥æ˜¯æ”»å‡»è€…ç”Ÿæˆçš„ï¼Œæ‰€ä»¥æ”»å‡»è€…å¯ä»¥è½»æ˜“è·å¾—æ¡æ‰‹ä¸­çš„æ•°æ®ã€‚ä¹Ÿå°±å¯ä»¥è·å–åˆ°å’Œç”¨æˆ·é€šä¿¡è¿‡ç¨‹ä¸­çš„å¯¹ç§°åŠ å¯†çš„å¯†é’¥ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡å¯†é’¥è·å–ç”¨æˆ·å‘é€çš„æ•°æ®ï¼ŒåŒæ—¶åœ¨ä½¿ç”¨å’ŒæœåŠ¡å™¨é€šä¿¡çš„å¯†é’¥åŠ å¯†åå†å‘é€ç»™æœåŠ¡å™¨ã€‚</p>
<p>è¿™ç§æ”»å‡»æ–¹å¼ä¹Ÿæœ‰ä¸€ä¸ªæ˜æ˜¾çš„é—®é¢˜å°±æ˜¯æ”»å‡»è€…ç”Ÿæˆçš„è¯ä¹¦å‡ ä¹æ˜¯ä¸å¯èƒ½è¢«ç”¨æˆ·ä¿¡ä»»çš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·æµè§ˆå™¨é€šå¸¸ä¼šæç¤ºè¯¥ç½‘ç«™çš„è¯ä¹¦ä¸å¯ä¿¡ï¼Œæ˜¯å¦ç»§ç»­è®¿é—®ï¼Œè¿™å·²ç»å¯¹ç”¨æˆ·è¿›è¡Œäº†ä¸€ä¸ªæ˜æ˜¾çš„è­¦å‘Šäº†ã€‚</p>
<p>å¦å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¿™ç§å¯¹åŸºäº HTTPS çš„é€šä¿¡è¿›è¡ŒæŠ“åŒ…åˆ†æã€‚Mac å¹³å°è‘—åçš„æŠ“åŒ…å·¥å…· Charles å°±æ˜¯åŸºäºè¿™ç§æ–¹å¼ï¼Œé¦–å…ˆè¦æ±‚ä½ ä¿¡ä»»ä¸€ä¸ªå®ƒçš„è¯ä¹¦ï¼Œç„¶åè‡ªå·±å……å½“ä¸­é—´äººå¯¹ä½ ä¸æŸä¸ªæœåŠ¡å™¨çš„ HTTPS é€šä¿¡è¿›è¡ŒæŠ“åŒ…åˆ†æã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[mysql å­˜å‚¨å¼•æ“]]></title>
      <url>http://zsr.github.io/2016/09/27/mysql-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/</url>
      <content type="html"><![CDATA[<h3 id="ä»€ä¹ˆæ˜¯å­˜å‚¨å¼•æ“ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å­˜å‚¨å¼•æ“ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å­˜å‚¨å¼•æ“ï¼Ÿ"></a><strong>ä»€ä¹ˆæ˜¯å­˜å‚¨å¼•æ“ï¼Ÿ</strong></h3><p>å­˜å‚¨å¼•æ“è¯´ç™½äº†å°±æ˜¯å¦‚ä½•å­˜å‚¨æ•°æ®ã€å¦‚ä½•ä¸ºå­˜å‚¨çš„æ•°æ®å»ºç«‹ç´¢å¼•å’Œå¦‚ä½•æ›´æ–°ã€æŸ¥è¯¢æ•°æ®ç­‰æŠ€æœ¯çš„å®ç°æ–¹æ³•ã€‚å› ä¸ºåœ¨å…³ç³»æ•°æ®åº“ä¸­æ•°æ®çš„å­˜å‚¨æ˜¯ä»¥è¡¨çš„å½¢å¼å­˜å‚¨çš„ï¼Œæ‰€ä»¥å­˜å‚¨å¼•æ“ä¹Ÿå¯ä»¥ç§°ä¸ºè¡¨ç±»å‹ï¼ˆå³å­˜å‚¨å’Œæ“ä½œæ­¤è¡¨çš„ç±»å‹ï¼‰ã€‚</p>
<p>å…³ç³»æ•°æ®åº“è¡¨æ˜¯ç”¨äºå­˜å‚¨å’Œç»„ç»‡ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥å°†è¡¨ç†è§£ä¸ºç”±è¡Œå’Œåˆ—ç»„æˆçš„è¡¨æ ¼ï¼Œç±»ä¼¼äºExcelçš„ç”µå­è¡¨æ ¼çš„å½¢å¼ã€‚æœ‰çš„è¡¨ç®€å•ï¼Œæœ‰çš„è¡¨å¤æ‚ï¼Œæœ‰çš„è¡¨æ ¹æœ¬ä¸ç”¨æ¥å­˜å‚¨ä»»ä½•é•¿æœŸçš„æ•°æ®ï¼Œæœ‰çš„è¡¨è¯»å–æ—¶éå¸¸å¿«ï¼Œä½†æ˜¯æ’å…¥æ•°æ®æ—¶å»å¾ˆå·®ï¼›è€Œæˆ‘ä»¬åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå°±å¯èƒ½éœ€è¦å„ç§å„æ ·çš„è¡¨ï¼Œä¸åŒçš„è¡¨ï¼Œå°±æ„å‘³ç€å­˜å‚¨ä¸åŒç±»å‹çš„æ•°æ®ï¼Œæ•°æ®çš„å¤„ç†ä¸Šä¹Ÿä¼šå­˜åœ¨ç€å·®å¼‚ï¼Œé‚£ä¹ˆã€‚å¯¹äºMySQLæ¥è¯´ï¼Œå®ƒæä¾›äº†å¾ˆå¤šç§ç±»å‹çš„å­˜å‚¨å¼•æ“ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å¯¹æ•°æ®å¤„ç†çš„éœ€æ±‚ï¼Œé€‰æ‹©ä¸åŒçš„å­˜å‚¨å¼•æ“ï¼Œä»è€Œæœ€å¤§é™åº¦çš„åˆ©ç”¨MySQLå¼ºå¤§çš„åŠŸèƒ½ã€‚</p>
<h3 id="MyISAMå­˜å‚¨å¼•æ“"><a href="#MyISAMå­˜å‚¨å¼•æ“" class="headerlink" title="MyISAMå­˜å‚¨å¼•æ“"></a><strong>MyISAMå­˜å‚¨å¼•æ“</strong></h3><p>åœ¨mysqlå®¢æˆ·ç«¯ä¸­ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹MySQLæ”¯æŒçš„å¼•æ“ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">show engines;</div></pre></td></tr></table></figure>
<p>MyISAMè¡¨æ˜¯ç‹¬ç«‹äºæ“ä½œç³»ç»Ÿçš„ï¼Œè¿™è¯´æ˜å¯ä»¥è½»æ¾åœ°å°†å…¶ä»WindowsæœåŠ¡å™¨ç§»æ¤åˆ°LinuxæœåŠ¡å™¨ï¼›æ¯å½“æˆ‘ä»¬å»ºç«‹ä¸€ä¸ªMyISAMå¼•æ“çš„è¡¨æ—¶ï¼Œå°±ä¼šåœ¨æœ¬åœ°ç£ç›˜ä¸Šå»ºç«‹ä¸‰ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶åå°±æ˜¯è¡¨åã€‚ä¾‹å¦‚ï¼Œæˆ‘å»ºç«‹äº†ä¸€ä¸ªMyISAMå¼•æ“çš„tb_Demoè¡¨ï¼Œé‚£ä¹ˆå°±ä¼šç”Ÿæˆä»¥ä¸‹ä¸‰ä¸ªæ–‡ä»¶ï¼š</p>
<ul>
<li>tb_demo.frmï¼Œå­˜å‚¨è¡¨å®šä¹‰ï¼›</li>
<li>tb_demo.MYDï¼Œå­˜å‚¨æ•°æ®ï¼›</li>
<li>tb_demo.MYIï¼Œå­˜å‚¨ç´¢å¼•ã€‚</li>
</ul>
<p>MyISAMè¡¨æ— æ³•å¤„ç†äº‹åŠ¡ï¼Œè¿™å°±æ„å‘³ç€æœ‰äº‹åŠ¡å¤„ç†éœ€æ±‚çš„è¡¨ï¼Œä¸èƒ½ä½¿ç”¨MyISAMå­˜å‚¨å¼•æ“ã€‚MyISAMå­˜å‚¨å¼•æ“ç‰¹åˆ«é€‚åˆåœ¨ä»¥ä¸‹å‡ ç§æƒ…å†µä¸‹ä½¿ç”¨ï¼š</p>
<ul>
<li>é€‰æ‹©å¯†é›†å‹çš„è¡¨ã€‚MyISAMå­˜å‚¨å¼•æ“åœ¨ç­›é€‰å¤§é‡æ•°æ®æ—¶éå¸¸è¿…é€Ÿï¼Œè¿™æ˜¯å®ƒæœ€çªå‡ºçš„ä¼˜ç‚¹ã€‚</li>
<li>æ’å…¥å¯†é›†å‹çš„è¡¨ã€‚MyISAMçš„å¹¶å‘æ’å…¥ç‰¹æ€§å…è®¸åŒæ—¶é€‰æ‹©å’Œæ’å…¥æ•°æ®ã€‚ä¾‹å¦‚ï¼šMyISAMå­˜å‚¨å¼•æ“å¾ˆé€‚åˆç®¡ç†é‚®ä»¶æˆ–WebæœåŠ¡å™¨æ—¥å¿—æ•°æ®ã€‚</li>
</ul>
<h3 id="InnoDBå­˜å‚¨å¼•æ“"><a href="#InnoDBå­˜å‚¨å¼•æ“" class="headerlink" title="InnoDBå­˜å‚¨å¼•æ“"></a><strong>InnoDBå­˜å‚¨å¼•æ“</strong></h3><p>InnoDBç»™Mysqlçš„è¡¨æä¾›äº† äº‹åŠ¡ã€å›æ»šã€å´©æºƒä¿®å¤èƒ½åŠ›ã€å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶çš„äº‹åŠ¡å®‰å…¨ã€é—´éš™é”ï¼ˆå¯ä»¥æœ‰æ•ˆçš„é˜²æ­¢å¹»è¯»çš„å‡ºç°ï¼‰ã€æ”¯æŒè¾…åŠ©ç´¢å¼•ã€èšç°‡ç´¢å¼•ã€è‡ªé€‚åº”hashç´¢å¼•ã€æ”¯æŒçƒ­å¤‡ã€è¡Œçº§é”ã€‚è¿˜æœ‰InnoDBæ˜¯Mysqlä¸Šå”¯ä¸€ä¸€ä¸ªæä¾›äº†å¤–é”®çº¦æŸçš„å¼•æ“ã€‚</p>
<p>InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œåˆ›å»ºçš„è¡¨çš„è¡¨ç»“æ„æ˜¯å•ç‹¬å­˜å‚¨çš„å¹¶ä¸”å­˜å‚¨åœ¨.frmæ–‡ä»¶ä¸­ã€‚æ•°æ®å’Œç´¢å¼•å­˜å‚¨åœ¨ä¸€èµ·çš„å¹¶ä¸”å­˜å‚¨åœ¨è¡¨ç©ºé—´ä¸­ã€‚ä½†æ˜¯é»˜è®¤æƒ…å†µä¸‹mysqlä¼šå°†æ•°æ®åº“çš„æ‰€æœ‰InnoDBè¡¨å­˜å‚¨åœ¨ä¸€ä¸ªè¡¨ç©ºé—´ä¸­çš„ã€‚</p>
<p>InnoDBæ˜¯ä¸€ä¸ªå¥å£®çš„äº‹åŠ¡å‹å­˜å‚¨å¼•æ“ï¼Œ<strong>mysql 5.5 ä¹‹åã€‚InnoDB è¢«è®¤å®šä¸ºé»˜è®¤çš„å­˜å‚¨å¼•æ“</strong>. InnoDBå°±æ˜¯ä½œä¸ºé»˜è®¤çš„å­˜å‚¨å¼•æ“**ã€‚InnoDBè¿˜å¼•å…¥äº†è¡Œçº§é”å®šå’Œå¤–é”®çº¦æŸï¼Œåœ¨ä»¥ä¸‹åœºåˆä¸‹ï¼Œä½¿ç”¨InnoDBæ˜¯æœ€ç†æƒ³çš„é€‰æ‹©ï¼š</p>
<ol>
<li>æ›´æ–°å¯†é›†çš„è¡¨ã€‚InnoDBå­˜å‚¨å¼•æ“ç‰¹åˆ«é€‚åˆå¤„ç†å¤šé‡å¹¶å‘çš„æ›´æ–°è¯·æ±‚ã€‚</li>
<li>äº‹åŠ¡ã€‚InnoDBå­˜å‚¨å¼•æ“æ˜¯æ”¯æŒäº‹åŠ¡çš„æ ‡å‡†MySQLå­˜å‚¨å¼•æ“ã€‚</li>
<li>è‡ªåŠ¨ç¾éš¾æ¢å¤ã€‚ä¸å…¶å®ƒå­˜å‚¨å¼•æ“ä¸åŒï¼ŒInnoDBè¡¨èƒ½å¤Ÿè‡ªåŠ¨ä»ç¾éš¾ä¸­æ¢å¤ã€‚</li>
<li>å¤–é”®çº¦æŸã€‚MySQLæ”¯æŒå¤–é”®çš„å­˜å‚¨å¼•æ“åªæœ‰InnoDBã€‚</li>
<li>æ”¯æŒè‡ªåŠ¨å¢åŠ åˆ—AUTO_INCREMENTå±æ€§ã€‚</li>
</ol>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœéœ€è¦äº‹åŠ¡æ”¯æŒï¼Œå¹¶ä¸”æœ‰è¾ƒé«˜çš„å¹¶å‘è¯»å–é¢‘ç‡ï¼ŒInnoDBæ˜¯ä¸é”™çš„é€‰æ‹©ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[context:annotation-config ä¸ context:component-scanåŒºåˆ«]]></title>
      <url>http://zsr.github.io/2016/09/21/context-annotation-config%E4%B8%8Econtext-component-scan%E5%8C%BA%E5%88%AB/</url>
      <content type="html"><![CDATA[<p><code>&lt;context:annotation-config&gt;</code> <strong>æ˜¯ç”¨äºæ¿€æ´»é‚£äº›å·²ç»åœ¨springå®¹å™¨é‡Œæ³¨å†Œè¿‡çš„bean</strong>ï¼ˆæ— è®ºæ˜¯é€šè¿‡xmlçš„æ–¹å¼è¿˜æ˜¯é€šè¿‡package sanningçš„æ–¹å¼ï¼‰ä¸Šé¢çš„æ³¨è§£ã€‚</p>
<p><code>&lt;context:component-scan&gt;</code>é™¤äº†å…·æœ‰<code>&lt;context:annotation-config&gt;</code>çš„åŠŸèƒ½ä¹‹å¤–ï¼Œ<code>&lt;context:component-scan&gt;</code>è¿˜å¯ä»¥åœ¨æŒ‡å®šçš„packageä¸‹æ‰«æä»¥åŠæ³¨å†Œjavabean ã€‚</p>
<p>ä¸‹é¢é€šè¿‡ä¾‹å­æ¥è¯¦ç»†æŸ¥çœ‹ä»–ä»¬çš„åŒºåˆ«ï¼Œæœ‰ä¸‰ä¸ªclass   A,B,C,å¹¶ä¸”B,Cçš„å¯¹è±¡è¢«æ³¨å…¥åˆ°Aä¸­.</p>
<h3 id="é€šè¿‡xmlçš„æ–¹å¼"><a href="#é€šè¿‡xmlçš„æ–¹å¼" class="headerlink" title="é€šè¿‡xmlçš„æ–¹å¼"></a><strong>é€šè¿‡xmlçš„æ–¹å¼</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.xxx;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"creating bean B: "</span> + <span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">package</span> com.xxx;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">C</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"creating bean C: "</span> + <span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">package</span> com.yyy;</div><div class="line"><span class="keyword">import</span> com.xxx.B;</div><div class="line"><span class="keyword">import</span> com.xxx.C;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123; </div><div class="line">  <span class="keyword">private</span> B bbb;</div><div class="line">  <span class="keyword">private</span> C ccc;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"creating bean A: "</span> + <span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBbb</span><span class="params">(B bbb)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"setting A.bbb with "</span> + bbb);</div><div class="line">    <span class="keyword">this</span>.bbb = bbb;</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCcc</span><span class="params">(C ccc)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"setting A.ccc with "</span> + ccc);</div><div class="line">    <span class="keyword">this</span>.ccc = ccc; </div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨applicationContext.xmlä¸­åŠ å…¥ä¸‹é¢çš„é…ç½® :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;bean id="bBean"class="com.xxx.B"/&gt;</div><div class="line">&lt;bean id="cBean"class="com.xxx.C"/&gt;</div><div class="line">&lt;bean id="aBean"class="com.yyy.A"&gt;</div><div class="line">  &lt;property name="bbb" ref="bBean"/&gt;</div><div class="line">  &lt;property name="ccc" ref="cBean"/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<p>åŠ è½½applicationContext.xmlé…ç½®æ–‡ä»¶ï¼Œå°†å¾—åˆ°ä¸‹é¢çš„ç»“æœ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">creating bean B: com.xxx.B<span class="meta">@c</span>2ff5</div><div class="line">creating bean C: com.xxx.C@<span class="number">1e8</span>a1f6</div><div class="line">creating bean A: com.yyy.A@<span class="number">1e152</span>c5</div><div class="line">setting A.bbb with com.xxx.B<span class="meta">@c</span>2ff5</div><div class="line">setting A.ccc with com.xxx.C@<span class="number">1e8</span>a1f6</div></pre></td></tr></table></figure>
<h3 id="é€šè¿‡æ³¨è§£çš„æ–¹å¼"><a href="#é€šè¿‡æ³¨è§£çš„æ–¹å¼" class="headerlink" title="é€šè¿‡æ³¨è§£çš„æ–¹å¼"></a><strong>é€šè¿‡æ³¨è§£çš„æ–¹å¼</strong></h3><p><strong>ä½¿ç”¨<code>&lt;context:annotation-config&gt;</code>å’Œ <code>&lt;context:component-scan&gt;</code></strong></p>
<a id="more"></a>
<ul>
<li><strong>ä½¿ç”¨<code>&lt;context:annotation-config&gt;</code></strong></li>
</ul>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨<code>@Autowire</code>çš„æ–¹å¼å°†å¯¹è±¡bbbå’Œcccæ³¨å…¥åˆ°Aä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.yyy;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> com.xxx.B;</div><div class="line"><span class="keyword">import</span> com.xxx.C;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123; </div><div class="line">  <span class="keyword">private</span> B bbb;</div><div class="line">  <span class="keyword">private</span> C ccc;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"creating bean A: "</span> + <span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="meta">@Autowired</span> </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBbb</span><span class="params">(B bbb)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"setting A.bbb with "</span> + bbb);</div><div class="line">    <span class="keyword">this</span>.bbb = bbb;</div><div class="line">  &#125;</div><div class="line">  <span class="meta">@Autowired</span> </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCcc</span><span class="params">(C ccc)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"setting A.ccc with "</span> + ccc);</div><div class="line">    <span class="keyword">this</span>.ccc = ccc;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åapplicationContext.xmlé…ç½®æ–‡ä»¶å»é™¤å±æ€§<code>&lt;property&gt;</code>å°±ç®€åŒ–ä¸ºä¸‹é¢çš„æ ·å­äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=<span class="string">"bBean"</span><span class="class"><span class="keyword">class</span></span>=<span class="string">"com.xxx.B"</span>/&gt;</div><div class="line">&lt;bean id=<span class="string">"cBean"</span><span class="class"><span class="keyword">class</span></span>=<span class="string">"com.xxx.C"</span>/&gt;</div><div class="line">&lt;bean id=<span class="string">"aBean"</span><span class="class"><span class="keyword">class</span></span>=<span class="string">"com.yyy.A"</span>/&gt;</div></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬åŠ è½½applicationContext.xmlé…ç½®æ–‡ä»¶ä¹‹åï¼Œå°†å¾—åˆ°ä¸‹é¢çš„ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">reating bean B: com.xxx.B@<span class="number">5e5</span>a50</div><div class="line">creating bean C: com.xxx.C@<span class="number">54</span>a328</div><div class="line">creating bean A: com.yyy.A<span class="meta">@a</span>3d4cf</div></pre></td></tr></table></figure>
<p>ClassAä¸­æ˜¾ç„¶æ²¡æœ‰æ³¨å…¥å±æ€§ï¼Œç»“æœæ˜¯é”™è¯¯çš„çš„ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬çš„å±æ€§æ²¡æœ‰è¢«æ³¨å…¥è¿›å»å‘¢ï¼Ÿ</p>
<p>æ˜¯å› ä¸ºæ³¨è§£æœ¬èº«å¹¶ä¸èƒ½å¤Ÿåšä»»ä½•äº‹æƒ…ï¼Œå®ƒä»¬åªæ˜¯æœ€åŸºæœ¬çš„ç»„æˆéƒ¨åˆ†ï¼Œæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿå¤„ç†è¿™äº›æ³¨è§£çš„å¤„ç†å·¥å…·æ¥å¤„ç†è¿™äº›æ³¨è§£ã€‚</p>
<p>è¿™å°±æ˜¯<code>&lt;context:annotation-config&gt;</code> æ‰€åšçš„äº‹æƒ…ï¼Œ<strong>ç”¨äºæ¿€æ´»é‚£äº›å·²ç»åœ¨springå®¹å™¨é‡Œæ³¨å†Œè¿‡çš„bean</strong></p>
<p>æˆ‘ä»¬å°†applicationContext.xmlé…ç½®æ–‡ä»¶ä½œå¦‚ä¸‹ä¿®æ”¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;context:annotation-config /&gt;</div><div class="line">&lt;bean id=<span class="string">"bBean"</span><span class="class"><span class="keyword">class</span></span>=<span class="string">"com.xxx.B"</span>/&gt;</div><div class="line">&lt;bean id=<span class="string">"cBean"</span><span class="class"><span class="keyword">class</span></span>=<span class="string">"com.xxx.C"</span>/&gt;</div><div class="line">&lt;bean id=<span class="string">"aBean"</span><span class="class"><span class="keyword">class</span></span>=<span class="string">"com.yyy.A"</span>/&gt;</div></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬åŠ è½½applicationContext.xmlé…ç½®æ–‡ä»¶ä¹‹åï¼Œå°†å¾—åˆ°ä¸‹é¢çš„ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">creating bean B: com.xxx.B@<span class="number">15663</span>a2</div><div class="line">creating bean C: com.xxx.C<span class="meta">@cd</span>5f8b</div><div class="line">creating bean A: com.yyy.A@<span class="number">157</span>aa53</div><div class="line">setting A.bbb with com.xxx.B@<span class="number">15663</span>a2</div><div class="line">setting A.ccc with com.xxx.C<span class="meta">@cd</span>5f8b</div></pre></td></tr></table></figure>
<p> ç»“æœæ­£ç¡®äº†</p>
<ul>
<li><strong>ä½¿ç”¨<code>&lt;context:component-scan&gt;</code></strong></li>
</ul>
<p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬å°†ä»£ç ä½œå¦‚ä¸‹ä¿®æ”¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.xxx;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"creating bean B: "</span> + <span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">package</span> com.xxx;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">C</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"creating bean C: "</span> + <span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">package</span> com.yyy;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</div><div class="line"><span class="keyword">import</span> com.xxx.B;</div><div class="line"><span class="keyword">import</span> com.xxx.C;</div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123; </div><div class="line">  <span class="keyword">private</span> B bbb;</div><div class="line">  <span class="keyword">private</span> C ccc;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">()</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"creating bean A: "</span> + <span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="meta">@Autowired</span> </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBbb</span><span class="params">(B bbb)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"setting A.bbb with "</span> + bbb);</div><div class="line">    <span class="keyword">this</span>.bbb = bbb;</div><div class="line">  &#125;</div><div class="line">  <span class="meta">@Autowired</span> </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCcc</span><span class="params">(C ccc)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"setting A.ccc with "</span> + ccc);</div><div class="line">    <span class="keyword">this</span>.ccc = ccc;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>applicationContext.xmlé…ç½®æ–‡ä»¶ä¿®æ”¹ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;context:annotation-config /&gt;</div></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬åŠ è½½applicationContext.xmlé…ç½®æ–‡ä»¶ä¹‹åï¼Œå´æ²¡æœ‰ä»»ä½•è¾“å‡ºï¼Œè¿™æ˜¯å› ä¸º<code>&lt;context:annotation-config /&gt;</code><strong>ä»…èƒ½å¤Ÿåœ¨å·²ç»åœ¨å·²ç»æ³¨å†Œè¿‡çš„beanä¸Šé¢èµ·ä½œç”¨</strong>ã€‚å¯¹äºæ²¡æœ‰åœ¨springå®¹å™¨ä¸­æ³¨å†Œçš„beanï¼Œå®ƒå¹¶ä¸èƒ½æ‰§è¡Œä»»ä½•æ“ä½œã€‚</p>
<p>ä½†æ˜¯ä¸ç”¨æ‹…å¿ƒï¼Œ<code>&lt;context:component-scan&gt;</code>é™¤äº†å…·æœ‰<code>&lt;context:annotation-config /&gt;</code>çš„åŠŸèƒ½ä¹‹å¤–ï¼Œè¿˜å…·æœ‰<strong>è‡ªåŠ¨å°†å¸¦æœ‰@component,@service,@Repositoryç­‰æ³¨è§£çš„å¯¹è±¡æ³¨å†Œåˆ°springå®¹å™¨ä¸­çš„åŠŸèƒ½</strong>ã€‚</p>
<p>æˆ‘ä»¬å°†applicationContext.xmlé…ç½®æ–‡ä»¶ä½œå¦‚ä¸‹ä¿®æ”¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">"com.xxx"</span>/&gt;</div></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬åŠ è½½applicationContext.xmlçš„æ—¶å€™ï¼Œä¼šå¾—åˆ°ä¸‹é¢çš„ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">creating bean B: com.xxx.B@<span class="number">1</span>be0f0a</div><div class="line">creating bean C: com.xxx.C@<span class="number">80</span>d1ff</div></pre></td></tr></table></figure>
<p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä»…ä»…æ‰«æäº†<code>com.xxx</code>åŒ…åŠå…¶å­åŒ…çš„ç±»ï¼Œè€Œclass  Aæ˜¯åœ¨<code>com.yyy</code>åŒ…ä¸‹ï¼Œæ‰€ä»¥å°±æ‰«æä¸åˆ°äº†</p>
<p>ä¸‹é¢æˆ‘ä»¬åœ¨applicationContext.xmlä¸­æŠŠ<code>com.yyy</code>ä¹ŸåŠ å…¥è¿›æ¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">"com.xxx"</span>/&gt;</div><div class="line">&lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">"com.xxx,com.yyy"</span>/&gt;</div></pre></td></tr></table></figure>
<p>ç„¶ååŠ è½½applicationContext.xmlå°±ä¼šå¾—åˆ°ä¸‹é¢çš„ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">creating bean B: com.xxx.B<span class="meta">@cd</span>5f8b</div><div class="line">creating bean C: com.xxx.C@<span class="number">15</span>ac3c9</div><div class="line">creating bean A: com.yyy.A<span class="meta">@ec</span>4a87</div><div class="line">setting A.bbb with com.xxx.B<span class="meta">@cd</span>5f8b</div><div class="line">setting A.ccc with com.xxx.C@<span class="number">15</span>ac3c9</div></pre></td></tr></table></figure>
<p>çœ‹ä¸‹applicationContext.xmlæ–‡ä»¶ï¼Œå·²ç»ç®€åŒ–ä¸ºä¸¤è¡Œ<code>context:component-scan</code>äº†.</p>
<p>å¦‚æœåœ¨applicationContext.xmlæ‰‹åŠ¨åŠ ä¸Šä¸‹é¢çš„é…ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´æ—¢åœ¨applicationContext.xmlä¸­æ‰‹åŠ¨çš„æ³¨å†Œäº†Açš„å®ä¾‹å¯¹è±¡ï¼ŒåŒæ—¶ï¼Œé€šè¿‡component-scanå»æ‰«æå¹¶æ³¨å†ŒB,Cçš„å¯¹è±¡ï¼Œå¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">"com.xxx"</span>/&gt;</div><div class="line">&lt;bean id=<span class="string">"aBean"</span><span class="class"><span class="keyword">class</span></span>=<span class="string">"com.yyy.A"</span>/&gt;</div></pre></td></tr></table></figure>
<p>ç»“æœä»æ˜¯æ­£ç¡®çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">creating bean B: com.xxx.B@<span class="number">157</span>aa53</div><div class="line">creating bean C: com.xxx.C<span class="meta">@ec</span>4a87</div><div class="line">creating bean A: com.yyy.A@<span class="number">1</span>d64c37</div><div class="line">setting A.bbb with com.xxx.B@<span class="number">157</span>aa53</div><div class="line">setting A.ccc with com.xxx.C<span class="meta">@ec</span>4a87</div></pre></td></tr></table></figure>
<p>è™½ç„¶class Aå¹¶ä¸æ˜¯é€šè¿‡æ‰«æçš„æ–¹å¼æ³¨å†Œåˆ°å®¹å™¨ä¸­çš„ ï¼Œä½†æ˜¯<code>&lt;context:component-scan&gt;</code>æ‰€äº§ç”Ÿçš„çš„å¤„ç†é‚£äº›æ³¨è§£çš„å¤„ç†å™¨å·¥å…·ï¼Œä¼šå¤„ç†æ‰€æœ‰ç»‘å®šåˆ°å®¹å™¨ä¸Šé¢çš„beanï¼Œä¸ç®¡æ˜¯é€šè¿‡xmlæ‰‹åŠ¨æ³¨å†Œçš„è¿˜æ˜¯é€šè¿‡scanningæ‰«ææ³¨å†Œçš„ã€‚ </p>
<p>é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬æ—¢é…ç½®äº†<code>&lt;context:annotation-config /&gt;</code>ï¼Œåˆé…ç½®äº†<code>&lt;context:component-scan base-package=&quot;com.xxx&quot;/&gt;</code>ï¼Œå®ƒä»¬éƒ½å…·æœ‰å¤„ç†åœ¨å®¹å™¨ä¸­æ³¨å†Œçš„beané‡Œé¢çš„æ³¨è§£çš„åŠŸèƒ½ã€‚ä¼šä¸ä¼šå‡ºç°é‡å¤æ³¨å…¥çš„æƒ…å†µå‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;context:annotation-config /&gt;</div><div class="line">&lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">"com.xxx"</span>/&gt;</div><div class="line">&lt;bean id=<span class="string">"aBean"</span><span class="class"><span class="keyword">class</span></span>=<span class="string">"com.yyy.A"</span>/&gt;</div></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">creating bean B: com.xxx.B@<span class="number">157</span>aa53</div><div class="line">creating bean C: com.xxx.C<span class="meta">@ec</span>4a87</div><div class="line">creating bean A: com.yyy.A@<span class="number">1</span>d64c37</div><div class="line">setting A.bbb with com.xxx.B@<span class="number">157</span>aa53</div><div class="line">setting A.ccc with com.xxx.C<span class="meta">@ec</span>4a87</div></pre></td></tr></table></figure>
<p>å› ä¸º<code>&lt;context:annotation-config /&gt;</code>å’Œ <code>&lt;context:component-scan&gt;</code>åŒæ—¶å­˜åœ¨çš„æ—¶å€™ï¼Œå‰è€…ä¼šè¢«å¿½ç•¥ã€‚</p>
<p>ä¹Ÿå°±æ˜¯é‚£äº›@autowireï¼Œ@resourceç­‰æ³¨å…¥æ³¨è§£åªä¼šè¢«æ³¨å…¥ä¸€æ¬¡</p>
<p>å“ªæ€•æ˜¯æ‰‹åŠ¨çš„æ³¨å†Œäº†å¤šä¸ªå¤„ç†å™¨ï¼Œspringä»ç„¶åªä¼šå¤„ç†ä¸€æ¬¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;context:annotation-config /&gt;</div><div class="line">&lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">"com.xxx"</span> /&gt;</div><div class="line">&lt;bean id=<span class="string">"aBean"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"com.yyy.A"</span> /&gt;</div><div class="line">&lt;bean id=<span class="string">"bla"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor"</span> /&gt;</div><div class="line">&lt;bean id=<span class="string">"bla1"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor"</span> /&gt;</div><div class="line">&lt;bean id=<span class="string">"bla2"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor"</span> /&gt;</div><div class="line">&lt;bean id=<span class="string">"bla3"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor"</span> /&gt;</div></pre></td></tr></table></figure>
<p>ç»“æœä»æ˜¯æ­£ç¡®çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">creating bean B: com.xxx.B@<span class="number">157</span>aa53</div><div class="line">creating bean C: com.xxx.C<span class="meta">@ec</span>4a87</div><div class="line">creating bean A: com.yyy.A@<span class="number">25</span>d2b2</div><div class="line">setting A.bbb with com.xxx.B@<span class="number">157</span>aa53</div><div class="line">setting A.ccc with com.xxx.C<span class="meta">@ec</span>4a87</div></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[context:annotation-config ä½œç”¨]]></title>
      <url>http://zsr.github.io/2016/09/21/context-annotation-config-%E4%BD%9C%E7%94%A8/</url>
      <content type="html"><![CDATA[<p>åœ¨åŸºäºæ³¨è§£æ–¹å¼é…ç½®Springçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯èƒ½ä¼šè§åˆ°<code>&lt;context:annotation-config/&gt;</code>è¿™æ ·ä¸€æ¡é…ç½®ï¼Œä»–çš„ä½œç”¨æ˜¯éšå¼åœ°å‘ Spring å®¹å™¨æ³¨å†Œ</p>
<ul>
<li>AutowiredAnnotationBeanPostProcessor</li>
<li>CommonAnnotationBeanPostProcessor</li>
<li>PersistenceAnnotationBeanPostProcessor</li>
<li>RequiredAnnotationBeanPostProcessor è¿™ 4 ä¸ªBeanPostProcessorã€‚</li>
</ul>
<p>æ³¨å†Œè¿™4ä¸ªBeanPostProcessorçš„ä½œç”¨ï¼Œå°±æ˜¯ä¸ºäº†ä½ çš„ç³»ç»Ÿèƒ½å¤Ÿè¯†åˆ«ç›¸åº”çš„æ³¨è§£ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<ol>
<li>å¦‚æœä½ æƒ³ä½¿ç”¨<code>@Autowired</code>æ³¨è§£ï¼Œé‚£ä¹ˆå°±å¿…é¡»äº‹å…ˆåœ¨ Spring å®¹å™¨ä¸­å£°æ˜ <code>AutowiredAnnotationBeanPostProcessor</code>Beanã€‚ä¼ ç»Ÿå£°æ˜æ–¹å¼å¦‚ä¸‹</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;beanÂ <span class="class"><span class="keyword">class</span></span>=<span class="string">"org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessorÂ "</span>/&gt;</div></pre></td></tr></table></figure>
<ol>
<li>å¦‚æœæƒ³ä½¿ç”¨@ Resource ã€@ PostConstructã€@ PreDestroyç­‰æ³¨è§£å°±å¿…é¡»å£°æ˜CommonAnnotationBeanPostProcessor</li>
<li>å¦‚æœæƒ³ä½¿ç”¨@PersistenceContextæ³¨è§£ï¼Œå°±å¿…é¡»å£°æ˜PersistenceAnnotationBeanPostProcessorçš„Beanã€‚</li>
<li>å¦‚æœæƒ³ä½¿ç”¨ @Requiredçš„æ³¨è§£ï¼Œå°±å¿…é¡»å£°æ˜RequiredAnnotationBeanPostProcessorçš„Beanã€‚åŒæ ·ï¼Œä¼ ç»Ÿçš„å£°æ˜æ–¹å¼å¦‚ä¸‹ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;beanÂ <span class="class"><span class="keyword">class</span></span>=<span class="string">"org.springframework.beans.factory.annotation.RequiredAnnotationBeanPostProcessor"</span>/&gt;</div></pre></td></tr></table></figure>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œè¿™äº›æ³¨è§£æˆ‘ä»¬è¿˜æ˜¯æ¯”è¾ƒå¸¸ç”¨ï¼Œå°¤å…¶æ˜¯<code>@Autowired</code>çš„æ³¨è§£ï¼Œåœ¨è‡ªåŠ¨æ³¨å…¥çš„æ—¶å€™æ›´æ˜¯ç»å¸¸ä½¿ç”¨ï¼Œæ‰€ä»¥å¦‚æœæ€»æ˜¯éœ€è¦æŒ‰ç…§ä¼ ç»Ÿçš„æ–¹å¼ä¸€æ¡ä¸€æ¡é…ç½®æ˜¾å¾—æœ‰äº›ç¹çå’Œæ²¡æœ‰å¿…è¦ï¼Œäºæ˜¯springç»™æˆ‘ä»¬æä¾›<code>&lt;context:annotation-config/&gt;</code>çš„ç®€åŒ–é…ç½®æ–¹å¼ï¼Œè‡ªåŠ¨å¸®ä½ å®Œæˆå£°æ˜ã€‚</p>
<p>ä¸è¿‡ï¼Œæˆ‘ä»¬ä½¿ç”¨æ³¨è§£ä¸€èˆ¬éƒ½ä¼šé…ç½®æ‰«æåŒ…è·¯å¾„é€‰é¡¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;context:component-scanÂ base-<span class="keyword">package</span>=<span class="string">"XX.XX"</span>/&gt;</div></pre></td></tr></table></figure>
<p>è¯¥é…ç½®é¡¹å…¶å®ä¹ŸåŒ…å«äº†è‡ªåŠ¨æ³¨å…¥ä¸Šè¿°processorçš„åŠŸèƒ½ï¼Œå› æ­¤å½“ä½¿ç”¨<code>&lt;context:component-scan/&gt;</code>åï¼Œå°±å¯ä»¥å°† <code>&lt;context:annotation-config/&gt;</code>ç§»é™¤äº†ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Springçš„@Autowiredæ³¨å…¥è§„åˆ™]]></title>
      <url>http://zsr.github.io/2016/09/21/spring-Autowired/</url>
      <content type="html"><![CDATA[<p>Spring 2.5å¼•å…¥äº†<code>@Autowired</code>æ³¨è§£ï¼Œå®ƒå¯ä»¥å¯¹ç±»æˆå‘˜å˜é‡ã€æ–¹æ³•åŠæ„é€ å‡½æ•°è¿›è¡Œæ ‡æ³¨ï¼Œå®Œæˆè‡ªåŠ¨è£…é…çš„å·¥ä½œã€‚é€šè¿‡<code>@Autowired</code>çš„ä½¿ç”¨æ¥æ¶ˆé™¤setï¼Œgetæ–¹æ³•ã€‚</p>
<p><code>@Autowired</code>é»˜è®¤æ˜¯æŒ‰ç…§byTypeè¿›è¡Œæ³¨å…¥çš„ï¼Œä½†æ˜¯å½“byTypeæ–¹å¼æ‰¾åˆ°äº†å¤šä¸ªç¬¦åˆçš„beanï¼Œåˆæ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿ</p>
<p><strong>Autowiredé»˜è®¤å…ˆæŒ‰byTypeï¼Œå¦‚æœå‘ç°æ‰¾åˆ°å¤šä¸ªbeanï¼Œåˆ™ï¼ŒåˆæŒ‰ç…§byNameæ–¹å¼æ¯”å¯¹ï¼Œå¦‚æœè¿˜æœ‰å¤šä¸ªï¼Œåˆ™æŠ¥å‡ºå¼‚å¸¸</strong>ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Autowired</span></div><div class="line"><span class="keyword">private</span> ExamUserMapper examUserMapper;Â  - ExamUserMapperæ˜¯ä¸€ä¸ªæ¥å£</div></pre></td></tr></table></figure>
<ul>
<li>springå…ˆæ‰¾ç±»å‹ä¸ºExamUserMapperçš„bean</li>
<li>å¦‚æœå­˜åœ¨ä¸”å”¯ä¸€ï¼Œåˆ™OKï¼›</li>
<li>å¦‚æœä¸å”¯ä¸€ï¼Œåœ¨ç»“æœé›†é‡Œï¼Œå¯»æ‰¾nameä¸ºexamUserMapperçš„beanã€‚å› ä¸ºbeançš„nameæœ‰å”¯ä¸€æ€§ï¼Œæ‰€ä»¥ï¼Œåˆ°è¿™é‡Œåº”è¯¥èƒ½ç¡®å®šæ˜¯å¦å­˜åœ¨æ»¡è¶³è¦æ±‚çš„beanäº†</li>
</ul>
<p><code>@Autowiredä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šæŒ‰ç…§byNameæ–¹å¼æ³¨å…¥ï¼Œä½¿ç”¨@Qualifieræ ‡ç­¾ï¼Œä¾‹å¦‚ï¼š</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Autowired</span></div><div class="line"><span class="meta">@Qualifier</span>Â (Â <span class="string">"baseDao"</span>Â )</div></pre></td></tr></table></figure>
<p>å› ä¸ºbeançš„nameå…·æœ‰å”¯ä¸€æ€§ï¼Œç†è®ºä¸Šæ˜¯byNameä¼šå¿«ä¸€ç‚¹ï¼Œä½†springé»˜è®¤ä½¿ç”¨byTypeçš„æ–¹å¼æ³¨å…¥</p>
<p>è¦ä½¿ç”¨@Autowiredå®ç°è¦ç²¾ç®€ç¨‹åºçš„ç›®çš„ï¼Œéœ€è¦è¿™æ ·æ¥å¤„ç†ï¼š </p>
<p>åœ¨applicationContext.xmlä¸­åŠ å…¥ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;!-- è¯¥ BeanPostProcessor å°†è‡ªåŠ¨å¯¹æ ‡æ³¨ <span class="meta">@Autowired</span> çš„ Bean è¿›è¡Œæ³¨å…¥ --&gt;Â Â Â </div><div class="line">&lt;bean <span class="class"><span class="keyword">class</span></span>=<span class="string">"org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor"</span>/&gt;</div></pre></td></tr></table></figure>
<p>Springé€šè¿‡ä¸€ä¸ªBeanPostProcessorå¯¹@Autowiredè¿›è¡Œè§£æï¼Œæ‰€ä»¥è¦è®©@Autowiredèµ·ä½œç”¨å¿…é¡»äº‹å…ˆåœ¨Springå®¹å™¨ä¸­å£°æ˜<code>AutowiredAnnotationBeanPostProcessor</code> Beanã€‚   </p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Comparable å’Œ Comparatoræ¯”è¾ƒ]]></title>
      <url>http://zsr.github.io/2016/09/20/Comparable%E5%92%8CComparator%E6%AF%94%E8%BE%83/</url>
      <content type="html"><![CDATA[<p>æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥è¿›è¡Œé›†åˆæ’åº ï¼š</p>
<ul>
<li>é›†åˆä¸­å¯¹è±¡çš„æ‰€å±ç±»å®ç°äº† java.lang.Comparable æ¥å£</li>
<li>ç»™é›†åˆæŒ‡å®šæ¯”è¾ƒå™¨ java.lang.Comparator çš„å®ç°ç±»</li>
</ul>
<h3 id="1-java-lang-Comparable"><a href="#1-java-lang-Comparable" class="headerlink" title="1. java.lang.Comparable"></a><strong>1. java.lang.Comparable</strong></h3><p>public interface Comparable æ¥å£å¼ºè¡Œå¯¹å®ç°å®ƒçš„æ¯ä¸ªç±»çš„å¯¹è±¡è¿›è¡Œæ•´ä½“æ’åºã€‚ â€“ è‡ªç„¶æ’åºã€‚ç±»çš„compareToç§°ä¸ºè‡ªç„¶æ¯”è¾ƒæ–¹æ³•ã€‚</p>
<p><strong>æ¥å£çš„ä½œç”¨</strong></p>
<p>è‹¥ä¸€ä¸ªç±»å®ç°äº†Comparable æ¥å£ï¼Œå®ç° Comparable æ¥å£çš„ç±»å¯¹è±¡çš„ List åˆ—è¡¨ ( æˆ–æ•°ç»„)å¯ä»¥é€šè¿‡ Collections.sortï¼ˆæˆ– Arrays.sortï¼‰è¿›è¡Œæ’åºã€‚</p>
<p>æ­¤å¤–ï¼Œå®ç° Comparable æ¥å£çš„ç±»çš„å¯¹è±¡ å¯ä»¥ç”¨ä½œ â€œæœ‰åºæ˜ å°„ ( å¦‚ TreeMap)â€ ä¸­çš„é”®æˆ– â€œæœ‰åºé›†åˆ (TreeSet)â€ ä¸­çš„å…ƒç´ ï¼Œè€Œä¸éœ€è¦æŒ‡å®šæ¯”è¾ƒå™¨ã€‚</p>
<p><strong>å®ç°çš„æ–¹å¼</strong></p>
<p>åˆ©ç”¨Comparableæ¥å£åˆ›å»ºè‡ªå·±çš„ç±»çš„æ’åºé¡ºåºï¼Œåªæ˜¯å®ç°comparaToæ–¹æ³•çš„é—®é¢˜ã€‚<br>é€šå¸¸å°±æ˜¯ä¾èµ–å‡ ä¸ªæ•°æ®æˆå‘˜çš„è‡ªç„¶æ’åºã€‚åŒæ—¶ç±»ä¹Ÿåº”è¯¥è¦†ç›–equals()å’ŒhashCode() ä»¥ç¡®ä¿ä¸¤ä¸ªç›¸ç­‰çš„å¯¹è±¡è¿”å›åŒä¸€ä¸ªå“ˆå¸Œç ã€‚</p>
<p>Comparableæ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼ŒcompareTo(Object obj),å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Comparable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(T o)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€šå¸¸éœ€è¦è¦†å†™ compareTo æ–¹æ³•å®ç°æ’åºè§„åˆ™çš„åº”ç”¨ ï¼š<strong>int compareTo(Object o): æ¯”è¾ƒå½“å‰å®ä¾‹å¯¹è±¡ä¸å¯¹è±¡ o ï¼Œå¦‚æœä½äºå¯¹è±¡ o ä¹‹å‰ï¼Œè¿”å›è´Ÿå€¼ï¼Œå¦‚æœä¸¤ä¸ªå¯¹è±¡åœ¨æ’åºä¸­ä½ç½®ç›¸åŒï¼Œåˆ™è¿”å› 0 ï¼Œå¦‚æœä½äºå¯¹è±¡ o åé¢ï¼Œåˆ™è¿”å›æ­£å€¼.</strong></p>
<p>ä¸‹è¡¨å±•ç¤ºäº†å‡ ç§åŸºæœ¬ç±»å‹çš„è‡ªç„¶æ’åºã€‚è™½ç„¶ä¸€äº›ç±»å…±äº«åŒä¸€ç§è‡ªç„¶æ’åºï¼Œä½†åªæœ‰ç›¸äº’å¯æ¯”çš„ç±»æ‰èƒ½æ’åºã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">ç±»</th>
<th style="text-align:center">æ’åº(è¶Šå¤§æ’åœ¨åé¢)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Integer</td>
<td style="text-align:center">æŒ‰æ•°å­—å¤§å°æ’åº</td>
</tr>
<tr>
<td style="text-align:center">Long</td>
<td style="text-align:center">æŒ‰æ•°å­—å¤§å°æ’åº</td>
</tr>
<tr>
<td style="text-align:center">Byte</td>
<td style="text-align:center">æŒ‰æ•°å­—å¤§å°æ’åº</td>
</tr>
<tr>
<td style="text-align:center">Double</td>
<td style="text-align:center">æŒ‰æ•°å­—å¤§å°æ’åº</td>
</tr>
<tr>
<td style="text-align:center">Character</td>
<td style="text-align:center">æŒ‰ <code>Unicode</code> å€¼çš„æ•°å­—å¤§å°æ’åº</td>
</tr>
<tr>
<td style="text-align:center">String</td>
<td style="text-align:center">æŒ‰å­—ç¬¦ä¸²ä¸­å­—ç¬¦ <code>Unicode</code> å€¼æ’åº</td>
</tr>
</tbody>
</table>
<p>ä¸¾ä¸ªä¾‹å­ï¼šä¸€ç§å•†å“(å•†å“åï¼Œé”€å”®é‡ï¼Œç”Ÿäº§æ—¥æœŸ)ï¼Œæ ¹æ®<strong>ç”Ÿäº§æ—¥æœŸé™åº é”€å”®é‡å‡åº å•†å“åç§°é™åº</strong></p>
<p><strong>æ€è·¯ï¼šé¦–å…ˆæŒ‰ç…§æ—¥æœŸé™åºï¼Œå¦‚æœæ—¥æœŸç›¸åŒ æŒ‰ç…§é”€å”®é‡å‡åºï¼Œå¦‚æœé”€å”®é‡ç›¸åŒï¼ŒæŒ‰å‘¨å•†å“çš„åç§°é™åº</strong></p>
<ul>
<li><strong>åˆ›å»ºéœ€è¦æ¯”è¾ƒçš„å¯¹è±¡çš„java bean</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComparableExample</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">ComparableExample</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> String title; <span class="comment">// åç§°</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> hits; <span class="comment">// é”€å”®é‡</span></div><div class="line">  <span class="keyword">private</span> Date pubTime; <span class="comment">// æ—¥æœŸ</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ComparableExample</span><span class="params">()</span> </span>&#123;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ComparableExample</span><span class="params">(String title, <span class="keyword">int</span> hits, Date pubTime)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>();</div><div class="line">    <span class="keyword">this</span>.title = title;</div><div class="line">    <span class="keyword">this</span>.hits = hits;</div><div class="line">    <span class="keyword">this</span>.pubTime = pubTime;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getTitle</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> title;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTitle</span><span class="params">(String title)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.title = title;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHits</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> hits;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHits</span><span class="params">(<span class="keyword">int</span> hits)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.hits = hits;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Date <span class="title">getPubTime</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pubTime;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPubTime</span><span class="params">(Date pubTime)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.pubTime = pubTime;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// æ—¶é—´é™åº(è¶Šå¤§æ’åœ¨å‰é¢) ç‚¹å‡»é‡å‡åº(è¶Šå¤§æ’åœ¨åé¢) æ ‡é¢˜é™åº</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(ComparableExample o)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">    <span class="comment">// æŒ‰ç…§ç”Ÿäº§æ—¶é—´é™åº</span></div><div class="line">    result = -<span class="keyword">this</span>.pubTime.compareTo(o.pubTime);</div><div class="line">    <span class="keyword">if</span> (<span class="number">0</span> == result) &#123;<span class="comment">// å¦‚æœç”Ÿäº§æ—¶é—´ç›¸åŒ å°±æŒ‰ç…§é”€å”®é‡å‡åºæ’åˆ—</span></div><div class="line">      result = <span class="keyword">this</span>.hits - o.hits;</div><div class="line">      <span class="keyword">if</span> (<span class="number">0</span> == result) &#123;<span class="comment">// å¦‚æœé”€å”®é‡ç›¸åŒ æŒ‰ç…§åå­—é™åºæ’åˆ—</span></div><div class="line">        result = -<span class="keyword">this</span>.title.compareTo(o.title);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">    sb.append(<span class="string">"å•†å“åç§°"</span>).append(<span class="keyword">this</span>.title);</div><div class="line">    sb.append(<span class="string">"é”€å”®é‡"</span>).append(<span class="keyword">this</span>.hits);</div><div class="line">    sb.append(<span class="string">"ç”Ÿäº§æ—¶é—´"</span>).append(<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).format(<span class="keyword">this</span>.pubTime)).append(<span class="string">"\n"</span>);</div><div class="line">    <span class="keyword">return</span> sb.toString();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>æµ‹è¯•ï¼Œæ¯”è¾ƒ</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// æ—¶é—´é™åºï¼Œ é”€å”®é‡å‡åºï¼Œ æ ‡é¢˜é™åº</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">  List&lt;ComparableExample&gt; item = <span class="keyword">new</span> ArrayList&lt;ComparableExample&gt;();</div><div class="line">  item.add(<span class="keyword">new</span> ComparableExample(<span class="string">"abcitems"</span>, <span class="number">30</span>, <span class="keyword">new</span> Date(System.currentTimeMillis() - <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span>)));</div><div class="line">  item.add(<span class="keyword">new</span> ComparableExample(<span class="string">"abcfgitems"</span>, <span class="number">30</span>, <span class="keyword">new</span> Date(System.currentTimeMillis() - <span class="number">1000</span> * <span class="number">60</span> * <span class="number">50</span>)));</div><div class="line">  item.add(<span class="keyword">new</span> ComparableExample(<span class="string">"abcditems"</span>, <span class="number">100</span>, <span class="keyword">new</span> Date()));</div><div class="line">  item.add(<span class="keyword">new</span> ComparableExample(<span class="string">"abefNews"</span>, <span class="number">50</span>, <span class="keyword">new</span> Date(System.currentTimeMillis() - <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span>)));</div><div class="line">  System.out.println(<span class="string">"----------æ’åºå‰----------"</span>);</div><div class="line">  System.out.println(item);</div><div class="line">  System.out.println(<span class="string">"----------æ’åºå----------"</span>);</div><div class="line">  Collections.sort(item);</div><div class="line">  System.out.println(item);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>è¿è¡Œç»“æœ</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">----------æ’åºå‰----------</div><div class="line">[å•†å“åç§°abcitemsé”€å”®é‡30ç”Ÿäº§æ—¶é—´2016-09-20 15:04:37</div><div class="line">, å•†å“åç§°abcfgitemsé”€å”®é‡30ç”Ÿäº§æ—¶é—´2016-09-20 15:14:37</div><div class="line">, å•†å“åç§°abcditemsé”€å”®é‡100ç”Ÿäº§æ—¶é—´2016-09-20 16:04:37</div><div class="line">, å•†å“åç§°abefNewsé”€å”®é‡50ç”Ÿäº§æ—¶é—´2016-09-20 15:04:37</div><div class="line">]</div><div class="line">----------æ’åºå----------</div><div class="line">[å•†å“åç§°abcditemsé”€å”®é‡100ç”Ÿäº§æ—¶é—´2016-09-20 16:04:37</div><div class="line">, å•†å“åç§°abcfgitemsé”€å”®é‡30ç”Ÿäº§æ—¶é—´2016-09-20 15:14:37</div><div class="line">, å•†å“åç§°abcitemsé”€å”®é‡30ç”Ÿäº§æ—¶é—´2016-09-20 15:04:37</div><div class="line">, å•†å“åç§°abefNewsé”€å”®é‡50ç”Ÿäº§æ—¶é—´2016-09-20 15:04:37</div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="2-Comparator-æ¯”è¾ƒå™¨æ¥å£"><a href="#2-Comparator-æ¯”è¾ƒå™¨æ¥å£" class="headerlink" title="2. Comparator æ¯”è¾ƒå™¨æ¥å£"></a><strong>2. Comparator æ¯”è¾ƒå™¨æ¥å£</strong></h3><p>å¦‚æœéœ€è¦æ§åˆ¶æŸä¸ªç±»çš„æ¬¡åºï¼Œè€Œ<strong>è¯¥ç±»æœ¬èº«ä¸æ”¯æŒæ’åº</strong>ï¼ˆå³æ²¡æœ‰å®ç°Comparableæ¥å£ï¼‰ï¼›é‚£ä¹ˆå¯ä»¥å»ºç«‹ä¸€ä¸ªè¯¥ç±»çš„æ¯”è¾ƒå™¨æ¥æ’åºï¼Œè¿™ä¸ªæ¯”è¾ƒå™¨åªéœ€è¦å®ç°Comparatoræ¥å£å³å¯ã€‚ æ¢å¥è¯è¯´, <strong>é€šè¿‡å®ç°Comparatorç±»æ¥æ–°å»ºä¸€ä¸ªæ¯”è¾ƒå™¨ï¼Œç„¶åé€šè¿‡è¯¥æ¯”è¾ƒå™¨æ¥å¯¹ç±»è¿›è¡Œæ’åº</strong>ã€‚Comparator æ¥å£å…¶å®å°±æ˜¯ä¸€ç§ç­–ç•¥æ¨¡å¼çš„å®è·µ</p>
<p><strong>æ¥å£ä½œç”¨</strong></p>
<ol>
<li>å¦‚æœä¸€ä¸ªç±»å·²ç»å¼€æ”¾å®Œæˆï¼Œä½†æ˜¯åœ¨æ­¤ç±»å»ºç«‹çš„åˆæœŸå¹¶æ²¡æœ‰å®ç° Comparable æ¥å£ï¼Œæ­¤æ—¶è‚¯å®šæ˜¯æ— æ³•è¿›è¡Œå¯¹è±¡æ’åºæ“ä½œçš„ï¼Œæ‰€ä»¥ä¸ºäº†è§£å†³è¿™ä¸€çš„é—®é¢˜ï¼Œjava åˆå®šä¹‰äº†å¦ä¸€ä¸ªæ¯”è¾ƒå™¨çš„æ“ä½œæ¥å£ Comparator æ­¤æ¥å£å®šä¹‰åœ¨ java.util åŒ…ä¸­</li>
<li>ä¸ºäº†ä½¿ç”¨ä¸åŒçš„æ’åºæ ‡å‡†åšå‡†å¤‡ï¼Œæ¯”å¦‚å‡åºï¼Œé™åºæˆ–è€…å…¶ä»–ä»€ä¹ˆåºåˆ—</li>
</ol>
<p>æ¥å£ä»…ä»…åŒ…æ‹¬ä¸¤ä¸ªå‡½æ•°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Comparator</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">compare</span><span class="params">(T o1, T o2)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>è‹¥ä¸€ä¸ªç±»è¦å®ç°Comparatoræ¥å£ï¼šå®ƒä¸€å®šè¦å®ç°compare(T o1ï¼Œ T o2)å‡½æ•°ï¼Œ<strong>ä½†æ˜¯å¯ä»¥ä¸å®ç°equalså‡½æ•°ã€‚ å› ä¸ºä»»ä½•ç±»ï¼Œé»˜è®¤éƒ½æ˜¯å·²ç»å®ç°äº† equals(Object obj) </strong>ã€‚ Java ä¸­çš„ä¸€åˆ‡ç±»éƒ½æ˜¯ç»§æ‰¿äº java.lang.Objectï¼Œåœ¨ Object.java ä¸­å®ç°äº† equals(Object obj) å‡½æ•°ï¼›æ‰€ä»¥ï¼Œå…¶å®ƒæ‰€æœ‰çš„ç±»ä¹Ÿç›¸å½“äºéƒ½å®ç°äº†è¯¥å‡½æ•°ã€‚</li>
<li>int compare(T o1, T o2) æ˜¯ â€œæ¯”è¾ƒ o1 å’Œ o2 çš„å¤§å°â€ã€‚è¿”å› â€œè´Ÿæ•°â€ï¼Œæ„å‘³ç€ â€œo1 æ¯” o2 å°â€ï¼›è¿”å› â€œé›¶â€ï¼Œæ„å‘³ç€ â€œo1 ç­‰äº o2â€ï¼›è¿”å› â€œæ­£æ•°â€ï¼Œæ„å‘³ç€ â€œo1 å¤§äº o2â€ã€‚</li>
</ol>
<p>æ¯”å¦‚ å•†å“,æˆ‘éœ€è¦æŒ‰ç…§ä»·æ ¼çš„é™åºæ’åˆ—,ä»£ç å¦‚ä¸‹:</p>
<ul>
<li><strong>å•†å“ç±»</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.compare;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> String title;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> price;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Product</span><span class="params">()</span> </span>&#123;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Product</span><span class="params">(String title, <span class="keyword">int</span> price)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>();</div><div class="line">    <span class="keyword">this</span>.title = title;</div><div class="line">    <span class="keyword">this</span>.price = price;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getTitle</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> title;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTitle</span><span class="params">(String title)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.title = title;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> price;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrice</span><span class="params">(<span class="keyword">int</span> price)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.price = price;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"title="</span> + title + <span class="string">",price="</span> + price + <span class="string">"\n"</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>å®šä¹‰æ¯”è¾ƒè§„åˆ™:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.compare;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Comparator;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductCompare</span> <span class="keyword">implements</span> <span class="title">Comparator</span>&lt;<span class="title">Product</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Product o1, Product o2)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> -(o1.getPrice() - o2.getPrice() &gt; <span class="number">0</span> ? <span class="number">1</span> : (o1.getPrice() == o2.getPrice() ? <span class="number">0</span> : -<span class="number">1</span>));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>æµ‹è¯•, æ¯”è¾ƒ</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    List&lt;Product&gt; product = <span class="keyword">new</span> ArrayList&lt;Product&gt;();</div><div class="line">    product.add(<span class="keyword">new</span> Product(<span class="string">"a"</span>, <span class="number">120</span>));</div><div class="line">    product.add(<span class="keyword">new</span> Product(<span class="string">"b"</span>, <span class="number">143432</span>));</div><div class="line">    product.add(<span class="keyword">new</span> Product(<span class="string">"c"</span>, <span class="number">1892</span>));</div><div class="line">    product.add(<span class="keyword">new</span> Product(<span class="string">"d"</span>, <span class="number">11092</span>));</div><div class="line">    Collections.sort(product, <span class="keyword">new</span> ProductCompare());</div><div class="line">    System.out.println(product);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>è¿è¡Œç»“æœ</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[title=b,price=143432</div><div class="line">, title=d,price=11092</div><div class="line">, title=c,price=1892</div><div class="line">, title=a,price=120</div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="3-Comparable-å’Œ-Comparatoræ¯”è¾ƒ"><a href="#3-Comparable-å’Œ-Comparatoræ¯”è¾ƒ" class="headerlink" title="3. Comparable å’Œ Comparatoræ¯”è¾ƒ"></a><strong>3. Comparable å’Œ Comparatoræ¯”è¾ƒ</strong></h3><p>Comparable æ˜¯æ’åºæ¥å£ï¼›è‹¥ä¸€ä¸ªç±»å®ç°äº† Comparable æ¥å£ï¼Œå°±æ„å‘³ç€ â€œè¯¥ç±»æ”¯æŒæ’åºâ€ã€‚ è€Œ Comparator æ˜¯æ¯”è¾ƒå™¨ï¼›æˆ‘ä»¬è‹¥éœ€è¦æ§åˆ¶æŸä¸ªç±»çš„æ¬¡åºï¼Œå¯ä»¥å»ºç«‹ä¸€ä¸ª â€œè¯¥ç±»çš„æ¯”è¾ƒå™¨â€ æ¥è¿›è¡Œæ’åºã€‚</p>
<p>å‰è€…åº”è¯¥æ¯”è¾ƒå›ºå®šï¼Œå’Œä¸€ä¸ªå…·ä½“ç±»ç›¸ç»‘å®šï¼Œè€Œåè€…æ¯”è¾ƒçµæ´»ï¼Œå®ƒå¯ä»¥è¢«ç”¨äºå„ä¸ªéœ€è¦æ¯”è¾ƒåŠŸèƒ½çš„ç±»ä½¿ç”¨ã€‚å¯ä»¥è¯´å‰è€…å±äº â€œé™æ€ç»‘å®šâ€ï¼Œè€Œåè€…å¯ä»¥ â€œåŠ¨æ€ç»‘å®šâ€ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[mvc:annotation-driven]]></title>
      <url>http://zsr.github.io/2016/09/13/mvc-annotation-driven/</url>
      <content type="html"><![CDATA[<p><strong><code>&lt;mvc:annotation-driven /&gt;</code>è¿™ä¸ªæ ‡ç­¾æ³¨å†Œäº†Spring MVCåˆ†å‘è¯·æ±‚åˆ°Controlleræ§åˆ¶å™¨æ‰€å¿…é¡»çš„HandlerMappingå’ŒHandlerAdapterå®ä¾‹ã€‚</strong></p>
<p><strong>Spring 3.1 ä¹‹å‰:</strong></p>
<ol>
<li>DefaultAnnotationHandlerMapping</li>
<li>AnnotationMethodHandlerAdapter</li>
<li>AnnotationMethodHandlerExceptionResolver</li>
</ol>
<p><strong>Spring 3.1+ ï¼š</strong></p>
<ol>
<li>RequestMappingHandlerMapping</li>
<li>RequestMappingHandlerAdapter</li>
<li>ExceptionHandlerExceptionResolver  </li>
</ol>
<p><code>DefaultAnnotationHandlerMapping</code> æ ¹æ®urlå†³å®šä½¿ç”¨å“ªä¸ª<code>controller</code>ï¼Œ<code>AnnotationMethodHandlerAdapter</code> é€‰æ‹©å¤„ç†è¯·æ±‚çš„å®é™…æ–¹æ³•ã€‚<code>RequestMappingHandlerMapping</code>åŒ…æ¶µä¸Šé¢2ä¸ªä½œç”¨ï¼Œæ‰€ä»¥å°†è¯·æ±‚ç›´æ¥æ˜ å°„åˆ°æ–¹æ³•ã€‚</p>
<a id="more"></a>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p><code>DispatcherServlet</code>åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ä¸€ä¸ªæ–¹æ³•å¦‚ä¸‹ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initStrategies</span><span class="params">(ApplicationContext context)</span> </span>&#123;  </div><div class="line">        initMultipartResolver(context);  </div><div class="line">        initLocaleResolver(context);  </div><div class="line">        initThemeResolver(context);  </div><div class="line">        <span class="comment">//åˆå§‹åŒ–ä¸€äº›HandlerMapping  </span></div><div class="line">        initHandlerMappings(context);  </div><div class="line">        <span class="comment">//åˆå§‹åŒ–ä¸€äº›HandlerAdapter  </span></div><div class="line">        initHandlerAdapters(context);  </div><div class="line">        initHandlerExceptionResolvers(context);  </div><div class="line">        initRequestToViewNameTranslator(context);  </div><div class="line">        initViewResolvers(context);  </div><div class="line">        initFlashMapManager(context);  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å®ƒä¼šåˆå§‹åŒ–ä¸€äº›<code>HandlerMapping</code>å’Œ<code>HandlerAdapter</code>ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éå¸¸é‡è¦</p>
<ul>
<li>åˆå§‹åŒ–<code>HandlerMapping</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initHandlerMappings</span><span class="params">(ApplicationContext context)</span> </span>&#123;  </div><div class="line">        <span class="keyword">this</span>.handlerMappings = <span class="keyword">null</span>;  </div><div class="line">  </div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.detectAllHandlerMappings) &#123;  </div><div class="line">            <span class="comment">// Find all HandlerMappings in the ApplicationContext, including ancestor contexts.  </span></div><div class="line">            Map&lt;String, HandlerMapping&gt; matchingBeans =  </div><div class="line">                    BeanFactoryUtils.beansOfTypeIncludingAncestors(context, HandlerMapping.class, <span class="keyword">true</span>, <span class="keyword">false</span>);  </div><div class="line">            <span class="keyword">if</span> (!matchingBeans.isEmpty()) &#123;  </div><div class="line">                <span class="keyword">this</span>.handlerMappings = <span class="keyword">new</span> ArrayList&lt;HandlerMapping&gt;(matchingBeans.values());  </div><div class="line">                <span class="comment">// We keep HandlerMappings in sorted order.  </span></div><div class="line">                OrderComparator.sort(<span class="keyword">this</span>.handlerMappings);  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">else</span> &#123;  </div><div class="line">            <span class="keyword">try</span> &#123;  </div><div class="line">                HandlerMapping hm = context.getBean(HANDLER_MAPPING_BEAN_NAME, HandlerMapping.class);  </div><div class="line">                <span class="keyword">this</span>.handlerMappings = Collections.singletonList(hm);  </div><div class="line">            &#125;  </div><div class="line">            <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;  </div><div class="line">                <span class="comment">// Ignore, we'll add a default HandlerMapping later.  </span></div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="comment">// Ensure we have at least one HandlerMapping, by registering  </span></div><div class="line">        <span class="comment">// a default HandlerMapping if no other mappings are found.  </span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.handlerMappings == <span class="keyword">null</span>) &#123;  </div><div class="line">            <span class="keyword">this</span>.handlerMappings = getDefaultStrategies(context, HandlerMapping.class);  </div><div class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;  </div><div class="line">                logger.debug(<span class="string">"No HandlerMappings found in servlet '"</span> + getServletName() + <span class="string">"': using default"</span>);  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><code>detectAllHandlerMappings</code>æ˜¯<code>DispatcherServlet</code>çš„ä¸€ä¸ªå±æ€§ï¼Œå¯ä»¥åœ¨<code>web.xml</code>ä¸­é…ç½®ï¼Œ<strong>é»˜è®¤æ˜¯true</strong>ï¼Œå¦‚æœä¸ºtrue,åˆ™ä¼šå»ä»æœ¬å·¥ç¨‹<code>mvc-servlet.xml</code>æ–‡ä»¶ä¸­å»æ¢æµ‹æ‰€æœ‰å®ç°äº†<code>HandlerMapping</code>çš„beanï¼Œå¦‚æœæœ‰ï¼Œåˆ™åŠ å…¥<code>DispatcherServlet</code>çš„<code>handlerMappings</code>ä¸­ã€‚å¦‚æœ<code>detectAllHandlerMappings</code>ä¸ºfalse,åˆ™ç›´æ¥å»å®¹å™¨ä¸­æ‰¾<code>id=&quot;handlerMapping&quot;</code>ä¸”å®ç°äº†<code>HandlerMapping</code>çš„bean.å¦‚æœä»¥ä¸Šéƒ½æ²¡æ‰¾åˆ°ï¼Œåˆ™ä¼šå»åŠ è½½é»˜è®¤çš„<code>HandlerMapping</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Detect all HandlerMappings or just expect "handlerMapping" bean? */</span>  </div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> detectAllHandlerMappings = <span class="keyword">true</span>;</div></pre></td></tr></table></figure>
<p>å¦‚æœæ²¡æœ‰é…ç½®<code>HandlerMapping</code>,æ‰€ä»¥å®ƒä¼šå»åŠ è½½é»˜è®¤çš„ï¼Œé»˜è®¤çš„é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">getDefaultStrategies</span><span class="params">(ApplicationContext context, Class&lt;T&gt; strategyInterface)</span> </span>&#123;  </div><div class="line">        String key = strategyInterface.getName();  </div><div class="line">        <span class="comment">//defaultStrategieså­˜å‚¨äº†é»˜è®¤çš„é…ç½®  </span></div><div class="line">        String value = defaultStrategies.getProperty(key);  </div><div class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;  </div><div class="line">            String[] classNames = StringUtils.commaDelimitedListToStringArray(value);  </div><div class="line">            List&lt;T&gt; strategies = <span class="keyword">new</span> ArrayList&lt;T&gt;(classNames.length);  </div><div class="line">            <span class="keyword">for</span> (String className : classNames) &#123;  </div><div class="line">                <span class="keyword">try</span> &#123;  </div><div class="line">                    Class&lt;?&gt; clazz = ClassUtils.forName(className, DispatcherServlet.class.getClassLoader());  </div><div class="line">                    Object strategy = createDefaultStrategy(context, clazz);  </div><div class="line">                    strategies.add((T) strategy);  </div><div class="line">                &#125;  </div><div class="line">                <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;  </div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(  </div><div class="line">                            <span class="string">"Could not find DispatcherServlet's default strategy class ["</span> + className +  </div><div class="line">                                    <span class="string">"] for interface ["</span> + key + <span class="string">"]"</span>, ex);  </div><div class="line">                &#125;  </div><div class="line">                <span class="keyword">catch</span> (LinkageError err) &#123;  </div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(  </div><div class="line">                            <span class="string">"Error loading DispatcherServlet's default strategy class ["</span> + className +  </div><div class="line">                                    <span class="string">"] for interface ["</span> + key + <span class="string">"]: problem with class file or dependent class"</span>, err);  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">            <span class="keyword">return</span> strategies;  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">else</span> &#123;  </div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LinkedList&lt;T&gt;();  </div><div class="line">        &#125;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>çœ‹çœ‹<code>defaultStrategies</code>æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Properties defaultStrategies;  </div><div class="line">  </div><div class="line">    <span class="keyword">static</span> &#123;  </div><div class="line">        <span class="comment">// Load default strategy implementations from properties file.  </span></div><div class="line">        <span class="comment">// This is currently strictly internal and not meant to be customized  </span></div><div class="line">        <span class="comment">// by application developers.  </span></div><div class="line">        <span class="keyword">try</span> &#123;  </div><div class="line">            <span class="comment">//è¿™é‡Œçš„DEFAULT_STRATEGIES_PATHå°±æ˜¯DispatcherServlet.properties  </span></div><div class="line">            ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(DEFAULT_STRATEGIES_PATH, DispatcherServlet.class);  </div><div class="line">            defaultStrategies = PropertiesLoaderUtils.loadProperties(resource);  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">catch</span> (IOException ex) &#123;  </div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Could not load 'DispatcherServlet.properties': "</span> + ex.getMessage());  </div><div class="line">        &#125;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œä½¿ç”¨é™æ€ä»£ç å—æ¥åŠ è½½é…ç½®æ–‡ä»¶<code>DispatcherServlet.properties</code>ï¼Œå®ƒæ‰€åœ¨ä½ç½®å°±æ˜¯å’Œ<code>DispatcherServlet</code>åŒä¸€ç›®å½•ä¸‹é¢ã€‚é»˜è®¤çš„é…ç½®æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">#è¿™é‡Œå°±æ˜¯é»˜è®¤çš„HandlerMappingçš„é…ç½®  </div><div class="line">org.springframework.web.servlet.HandlerMapping=org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping,\  </div><div class="line">    org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping  </div><div class="line">#è¿™é‡Œå°±æ˜¯é»˜è®¤çš„HandlerAdapterçš„é…ç½®  </div><div class="line">org.springframework.web.servlet.HandlerAdapter=org.springframework.web.servlet.mvc.HttpRequestHandlerAdapter,\  </div><div class="line">    org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter,\  </div><div class="line">    org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter  </div><div class="line">  </div><div class="line">org.springframework.web.servlet.HandlerExceptionResolver=org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerExceptionResolver,\  </div><div class="line">    org.springframework.web.servlet.mvc.annotation.ResponseStatusExceptionResolver,\  </div><div class="line">    org.springframework.web.servlet.mvc.support.DefaultHandlerExceptionResolver</div></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä½ ä»€ä¹ˆéƒ½æ²¡æœ‰é…ç½®æ—¶ï¼Œé»˜è®¤ä¼šåŠ è½½ä»¥ä¸Šçš„é…ç½®</p>
<p>é»˜è®¤<code>HandlerMapping</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">BeanNameUrlHandlerMapping</div><div class="line">DefaultAnnotationHandlerMapping</div></pre></td></tr></table></figure>
<p>é»˜è®¤<code>HandlerAdapter</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HttpRequestHandlerAdapter</div><div class="line">SimpleControllerHandlerAdapter</div><div class="line">AnnotationMethodHandlerAdapter</div></pre></td></tr></table></figure>
<p>å‚è€ƒï¼š</p>
<p><a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html" target="_blank" rel="external">http://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html</a></p>
<p><a href="http://shouce.jb51.net/spring/mvc.html" target="_blank" rel="external">http://shouce.jb51.net/spring/mvc.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Spring MVC é€‚é…å™¨æ¨¡å¼]]></title>
      <url>http://zsr.github.io/2016/09/13/Spring-MVC-%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<pre><code>æ‰¾åˆ°DispatcherServletç±»ä¸­çš„`doDispatch`ä½“ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒçš„ä½œç”¨æ˜¯ç›¸å½“äºåœ¨Servletçš„ doServiceè°ƒç”¨çš„ã€‚ ä¹Ÿå°±æ˜¯ç”¨æ¥ä¼ é€’requestç»™æˆ‘ä»¬ç¼–å†™çš„Controllerå¹¶æ‰§è¡Œç›¸åº”çš„æ–¹æ³•ã€è¿”å›ModeViewå¯¹è±¡ã€‚ 

 æ‰§è¡Œçš„ä»£ç ç‰‡æ®µï¼š 
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...  </div><div class="line">HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());  </div><div class="line">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());  </div><div class="line">...</div></pre></td></tr></table></figure>
<p><code>mappedHandler.getHandler()</code>å¾—åˆ°çš„æ˜¯Controllerå¯¹è±¡<br>è€Œæ­¤å¤„å¹¶éé‡‡ç”¨ç›´æ¥ è°ƒç”¨.handlerRequestæˆ–è€…MultiActionControllerä¸­ç¼–å†™çš„è‡ªå®šä¹‰æ–¹æ³•ï¼Œè€Œé‡‡ç”¨äº†ä¸€ä¸ª<code>HandlerAdapter</code>çš„æ¥å£ã€‚ </p>
<p>æ­¤å¤„é‡‡ç”¨äº†é€‚é…å™¨æ¨¡å¼ï¼Œ ç”±äºControllerçš„ç±»å‹ä¸åŒï¼Œæœ‰å¤šé‡å®ç°æ–¹å¼ï¼Œé‚£ä¹ˆè°ƒç”¨æ–¹å¼å°±ä¸æ˜¯ç¡®å®šçš„ï¼Œå¦‚æœéœ€è¦ç›´æ¥è°ƒç”¨Controlleræ–¹æ³•ï¼Œéœ€è¦åœ¨ä»£ç ä¸­å†™æˆå¦‚ä¸‹å½¢å¼ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(mappedHandler.getHandler() <span class="keyword">instanceof</span> MultiActionController)&#123;  </div><div class="line">   ((MultiActionController)mappedHandler.getHandler()).xxx  </div><div class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(mappedHandler.getHandler() <span class="keyword">instanceof</span> XXX)&#123;  </div><div class="line">    ...  </div><div class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(...)&#123;  </div><div class="line">   ...  </div><div class="line">&#125;  </div><div class="line">...</div></pre></td></tr></table></figure>
<p>è¿™æ ·å‡è®¾å¦‚æœæˆ‘ä»¬å¢åŠ ä¸€ä¸ªHardController,å°±è¦åœ¨ä»£ç ä¸­åŠ å…¥ä¸€è¡Œ if(mappedHandler.getHandler() instanceof  HardController) , è¿™ç§å½¢å¼å°±ä½¿å¾—ç¨‹åºéš¾ä»¥ç»´æŠ¤ï¼Œä¹Ÿè¿åäº†è®¾è®¡æ¨¡å¼ä¸­çš„<code>å¼€é—­åŸåˆ™</code> â€“  å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚ </p>
<p>å› æ­¤Springå®šä¹‰äº†ä¸€ä¸ªé€‚é…æ¥å£ï¼Œä½¿å¾—æ¯ä¸€ç§Controlleræœ‰ä¸€ç§å¯¹åº”çš„é€‚é…å™¨å®ç°ç±»ï¼Œ è®©é€‚é…å™¨ä»£æ›¿controlleræ‰§è¡Œç›¸åº”çš„æ–¹æ³•ã€‚è¿™æ ·åœ¨æ‰©å±•Controller æ—¶ï¼Œåªéœ€è¦å¢åŠ ä¸€ä¸ªé€‚é…å™¨ç±»å°±å®Œæˆäº†SpringMVCçš„æ‰©å±•äº†.</p>
<p>â€‹    å®ç°ä¸€å¥—ä»£ç æ¥æ¨¡æ‹ŸspringMVC:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å®šä¹‰ä¸€ä¸ªAdapteræ¥å£  </span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerAdapter</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Object handler)</span></span>;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Object handler)</span></span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä»¥ä¸‹æ˜¯ä¸‰ç§Controllerå®ç°  </span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Controller</span> </span>&#123;  </div><div class="line">  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpController</span> <span class="keyword">implements</span> <span class="title">Controller</span></span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doHttpHandler</span><span class="params">()</span></span>&#123;  </div><div class="line">        System.out.println(<span class="string">"http..."</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleController</span> <span class="keyword">implements</span> <span class="title">Controller</span></span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSimplerHandler</span><span class="params">()</span></span>&#123;  </div><div class="line">        System.out.println(<span class="string">"simple..."</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationController</span> <span class="keyword">implements</span> <span class="title">Controller</span></span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAnnotationHandler</span><span class="params">()</span></span>&#123;  </div><div class="line">        System.out.println(<span class="string">"annotation..."</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä¸‹é¢ç¼–å†™é€‚é…å™¨ç±»  </span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleHandlerAdapter</span> <span class="keyword">implements</span> <span class="title">HandlerAdapter</span> </span>&#123;  </div><div class="line">  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Object handler)</span> </span>&#123;  </div><div class="line">        ((SimpleController)handler).doSimplerHandler();  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Object handler)</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> (handler <span class="keyword">instanceof</span> SimpleController);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpHandlerAdapter</span> <span class="keyword">implements</span> <span class="title">HandlerAdapter</span> </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Object handler)</span> </span>&#123;  </div><div class="line">        ((HttpController)handler).doHttpHandler();  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Object handler)</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> (handler <span class="keyword">instanceof</span> HttpController);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">  </div><div class="line">  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationHandlerAdapter</span> <span class="keyword">implements</span> <span class="title">HandlerAdapter</span> </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Object handler)</span> </span>&#123;  </div><div class="line">        ((AnnotationController)handler).doAnnotationHandler();  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Object handler)</span> </span>&#123;  </div><div class="line">          </div><div class="line">        <span class="keyword">return</span> (handler <span class="keyword">instanceof</span> AnnotationController);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æ¨¡æ‹Ÿä¸€ä¸ªDispatcherServlet  </span></div><div class="line"><span class="keyword">import</span> java.util.ArrayList;  </div><div class="line"><span class="keyword">import</span> java.util.List;  </div><div class="line">  </div><div class="line">  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatchServlet</span> </span>&#123;  </div><div class="line">      </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;HandlerAdapter&gt; handlerAdapters = <span class="keyword">new</span> ArrayList&lt;HandlerAdapter&gt;();   </div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DispatchServlet</span><span class="params">()</span></span>&#123;  </div><div class="line">        handlerAdapters.add(<span class="keyword">new</span> AnnotationHandlerAdapter());  </div><div class="line">        handlerAdapters.add(<span class="keyword">new</span> HttpHandlerAdapter());  </div><div class="line">        handlerAdapters.add(<span class="keyword">new</span> SimpleHandlerAdapter());  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">()</span></span>&#123;  </div><div class="line">          </div><div class="line">        <span class="comment">//æ­¤å¤„æ¨¡æ‹ŸSpringMVCä»requestå–handlerçš„å¯¹è±¡ï¼Œä»…ä»…newå‡º.               </span></div><div class="line">        <span class="comment">//ä¸è®ºå®ç°ä½•ç§Controllerï¼Œé€‚é…å™¨æ€»èƒ½ç»è¿‡é€‚é…ä»¥åå¾—åˆ°æƒ³è¦çš„ç»“æœ  </span></div><div class="line"><span class="comment">//      HttpController controller = new HttpController();  </span></div><div class="line"><span class="comment">//      AnnotationController controller = new AnnotationController();  </span></div><div class="line">        SimpleController controller = <span class="keyword">new</span> SimpleController();  </div><div class="line">        <span class="comment">//å¾—åˆ°å¯¹åº”é€‚é…å™¨  </span></div><div class="line">        HandlerAdapter adapter = getHandler(controller);  </div><div class="line">        <span class="comment">//é€šè¿‡é€‚é…å™¨æ‰§è¡Œå¯¹åº”çš„controllerå¯¹åº”æ–¹æ³•  </span></div><div class="line">        adapter.handle(controller);  </div><div class="line">          </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">public</span> HandlerAdapter <span class="title">getHandler</span><span class="params">(Controller controller)</span></span>&#123;  </div><div class="line">        <span class="keyword">for</span>(HandlerAdapter adapter: <span class="keyword">this</span>.handlerAdapters)&#123;  </div><div class="line">            <span class="keyword">if</span>(adapter.supports(controller))&#123;  </div><div class="line">                <span class="keyword">return</span> adapter;  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;  </div><div class="line">        <span class="keyword">new</span> DispatchServlet().doDispatch();  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Spring MVC HandlerAdapter ,æœ‰ä¸‹é¢å‡ ä¸ªå­ç±»ï¼š</p>
<p><img src="http://www.ityuedu.com/myimages/2/593936406071.png" alt="img"></p>
<p>è¿™å‡ ä¸ªå­ç±»ï¼Œåˆ†åˆ«ç”¨äºé€‚é…ä¸åŒçš„Handlerï¼ˆæˆ‘ä»¬å†™çš„è¯·æ±‚å¤„ç†ä»£ç ï¼‰ã€‚</p>
<p>å¦‚æœHandleræ˜¯ä¸€ä¸ªç®€å•çš„Servletï¼ˆè¿™æ˜¯åœ¨web.xmlé…ç½®è‡ªå®šä¹‰çš„Servletæ—¶çš„æ–¹å¼ï¼‰ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨<code>SimpleServletHandlerAdapter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span>  ModelAndView <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> </span></div><div class="line"></div><div class="line">        <span class="keyword">throws</span>  Exception &#123; </div><div class="line">        </div><div class="line">      ((Servlet) handler).service(request, response); </div><div class="line"></div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span> ; </div><div class="line"></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœHandleræ˜¯ä¸€ä¸ªç®€å•çš„Controllerçš„å®ä¾‹ï¼Œå°±æ˜¯ç”¨<code>SimpleControllerHandlerAdapter</code>æ¥é€‚é…ï¼ˆåœ¨Spring2.5æ—¶ï¼Œä¸€èˆ¬ä¼šé‡‡ç”¨è¿™ç§æ–¹å¼ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123; </div><div class="line">  <span class="keyword">return</span> ((Controller) handler).handleRequest(request, response); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœä½¿ç”¨äº†æ³¨è§£æ–¹å¼ï¼Œå°±ä½¿ç”¨<code>AnnotationMethodHandlerAdapter</code>.</p>
<p>ä»ä¸Šé¢çš„å¯ä»¥é‡‡ç”¨çš„å‡ ç§å¤„ç†HttpRequestçš„å†™æ³•ä¸Šæ¥çœ‹ï¼Œè¿™å‡ ç§Handleråˆ†åˆ«å±äºä¸åŒçš„ç±»ï¼Œä¹Ÿå°±æ˜¯å¤„ç†çš„æ¥å£æ˜¯ä¸åŒçš„ã€‚ç„¶è€Œåœ¨DispatcherServletä¸­ï¼Œåªç”¨äº†ä¸€ä¸ªæ¥å£ï¼Œé‡‡ç”¨äº†é€‚é…å™¨æ¨¡å¼ï¼Œæ¥å±è”½æ‰è¿™ç§å·®å¼‚ï¼Œåœ¨é€‚é…å™¨çš„å†…éƒ¨ï¼Œè¿›è¡Œæ¥å£çš„è½¬æ¢å·¥ä½œã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[HTTPåè®®è¯¦è§£]]></title>
      <url>http://zsr.github.io/2016/09/11/HTTP%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<h3 id="Http"><a href="#Http" class="headerlink" title="Http:"></a><strong>Http:</strong></h3><ul>
<li>å…¨ç§°ï¼šè¶…æ–‡æœ¬ä¼ è¾“åè®®<code>(HyperText Transfer Protocol)</code></li>
<li>ä½œç”¨ï¼šè®¾è®¡ä¹‹åˆæ˜¯ä¸ºäº†å°†<strong>è¶…æ–‡æœ¬æ ‡è®°è¯­è¨€</strong><code>(HTML)</code>æ–‡æ¡£ä»WebæœåŠ¡å™¨ä¼ é€åˆ°å®¢æˆ·ç«¯çš„æµè§ˆå™¨ã€‚ç°åœ¨<code>http</code>çš„ä½œç”¨å·²ä¸å±€é™äº<code>HTML</code>çš„ä¼ è¾“ã€‚</li>
<li>ç‰ˆæœ¬ï¼š<code>http/1.0</code> <code>http/1.1*</code> <code>http/2.0</code></li>
</ul>
<h3 id="URLè¯¦è§£"><a href="#URLè¯¦è§£" class="headerlink" title="URLè¯¦è§£"></a><strong>URLè¯¦è§£</strong></h3><p>ä¸€ä¸ªç¤ºä¾‹URL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">http://www.mywebsite.com/sj/test;id=8079?name=sviergn&amp;x=true#stuff</div><div class="line"></div><div class="line">Schema: http</div><div class="line">host: www.mywebsite.com</div><div class="line">path: /sj/test</div><div class="line">URL params: id=8079</div><div class="line">Query String: name=sviergn&amp;x=true</div><div class="line">Anchor: stuff</div></pre></td></tr></table></figure>
<ul>
<li><code>scheme</code>ï¼šæŒ‡å®šä½å±‚ä½¿ç”¨çš„åè®®(ä¾‹å¦‚ï¼š<code>http</code>, <code>https</code>, <code>ftp</code>)</li>
<li><code>host</code>ï¼š<code>HTTP</code>æœåŠ¡å™¨çš„<code>IP</code>åœ°å€æˆ–è€…åŸŸå</li>
<li><code>port#</code>ï¼š<code>HTTP</code>æœåŠ¡å™¨çš„é»˜è®¤ç«¯å£æ˜¯<code>80</code>ï¼Œè¿™ç§æƒ…å†µä¸‹ç«¯å£å·å¯ä»¥çœç•¥ã€‚å¦‚æœä½¿ç”¨äº†åˆ«çš„ç«¯å£ï¼Œå¿…é¡»æŒ‡æ˜ï¼Œä¾‹å¦‚<code>http://www.mywebsite.com:8080/</code></li>
<li><code>path</code>ï¼šè®¿é—®èµ„æºçš„è·¯å¾„</li>
<li><code>url-params</code></li>
<li><code>query-string</code>ï¼šå‘é€ç»™<code>http</code>æœåŠ¡å™¨çš„æ•°æ®</li>
<li><code>anchor</code>ï¼šé”š</li>
</ul>
<h3 id="æ— çŠ¶æ€çš„åè®®"><a href="#æ— çŠ¶æ€çš„åè®®" class="headerlink" title="æ— çŠ¶æ€çš„åè®®"></a><strong>æ— çŠ¶æ€çš„åè®®</strong></h3><p><code>http</code>åè®®æ˜¯<strong>æ— çŠ¶æ€</strong>çš„ï¼š</p>
<blockquote>
<p><strong>åŒä¸€ä¸ªå®¢æˆ·ç«¯çš„è¿™æ¬¡è¯·æ±‚å’Œä¸Šæ¬¡è¯·æ±‚æ˜¯æ²¡æœ‰å¯¹åº”å…³ç³»ï¼Œå¯¹httpæœåŠ¡å™¨æ¥è¯´ï¼Œå®ƒå¹¶ä¸çŸ¥é“è¿™ä¸¤ä¸ªè¯·æ±‚æ¥è‡ªåŒä¸€ä¸ªå®¢æˆ·ç«¯ã€‚</strong></p>
</blockquote>
<p>è§£å†³æ–¹æ³•ï¼š<code>Cookie</code>æœºåˆ¶æ¥ç»´æŠ¤çŠ¶æ€</p>
<p><strong>æ—¢ç„¶Httpåè®®æ˜¯æ— çŠ¶æ€çš„ï¼Œé‚£ä¹ˆConnection:keep-alive åˆæ˜¯æ€æ ·ä¸€å›äº‹ï¼Ÿ</strong></p>
<blockquote>
<p>æ— çŠ¶æ€æ˜¯æŒ‡åè®®å¯¹äºäº‹åŠ¡å¤„ç†æ²¡æœ‰è®°å¿†èƒ½åŠ›ï¼ŒæœåŠ¡å™¨ä¸çŸ¥é“å®¢æˆ·ç«¯æ˜¯ä»€ä¹ˆçŠ¶æ€ã€‚ä»å¦ä¸€æ–¹é¢è®²ï¼Œæ‰“å¼€ä¸€ä¸ªæœåŠ¡å™¨ä¸Šçš„ç½‘é¡µå’Œä½ ä¹‹å‰æ‰“å¼€è¿™ä¸ªæœåŠ¡å™¨ä¸Šçš„ç½‘é¡µä¹‹é—´æ²¡æœ‰ä»»ä½•è”ç³»ã€‚</p>
</blockquote>
<h3 id="httpæ¶ˆæ¯ç»“æ„"><a href="#httpæ¶ˆæ¯ç»“æ„" class="headerlink" title="httpæ¶ˆæ¯ç»“æ„"></a><strong>httpæ¶ˆæ¯ç»“æ„</strong></h3><ol>
<li><p><strong>Request æ¶ˆæ¯çš„ç»“æ„</strong>ï¼š<strong>ä¸‰éƒ¨åˆ†</strong></p>
<blockquote>
<p>ç¬¬ä¸€éƒ¨åˆ†å«<code>Request line</code>ï¼ˆè¯·æ±‚è¡Œï¼‰ï¼Œ ç¬¬äºŒéƒ¨åˆ†å«<code>http header</code>, ç¬¬ä¸‰éƒ¨åˆ†æ˜¯<code>body</code></p>
<ul>
<li><p><strong>è¯·æ±‚è¡Œ</strong>ï¼šåŒ…æ‹¬<code>http</code>è¯·æ±‚çš„ç§ç±»ï¼Œè¯·æ±‚èµ„æºçš„è·¯å¾„ï¼Œ<code>http</code>åè®®ç‰ˆæœ¬</p>
</li>
<li><p><strong>http header</strong>ï¼š<code>http</code>å¤´éƒ¨ä¿¡æ¯</p>
</li>
<li><p><strong>body</strong>ï¼šå‘é€ç»™æœåŠ¡å™¨çš„<code>query</code>ä¿¡æ¯<br>å½“ä½¿ç”¨çš„æ˜¯â€<code>GET</code>â€œ æ–¹æ³•çš„æ—¶å€™ï¼Œ<code>body</code>æ˜¯ä¸ºç©ºçš„ï¼ˆ<strong>GETåªèƒ½è¯»å–æœåŠ¡å™¨ä¸Šçš„ä¿¡æ¯</strong>ï¼Œ<strong>postèƒ½å†™å…¥</strong>ï¼‰ </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&gt;   GET /hope/ HTTP/1.1   //---è¯·æ±‚è¡Œ</div><div class="line">&gt;   Host: ce.sysu.edu.cn</div><div class="line">&gt;   Accept: */*</div><div class="line">&gt;   Accept-Encoding: gzip, deflate, sdch</div><div class="line">&gt;   Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.6</div><div class="line">&gt;   Cache-Control: max-age=0</div><div class="line">&gt;   Cookie:.........</div><div class="line">&gt;   Referer: http://ce.sysu.edu.cn/hope/</div><div class="line">&gt;   User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.130 Safari/537.36</div><div class="line">&gt;   ---åˆ†å‰²çº¿---</div><div class="line">&gt;   POST /hope/ HTTP/1.1   //---è¯·æ±‚è¡Œ</div><div class="line">&gt;   Host: ce.sysu.edu.cn</div><div class="line">&gt;   Accept: */*</div><div class="line">&gt;   Accept-Encoding: gzip, deflate, sdch</div><div class="line">&gt;   Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.6</div><div class="line">&gt;   Cache-Control: max-age=0</div><div class="line">&gt;   Cookie:.........</div><div class="line">&gt;   Referer: http://ce.sysu.edu.cn/hope/</div><div class="line">&gt;   User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.130 Safari/537.36</div><div class="line">&gt;   ...body...</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>  â€‹</p>
</blockquote>
</li>
<li><p><strong>Responseæ¶ˆæ¯çš„ç»“æ„</strong></p>
<blockquote>
<p>ä¹Ÿåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†å«request line, ç¬¬äºŒéƒ¨åˆ†å«request headerï¼Œç¬¬ä¸‰éƒ¨åˆ†æ˜¯body</p>
<ul>
<li><p><strong>request line</strong>ï¼šåè®®ç‰ˆæœ¬ã€çŠ¶æ€ç ã€<code>message</code></p>
</li>
<li><p><strong>request header</strong>ï¼š<code>request</code>å¤´ä¿¡æ¯</p>
</li>
<li><p><strong>body</strong>ï¼šè¿”å›çš„è¯·æ±‚èµ„æºä¸»ä½“ </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&gt;   HTTP/1.1 200 OK</div><div class="line">&gt;   Accept-Ranges: bytes</div><div class="line">&gt;   Content-Encoding: gzip</div><div class="line">&gt;   Content-Length: 4533</div><div class="line">&gt;   Content-Type: text/html</div><div class="line">&gt;   Date: Sun, 06 Sep 2015 07:56:07 GMT</div><div class="line">&gt;   ETag: &quot;2788e6e716e7d01:0&quot;</div><div class="line">&gt;   Last-Modified: Fri, 04 Sep 2015 13:37:55 GMT</div><div class="line">&gt;   Server: Microsoft-IIS/7.5</div><div class="line">&gt;   Vary: Accept-Encoding</div><div class="line">&gt;   X-Powered-By: ASP.NET</div><div class="line">&gt;   &lt;!DOCTYPE html&gt;</div><div class="line">&gt;   ...</div><div class="line">&gt;   &lt;&gt;</div><div class="line">&gt;   ...</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
</li>
</ol>
<h3 id="get-å’Œ-post-åŒºåˆ«"><a href="#get-å’Œ-post-åŒºåˆ«" class="headerlink" title="get å’Œ post åŒºåˆ«"></a><strong>get å’Œ post åŒºåˆ«</strong></h3><p><code>http</code>åè®®å®šä¹‰äº†å¾ˆå¤šä¸æœåŠ¡å™¨äº¤äº’çš„æ–¹æ³•ï¼Œæœ€åŸºæœ¬çš„æœ‰4ç§ï¼Œåˆ†åˆ«æ˜¯<code>GET</code>,<code>POST</code>,<code>PUT</code>,<code>DELETE</code>ã€‚ ä¸€ä¸ª<code>URL</code>åœ°å€ç”¨äºæè¿°ä¸€ä¸ªç½‘ç»œä¸Šçš„èµ„æºï¼Œè€Œ<code>HTTP</code>ä¸­çš„<code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code> å°±å¯¹åº”ç€å¯¹è¿™ä¸ªèµ„æºçš„æŸ¥ï¼Œæ”¹ï¼Œå¢ï¼Œåˆ 4ä¸ªæ“ä½œã€‚ æˆ‘ä»¬æœ€å¸¸è§çš„å°±æ˜¯<code>GET</code>å’Œ<code>POST</code>äº†ã€‚<code>GET</code>ä¸€èˆ¬ç”¨äºè·å–/æŸ¥è¯¢èµ„æºä¿¡æ¯ï¼Œè€ŒPOSTä¸€èˆ¬ç”¨äºæ›´æ–°èµ„æºä¿¡æ¯.</p>
<ol>
<li><code>GET</code> æäº¤çš„æ•°æ®ä¼šæ”¾åœ¨<code>URL</code>ä¹‹åï¼Œä»¥<code>?</code>åˆ†å‰²<code>URL</code>å’Œä¼ è¾“æ•°æ®ï¼Œå‚æ•°ä¹‹é—´ä»¥<code>&amp;</code>ç›¸è¿ï¼Œå¦‚<code>EditPosts.aspx?name=test1&amp;id=123456</code>ã€‚<code>POST</code> æ–¹æ³•æ˜¯æŠŠæäº¤çš„æ•°æ®æ”¾åœ¨<code>HTTP</code>åŒ…çš„<code>Body</code>ä¸­ã€‚</li>
<li><code>GET</code> æäº¤çš„æ•°æ®å¤§å°æœ‰é™åˆ¶ï¼ˆå› ä¸º<strong>æµè§ˆå™¨å¯¹URLçš„é•¿åº¦æœ‰é™åˆ¶</strong>ï¼‰ï¼Œè€Œ<code>POST</code>æ–¹æ³•æäº¤çš„æ•°æ®æ²¡æœ‰é™åˆ¶.</li>
<li><code>GET</code> æ–¹å¼éœ€è¦ä½¿ç”¨<code>Request.QueryString</code> æ¥å–å¾—å˜é‡çš„å€¼ï¼Œè€Œ<code>POST</code>æ–¹å¼é€šè¿‡<code>Request.Form</code>æ¥è·å–å˜é‡çš„å€¼ã€‚</li>
<li><code>GET</code> æ–¹å¼æäº¤æ•°æ®ï¼Œä¼šå¸¦æ¥<strong>å®‰å…¨é—®é¢˜</strong>ï¼Œæ¯”å¦‚ä¸€ä¸ªç™»å½•é¡µé¢ï¼Œé€šè¿‡<code>GET</code>æ–¹å¼æäº¤æ•°æ®æ—¶ï¼Œç”¨æˆ·åå’Œå¯†ç å°†å‡ºç°åœ¨<code>URL</code>ä¸Šï¼Œå¦‚æœé¡µé¢å¯ä»¥è¢«ç¼“å­˜æˆ–è€…å…¶ä»–äººå¯ä»¥è®¿é—®è¿™å°æœºå™¨ï¼Œå°±å¯ä»¥ä»å†å²è®°å½•è·å¾—è¯¥ç”¨æˆ·çš„è´¦å·å’Œå¯†ç . </li>
</ol>
<p><strong><a href="https://www.zybuluo.com/yangfch3/note/123476" target="_blank" rel="external">HTTPè¯·æ±‚çš„Getä¸Post</a></strong></p>
<h3 id="çŠ¶æ€ç "><a href="#çŠ¶æ€ç " class="headerlink" title="çŠ¶æ€ç "></a><strong>çŠ¶æ€ç </strong></h3><p><code>Response</code> æ¶ˆæ¯ä¸­çš„ç¬¬ä¸€è¡Œå«åš<strong>çŠ¶æ€è¡Œ</strong>ï¼Œç”±<code>HTTP</code>åè®®ç‰ˆæœ¬å·ï¼Œ <strong>çŠ¶æ€ç </strong>ï¼Œ <strong>çŠ¶æ€æ¶ˆæ¯</strong> ä¸‰éƒ¨åˆ†ç»„æˆã€‚</p>
<p>çŠ¶æ€ç ç”¨æ¥å‘Šè¯‰<code>HTTP</code>å®¢æˆ·ç«¯ï¼Œ<code>HTTP</code>æœåŠ¡å™¨æ˜¯å¦äº§ç”Ÿäº†é¢„æœŸçš„<code>Response</code>.</p>
<p><code>HTTP/1.1</code>ä¸­å®šä¹‰äº† 5 ç±»çŠ¶æ€ç ã€‚</p>
<p>çŠ¶æ€ç ç”±ä¸‰ä½æ•°å­—ç»„æˆï¼Œç¬¬ä¸€ä¸ªæ•°å­—å®šä¹‰äº†å“åº”çš„ç±»åˆ«</p>
<ul>
<li><code>1XX</code> æç¤ºä¿¡æ¯ - è¡¨ç¤ºè¯·æ±‚å·²è¢«æˆåŠŸæ¥æ”¶ï¼Œç»§ç»­å¤„ç†</li>
<li><code>2XX</code> æˆåŠŸ - è¡¨ç¤ºè¯·æ±‚å·²è¢«æˆåŠŸæ¥æ”¶ï¼Œç†è§£ï¼Œæ¥å—</li>
<li><code>3XX</code> é‡å®šå‘ - è¦å®Œæˆè¯·æ±‚å¿…é¡»è¿›è¡Œæ›´è¿›ä¸€æ­¥çš„å¤„ç†</li>
<li><code>4XX</code> å®¢æˆ·ç«¯é”™è¯¯ - è¯·æ±‚æœ‰è¯­æ³•é”™è¯¯æˆ–è¯·æ±‚æ— æ³•å®ç°</li>
<li><code>5XX</code> æœåŠ¡å™¨ç«¯é”™è¯¯ - æœåŠ¡å™¨æœªèƒ½å®ç°åˆæ³•çš„è¯·æ±‚<ol>
<li><strong>200 OK</strong><br>è¯·æ±‚è¢«æˆåŠŸåœ°å®Œæˆï¼Œæ‰€è¯·æ±‚çš„èµ„æºå‘é€å›å®¢æˆ·ç«¯</li>
<li><strong>302 Found</strong><br>é‡å®šå‘ï¼Œæ–°çš„<code>URL</code>ä¼šåœ¨<code>response</code>ä¸­çš„<code>Location</code>ä¸­è¿”å›ï¼Œæµè§ˆå™¨å°†ä¼šä½¿ç”¨æ–°çš„<code>URL</code>å‘å‡ºæ–°çš„<code>Request</code></li>
<li><strong>304 Not Modified</strong><br>æ–‡æ¡£å·²ç»è¢«ç¼“å­˜ï¼Œç›´æ¥ä»ç¼“å­˜è°ƒç”¨</li>
<li><strong>400 Bad Request</strong><br>å®¢æˆ·ç«¯è¯·æ±‚ä¸è¯­æ³•é”™è¯¯ï¼Œä¸èƒ½è¢«æœåŠ¡å™¨æ‰€ç†è§£<br><strong>403 Forbidden</strong><br>æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚ï¼Œä½†æ˜¯æ‹’ç»æä¾›æœåŠ¡<br><strong>404 Not Found</strong><br>è¯·æ±‚èµ„æºä¸å­˜åœ¨</li>
<li><strong>500 Internal Server Error</strong><br>æœåŠ¡å™¨å‘ç”Ÿäº†ä¸å¯é¢„æœŸçš„é”™è¯¯<br><strong>503 Server Unavailable</strong><br>æœåŠ¡å™¨å½“å‰ä¸èƒ½å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä¸€æ®µæ—¶é—´åå¯èƒ½æ¢å¤æ­£å¸¸</li>
</ol>
</li>
</ul>
<h3 id="http-reauest-header"><a href="#http-reauest-header" class="headerlink" title="http reauest header"></a><strong>http reauest header</strong></h3><p><code>http</code> è¯·æ±‚å¤´åŒ…æ‹¬å¾ˆå¤šé”®å€¼å¯¹ï¼Œè¿™äº›é”®å€¼å¯¹æœ‰ä»€ä¹ˆæ„ä¹‰ä¸ä½œç”¨ï¼Ÿå¦‚ä½•æ ¹æ®åŠŸèƒ½ä¸ºä»–ä»¬åˆ†ä¸€ä¸‹ç»„å‘¢ï¼Ÿ</p>
<ol>
<li><p><strong>cache å¤´åŸŸ</strong></p>
<ul>
<li><p><code>If-Modified-Since</code><br>ç”¨æ³•ï¼š<code>If-Modified-Since: Thu, 09 Feb 2012 09:07:57 GMT</code></p>
<p>æŠŠæµè§ˆå™¨ç«¯ç¼“å­˜é¡µé¢çš„æœ€åä¿®æ”¹æ—¶é—´å‘é€åˆ°æœåŠ¡å™¨å»ï¼ŒæœåŠ¡å™¨ä¼šæŠŠè¿™ä¸ªæ—¶é—´ä¸æœåŠ¡å™¨ä¸Šå®é™…æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´è¿›è¡Œå¯¹æ¯”ã€‚å¦‚æœæ—¶é—´ä¸€è‡´ï¼Œé‚£ä¹ˆè¿”å›304ï¼Œå®¢æˆ·ç«¯å°±ç›´æ¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ–‡ä»¶ã€‚å¦‚æœæ—¶é—´ä¸ä¸€è‡´ï¼Œå°±ä¼šè¿”å›200å’Œæ–°çš„æ–‡ä»¶å†…å®¹ã€‚å®¢æˆ·ç«¯æ¥åˆ°ä¹‹åï¼Œä¼šä¸¢å¼ƒæ—§æ–‡ä»¶ï¼ŒæŠŠæ–°æ–‡ä»¶ç¼“å­˜èµ·æ¥ï¼Œå¹¶æ˜¾ç¤ºåœ¨æµè§ˆå™¨ä¸­ã€‚ </p>
</li>
<li><p><code>If-None-Match</code><br>ç”¨æ³•ï¼š<code>If-None-Match: &quot;03f2b33c0bfcc1:0&quot;</code></p>
<p><code>If-None-Match</code>å’Œ<code>ETag</code>ä¸€èµ·å·¥ä½œï¼Œ<strong>å·¥ä½œåŸç†æ˜¯åœ¨HTTP Responseä¸­æ·»åŠ ETagä¿¡æ¯</strong>ã€‚ å½“ç”¨æˆ·å†æ¬¡è¯·æ±‚è¯¥èµ„æºæ—¶ï¼Œå°†åœ¨<code>HTTP Request</code> ä¸­åŠ å…¥<code>If-None-Match</code>ä¿¡æ¯(<code>ETag</code>çš„å€¼)ã€‚å¦‚æœæœåŠ¡å™¨éªŒè¯èµ„æºçš„<code>ETag</code>æ²¡æœ‰æ”¹å˜ï¼ˆè¯¥èµ„æºæ²¡æœ‰æ›´æ–°ï¼‰ï¼Œå°†è¿”å›ä¸€ä¸ª<code>304</code>çŠ¶æ€å‘Šè¯‰å®¢æˆ·ç«¯ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ–‡ä»¶ã€‚<strong>å¦åˆ™å°†è¿”å›200çŠ¶æ€å’Œæ–°çš„èµ„æºå’ŒEtag</strong>. ä½¿ç”¨è¿™æ ·çš„æœºåˆ¶å°†æé«˜ç½‘ç«™çš„æ€§èƒ½ </p>
</li>
<li><p><code>Pragma</code>ï¼š<code>Pragma: no-cache</code><br><code>Pargma</code>åªæœ‰ä¸€ä¸ªç”¨æ³•ï¼Œ ä¾‹å¦‚ï¼š <code>Pragma: no-cache</code></p>
<p>ä½œç”¨ï¼š é˜²æ­¢é¡µé¢è¢«ç¼“å­˜ï¼Œ åœ¨<code>HTTP/1.1</code>ç‰ˆæœ¬ä¸­ï¼Œå®ƒå’Œ<code>Cache-Control:no-cache</code>ä½œç”¨ä¸€æ¨¡ä¸€æ · </p>
</li>
<li><p><code>Cache-Control</code><br>ç”¨æ³•ï¼š</p>
<ul>
<li><code>Cache-Control:Public</code> å¯ä»¥è¢«ä»»ä½•ç¼“å­˜æ‰€ç¼“å­˜ï¼ˆï¼‰</li>
<li><code>Cache-Control:Private</code> å†…å®¹åªç¼“å­˜åˆ°ç§æœ‰ç¼“å­˜ä¸­</li>
<li><code>Cache-Control:no-cache</code> æ‰€æœ‰å†…å®¹éƒ½ä¸ä¼šè¢«ç¼“å­˜</li>
</ul>
<p>ä½œç”¨ï¼šç”¨æ¥æŒ‡å®š<code>Response-Request</code>éµå¾ªçš„ç¼“å­˜æœºåˆ¶</p>
</li>
</ul>
</li>
<li><p><strong>Client å¤´åŸŸ</strong></p>
<ul>
<li><p><code>Accept</code><br>ç”¨æ³•ï¼š<code>Accept: */*</code>ï¼Œ<code>Accept: text/html</code></p>
<p>ä½œç”¨ï¼š æµè§ˆå™¨ç«¯å¯ä»¥æ¥å—çš„åª’ä½“ç±»å‹ï¼›<br><code>Accept: */*</code> ä»£è¡¨æµè§ˆå™¨å¯ä»¥å¤„ç†æ‰€æœ‰å›å‘çš„ç±»å‹ï¼Œ(<strong>ä¸€èˆ¬æµè§ˆå™¨å‘ç»™æœåŠ¡å™¨éƒ½æ˜¯å‘è¿™ä¸ª</strong>ï¼‰<br><code>Accept: text/html</code> ä»£è¡¨æµè§ˆå™¨å¯ä»¥æ¥å—æœåŠ¡å™¨å›å‘çš„ç±»å‹ä¸º <code>text/html</code> ï¼›å¦‚æœæœåŠ¡å™¨æ— æ³•è¿”å›<code>text/html</code>ç±»å‹çš„æ•°æ®ï¼ŒæœåŠ¡å™¨åº”è¯¥è¿”å›ä¸€ä¸ª<code>406</code>é”™è¯¯(<code>non acceptable</code>) </p>
</li>
<li><p><code>Accept-Encoding</code><br>ç”¨æ³•ï¼š<code>Accept-Encoding: gzip, deflate</code></p>
<p>ä½œç”¨ï¼š æµè§ˆå™¨ç”³æ˜è‡ªå·±æ¥æ”¶çš„<strong>æ–‡ä»¶</strong>ç¼–ç æ–¹æ³•ï¼Œé€šå¸¸æŒ‡å®š<strong>å‹ç¼©æ–¹æ³•</strong>ï¼Œæ˜¯å¦æ”¯æŒå‹ç¼©ï¼Œæ”¯æŒä»€ä¹ˆå‹ç¼©æ–¹æ³•ï¼ˆ<code>gzip</code>ï¼Œ<code>deflate</code>ï¼‰ï¼Œï¼ˆæ³¨æ„ï¼šè¿™ä¸æ˜¯æŒ‡å­—ç¬¦ç¼–ç ï¼‰ </p>
</li>
<li><p><code>Accept-Language</code><br>ç”¨æ³•ï¼š<code>Accept-Language: en-us</code></p>
<p>ä½œç”¨ï¼š æµè§ˆå™¨ç”³æ˜è‡ªå·±æ¥æ”¶çš„è¯­è¨€ã€‚<br><strong>è¯­è¨€è·Ÿå­—ç¬¦é›†çš„åŒºåˆ«</strong>ï¼šä¸­æ–‡æ˜¯è¯­è¨€ï¼Œä¸­æ–‡æœ‰å¤šç§å­—ç¬¦é›†ï¼Œæ¯”å¦‚<code>big5</code>ï¼Œ<code>gb2312</code>ï¼Œ<code>gbk</code>ç­‰ç­‰ï¼› </p>
</li>
<li><p><code>User-Agent</code><br>ç”¨æ³•ï¼š <code>User-Agent: Mozilla/4.0......</code></p>
<p>ä½œç”¨ï¼šå‘Šè¯‰<code>HTTP</code>æœåŠ¡å™¨ï¼Œ å®¢æˆ·ç«¯ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿå’Œæµè§ˆå™¨çš„åç§°å’Œç‰ˆæœ¬. </p>
</li>
<li><p><code>Accept-Charset</code><br>ç”¨æ³•ï¼š<code>Accept-Charsetï¼šutf-8</code></p>
<p>ä½œç”¨ï¼šæµè§ˆå™¨ç”³æ˜è‡ªå·±æ¥æ”¶çš„å­—ç¬¦é›†ï¼Œè¿™å°±æ˜¯æœ¬æ–‡å‰é¢ä»‹ç»çš„å„ç§å­—ç¬¦é›†å’Œå­—ç¬¦ç¼–ç ï¼Œå¦‚gb2312ï¼Œutf-8ï¼ˆé€šå¸¸æˆ‘ä»¬è¯´CharsetåŒ…æ‹¬äº†ç›¸åº”çš„å­—ç¬¦ç¼–ç æ–¹æ¡ˆï¼‰ </p>
</li>
</ul>
</li>
<li><p><strong>Cookie/Login å¤´åŸŸ</strong></p>
<ul>
<li><p><code>Cookie</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Cookie: bdshare_firstime=1439081296143; ASP.NET_SessionId=rcqayd4ufldcke0wkbm1vhxb; pgv_pvi=7361416192; pgv_si=s6686106624; ce.sysu.edu.cn80.ASPXAUTH=9E099592DD5A414BEECD8CF43CFC71664</div></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼š <strong>æœ€é‡è¦</strong>çš„<strong>header</strong>, å°†<code>cookie</code>çš„å€¼å‘é€ç»™<code>HTTP</code> æœåŠ¡å™¨</p>
</li>
</ul>
</li>
<li><p><strong>Entity å¤´åŸŸ</strong></p>
<ul>
<li><p><code>Content-Length</code><br>ç”¨æ³•ï¼š<code>Content-Length: 38</code></p>
<p>ä½œç”¨ï¼šå‘é€ç»™HTTPæœåŠ¡å™¨æ•°æ®çš„é•¿åº¦ã€‚ </p>
</li>
<li><p><code>Content-Type</code><br>ç”¨æ³•ï¼š<code>Content-Type: application/x-www-form-urlencoded</code></p>
<p>ä¸å¸¸å‡ºç°ï¼Œä¸€èˆ¬å‡ºç°åœ¨<code>response</code>å¤´éƒ¨ï¼Œç”¨äºæŒ‡å®šæ•°æ®æ–‡ä»¶ç±»å‹ </p>
</li>
</ul>
</li>
<li><p><strong>Miscellaneous å¤´åŸŸ</strong></p>
<ul>
<li><p><code>Referer</code><br>ç”¨æ³•ï¼š<code>Referer: http://ce.sysu.edu.cn/hope/</code></p>
<p>ä½œç”¨ï¼šæä¾›äº†<code>Request</code>çš„<strong>ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>çš„æœåŠ¡å™¨ï¼Œå‘Šè¯‰æœåŠ¡å™¨æˆ‘æ˜¯ä»å“ªä¸ªé“¾æ¥è¿‡æ¥çš„ï¼Œæ¯”å¦‚ä»æˆ‘ä¸»é¡µä¸Šé“¾æ¥åˆ°ä¸€ä¸ªæœ‹å‹é‚£é‡Œï¼Œä»–çš„æœåŠ¡å™¨å°±èƒ½å¤Ÿä»<code>HTTP Referer</code>ä¸­ç»Ÿè®¡å‡ºæ¯å¤©æœ‰å¤šå°‘ç”¨æˆ·ç‚¹å‡»æˆ‘ä¸»é¡µä¸Šçš„é“¾æ¥è®¿é—®ä»–çš„ç½‘ç«™ã€‚ </p>
</li>
</ul>
</li>
<li><p><strong>Transport å¤´åŸŸ</strong></p>
<ul>
<li><p><code>Connection</code><br><code>Connection: keep-alive</code>ï¼š å½“ä¸€ä¸ªç½‘é¡µæ‰“å¼€å®Œæˆåï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ç”¨äºä¼ è¾“HTTPæ•°æ®çš„TCPè¿æ¥ä¸ä¼šå…³é—­ï¼Œå¦‚æœå®¢æˆ·ç«¯å†æ¬¡è®¿é—®è¿™ä¸ªæœåŠ¡å™¨ä¸Šçš„ç½‘é¡µï¼Œä¼šç»§ç»­ä½¿ç”¨è¿™ä¸€æ¡å·²ç»å»ºç«‹çš„è¿æ¥</p>
<p><code>Connection: close</code>ï¼š ä»£è¡¨ä¸€ä¸ª<code>Request</code>å®Œæˆåï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ç”¨äºä¼ è¾“<code>HTTP</code>æ•°æ®çš„<code>TCP</code>è¿æ¥ä¼šå…³é—­ï¼Œ å½“å®¢æˆ·ç«¯å†æ¬¡å‘é€<code>Request</code>ï¼Œéœ€è¦é‡æ–°å»ºç«‹<code>TCP</code>è¿æ¥ </p>
</li>
<li><p><code>Host</code><br>ç”¨æ³•ï¼š<code>Host: ce.sysu.edu.cn</code></p>
<p>ä½œç”¨: è¯·æ±‚æŠ¥å¤´åŸŸä¸»è¦ç”¨äºæŒ‡å®šè¢«è¯·æ±‚èµ„æºçš„<code>Internet</code><strong>ä¸»æœºå’Œç«¯å£å·</strong>ï¼ˆé»˜è®¤80ï¼‰ï¼Œå®ƒé€šå¸¸ä»<code>HTTP URL</code>ä¸­æå–å‡ºæ¥çš„</p>
</li>
</ul>
</li>
</ol>
<h3 id="HTTP-Response-header"><a href="#HTTP-Response-header" class="headerlink" title="HTTP Response header"></a><strong>HTTP Response header</strong></h3><ol>
<li><p><strong><code>Cache</code> å¤´åŸŸ</strong></p>
<ul>
<li><p><code>Date</code><br>ç”¨æ³•ï¼š<code>Date: Sat, 11 Feb 2012 11:35:14 GMT</code></p>
<p>ä½œç”¨: ç”Ÿæˆæ¶ˆæ¯çš„å…·ä½“æ—¶é—´å’Œæ—¥æœŸ </p>
</li>
<li><p><code>Expires</code><br>ç”¨æ³•ï¼š<code>Expires: Tue, 08 Feb 2022 11:35:14 GMT</code><br>ä½œç”¨: æµè§ˆå™¨ä¼šåœ¨æŒ‡å®šè¿‡æœŸæ—¶é—´å†…ä½¿ç”¨æœ¬åœ°ç¼“å­˜ </p>
</li>
<li><p><code>Vary</code><br>ç”¨æ³•ï¼šVary: Accept-Encoding </p>
</li>
</ul>
</li>
<li><p><strong><code>Cookie/Login</code> å¤´åŸŸ</strong></p>
<ul>
<li><p><code>P3P</code><br>ç”¨æ³•ï¼š<br><code>P3P: CP=CURa ADMa DEVa PSAo PSDo OUR BUS UNI PUR INT DEM STA PRE COM NAV OTC NOI DSP COR</code></p>
<p>ä½œç”¨: ç”¨äº<strong>è·¨åŸŸ</strong>è®¾ç½®<strong>Cookie</strong>, è¿™æ ·å¯ä»¥è§£å†³<code>iframe</code>è·¨åŸŸè®¿é—®<code>cookie</code>çš„é—®é¢˜ </p>
</li>
<li><p><code>Set-Cookie</code><br>ç”¨æ³•ï¼š<br><code>Set-Cookie: sc=4c31523a; path=/; domain=.acookie.taobao.com</code></p>
<p>ä½œç”¨ï¼šéå¸¸é‡è¦çš„<code>header</code>, ç”¨äºæŠŠ<code>cookie</code> å‘é€åˆ°å®¢æˆ·ç«¯æµè§ˆå™¨ï¼Œ æ¯ä¸€ä¸ªå†™å…¥<code>cookie</code>éƒ½ä¼šç”Ÿæˆä¸€ä¸ª<code>Set-Cookie</code>.</p>
</li>
</ul>
</li>
<li><p><strong><code>Entity</code> å¤´åŸŸ</strong></p>
<ul>
<li><p><code>ETag</code><br>ç”¨æ³•ï¼š<code>ETag: &quot;03f2b33c0bfcc1:0&quot;</code></p>
<p>ä½œç”¨: å’Œ<code>request header</code>çš„<code>If-None-Match</code> é…åˆä½¿ç”¨ </p>
</li>
<li><p><code>Last-Modified</code><br>ç”¨æ³•ï¼š<code>Last-Modified: Wed, 21 Dec 2011 09:09:10 GMT</code></p>
<p>ä½œç”¨ï¼šç”¨äºæŒ‡ç¤ºèµ„æºçš„æœ€åä¿®æ”¹æ—¥æœŸå’Œæ—¶é—´ã€‚ï¼ˆå®ä¾‹è¯·çœ‹ä¸ŠèŠ‚çš„<code>If-Modified-Since</code>çš„å®ä¾‹ï¼‰ </p>
</li>
<li><p><code>Content-Type</code><br>ç”¨æ³•ï¼š</p>
<ul>
<li>Content-Type: text/html; charset=utf-8</li>
<li>Content-Type:text/html;charset=GB2312</li>
<li>Content-Type: image/jpeg</li>
</ul>
<p>ä½œç”¨ï¼šWEBæœåŠ¡å™¨å‘Šè¯‰æµè§ˆå™¨è‡ªå·±å“åº”çš„å¯¹è±¡çš„ç±»å‹å’Œå­—ç¬¦é›† </p>
</li>
<li><p>Content-Encoding<br>ç”¨æ³•ï¼š<code>Content-Encodingï¼šgzip</code></p>
<p>ä½œç”¨ï¼šWEBæœåŠ¡å™¨è¡¨æ˜è‡ªå·±ä½¿ç”¨äº†ä»€ä¹ˆå‹ç¼©æ–¹æ³•ï¼ˆ<code>gzip</code>ï¼Œ<code>deflate</code>ï¼‰å‹ç¼©å“åº”ä¸­çš„å¯¹è±¡ã€‚ </p>
</li>
<li><p><code>Content-Language</code><br>ç”¨æ³•ï¼š <code>Content-Language:da</code></p>
<p>WEBæœåŠ¡å™¨å‘Šè¯‰æµè§ˆå™¨è‡ªå·±å“åº”çš„å¯¹è±¡çš„è¯­è¨€</p>
</li>
</ul>
</li>
<li><p><strong><code>Miscellaneous</code> å¤´åŸŸ</strong></p>
<ul>
<li><p><code>Server</code><br>ç”¨æ³•ï¼š<code>Server: Microsoft-IIS/7.5</code></p>
<p>ä½œç”¨ï¼šæŒ‡æ˜HTTPæœåŠ¡å™¨çš„è½¯ä»¶ä¿¡æ¯ </p>
</li>
<li><p><code>X-AspNet-Version</code><br>ç”¨æ³•ï¼š<code>X-AspNet-Version: 4.0.30319</code></p>
<p>ä½œç”¨ï¼šå¦‚æœç½‘ç«™æ˜¯ç”¨<code>ASP.NET</code>å¼€å‘çš„ï¼Œè¿™ä¸ª<code>header</code>ç”¨æ¥è¡¨ç¤º<code>ASP.NET</code>çš„ç‰ˆæœ¬ </p>
</li>
<li><p>X-Powered-By<br>ç”¨æ³•ï¼š<code>X-Powered-By: ASP.NET</code></p>
<p>ä½œç”¨ï¼šè¡¨ç¤ºç½‘ç«™æ˜¯ç”¨ä»€ä¹ˆæŠ€æœ¯å¼€å‘çš„ </p>
</li>
</ul>
</li>
<li><p><strong><code>Transport</code>å¤´åŸŸ</strong></p>
<ul>
<li><code>Connection</code><br>ç”¨æ³•ä¸ä½œç”¨ï¼š<br><code>Connection: keep-alive</code>ï¼šå½“ä¸€ä¸ªç½‘é¡µæ‰“å¼€å®Œæˆåï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ç”¨äºä¼ è¾“HTTPæ•°æ®çš„TCPè¿æ¥ä¸ä¼šå…³é—­ï¼Œå¦‚æœå®¢æˆ·ç«¯å†æ¬¡è®¿é—®è¿™ä¸ªæœåŠ¡å™¨ä¸Šçš„ç½‘é¡µï¼Œä¼šç»§ç»­ä½¿ç”¨è¿™ä¸€æ¡å·²ç»å»ºç«‹çš„è¿æ¥<code>Connection: close</code>ï¼šä»£è¡¨ä¸€ä¸ªRequestå®Œæˆåï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ç”¨äºä¼ è¾“HTTPæ•°æ®çš„TCPè¿æ¥ä¼šå…³é—­ï¼Œ å½“å®¢æˆ·ç«¯å†æ¬¡å‘é€Requestï¼Œéœ€è¦é‡æ–°å»ºç«‹TCPè¿æ¥</li>
</ul>
</li>
<li><p><strong><code>Location</code>å¤´åŸŸ</strong></p>
<ul>
<li>Location<br>ç”¨æ³•ï¼š<code>Locationï¼šhttp://ce.sysu.edu.cn/hope/</code><br>ä½œç”¨ï¼š ç”¨äºé‡å®šå‘ä¸€ä¸ªæ–°çš„ä½ç½®ï¼Œ åŒ…å«æ–°çš„<code>URL</code>åœ°å€</li>
</ul>
</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Httpè¯·æ±‚è¿‡ç¨‹]]></title>
      <url>http://zsr.github.io/2016/09/10/http%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B/</url>
      <content type="html"><![CDATA[<p>æµè§ˆå™¨ httpè¯·æ±‚è¿‡ç¨‹</p>
<h3 id="1-é¦–å…ˆæ˜¯è¾“å…¥ç½‘å€"><a href="#1-é¦–å…ˆæ˜¯è¾“å…¥ç½‘å€" class="headerlink" title="1. é¦–å…ˆæ˜¯è¾“å…¥ç½‘å€"></a><strong>1. é¦–å…ˆæ˜¯è¾“å…¥ç½‘å€</strong></h3><p>ä»¥www.facebook.comä¸ºä¾‹.</p>
<h3 id="2-æµè§ˆå™¨æŸ¥æ‰¾åŸŸåå¯¹åº”IP"><a href="#2-æµè§ˆå™¨æŸ¥æ‰¾åŸŸåå¯¹åº”IP" class="headerlink" title="2. æµè§ˆå™¨æŸ¥æ‰¾åŸŸåå¯¹åº”IP"></a><strong>2. æµè§ˆå™¨æŸ¥æ‰¾åŸŸåå¯¹åº”IP</strong></h3><h4 id="2-1-DNSæŸ¥æ‰¾è¿‡ç¨‹ï¼š"><a href="#2-1-DNSæŸ¥æ‰¾è¿‡ç¨‹ï¼š" class="headerlink" title="2.1 DNSæŸ¥æ‰¾è¿‡ç¨‹ï¼š"></a><strong>2.1 DNSæŸ¥æ‰¾è¿‡ç¨‹ï¼š</strong></h4><ol>
<li><strong>æµè§ˆå™¨ç¼“å­˜</strong>â€”â€”æµè§ˆå™¨ä¼šè®°å½•DNSä¸€æ®µæ—¶é—´ï¼ˆ2-30åˆ†é’Ÿä¸ç­‰ï¼Œè§†æµè§ˆå™¨è€Œå®šï¼‰</li>
<li><strong>ç³»ç»Ÿç¼“å­˜</strong>â€”â€”æµè§ˆå™¨é‡Œæ²¡æ‰¾åˆ°DNSç¼“å­˜ï¼Œæ­¤äº‹æµè§ˆå™¨åšä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼ˆwindowä¸‹æ˜¯gethostbynameï¼‰ã€‚å¦‚å‘ç°åŒ¹é…åˆ™é‡‡ç”¨ã€‚ï¼ˆä¸æ­¤å¯¹åº”æœ‰hostæ¶æ„åŠ«æŒæ›´æ”¹æ”»å‡»ï¼‰</li>
<li><strong>è·¯ç”±å™¨ç¼“å­˜</strong>â€”â€”è·¯ç”±å™¨ä¹Ÿä¼šæœ‰DNSç¼“å­˜ï¼ˆç¼“å­˜ä½ ä¸Šè¿‡çš„ç½‘ç«™ï¼Œæ‰€ä»¥æœ‰æ—¶è·¯ç”±å™¨éœ€è¦è¿›è¡ŒDNSåˆ·æ–°ï¼‰</li>
<li><strong>ISP DNSç¼“å­˜</strong>â€”â€”æ¥ä¸‹æ¥æ˜¯åœ¨ISPï¼ˆäº’è”ç½‘æœåŠ¡æä¾›å•†ï¼‰çš„DNSæœåŠ¡å™¨çš„<strong>ç¼“å­˜</strong>ä¸ŠæŸ¥æ‰¾ã€‚**</li>
<li><strong>é€’å½’æŸ¥æ‰¾</strong>â€”â€”DNSç¼“å­˜é‡Œæ²¡æœ‰çš„è¯ï¼ŒISP DNSæœåŠ¡å™¨ä¼šå…ˆåä»<strong>æ ¹åŸŸåæœåŠ¡å™¨ï¼ˆrootï¼‰</strong>ã€<strong>.comé¡¶çº§åŸŸåæœåŠ¡å™¨</strong>ã€<strong>FacebookåŸŸåæœåŠ¡å™¨</strong>è·å–IPï¼ˆä¸€èˆ¬ç¼“å­˜å†…éƒ½ä¼šæœ‰ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ä¸€èˆ¬ä¸ä¼šå‘ç”Ÿï¼‰</li>
</ol>
<p>DNSé€’å½’æŸ¥æ‰¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://mmbiz.qpic.cn/mmbiz/KovAgJ2aWyaMiajaQydgJ5rUpib6cuhTpJ8RvkQs1icO3m8PUqSRHvhq6qbWyXr1keDtg9wNE9SlJpicDq8dHspuVA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" alt="img"></p>
<p>DNSæœ‰ä¸€ç‚¹ä»¤äººæ‹…å¿§ï¼Œè¿™å°±æ˜¯åƒwikipedia.org æˆ–è€… facebook.comè¿™æ ·çš„æ•´ä¸ªåŸŸåçœ‹ä¸Šå»åªæ˜¯å¯¹åº”ä¸€ä¸ªå•ç‹¬çš„IPåœ°å€ã€‚è¿˜å¥½ï¼Œæœ‰å‡ ç§æ–¹æ³•å¯ä»¥æ¶ˆé™¤è¿™ä¸ªç“¶é¢ˆï¼š</p>
<h4 id="2-2-å¤šIPåŸŸåDNSæŸ¥è¯¢è§£å†³æ–¹æ¡ˆ"><a href="#2-2-å¤šIPåŸŸåDNSæŸ¥è¯¢è§£å†³æ–¹æ¡ˆ" class="headerlink" title="2.2 å¤šIPåŸŸåDNSæŸ¥è¯¢è§£å†³æ–¹æ¡ˆ"></a><strong>2.2 å¤šIPåŸŸåDNSæŸ¥è¯¢è§£å†³æ–¹æ¡ˆ</strong></h4><ol>
<li><strong>å¾ªç¯DNS</strong>â€”â€”å•ä¸ªåŸŸåã€å¤šä¸ªIPåˆ—è¡¨å¾ªç¯åº”å¯¹DNSæŸ¥è¯¢</li>
<li><strong>è´Ÿè½½å‡è¡¡å™¨</strong>â€”â€”ä¸€ä¸ªç‰¹å®šIPçš„è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ï¼šåå‘ä»£ç†æœåŠ¡å™¨ï¼‰è´Ÿè´£ç›‘å¬è¯·æ±‚å¹¶è½¬å‘ç»™åé¢çš„å¤šä¸ªæœåŠ¡å™¨é›†ç¾¤çš„æŸä¸€ä¸ªï¼Œå®ç°å¤šä¸ªæœåŠ¡å™¨è´Ÿè½½å‡è¡¡</li>
<li><strong>åœ°ç†DNS</strong>â€”â€”æ ¹æ®ç”¨æˆ·æ‰€å¤„åœ°ç†ä½ç½®ï¼Œè¿”å›ä¸åŒçš„IPï¼ˆåº”ç”¨ï¼šCDNï¼‰</li>
<li><strong>anycast</strong>â€”â€”ä¸€ä¸ªIPåœ°å€æ˜ å°„å¤šä¸ªç‰©ç†ä¸»æœºçš„è·¯ç”±æŠ€æœ¯</li>
</ol>
<p>å¤§å¤šæ•°DNSæœåŠ¡å™¨ä½¿ç”¨Anycastæ¥è·å¾—é«˜æ•ˆä½å»¶è¿Ÿçš„DNSæŸ¥æ‰¾ã€‚</p>
<h3 id="3-å‘é€è¯·æ±‚"><a href="#3-å‘é€è¯·æ±‚" class="headerlink" title="3. å‘é€è¯·æ±‚"></a><strong>3. å‘é€è¯·æ±‚</strong></h3><p>å¾—åˆ°åŸŸåå¯¹åº”çš„IPåï¼Œå°±å¼€å§‹å‘é€HTTP(S)è¯·æ±‚äº†.</p>
<p>æµè§ˆå™¨å°†æŠŠè¯·æ±‚å‘é€åˆ°Facebookæ‰€åœ¨çš„æœåŠ¡å™¨, è¯·æ±‚å¤´è¯¦è§£ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET http://facebook.com/ HTTP/1.1</div><div class="line">Accept: application/x-ms-application, image/jpeg, application/xaml+xml, [...]</div><div class="line">User-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; WOW64; [...]</div><div class="line">Accept-Encoding: gzip, deflate</div><div class="line">Connection: Keep-Alive</div><div class="line">Host: facebook.com</div><div class="line">Cookie: datr=1265876274-[...]; locale=en_US; lsd=WW[...]; c_user=2101[...]</div></pre></td></tr></table></figure>
<p>è¯·æ±‚å‘Šè¯‰æœåŠ¡å™¨ï¼š </p>
<ol>
<li>æˆ‘è¦è·å–ï¼ˆGETï¼‰ <a href="http://facebook.com/" target="_blank" rel="external">http://facebook.com/</a>ï¼ˆGETçš„URLï¼‰è¿™ä¸ªé¡µé¢ </li>
<li>Acceptï¼šæˆ‘èƒ½æ¥å—è¿™äº›ç±»å‹çš„æ–‡ä»¶ </li>
<li>æˆ‘ä½¿ç”¨çš„æ˜¯ä½•ç§æ“ä½œç³»ç»Ÿä¸Šçš„å“ªä¸ªç±»å‹é‚£ä¸ªç‰ˆæœ¬çš„æµè§ˆå™¨ </li>
<li>æ¥å—ä½•ç§æ–¹å¼çš„å‹ç¼©æ–‡ä»¶ </li>
<li>è¿æ¥ç±»å‹ï¼šçŸ­è¿æ¥ï¼Ÿé•¿è¿æ¥ï¼Ÿ </li>
<li>ä¸»æœºåŸŸå </li>
<li>å‘é€å­˜å‚¨åœ¨æœ¬æœºçš„cookiesä¿¡æ¯ç»™æœåŠ¡å™¨</li>
</ol>
<p>é™¤äº†è·å–è¯·æ±‚ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯å‘é€è¯·æ±‚ï¼Œå®ƒå¸¸åœ¨æäº¤è¡¨å•ç”¨åˆ°ã€‚ï¼ˆå¦‚ï¼šæœç´¢æ—¶è¦æŠŠæœç´¢çš„å†…å®¹ä¸€å¹¶å‘ç»™æœåŠ¡å™¨è¿›è¡Œå¤„ç†ï¼ˆåœ¨è¯·æ±‚URLåé¢å¢åŠ ç‰¹å®šçš„ç”¨æˆ·å‚æ•°ï¼‰ï¼Œä»¥è·å–ç‰¹å®šçš„å†…å®¹ï¼‰</p>
<p>æ³¨æ„ï¼š<strong>URLåé¢åŠ æ–œæ ä¸ä¸åŠ æ–œæ çš„åŒºåˆ«</strong>(æ–‡ä»¶å¤¹ä¸å•ä¸ªæ–‡ä»¶çš„åŒºåˆ«)<br><a href="http://www.facebook.com/" target="_blank" rel="external">http://www.facebook.com</a><br><a href="http://www.facebook.com/" target="_blank" rel="external">http://www.facebook.com/</a></p>
<p>å½“æˆ‘ä»¬è¾“å…¥<a href="http://www.facebook.com/" target="_blank" rel="external">http://www.facebook.com</a>æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨æ·»åŠ æ–œæ ï¼Œä¿è¯URLçš„ä¸¥è°¨ã€‚<br>å½“æˆ‘ä»¬è¾“å…¥ï¼š<a href="http://www.facebook.com/folderOrFile" target="_blank" rel="external">http://www.facebook.com/folderOrFile</a> æ—¶ï¼Œå› ä¸º<strong>æµè§ˆå™¨ä¸æ¸…æ¥šfolderOrFileåˆ°åº•æ˜¯æ–‡ä»¶å¤¹è¿˜æ˜¯æ–‡ä»¶</strong>ï¼Œæ‰€ä»¥<strong>ä¸èƒ½è‡ªåŠ¨æ·»åŠ  æ–œæ </strong>ã€‚è¿™æ—¶ï¼Œæµè§ˆå™¨å°±ä¸åŠ æ–œæ ç›´æ¥è®¿é—®åœ°å€ï¼ŒæœåŠ¡å™¨ä¼š<strong>å“åº”ä¸€ä¸ªé‡å®šå‘</strong>ï¼Œç»“æœé€ æˆä¸€æ¬¡<strong>ä¸å¿…è¦çš„æ¡æ‰‹</strong>ã€‚</p>
<h3 id="4-é‡å®šå‘"><a href="#4-é‡å®šå‘" class="headerlink" title="4. é‡å®šå‘"></a><strong>4. é‡å®šå‘</strong></h3><p>å½“æˆ‘ä»¬è¾“å…¥ä¸å®Œæ•´çš„ç½‘å€ï¼ˆ<a href="http://facebook.com/" target="_blank" rel="external">http://facebook.com</a>ï¼‰æ—¶ï¼Œæˆ–è€…ç½‘ç«™è¿ç§»åšäº†é‡å®šå‘è®¾ç½®æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè¿›è¡Œä¸€æ¬¡é‡å®šå‘å“åº”ã€‚<br>ä¸‹é¢æ˜¯é‡å®šå‘ä¹‹åè¿”å›çš„å“åº”å¤´ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 301 Moved Permanently  </div><div class="line">Cache-Control: private, no-store, no-cache, must-revalidate, post-check=0,</div><div class="line">pre-check=0</div><div class="line">Expires: Sat, 01 Jan 2000 00:00:00 GMT</div><div class="line">Location: http://www.facebook.com/</div><div class="line">P3P: CP=&quot;DSP LAW&quot;</div><div class="line">Pragma: no-cache</div><div class="line">Set-Cookie: made_write_conn=deleted; expires=Thu, 12-Feb-2009 05:09:50 GMT;</div><div class="line">path=/; domain=.facebook.com; httponly</div><div class="line">Content-Type: text/html; charset=utf-8</div><div class="line">X-Cnection: close</div><div class="line">Date: Fri, 12 Feb 2010 05:09:51 GMT</div><div class="line">Content-Length: 0</div></pre></td></tr></table></figure>
<ol>
<li>301 æ°¸ä¹…é‡å®šå‘ </li>
<li>æ–°çš„Locationï¼šâ€¦â€¦</li>
</ol>
<p><strong>ä¸ºä»€ä¹ˆè¦é‡å®šå‘ï¼Œè€Œä¸ç›´æ¥è¿”å›ç”¨æˆ·æƒ³çœ‹çš„å†…å®¹å‘¢ï¼Ÿï¼ˆæ—¢ç„¶æœåŠ¡å™¨å·²ç»ç»è¿‡é‡å®šå‘çŸ¥é“äº†ç”¨æˆ·éœ€è¦ä»€ä¹ˆï¼‰</strong><br>ç­”ï¼šåŸå› ä¹‹ä¸€ï¼šä¸æœç´¢å¼•æ“æ’åæœ‰å…³ã€‚ä½ çœ‹ï¼Œå¦‚æœä¸€ä¸ªé¡µé¢æœ‰ä¸¤ä¸ªåœ°å€ï¼Œå°±åƒ<a href="http://www.igoro.com/" target="_blank" rel="external">http://www.igoro.com/</a> å’Œ<a href="http://igoro.com/" target="_blank" rel="external">http://igoro.com/</a>ï¼Œæœç´¢å¼•æ“ä¼šè®¤ä¸ºå®ƒä»¬æ˜¯ä¸¤ä¸ªç½‘ç«™ï¼Œç»“æœé€ æˆæ¯ä¸€ä¸ªçš„æœç´¢é“¾æ¥éƒ½å‡å°‘ä»è€Œé™ä½æ’åã€‚è€Œæœç´¢å¼•æ“çŸ¥é“301æ°¸ä¹…é‡å®šå‘æ˜¯ ä»€ä¹ˆæ„æ€ï¼Œè¿™æ ·å°±ä¼šæŠŠè®¿é—®å¸¦wwwçš„å’Œä¸å¸¦wwwçš„åœ°å€å½’åˆ°åŒä¸€ä¸ªç½‘ç«™æ’åä¸‹ã€‚è¿˜æœ‰ä¸€ä¸ªæ˜¯ç”¨ä¸åŒçš„åœ°å€ä¼šé€ æˆç¼“å­˜å‹å¥½æ€§å˜å·®ã€‚å½“ä¸€ä¸ªé¡µé¢æœ‰å¥½å‡ ä¸ªåå­—æ—¶ï¼Œå®ƒå¯èƒ½ä¼šåœ¨ç¼“å­˜é‡Œå‡ºç°å¥½å‡ æ¬¡ã€‚</p>
<h3 id="5-æ–°çš„è¯·æ±‚"><a href="#5-æ–°çš„è¯·æ±‚" class="headerlink" title="5. æ–°çš„è¯·æ±‚"></a><strong>5. æ–°çš„è¯·æ±‚</strong></h3><p>é‡å®šå‘ä¹‹åä¼šå‘å¸ƒä¸€ä¸ªæ–°çš„è·å–è¯·æ±‚</p>
<h3 id="6-æœåŠ¡å™¨å¤„ç†è¯·æ±‚"><a href="#6-æœåŠ¡å™¨å¤„ç†è¯·æ±‚" class="headerlink" title="6. æœåŠ¡å™¨å¤„ç†è¯·æ±‚"></a><strong>6. æœåŠ¡å™¨å¤„ç†è¯·æ±‚</strong></h3><h4 id="6-1-webæœåŠ¡å™¨è½¯ä»¶"><a href="#6-1-webæœåŠ¡å™¨è½¯ä»¶" class="headerlink" title="6.1 webæœåŠ¡å™¨è½¯ä»¶"></a><strong>6.1 webæœåŠ¡å™¨è½¯ä»¶</strong></h4><ul>
<li>æœåŠ¡å™¨æ“ä½œç³»ç»Ÿç§ç±»ï¼šLinuxï¼ˆä¸€èˆ¬æ˜¯å‚å®¶æ ¹æ®å¼€æºå®šåˆ¶ï¼‰ã€windows serverç³»åˆ—ï¼ˆå¾®è½¯ï¼‰</li>
<li>ä¸»è¦çš„æœåŠ¡å™¨è½¯ä»¶ï¼šIISã€Apacheã€Tomcatã€JBOSSã€Nginxã€lighttpdã€Tetty</li>
<li>æœåŠ¡å™¨è½¯ä»¶çš„ä½œç”¨ï¼šæ¥æ”¶ã€å¤„ç†ä¸å“åº”è¯·æ±‚ï¼ˆäº†è§£CGIçš„ä½œç”¨ï¼‰</li>
</ul>
<h4 id="6-2-å¤„ç†æµç¨‹ï¼š"><a href="#6-2-å¤„ç†æµç¨‹ï¼š" class="headerlink" title="6.2 å¤„ç†æµç¨‹ï¼š"></a><strong>6.2 å¤„ç†æµç¨‹ï¼š</strong></h4><ol>
<li>webæœåŠ¡å™¨è½¯ä»¶ï¼ˆå¦‚IISæˆ–è€…Apacheï¼‰æ¥æ”¶åˆ°HTTPè¯·æ±‚</li>
<li>ç¡®å®šæ‰§è¡Œé‚£ä¸ª<strong>è¯·æ±‚å¤„ç†ç¨‹åº</strong>ï¼ˆä¸€ä¸ªèƒ½<strong>è¯»æ‡‚è¯·æ±‚</strong>å¹¶ä¸”<strong>èƒ½ç”ŸæˆHTML</strong>æ¥è¿›è¡Œå“åº”çš„ç¨‹åºï¼‰ï¼ˆä¾‹å¦‚ï¼šjavaï¼‰æ¥å¤„ç†å®ƒ</li>
<li>è¯·æ±‚å¤„ç†å™¨<strong>é˜…è¯»è¯·æ±‚å¤´çš„å‚æ•°å’Œcookiesä¿¡æ¯</strong></li>
<li>æ›´æ–°æœåŠ¡å™¨ä¸Šçš„ä¿¡æ¯ï¼šä¾‹å¦‚æ›´æ–°æ•°æ®åº“ä¿¡æ¯</li>
<li>ç”ŸæˆHTMLï¼Œå‹ç¼©ï¼ˆgzipæˆ–å…¶ä»–ï¼‰ï¼Œå“åº”è¯·æ±‚å‘é€ç»™ç”¨æˆ·</li>
</ol>
<h3 id="7-æœåŠ¡å™¨å‘å›ä¸€ä¸ªHTMLå“åº”"><a href="#7-æœåŠ¡å™¨å‘å›ä¸€ä¸ªHTMLå“åº”" class="headerlink" title="7. æœåŠ¡å™¨å‘å›ä¸€ä¸ªHTMLå“åº”"></a><strong>7. æœåŠ¡å™¨å‘å›ä¸€ä¸ªHTMLå“åº”</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">Cache-Control: private, no-store, no-cache, must-revalidate, post-check=0,</div><div class="line">pre-check=0</div><div class="line">Expires: Sat, 01 Jan 2000 00:00:00 GMT</div><div class="line">P3P: CP=&quot;DSP LAW&quot;</div><div class="line">Pragma: no-cache</div><div class="line">Content-Encoding: gzip</div><div class="line">Content-Type: text/html; charset=utf-8</div><div class="line">X-Cnection: close</div><div class="line">Transfer-Encoding: chunked</div><div class="line">Date: Fri, 12 Feb 2010 09:05:55 GMT</div><div class="line"></div><div class="line">2b3Tn@[...]</div></pre></td></tr></table></figure>
<p>å“åº”åŒ…æ‹¬å“åº”å¤´ï¼ˆå“åº”å‚æ•°ä¸ä¿¡æ¯ï¼‰ã€å“åº”bodyï¼ˆä¸»ä½“æ–‡ä»¶ï¼‰</p>
<p>å“åº”åŒ…é‡‡ç”¨ç‰¹å®šæ–¹æ³•å‹ç¼©ï¼Œæ•´ä¸ªå“åº”ä»¥blobç±»å‹ä¼ è¾“ï¼Œå“åº”å¤´æŒ‡ç¤ºå“åº”åŒ…ä»¥ä½•ç§æ–¹å¼å‹ç¼©</p>
<p>è¿™ä¸ªå“åº”å¤´ä¸é‡å®šå‘çš„å“åº”å¤´ä¸å¤ªä¸€æ ·ï¼Œè¿™ä¸ªå“åº”å¤´è¿˜åŒ…å«ç€<strong>ç¼“å­˜é€‰é¡¹</strong>ï¼Œ<strong>cookiesè®¾ç½®</strong>å’Œ<strong>éšç§ä¿¡æ¯</strong>ç­‰</p>
<p><strong>æ³¨æ„: æŠ¥å¤´ä¸­æŠŠContent-typeè®¾ç½®ä¸ºâ€œtext/htmlâ€ã€‚æŠ¥å¤´è®©æµè§ˆå™¨å°†è¯¥å“åº”å†…å®¹ä»¥HTMLå½¢å¼å‘ˆç°ï¼Œè€Œä¸æ˜¯ä»¥æ–‡ä»¶å½¢å¼ä¸‹è½½å®ƒã€‚æµè§ˆå™¨ä¼šæ ¹æ®æŠ¥å¤´ä¿¡æ¯å†³å®šå¦‚ä½•è§£é‡Šè¯¥å“åº”ï¼Œä¸è¿‡åŒæ—¶ä¹Ÿä¼šè€ƒè™‘åƒURLæ‰©å±•å†…å®¹ç­‰å…¶ä»–å› ç´ ã€‚</strong></p>
<h3 id="8-æµè§ˆå™¨å¼€å§‹æ˜¾ç¤ºHTML"><a href="#8-æµè§ˆå™¨å¼€å§‹æ˜¾ç¤ºHTML" class="headerlink" title="8. æµè§ˆå™¨å¼€å§‹æ˜¾ç¤ºHTML"></a><strong>8. æµè§ˆå™¨å¼€å§‹æ˜¾ç¤ºHTML</strong></h3><p>æµè§ˆå™¨åœ¨æ²¡æœ‰å®Œæ•´æ¥æ”¶å…¨éƒ¨HTMLæ–‡ä»¶ï¼Œå°±å·²ç»å¼€å§‹æ˜¾ç¤ºé¡µé¢äº†</p>
<h3 id="9-æµè§ˆå™¨è·å–å…¶ä»–æ–‡ä»¶"><a href="#9-æµè§ˆå™¨è·å–å…¶ä»–æ–‡ä»¶" class="headerlink" title="9. æµè§ˆå™¨è·å–å…¶ä»–æ–‡ä»¶"></a><strong>9. æµè§ˆå™¨è·å–å…¶ä»–æ–‡ä»¶</strong></h3><p>æµè§ˆå™¨è§£æHTMLé‡åˆ°éœ€è¦ä¸‹è½½çš„æ–‡ä»¶æ—¶ï¼Œä¾¿å†æ¬¡å‘æœåŠ¡å™¨ï¼ˆCDNï¼‰å‘é€è·å–æ–‡ä»¶çš„è¯·æ±‚ã€‚</p>
<p>ä¸‹é¢æ˜¯å‡ ä¸ªè®¿é—®facebook.comæ—¶éœ€è¦é‡è·å–çš„å‡ ä¸ªURLï¼š</p>
<p>å›¾ç‰‡</p>
<p><a href="http://static.ak.fbcdn.net/rsrc.php/z12E0/hash/8q2anwu7.gif" target="_blank" rel="external">http://static.ak.fbcdn.net/rsrc.php/z12E0/hash/8q2anwu7.gif</a></p>
<p><a href="http://static.ak.fbcdn.net/rsrc.php/zBS5C/hash/7hwy7at6.gif" target="_blank" rel="external">http://static.ak.fbcdn.net/rsrc.php/zBS5C/hash/7hwy7at6.gif</a></p>
<p>â€¦</p>
<p>CSS å¼æ ·è¡¨</p>
<p><a href="http://static.ak.fbcdn.net/rsrc.php/z448Z/hash/2plh8s4n.css" target="_blank" rel="external">http://static.ak.fbcdn.net/rsrc.php/z448Z/hash/2plh8s4n.css</a></p>
<p><a href="http://static.ak.fbcdn.net/rsrc.php/zANE1/hash/cvtutcee.css" target="_blank" rel="external">http://static.ak.fbcdn.net/rsrc.php/zANE1/hash/cvtutcee.css</a></p>
<p>â€¦</p>
<p>JavaScript æ–‡ä»¶</p>
<p><a href="http://static.ak.fbcdn.net/rsrc.php/zEMOA/hash/c8yzb6ub.js" target="_blank" rel="external">http://static.ak.fbcdn.net/rsrc.php/zEMOA/hash/c8yzb6ub.js</a></p>
<p><a href="http://static.ak.fbcdn.net/rsrc.php/z6R9L/hash/cq2lgbs8.js" target="_blank" rel="external">http://static.ak.fbcdn.net/rsrc.php/z6R9L/hash/cq2lgbs8.js</a></p>
<p>â€¦</p>
<p>è¿™äº›åœ°å€éƒ½è¦ç»å†ä¸€ä¸ªå’ŒHTMLè¯»å–ç±»ä¼¼çš„è¿‡ç¨‹ã€‚æ‰€ä»¥æµè§ˆå™¨ä¼šåœ¨DNSä¸­æŸ¥æ‰¾è¿™äº›åŸŸåï¼Œå‘é€è¯·æ±‚ï¼Œé‡å®šå‘ç­‰ç­‰â€¦</p>
<p>ä½† ä¸åƒåŠ¨æ€é¡µé¢é‚£æ ·ï¼Œé™æ€æ–‡ä»¶ä¼šå…è®¸æµè§ˆå™¨å¯¹å…¶è¿›è¡Œç¼“å­˜ã€‚æœ‰çš„æ–‡ä»¶å¯èƒ½ä¼šä¸éœ€è¦ä¸æœåŠ¡å™¨é€šè®¯ï¼Œè€Œä»ç¼“å­˜ä¸­ç›´æ¥è¯»å–ã€‚æœåŠ¡å™¨çš„å“åº”ä¸­åŒ…å«äº†é™æ€æ–‡ä»¶ä¿å­˜çš„æœŸé™ ä¿¡æ¯ï¼Œæ‰€ä»¥æµè§ˆå™¨çŸ¥é“è¦æŠŠå®ƒä»¬ç¼“å­˜å¤šé•¿æ—¶é—´ã€‚è¿˜æœ‰ï¼Œæ¯ä¸ªå“åº”éƒ½å¯èƒ½åŒ…å«åƒç‰ˆæœ¬å·ä¸€æ ·å·¥ä½œçš„ETagå¤´ï¼ˆè¢«è¯·æ±‚å˜é‡çš„å®ä½“å€¼ï¼‰ï¼Œå¦‚æœæµè§ˆå™¨è§‚å¯Ÿåˆ°æ–‡ä»¶çš„ç‰ˆæœ¬ ETagä¿¡æ¯å·²ç»å­˜åœ¨ï¼Œå°±é©¬ä¸Šåœæ­¢è¿™ä¸ªæ–‡ä»¶çš„ä¼ è¾“ã€‚</p>
<p>è¯•ç€çŒœçŒœçœ‹â€œfbcdn.netâ€åœ¨åœ°å€ä¸­ä»£è¡¨ä»€ä¹ˆï¼Ÿèªæ˜çš„ç­”æ¡ˆæ˜¯â€Facebookå†…å®¹åˆ†å‘ç½‘ç»œâ€ã€‚Facebookåˆ©ç”¨å†…å®¹åˆ†å‘ç½‘ç»œï¼ˆCDNï¼‰åˆ†å‘åƒå›¾ç‰‡ï¼ŒCSSè¡¨å’ŒJavaScriptæ–‡ä»¶è¿™äº›é™æ€æ–‡ä»¶ã€‚æ‰€ä»¥ï¼Œè¿™äº›æ–‡ä»¶ä¼šåœ¨å…¨çƒå¾ˆå¤šCDNçš„æ•°æ®ä¸­å¿ƒä¸­ç•™ä¸‹å¤‡ä»½ã€‚</p>
<p>é™æ€å†…å®¹å¾€å¾€ä»£è¡¨ç«™ç‚¹çš„å¸¦å®½å¤§å°ï¼Œä¹Ÿèƒ½é€šè¿‡CDNè½»æ¾çš„å¤åˆ¶ã€‚é€šå¸¸ç½‘ç«™ä¼šä½¿ç”¨ç¬¬ä¸‰æ–¹çš„CDNã€‚ä¾‹å¦‚ï¼ŒFacebookçš„é™æ€æ–‡ä»¶ç”±æœ€å¤§çš„CDNæä¾›å•†Akamaiæ¥æ‰˜ç®¡ã€‚</p>
<p>ä¸¾ä¾‹æ¥è®²ï¼Œå½“ä½ è¯•ç€ping static.ak.fbcdn.netçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šä»æŸä¸ªakamai.netæœåŠ¡å™¨ä¸Šè·å¾—å“åº”ã€‚æœ‰æ„æ€çš„æ˜¯ï¼Œå½“ä½ åŒæ ·å†pingä¸€æ¬¡çš„æ—¶å€™ï¼Œå“åº”çš„æœåŠ¡å™¨å¯èƒ½å°±ä¸ä¸€æ ·ï¼Œè¿™è¯´æ˜å¹•åçš„è´Ÿè½½å¹³è¡¡å¼€å§‹èµ·ä½œç”¨äº†ã€‚</p>
<p><strong>æ³¨æ„ï¼š </strong></p>
<ol>
<li>åŠ¨æ€é¡µé¢æ— æ³•ç¼“å­˜ï¼Œé™æ€æ–‡ä»¶å…è®¸æµè§ˆå™¨è¿›è¡Œç¼“å­˜ã€‚ </li>
<li>é™æ€æ–‡ä»¶æœ¬åœ°æœ‰ç¼“å­˜æ—¶ç›´æ¥ä»æœ¬åœ°è¯»å– </li>
<li>è¯·æ±‚å“åº”å¤´å†…åŒ…å«ç€<strong>é™æ€æ–‡ä»¶ä¿å­˜çš„æœŸé™</strong>ï¼Œæµè§ˆå™¨çŸ¥é“ä¸‹è½½çš„é™æ€æ–‡ä»¶è¦é™é»˜ä¿ç•™å¤šä¹…ã€‚ </li>
<li>å“åº”å¤´è¿˜ä¼šæœ‰é™æ€æ–‡ä»¶çš„ETagï¼ˆç›¸å½“äºç‰ˆæœ¬å·ï¼‰ï¼Œå½“æµè§ˆå™¨å‘ç°è¯·æ±‚çš„é™æ€æ–‡ä»¶çš„å“åº”å¤´çš„ETagä¸ç°æœ‰çš„ç¼“å­˜æ–‡ä»¶ä¸ç¬¦æ—¶ï¼Œä¾¿ä¼šå†æ¬¡å‘æœåŠ¡å™¨è·å–é™æ€æ–‡ä»¶ã€‚</li>
</ol>
<h3 id="10-æµè§ˆå™¨å‘é€å¼‚æ­¥ï¼ˆAJAXï¼‰è¯·æ±‚"><a href="#10-æµè§ˆå™¨å‘é€å¼‚æ­¥ï¼ˆAJAXï¼‰è¯·æ±‚" class="headerlink" title="10. æµè§ˆå™¨å‘é€å¼‚æ­¥ï¼ˆAJAXï¼‰è¯·æ±‚"></a><strong>10. æµè§ˆå™¨å‘é€å¼‚æ­¥ï¼ˆAJAXï¼‰è¯·æ±‚</strong></h3><p>ä»¥ FacebookèŠå¤©åŠŸèƒ½ä¸ºä¾‹ï¼Œå®ƒä¼šæŒç»­ä¸æœåŠ¡å™¨ä¿æŒè”ç³»æ¥åŠæ—¶æ›´æ–°ä½ é‚£äº›äº®äº®ç°ç°çš„å¥½å‹çŠ¶æ€ã€‚ä¸ºäº†æ›´æ–°è¿™äº›å¤´åƒäº®ç€çš„å¥½å‹çŠ¶æ€ï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰§è¡Œçš„ JavaScriptä»£ç ä¼šç»™æœåŠ¡å™¨å‘é€å¼‚æ­¥è¯·æ±‚ã€‚è¿™ä¸ªå¼‚æ­¥è¯·æ±‚å‘é€ç»™ç‰¹å®šçš„åœ°å€ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‰ç…§ç¨‹å¼æ„é€ çš„è·å–æˆ–å‘é€è¯·æ±‚ã€‚è¿˜æ˜¯åœ¨Facebookè¿™ä¸ªä¾‹å­ä¸­ï¼Œå®¢æˆ·ç«¯å‘é€ç»™<a href="http://www.facebook.com/ajax/chat/buddy_list.phpä¸€ä¸ªå‘å¸ƒè¯·æ±‚æ¥è·å–ä½ å¥½å‹é‡Œå“ªä¸ªåœ¨çº¿çš„çŠ¶æ€ä¿¡æ¯ã€‚" target="_blank" rel="external">http://www.facebook.com/ajax/chat/buddy_list.phpä¸€ä¸ªå‘å¸ƒè¯·æ±‚æ¥è·å–ä½ å¥½å‹é‡Œå“ªä¸ªåœ¨çº¿çš„çŠ¶æ€ä¿¡æ¯ã€‚</a></p>
<p>FacebookèŠå¤©åŠŸèƒ½æä¾›äº†å…³äºAJAXä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜æ¡ˆä¾‹ï¼šæŠŠæ•°æ®ä»æœåŠ¡å™¨ç«¯æ¨é€åˆ°å®¢æˆ·ç«¯ã€‚å› ä¸ºHTTPæ˜¯ä¸€ä¸ªè¯·æ±‚-å“åº”åè®®ï¼Œæ‰€ä»¥èŠå¤©æœåŠ¡å™¨ä¸èƒ½æŠŠæ–°æ¶ˆæ¯å‘ç»™å®¢æˆ·ã€‚å–è€Œä»£ä¹‹çš„æ˜¯å®¢æˆ·ç«¯ä¸å¾—ä¸éš”å‡ ç§’å°±è½®è¯¢ä¸‹æœåŠ¡å™¨ç«¯çœ‹è‡ªå·±æœ‰æ²¡æœ‰æ–°æ¶ˆæ¯ã€‚</p>
<p>è¿™äº›æƒ…å†µå‘ç”Ÿæ—¶é•¿è½®è¯¢æ˜¯ä¸ªå‡è½»æœåŠ¡å™¨è´Ÿè½½æŒºæœ‰è¶£çš„æŠ€æœ¯ã€‚å¦‚æœå½“è¢«è½®è¯¢æ—¶æœåŠ¡å™¨æ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œå®ƒå°±ä¸ç†è¿™ä¸ªå®¢æˆ·ç«¯ã€‚è€Œå½“å°šæœªè¶…æ—¶çš„æƒ…å†µä¸‹æ”¶åˆ°äº†è¯¥å®¢æˆ·çš„æ–°æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨å°±ä¼šæ‰¾åˆ°æœªå®Œæˆçš„è¯·æ±‚ï¼ŒæŠŠæ–°æ¶ˆæ¯åšä¸ºå“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<p><strong>æ€»ç»“ï¼š</strong></p>
<ul>
<li>web 2.0çš„ä¸€å¤§ç‰¹å¾å°±æ˜¯é¡µé¢æ˜¾ç¤ºå®Œå…¨åå®¢æˆ·ç«¯ä»æ—§ä¸æœåŠ¡å™¨ç«¯ä¿æŒè”ç³»ï¼ˆkeep-aliveï¼‰</li>
<li>æµè§ˆå™¨æ‰§è¡Œç‰¹å®šçš„JSä»£ç ä¼šç»™æœåŠ¡å™¨å‘é€<strong>å¼‚æ­¥è¯·æ±‚</strong>ï¼Œè·å–æœ€æ–°çš„åŠ¨æ€æ¶ˆæ¯ï¼Œä½¿å¾—é¡µé¢èƒ½ä¿æŒè¾ƒæ–°çš„çŠ¶æ€ã€‚</li>
<li>HTTPæ˜¯ä¸€ä¸ª<strong>è¯·æ±‚-å“åº”åè®®</strong>ï¼Œåªæœ‰åœ¨å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯æ‰èƒ½åšå‡ºå“åº”ï¼Œè€Œä¸èƒ½ä¸»åŠ¨æŠŠæ¶ˆæ¯æˆ–è€…æ–‡æ¡£å‘ç»™å®¢æˆ·</li>
<li>æ‰€ä»¥ï¼Œè¦æƒ³ä¿æŒé¡µé¢å¤„äºæœ€æ–°çš„çŠ¶æ€ï¼Œéœ€è¦<strong>å®šæ—¶è¿›è¡Œè½®è¯¢</strong>ï¼ˆå®šæ—¶å‘é€AJAXè¯·æ±‚ä»¥æ›´æ–°é¡µé¢å†…å®¹ï¼‰</li>
<li>AJAXè¯·æ±‚ååˆ†å®¹æ˜“æ›´æ”¹ï¼Œä¸”ç”¨æˆ·ååˆ†å®¹æ˜“è‡ªå·±åˆ¶é€ å’Œå‘é€AJAXè¯·æ±‚ï¼Œæ‰€ä»¥æ²¡æœ‰éªŒè¯ç çš„æ²¡æœ‰IPé™åˆ¶æ¡ä»¶çš„æŠ•ç¥¨å°±æ˜¯ä¸€ä¸ªå°æ¸¸æˆäº†ï¼ˆå‚ç…§å·¥ä½œå®¤ä¸¤æ¬¡åˆ·ç¥¨ï¼šè‡ªå·±å®šä¹‰IPï¼Œè‡ªå·±å®šæ—¶å‘é€AJAXè¯·æ±‚ï¼Œç„¶åç¥¨å°±å“—å“—çš„ä¸Šäº†ï¼‰ã€‚</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[gitlab-ci]]></title>
      <url>http://zsr.github.io/2016/09/08/gitlab-ci/</url>
      <content type="html"><![CDATA[<h3 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1. èƒŒæ™¯"></a><strong>1. èƒŒæ™¯</strong></h3><p>å›¢é˜Ÿå¼€å‘é¡¹ç›®é‡åˆ°çš„é—®é¢˜ï¼š</p>
<ul>
<li>ç‰ˆæœ¬æ›´æ–°è¾ƒä¸ºé¢‘ç¹çš„é—®é¢˜ã€‚</li>
<li>æµ‹è¯•è¦†ç›–ä¸åˆ°ä½çš„é—®é¢˜ã€‚</li>
</ul>
<h3 id="2-Jenkinså’ŒGitlab-CIçš„ç®€å•æ¯”è¾ƒ"><a href="#2-Jenkinså’ŒGitlab-CIçš„ç®€å•æ¯”è¾ƒ" class="headerlink" title="2. Jenkinså’ŒGitlab CIçš„ç®€å•æ¯”è¾ƒ"></a><strong>2. Jenkinså’ŒGitlab CIçš„ç®€å•æ¯”è¾ƒ</strong></h3><p>Jenkinsæ˜¯è€ç‰ŒæŒç»­é›†æˆå¼€æºå¹³å°ï¼š</p>
<ul>
<li>ä¼˜ç‚¹ï¼šç°åœ¨å·²ç»å‘å±•åˆ°2.0ï¼Œå„ç§åŠŸèƒ½æ’ä»¶éå¸¸ä¸°å¯Œï¼Œæ”¯æŒgroovyç¼–å†™è„šæœ¬ï¼Œå°¤å…¶æ”¯æŒLDAPç­‰ä¸ä¼ä¸šé›†æˆçš„åŠŸèƒ½ï¼ŒåŸºæœ¬ä¸Šæ˜¯CIçš„ä¸äºŒä¹‹é€‰ã€‚</li>
<li>ç¼ºç‚¹ï¼šç•Œé¢ä¸‘é™‹ï¼Œé…ç½®ç›¸å¯¹å¤æ‚ï¼Œä¸€èˆ¬éœ€è¦ä¸“é—¨çš„ITè¿ç»´äººå‘˜ç»´æŠ¤ï¼Œä¸ä»£ç ç®¡ç†å¹³å°ç»“åˆåº¦ç›¸å¯¹è¾ƒä½ï¼Œå¯¹Dockeræ”¯æŒéœ€è¦å®‰è£…é¢å¤–çš„æ’ä»¶ã€‚</li>
</ul>
<p>Gitlab CIï¼Œæ–°é”CIå¹³å°ï¼š</p>
<ul>
<li>ä¼˜ç‚¹ï¼šç•Œé¢ç¾è§‚ï¼ŒåŸç”Ÿæ”¯æŒdockeråŠå¤šç§æœºåˆ¶ï¼Œä¸ä»£ç ç®¡ç†å·¥å…·ç»“åˆåº¦éå¸¸é«˜ï¼Œé…ç½®ç®€å•ï¼Œä½¿ç”¨YAMLè¯­è¨€ï¼Œç¨‹åºå‘˜å³å¯ç¼–å†™è‡ªåŠ¨ç¼–è¯‘è„šæœ¬ã€‚</li>
<li>ç¼ºç‚¹ï¼šæ§åˆ¶æ€§ä¸å¤Ÿå¥½ï¼Œç”Ÿæ€è¿˜ä¸å¤Ÿé½å…¨ï¼ŒYAMLæœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œå¤æ‚ä»»åŠ¡éœ€è¦äº›shellå®Œæˆã€‚</li>
</ul>
<p><strong>Jenkinsé€‚åˆå¤æ‚é›†æˆä»»åŠ¡ï¼Œè€ŒGitlab CIé€‚åˆç›¸å¯¹ç®€å•çš„æŒç»­é›†æˆã€‚</strong></p>
<p>ä¼ä¸šä¸­ä¸€èˆ¬ä¼š2ä¸ªåŒæ—¶ä½¿ç”¨ï¼Œè€Œä¸¤è€…çš„åˆ†å·¥å¯ä»¥ä¸ºï¼š</p>
<ul>
<li>developç¯å¢ƒï¼Œç›´æ¥ä½¿ç”¨Gitlab CIåšæŒç»­çš„ç¼–è¯‘ã€æµ‹è¯•ã€å¼€å‘ç¯å¢ƒéƒ¨ç½²ã€APIæµ‹è¯•ã€å®¢æˆ·ç«¯æ‰“åŒ…ç­‰å·¥ä½œ</li>
<li>stagingå’Œproductionç¯å¢ƒï¼Œä½¿ç”¨Gitlab CI+Jenkinsè¾…åŠ©é…åˆçš„æ–¹å¼ï¼Œæˆ–è€…ç›´æ¥ç”±jenkinså…¨åŒ…ï¼Œå› ä¸ºä¸Šçº¿ä¼šæ¶‰åŠåˆ°ä¸åŒç‰ˆæœ¬çš„èµ„æºæ›´æ”¹ã€æ ¹æ®å‚æ•°è°ƒæ•´ç¼–è¯‘å’Œæ‰“åŒ…ç­‰ç›¸å¯¹å¤æ‚çš„ä»»åŠ¡ï¼Œè¿™æ—¶Gitlab CIå°±ä¼šç›¸å½¢è§è‚˜äº†ï¼Œè™½ç„¶å¯ä»¥è‡ªå·±å†™Shellæ¥æ”¯æŒï¼Œä½†æ§åˆ¶æ€§ï¼ˆå¦‚é¸¡è‚‹çš„triggerï¼‰å·®å¼ºäººæ„</li>
</ul>
<h3 id="3-é¡¹ç›®ä¸­çš„ä½¿ç”¨"><a href="#3-é¡¹ç›®ä¸­çš„ä½¿ç”¨" class="headerlink" title="3. é¡¹ç›®ä¸­çš„ä½¿ç”¨"></a><strong>3. é¡¹ç›®ä¸­çš„ä½¿ç”¨</strong></h3><p>é¡¹ç›®ä¸­ä¼šä½¿ç”¨J2EE, å¤§è‡´é˜¶æ®µåˆ†ä¸ºï¼šä»£ç æ£€è§†ã€ç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…ã€éƒ¨ç½²ã€‚</p>
<p>devç¯å¢ƒï¼Œå‡ä½¿ç”¨Gitlab CIï¼Œæ¯”è¾ƒç®€å•ï¼Œå¯ä»¥ç›´æ¥æŸ¥è¯¢Gitlab CIæ–‡æ¡£ï¼Œå¦‚æœç”¨è¿‡Travis CIï¼Œå¯¹äºGitlab CIå°±æ›´ä¸ä¼šæœ‰é—®é¢˜äº†ã€‚</p>
<p>stagingå’Œproductionç¯å¢ƒï¼Œé€‰ç”¨Gitlab CI+Jenkinsæ··åˆçš„æ¨¡å¼ï¼Œå…·ä½“é˜¶æ®µåˆ†å·¥ä¸ºï¼š</p>
<ul>
<li>Gitlab CIè´Ÿè´£ï¼šä»£ç æ£€è§†ã€ç¼–è¯‘ã€æ‰“åŒ…ã€æµ‹è¯•</li>
<li>Jenkinsè´Ÿè´£ï¼šæ‰“åŒ…ï¼ˆä¸»è¦æ˜¯èµ„æºæ›¿æ¢ï¼‰ã€éƒ¨ç½²</li>
</ul>
<p><strong>åœ¨gitlabä¸­å®ŒæˆæŒç»­é›†æˆCIåŒ…æ‹¬ä¸¤ä¸ªæ“ä½œï¼š</strong></p>
<ul>
<li>é…ç½®ä¸€ä¸ªRunner(ç”¨æ¥ç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…çš„æœåŠ¡å™¨èŠ‚ç‚¹)ã€‚</li>
<li>åœ¨é¡¹ç›®æ ¹ç›®å½•å¢åŠ <a href="https://en.wikipedia.org/wiki/YAML" target="_blank" rel="external">YAML</a>æ ¼å¼çš„CIè„šæœ¬æ–‡ä»¶<code>.gitlab-ci.yml</code>ã€‚</li>
</ul>
<h4 id="3-1-install-configue-gitlab-ci-multi-runner"><a href="#3-1-install-configue-gitlab-ci-multi-runner" class="headerlink" title="3.1 install configue gitlab-ci-multi-runner"></a><strong>3.1 install configue <code>gitlab-ci-multi-runner</code></strong></h4><ul>
<li><p><strong>GitLab éƒ¨ç½² CI çš„ç¬¬ä¸€æ­¥å°±æ˜¯å®‰è£… gitlab-ci-multi-runnerï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºï¼šè·‘ CI çš„æœåŠ¡ã€‚</strong></p>
<p>å°†ä¸€å°macè®¡ç®—æœºé…ç½®æˆæˆ‘ä»¬çš„ä¸€ä¸ªRunnerï¼ŒåŸºæœ¬åŸç†å°±æ˜¯åœ¨Macä¸Šå®‰è£…ä¸€ä¸ªä»£ç†ç¨‹åºgitlab-ci-multi-runnerï¼Œç„¶åå°†macæ³¨å†Œåˆ°gitlabæœåŠ¡å™¨ç«¯ï¼Œç„¶åè¿™å°macæœºå™¨å°±èƒ½æ¥æ”¶åˆ°gitlabæœåŠ¡å™¨ä¸‹å‘çš„CIä»»åŠ¡ï¼Œå®Œæˆç›¸åº”çš„ç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…ç­‰å·¥ä½œï¼Œç„¶åå°†ç»“æœåé¦ˆç»™gitlabæœåŠ¡å™¨ã€‚</p>
</li>
</ul>
<p>åœ¨ä¸€å°Macæœºå™¨ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å®‰è£…gitlab-ci-multi-runner:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo curl --output /usr/local/bin/gitlab-ci-multi-runner https://gitlab-ci-multi-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-ci-multi-runner-darwin-amd64</div><div class="line"></div><div class="line">sudo chmod +x /usr/local/bin/gitlab-ci-multi-runner</div></pre></td></tr></table></figure>
<ul>
<li><strong>è¿›å…¥é¡¹ç›®çš„Runneré…ç½®é¡µé¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</strong></li>
</ul>
<p><img src="http://img.blog.csdn.net/20160805110318437" alt="gitlab_config_runner"></p>
<ul>
<li><strong>åœ¨Macæœºå™¨ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå°†è¿™å°Macæ³¨å†Œåˆ°gitlabå¹¶ç»‘å®šåˆ°æˆ‘ä»¬ç¤ºä¾‹é¡¹ç›®ã€‚</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">gitlab-ci-multi-runner register</div><div class="line">#Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/ci):</div><div class="line">##è¾“å…¥ä¸Šå›¾ä¸­çš„URL.</div><div class="line">#Please enter the gitlab-ci token for this runner:</div><div class="line">##è¾“å…¥ä¸Šå›¾ä¸­çš„token.</div><div class="line">#Please enter the gitlab-ci description for this runner:</div><div class="line">##è¾“å…¥ä¸€ä¸ªæè¿°ä¿¡æ¯ï¼Œè¿™é‡Œæˆ‘ä»¬è¾“å…¥mac_runner</div><div class="line">#Please enter the gitlab-ci tags for this runner (comma separated):</div><div class="line">##è¾“å…¥ä¸€äº›æ ‡ç­¾ï¼Œè¿™é‡Œæˆ‘ä»¬è¾“å…¥&quot;mac,xcode7.1&quot;</div><div class="line"># Registering runner... succeeded runner=euasz2j9 </div><div class="line">#Please enter the executor: docker-ssh+machine, docker, docker-ssh, parallels, shell, ssh, virtualbox, docker+machine:</div><div class="line">##è¿™é‡Œæˆ‘ä»¬è¾“å…¥shellï¼Œå› ä¸ºiosé¡¹ç›®çš„ç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…æˆ‘ä»¬éƒ½é‡‡ç”¨è„šæœ¬æ¥æ‰§è¡Œã€‚</div><div class="line">#Runner registered successfully. Feel free to start it, but if it&apos;s running already the config should be automatically reloaded!</div><div class="line"></div><div class="line">#æ³¨å†ŒæˆåŠŸï¼Œæ¥ä¸‹æ¥å¯åŠ¨å®ƒ</div><div class="line">gitlab-ci-multi-runner install </div><div class="line">gitlab-ci-multi-runner start</div></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬çš„Macæœºå™¨å°±æ³¨å†Œä¸ºä¸€ä¸ªRunneräº†ï¼ŒæŸ¥çœ‹é¡¹ç›®çš„Runneré¡µé¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://img.blog.csdn.net/20160805110339094" alt="gitlab_runner_running"></p>
<p>æˆ‘ä»¬çš„Runnerå°±æˆåŠŸæ³¨å†Œä¸Šäº†ã€‚æ¥ä¸‹æ¥å°±å¯ä»¥ç¼–å†™CIçš„è„šæœ¬äº†ã€‚</p>
<ul>
<li><strong>å¢åŠ CIè„šæœ¬æ–‡ä»¶<code>.gitlab-ci.yml</code></strong></li>
</ul>
<p>åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º<code>.gitlab-ci.yml</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">before_script:</div><div class="line">  - export JAVA_HOME=/usr/local/jdk1.7.0_79</div><div class="line"></div><div class="line">job:</div><div class="line">  only:</div><div class="line">    - master(æ¯ä¸€æ¬¡æäº¤åˆ°masteråˆ†æ”¯è§¦å‘script)</div><div class="line"></div><div class="line">  script: </div><div class="line">    - mvn clean package -Ptest -q -Dmaven.javadoc.skip=true</div></pre></td></tr></table></figure>
<p><code>before_script</code> éƒ¨åˆ†å°†åœ¨æ¯ä¸€ä¸ªjobå‰è¢«æ‰§è¡Œã€‚æ¯ä¸ªjobåŒ…å«çš„å‚æ•°ï¼Œä¾‹å¦‚<code>script</code> ï¼ˆshell scriptï¼‰ã€<code>tags</code> ï¼ˆåªæœ‰è¿è¡Œè¿™ä¸ªtag/tagsæ‰å…è®¸é€‰æ‹©è¿™ä¸ªæ„å»ºï¼‰ï¼Œä»¥åŠ<code>only</code> æˆ–<code>except</code> å‚æ•°æ¥å®šä¹‰å…è®¸è¿è¡Œæ„å»ºçš„åˆ†æ”¯åç§°ã€‚<code>only</code> éƒ¨åˆ†ä¼˜å…ˆäº â€œexceptâ€ã€‚å‚è§ï¼š<a href="http://doc.gitlab.com/ci/builds_configuration/README.html" target="_blank" rel="external">Configuration of your builds with .gitlab-ci.yml</a></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ**"></a>å‚è€ƒ**</h3><ul>
<li><a href="http://www.ruanyifeng.com/blog/2015/09/continuous-integration.html" target="_blank" rel="external">æŒç»­é›†æˆæ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[å¼€é—­åŸåˆ™]]></title>
      <url>http://zsr.github.io/2016/09/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%85%AD%E5%A4%A7%E5%8E%9F%E5%88%99-%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99/</url>
      <content type="html"><![CDATA[<p>å¼€é—­åŸåˆ™æ˜¯è®¾è®¡æ¨¡å¼å…­å¤§åŸåˆ™ä¸­æœ€é‡è¦ä¹Ÿæ˜¯æœ€â€œè™šâ€çš„ä¸€ä¸ªåŸåˆ™ã€‚ä¸ºä»€ä¹ˆè¯´å®ƒæœ€é‡è¦å‘¢ï¼Ÿå› ä¸ºå‰é¢äº”å¤§åŸåˆ™çš„ç›®çš„éƒ½æ˜¯ä¸ºäº†å®ç°è¿™ä¸ªå¼€é—­åŸåˆ™ï¼Œå¼€é—­åŸåˆ™ç›¸å½“äºå®ƒä»¬çš„ä¸»æ—¨æ€æƒ³ã€‚ä¸ºä»€ä¹ˆè¯´å®ƒâ€œè™šâ€å‘¢ï¼Ÿå› ä¸ºå¼€é—­åŸåˆ™åªæ˜¯ä¸ªæŒ‡å¯¼æ€æƒ³ï¼Œä¸åƒå¦å¤–äº”å¤§åŸåˆ™éƒ½æœ‰å…·ä½“å¯è¡Œçš„æŒ‡å¯¼æ–¹æ³•ã€‚</p>
<h3 id="1ã€ä»€ä¹ˆæ˜¯å¼€é—­åŸåˆ™"><a href="#1ã€ä»€ä¹ˆæ˜¯å¼€é—­åŸåˆ™" class="headerlink" title="1ã€ä»€ä¹ˆæ˜¯å¼€é—­åŸåˆ™"></a><strong>1ã€ä»€ä¹ˆæ˜¯å¼€é—­åŸåˆ™</strong></h3><p>Software entities like classes, modules and functions shoule be open for extension but closed for modifications.ï¼ˆä¸€ä¸ªè½¯ä»¶å®ä½“å¦‚ç±»ï¼Œæ¨¡å—å’Œå‡½æ•°åº”è¯¥å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚ï¼‰</p>
<p>å¼€é—­åŸåˆ™çš„å®šä¹‰å¾ˆçŸ­ï¼Œå°±æ˜¯å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆè¦éµå®ˆè¿™ä¸€ä¸ªåŸåˆ™å‘¢ï¼Ÿ</p>
<p>åšè¿‡å®é™…é¡¹ç›®çš„ç­’å­ä»¬åº”è¯¥éƒ½ä¼šæ·±æœ‰ä½“ä¼šï¼Œä¸€ä¸ªè½¯ä»¶åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…éƒ½ä¼šå‘ç”Ÿå¾ˆå¤šå˜åŒ–ï¼Œè¿™å‡ ä¹æ˜¯ä¸å¯é¿å…çš„ã€‚æ— è®ºæ˜¯éœ€æ±‚çš„å˜åŒ–ã€ä¸šåŠ¡é€»è¾‘çš„å˜åŒ–ã€ç¨‹åºä»£ç çš„å˜åŒ–ç­‰ç­‰ï¼Œè¿™äº›å˜åŒ–éƒ½æœ‰å¯èƒ½å¯¹æ•´ä¸ªè½¯ä»¶çš„ç¨³å®šæ€§é€ æˆä¸€å®šçš„å¨èƒã€‚</p>
<p>è€Œå¼€é—­åŸåˆ™å°±æ˜¯åº”å¯¹è¿™äº›å˜åŒ–çš„ï¼Œå®ƒå‘Šè¯‰æˆ‘ä»¬åº”è¯¥é€šè¿‡æ‰©å±•æ¥å®ç°å˜åŒ–ï¼Œè€Œä¸æ˜¯é€šè¿‡ä¿®æ”¹å·²æœ‰çš„ä»£ç ã€‚</p>
<h3 id="2ã€ä¾‹å­"><a href="#2ã€ä¾‹å­" class="headerlink" title="2ã€ä¾‹å­"></a><strong>2ã€ä¾‹å­</strong></h3><p>UMLç±»å›¾ï¼š</p>
<p><img src="http://7u2i08.com1.z0.glb.clouddn.com/design-pattern/open-close-principle1.png" alt="img"></p>
<p>ç¨‹åºä»£ç å¦‚ä¸‹ï¼š</p>
<ol>
<li>å­¦ç”Ÿç±»ï¼Œæ¯ä¸ªå­¦ç”Ÿéƒ½æœ‰å§“åå’Œæˆç»©ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> String name;</div><div class="line">  <span class="keyword">private</span> String grade;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(String name, String grade)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.name = name;</div><div class="line">      <span class="keyword">this</span>.grade = grade;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getGrade</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> grade;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>è€å¸ˆç±»ï¼Œæ¯ä¸ªè€å¸ˆç®¡ç†ä¸€ç¾¤çš„å­¦ç”Ÿï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Teacher</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> List&lt;Student&gt; students = <span class="keyword">new</span> ArrayList&lt;Student&gt;();</div><div class="line"></div><div class="line">  <span class="keyword">static</span> &#123;</div><div class="line">      students.add(<span class="keyword">new</span> Student(<span class="string">"å¼ ä¸‰"</span>, <span class="string">"60"</span>));</div><div class="line">      students.add(<span class="keyword">new</span> Student(<span class="string">"æå››"</span>, <span class="string">"70"</span>));</div><div class="line">      students.add(<span class="keyword">new</span> Student(<span class="string">"ç‹äº”"</span>, <span class="string">"80"</span>));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>åœºæ™¯ç±»ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">      Teacher teacher = <span class="keyword">new</span> Teacher();</div><div class="line">      <span class="keyword">for</span> (Student student : teacher.students) &#123;</div><div class="line">          System.out.println(<span class="string">"å§“åï¼š"</span> + student.getName() + <span class="string">" æˆç»©ï¼š"</span> + student.getGrade());</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">å§“åï¼šå¼ ä¸‰ æˆç»©ï¼š60</div><div class="line">å§“åï¼šæå›› æˆç»©ï¼š70</div><div class="line">å§“åï¼šç‹äº” æˆç»©ï¼š80</div></pre></td></tr></table></figure>
<h4 id="æ›´æ”¹éœ€æ±‚"><a href="#æ›´æ”¹éœ€æ±‚" class="headerlink" title="æ›´æ”¹éœ€æ±‚"></a><strong>æ›´æ”¹éœ€æ±‚</strong></h4><p>æŠŠåŒå­¦ä»¬çš„æˆç»©æŒ‰ç…§çº§åˆ«æ¥åˆ†ï¼Œåˆ†åˆ«æœ‰ä¼˜ç§€ï¼Œè‰¯å¥½ï¼Œä¸€èˆ¬ï¼ŒåŠæ ¼ï¼Œä¸åŠæ ¼è¿™å‡ ç§ã€‚</p>
<p>ç›´æ¥ä¿®æ”¹Studentç±»çš„getGradeæ–¹æ³•ä¸å°±è¡Œäº†å˜›? å¯èƒ½æœ‰å¾ˆå¤šäººåœ¨å®é™…é¡¹ç›®ä¸­éƒ½æ˜¯è¿™ä¹ˆåšçš„ï¼Œä½†æ˜¯è¿™å°±è¿èƒŒäº†å¼€é—­åŸåˆ™ï¼Œå¼€é—­åŸåˆ™è¦æ±‚æˆ‘ä»¬å°½é‡ä¸è¦ä¿®æ”¹å·²æœ‰çš„ä»£ç ï¼Œå°½é‡é€šè¿‡æ‰©å±•æ¥å®ç°æ”¹å˜ã€‚</p>
<p>å¯ä»¥é€šè¿‡æ‰©å±•å·²æœ‰çš„ä»£ç æ¥å®ç°æ”¹å˜ï¼Œå¯ä»¥å¢åŠ ä¸€ä¸ªLevelStudentæ¥ç»§æ‰¿Studentï¼Œå¹¶æ‰©å±•ä¿®æ”¹getGradeæ–¹æ³•ã€‚</p>
<p>ä¿®æ”¹åçš„UMLç±»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://7u2i08.com1.z0.glb.clouddn.com/design-pattern/open-close-principle2.png" alt="img"></p>
<p>å¢åŠ LevelStudentç±»ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LevelStudent</span> <span class="keyword">extends</span> <span class="title">Student</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LevelStudent</span><span class="params">(String name, String grade)</span> </span>&#123;</div><div class="line">      <span class="keyword">super</span>(name, grade);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getGrade</span><span class="params">()</span> </span>&#123;</div><div class="line">      String level = <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">int</span> grade_ = Integer.valueOf(<span class="keyword">super</span>.getGrade());</div><div class="line">      <span class="keyword">if</span> (grade_ &gt;= <span class="number">90</span>) &#123;</div><div class="line">          level = <span class="string">"ä¼˜ç§€"</span>;</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (grade_ &gt;= <span class="number">80</span> &amp;&amp; grade_ &lt; <span class="number">90</span>) &#123;</div><div class="line">          level = <span class="string">"è‰¯å¥½"</span>;</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (grade_ &gt;= <span class="number">70</span> &amp;&amp; grade_ &lt; <span class="number">80</span>) &#123;</div><div class="line">          level = <span class="string">"ä¸€èˆ¬"</span>;</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (grade_ &gt;= <span class="number">60</span> &amp;&amp; grade_ &lt; <span class="number">70</span>) &#123;</div><div class="line">          level = <span class="string">"åŠæ ¼"</span>;</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (grade_ &lt; <span class="number">60</span>) &#123;</div><div class="line">          level = <span class="string">"ä¸åŠæ ¼"</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> level;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3ã€æ€»ç»“"><a href="#3ã€æ€»ç»“" class="headerlink" title="3ã€æ€»ç»“"></a><strong>3ã€æ€»ç»“</strong></h3><p>å¼€é—­åŸåˆ™æ˜¯å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚</p>
<p>å¼€é—­åŸåˆ™çš„ä¸»æ—¨æ˜¯ä¸ºäº†æ‹¥æŠ±å˜åŒ–ã€‚</p>
<p>åœ¨å…­å¤§åŸåˆ™ä¸­ï¼Œå¼€é—­åŸåˆ™åªæ˜¯ä¸€ä¸ªæ€æƒ³ï¼Œæ²¡æœ‰å…·ä½“å®é™…æ“ä½œæ–¹æ³•ã€‚å…¶ä»–äº”å¤§åŸåˆ™éƒ½æ˜¯ä¸ºäº†å®ç°è¿™ä¸ªå¼€é—­æ€æƒ³çš„ä¸€äº›æ–¹æ³•å’Œå·¥å…·ã€‚</p>
<p>æƒ³è¦éµå®ˆå¼€é—­åŸåˆ™ï¼Œå°±éœ€è¦ä¸€ä¸ªè®¾è®¡åˆç†çš„ç³»ç»Ÿã€‚å¯ä»¥è¯´åœ¨åšç³»ç»Ÿè®¾è®¡çš„æ—¶å€™å°±è¦è€ƒè™‘åˆ°æœªæ¥çš„æ‰©å±•å’Œæ”¹å˜ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[è¿ªç±³ç‰¹æ³•åˆ™]]></title>
      <url>http://zsr.github.io/2016/09/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%85%AD%E5%A4%A7%E5%8E%9F%E5%88%99-%E8%BF%AA%E7%B1%B3%E7%89%B9%E6%B3%95%E5%88%99/</url>
      <content type="html"><![CDATA[<p>è¿ªç±³ç‰¹æ³•åˆ™æœ‰å¾ˆå¤šç§è¯´æ³•ï¼Œæ¯”å¦‚ï¼šä¸€ä¸ªç±»åº”è¯¥åº”è¯¥å¯¹å…¶ä»–ç±»å°½å¯èƒ½äº†è§£å¾—æœ€å°‘ï¼›ç±»åªä¸ç›´æ¥çš„æœ‹å‹é€šä¿¡ç­‰ç­‰ã€‚ä½†æ˜¯å…¶æœ€ç»ˆç›®çš„åªæœ‰ä¸€ä¸ªï¼Œå°±æ˜¯è®©ç±»é—´è§£è€¦ã€‚</p>
<h3 id="1ã€ä»€ä¹ˆæ˜¯è¿ªç±³ç‰¹æ³•åˆ™"><a href="#1ã€ä»€ä¹ˆæ˜¯è¿ªç±³ç‰¹æ³•åˆ™" class="headerlink" title="1ã€ä»€ä¹ˆæ˜¯è¿ªç±³ç‰¹æ³•åˆ™"></a><strong>1ã€ä»€ä¹ˆæ˜¯è¿ªç±³ç‰¹æ³•åˆ™</strong></h3><p>è¿ªç±³ç‰¹æ³•åˆ™ï¼šLaw Of Demeterï¼ŒLoDã€‚</p>
<p>ä¹Ÿè¢«ç§°ä¸ºæœ€å°‘çŸ¥è¯†åŸåˆ™ï¼ŒLeast Knowledge Principleï¼ŒLKPã€‚</p>
<p>å°±æ˜¯è¯´ä¸€ä¸ªå¯¹è±¡åº”è¯¥å¯¹å…¶ä»–å¯¹è±¡ä¿æŒæœ€å°‘çš„äº†è§£ã€‚æ­£å¦‚æœ€å°‘çŸ¥è¯†åŸåˆ™è¿™ä¸ªå®šä¹‰ä¸€æ ·ï¼Œä¸€ä¸ªç±»åº”è¯¥å¯¹å…¶è€¦åˆçš„å…¶ä»–ç±»æˆ–æ‰€è°ƒç”¨çš„ç±»çŸ¥é“å¾—æœ€å°‘ã€‚æ‰€è€¦åˆçš„ç±»å†…éƒ¨æ— è®ºå¦‚ä½•å¤æ‚ï¼Œæ€ä¹ˆå®ç°çš„æˆ‘éƒ½ä¸éœ€è¦çŸ¥é“ï¼Œæˆ‘åªè°ƒç”¨ä½ publicå‡ºæ¥çš„è¿™äº›æ–¹æ³•ï¼Œå…¶ä»–éƒ½ä¸ç”¨çŸ¥é“ã€‚</p>
<p>å¦å¤–å¯ä»¥è§£é‡Šä¸€ä¸‹å¼€å¤´æåˆ°çš„åªä¸ç›´æ¥çš„æœ‹å‹é€šä¿¡ï¼Œä»€ä¹ˆå«ç›´æ¥çš„æœ‹å‹å‘¢ï¼Ÿ</p>
<h3 id="2ã€ä¾‹å­"><a href="#2ã€ä¾‹å­" class="headerlink" title="2ã€ä¾‹å­"></a><strong>2ã€ä¾‹å­</strong></h3><p>å…‰çœ‹å®šä¹‰å¯èƒ½æ— æ³•å®Œå…¨ç†è§£å®ƒæ‰€è¡¨è¾¾çš„å«ä¹‰ï¼Œä»¥åŠåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹æ‰éœ€è¦ä½¿ç”¨è¿™ä¸ªè¿ªç±³ç‰¹æ³•åˆ™ã€‚ç°åœ¨å°±æ¥ä¸¾ä¸ªä¾‹å­ã€‚</p>
<p>ç°åœ¨å¸‚é¢ä¸Šå„ç§äººè„‰ä¹¦ä¸Šå¾ˆå¤šéƒ½ä¼šæåˆ°â€œå…­åº¦äººè„‰â€è¿™ä¸ªç†è®ºï¼Œè¿™ä¸ªç†è®ºè¯´çš„æ˜¯ä½ ä¸ä¸–ç•Œä¸Šä»»ä½•ä¸€ä¸ªäººä¸­é—´åªéš”äº†å…­ä¸ªäººã€‚ä¹Ÿå°±æ˜¯è¯´ä½ æƒ³æ‰¾ä»»ä½•ä¸€ä¸ªäººï¼Œæ— è®ºè¿™ä¸ªäººæ˜¯æ”¿ç•Œè¦äººï¼Œè¿˜æ˜¯å•†ç•Œå·¨é³„ï¼ŒæŠ‘æˆ–æ˜¯æ˜æ˜Ÿåäººï¼Œä½ æœ€å¤šåªé€šè¿‡å…­ä¸ªäººå°±å¯ä»¥è”ç³»åˆ°ä»–ã€‚</p>
<p>æˆ‘ä»¬æš‚ä¸”ä¸è®ºè¿™ä¸ªç†è®ºæ˜¯å¯¹æ˜¯é”™ï¼Œåœ¨ç°å®ç”Ÿæ´»ä¸­æˆ‘ä»¬ä¹Ÿç»å¸¸é‡åˆ°è¿™æ ·çš„æƒ…å†µã€‚æ¯”å¦‚ä½ æƒ³åŠä¸€ä»¶äº‹æƒ…ï¼Œä½†æ˜¯å‡­å€Ÿä½ çš„èƒ½åŠ›æ˜¯åšä¸åˆ°çš„ï¼Œè€Œä½ å‘¨å›´çš„æœ‹å‹ä¹Ÿæ— æ³•å¸®ä½ åŠåˆ°ã€‚ä½†æ˜¯æ°å¥½ä½ æœ‰ä¸€ä¸ªæœ‹å‹è®¤è¯†æœ‰å¦å¤–ä¸€ä¸ªæœ‹å‹å¯ä»¥åŠå¾—æˆæ­¤äº‹ï¼Œé‚£ä¹ˆä½ åªæœ‰æ‹œæ‰˜ä½ è¿™ä½æœ‹å‹ä¸­é—´ç‰µçº¿æ­æ¡¥ï¼Œè®©ä»–çš„æœ‹å‹å¸®ä½ åŠå¥½æ­¤äº‹ã€‚</p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°±æš‚ä¸”å®šä¹‰ä½ ä¸ºAï¼Œä½ çš„æœ‹å‹ä¸ºBï¼Œä½ æœ‹å‹çš„æœ‹å‹ä¸ºCå¥½äº†ã€‚</p>
<ul>
<li><strong>åé¢æ•™æ</strong></li>
</ul>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¡¨è¾¾æ­¤ç§å…³ç³»çš„UMLç±»å›¾ï¼š</p>
<p><img src="http://7u2i08.com1.z0.glb.clouddn.com/design-pattern/law-of-demeter1.png" alt="img"></p>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç±»Aå’Œç±»Bæ˜¯å¥½æœ‹å‹ï¼Œèƒ½æ‰¾åˆ°ç±»Bæ¥å¸®å¿™ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> String name;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.name = name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> B <span class="title">getB</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> B(name);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</div><div class="line">      B b = getB(<span class="string">"æå››"</span>);</div><div class="line">      C c = b.getC(<span class="string">"ç‹äº”"</span>);</div><div class="line">      c.work();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>ç±»Bå’Œç±»Cæ˜¯å¥½æœ‹å‹ï¼Œèƒ½çŸ¥é“ç±»Cæ¥å¸®å¿™ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.name = name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> C <span class="title">getC</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> C(name);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>ç±»Cèƒ½å¤ŸåŠæˆæ­¤äº‹ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> String name;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">C</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.name = name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</div><div class="line">      System.out.println(name + <span class="string">"æŠŠè¿™ä»¶äº‹åšå¥½äº†"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>åœºæ™¯ç±»</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">      A a = <span class="keyword">new</span> A(<span class="string">"å¼ ä¸‰"</span>);</div><div class="line">      a.work();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ç‹äº”æŠŠè¿™ä»¶äº‹åšå¥½äº†</div></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„è¾“å‡ºè™½ç„¶æ˜¯æŠŠäº‹æƒ…æˆåŠŸåŠå¥½äº†ï¼Œä½†æ˜¯ä»”ç»†çœ‹ä¸šåŠ¡é€»è¾‘æ˜æ˜¾æ˜¯ä¸å¯¹çš„ã€‚Aå’ŒCåˆä¸æ˜¯å¥½æœ‹å‹ï¼Œä¸ºä»€ä¹ˆåœ¨ç±»Aä¸­ä¼šå‡ºç°ç±»Cå‘¢ï¼Ÿä»–ä»¬åˆäº’ç›¸ä¸è®¤è¯†ã€‚</p>
<p>çœ‹åˆ°è¿™é‡Œå¾ˆå¤šäººéƒ½ä¼šæ˜ç™½ï¼Œè¿™ç§åœºæ™¯åœ¨å®é™…å¼€å‘ä¸­æ˜¯éå¸¸å¸¸è§çš„ä¸€ç§æƒ…å†µã€‚å¯¹è±¡Aéœ€è¦è°ƒç”¨å¯¹è±¡Bçš„æ–¹æ³•ï¼Œå¯¹è±¡Bæœ‰éœ€è¦è°ƒç”¨å¯¹è±¡Cçš„æ–¹æ³•â€¦â€¦å°±æ˜¯å¸¸è§çš„getXXX().getXXX().getXXX()â€¦â€¦ç±»ä¼¼äºè¿™ç§ä»£ç ã€‚å¦‚æœä½ å‘ç°ä½ çš„ä»£ç ä¸­ä¹Ÿæœ‰è¿™æ ·çš„ä»£ç ï¼Œé‚£å°±è€ƒè™‘ä¸‹æ˜¯ä¸æ˜¯è¿åè¿ªç±³ç‰¹æ³•åˆ™ï¼Œæ˜¯ä¸æ˜¯è¦é‡æ„ä¸€ä¸‹äº†ã€‚</p>
<ul>
<li><strong>æ­£ç¡®ä¾‹å­</strong></li>
</ul>
<p>ä¸ºäº†ç¬¦åˆè¿ªç±³ç‰¹æ³•åˆ™ï¼Œä¹Ÿä¸ºäº†è®©ä¸šåŠ¡é€»è¾‘èƒ½å¤Ÿè¯´å¾—é€šï¼Œæˆ‘ä»¬æŠŠä¸Šé¢çš„ä¾‹å­ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ã€‚</p>
<p>UMLç±»å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://7u2i08.com1.z0.glb.clouddn.com/design-pattern/law-of-demeter2.png" alt="img"></p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç±»Aå’Œç±»Bæ˜¯å¥½æœ‹å‹ï¼Œèƒ½æ‰¾åˆ°ç±»Bæ¥å¸®å¿™ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> String name;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.name = name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> B <span class="title">getB</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> B(name);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</div><div class="line">      B b = getB(<span class="string">"æå››"</span>);</div><div class="line">      b.work();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>ç±»Bå’Œç±»Cæ˜¯å¥½æœ‹å‹ï¼Œèƒ½çŸ¥é“ç±»Cæ¥å¸®å¿™ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.name = name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> C <span class="title">getC</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> C(name);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span></span>&#123;</div><div class="line">      C c = getC(<span class="string">"ç‹äº”"</span>);</div><div class="line">      c.work();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>ç±»Cèƒ½å¤ŸåŠæˆæ­¤äº‹ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> String name;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">C</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.name = name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</div><div class="line">      System.out.println(name + <span class="string">"æŠŠè¿™ä»¶äº‹åšå¥½äº†"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>åœºæ™¯ç±»</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">      A a = <span class="keyword">new</span> A(<span class="string">"å¼ ä¸‰"</span>);</div><div class="line">      a.work();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ç‹äº”æŠŠè¿™ä»¶äº‹åšå¥½äº†</div></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç åªæ˜¯ä¿®æ”¹äº†ä¸‹ç±»Aå’ŒBçš„workæ–¹æ³•ï¼Œä½¿ä¹‹ç¬¦åˆäº†è¿ªç±³ç‰¹æ³•åˆ™ï¼š</p>
<ul>
<li>ç±»Aåªä¸æœ€ç›´æ¥çš„æœ‹å‹ç±»Bé€šä¿¡ï¼Œä¸ä¸ç±»Cé€šä¿¡ï¼›</li>
<li>ç±»Aåªè°ƒç”¨ç±»Bæä¾›çš„æ–¹æ³•å³å¯ï¼Œä¸ç”¨å…³å¿ƒç±»Bå†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼ˆè‡³äºBæ˜¯æ€ä¹ˆè°ƒç”¨çš„Cï¼Œè¿™äº›Aéƒ½ä¸ç”¨å…³å¿ƒï¼‰ã€‚</li>
</ul>
<h3 id="3ã€æ€»ç»“"><a href="#3ã€æ€»ç»“" class="headerlink" title="3ã€æ€»ç»“"></a><strong>3ã€æ€»ç»“</strong></h3><p>è¿ªç±³ç‰¹æ³•åˆ™çš„ç›®çš„æ˜¯è®©ç±»ä¹‹é—´è§£è€¦ï¼Œé™ä½è€¦åˆåº¦ã€‚åªæœ‰è¿™æ ·ï¼Œç±»çš„å¯å¤ç”¨æ€§æ‰èƒ½æé«˜ã€‚</p>
<p>ä½†æ˜¯è¿ªç±³ç‰¹æ³•åˆ™ä¹Ÿæœ‰å¼Šç«¯ï¼Œå®ƒä¼šäº§ç”Ÿå¤§é‡çš„ä¸­è½¬ç±»æˆ–è·³è½¬ç±»ï¼Œå¯¼è‡´ç³»ç»Ÿçš„å¤æ‚åº¦æé«˜ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬ä¸è¦å¤ªæ­»æ¿çš„éµå®ˆè¿™ä¸ªè¿ªç±³ç‰¹æ³•åˆ™ï¼Œåœ¨ç³»ç»Ÿè®¾è®¡çš„æ—¶å€™ï¼Œåœ¨å¼±è€¦åˆå’Œç»“æ„æ¸…æ™°ä¹‹é—´åå¤æƒè¡¡ã€‚å°½é‡ä¿è¯ç³»ç»Ÿç»“æ„æ¸…æ™°ï¼Œåˆèƒ½åšåˆ°ä½è€¦åˆã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[æ¥å£éš”ç¦»åŸåˆ™]]></title>
      <url>http://zsr.github.io/2016/09/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%85%AD%E5%A4%A7%E5%8E%9F%E5%88%99-%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99/</url>
      <content type="html"><![CDATA[<p><strong>1ã€é—®é¢˜ç”±æ¥</strong></p>
<p>ã€€ã€€ç±»Aé€šè¿‡æ¥å£Iä¾èµ–ç±»Bï¼Œç±»Cé€šè¿‡æ¥å£Iä¾èµ–ç±»Dï¼Œå¦‚æœæ¥å£Iå¯¹äºç±»Bå’Œç±»Dæ¥è¯´ä¸æ˜¯æœ€å°æ¥å£ï¼Œåˆ™ç±»Bå’Œç±»Då¿…é¡»å»å®ç°ä»–ä»¬ä¸éœ€è¦çš„æ–¹æ³•ã€‚</p>
<p><strong>2ã€ä»€ä¹ˆæ˜¯æ¥å£éš”ç¦»åŸåˆ™</strong></p>
<p>ã€€ã€€æ¥å£éš”ç¦»åŸåˆ™æ¯”è¾ƒç®€å•ï¼Œæœ‰ä¸¤ç§å®šä¹‰ï¼š</p>
<ul>
<li>Clients should not be forced to depend upon interfaces that they donâ€™t use.ï¼ˆå®¢æˆ·ç«¯ä¸åº”è¯¥å¼ºè¡Œä¾èµ–å®ƒä¸éœ€è¦çš„æ¥å£ï¼‰</li>
<li>The dependency of one class to another one should depend on the smallest possible interface.ï¼ˆç±»é—´çš„ä¾èµ–å…³ç³»åº”è¯¥å»ºç«‹åœ¨æœ€å°çš„æ¥å£ä¸Šï¼‰</li>
</ul>
<p>ã€€ã€€å…¶å®ä¸Šè¿°ä¸¤ç§å®šä¹‰è¯´çš„æ˜¯åŒä¸€ç§æ„æ€ã€‚å®¢æˆ·ç«¯ä¸åº”è¯¥ä¾èµ–å®ƒä¸éœ€è¦çš„æ¥å£ï¼Œæ„æ€å°±æ˜¯è¯´å®¢æˆ·ç«¯åªè¦ä¾èµ–å®ƒéœ€è¦çš„æ¥å£ï¼Œå®ƒéœ€è¦ä»€ä¹ˆæ¥å£ï¼Œå°±æä¾›ä»€ä¹ˆæ¥å£ï¼Œä¸æä¾›å¤šä½™çš„æ¥å£ã€‚â€œç±»é—´çš„ä¾èµ–å…³ç³»åº”è¯¥å»ºç«‹åœ¨æœ€å°çš„æ¥å£ä¸Šâ€ä¹Ÿè¡¨è¾¾è¿™ä¸€å±‚æ„æ€ã€‚é€šä¿—çš„è®²å°±æ˜¯ï¼šæ¥å£ä¸­çš„æ–¹æ³•åº”è¯¥å°½é‡å°‘ï¼Œä¸è¦ä½¿æ¥å£è¿‡äºè‡ƒè‚¿ï¼Œä¸è¦æœ‰å¾ˆå¤šä¸ç›¸å…³çš„é€»è¾‘æ–¹æ³•ã€‚</p>
<p>ã€€ã€€é€šè¿‡ç®€å•çš„ä»£ç è¿˜åŸå¼€ç¯‡çš„é—®é¢˜ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">I</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">I</span></span>&#123;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"ç±»Bå®ç°äº†æ¥å£Içš„æ–¹æ³•1"</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"ç±»Bå®ç°äº†æ¥å£Içš„æ–¹æ³•2"</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span> </span>&#123;<span class="comment">//ç±»Bå¹¶ä¸éœ€è¦æ¥å£Içš„æ–¹æ³•3åŠŸèƒ½ï¼Œä½†æ˜¯ç”±äºå®ç°æ¥å£Iï¼Œæ‰€ä»¥ä¸å¾—ä¸å®ç°æ–¹æ³•3</span></div><div class="line">        <span class="comment">//åœ¨è¿™é‡Œå†™ä¸€ä¸ªç©ºæ–¹æ³•</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">D</span> <span class="keyword">implements</span> <span class="title">I</span></span>&#123;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"ç±»Då®ç°äº†æ¥å£Içš„æ–¹æ³•2"</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"ç±»Då®ç°äº†æ¥å£Içš„æ–¹æ³•3"</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;<span class="comment">//ç±»Då¹¶ä¸éœ€è¦æ¥å£Içš„æ–¹æ³•1åŠŸèƒ½ï¼Œä½†æ˜¯ç”±äºå®ç°æ¥å£Iï¼Œæ‰€ä»¥ä¸å¾—ä¸å®ç°æ–¹æ³•1</span></div><div class="line">        <span class="comment">//åœ¨è¿™é‡Œå†™ä¸€ä¸ªç©ºæ–¹æ³•</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//ç±»Aé€šè¿‡æ¥å£Iä¾èµ–ç±»B</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">depend1</span><span class="params">(I i)</span></span>&#123;</div><div class="line">        i.method1();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//ç±»Cé€šè¿‡æ¥å£Iä¾èµ–ç±»D</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">depend1</span><span class="params">(I i)</span></span>&#123;</div><div class="line">        i.method3();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        A a = <span class="keyword">new</span> A();</div><div class="line">        I i1 = <span class="keyword">new</span> B();</div><div class="line">        a.depend1(i1);</div><div class="line">         </div><div class="line">        C c = <span class="keyword">new</span> C();</div><div class="line">        I i2 = <span class="keyword">new</span> D();</div><div class="line">        c.depend1(i2);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ã€€è¿è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ç±»Bå®ç°äº†æ¥å£Içš„æ–¹æ³•<span class="number">1</span></div><div class="line">ç±»Då®ç°äº†æ¥å£Içš„æ–¹æ³•<span class="number">3</span></div></pre></td></tr></table></figure>
<p>ã€€ã€€ä»ä»¥ä¸Šä»£ç å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæ¥å£è¿‡äºè‡ƒè‚¿ï¼Œä¸åŒä¸šåŠ¡é€»è¾‘çš„æŠ½è±¡æ–¹æ³•éƒ½æ”¾åœ¨ä¸€ä¸ªæ¥å£å†…ï¼Œåˆ™ä¼šé€ æˆå®ƒçš„å®ç°ç±»å¿…é¡»å®ç°è‡ªå·±å¹¶ä¸éœ€è¦çš„æ–¹æ³•ï¼Œè¿™ç§è®¾è®¡æ–¹å¼æ˜¾ç„¶æ˜¯ä¸å¦¥å½“çš„ã€‚æ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹ä¸Šè¿°è®¾è®¡æ–¹æ³•ï¼ŒæŠŠæ¥å£Iæ‹†åˆ†æˆ3ä¸ªæ¥å£ï¼Œä½¿å¾—å®ç°ç±»åªéœ€è¦å®ç°è‡ªå·±éœ€è¦çš„æ¥å£å³å¯ã€‚åªè´´å‡ºä¿®æ”¹åçš„æ¥å£å’Œå®ç°ç±»çš„ä»£ç ï¼Œä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">I1</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">I2</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">I3</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">I1</span>,<span class="title">I2</span></span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"ç±»Bå®ç°äº†æ¥å£Içš„æ–¹æ³•1"</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"ç±»Bå®ç°äº†æ¥å£Içš„æ–¹æ³•2"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">D</span> <span class="keyword">implements</span> <span class="title">I2</span>,<span class="title">I3</span></span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"ç±»Då®ç°äº†æ¥å£Içš„æ–¹æ³•2"</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"ç±»Då®ç°äº†æ¥å£Içš„æ–¹æ³•3"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>3ã€ä¸å•ä¸€èŒè´£åŸåˆ™çš„åŒºåˆ«</strong></p>
<p>ã€€ã€€åˆ°äº†è¿™é‡Œï¼Œæœ‰äº›äººå¯èƒ½è§‰å¾—æ¥å£éš”ç¦»åŸåˆ™ä¸å•ä¸€èŒè´£åŸåˆ™å¾ˆç›¸ä¼¼ï¼Œå…¶å®ä¸ç„¶ã€‚</p>
<ul>
<li>ç¬¬ä¸€ï¼Œå•ä¸€èŒè´£åŸåˆ™æ³¨é‡çš„æ˜¯èŒè´£ï¼›è€Œæ¥å£éš”ç¦»åŸåˆ™æ³¨é‡å¯¹æ¥å£ä¾èµ–çš„éš”ç¦»ã€‚</li>
<li>ç¬¬äºŒï¼Œå•ä¸€èŒè´£åŸåˆ™ä¸»è¦æ˜¯çº¦æŸç±»ï¼Œå…¶æ¬¡æ‰æ˜¯æ¥å£å’Œæ–¹æ³•ï¼Œå®ƒé’ˆå¯¹çš„æ˜¯ç¨‹åºä¸­çš„å®ç°å’Œç»†èŠ‚ï¼›è€Œæ¥å£éš”ç¦»åŸåˆ™ä¸»è¦çº¦æŸæ¥å£ï¼Œä¸»è¦é’ˆå¯¹æŠ½è±¡ï¼Œé’ˆå¯¹ç¨‹åºæ•´ä½“æ¡†æ¶çš„æ„å»ºã€‚</li>
</ul>
<p><strong>4ã€æ³¨æ„äº‹é¡¹</strong></p>
<p>ã€€ã€€åŸåˆ™æ˜¯å‰äººç»éªŒçš„æ€»ç»“ï¼Œåœ¨è½¯ä»¶è®¾è®¡ä¸­å…·æœ‰ä¸€å®šçš„æŒ‡å¯¼ä½œç”¨ï¼Œä½†æ˜¯ä¸èƒ½å®Œå…¨ç…§æ¬è¿™äº›åŸåˆ™ã€‚å¯¹äºæ¥å£éš”ç¦»åŸåˆ™æ¥è¯´ï¼Œæ¥å£å°½é‡å°ï¼Œä½†æ˜¯ä¹Ÿè¦æœ‰é™åº¦ã€‚å¯¹æ¥å£è¿›è¡Œç»†åŒ–å¯ä»¥æé«˜ç¨‹åºè®¾è®¡çµæ´»æ€§æ˜¯ä¸äº‰çš„äº‹å®ï¼Œä½†æ˜¯å¦‚æœè¿‡å°ï¼Œåˆ™ä¼šé€ æˆæ¥å£æ•°é‡è¿‡å¤šï¼Œä½¿è®¾è®¡å¤æ‚åŒ–ï¼Œæ‰€ä»¥ä¸€å®šè¦é€‚åº¦ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ä¾èµ–å€’ç½®åŸåˆ™]]></title>
      <url>http://zsr.github.io/2016/09/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%85%AD%E5%A4%A7%E5%8E%9F%E5%88%99-%E4%BE%9D%E8%B5%96%E5%80%92%E7%BD%AE%E5%8E%9F%E5%88%99/</url>
      <content type="html"><![CDATA[<p><strong>1ã€é—®é¢˜ç”±æ¥</strong></p>
<p>ã€€ã€€ç±»Aç›´æ¥ä¾èµ–äºç±»Bï¼Œå‡å¦‚è¦å°†ç±»Aä¿®æ”¹ä¸ºä¾èµ–ç±»Cï¼Œåˆ™å¿…é¡»é€šè¿‡ä¿®æ”¹ç±»Açš„ä»£ç æ¥è¾¾æˆã€‚è¿™ç§åœºæ™¯ä¸‹ï¼Œç±»Aä¸€èˆ¬æ˜¯é«˜å±‚æ¨¡å—ï¼Œè´Ÿè´£å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚ç±»Bå’ŒCæ˜¯åº•å±‚æ¨¡å—ï¼Œè´Ÿè´£åŸºæœ¬çš„åŸå­æ“ä½œã€‚å‡å¦‚ä¿®æ”¹ç±»Aï¼Œå°†ä¼šç»™ç¨‹åºå¸¦æ¥ä¸å¿…è¦çš„é£é™©ã€‚è€Œéµå¾ªä¾èµ–å€’ç½®åŸåˆ™çš„ç¨‹åºè®¾è®¡å¯ä»¥è§£å†³è¿™ä¸€é—®é¢˜ã€‚</p>
<p><strong>2ã€ä»€ä¹ˆæ˜¯ä¾èµ–å€’ç½®åŸåˆ™</strong></p>
<p>ã€€ã€€è‹±æ–‡ç¼©å†™DIPï¼ˆDependence Inversion Principleï¼‰ã€‚</p>
<p>ã€€ã€€åŸå§‹å®šä¹‰ï¼šHigh level modules should not depend upon low level modules. Both should depend upon abstractions. Abstractions should not depend upon details. Details should depend upon abstractions.</p>
<p>ã€€ã€€ç¿»è¯‘è¿‡æ¥å°±ä¸‰å±‚å«ä¹‰ï¼š</p>
<ul>
<li>é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚æ¨¡å—ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–å…¶æŠ½è±¡ï¼›</li>
<li>æŠ½è±¡ä¸åº”è¯¥ä¾èµ–ç»†èŠ‚ï¼›</li>
<li>ç»†èŠ‚åº”è¯¥ä¾èµ–æŠ½è±¡ã€‚</li>
</ul>
<p>ã€€ã€€æŠ½è±¡ï¼šå³æŠ½è±¡ç±»æˆ–æ¥å£ï¼Œä¸¤è€…æ˜¯ä¸èƒ½å¤Ÿå®ä¾‹åŒ–çš„ã€‚</p>
<p>ã€€ã€€ç»†èŠ‚ï¼šå³å…·ä½“çš„å®ç°ç±»ï¼Œå®ç°æ¥å£æˆ–è€…ç»§æ‰¿æŠ½è±¡ç±»æ‰€äº§ç”Ÿçš„ç±»ï¼Œä¸¤è€…å¯ä»¥é€šè¿‡å…³é”®å­—newç›´æ¥è¢«å®ä¾‹åŒ–ã€‚</p>
<p>ã€€ã€€ç°åœ¨æˆ‘ä»¬æ¥é€šè¿‡å®ä¾‹è¿˜åŸå¼€ç¯‡é—®é¢˜çš„åœºæ™¯ï¼Œä»¥ä¾¿æ›´å¥½çš„æ¥ç†è§£ã€‚ä¸‹é¢ä»£ç æè¿°äº†ä¸€ä¸ªç®€å•çš„åœºæ™¯ï¼ŒJimä½œä¸ºäººæœ‰åƒçš„æ–¹æ³•ï¼Œè‹¹æœæœ‰å–å¾—è‡ªå·±åå­—çš„æ–¹æ³•ï¼Œç„¶åå®ç°Jimå»åƒè‹¹æœã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å…·ä½“Jimäººç±»</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jim</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">(Apple apple)</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"Jim eat "</span> + apple.getName());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//å…·ä½“è‹¹æœç±»</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Apple</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"apple"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Jim jim = <span class="keyword">new</span> Jim();</div><div class="line">        Apple apple = <span class="keyword">new</span> Apple();</div><div class="line">        jim.eat(apple);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Jim eat apple</div></pre></td></tr></table></figure>
<p>ã€€ã€€ä¸Šé¢ä»£ç çœ‹èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä½†å…¶å®æ˜¯ä¸€ä¸ªéå¸¸è„†å¼±çš„è®¾è®¡ã€‚ç°åœ¨Jimå¯ä»¥åƒè‹¹æœäº†ï¼Œä½†æ˜¯ä¸èƒ½åªåƒè‹¹æœè€Œä¸åƒåˆ«çš„æ°´æœå•Šï¼Œè¿™æ ·ä¸‹å»è‚¯å®šä¼šé€ æˆè¥å…»å¤±è¡¡ã€‚ç°åœ¨æƒ³è®©Jimåƒé¦™è•‰äº†ï¼ˆå¥½åƒé¦™è•‰é‡Œå«é’¾å…ƒç´ æ¯”è¾ƒå¤šï¼Œåƒç‚¹æ¯”è¾ƒæœ‰ç›Šï¼‰ï¼Œçªç„¶å‘ç°Jimæ˜¯åƒä¸äº†é¦™è•‰çš„ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿçœ‹æ¥åªæœ‰ä¿®æ”¹ä»£ç äº†å•Šï¼Œç”±äºä¸Šé¢ä»£ç ä¸­Jimç±»ä¾èµ–äºAppleç±»ï¼Œæ‰€ä»¥å¯¼è‡´ä¸å¾—ä¸å»æ”¹åŠ¨Jimç±»é‡Œé¢çš„ä»£ç ã€‚é‚£å¦‚æœä¸‹æ¬¡Jimåˆè¦åƒåˆ«çš„æ°´æœäº†å‘¢ï¼Ÿç»§ç»­ä¿®æ”¹ä»£ç ï¼Ÿè¿™ç§å¤„ç†æ–¹å¼æ˜¾ç„¶æ˜¯ä¸å¯å–çš„ï¼Œé¢‘ç¹ä¿®æ”¹ä¼šå¸¦æ¥å¾ˆå¤§çš„ç³»ç»Ÿé£é™©ï¼Œæ”¹ç€æ”¹ç€å¯èƒ½å°±å‘ç°Jimä¸ä¼šåƒæ°´æœäº†ã€‚</p>
<p>ã€€ã€€ä¸Šé¢çš„ä»£ç ä¹‹æ‰€ä»¥ä¼šå‡ºç°ä¸Šè¿°éš¾å ªçš„é—®é¢˜ï¼Œå°±æ˜¯å› ä¸ºJimç±»ä¾èµ–äºAppleç±»ï¼Œä¸¤è€…æ˜¯ç´§è€¦åˆçš„å…³ç³»ï¼Œå…¶å¯¼è‡´çš„ç»“æœå°±æ˜¯ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å¤§å¤§é™ä½ã€‚è¦å¢åŠ é¦™è•‰ç±»å´è¦å»ä¿®æ”¹Jimç±»ä»£ç ï¼Œè¿™æ˜¯ä¸å¯å¿å—çš„ï¼Œä½ æ”¹ä½ çš„ä»£ç ä¸ºä»€ä¹ˆè¦åŠ¨æˆ‘çš„å•Šï¼Œæ˜¾ç„¶Jimä¸ä¹æ„äº†ã€‚æˆ‘ä»¬å¸¸è¯´è¦è®¾è®¡ä¸€ä¸ªå¥å£®ç¨³å®šçš„ç³»ç»Ÿï¼Œè€Œè¿™é‡Œåªæ˜¯å¢åŠ äº†ä¸€ä¸ªé¦™è•‰ç±»ï¼Œå°±è¦å»ä¿®æ”¹Jimç±»ï¼Œå¥å£®å’Œç¨³å®šè¿˜ä»ä½•è°ˆèµ·ã€‚</p>
<p>ã€€ã€€è€Œæ ¹æ®ä¾èµ–å€’ç½®åŸåˆ™ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ä¸Šè¿°ä»£ç åšäº›ä¿®æ”¹ï¼Œæå–æŠ½è±¡çš„éƒ¨åˆ†ã€‚é¦–å…ˆæˆ‘ä»¬æå–å‡ºä¸¤ä¸ªæ¥å£ï¼šPeopleå’ŒFruitï¼Œéƒ½æä¾›å„è‡ªå¿…éœ€çš„æŠ½è±¡æ–¹æ³•ï¼Œè¿™æ ·ä»¥åæ— è®ºæ˜¯å¢åŠ Jimäººç±»ï¼Œè¿˜æ˜¯å¢åŠ Appleã€Bananaç­‰å„ç§æ°´æœï¼Œéƒ½åªéœ€è¦å¢åŠ è‡ªå·±çš„å®ç°ç±»å°±å¯ä»¥äº†ã€‚ç”±äºéµå¾ªä¾èµ–å€’ç½®åŸåˆ™ï¼Œåªä¾èµ–äºæŠ½è±¡ï¼Œè€Œä¸ä¾èµ–äºç»†èŠ‚ï¼Œæ‰€ä»¥å¢åŠ ç±»æ— éœ€ä¿®æ”¹å…¶ä»–ç±»ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//äººæ¥å£</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">People</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">(Fruit fruit)</span></span>;<span class="comment">//äººéƒ½æœ‰åƒçš„æ–¹æ³•ï¼Œä¸ç„¶éƒ½é¥¿æ­»äº†</span></div><div class="line">&#125;</div><div class="line"><span class="comment">//æ°´æœæ¥å£</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Fruit</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>;<span class="comment">//æ°´æœéƒ½æ˜¯æœ‰åå­—çš„</span></div><div class="line">&#125;</div><div class="line"><span class="comment">//å…·ä½“Jimäººç±»</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jim</span> <span class="keyword">implements</span> <span class="title">People</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">(Fruit fruit)</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"Jim eat "</span> + fruit.getName());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//å…·ä½“è‹¹æœç±»</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Apple</span> <span class="keyword">implements</span> <span class="title">Fruit</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"apple"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//å…·ä½“é¦™è•‰ç±»</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Banana</span> <span class="keyword">implements</span> <span class="title">Fruit</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"banana"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        People jim = <span class="keyword">new</span> Jim();</div><div class="line">        Fruit apple = <span class="keyword">new</span> Apple();</div><div class="line">        Fruit Banana = <span class="keyword">new</span> Banana();<span class="comment">//è¿™é‡Œç¬¦åˆäº†é‡Œæ°æ›¿æ¢åŸåˆ™</span></div><div class="line">        jim.eat(apple);</div><div class="line">        jim.eat(Banana);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Jim eat apple</div><div class="line">Jim eat banana</div></pre></td></tr></table></figure>
<ul>
<li>Peopleç±»æ˜¯å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œå±äºé«˜å±‚æ¨¡å—ï¼Œè€ŒFruitæ˜¯åŸå­æ¨¡å—ï¼Œå±äºä½å±‚æ¨¡å—ã€‚Peopleä¾èµ–äºæŠ½è±¡çš„Fruitæ¥å£ï¼Œè¿™å°±åšåˆ°äº†ï¼šé«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚æ¨¡å—ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–äºæŠ½è±¡ï¼ˆæŠ½è±¡ç±»æˆ–æ¥å£ï¼‰ã€‚</li>
<li>Peopleå’ŒFruitæ¥å£ä¸å„è‡ªçš„å®ç°ç±»æ²¡æœ‰å…³ç³»ï¼Œå¢åŠ å®ç°ç±»ä¸ä¼šå½±å“æ¥å£ï¼Œè¿™å°±åšåˆ°äº†ï¼šæŠ½è±¡ï¼ˆæŠ½è±¡ç±»æˆ–æ¥å£ï¼‰ä¸åº”è¯¥ä¾èµ–äºç»†èŠ‚ï¼ˆå…·ä½“å®ç°ç±»ï¼‰ã€‚</li>
<li>Jimã€Appleã€Bananaå®ç°ç±»éƒ½è¦å»å®ç°å„è‡ªçš„æ¥å£æ‰€å®šä¹‰çš„æŠ½è±¡æ–¹æ³•ï¼Œæ‰€ä»¥æ˜¯ä¾èµ–äºæ¥å£çš„ã€‚è¿™å°±åšåˆ°äº†ï¼šç»†èŠ‚ï¼ˆå…·ä½“å®ç°ç±»ï¼‰åº”è¯¥ä¾èµ–æŠ½è±¡ã€‚</li>
</ul>
<p><strong>3ã€ä»€ä¹ˆæ˜¯å€’ç½®</strong></p>
<p>ã€€ã€€åˆ°äº†è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹ä¾èµ–å€’ç½®åŸåˆ™çš„â€œä¾èµ–â€å°±å¾ˆå¥½ç†è§£äº†ï¼Œä½†æ˜¯ä»€ä¹ˆæ˜¯â€œå€’ç½®â€å‘¢ã€‚æ˜¯è¿™æ ·å­çš„ï¼Œåˆšå¼€å§‹æŒ‰ç…§æ­£å¸¸äººçš„ä¸€èˆ¬æ€ç»´æ–¹å¼ï¼Œæˆ‘æƒ³åƒé¦™è•‰å°±æ˜¯åƒé¦™è•‰ï¼Œæƒ³åƒè‹¹æœå°±åƒè‹¹æœï¼Œç¼–ç¨‹ä¹Ÿæ˜¯è¿™æ ·ï¼Œéƒ½æ˜¯æŒ‰ç…§é¢å‘å®ç°çš„æ€ç»´æ–¹å¼æ¥è®¾è®¡ã€‚è€Œç°åœ¨è¦å€’ç½®æ€ç»´ï¼Œæå–å…¬å…±çš„æŠ½è±¡ï¼Œé¢å‘æ¥å£ï¼ˆæŠ½è±¡ç±»ï¼‰ç¼–ç¨‹ã€‚ä¸å†ä¾èµ–äºå…·ä½“å®ç°äº†ï¼Œè€Œæ˜¯ä¾èµ–äºæ¥å£æˆ–æŠ½è±¡ç±»ï¼Œè¿™å°±æ˜¯ä¾èµ–çš„æ€ç»´æ–¹å¼â€œå€’ç½®â€äº†ã€‚</p>
<p><strong>4ã€ä¾èµ–çš„ä¸‰ç§å®ç°æ–¹å¼</strong></p>
<p>ã€€ã€€å¯¹è±¡çš„ä¾èµ–å…³ç³»æœ‰ä¸‰ç§æ–¹å¼æ¥ä¼ é€’ï¼š</p>
<ul>
<li>æ¥å£æ–¹æ³•ä¸­å£°æ˜ä¾èµ–å¯¹è±¡ã€‚å°±æ˜¯æˆ‘ä»¬ä¸Šé¢ä»£ç æ‰€å±•ç¤ºçš„é‚£æ ·ã€‚</li>
<li>æ„é€ æ–¹æ³•ä¼ é€’ä¾èµ–å¯¹è±¡ã€‚åœ¨æ„é€ å‡½æ•°ä¸­çš„éœ€è¦ä¼ é€’çš„å‚æ•°æ˜¯æŠ½è±¡ç±»æˆ–æ¥å£çš„æ–¹å¼å®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å…·ä½“Jimäººç±»</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jim</span> <span class="keyword">implements</span> <span class="title">People</span></span>&#123;</div><div class="line">     </div><div class="line">    <span class="keyword">private</span> Fruit fruit;</div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Jim</span><span class="params">(Fruit fruit)</span></span>&#123;<span class="comment">//æ„é€ æ–¹æ³•ä¼ é€’ä¾èµ–å¯¹è±¡</span></div><div class="line">        <span class="keyword">this</span>.fruit = fruit;</div><div class="line">    &#125;</div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">(Fruit fruit)</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"Jim eat "</span> + <span class="keyword">this</span>.fruit.getName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Setteræ–¹æ³•ä¼ é€’ä¾èµ–å¯¹è±¡ã€‚åœ¨æˆ‘ä»¬è®¾ç½®çš„setXXXæ–¹æ³•ä¸­çš„å‚æ•°ä¸ºæŠ½è±¡ç±»æˆ–æ¥å£ï¼Œæ¥å®ç°ä¼ é€’ä¾èµ–å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å…·ä½“Jimäººç±»</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jim</span> <span class="keyword">implements</span> <span class="title">People</span></span>&#123;</div><div class="line">     </div><div class="line">    <span class="keyword">private</span> Fruit fruit;</div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFruit</span><span class="params">(Fruit fruit)</span></span>&#123;<span class="comment">//setteræ–¹å¼ä¼ é€’ä¾èµ–å¯¹è±¡</span></div><div class="line">        <span class="keyword">this</span>.fruit = fruit;</div><div class="line">    &#125;</div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"Jim eat "</span> + <span class="keyword">this</span>.fruit.getName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>5ã€ä¼˜ç‚¹</strong></p>
<p>ã€€ã€€ä»ä¸Šé¢çš„ä»£ç ä¿®æ”¹è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç”±äºç±»ä¹‹é—´æ¾è€¦åˆçš„è®¾è®¡ï¼Œé¢å‘æ¥å£ç¼–ç¨‹ä¾èµ–æŠ½è±¡è€Œä¸ä¾èµ–ç»†èŠ‚ï¼Œæ‰€ä»¥åœ¨ä¿®æ”¹æŸä¸ªç±»çš„ä»£ç æ—¶ï¼Œä¸ä¼šç‰µæ¶‰åˆ°å…¶ä»–ç±»çš„ä¿®æ”¹ï¼Œæ˜¾è‘—é™ä½ç³»ç»Ÿé£é™©ï¼Œæé«˜ç³»ç»Ÿå¥å£®æ€§ã€‚</p>
<p>ã€€ã€€è¿˜æœ‰ä¸€ä¸ªä¼˜ç‚¹æ˜¯ï¼Œåœ¨æˆ‘ä»¬å®é™…é¡¹ç›®å¼€å‘ä¸­ï¼Œéƒ½æ˜¯å¤šäººå›¢é˜Ÿåä½œï¼Œæ¯äººè´Ÿè´£æŸä¸€æ¨¡å—ã€‚æ¯”å¦‚ä¸€ä¸ªäººè´Ÿè´£å¼€å‘Peopleæ¨¡å—ï¼Œä¸€äººè´Ÿè´£å¼€å‘Fruitæ¨¡å—ï¼Œå¦‚æœæœªé‡‡ç”¨ä¾èµ–å€’ç½®åŸåˆ™ï¼Œæ²¡æœ‰æå–æŠ½è±¡ï¼Œé‚£ä¹ˆå¼€å‘Peopleæ¨¡å—çš„äººå¿…é¡»ç­‰Fruitæ¨¡å—å¼€å‘å®Œæˆåè‡ªå·±æ‰èƒ½å¼€å‘ï¼Œå¦åˆ™ç¼–è¯‘éƒ½æ— æ³•é€šè¿‡ï¼Œè¿™å°±æ˜¯å•çº¿ç¨‹çš„å¼€å‘ã€‚ä¸ºäº†èƒ½å¤Ÿä¸¤äººå¹¶è¡Œå¼€å‘ï¼Œè®¾è®¡æ—¶éµå¾ªä¾èµ–å€’ç½®åŸåˆ™ï¼Œæå–æŠ½è±¡ï¼Œå°±å¯ä»¥å¤§å¤§æé«˜å¼€å‘è¿›åº¦ã€‚</p>
<p><strong>6ã€æ€»ç»“</strong></p>
<p>ã€€ã€€è¯´åˆ°åº•ï¼Œä¾èµ–å€’ç½®åŸåˆ™çš„æ ¸å¿ƒå°±æ˜¯é¢å‘æ¥å£ç¼–ç¨‹çš„æ€æƒ³ï¼Œå°½é‡å¯¹æ¯ä¸ªå®ç°ç±»éƒ½æå–æŠ½è±¡å’Œå…¬å…±æ¥å£å½¢æˆæ¥å£æˆ–æŠ½è±¡ç±»ï¼Œä¾èµ–äºæŠ½è±¡è€Œä¸è¦ä¾èµ–äºå…·ä½“å®ç°ã€‚ä¾èµ–å€’ç½®åŸåˆ™çš„æœ¬è´¨å…¶å®å°±æ˜¯é€šè¿‡æŠ½è±¡ï¼ˆæŠ½è±¡ç±»æˆ–æ¥å£ï¼‰ä½¿å„ä¸ªç±»æˆ–æ¨¡å—çš„å®ç°å½¼æ­¤ç‹¬ç«‹ï¼Œä¸ç›¸äº’å½±å“ï¼Œå®ç°æ¨¡å—é—´çš„æ¾è€¦åˆã€‚ä½†æ˜¯è¿™ä¸ªåŸåˆ™ä¹Ÿæ˜¯6ä¸ªè®¾è®¡åŸåˆ™ä¸­æœ€éš¾ä»¥å®ç°çš„äº†ï¼Œå¦‚æœæ²¡æœ‰å®ç°è¿™ä¸ªåŸåˆ™ï¼Œé‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€å¼€é—­åŸåˆ™ï¼ˆå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼‰ä¹Ÿæ— æ³•å®ç°ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[é‡Œæ°æ›¿æ¢åŸåˆ™]]></title>
      <url>http://zsr.github.io/2016/09/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%85%AD%E5%A4%A7%E5%8E%9F%E5%88%99-%E9%87%8C%E6%B0%8F%E6%9B%BF%E6%8D%A2%E5%8E%9F%E5%88%99/</url>
      <content type="html"><![CDATA[<p><strong>1ã€é—®é¢˜çš„ç”±æ¥</strong></p>
<p>ã€€ã€€æˆ‘ä»¬éƒ½çŸ¥é“é¢å‘å¯¹è±¡æœ‰ä¸‰å¤§ç‰¹æ€§ï¼šå°è£…ã€ç»§æ‰¿ã€å¤šæ€ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå­ç±»åœ¨ç»§æ‰¿çˆ¶ç±»åï¼Œæ ¹æ®å¤šæ€çš„ç‰¹æ€§ï¼Œå¯èƒ½æ˜¯å›¾ä¸€æ—¶æ–¹ä¾¿ï¼Œç»å¸¸ä»»æ„é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ç§æ–¹å¼ä¼šå¤§å¤§å¢åŠ ä»£ç å‡ºé—®é¢˜çš„å‡ ç‡ã€‚æ¯”å¦‚ä¸‹é¢åœºæ™¯ï¼šç±»Cå®ç°äº†æŸé¡¹åŠŸèƒ½F1ã€‚ç°åœ¨éœ€è¦å¯¹åŠŸèƒ½F1ä½œä¿®æ”¹æ‰©å±•ï¼Œå°†åŠŸèƒ½F1æ‰©å±•ä¸ºFï¼Œå…¶ä¸­Fç”±åŸæœ‰çš„åŠŸèƒ½F1å’Œæ–°åŠŸèƒ½F2ç»„æˆã€‚æ–°åŠŸèƒ½Fç”±ç±»Cçš„å­ç±»C1æ¥å®Œæˆï¼Œåˆ™å­ç±»C1åœ¨å®ŒæˆåŠŸèƒ½Fçš„åŒæ—¶ï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´ç±»Cçš„åŸåŠŸèƒ½F1å‘ç”Ÿæ•…éšœã€‚è¿™æ—¶å€™é‡Œæ°æ›¿æ¢åŸåˆ™å°±é—ªäº®ç™»åœºäº†ã€‚</p>
<p><strong>2ã€ä»€ä¹ˆæ˜¯é‡Œæ°æ›¿æ¢åŸåˆ™</strong></p>
<p>ã€€ã€€å‰é¢è¯´è¿‡çš„å•ä¸€èŒè´£åŸåˆ™ï¼Œä»å­—é¢æ„æ€å°±å¾ˆå¥½ç†è§£ï¼Œä½†æ˜¯é‡Œæ°æ›¿æ¢åŸåˆ™å°±æœ‰ç‚¹è®©äººæ‘¸ä¸ç€å¤´è„‘ã€‚æŸ¥è¿‡èµ„æ–™åå‘ç°åŸæ¥è¿™é¡¹åŸåˆ™æœ€æ—©æ˜¯åœ¨1988å¹´ï¼Œç”±éº»çœç†å·¥å­¦é™¢ä¸€ä½å§“é‡Œçš„å¥³å£«ï¼ˆLiskovï¼‰æå‡ºæ¥çš„ã€‚</p>
<p>ã€€ã€€è‹±æ–‡ç¼©å†™ï¼šLSP (Liskov Substitution Principle)ã€‚</p>
<p>ã€€ã€€ä¸¥æ ¼çš„å®šä¹‰ï¼šå¦‚æœå¯¹æ¯ä¸€ä¸ªç±»å‹ä¸ºT1çš„å¯¹è±¡o1ï¼Œéƒ½æœ‰ç±»å‹ä¸ºT2çš„å¯¹è±¡o2ï¼Œä½¿å¾—ä»¥T1å®šä¹‰çš„æ‰€æœ‰ç¨‹åºPåœ¨æ‰€æœ‰çš„å¯¹è±¡o1éƒ½æ¢æˆo2æ—¶ï¼Œç¨‹åºPçš„è¡Œä¸ºæ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆç±»å‹T2æ˜¯ç±»å‹T1çš„å­ç±»å‹ã€‚ </p>
<p>ã€€ã€€é€šä¿—çš„å®šä¹‰ï¼šæ‰€æœ‰å¼•ç”¨åŸºç±»çš„åœ°æ–¹å¿…é¡»èƒ½é€æ˜åœ°ä½¿ç”¨å…¶å­ç±»çš„å¯¹è±¡ã€‚</p>
<p>ã€€ã€€æ›´é€šä¿—çš„å®šä¹‰ï¼šå­ç±»å¯ä»¥æ‰©å±•çˆ¶ç±»çš„åŠŸèƒ½ï¼Œä½†ä¸èƒ½æ”¹å˜çˆ¶ç±»åŸæœ‰çš„åŠŸèƒ½ã€‚</p>
<p>ä»£ç ç¤ºä¾‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æŠ½è±¡çˆ¶ç±»ç”µè„‘</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Computer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">use</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IBM</span> <span class="keyword">extends</span> <span class="title">Computer</span></span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">use</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"use IBM Computer."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HP</span> <span class="keyword">extends</span> <span class="title">Computer</span></span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">use</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"use HP Computer."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Computer ibm = <span class="keyword">new</span> IBM();</div><div class="line">        Computer hp = <span class="keyword">new</span> HP();<span class="comment">//å¼•ç”¨åŸºç±»çš„åœ°æ–¹èƒ½é€æ˜åœ°ä½¿ç”¨å…¶å­ç±»çš„å¯¹è±¡ã€‚</span></div><div class="line">         </div><div class="line">        ibm.use();</div><div class="line">        hp.use();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>3ã€å››å±‚å«ä¹‰</strong></p>
<p>ã€€ã€€é‡Œæ°æ›¿æ¢åŸåˆ™åŒ…å«ä»¥ä¸‹4å±‚å«ä¹‰ï¼š</p>
<ul>
<li>å­ç±»å¯ä»¥å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œä½†æ˜¯ä¸èƒ½è¦†ç›–çˆ¶ç±»çš„éæŠ½è±¡æ–¹æ³•ã€‚</li>
<li>å­ç±»ä¸­å¯ä»¥å¢åŠ è‡ªå·±ç‰¹æœ‰çš„æ–¹æ³•ã€‚</li>
<li>å½“å­ç±»è¦†ç›–æˆ–å®ç°çˆ¶ç±»çš„æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„å‰ç½®æ¡ä»¶ï¼ˆå³æ–¹æ³•çš„å½¢å‚ï¼‰è¦æ¯”çˆ¶ç±»æ–¹æ³•çš„è¾“å…¥å‚æ•°æ›´å®½æ¾ã€‚</li>
<li>å½“å­ç±»çš„æ–¹æ³•å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„åç½®æ¡ä»¶ï¼ˆå³æ–¹æ³•çš„è¿”å›å€¼ï¼‰è¦æ¯”çˆ¶ç±»æ›´ä¸¥æ ¼ã€‚</li>
</ul>
<p>ã€€ã€€ç°åœ¨æˆ‘ä»¬å¯ä»¥å¯¹ä»¥ä¸Šå››å±‚å«ä¹‰é€ä¸ªè®²è§£ã€‚</p>
<p>ã€€ã€€<strong>å­ç±»å¯ä»¥å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œä½†æ˜¯ä¸èƒ½è¦†ç›–çˆ¶ç±»çš„éæŠ½è±¡æ–¹æ³•</strong></p>
<p>ã€€ã€€åœ¨æˆ‘ä»¬åšç³»ç»Ÿè®¾è®¡æ—¶ï¼Œç»å¸¸ä¼šè®¾è®¡æ¥å£æˆ–æŠ½è±¡ç±»ï¼Œç„¶åç”±å­ç±»æ¥å®ç°æŠ½è±¡æ–¹æ³•ï¼Œè¿™é‡Œä½¿ç”¨çš„å…¶å®å°±æ˜¯é‡Œæ°æ›¿æ¢åŸåˆ™ã€‚å­ç±»å¯ä»¥å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•å¾ˆå¥½ç†è§£ï¼Œäº‹å®ä¸Šï¼Œå­ç±»ä¹Ÿå¿…é¡»å®Œå…¨å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œå“ªæ€•å†™ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œå¦åˆ™ä¼šç¼–è¯‘æŠ¥é”™ã€‚</p>
<p>ã€€ã€€é‡Œæ°æ›¿æ¢åŸåˆ™çš„å…³é”®ç‚¹åœ¨äºä¸èƒ½è¦†ç›–çˆ¶ç±»çš„éæŠ½è±¡æ–¹æ³•ã€‚çˆ¶ç±»ä¸­å‡¡æ˜¯å·²ç»å®ç°å¥½çš„æ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯åœ¨è®¾å®šä¸€ç³»åˆ—çš„è§„èŒƒå’Œå¥‘çº¦ï¼Œè™½ç„¶å®ƒä¸å¼ºåˆ¶è¦æ±‚æ‰€æœ‰çš„å­ç±»å¿…é¡»éµä»è¿™äº›è§„èŒƒï¼Œä½†æ˜¯å¦‚æœå­ç±»å¯¹è¿™äº›éæŠ½è±¡æ–¹æ³•ä»»æ„ä¿®æ”¹ï¼Œå°±ä¼šå¯¹æ•´ä¸ªç»§æ‰¿ä½“ç³»é€ æˆç ´åã€‚è€Œé‡Œæ°æ›¿æ¢åŸåˆ™å°±æ˜¯è¡¨è¾¾äº†è¿™ä¸€å±‚å«ä¹‰ã€‚</p>
<p>ã€€ã€€åœ¨é¢å‘å¯¹è±¡çš„è®¾è®¡æ€æƒ³ä¸­ï¼Œç»§æ‰¿è¿™ä¸€ç‰¹æ€§ä¸ºç³»ç»Ÿçš„è®¾è®¡å¸¦æ¥äº†æå¤§çš„ä¾¿åˆ©æ€§ï¼Œä½†æ˜¯ç”±ä¹‹è€Œæ¥çš„ä¹Ÿæ½œåœ¨ç€ä¸€äº›é£é™©ã€‚å°±åƒå¼€ç¯‡æ‰€æåˆ°çš„é‚£ä¸€åœºæ™¯ä¸€æ ·ï¼Œå¯¹äºé‚£ç§æƒ…å†µæœ€å¥½éµå¾ªé‡Œæ°æ›¿æ¢åŸåˆ™ï¼Œç±»C1ç»§æ‰¿ç±»Cæ—¶ï¼Œå¯ä»¥æ·»åŠ æ–°æ–¹æ³•å®Œæˆæ–°å¢åŠŸèƒ½ï¼Œå°½é‡ä¸è¦é‡å†™çˆ¶ç±»Cçš„æ–¹æ³•ã€‚å¦åˆ™å¯èƒ½å¸¦æ¥éš¾ä»¥é¢„æ–™çš„é£é™©ï¼Œæ¯”å¦‚ä¸‹é¢ä¸€ä¸ªç®€å•çš„ä¾‹å­è¿˜åŸå¼€ç¯‡çš„åœºæ™¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> a+b;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C1</span> <span class="keyword">extends</span> <span class="title">C</span></span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> a-b;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        C c = <span class="keyword">new</span> C1();</div><div class="line">        System.out.println(<span class="string">"2+1="</span> + c.func(<span class="number">2</span>, <span class="number">1</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">2</span>+<span class="number">1</span>=<span class="number">1</span></div></pre></td></tr></table></figure>
<p>ã€€ã€€ä¸Šé¢çš„è¿è¡Œç»“æœæ˜æ˜¾æ˜¯é”™è¯¯çš„ã€‚ç±»C1ç»§æ‰¿Cï¼Œåæ¥éœ€è¦å¢åŠ æ–°åŠŸèƒ½ï¼Œç±»C1å¹¶æ²¡æœ‰æ–°å†™ä¸€ä¸ªæ–¹æ³•ï¼Œè€Œæ˜¯ç›´æ¥é‡å†™äº†çˆ¶ç±»Cçš„funcæ–¹æ³•ï¼Œè¿èƒŒé‡Œæ°æ›¿æ¢åŸåˆ™ï¼Œå¼•ç”¨çˆ¶ç±»çš„åœ°æ–¹å¹¶ä¸èƒ½é€æ˜çš„ä½¿ç”¨å­ç±»çš„å¯¹è±¡ï¼Œå¯¼è‡´è¿è¡Œç»“æœå‡ºé”™ã€‚</p>
<p>ã€€ã€€<strong>å­ç±»ä¸­å¯ä»¥å¢åŠ è‡ªå·±ç‰¹æœ‰çš„æ–¹æ³•</strong></p>
<p>ã€€ã€€åœ¨ç»§æ‰¿çˆ¶ç±»å±æ€§å’Œæ–¹æ³•çš„åŒæ—¶ï¼Œæ¯ä¸ªå­ç±»ä¹Ÿéƒ½å¯ä»¥æœ‰è‡ªå·±çš„ä¸ªæ€§ï¼Œåœ¨çˆ¶ç±»çš„åŸºç¡€ä¸Šæ‰©å±•è‡ªå·±çš„åŠŸèƒ½ã€‚å‰é¢å…¶å®å·²ç»æåˆ°ï¼Œå½“åŠŸèƒ½æ‰©å±•æ—¶ï¼Œå­ç±»å°½é‡ä¸è¦é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œè€Œæ˜¯å¦å†™ä¸€ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥å¯¹ä¸Šé¢çš„ä»£ç åŠ ä»¥æ›´æ”¹ï¼Œä½¿å…¶ç¬¦åˆé‡Œæ°æ›¿æ¢åŸåˆ™ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> a+b;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C1</span> <span class="keyword">extends</span> <span class="title">C</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">func2</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> a-b;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        C1 c = <span class="keyword">new</span> C1();</div><div class="line">        System.out.println(<span class="string">"2-1="</span> + c.func2(<span class="number">2</span>, <span class="number">1</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">2</span>-<span class="number">1</span>=<span class="number">1</span></div></pre></td></tr></table></figure>
<p>ã€€ã€€<strong>å½“å­ç±»è¦†ç›–æˆ–å®ç°çˆ¶ç±»çš„æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„å‰ç½®æ¡ä»¶ï¼ˆå³æ–¹æ³•çš„å½¢å‚ï¼‰è¦æ¯”çˆ¶ç±»æ–¹æ³•çš„è¾“å…¥å‚æ•°æ›´å®½æ¾</strong></p>
<p>ä»£ç ç¤ºä¾‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Father</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">func</span><span class="params">(HashMap m)</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"æ‰§è¡Œçˆ¶ç±»..."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Son</span> <span class="keyword">extends</span> <span class="title">Father</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">func</span><span class="params">(Map m)</span></span>&#123;<span class="comment">//æ–¹æ³•çš„å½¢å‚æ¯”çˆ¶ç±»çš„æ›´å®½æ¾</span></div><div class="line">        System.out.println(<span class="string">"æ‰§è¡Œå­ç±»..."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Father f = <span class="keyword">new</span> Son();<span class="comment">//å¼•ç”¨åŸºç±»çš„åœ°æ–¹èƒ½é€æ˜åœ°ä½¿ç”¨å…¶å­ç±»çš„å¯¹è±¡ã€‚</span></div><div class="line">        HashMap h = <span class="keyword">new</span> HashMap();</div><div class="line">        f.func(h);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">æ‰§è¡Œçˆ¶ç±»...</div></pre></td></tr></table></figure>
<p>ã€€ã€€æ³¨æ„Sonç±»çš„funcæ–¹æ³•å‰é¢æ˜¯ä¸èƒ½åŠ @Overrideæ³¨è§£çš„ï¼Œå› ä¸ºå¦åˆ™ä¼šç¼–è¯‘æç¤ºæŠ¥é”™ï¼Œå› ä¸ºè¿™å¹¶ä¸æ˜¯é‡å†™ï¼ˆOverrideï¼‰ï¼Œè€Œæ˜¯é‡è½½ï¼ˆOverloadï¼‰ï¼Œå› ä¸ºæ–¹æ³•çš„è¾“å…¥å‚æ•°ä¸åŒã€‚é‡å†™å’Œé‡è½½çš„åŒºåˆ«åœ¨<a href="http://www.cnblogs.com/hellojava/archive/2013/02/27/2935450.html" target="_blank" rel="external">Javaé¢å‘å¯¹è±¡è¯¦è§£</a>ä¸€æ–‡ä¸­å·²ä½œè§£é‡Šï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚</p>
<p>ã€€ã€€<strong>å½“å­ç±»çš„æ–¹æ³•å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„åç½®æ¡ä»¶ï¼ˆå³æ–¹æ³•çš„è¿”å›å€¼ï¼‰è¦æ¯”çˆ¶ç±»æ›´ä¸¥æ ¼</strong></p>
<p>ä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Father</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Map <span class="title">func</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Son</span> <span class="keyword">extends</span> <span class="title">Father</span></span>&#123;</div><div class="line">     </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> HashMap <span class="title">func</span><span class="params">()</span></span>&#123;<span class="comment">//æ–¹æ³•çš„è¿”å›å€¼æ¯”çˆ¶ç±»çš„æ›´ä¸¥æ ¼</span></div><div class="line">        HashMap h = <span class="keyword">new</span> HashMap();</div><div class="line">        h.put(<span class="string">"h"</span>, <span class="string">"æ‰§è¡Œå­ç±»..."</span>);</div><div class="line">        <span class="keyword">return</span> h;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Father f = <span class="keyword">new</span> Son();<span class="comment">//å¼•ç”¨åŸºç±»çš„åœ°æ–¹èƒ½é€æ˜åœ°ä½¿ç”¨å…¶å­ç±»çš„å¯¹è±¡ã€‚</span></div><div class="line">        System.out.println(f.func());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;h=æ‰§è¡Œå­ç±»...&#125;</div></pre></td></tr></table></figure>
<p><strong>4ã€æ€»ç»“</strong></p>
<p>ã€€ã€€ç»§æ‰¿ä½œä¸ºé¢å‘å¯¹è±¡ä¸‰å¤§ç‰¹æ€§ä¹‹ä¸€ï¼Œåœ¨ç»™ç¨‹åºè®¾è®¡å¸¦æ¥å·¨å¤§ä¾¿åˆ©çš„åŒæ—¶ï¼Œä¹Ÿå¸¦æ¥äº†ä¸€äº›å¼Šç«¯ï¼Œå®ƒå¢åŠ äº†å¯¹è±¡ä¹‹é—´çš„è€¦åˆæ€§ã€‚å› æ­¤åœ¨ç³»ç»Ÿè®¾è®¡æ—¶ï¼Œéµå¾ªé‡Œæ°æ›¿æ¢åŸåˆ™ï¼Œå°½é‡é¿å…å­ç±»é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œå¯ä»¥æœ‰æ•ˆé™ä½ä»£ç å‡ºé”™çš„å¯èƒ½æ€§ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[å•ä¸€èŒè´£åŸåˆ™]]></title>
      <url>http://zsr.github.io/2016/09/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%85%AD%E5%A4%A7%E5%8E%9F%E5%88%99-%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3%E5%8E%9F%E5%88%99/</url>
      <content type="html"><![CDATA[<p>ã€€ã€€å‰è¨€ï¼šæ®è¯´è®¾è®¡æ¨¡å¼æ˜¯åŒºåˆ«ç¨‹åºå‘˜ä¸è½¯ä»¶è®¾è®¡å¸ˆçš„æ ‡å‡†ä¹‹ä¸€ã€‚å…¶å®åœ¨ç¼–ç¨‹å­¦ä¹ åˆæœŸå°±æ¥è§¦è¿‡è®¾è®¡æ¨¡å¼ï¼Œä½†æ˜¯éƒ½æ²¡æœ‰å†™è¿‡å¤šå°‘ä»£ç æ˜¯é¢†æ‚Ÿä¸åˆ°è®¾è®¡æ¨¡å¼çœŸæ­£çš„å¨åŠ›å’Œå¿…è¦æ€§çš„ã€‚ç°åœ¨è‡ªè®¤ä¸ºä¹Ÿå®è·µè¿‡ä¸å°‘æ®µæ—¶é—´äº†ï¼Œæ˜¯æ—¶å€™æ€»ç»“ä¸€ä¸‹è®¾è®¡æ¨¡å¼ã€‚ä¸çŸ¥è°è¯´è¿‡æ²¡æœ‰å†™è¿‡åä¸‡è¡Œä»¥ä¸Šä»£ç åˆ«è°ˆè®¾è®¡æ¨¡å¼ï¼Œè™½ç„¶ç•¥æ˜¾å¤¸å¼ ï¼Œä½†æ˜¯è¿˜æ˜¯å¾ˆæœ‰é“ç†çš„ã€‚åªæœ‰è‡ªå·±äº²èº«ç»å†è¿‡ä¸€äº›ç¼–å†™è®¾è®¡åƒåœ¾ä»£ç ï¼Œæ‰ä¼šæ·±åˆ»ç†è§£è®¾è®¡æ¨¡å¼çœŸæ­£çš„æ„ä¹‰æ‰€åœ¨ã€‚è®¾è®¡æ¨¡å¼éƒ½æ˜¯å‰è¾ˆå¤§ç‰›ä»¬åœ¨æ— æ•°æ¬¡å®è·µä¸­æ€»ç»“å‡ºæ¥çš„ï¼Œæˆ‘è¾ˆè‡ªç„¶è¦ç«™åœ¨å·¨äººè‚©è†€ä¸Šï¼Œå®è¡Œæ‹¿æ¥ä¸»ä¹‰å¹¶æ¶ˆåŒ–ä½¿ç”¨ä¹‹ã€‚</p>
<p><strong>1ã€é—®é¢˜çš„ç”±æ¥</strong></p>
<p>ã€€ã€€åˆå­¦è€…åœ¨ç¼–ç¨‹çš„æ—¶å€™å¯èƒ½ä¸€å¼€å§‹ä¼šæœ‰è¿™æ ·çš„ç»å†ï¼Œä½¿ç”¨ä¸€ä¸ªç±»æ¥å®ç°å¾ˆå¤šçš„åŠŸèƒ½ï¼Œæ–°æ·»åŠ çš„ç”šè‡³ä¸ç›¸å…³çš„åŠŸèƒ½éƒ½æ”¾åœ¨ä¸€ä¸ªç±»é‡Œæ¥å®ç°ï¼Œç…®æˆäº†ä¸€é”…å¤§æ‚çƒ©ï¼Œå¾€å¾€ä½¿å¾—æŸä¸ªç±»åŒ…ç½—ä¸‡è±¡ï¼Œæ— æ‰€ä¸èƒ½ã€‚å¯èƒ½åˆšå¼€å§‹å®ç°åŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œè¿™æ ·åšä¸ä¼šå¼•å‘ä»€ä¹ˆç‰¹åˆ«å¤§çš„é—®é¢˜ã€‚ä½†æ˜¯éšç€é¡¹ç›®å¤æ‚åº¦çš„æå‡ï¼Œå„ç§ä¸ç›¸å…³çš„å®ç°ä»£ç è€¦åˆåœ¨ä¸€èµ·ï¼Œä¸€æ—¦æœ‰åŠŸèƒ½çš„æ›´æ”¹æˆ–å¢åˆ ï¼Œä¿®æ”¹çš„ä»£ç å¾ˆå¯èƒ½ä¼šå¯¼è‡´å…¶ä»–åŠŸèƒ½çš„æ­£å¸¸è¿è¡Œã€‚è¿™ç§ç¼–ç¨‹æ–¹å¼æ˜¾ç„¶æ˜¯ä¸å¯å–çš„ï¼Œä¹Ÿå°±æ˜¯è¿èƒŒäº†æ‰€è°“çš„å•ä¸€èŒè´£åŸåˆ™ã€‚</p>
<p><strong>2ã€ä»€ä¹ˆæ˜¯å•ä¸€èŒè´£åŸåˆ™ï¼Ÿ</strong></p>
<p>ã€€ã€€å•ä¸€èŒè´£åŸåˆ™çš„è‹±æ–‡åç§°æ˜¯Single Responsibility Principleï¼Œç®€ç§°æ˜¯SRPã€‚SRPåŸåˆ™çš„è§£é‡Šæ˜¯ï¼šThere should never be more than one reason for a class to changeã€‚å®šä¹‰å¾ˆç®€å•ï¼Œå³ä¸èƒ½å­˜åœ¨å¤šäºä¸€ä¸ªå¯¼è‡´ç±»å˜æ›´çš„åŸå› ã€‚ç®€å•çš„è¯´å°±æ˜¯ä¸€ä¸ªç±»åªè´Ÿè´£ä¸€é¡¹èŒè´£ã€‚</p>
<p>ã€€ã€€åœ¨è½¯ä»¶è®¾è®¡ä¸­ï¼Œç§‰æ‰¿ç€â€œé«˜å†…èšï¼Œä½è€¦åˆâ€çš„æ€æƒ³ï¼Œè®©ä¸€ä¸ªç±»ä»…è´Ÿè´£ä¸€é¡¹èŒè´£ï¼Œå¦‚æœä¸€ä¸ªç±»æœ‰å¤šäºä¸€é¡¹çš„èŒè´£ï¼Œé‚£ä¹ˆå°±ä»£è¡¨è¿™ä¸ªç±»è€¦åˆæ€§å˜é«˜äº†ï¼Œè¿™äº›èŒè´£è€¦åˆåœ¨äº†ä¸€èµ·ï¼Œè¿™æ˜¯æ¯”è¾ƒè„†å¼±çš„è®¾è®¡ã€‚å› ä¸ºä¸€æ—¦æŸä¸€é¡¹èŒè´£å‘ç”Ÿäº†æ”¹å˜ï¼Œéœ€è¦å»æ›´æ”¹ä»£ç ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½ä¼šå¼•èµ·å…¶ä»–èŒè´£æ”¹å˜ã€‚æ‰€è°“ç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ï¼Œè¿™æ˜¾ç„¶æ˜¯æˆ‘ä»¬æ‰€ä¸æ„¿æ„çœ‹åˆ°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæŠŠè¿™ä¸ªç±»åˆ†æ‹†å¼€æ¥ï¼Œç”±ä¸¤ä¸ªç±»æ¥åˆ†åˆ«ç»´æŠ¤è¿™ä¸¤ä¸ªèŒè´£ï¼Œè¿™æ ·å½“ä¸€ä¸ªèŒè´£å‘ç”Ÿæ”¹å˜ï¼Œéœ€è¦ä¿®æ”¹æ—¶ï¼Œä¸ä¼šå½±å“åˆ°å¦ä¸€ä¸ªèŒè´£ã€‚</p>
<p>ã€€ã€€éœ€è¦è¯´æ˜çš„æ˜¯å•ä¸€èŒè´£åŸåˆ™ä¸åªæ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹æ€æƒ³æ‰€ç‰¹æœ‰çš„ï¼Œåªè¦æ˜¯æ¨¡å—åŒ–çš„ç¨‹åºè®¾è®¡ï¼Œéƒ½é€‚ç”¨å•ä¸€èŒè´£åŸåˆ™ã€‚</p>
<p><strong>3ã€å…³äºèŒè´£</strong></p>
<p>ã€€ã€€çœ‹åˆ°ä¸Šé¢æ‰€è¿°ï¼Œæˆ–è®¸æœ‰äººä¼šè¯´è¿™ä¹ˆç®€å•è°ä¸çŸ¥é“ã€‚çš„ç¡®ï¼Œå¾ˆå¤šç¨‹åºå‘˜å³ä½¿æ²¡æœ‰å­¦è¿‡è®¾è®¡æ¨¡å¼ï¼Œä¸çŸ¥é“å•ä¸€èŒè´£åŸåˆ™ï¼Œåœ¨ç¼–ç¨‹çš„æ—¶å€™ï¼Œåœ¨è®¾è®¡è½¯ä»¶æ—¶ä¹Ÿä¼šæœ‰æ„è¯†çš„éµå¾ªè¿™ä¸€åŸåˆ™ã€‚å› ä¸ºè°éƒ½ä¸å¸Œæœ›ä¿®æ”¹ä¸€ä¸ªåœ°æ–¹ä¼šå¼•å‘å¦å¤–ä¸€ä¸ªåœ°æ–¹å‡ºç°é—®é¢˜ï¼Œè€Œé¿å…è¿™ç§é—®é¢˜çš„æœ€å¥½å¤„ç†æ–¹å¼å°±æ˜¯è®¾è®¡æ—¶éµå¾ªå•ä¸€èŒè´£åŸåˆ™ã€‚ä½†æ˜¯ï¼Œæˆ‘è®¤ä¸ºå•ä¸€èŒè´£åŸåˆ™çš„éš¾ç‚¹æ˜¯åœ¨äºèŒè´£èŒƒå›´çš„è®¤å®šã€‚å…³äºèŒè´£çš„è®¤å®šæ˜¯ä¸€ä¸ªä»è€…è§ä»æ™ºè€…è§æ™ºçš„è¯é¢˜ï¼Œåœ¨å®é™…å¼€å‘ä¸­ä¹Ÿä¼šå¼•èµ·ç¨‹åºå‘˜ä¹‹é—´çš„äº‰è®ºã€‚æœ‰çš„äººè®¤ä¸ºè¿™äº›åŠŸèƒ½æ–¹æ³•çš„å®ç°ç›®çš„å¾ˆç›¸ä¼¼ï¼Œå¿…é¡»è¦æ”¾åœ¨ä¸€ä¸ªç±»ä¸­ï¼Œæœ‰çš„äººè®¤ä¸ºæ–¹æ³•å·®åˆ«å¾ˆå¤§ï¼Œå¿…é¡»è¦åˆ†æ‹†æˆå¤šä¸ªç±»ï¼Œåœ¨å¤šä¸ªç±»é‡Œé¢æ¥å®ç°ã€‚</p>
<p>ã€€ã€€è¿˜æœ‰èŒè´£çš„æ‰©æ•£é—®é¢˜ã€‚è½¯ä»¶ä¸€å¼€å‘å®Œä¸Šçº¿åå¹¶ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œéšç€ç¤¾ä¼šçš„è¿›æ­¥ï¼Œéœ€æ±‚çš„å˜æ›´ï¼Œè½¯ä»¶çš„åŠŸèƒ½å¯èƒ½è¦åšäº›ç»´æŠ¤æ›´æ”¹ï¼Œæœ‰æ—¶å€™ä¼šé‡åˆ°èŒè´£æ‰©æ•£ã€‚æ‰€è°“çš„èŒè´£æ‰©æ•£å°±æ˜¯å› ä¸ºæŸç§åŸå› ï¼ŒèŒè´£Rè¢«åˆ†åŒ–ä¸ºç²’åº¦æ›´ç»†çš„R1å’ŒR2ã€‚</p>
<p>ã€€ã€€æ¯”å¦‚ç±»Cåªè´Ÿè´£ä¸€ä¸ªèŒè´£Rï¼Œè¿™æ˜¯ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™çš„ã€‚ä½†æ˜¯åæ¥éœ€è¦æŠŠèŒè´£Ræ‹†åˆ†ä¸ºèŒè´£R1å’ŒèŒè´£R2ï¼Œé‚£ä¹ˆè¿™æ—¶å€™æ˜¯å¦éœ€è¦æ­»å®ˆç€å•ä¸€èŒè´£åŸåˆ™ï¼ŒæŠŠç±»Cä¹Ÿæ‹†å¼€ä¸ºC1å’ŒC2ã€‚æ¥ç€å¦‚æœR1åˆéœ€è¦ç»†åŒ–ä¸ºR11å’ŒR12å‘¢â€¦â€¦</p>
<p>ã€€ã€€æˆ‘ä»¬å¿…é¡»è¦æ„è¯†åˆ°ï¼Œä¸€å‘³çš„éµå®ˆå•ä¸€èŒè´£åŸåˆ™ï¼Œä¸åœçš„åˆ†æ‹†ç±»æ‰€ä»˜å‡ºçš„å¼€é”€æ˜¯å¾ˆå¤§çš„ã€‚è¿™æ—¶å€™å°±æ¶‰åŠåˆ°å¹³è¡¡çš„é—®é¢˜ï¼Œå¹³è¡¡å•ä¸€èŒè´£åŸåˆ™ä¸ä¿®æ”¹é€ æˆçš„å¼€é”€ã€‚æˆ‘çš„è§‚ç‚¹æ˜¯å¦‚æœä¸€ä¸ªæ–¹æ³•é€»è¾‘ä¸å¤æ‚çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä¿®æ”¹æ–¹æ³•å®ç°ï¼Œå¦åˆ™è¦æ‹†åˆ†ä¸ºä¸¤ä¸ªæ–¹æ³•ï¼Œéµå¾ªæ–¹æ³•çº§åˆ«çš„å•ä¸€èŒè´£åŸåˆ™ï¼›å¦‚æœä¸€ä¸ªç±»æ–¹æ³•ä¸å¤šçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åªå¢åŠ æ–¹æ³•ï¼Œè€Œä¸ç”¨åˆ†æ‹†ä¸ºå¤šä¸ªç±»ï¼Œå¦åˆ™è¦æ‹†åˆ†ä¸ºå¤šä¸ªç±»ï¼Œéµå¾ªç±»çº§åˆ«çš„å•ä¸€èŒè´£åŸåˆ™ã€‚</p>
<p><strong>4ã€éµå¾ªå•ä¸€èŒè´£åŸåˆ™çš„ä¼˜ç‚¹</strong></p>
<ul>
<li>é™ä½äº†ç±»çš„å¤æ‚åº¦ã€‚ä¸€ä¸ªç±»åªè´Ÿè´£ä¸€é¡¹èŒè´£æ¯”è´Ÿè´£å¤šé¡¹èŒè´£è¦ç®€å•å¾—å¤šã€‚</li>
<li>æé«˜äº†ä»£ç çš„å¯è¯»æ€§ã€‚ä¸€ä¸ªç±»ç®€å•äº†ï¼Œå¯è¯»æ€§è‡ªç„¶å°±æé«˜äº†ã€‚</li>
<li>æé«˜äº†ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ã€‚ä»£ç çš„å¯è¯»æ€§é«˜äº†ï¼Œå¹¶ä¸”ä¿®æ”¹ä¸€é¡¹èŒè´£å¯¹å…¶ä»–èŒè´£å½±å“é™ä½äº†ï¼Œå¯ç»´æŠ¤æ€§è‡ªç„¶å°±æé«˜äº†ã€‚</li>
<li>å˜æ›´å¼•èµ·çš„é£é™©å˜ä½äº†ã€‚å•ä¸€èŒè´£æœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯ä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½ï¼Œå¯¹å…¶ä»–åŠŸèƒ½çš„å½±å“æ˜¾è‘—é™ä½ã€‚</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Servlet Listener]]></title>
      <url>http://zsr.github.io/2016/09/06/Servlet-Listener/</url>
      <content type="html"><![CDATA[<h2 id="Listener-ç›‘å¬å™¨"><a href="#Listener-ç›‘å¬å™¨" class="headerlink" title="Listener ç›‘å¬å™¨"></a><strong>Listener ç›‘å¬å™¨</strong></h2><h3 id="1ã€Listenerçš„å®šä¹‰ä¸ä½œç”¨"><a href="#1ã€Listenerçš„å®šä¹‰ä¸ä½œç”¨" class="headerlink" title="1ã€Listenerçš„å®šä¹‰ä¸ä½œç”¨"></a><strong>1ã€Listenerçš„å®šä¹‰ä¸ä½œç”¨</strong></h3><p>ç›‘å¬å™¨Listenerå°±æ˜¯åœ¨application,session,requestä¸‰ä¸ªå¯¹è±¡åˆ›å»ºã€é”€æ¯æˆ–è€…å¾€å…¶ä¸­æ·»åŠ ä¿®æ”¹åˆ é™¤å±æ€§æ—¶è‡ªåŠ¨æ‰§è¡Œä»£ç çš„åŠŸèƒ½ç»„ä»¶ã€‚</p>
<p>Listeneræ˜¯Servletçš„ç›‘å¬å™¨ï¼Œå¯ä»¥ç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼ŒæœåŠ¡ç«¯çš„æ“ä½œç­‰ã€‚</p>
<h3 id="2ã€Listenerçš„åˆ†ç±»ä¸ä½¿ç”¨"><a href="#2ã€Listenerçš„åˆ†ç±»ä¸ä½¿ç”¨" class="headerlink" title="2ã€Listenerçš„åˆ†ç±»ä¸ä½¿ç”¨"></a><strong>2ã€Listenerçš„åˆ†ç±»ä¸ä½¿ç”¨</strong></h3><p>ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç±»ï¼š</p>
<h4 id="2-1ã€ServletContextç›‘å¬"><a href="#2-1ã€ServletContextç›‘å¬" class="headerlink" title="2.1ã€ServletContextç›‘å¬"></a>2.1ã€<strong>ServletContextç›‘å¬</strong></h4><ul>
<li><strong>ServletContextListener</strong>ï¼šç”¨äºå¯¹Servletæ•´ä¸ªä¸Šä¸‹æ–‡è¿›è¡Œç›‘å¬ï¼ˆåˆ›å»ºã€é”€æ¯ï¼‰ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent sce)</span></span>;<span class="comment">//ä¸Šä¸‹æ–‡åˆå§‹åŒ–</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span></span>;<span class="comment">//ä¸Šä¸‹æ–‡é”€æ¯</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> ServletContext <span class="title">getServletContext</span><span class="params">()</span></span>;<span class="comment">//ServletContextEventäº‹ä»¶ï¼šå–å¾—ä¸€ä¸ªServletContextï¼ˆapplicationï¼‰å¯¹è±¡</span></div></pre></td></tr></table></figure>
<ul>
<li><strong>ServletContextAttributeListener</strong>ï¼šå¯¹Servletä¸Šä¸‹æ–‡å±æ€§çš„ç›‘å¬ï¼ˆå¢åˆ æ”¹å±æ€§ï¼‰ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attributeAdded</span><span class="params">(ServletContextAttributeEvent scab)</span></span>;<span class="comment">//å¢åŠ å±æ€§</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attributeRemoved</span><span class="params">(ServletContextAttributeEvent scab)</span></span>;<span class="comment">//å±æ€§åˆ é™¤</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attributeRepalced</span><span class="params">(ServletContextAttributeEvent scab)</span></span>;<span class="comment">//å±æ€§æ›¿æ¢ï¼ˆç¬¬äºŒæ¬¡è®¾ç½®åŒä¸€å±æ€§ï¼‰</span></div><div class="line"></div><div class="line"><span class="comment">//ServletContextAttributeEventäº‹ä»¶ï¼šèƒ½å–å¾—è®¾ç½®å±æ€§çš„åç§°ä¸å†…å®¹</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>;<span class="comment">//å¾—åˆ°å±æ€§åç§°</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span></span>;<span class="comment">//å–å¾—å±æ€§çš„å€¼</span></div></pre></td></tr></table></figure>
<h4 id="2-2ã€Sessionç›‘å¬"><a href="#2-2ã€Sessionç›‘å¬" class="headerlink" title="2.2ã€Sessionç›‘å¬"></a>2.2ã€<strong>Sessionç›‘å¬</strong></h4><p>Sessionå±äºhttpåè®®ä¸‹çš„å†…å®¹ï¼Œæ¥å£ä½äºjavax.servlet.http.*åŒ…ä¸‹ã€‚</p>
<ul>
<li><strong>HttpSessionListeneræ¥å£</strong>ï¼šå¯¹Sessionçš„æ•´ä½“çŠ¶æ€çš„ç›‘å¬ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionCreated</span><span class="params">(HttpSessionEvent se)</span></span>;<span class="comment">//sessionåˆ›å»º</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionDestroyed</span><span class="params">(HttpSessionEvent se)</span></span>;<span class="comment">//sessioné”€æ¯</span></div><div class="line"></div><div class="line"><span class="comment">//HttpSessionEventäº‹ä»¶ï¼š</span></div><div class="line"><span class="function"><span class="keyword">public</span> HttpSession <span class="title">getSession</span><span class="params">()</span></span>;<span class="comment">//å–å¾—å½“å‰æ“ä½œçš„session</span></div></pre></td></tr></table></figure>
<ul>
<li><strong>HttpSessionAttributeListeneræ¥å£</strong>ï¼šå¯¹sessionçš„å±æ€§ç›‘å¬ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attributeAdded</span><span class="params">(HttpSessionBindingEvent se)</span></span>;<span class="comment">//å¢åŠ å±æ€§</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attributeRemoved</span><span class="params">(HttpSessionBindingEvent se)</span></span>;<span class="comment">//åˆ é™¤å±æ€§</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attributeReplaced</span><span class="params">(HttpSessionBindingEvent se)</span></span>;<span class="comment">//æ›¿æ¢å±æ€§</span></div><div class="line"></div><div class="line"><span class="comment">//HttpSessionBindingEventäº‹ä»¶ï¼š</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>;<span class="comment">//å–å¾—å±æ€§çš„åç§°</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span></span>;<span class="comment">//å–å¾—å±æ€§çš„å€¼</span></div><div class="line"><span class="function"><span class="keyword">public</span> HttpSession <span class="title">getSession</span><span class="params">()</span></span>;<span class="comment">//å–å¾—å½“å‰çš„session</span></div></pre></td></tr></table></figure>
<p>sessionçš„é”€æ¯æœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>sessionè¶…æ—¶ï¼Œweb.xmlé…ç½®ï¼š</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;session-config&gt;</div><div class="line">    &lt;session-timeout&gt;120&lt;/session-timeout&gt;&lt;!--session120åˆ†é’Ÿåè¶…æ—¶é”€æ¯--&gt;</div><div class="line">&lt;/session-config&gt;</div></pre></td></tr></table></figure>
<ul>
<li>æ‰‹å·¥ä½¿sessionå¤±æ•ˆ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä½¿sessionå¤±æ•ˆæ–¹æ³•ã€‚session.invalidate();</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure>
<h4 id="2-3ã€Requestç›‘å¬"><a href="#2-3ã€Requestç›‘å¬" class="headerlink" title="2.3ã€Requestç›‘å¬"></a><strong>2.3ã€Requestç›‘å¬</strong></h4><ul>
<li>ServletRequestListenerï¼šç”¨äºå¯¹Requestè¯·æ±‚è¿›è¡Œç›‘å¬ï¼ˆåˆ›å»ºã€é”€æ¯ï¼‰ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span></span>;<span class="comment">//requeståˆå§‹åŒ–</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span></span>;<span class="comment">//requesté”€æ¯</span></div><div class="line"></div><div class="line"><span class="comment">//ServletRequestEventäº‹ä»¶ï¼š</span></div><div class="line"><span class="function"><span class="keyword">public</span> ServletRequest <span class="title">getServletRequest</span><span class="params">()</span></span>;<span class="comment">//å–å¾—ä¸€ä¸ªServletRequestå¯¹è±¡</span></div><div class="line"><span class="function"><span class="keyword">public</span> ServletContext <span class="title">getServletContext</span><span class="params">()</span></span>;<span class="comment">//å–å¾—ä¸€ä¸ªServletContextï¼ˆapplicationï¼‰å¯¹è±¡</span></div></pre></td></tr></table></figure>
<ul>
<li>ServletRequestAttributeListenerï¼šå¯¹Requestå±æ€§çš„ç›‘å¬ï¼ˆå¢åˆ æ”¹å±æ€§ï¼‰ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attributeAdded</span><span class="params">(ServletRequestAttributeEvent srae)</span></span>;<span class="comment">//å¢åŠ å±æ€§</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attributeRemoved</span><span class="params">(ServletRequestAttributeEvent srae)</span></span>;<span class="comment">//å±æ€§åˆ é™¤</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attributeReplaced</span><span class="params">(ServletRequestAttributeEvent srae)</span></span>;<span class="comment">//å±æ€§æ›¿æ¢ï¼ˆç¬¬äºŒæ¬¡è®¾ç½®åŒä¸€å±æ€§ï¼‰</span></div><div class="line"></div><div class="line"><span class="comment">//ServletRequestAttributeEventäº‹ä»¶ï¼šèƒ½å–å¾—è®¾ç½®å±æ€§çš„åç§°ä¸å†…å®¹</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>;<span class="comment">//å¾—åˆ°å±æ€§åç§°</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span></span>;<span class="comment">//å–å¾—å±æ€§çš„å€¼</span></div></pre></td></tr></table></figure>
<h3 id="3ã€åœ¨web-xmlä¸­é…ç½®"><a href="#3ã€åœ¨web-xmlä¸­é…ç½®" class="headerlink" title="3ã€åœ¨web.xmlä¸­é…ç½®"></a><strong>3ã€åœ¨web.xmlä¸­é…ç½®</strong></h3><p>Listeneré…ç½®ä¿¡æ¯å¿…é¡»åœ¨Filterå’ŒServleté…ç½®ä¹‹å‰ï¼ŒListenerçš„åˆå§‹åŒ–ï¼ˆServletContentListeneråˆå§‹åŒ–ï¼‰æ¯”Servletå’ŒFilteréƒ½ä¼˜å…ˆï¼Œè€Œé”€æ¯æ¯”Servletå’ŒFilteréƒ½æ…¢ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;listener&gt;</div><div class="line">    &lt;listener-<span class="class"><span class="keyword">class</span>&gt;<span class="title">com</span>.<span class="title">listener</span>.<span class="title">class</span>&lt;/<span class="title">listener</span>-<span class="title">class</span>&gt;</span></div><div class="line">&lt;/<span class="title">listener</span>&gt;</div></pre></td></tr></table></figure>
<h3 id="4ã€Listeneråº”ç”¨å®ä¾‹"><a href="#4ã€Listeneråº”ç”¨å®ä¾‹" class="headerlink" title="4ã€Listeneråº”ç”¨å®ä¾‹"></a><strong>4ã€Listeneråº”ç”¨å®ä¾‹</strong></h3><h4 id="4-1ã€Springä½¿ç”¨ContextLoaderListeneråŠ è½½ApplicationContexté…ç½®ä¿¡æ¯"><a href="#4-1ã€Springä½¿ç”¨ContextLoaderListeneråŠ è½½ApplicationContexté…ç½®ä¿¡æ¯" class="headerlink" title="4.1ã€Springä½¿ç”¨ContextLoaderListeneråŠ è½½ApplicationContexté…ç½®ä¿¡æ¯"></a><strong>4.1ã€Springä½¿ç”¨ContextLoaderListeneråŠ è½½ApplicationContexté…ç½®ä¿¡æ¯</strong></h4><p>ContextLoaderListenerçš„ä½œç”¨å°±æ˜¯å¯åŠ¨Webå®¹å™¨æ—¶ï¼Œè‡ªåŠ¨è£…é…ApplicationContextçš„é…ç½®ä¿¡æ¯ã€‚å› ä¸ºå®ƒå®ç°äº†ServletContextListenerè¿™ä¸ªæ¥å£ï¼Œåœ¨web.xmlé…ç½®è¿™ä¸ªç›‘å¬å™¨ï¼Œå¯åŠ¨å®¹å™¨æ—¶ï¼Œå°±ä¼šé»˜è®¤æ‰§è¡Œå®ƒå®ç°çš„æ–¹æ³•ã€‚</p>
<p>ContextLoaderListenerå¦‚ä½•æŸ¥æ‰¾ApplicationContext.xmlçš„é…ç½®ä½ç½®ä»¥åŠé…ç½®å¤šä¸ªxmlï¼šå¦‚æœåœ¨web.xmlä¸­ä¸å†™ä»»ä½•å‚æ•°é…ç½®ä¿¡æ¯ï¼Œé»˜è®¤çš„è·¯å¾„æ˜¯â€/WEB-INF/applicationContext.xmlâ€ï¼Œåœ¨WEB-INFç›®å½•ä¸‹åˆ›å»ºçš„xmlæ–‡ä»¶çš„åç§°å¿…é¡»æ˜¯applicationContext.xmlï¼ˆåœ¨MyEclipseä¸­æŠŠxmlæ–‡ä»¶æ”¾ç½®åœ¨srcç›®å½•ä¸‹ï¼‰ã€‚å¦‚æœæ˜¯è¦è‡ªå®šä¹‰æ–‡ä»¶åå¯ä»¥åœ¨web.xmlé‡ŒåŠ å…¥contextConfigLocationè¿™ä¸ªcontextå‚æ•°ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;context-param&gt;</div><div class="line">    &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</div><div class="line">    &lt;param-value&gt;classpath:spring/applicationContext-*.xml&lt;/param-value&gt;&lt;!-- é‡‡ç”¨çš„æ˜¯é€šé…ç¬¦æ–¹å¼ï¼ŒæŸ¥æ‰¾WEB-INF/springç›®å½•ä¸‹xmlæ–‡ä»¶ã€‚å¦‚æœ‰å¤šä¸ªxmlæ–‡ä»¶ï¼Œä»¥â€œ,â€åˆ†éš”ã€‚ --&gt;</div><div class="line">&lt;/context-param&gt;</div><div class="line">&lt;listener&gt;</div><div class="line">    &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;</div><div class="line">&lt;/listener&gt;</div></pre></td></tr></table></figure>
<h4 id="4-2ã€Springä½¿ç”¨Log4jConfigListeneré…ç½®Log4jæ—¥å¿—"><a href="#4-2ã€Springä½¿ç”¨Log4jConfigListeneré…ç½®Log4jæ—¥å¿—" class="headerlink" title="4.2ã€Springä½¿ç”¨Log4jConfigListeneré…ç½®Log4jæ—¥å¿—"></a><strong>4.2ã€Springä½¿ç”¨Log4jConfigListeneré…ç½®Log4jæ—¥å¿—</strong></h4><p>Springä½¿ç”¨Log4jConfigListener(å®ç°äº†ServletContextListeneræ¥å£)çš„å¥½å¤„ï¼š</p>
<ul>
<li>åŠ¨æ€çš„æ”¹å˜è®°å½•çº§åˆ«å’Œç­–ç•¥ï¼Œä¸éœ€è¦é‡å¯Webåº”ç”¨ã€‚</li>
<li>æŠŠlogæ–‡ä»¶å®šåœ¨ /WEB-INF/logs/ è€Œä¸éœ€è¦å†™ç»å¯¹è·¯å¾„ã€‚å› ä¸ºç³»ç»ŸæŠŠwebç›®å½•çš„è·¯å¾„å‹å…¥ä¸€ä¸ªå«webapp.rootçš„ç³»ç»Ÿå˜é‡ã€‚è¿™æ ·å†™logæ–‡ä»¶è·¯å¾„æ—¶ä¸ç”¨å†™ç»å¯¹è·¯å¾„äº†ã€‚</li>
<li>å¯ä»¥æŠŠlog4j.propertieså’Œå…¶ä»–propertiesä¸€èµ·æ”¾åœ¨/WEB-INF/ ï¼Œè€Œä¸æ˜¯Class-Pathã€‚</li>
<li>è®¾ç½®log4jRefreshIntervalæ—¶é—´ï¼Œå¼€ä¸€æ¡watchdogçº¿ç¨‹æ¯éš”æ®µæ—¶é—´æ‰«æä¸€ä¸‹é…ç½®æ–‡ä»¶çš„å˜åŒ–ã€‚</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;context-param&gt;</div><div class="line">    &lt;param-name&gt;webAppRootKey&lt;/param-name&gt;</div><div class="line">    &lt;param-value&gt;project.root&lt;/param-value&gt;&lt;!-- ç”¨äºå®šä½logæ–‡ä»¶è¾“å‡ºä½ç½®åœ¨webåº”ç”¨æ ¹ç›®å½•ä¸‹ï¼Œlog4jé…ç½®æ–‡ä»¶ä¸­å†™è¾“å‡ºä½ç½®ï¼šlog4j.appender.FILE.File=$&#123;project.root&#125;/logs/project.log --&gt;</div><div class="line">&lt;/context-param&gt;</div><div class="line">&lt;context-param&gt;</div><div class="line">    &lt;param-name&gt;log4jConfigLocation&lt;/param-name&gt;</div><div class="line">    &lt;param-value&gt;classpath:log4j.properties&lt;/param-value&gt;&lt;!-- è½½å…¥log4jé…ç½®æ–‡ä»¶ --&gt;</div><div class="line">&lt;/context-param&gt;</div><div class="line">&lt;context-param&gt;</div><div class="line">    &lt;param-name&gt;log4jRefreshInterval&lt;/param-name&gt;</div><div class="line">    &lt;param-value&gt;60000&lt;/param-value&gt;&lt;!--Springåˆ·æ–°Log4jé…ç½®æ–‡ä»¶çš„é—´éš”60ç§’,å•ä½ä¸ºmillisecond--&gt;</div><div class="line">&lt;/context-param&gt;</div><div class="line">&lt;listener&gt;</div><div class="line">    &lt;listener-class&gt;org.springframework.web.util.Log4jConfigListener&lt;/listener-class&gt;</div><div class="line">&lt;/listener&gt;</div></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Servlet Filter]]></title>
      <url>http://zsr.github.io/2016/09/06/Servlet-Filter/</url>
      <content type="html"><![CDATA[<h2 id="Filter-è¿‡æ»¤å™¨"><a href="#Filter-è¿‡æ»¤å™¨" class="headerlink" title="Filter è¿‡æ»¤å™¨"></a><strong>Filter è¿‡æ»¤å™¨</strong></h2><h3 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. <strong>ç®€ä»‹</strong></h3><p>Filterä¹Ÿç§°ä¹‹ä¸ºè¿‡æ»¤å™¨ï¼Œå®ƒæ˜¯ServletæŠ€æœ¯ä¸­æœ€å®ç”¨çš„æŠ€æœ¯ï¼ŒWEBå¼€å‘äººå‘˜é€šè¿‡FilteræŠ€æœ¯ï¼Œå¯¹webæœåŠ¡å™¨ç®¡ç†çš„æ‰€æœ‰webèµ„æºï¼šä¾‹å¦‚Jsp, Servlet, é™æ€å›¾ç‰‡æ–‡ä»¶æˆ–é™æ€ html æ–‡ä»¶ç­‰è¿›è¡Œæ‹¦æˆªï¼Œä»è€Œå®ç°ä¸€äº›ç‰¹æ®Šçš„åŠŸèƒ½ã€‚ä¾‹å¦‚å®ç°URLçº§åˆ«çš„æƒé™è®¿é—®æ§åˆ¶ã€è¿‡æ»¤æ•æ„Ÿè¯æ±‡ã€å‹ç¼©å“åº”ä¿¡æ¯ç­‰ä¸€äº›é«˜çº§åŠŸèƒ½ã€‚</p>
<p>å®ƒä¸»è¦ç”¨äºå¯¹ç”¨æˆ·è¯·æ±‚è¿›è¡Œé¢„å¤„ç†ï¼Œä¹Ÿå¯ä»¥å¯¹HttpServletResponse è¿›è¡Œåå¤„ç†ã€‚ä½¿ç”¨Filter çš„å®Œæ•´æµç¨‹ï¼šFilter å¯¹ç”¨æˆ·è¯·æ±‚è¿›è¡Œé¢„å¤„ç†ï¼Œæ¥ç€å°†è¯·æ±‚äº¤ç»™Servlet è¿›è¡Œå¤„ç†å¹¶ç”Ÿæˆå“åº”ï¼Œæœ€åFilter å†å¯¹æœåŠ¡å™¨å“åº”è¿›è¡Œåå¤„ç†ã€‚</p>
<p>ã€€ã€€FilteråŠŸèƒ½ï¼š</p>
<ul>
<li>åœ¨HttpServletRequest åˆ°è¾¾ Servlet ä¹‹å‰ï¼Œæ‹¦æˆªå®¢æˆ·çš„ HttpServletRequest ã€‚ æ ¹æ®éœ€è¦æ£€æŸ¥ HttpServletRequest ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹HttpServletRequest å¤´å’Œæ•°æ®ã€‚</li>
<li>åœ¨HttpServletResponse åˆ°è¾¾å®¢æˆ·ç«¯ä¹‹å‰ï¼Œæ‹¦æˆªHttpServletResponse ã€‚ æ ¹æ®éœ€è¦æ£€æŸ¥ HttpServletResponse ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹HttpServletResponseå¤´å’Œæ•°æ®ã€‚</li>
</ul>
<h3 id="2-å¦‚ä½•å®ç°æ‹¦æˆª"><a href="#2-å¦‚ä½•å®ç°æ‹¦æˆª" class="headerlink" title="2. å¦‚ä½•å®ç°æ‹¦æˆª"></a>2. <strong>å¦‚ä½•å®ç°æ‹¦æˆª</strong></h3><p>Filteræ¥å£ä¸­æœ‰ä¸€ä¸ªdoFilteræ–¹æ³•ï¼Œå½“å¼€å‘äººå‘˜ç¼–å†™å¥½Filterï¼Œå¹¶é…ç½®å¯¹å“ªä¸ªwebèµ„æºè¿›è¡Œæ‹¦æˆªåï¼ŒWEBæœåŠ¡å™¨æ¯æ¬¡åœ¨è°ƒç”¨webèµ„æºçš„serviceæ–¹æ³•ä¹‹å‰ï¼Œéƒ½ä¼šå…ˆè°ƒç”¨ä¸€ä¸‹filterçš„doFilteræ–¹æ³•ï¼Œå› æ­¤ï¼Œåœ¨è¯¥æ–¹æ³•å†…ç¼–å†™ä»£ç å¯è¾¾åˆ°å¦‚ä¸‹ç›®çš„ï¼š</p>
<ul>
<li>è°ƒç”¨ç›®æ ‡èµ„æºä¹‹å‰ï¼Œè®©ä¸€æ®µä»£ç æ‰§è¡Œã€‚</li>
<li>æ˜¯å¦è°ƒç”¨ç›®æ ‡èµ„æºï¼ˆå³æ˜¯å¦è®©ç”¨æˆ·è®¿é—®webèµ„æºï¼‰ã€‚</li>
</ul>
<p>webæœåŠ¡å™¨åœ¨è°ƒç”¨doFilteræ–¹æ³•æ—¶ï¼Œä¼šä¼ é€’ä¸€ä¸ªfilterChainå¯¹è±¡è¿›æ¥ï¼Œ<strong>filterChainå¯¹è±¡æ˜¯filteræ¥å£ä¸­æœ€é‡è¦çš„ä¸€ä¸ªå¯¹è±¡</strong>ï¼Œå®ƒä¹Ÿæä¾›äº†ä¸€ä¸ªdoFilteræ–¹æ³•ï¼Œå¼€å‘äººå‘˜å¯ä»¥æ ¹æ®éœ€æ±‚å†³å®šæ˜¯å¦è°ƒç”¨æ­¤æ–¹æ³•ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œåˆ™webæœåŠ¡å™¨å°±ä¼šè°ƒç”¨webèµ„æºçš„serviceæ–¹æ³•ï¼Œå³webèµ„æºå°±ä¼šè¢«è®¿é—®ï¼Œå¦åˆ™webèµ„æºä¸ä¼šè¢«è®¿é—®ã€‚ </p>
<h3 id="3-Filterå¼€å‘ä¸¤æ­¥èµ°"><a href="#3-Filterå¼€å‘ä¸¤æ­¥èµ°" class="headerlink" title="3. Filterå¼€å‘ä¸¤æ­¥èµ°"></a>3. <strong>Filterå¼€å‘ä¸¤æ­¥èµ°</strong></h3><ul>
<li><ol>
<li>ç¼–å†™javaç±»å®ç°Filteræ¥å£ï¼Œå¹¶å®ç°å…¶doFilteræ–¹æ³•ã€‚ </li>
</ol>
</li>
<li><ol>
<li>åœ¨ web.xml æ–‡ä»¶ä¸­ä½¿ç”¨<filter>å’Œ<filter-mapping>å…ƒç´ å¯¹ç¼–å†™çš„filterç±»è¿›è¡Œæ³¨å†Œï¼Œå¹¶è®¾ç½®å®ƒæ‰€èƒ½æ‹¦æˆªçš„èµ„æºã€‚</filter-mapping></filter></li>
</ol>
</li>
</ul>
<p>web.xmlé…ç½®å„èŠ‚ç‚¹ä»‹ç»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;filter-name&gt;ç”¨äºä¸ºè¿‡æ»¤å™¨æŒ‡å®šä¸€ä¸ªåå­—ï¼Œè¯¥å…ƒç´ çš„å†…å®¹ä¸èƒ½ä¸ºç©ºã€‚ </div><div class="line">&lt;filter-<span class="class"><span class="keyword">class</span>&gt;å…ƒç´ ç”¨äºæŒ‡å®šè¿‡æ»¤å™¨çš„å®Œæ•´çš„é™å®šç±»åã€‚ </span></div><div class="line">&lt;<span class="title">init</span>-<span class="title">param</span>&gt;å…ƒç´ ç”¨äºä¸ºè¿‡æ»¤å™¨æŒ‡å®šåˆå§‹åŒ–å‚æ•°ï¼Œå®ƒçš„å­å…ƒç´ &lt;<span class="title">param</span>-<span class="title">name</span>&gt;æŒ‡å®šå‚æ•°çš„åå­—ï¼Œ&lt;<span class="title">param</span>-<span class="title">value</span>&gt;æŒ‡å®šå‚æ•°çš„å€¼ã€‚</div><div class="line">åœ¨è¿‡æ»¤å™¨ä¸­ï¼Œå¯ä»¥ä½¿ç”¨<span class="title">FilterConfig</span>æ¥å£å¯¹è±¡æ¥è®¿é—®åˆå§‹åŒ–å‚æ•°ã€‚</div><div class="line"></div><div class="line">&lt;<span class="title">filter</span>-<span class="title">mapping</span>&gt;å…ƒç´ ç”¨äºè®¾ç½®ä¸€ä¸ª <span class="title">Filter</span> æ‰€è´Ÿè´£æ‹¦æˆªçš„èµ„æºã€‚ä¸€ä¸ª<span class="title">Filter</span>æ‹¦æˆªçš„èµ„æºå¯é€šè¿‡ä¸¤ç§æ–¹å¼æ¥æŒ‡å®šï¼š<span class="title">Servlet</span> åç§°å’Œèµ„æºè®¿é—®çš„è¯·æ±‚è·¯å¾„ </div><div class="line">&lt;<span class="title">filter</span>-<span class="title">name</span>&gt;å­å…ƒç´ ç”¨äºè®¾ç½®<span class="title">filter</span>çš„æ³¨å†Œåç§°ã€‚è¯¥å€¼å¿…é¡»æ˜¯åœ¨&lt;<span class="title">filter</span>&gt;å…ƒç´ ä¸­å£°æ˜è¿‡çš„è¿‡æ»¤å™¨çš„åå­— </div><div class="line">&lt;<span class="title">url</span>-<span class="title">pattern</span>&gt;è®¾ç½® <span class="title">filter</span> æ‰€æ‹¦æˆªçš„è¯·æ±‚è·¯å¾„(è¿‡æ»¤å™¨å…³è”çš„<span class="title">URL</span>æ ·å¼) </div><div class="line">&lt;<span class="title">servlet</span>-<span class="title">name</span>&gt;æŒ‡å®šè¿‡æ»¤å™¨æ‰€æ‹¦æˆªçš„<span class="title">Servlet</span>åç§°ã€‚ </div><div class="line">&lt;<span class="title">dispatcher</span>&gt;æŒ‡å®šè¿‡æ»¤å™¨æ‰€æ‹¦æˆªçš„èµ„æºè¢« <span class="title">Servlet</span> å®¹å™¨è°ƒç”¨çš„æ–¹å¼ï¼Œå¯ä»¥æ˜¯<span class="title">REQUEST</span>,<span class="title">INCLUDE</span>,<span class="title">FORWARD</span>å’Œ<span class="title">ERROR</span>ä¹‹ä¸€ï¼Œé»˜è®¤<span class="title">REQUEST</span>ã€‚ç”¨æˆ·å¯ä»¥è®¾ç½®å¤šä¸ª&lt;<span class="title">dispatcher</span>&gt; å­å…ƒç´ ç”¨æ¥æŒ‡å®š <span class="title">Filter</span> å¯¹èµ„æºçš„å¤šç§è°ƒç”¨æ–¹å¼è¿›è¡Œæ‹¦æˆªã€‚ </div><div class="line"></div><div class="line">&lt;<span class="title">dispatcher</span>&gt; å­å…ƒç´ å¯ä»¥è®¾ç½®çš„å€¼åŠå…¶æ„ä¹‰ï¼š </div><div class="line"><span class="title">REQUEST</span>ï¼šå½“ç”¨æˆ·ç›´æ¥è®¿é—®é¡µé¢æ—¶ï¼Œ<span class="title">Web</span>å®¹å™¨å°†ä¼šè°ƒç”¨è¿‡æ»¤å™¨ã€‚å¦‚æœç›®æ ‡èµ„æºæ˜¯é€šè¿‡<span class="title">RequestDispatcher</span>çš„<span class="title">include</span>()æˆ–<span class="title">forward</span>()æ–¹æ³•è®¿é—®æ—¶ï¼Œé‚£ä¹ˆè¯¥è¿‡æ»¤å™¨å°±ä¸ä¼šè¢«è°ƒç”¨ã€‚ </div><div class="line"><span class="title">INCLUDE</span>ï¼šå¦‚æœç›®æ ‡èµ„æºæ˜¯é€šè¿‡<span class="title">RequestDispatcher</span>çš„<span class="title">include</span>()æ–¹æ³•è®¿é—®æ—¶ï¼Œé‚£ä¹ˆè¯¥è¿‡æ»¤å™¨å°†è¢«è°ƒç”¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¯¥è¿‡æ»¤å™¨ä¸ä¼šè¢«è°ƒç”¨ã€‚ </div><div class="line"><span class="title">FORWARD</span>ï¼šå¦‚æœç›®æ ‡èµ„æºæ˜¯é€šè¿‡<span class="title">RequestDispatcher</span>çš„<span class="title">forward</span>()æ–¹æ³•è®¿é—®æ—¶ï¼Œé‚£ä¹ˆè¯¥è¿‡æ»¤å™¨å°†è¢«è°ƒç”¨ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¯¥è¿‡æ»¤å™¨ä¸ä¼šè¢«è°ƒç”¨ã€‚ </div><div class="line"><span class="title">ERROR</span>ï¼šå¦‚æœç›®æ ‡èµ„æºæ˜¯é€šè¿‡å£°æ˜å¼å¼‚å¸¸å¤„ç†æœºåˆ¶è°ƒç”¨æ—¶ï¼Œé‚£ä¹ˆè¯¥è¿‡æ»¤å™¨å°†è¢«è°ƒç”¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿‡æ»¤å™¨ä¸ä¼šè¢«è°ƒç”¨ã€‚</div></pre></td></tr></table></figure>
<h3 id="4-Filteré“¾"><a href="#4-Filteré“¾" class="headerlink" title="4. Filteré“¾"></a>4. <strong>Filteré“¾</strong></h3><p>åœ¨ä¸€ä¸ªwebåº”ç”¨ä¸­ï¼Œå¯ä»¥å¼€å‘ç¼–å†™å¤šä¸ªFilterï¼Œè¿™äº›Filterç»„åˆèµ·æ¥ç§°ä¹‹ä¸ºä¸€ä¸ªFilteré“¾ã€‚</p>
<p><strong>webæœåŠ¡å™¨æ ¹æ®Filteråœ¨web.xmlæ–‡ä»¶ä¸­çš„æ³¨å†Œé¡ºåºï¼Œå†³å®šå…ˆè°ƒç”¨å“ªä¸ªFilter</strong>ï¼Œå½“ç¬¬ä¸€ä¸ªFilterçš„doFilteræ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒwebæœåŠ¡å™¨ä¼šåˆ›å»ºä¸€ä¸ªä»£è¡¨Filteré“¾çš„FilterChainå¯¹è±¡ä¼ é€’ç»™è¯¥æ–¹æ³•ã€‚åœ¨doFilteræ–¹æ³•ä¸­ï¼Œå¼€å‘äººå‘˜å¦‚æœè°ƒç”¨äº†FilterChainå¯¹è±¡çš„doFilteræ–¹æ³•ï¼Œåˆ™webæœåŠ¡å™¨ä¼šæ£€æŸ¥FilterChainå¯¹è±¡ä¸­æ˜¯å¦è¿˜æœ‰filterï¼Œå¦‚æœæœ‰ï¼Œåˆ™è°ƒç”¨ç¬¬2ä¸ªfilterï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è°ƒç”¨ç›®æ ‡èµ„æºã€‚</p>
<h3 id="5-Filterçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#5-Filterçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="5. Filterçš„ç”Ÿå‘½å‘¨æœŸ"></a>5. <strong>Filterçš„ç”Ÿå‘½å‘¨æœŸ</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException</span>;<span class="comment">//åˆå§‹åŒ–</span></div></pre></td></tr></table></figure>
<p>å’Œç¼–å†™çš„Servletç¨‹åºä¸€æ ·ï¼ŒFilterçš„åˆ›å»ºå’Œé”€æ¯ç”±WEBæœåŠ¡å™¨è´Ÿè´£ã€‚ web åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œweb æœåŠ¡å™¨å°†åˆ›å»ºFilter çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶initæ–¹æ³•ï¼Œè¯»å–web.xmlé…ç½®ï¼Œå®Œæˆå¯¹è±¡çš„åˆå§‹åŒ–åŠŸèƒ½ï¼Œä»è€Œä¸ºåç»­çš„ç”¨æˆ·è¯·æ±‚ä½œå¥½æ‹¦æˆªçš„å‡†å¤‡å·¥ä½œ<strong>ï¼ˆfilterå¯¹è±¡åªä¼šåˆ›å»ºä¸€æ¬¡ï¼Œinitæ–¹æ³•ä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡ï¼‰</strong>ã€‚å¼€å‘äººå‘˜é€šè¿‡initæ–¹æ³•çš„å‚æ•°ï¼Œå¯è·å¾—ä»£è¡¨å½“å‰filteré…ç½®ä¿¡æ¯çš„FilterConfigå¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException</span>;<span class="comment">//æ‹¦æˆªè¯·æ±‚</span></div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•å®Œæˆå®é™…çš„è¿‡æ»¤æ“ä½œã€‚å½“å®¢æˆ·è¯·æ±‚è®¿é—®ä¸è¿‡æ»¤å™¨å…³è”çš„URLçš„æ—¶å€™ï¼ŒServletè¿‡æ»¤å™¨å°†å…ˆæ‰§è¡ŒdoFilteræ–¹æ³•ã€‚FilterChainå‚æ•°ç”¨äºè®¿é—®åç»­è¿‡æ»¤å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;<span class="comment">//é”€æ¯</span></div></pre></td></tr></table></figure>
<p>Filterå¯¹è±¡åˆ›å»ºåä¼šé©»ç•™åœ¨å†…å­˜ï¼Œå½“webåº”ç”¨ç§»é™¤æˆ–æœåŠ¡å™¨åœæ­¢æ—¶æ‰é”€æ¯ã€‚åœ¨Webå®¹å™¨å¸è½½ Filter å¯¹è±¡ä¹‹å‰è¯¥æ–¹æ³•è¢«è°ƒç”¨ã€‚è¯¥æ–¹æ³•åœ¨Filterçš„ç”Ÿå‘½å‘¨æœŸä¸­ä»…æ‰§è¡Œä¸€æ¬¡ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå¯ä»¥é‡Šæ”¾è¿‡æ»¤å™¨ä½¿ç”¨çš„èµ„æºã€‚</p>
<h3 id="6-FilterConfigæ¥å£"><a href="#6-FilterConfigæ¥å£" class="headerlink" title="6. FilterConfigæ¥å£"></a>6. <strong>FilterConfigæ¥å£</strong></h3><p>ç”¨æˆ·åœ¨é…ç½®filteræ—¶ï¼Œå¯ä»¥ä½¿ç”¨<init-param>ä¸ºfilteré…ç½®ä¸€äº›åˆå§‹åŒ–å‚æ•°ï¼Œå½“webå®¹å™¨å®ä¾‹åŒ–Filterå¯¹è±¡ï¼Œè°ƒç”¨å…¶initæ–¹æ³•æ—¶ï¼Œä¼šæŠŠå°è£…äº†filteråˆå§‹åŒ–å‚æ•°çš„filterConfigå¯¹è±¡ä¼ é€’è¿›æ¥ã€‚å› æ­¤å¼€å‘äººå‘˜åœ¨ç¼–å†™filteræ—¶ï¼Œé€šè¿‡filterConfigå¯¹è±¡çš„æ–¹æ³•ï¼Œå°±å¯è·å¾—ä»¥ä¸‹å†…å®¹ï¼š</init-param></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function">String <span class="title">getFilterName</span><span class="params">()</span></span>;<span class="comment">//å¾—åˆ°filterçš„åç§°ã€‚ </span></div><div class="line"><span class="function">String <span class="title">getInitParameter</span><span class="params">(String name)</span></span>;<span class="comment">//è¿”å›åœ¨éƒ¨ç½²æè¿°ä¸­æŒ‡å®šåç§°çš„åˆå§‹åŒ–å‚æ•°çš„å€¼ã€‚å¦‚æœä¸å­˜åœ¨è¿”å›null. </span></div><div class="line"><span class="function">Enumeration <span class="title">getInitParameterNames</span><span class="params">()</span></span>;<span class="comment">//è¿”å›è¿‡æ»¤å™¨çš„æ‰€æœ‰åˆå§‹åŒ–å‚æ•°çš„åå­—çš„æšä¸¾é›†åˆã€‚ </span></div><div class="line"><span class="function"><span class="keyword">public</span> ServletContext <span class="title">getServletContext</span><span class="params">()</span></span>;<span class="comment">//è¿”å›Servletä¸Šä¸‹æ–‡å¯¹è±¡çš„å¼•ç”¨ã€‚</span></div></pre></td></tr></table></figure>
<h3 id="7-Filterä½¿ç”¨æ¡ˆä¾‹"><a href="#7-Filterä½¿ç”¨æ¡ˆä¾‹" class="headerlink" title="7. Filterä½¿ç”¨æ¡ˆä¾‹"></a>7. <strong>Filterä½¿ç”¨æ¡ˆä¾‹</strong></h3><h4 id="1ã€ä½¿ç”¨FilteréªŒè¯ç”¨æˆ·ç™»å½•å®‰å…¨æ§åˆ¶"><a href="#1ã€ä½¿ç”¨FilteréªŒè¯ç”¨æˆ·ç™»å½•å®‰å…¨æ§åˆ¶" class="headerlink" title="1ã€ä½¿ç”¨FilteréªŒè¯ç”¨æˆ·ç™»å½•å®‰å…¨æ§åˆ¶"></a><strong>1ã€ä½¿ç”¨FilteréªŒè¯ç”¨æˆ·ç™»å½•å®‰å…¨æ§åˆ¶</strong></h4><p>å…ˆåœ¨web.xmlé…ç½®</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&lt;filter&gt;</div><div class="line">    &lt;filter-name&gt;SessionFilter&lt;/filter-name&gt;</div><div class="line">    &lt;filter-class&gt;com.action.login.SessionFilter&lt;/filter-class&gt;</div><div class="line">    &lt;init-param&gt;</div><div class="line">        &lt;param-name&gt;logonStrings&lt;/param-name&gt;&lt;!-- å¯¹ç™»å½•é¡µé¢ä¸è¿›è¡Œè¿‡æ»¤ --&gt;</div><div class="line">        &lt;param-value&gt;/project/index.jsp;login.do&lt;/param-value&gt;</div><div class="line">    &lt;/init-param&gt;</div><div class="line">    &lt;init-param&gt;</div><div class="line">        &lt;param-name&gt;includeStrings&lt;/param-name&gt;&lt;!-- åªå¯¹æŒ‡å®šè¿‡æ»¤å‚æ•°åç¼€è¿›è¡Œè¿‡æ»¤ --&gt;</div><div class="line">        &lt;param-value&gt;.do;.jsp&lt;/param-value&gt;</div><div class="line">    &lt;/init-param&gt;</div><div class="line">    &lt;init-param&gt;</div><div class="line">        &lt;param-name&gt;redirectPath&lt;/param-name&gt;&lt;!-- æœªé€šè¿‡è·³è½¬åˆ°ç™»å½•ç•Œé¢ --&gt;</div><div class="line">        &lt;param-value&gt;/index.jsp&lt;/param-value&gt;</div><div class="line">    &lt;/init-param&gt;</div><div class="line">    &lt;init-param&gt;</div><div class="line">        &lt;param-name&gt;disabletestfilter&lt;/param-name&gt;&lt;!-- Y:è¿‡æ»¤æ— æ•ˆ --&gt;</div><div class="line">        &lt;param-value&gt;N&lt;/param-value&gt;</div><div class="line">    &lt;/init-param&gt;</div><div class="line">&lt;/filter&gt;</div><div class="line">&lt;filter-mapping&gt;</div><div class="line">    &lt;filter-name&gt;SessionFilter&lt;/filter-name&gt;</div><div class="line">    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;</div><div class="line">&lt;/filter-mapping&gt;</div></pre></td></tr></table></figure>
<p>æ¥ç€ç¼–å†™FilterServletï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.Filter;</div><div class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</div><div class="line"><span class="keyword">import</span> javax.servlet.FilterConfig;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponseWrapper;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *    åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•,æœªç™»å½•åˆ™é€€å‡ºç³»ç»Ÿ</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> FilterConfig config;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.config = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isContains</span><span class="params">(String container, String[] regx)</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; regx.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (container.indexOf(regx[i]) != -<span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">        HttpServletRequest hrequest = (HttpServletRequest)request;</div><div class="line">        HttpServletResponseWrapper wrapper = <span class="keyword">new</span> HttpServletResponseWrapper((HttpServletResponse) response);</div><div class="line">        </div><div class="line">        String logonStrings = config.getInitParameter(<span class="string">"logonStrings"</span>);        <span class="comment">// ç™»å½•ç™»é™†é¡µé¢</span></div><div class="line">        String includeStrings = config.getInitParameter(<span class="string">"includeStrings"</span>);    <span class="comment">// è¿‡æ»¤èµ„æºåç¼€å‚æ•°</span></div><div class="line">        String redirectPath = hrequest.getContextPath() + config.getInitParameter(<span class="string">"redirectPath"</span>);<span class="comment">// æ²¡æœ‰ç™»é™†è½¬å‘é¡µé¢</span></div><div class="line">        String disabletestfilter = config.getInitParameter(<span class="string">"disabletestfilter"</span>);<span class="comment">// è¿‡æ»¤å™¨æ˜¯å¦æœ‰æ•ˆ</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (disabletestfilter.toUpperCase().equals(<span class="string">"Y"</span>)) &#123;    <span class="comment">// è¿‡æ»¤æ— æ•ˆ</span></div><div class="line">            chain.doFilter(request, response);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        String[] logonList = logonStrings.split(<span class="string">";"</span>);</div><div class="line">        String[] includeList = includeStrings.split(<span class="string">";"</span>);</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.isContains(hrequest.getRequestURI(), includeList)) &#123;<span class="comment">// åªå¯¹æŒ‡å®šè¿‡æ»¤å‚æ•°åç¼€è¿›è¡Œè¿‡æ»¤</span></div><div class="line">            chain.doFilter(request, response);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.isContains(hrequest.getRequestURI(), logonList)) &#123;<span class="comment">// å¯¹ç™»å½•é¡µé¢ä¸è¿›è¡Œè¿‡æ»¤</span></div><div class="line">            chain.doFilter(request, response);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        String user = ( String ) hrequest.getSession().getAttribute(<span class="string">"useronly"</span>);<span class="comment">//åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•</span></div><div class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</div><div class="line">            wrapper.sendRedirect(redirectPath);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            chain.doFilter(request, response);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">        config = filterConfig;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·æ—¢å¯å®Œæˆå¯¹ç”¨æˆ·æ‰€æœ‰è¯·æ±‚ï¼Œå‡è¦ç»è¿‡è¿™ä¸ªFilterè¿›è¡ŒéªŒè¯ç”¨æˆ·ç™»å½•ã€‚</p>
<h4 id="2ã€é˜²æ­¢ä¸­æ–‡ä¹±ç è¿‡æ»¤å™¨"><a href="#2ã€é˜²æ­¢ä¸­æ–‡ä¹±ç è¿‡æ»¤å™¨" class="headerlink" title="2ã€é˜²æ­¢ä¸­æ–‡ä¹±ç è¿‡æ»¤å™¨"></a><strong>2ã€é˜²æ­¢ä¸­æ–‡ä¹±ç è¿‡æ»¤å™¨</strong></h4><p>é¡¹ç›®ä½¿ç”¨springæ¡†æ¶æ—¶ã€‚å½“å‰å°JSPé¡µé¢å’ŒJAVAä»£ç ä¸­ä½¿ç”¨äº†ä¸åŒçš„å­—ç¬¦é›†è¿›è¡Œç¼–ç çš„æ—¶å€™å°±ä¼šå‡ºç°è¡¨å•æäº¤çš„æ•°æ®æˆ–è€…ä¸Šä¼ /ä¸‹è½½ä¸­æ–‡åç§°æ–‡ä»¶å‡ºç°ä¹±ç çš„é—®é¢˜ï¼Œé‚£å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªè¿‡æ»¤å™¨ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;filter&gt;</div><div class="line">    &lt;filter-name&gt;Spring character encoding filter&lt;/filter-name&gt;</div><div class="line">    &lt;filter-class&gt;org.springframework.web.filter.CharacterEncodingFilter&lt;/filter-class&gt;</div><div class="line">    &lt;init-param&gt;</div><div class="line">      &lt;param-name&gt;encoding&lt;/param-name&gt;&lt;!--ç”¨æ¥æŒ‡å®šä¸€ä¸ªå…·ä½“çš„å­—ç¬¦é›†--&gt;</div><div class="line">      &lt;param-value&gt;UTF-8&lt;/param-value&gt;</div><div class="line">    &lt;/init-param&gt;</div><div class="line">    &lt;init-param&gt;</div><div class="line">      &lt;param-name&gt;forceEncoding&lt;/param-name&gt;&lt;!--trueï¼šæ— è®ºrequestæ˜¯å¦æŒ‡å®šäº†å­—ç¬¦é›†ï¼Œéƒ½æ˜¯encodingï¼›   falseï¼šå¦‚æœrequestå·²æŒ‡å®šä¸€ä¸ªå­—ç¬¦é›†ï¼Œåˆ™ä¸ä½¿ç”¨encoding--&gt;</div><div class="line">      &lt;param-value&gt;false&lt;/param-value&gt;</div><div class="line">    &lt;/init-param&gt;</div><div class="line">  &lt;/filter&gt;</div><div class="line"></div><div class="line">  &lt;filter-mapping&gt;</div><div class="line">    &lt;filter-name&gt;Spring character encoding filter&lt;/filter-name&gt;</div><div class="line">    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;</div><div class="line">  &lt;/filter-mapping&gt;</div></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Storm]]></title>
      <url>http://zsr.github.io/2016/08/30/Storm/</url>
      <content type="html"><![CDATA[<h2 id="Storm-å…¥é—¨æ•™ç¨‹"><a href="#Storm-å…¥é—¨æ•™ç¨‹" class="headerlink" title="Storm å…¥é—¨æ•™ç¨‹"></a>Storm å…¥é—¨æ•™ç¨‹</h2><p><strong>topologies topology</strong>: ç”±ç”¨æˆ·ç¼–å†™çš„Stormé›†ç¾¤ä¸­çš„ä¸šåŠ¡å¤„ç†é€»è¾‘<br><strong>deamon</strong>: å®ˆæŠ¤è¿›ç¨‹<br><strong>worker process</strong>: å·¥ä½œè¿›ç¨‹<br><strong>stream</strong>: æŒ‡Stormä¸­çš„æ•°æ®æµ<br><strong>tuple</strong>: æŒ‡streamä¸­çš„æœ€å°å•å…ƒæ•°æ®<br><strong>primitive</strong>: åŸºä»¶ æŒ‡storm topology çš„ç»„æˆéƒ¨åˆ†ï¼Œæ¯”å¦‚ bolt(èºæ “) å’Œ spout(å–·å˜´)</p>
<h3 id="Storm-é›†ç¾¤é‡Œçš„å„ç§ç»„ä»¶"><a href="#Storm-é›†ç¾¤é‡Œçš„å„ç§ç»„ä»¶" class="headerlink" title="Storm é›†ç¾¤é‡Œçš„å„ç§ç»„ä»¶"></a>Storm é›†ç¾¤é‡Œçš„å„ç§ç»„ä»¶</h3><p>ä»è¡¨é¢ä¸Šçœ‹ä¸€ä¸ª Storm é›†ç¾¤ ä¸ ä¸€ä¸ª Hadoop é›†ç¾¤ç›¸ä¼¼ï¼Œç„¶è€Œåœ¨ Hadoop ä¸Šè¿è¡Œ â€œMapReduce jobsâ€, åœ¨ Storm ä¸Šè¿è¡Œ â€œtopologiesâ€, ä½†æ˜¯ â€œjobsâ€ å’Œ â€œtopologiesâ€ æ˜¯éå¸¸ä¸åŒçš„â€“ <strong>ä¸€ä¸ªå…³é”®çš„ä¸åŒæ˜¯ MapReduce job æœ€ç»ˆä¼šç»“æŸï¼Œè€Œä¸€ä¸ª topology æ˜¯æ°¸è¿œåœ¨ç­‰å¾…æ¶ˆæ¯å¹¶å¤„ç†ï¼ˆç›´åˆ°ä½ æ€æ‰å®ƒï¼‰</strong>ã€‚</p>
<p>ä¸€ä¸ª Storm é›†ç¾¤ä¸­æœ‰ä¸¤ç§èŠ‚ç‚¹(node)ï¼šä¸»èŠ‚ç‚¹å’Œå·¥ä½œèŠ‚ç‚¹(æŒ‡Stormé›†ç¾¤ä¸­ä¸åŒè§’è‰²çš„æœåŠ¡å™¨èŠ‚ç‚¹)ï¼Œä¸»èŠ‚ç‚¹è¿è¡Œä¸€ä¸ªå« â€œNimbusâ€ çš„å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰è·Ÿ Hadoop çš„ â€œä»»åŠ¡è·Ÿè¸ªå™¨â€ï¼ˆJobtrackerï¼‰ç±»ä¼¼ã€‚Nimbus è´Ÿè´£å‘é›†ç¾¤ä¸­åˆ†å‘ä»£ç ï¼Œ å‘å„æœºå™¨åˆ†é…ä»»åŠ¡ï¼Œä»¥åŠç›‘æµ‹æ•…éšœã€‚</p>
<p>æ¯ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹è¿è¡Œä¸€ä¸ªåå« â€œSupervisorâ€ çš„å®ˆæŠ¤è¿›ç¨‹ã€‚Supervisor ç›‘å¬ Nimbus æŒ‡æ´¾åˆ°è¿™ä¸ªè¿™å°æœºå™¨çš„ä»»åŠ¡ï¼Œæ ¹æ® Numbus çš„æŒ‡æ´¾ä¿¡æ¯æ¥åœæ­¢æˆ–å¯åŠ¨å·¥ä½œè¿›ç¨‹(worker process) ï¼Œæ¯ä¸€ä¸ª worker process æ‰§è¡Œä¸€ä¸ªtopologyçš„å­é›†ï¼Œä¸€ä¸ªè¿è¡Œä¸­çš„topologyç”±è·¨è¶Šå¤šä¸ªä¸»æœºçš„å¤šä¸ª worker process ç»„æˆã€‚</p>
<p><img src="http://storm.apache.org/releases/current/images/storm-cluster.png" alt="Storm cluster"></p>
<p>åœ¨ Nimbus å’Œ Supervisors ä¹‹é—´çš„æ‰€æœ‰åè°ƒè°ƒåº¦é€šè¿‡ä¸€ä¸ª <a href="http://zookeeper.apache.org/" target="_blank" rel="external">Zookeeper</a> é›†ç¾¤æ¥å®Œæˆã€‚å¦å¤–ï¼ŒNimbus å®ˆæŠ¤è¿›ç¨‹å’Œ Supervisor å®ˆæŠ¤è¿›ç¨‹éƒ½æ˜¯å¿«é€Ÿå¤±è´¥ ï¼ˆfail-fastï¼‰å’Œæ— çŠ¶æ€çš„ï¼›æ‰€æœ‰çš„çŠ¶æ€ä¿å­˜åœ¨ Zookeeper æˆ–è€…æœ¬åœ°ç£ç›˜ä¸­ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ <code>kill -9</code> Nimbus æˆ–è€… Supervisors ä»–ä»¬ä¼šè‡ªåŠ¨æ¢å¤ï¼Œå°±åƒä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿè¿‡ä¸€æ ·ã€‚è¿™ç§è®¾è®¡è®© Storm é›†ç¾¤å˜çš„ä¸å¯æ€è®®çš„ç¨³å®šã€‚</p>
<h3 id="Topologies"><a href="#Topologies" class="headerlink" title="Topologies"></a>Topologies</h3><p>åœ¨Stromä¸Šåšå®æ—¶è®¡ç®—ï¼Œ éœ€è¦åˆ›å»º â€œTopologyâ€ï¼Œä¸€ä¸ª topology æ˜¯ä¸€ä¸ªè®¡ç®—è¿‡ç¨‹çš„æè¿°ï¼Œä¸€ä¸ª topology ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹åŒ…å«å¤„ç†é€»è¾‘ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥è¡¨æ˜äº†æ•°æ®åœ¨èŠ‚ç‚¹ä¹‹é—´æ˜¯å¦‚ä½•ä¼ é€’çš„ã€‚</p>
<p>è¿è¡Œä¸€ä¸ªtopologyæ˜¯å¾ˆç®€å•çš„ã€‚é¦–å…ˆï¼Œå°†ä½ æ‰€æœ‰çš„ä»£ç å’Œä¾èµ–éƒ½æ‰“åŒ…åˆ°ä¸€ä¸ªå•ç‹¬çš„jaråŒ…ä¸­ï¼Œç„¶åè¿è¡Œåƒä¸‹é¢è¿™æ ·çš„å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">storm jar all-my-code.jar backtype.storm.MyTopology arg1 arg2</div></pre></td></tr></table></figure>
<p>è¿™æ ·ä¼šä¼ é€’<code>arg1</code>å’Œ <code>arg2</code>å‚æ•°ç»™<code>backtype.storm.MyTopology</code>ç±»ï¼Œè¿™ä¸ªç±»çš„ <code>main</code> æ–¹æ³•å®šä¹‰topology å¹¶å°†å®ƒæäº¤åˆ° Nimbusã€‚<code>Strom jar</code> è´Ÿè´£è¿æ¥ Nimbus å¹¶ä¸Šä¼ jaråŒ….</p>
<p>ç”±äº topology çš„å®šä¹‰æœ¬æ¥å°±æ˜¯ Thrift ç»“æ„ï¼Œå¹¶ä¸” Nimbus æ˜¯ä¸€ä¸ª Thrift æœåŠ¡ï¼Œ æ‰€ä»¥å¯ä»¥ä½¿ç”¨ä»»ä½•ç¼–ç¨‹è¯­è¨€æ¥åˆ›å»ºå’Œæäº¤ topologyã€‚ä¸Šé¢çš„æ–¹æ³•æ˜¯ä½¿ç”¨åŸºäº JVM çš„ç¼–ç¨‹è¯­è¨€æ¥å®Œæˆçš„æœ€ç®€å•çš„æ–¹æ³•ï¼Œå‚è€ƒ<a href="http://storm.apache.org/documentation/Running-topologies-on-a-production-cluster.html" target="_blank" rel="external">Running topologies on a production cluster</a> æ¥è·å–æ›´å¤šçš„å…³äºå¼€å¯å’Œåœæ­¢ topology çš„æ–¹æ³•ã€‚</p>
<a id="more"></a>
<h3 id="Streams"><a href="#Streams" class="headerlink" title="Streams"></a>Streams</h3><p>Strom çš„æ ¸å¿ƒæŠ½è±¡æ¦‚å¿µæ˜¯ â€œæµâ€ ï¼ˆstreamï¼‰ï¼Œä¸€ä¸ª stream ç›¸å½“äºä¸€ä¸ªæ— é™çš„å…ƒç»„(tuple) åºåˆ—ï¼ŒStorm æä¾›äº†ä»¥å¯é ä¸”åˆ†å¸ƒå¼çš„æ–¹æ³•æ¥å°†ä¸€ä¸ª stream è½¬æ¢æˆä¸€ä¸ªæ–° stream çš„åŸºä»¶ (primitive) ï¼Œä¾‹å¦‚ï¼šä½ å¯ä»¥å°†twitteræµè½¬æ¢ä¸ºçƒ­é—¨è¯é¢˜æµã€‚</p>
<p>Stormæä¾›åŸºæœ¬çš„ç”¨æ¥åšæµè½¬æ¢çš„çš„åŸºä»¶æ˜¯ â€œspoutâ€ å’Œ â€œboltsâ€ ï¼Œspout å’Œ bolt æä¾›äº†æ¥å£ï¼Œä½ å¯ä»¥å®ç°è¿™äº›æ¥å£æ¥å¤„ç†çš„ä½ è‡ªå·±çš„åº”ç”¨ç¨‹åºç›¸å…³çš„é€»è¾‘ã€‚</p>
<p>spout æ˜¯æµçš„æ¥æºï¼Œ ä¾‹å¦‚ spout å¯ä»¥ä»ä¸€ä¸ª <a href="http://github.com/nathanmarz/storm-kestrel" target="_blank" rel="external">Kestrel</a> é˜Ÿåˆ—æ¥è¯» tuple å¹¶ä¸”å‘å°„(emit)ä»–ä»¬å½¢æˆä¸€ä¸ªæµï¼Œæˆ–è€… spout å¯ä»¥è¿æ¥åˆ° Twitter apiï¼Œæ¥å‘å°„ä¸€ä¸ªæ¨æ–‡çš„æµã€‚</p>
<p>ä¸€ä¸ª bolt æ¶ˆè´¹ä»»æ„æ•°é‡çš„æµï¼Œ åšä¸€äº›å¤„ç†ï¼Œç„¶åå¯èƒ½ä¼šå‘å°„å‡ºæ–°çš„æµï¼Œå¤æ‚çš„æµè½¬æ¢ï¼Œä¾‹å¦‚ä»ä¸€ä¸ªæ¨æ–‡çš„æµè®¡ç®—å‡ºä¸€ä¸ªçƒ­é—¨è¯é¢˜çš„æµï¼Œéœ€è¦å¤šä¸ªæ­¥éª¤ï¼Œå¤šä¸ª bolt ã€‚boltå¯ä»¥é€šè¿‡è¿è¡Œå‡½æ•°ï¼ˆfunctionsï¼‰æ¥åšä»»ä½•äº‹ï¼Œä¾‹å¦‚è¿‡æ»¤å…ƒç»„ï¼Œåšæµèšåˆï¼Œåšæµè¿æ¥ï¼Œè·Ÿæ•°æ®åº“äº¤äº’ç­‰ç­‰ã€‚</p>
<p>æ‰€æœ‰çš„ spout å’Œ bolt è¢«æ‰“åŒ…åˆ°äº†ä¸€ä¸ª â€œtopologyâ€ ä¸­ ï¼Œtopology æ˜¯ä½ æäº¤ç»™ Storm é›†ç¾¤æ¥æ‰§è¡Œçš„è®¡ç®—è¿‡ç¨‹çš„æœ€é«˜æŠ½è±¡ï¼Œä¸€ä¸ª topology ç±»ä¼¼ä¸€ä¸ªæµè½¬æ¢çš„å›¾è¡¨ï¼Œå®ƒç°æ˜¾ç¤ºäº†å“ªäº› bolt æ˜¯ç»‘å®š(subscribe)å“ªäº› stream ä¸Šçš„ ã€‚å½“ä¸€ä¸ª spout æˆ–è€… bolt å‘å°„å‡ºä¸€ä¸ª tuple åˆ° stream ä¸­ï¼Œå®ƒä¼šå‘é€ tuple åˆ°æ‰€æœ‰ç»‘å®šäº†è¿™ä¸ª stream çš„ bolt ä¸­ã€‚</p>
<p><img src="http://www.dahouduan.com/2015/11/10/storm-tutorial/topology.png" alt="[spoutå’Œboltçš„å…³ç³»å›¾]"></p>
<p>topology ä¸­èŠ‚ç‚¹(<strong>æŒ‡ topology ä¸­çš„ spout æˆ–è€… bolt </strong>)ä¹‹é—´çš„è¿æ¥è¡¨æ˜äº† tuple æ˜¯å¦‚ä½•åœ¨ä»–ä»¬ä¹‹é—´ä¼ é€’çš„ã€‚ä¾‹å¦‚å¦‚æœåœ¨ spout A å’Œ bolt B ä¹‹é—´æœ‰ä¸€ä¸ªè¿æ¥ï¼Œä» spout A åˆ° bolt C ä¹‹é—´æœ‰ä¸€ä¸ªè¿æ¥ï¼Œä» boltB åˆ° boltC æœ‰ä¸€ä¸ªè¿æ¥ï¼Œtuple ä¼šå‘åˆ° bolt B å’Œ bolt C ä¸­ï¼Œ æ‰€æœ‰ bolt B çš„è¾“å‡º tuple ä¹Ÿä¼šæµåˆ° bolt C ä¸­ã€‚</p>
<p>topologyä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ã€‚åœ¨topologyä¸­ï¼Œä½ å¯ä»¥æŒ‡å®šæ¯ä¸ªèŠ‚ç‚¹çš„å¹¶è¡Œæ•°é‡nï¼Œç„¶å Stormä¼šå¯åŠ¨ n ä¸ªçº¿ç¨‹åœ¨é›†ç¾¤ä¸­è¿è¡Œ</p>
<p>ä¸€ä¸ª topology æ˜¯æ°¸è¿œè¿è¡Œçš„ï¼Œç›´åˆ°ä½ æ€æ‰å®ƒï¼ŒStorm ä¼šè‡ªåŠ¨é‡æ–°åˆ†é…å¤±è´¥çš„ä»»åŠ¡ã€‚å¦å¤–ï¼ŒStorm ä¿è¯æ²¡æœ‰æ•°æ®ä¸¢å¤±ï¼Œ å³ä½¿ä¸»æœºæŒ‚æ‰æ¶ˆæ¯ä¸¢å¤±ã€‚</p>
<h3 id="æ•°æ®æ¨¡å‹"><a href="#æ•°æ®æ¨¡å‹" class="headerlink" title="æ•°æ®æ¨¡å‹"></a>æ•°æ®æ¨¡å‹</h3><p>Storm ä½¿ç”¨ tuple åšæ•°æ®æ¨¡å‹ï¼Œä¸€ä¸ª tuple æ˜¯è¢«å‘½åè¿‡çš„å€¼åˆ—è¡¨(A tuple is a named list of values)ï¼Œä¸€ä¸ª tuple ä¸­çš„å­—æ®µå¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„å¯¹è±¡ã€‚å®ƒæ˜¯å¼€ç®±å³ç”¨çš„ï¼ŒStorm æ”¯æŒæ‰€æœ‰çš„ç®€å•æ•°æ®ç±»å‹ï¼Œå¦‚å­—ç¬¦ä¸²ï¼Œå­—èŠ‚æ•°ç»„ä½œä¸º tuple çš„å­—æ®µå€¼ã€‚å¦‚æœè¦ä½¿ç”¨å¦ä¸€ç§ç±»å‹çš„å¯¹è±¡ï¼Œåªéœ€è¦ä¸ºè¿™ä¸ªç±»å‹å®ç°ä¸€ä¸ª <a href="http://storm.apache.org/documentation/Serialization.html" target="_blank" rel="external">serializer</a>.</p>
<p>topology ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½åº”è¯¥ä¸ºå®ƒè¦å‘å°„çš„å…ƒç»„å£°æ˜è¾“å‡ºå­—æ®µï¼Œ ä¾‹å¦‚ï¼Œ ä¸‹é¢è¿™ä¸ªboltå£°æ˜äº†å®ƒå‘å°„å­—æ®µä¸º â€œdoubleâ€ å’Œ â€œtripleâ€ å­—æ®µçš„å…ƒç»„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DoubleAndTripleBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> OutputCollectorBase _collector;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map conf, TopologyContext context, OutputCollectorBase collector)</span> </span>&#123;</div><div class="line">        _collector = collector;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple input)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> val = input.getInteger(<span class="number">0</span>);        </div><div class="line">        _collector.emit(input, <span class="keyword">new</span> Values(val*<span class="number">2</span>, val*<span class="number">3</span>));</div><div class="line">        _collector.ack(input);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</div><div class="line">        declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"double"</span>, <span class="string">"triple"</span>));</div><div class="line">    &#125;    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>declareOutputFields</code> æ–¹æ³•å£°æ˜äº†è¾“å‡ºå­—æ®µä¸º<code>[&quot;double&quot;, &quot;triple&quot;]</code>.</p>
<h3 id="ç®€å•çš„topologyä¾‹å­"><a href="#ç®€å•çš„topologyä¾‹å­" class="headerlink" title="ç®€å•çš„topologyä¾‹å­"></a>ç®€å•çš„topologyä¾‹å­</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * This is a basic example of a Storm topology.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExclamationTopology</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExclamationBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</div><div class="line">    OutputCollector _collector;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map conf, TopologyContext context, OutputCollector collector)</span> </span>&#123;</div><div class="line">      _collector = collector;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</div><div class="line">      _collector.emit(tuple, <span class="keyword">new</span> Values(tuple.getString(<span class="number">0</span>) + <span class="string">"!!!"</span>));</div><div class="line">      _collector.ack(tuple);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</div><div class="line">      declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"word"</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</div><div class="line"></div><div class="line">    builder.setSpout(<span class="string">"word"</span>, <span class="keyword">new</span> TestWordSpout(), <span class="number">10</span>);</div><div class="line">    builder.setBolt(<span class="string">"exclaim1"</span>, <span class="keyword">new</span> ExclamationBolt(), <span class="number">3</span>).shuffleGrouping(<span class="string">"word"</span>);</div><div class="line">    builder.setBolt(<span class="string">"exclaim2"</span>, <span class="keyword">new</span> ExclamationBolt(), <span class="number">2</span>).shuffleGrouping(<span class="string">"exclaim1"</span>);</div><div class="line"></div><div class="line">    Config conf = <span class="keyword">new</span> Config();</div><div class="line">    conf.setDebug(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (args != <span class="keyword">null</span> &amp;&amp; args.length &gt; <span class="number">0</span>) &#123;</div><div class="line">      conf.setNumWorkers(<span class="number">3</span>);</div><div class="line"></div><div class="line">      StormSubmitter.submitTopologyWithProgressBar(args[<span class="number">0</span>], conf, builder.createTopology());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">      LocalCluster cluster = <span class="keyword">new</span> LocalCluster();</div><div class="line">      cluster.submitTopology(<span class="string">"test"</span>, conf, builder.createTopology());</div><div class="line">      Utils.sleep(<span class="number">10000</span>);</div><div class="line">      cluster.killTopology(<span class="string">"test"</span>);</div><div class="line">      cluster.shutdown();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ª topology åŒ…å«ä¸€ä¸ª spout å’Œä¸¤ä¸ª boltï¼Œspout å‘é€å•è¯ï¼Œæ¯ä¸€ä¸ª bolt é™„åŠ  â€œ!!!â€ åˆ°å®ƒçš„è¾“å…¥æ•°æ®ä¸­ã€‚è¿™äº›èŠ‚ç‚¹æ’ç»ƒæˆä¸€æ¡çº¿ï¼šspout å…ˆå‘å°„ tuple åˆ°ç¬¬ä¸€ä¸ª boltï¼Œç„¶åç¬¬ä¸€ä¸ª bolt å‘é€åˆ°ç¬¬äºŒä¸ª boltã€‚å¦‚æœ spout å‘é€ [â€œbobâ€] å’Œ [â€œjohnâ€] å…ƒç»„ï¼Œç„¶åç¬¬äºŒä¸ªboltä¼šå‘é€ [â€œbob!!!!!!â€] å’Œ [â€œjohn!!!!!!â€] å…ƒç»„.</p>
<p>ä»£ç ä¸­ä½¿ç”¨ <code>setSpout</code> å’Œ <code>setBolt</code> æ–¹æ³•æ¥å®šä¹‰èŠ‚ç‚¹.è¿™äº›æ–¹æ³•éœ€è¦ä¼ å…¥: ä¸€ä¸ªç”¨æˆ·æŒ‡å®šçš„idï¼Œä¸€ä¸ªåŒ…å«å¤„ç†é€»è¾‘çš„å¯¹è±¡ï¼Œä»¥åŠä½ å¸Œæœ›è¿™ä¸ªèŠ‚ç‚¹è¿è¡Œçš„å¹¶è¡Œæ•°é‡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œspout è¢«æŒ‡å®šäº†id â€œwordsâ€, bolt è¢«æŒ‡å®šäº†id â€œexclaim1â€ å’Œ â€œexclaim2â€.</p>
<p><strong>ä¼ å…¥çš„ Spout å¯¹è±¡å®ç°äº† <a href="http://storm.apache.org/javadoc/apidocs/backtype/storm/topology/IRichSpout.html" target="_blank" rel="external">IRichSpout</a> æ¥å£å¹¶åŒ…å«ä¸šåŠ¡é€»è¾‘, Bolt å¯¹è±¡å®ç°äº† <a href="http://storm.apache.org/javadoc/apidocs/backtype/storm/topology/IRichBolt.html" target="_blank" rel="external">IRichBolt</a> æ¥å£å¹¶åŒ…å«ä¸šåŠ¡é€»è¾‘</strong>.</p>
<p>æœ€åä¸€ä¸ªå‚æ•°ï¼Œè®¾ç½®è¿™ä¸ªèŠ‚ç‚¹çš„å¹¶è¡Œæ•°é‡æ˜¯å‡ ï¼Œè¿™ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ï¼Œå®ƒè¡¨æ˜æœ‰å¤šå°‘çº¿ç¨‹åº”è¯¥åœ¨é›†ç¾¤ä¸­è¿è¡Œè¯¥ç»„ä»¶ ï¼Œå¦‚æœä½ å¿½ç•¥äº†å®ƒï¼ŒStorm ä¼šç»™è¿™ä¸ªèŠ‚ç‚¹ï¼ˆ<strong>å³ spout æˆ–è€… bolt</strong>ï¼‰åªåˆ†é…ä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<p><code>setBolt</code> è¿”å›ä¸€ä¸ª <a href="http://storm.apache.org/javadoc/apidocs/backtype/storm/topology/InputDeclarer.html" target="_blank" rel="external">InputDeclarer</a> å¯¹è±¡ç”¨æ¥ç»™ bolt å®šä¹‰è¾“å…¥ã€‚è¿™ â€œexclaim1â€ç»„ä»¶ å£°æ˜äº†å®ƒè¦æƒ³è¯»å…¥æ‰€æœ‰ â€œwordsâ€ ç»„ä»¶çš„å‘å°„çš„æ‰“ä¹±åˆ†ç»„è¿‡çš„æ‰€æœ‰ tuple. â€œexclaim2â€ ç»„ä»¶å£°æ˜äº†å®ƒè¦è¯»å…¥æ‰€æœ‰ â€œexclaim1â€ å‘å°„çš„æ‰“ä¹±åˆ†ç»„è¿‡çš„ tupleï¼Œâ€æ‰“ä¹±åˆ†ç»„â€ï¼ˆshuffile groupï¼‰æ„å‘³ç€ tuple å¿…é¡»ä»è¾“å…¥ä¸­éšæœºåˆ†å‘åˆ° bolt çš„ä»»åŠ¡ä¸­ã€‚æœ‰è®¸å¤šåœ¨ç»„ä»¶ä¹‹é—´å°†æ•°æ®åˆ†ç»„çš„æ–¹æ³•ï¼Œæ‰“ä¹±åªæ˜¯å…¶ä¸­ä¸€ç§ã€‚</p>
<p>å¦‚æœä½ å¸Œæœ› â€œexclaim2â€ ç»„ä»¶ï¼Œæ—¢è¯»å– â€œwordsâ€ åˆè¯»å– â€œexclaim1â€ å‘å°„çš„ tuple ï¼Œ ä½ å¯ä»¥åƒå¦‚ä¸‹è¿™æ ·å®ç° â€œexcliam2â€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">builder.setBolt(<span class="string">"exclaim2"</span>, <span class="keyword">new</span> ExclamationBolt(), <span class="number">5</span>)</div><div class="line">            .shuffleGrouping(<span class="string">"words"</span>)</div><div class="line">            .shuffleGrouping(<span class="string">"exclaim1"</span>);</div></pre></td></tr></table></figure>
<p><strong>å¯ä»¥ç»™ bolt é“¾å¼çš„æŒ‡å®šå¤šä¸ªæ•°æ®æºã€‚</strong></p>
<p>Spouts è´Ÿè´£å‘å°„æ–°çš„æ¶ˆæ¯åˆ° topologyä¸­ã€‚ åœ¨è¿™ä¸ª topology ä¸­ <code>TestWordSpouts</code>æ–¹æ³• ä» [â€œnathanâ€, â€œmikeâ€, â€œjacksonâ€, â€œgoldaâ€, â€œbertelsâ€] ä¸­æ¯ 100æ¯«ç§’ å‘å°„ä¸€ä¸ªéšæœºçš„å­—ç¬¦ï¼Œ TestWordSpout ä¸­ <code>nextTuple()</code>æ–¹æ³• çš„å®ç°æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nextTuple</span><span class="params">()</span> </span>&#123;</div><div class="line">    Utils.sleep(<span class="number">100</span>);</div><div class="line">    <span class="keyword">final</span> String[] words = <span class="keyword">new</span> String[] &#123;<span class="string">"nathan"</span>, <span class="string">"mike"</span>, <span class="string">"jackson"</span>, <span class="string">"golda"</span>, <span class="string">"bertels"</span>&#125;;</div><div class="line">    <span class="keyword">final</span> Random rand = <span class="keyword">new</span> Random();</div><div class="line">    <span class="keyword">final</span> String word = words[rand.nextInt(words.length)];</div><div class="line">    _collector.emit(<span class="keyword">new</span> Values(word));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ExclamationBoltç±»çš„ <code>prepare</code> æ–¹æ³•ç»™ bolt æä¾›äº†ä¸€ä¸ª <code>OutputCollector</code> å¯¹è±¡ç”¨æ¥ä»è¿™ä¸ª bolt ä¸­å‘å°„ tuple ã€‚ åœ¨è¿™ä¸ª bolt ä¸­çš„ä»»ä½•ä½ç½®éƒ½å¯ä»¥å‘å°„ tuples â€”åœ¨ <code>prepare</code>, <code>execute</code>, <code>cleanup</code> æ–¹æ³•ä¸­ï¼Œ ç”šè‡³åœ¨å¼‚æ­¥çš„å…¶ä»–çº¿ç¨‹ä¸­ã€‚</p>
<ul>
<li><p><code>prepare</code> æ–¹æ³•ä»…ä»…ä¿æŒä¸€ä¸ª <code>OutputCollector</code> å¯¹è±¡å®ä¾‹ä»¥ä¾¿åœ¨åé¢<code>execute</code> æ–¹æ³•ä¸­è°ƒç”¨ã€‚</p>
</li>
<li><p><code>execute</code> æ–¹æ³•ä»è¾“å…¥ä¸­æ¥æ”¶ä¸€ä¸ª tupleã€‚<code>ExclamationBolt</code> ä»å…ƒç»„ä¸­å–åˆ°ç¬¬ä¸€ä¸ªå­—æ®µï¼Œç„¶ååœ¨åé¢é™„åŠ  â€œ!!!â€ ã€‚ å¦‚æœä½ å®ç°çš„ bolt è®¢é˜…äº†å¤šä¸ªè¾“å…¥æºï¼Œ ä½ å¯ä»¥ä½¿ç”¨<code>Tuple#getSourceComponent</code> æ–¹æ³•æŸ¥åˆ°å½“å‰çš„ tuple æ˜¯æ¥è‡ªå“ªä¸ªç»„ä»¶.</p>
<p><code>execute</code> æ–¹æ³•é‡Œè¿˜å¯ä»¥åšä¸€äº›å…¶ä»–æ“ä½œï¼Œå³å°†è¾“å…¥çš„ tuple ä½œä¸º emit çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ï¼Œè¿™æ ·è¿™ä¸ª tuple ä¼šè¢«ç¡®è®¤ã€‚è¿™æ˜¯ Storm å¯é apiä¸€éƒ¨åˆ†å®ƒèƒ½ä¿è¯ï¼Œä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œè¿™äº›åœ¨æœ¬æ•™ç¨‹åé¢çš„ç« èŠ‚ä¸­è¿˜ä¼šé˜è¿°ã€‚</p>
</li>
<li><p><code>cleanup</code> æ–¹æ³•ä¼šåœ¨ Bolt åœæ­¢æ—¶è¢«è°ƒç”¨ï¼Œç”¨æ¥å…³é—­æ¸…ç†æ‰€æœ‰æ‰“å¼€çš„èµ„æºã€‚ä¸èƒ½ä¿è¯è¿™ä¸ªæ–¹æ³•ä¸€å®šä¼šåœ¨é›†ç¾¤ä¸­è¢«è°ƒç”¨ï¼Œå¦‚æœæ­£åœ¨è¿è¡Œçš„æœºå™¨å‘ç”Ÿäº†çˆ†ç‚¸ï¼ˆä½œè€…åœ¨æç¬‘ï¼‰ï¼Œè¿™æ ·å°±æ²¡åŠæ³•è°ƒç”¨è¿™ä¸ªæ–¹æ³•äº†ã€‚<code>cleanup</code>æ–¹æ³•å…¶å®æ˜¯ä¸“é—¨ä¸ºä½ åœ¨<a href="http://storm.apache.org/documentation/Local-mode.html" target="_blank" rel="external">æœ¬åœ°æ¨¡å¼</a>(å°†Stormé›†ç¾¤åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­æ¨¡æ‹Ÿå‡ºæ¥)ä¸‹è¿è¡Œ topology ï¼Œä½ å¸Œæœ›è¿è¡Œå’Œæ€æ‰ topology è€Œä¸å¿…æ‹…å¿ƒèµ„æºæ³„éœ²ã€‚</p>
</li>
</ul>
<p><code>declareOutputFields</code> æ–¹æ³•å£°æ˜ <code>ExclamationBolt</code> å‘å°„åŒ…å«ä¸€ä¸ª word å­—æ®µçš„ tuple</p>
<p><code>getComponentConfiguration</code> æ–¹æ³•å…è®¸ä½ é…ç½®å½±å“è¿™ä¸ª bolt å¦‚ä½•è¿è¡Œçš„å„ç§å‚æ•°ï¼Œå…³äºé…ç½®çš„æ›´å¤šå†…å®¹ <a href="http://storm.apache.org/documentation/Configuration.html" target="_blank" rel="external">Configuration</a>.</p>
<p>åƒ<code>cleanup</code> å’Œ <code>getComponentConfiguration</code> æ–¹æ³•é€šå¸¸å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œ ä½ å¯ä»¥é€šè¿‡ç»§æ‰¿ä¸€ä¸ªæä¾›äº†é»˜è®¤å®ç°çš„åŸºç±»æ¥æ›´ç®€æ´çš„å®šä¹‰ boltã€‚ é€šè¿‡ç»§æ‰¿ <code>BaseRichBolt</code>ç±» ï¼Œ<code>ExclamationBolt</code>å¯ä»¥è¢«å®ç°çš„æ›´ç®€æ´ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExclamationBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</div><div class="line">    OutputCollector _collector;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map conf, TopologyContext context, OutputCollector collector)</span> </span>&#123;</div><div class="line">        _collector = collector;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</div><div class="line">        _collector.emit(tuple, <span class="keyword">new</span> Values(tuple.getString(<span class="number">0</span>) + <span class="string">"!!!"</span>));</div><div class="line">        _collector.ack(tuple);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</div><div class="line">        declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"word"</span>));</div><div class="line">    &#125;    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="åœ¨æœ¬åœ°æ¨¡å¼ä¸‹è¿è¡Œ-ExclamationTopology"><a href="#åœ¨æœ¬åœ°æ¨¡å¼ä¸‹è¿è¡Œ-ExclamationTopology" class="headerlink" title="åœ¨æœ¬åœ°æ¨¡å¼ä¸‹è¿è¡Œ ExclamationTopology"></a>åœ¨æœ¬åœ°æ¨¡å¼ä¸‹è¿è¡Œ ExclamationTopology</h3><p>Storm æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š<code>æœ¬åœ°æ¨¡å¼</code>å’Œ<code>åˆ†å¸ƒå¼æ¨¡å¼</code>ã€‚</p>
<ul>
<li>åœ¨æœ¬åœ°æ¨¡å¼ä¸­ï¼ŒStorm å®Œå…¨åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­è¿è¡Œï¼Œç”¨çº¿ç¨‹æ¥æ¨¡æ‹Ÿå„ä¸ªå·¥ä½œèŠ‚ç‚¹ã€‚æœ¬åœ°æ¨¡å¼å¯¹ä¸å¼€å‘å’Œæµ‹è¯•topologyæ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå½“ä½ è¿è¡Œ storm-starter ä¸­çš„ topologyæ—¶ï¼Œå®ƒä¼šè¿è¡Œåœ¨æœ¬åœ°æ¨¡å¼ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªç»„ä»¶å‘å°„çš„æ¶ˆæ¯.</li>
<li>åœ¨åˆ†å¸ƒå¼æ¨¡å¼ä¸‹ï¼ŒStorm è¿è¡Œåœ¨ä¸€ç»„æœºå™¨ä¸Šï¼Œå½“ä½ æäº¤ä¸€ä¸ª topology åˆ° masterä¸Šï¼Œå°±ä¼šåŒæ—¶æäº¤æ‰€æœ‰å¿…è¦çš„ä»£ç æ¥è¿è¡Œè¿™ä¸ª topologyï¼Œmasterä¼šè´Ÿè´£åˆ†å‘ä½ çš„ä»£ç ï¼Œå¹¶åˆ†é…å·¥ä½œè¿›ç¨‹æ¥è¿è¡Œä½ çš„ topologyï¼Œå¦‚æœå·¥ä½œè¿›ç¨‹æŒ‚æ‰äº†ï¼Œmasterä¼šåœ¨æŸå¤„é‡æ–°åˆ†é…ä»–ä»¬.</li>
</ul>
<p>ä¸‹é¢æ˜¯åœ¨æœ¬åœ°æ¨¡å¼è¿è¡Œ <code>ExclamationTopology</code> çš„ä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Config conf = <span class="keyword">new</span> Config();</div><div class="line">conf.setDebug(<span class="keyword">true</span>);</div><div class="line">conf.setNumWorkers(<span class="number">2</span>);</div><div class="line"></div><div class="line">LocalCluster cluster = <span class="keyword">new</span> LocalCluster();</div><div class="line">cluster.submitTopology(<span class="string">"test"</span>, conf, builder.createTopology());</div><div class="line">Utils.sleep(<span class="number">10000</span>);</div><div class="line">cluster.killTopology(<span class="string">"test"</span>);</div><div class="line">cluster.shutdown();</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç é€šè¿‡åˆ›å»º <code>LocalCluster</code> å¯¹è±¡å®šä¹‰äº†ä¸€ä¸ªè¿›ç¨‹å†…çš„é›†ç¾¤ã€‚æäº¤ topology åˆ°è™šæ‹Ÿé›†ç¾¤å’Œæäº¤åˆ°åˆ†å¸ƒå¼é›†ç¾¤æ˜¯ä¸€æ ·çš„ï¼Œé€šè¿‡è°ƒç”¨ <code>submitTopology</code> æ¥å‘ <code>LocalCluster</code> ä¸­æäº¤ topologyï¼Œå®ƒæ¥å—ä¸‰ä¸ªå‚æ•°: topologyçš„åå­—ï¼Œtopologyçš„é…ç½®ï¼Œtopologyæœ¬èº«ã€‚</p>
<p>åå­—æ˜¯ç”¨æ¥è¯†åˆ«è¿™ä¸ª topologyï¼Œä»¥ä¾¿æ—¥åæ€æ‰å®ƒã€‚ã€‚topologyä¼šä¸€ç›´è¿è¡Œç›´åˆ°ä½ æ€æ‰å®ƒã€‚</p>
<p>é…ç½®æ˜¯ç”¨æ¥è°ƒä¼˜è¿è¡Œ topology çš„å„ä¸ªæ–¹é¢ï¼Œä¸‹é¢æ˜¯ä¸¤ä¸ªå¸¸è§çš„é…ç½®ï¼š</p>
<ol>
<li>TOPOLOGY_WORKERS (ç”¨ <code>setNumWorkers</code>æ¥è®¾ç½®) æŒ‡å®šä½ å°†åœ¨é›†ç¾¤åˆ†é…å‡ ä¸ªè¿›ç¨‹æ¥è¿è¡Œè¿™ä¸ªè¿™ä¸ªtopologyï¼Œtopologyä¸­çš„æ¯ä¸€ä¸ªç»„ä»¶ä¼šè¢«å½“åšå¤šä¸ªçº¿ç¨‹æ¥è¿è¡Œã€‚ä¸€ä¸ªç»„ä»¶è¢«åˆ†é…çº¿ç¨‹çš„æ•°é‡é€šè¿‡ <code>setBolt</code> å’Œ <code>setSpout</code> æ–¹æ³•æ¥é…ç½®ï¼Œè¿™äº›çº¿ç¨‹å­˜åœ¨äºå·¥ä½œè¿›ç¨‹ä¸­ã€‚æ¯ä¸ªå·¥ä½œè¿›ç¨‹åŒ…å«ä¸€äº›ç»„ä»¶ä¸­çš„ä¸€äº›çº¿ç¨‹ï¼Œä¾‹å¦‚ï¼Œä½ åˆ†é…äº† 300 ä¸ªçº¿ç¨‹ç»™æ‰€æœ‰çš„ç»„ä»¶ï¼Œåœ¨é…ç½®ä¸­è®¾ç½®äº†50ä¸ªå·¥ä½œè¿›ç¨‹ï¼Œé‚£ä¹ˆæ¯ä¸ªå·¥ä½œè¿›ç¨‹ä¼šè¿è¡Œ6ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¯èƒ½å±äºä¸åŒçš„ç»„ä»¶ã€‚é€šè¿‡è°ƒæ•´æ¯ä¸ªå…ƒä»¶çš„å¹¶è¡Œåº¦å’Œè¿è¡Œè¿™äº›çº¿ç¨‹çš„å·¥ä½œè¿›ç¨‹çš„æ•°é‡æ¥å¯¹ storm çš„å¹¶è¡Œæ€§èƒ½è°ƒä¼˜ã€‚</li>
<li>TOPOLOGY_DEBUG ï¼ˆé€šè¿‡ setDebug è®¾ç½®ï¼‰,å½“è¢«è®¾ä¸º true æ—¶ï¼Œstorm å°†è®°å½•å…ƒä»¶å‘å°„çš„æ¯ä¸ªæ¶ˆæ¯ï¼Œåœ¨æœ¬åœ°æ¨¡å¼æµ‹è¯•topologyæ—¶è¿™æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œä½†æ˜¯åœ¨çº¿ä¸Šæ¨¡å¼è¿è¡Œæ—¶ï¼Œä½ æ›´æ„¿æ„å°†å®ƒå…³é—­</li>
</ol>
<h3 id="æµåˆ†ç»„-Stream-groupings"><a href="#æµåˆ†ç»„-Stream-groupings" class="headerlink" title="æµåˆ†ç»„ Stream groupings"></a>æµåˆ†ç»„ Stream groupings</h3><p>æµåˆ†ç»„è®© topology çŸ¥é“åœ¨ç»„ä»¶ä¹‹é—´å¦‚ä½•å‘é€ tupleï¼Œè®°ä½ spouts å’Œ bolts æ˜¯è¢«å½“æˆå¾ˆå¤š tasks ï¼ˆ<strong>è¿™é‡Œçš„task å°±æ˜¯setBoltå’Œ setSpout ä¸­äº§ç”Ÿçš„å·¥ä½œçº¿ç¨‹ï¼Œå¦‚æœè®¾ç½®äº†æ•°é‡ï¼Œå°±æ˜¯çº¿ç¨‹ç»„æˆ–è€…ä»»åŠ¡ç»„å³ set of tasks</strong>ï¼‰å¹¶è¡Œè¿è¡Œåœ¨æ•´ä¸ªé›†ç¾¤ä¸­çš„ï¼Œå¦‚æœæƒ³çœ‹çœ‹ topology æ˜¯å¦‚ä½•åœ¨ task å±‚çº§è¿è¡Œçš„ï¼Œå¦‚ä¸‹å›¾:</p>
<p><img src="http://storm.apache.org/releases/current/images/topology-tasks.png" alt="Tasks in a topology"></p>
<p>å½“ä¸€ä¸ªè¿è¡Œ Bolt A çš„ task å‘å°„äº†ä¸€ä¸ª tuple åˆ° Bolt Bï¼Œé‚£ä¹ˆå®ƒåº”è¯¥å‘å°„åˆ°å“ªä¸ª taskï¼ˆå½“ç„¶æ˜¯è¿è¡ŒBolt B çš„taskï¼‰ å‘¢ï¼Ÿ</p>
<p>æµåˆ†ç»„ ï¼ˆStream groupingï¼‰ç­”äº†è¿™ä¸ªé—®é¢˜ï¼Œå®ƒå‘Šè¯‰ Storm å¦‚ä½•åœ¨ set of taskï¼ˆä»»åŠ¡ç»„ï¼‰ä¹‹é—´å‘é€ tupleï¼Œåœ¨æˆ‘ä»¬æ·±å…¥ä¸åŒç§ç±»çš„æµåˆ†ç»„ä»¥å‰ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ <a href="http://github.com/apache/storm/blob/master/examples/storm-starter" target="_blank" rel="external">storm-start</a> é‡Œçš„å¦ä¸€ä¸ª topology ï¼Œ<a href="https://github.com/apache/storm/blob/master/examples/storm-starter/src/jvm/storm/starter/WordCountTopology.java" target="_blank" rel="external">WordCountTopology</a>ä»ä¸€ä¸ª spout ä¸­è¯»å–å¥å­å¹¶ä¸”ä» <code>WordCountBolt</code> ä¸­è·å–æŸä¸ªå•è¯å‡ºç°çš„æ¬¡æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</div><div class="line"></div><div class="line">builder.setSpout(<span class="string">"sentences"</span>, <span class="keyword">new</span> RandomSentenceSpout(), <span class="number">5</span>);        </div><div class="line">builder.setBolt(<span class="string">"split"</span>, <span class="keyword">new</span> SplitSentence(), <span class="number">8</span>)</div><div class="line">        .shuffleGrouping(<span class="string">"sentences"</span>);</div><div class="line">builder.setBolt(<span class="string">"count"</span>, <span class="keyword">new</span> WordCount(), <span class="number">12</span>)</div><div class="line">        .fieldsGrouping(<span class="string">"split"</span>, <span class="keyword">new</span> Fields(<span class="string">"word"</span>));</div></pre></td></tr></table></figure>
<p><code>SplitSentence</code> æŠŠå®ƒæ¥æ”¶åˆ°çš„æ¯ä¸€ä¸ªå¥å­ä¸­çš„æ¯ä¸€ä¸ªå•è¯å½“åš tuple å‘é€å‡ºå»ï¼Œ<code>WordCount</code>åœ¨å†…å­˜ä¸­ç»´æŠ¤äº†ä¸€ä¸ªå•è¯å’Œæ•°é‡çš„æ˜ å°„å…³ç³»ï¼Œæ¯æ¬¡ <code>WordCount</code> æ¥æ”¶åˆ°ä¸€ä¸ªå•è¯ï¼Œå®ƒå°±æ›´æ–°å•è¯çš„æ•°é‡ï¼Œç„¶åå‘é€æ–°çš„å•è¯æ•°é‡ã€‚</p>
<p>è¿˜æœ‰ä¸€äº›ä¸åŒç§ç±»çš„æµåˆ†ç»„:</p>
<ul>
<li><p>åŸºæœ¬çš„åˆ†ç»„ç±»å‹å«åš â€œä¹±åºåˆ†ç»„(shuffle grouping)â€ ï¼Œå®ƒå°†ä½¿ tuple è¢«éšæœºå‘ä¸ªä¸€ä¸ª taskï¼Œ<code>WordCountTopology</code>ä¸­ ä½¿ç”¨äº†ä¹±åºåˆ†ç»„æ¥ä» <code>RandomSentenceSpout</code> å‘<code>SplitSentence</code> å‘é€ tupleï¼Œ è¿™æ ·æ‰€æœ‰çš„å¤„ç†ä»»åŠ¡å°±èƒ½å¤Ÿè¢«å¹³å‡çš„åˆ†é…åˆ°æ‰€æœ‰è¿è¡Œ<code>SplitSentence</code> Boltçš„ task ä¸Šã€‚</p>
</li>
<li><p>ä¸€ä¸ªæ›´æœ‰è¶£çš„åˆ†ç»„ç±»å‹æ˜¯ <code>å­—æ®µåˆ†ç»„(fields grouping)</code> ï¼Œ<code>SplitSentence</code> å’Œ <code>WordCount</code>ä¹‹é—´ä½¿ç”¨äº†ä¸€ä¸ªå­—æ®µåˆ†ç»„ï¼Œ<code>WordCount</code>èƒ½å¤Ÿè¿ä½œçš„ä¸€ä¸ªæä¸ºé‡è¦çš„è¦æ±‚æ˜¯ç›¸åŒçš„å•è¯å¿…é¡»è¢«å‘åˆ°åŒä¸€ä¸ª taskä¸­ï¼Œå¦åˆ™ä¼šæœ‰ä¸€ä¸ªä»¥ä¸Šçš„ task ä¼šæ¥æ”¶åˆ°ç›¸åŒçš„å•è¯ï¼Œç„¶åä»–ä»¬ä¼šå‘å°„é”™è¯¯çš„è®¡æ•°ã€‚å­—æ®µåˆ†ç»„ä½¿æˆ‘ä»¬å¯ä»¥ç”¨å­—æ®µå°†ä¸€ä¸ªæµåˆ†ç»„ï¼Œè¿™ä½¿å¾—ç›¸åŒå­—æ®µçš„å†…å®¹æ€»æ˜¯è¢«åˆ†åˆ°åŒä¸€ä¸ªtaskä¸­ã€‚ç”±äº<code>WordCount</code> åœ¨ <code>word</code> å­—æ®µä¸Šä½¿ç”¨å­—æ®µåˆ†ç»„è®¢é˜…äº† <code>SplitSentence</code>â€˜s çš„è¾“å‡ºæµï¼Œè¿™æ ·ç›¸åŒçš„å•è¯æ€»æ˜¯ä¼šè¿›å…¥åˆ°ç›¸åŒçš„task.</p>
<p>å­—æ®µåˆ†ç»„æ˜¯æµè¿æ¥å’Œæµèšåˆä»¥åŠè®¸å¤šå…¶ä»–ç”¨åŠ›çš„åŸºæœ¬å®ç°ï¼Œç©¶å…¶åŸç†ï¼Œå­—æ®µåˆ†ç»„æ˜¯é€šè¿‡ mod hashingï¼ˆå“ˆå¸Œçš„ä¸€ç§ï¼‰ æ¥å®ç°çš„.</p>
</li>
</ul>
<p>è¿˜æœ‰ä¸€äº›å…¶ä»–ç±»å‹çš„åˆ†ç»„ï¼Œå¯ä»¥åœ¨<a href="http://storm.apache.org/documentation/Concepts.html" target="_blank" rel="external">æ¦‚å¿µ</a>é‡ŒæŸ¥çœ‹æ›´å¤šã€‚</p>
<h3 id="ä¿è¯æ¶ˆæ¯å¤„ç†çš„å¯é æ€§"><a href="#ä¿è¯æ¶ˆæ¯å¤„ç†çš„å¯é æ€§" class="headerlink" title="ä¿è¯æ¶ˆæ¯å¤„ç†çš„å¯é æ€§"></a>ä¿è¯æ¶ˆæ¯å¤„ç†çš„å¯é æ€§</h3><p>stormä¿è¯ä»spoutå‘å‡ºçš„æ¯ä¸ªtupleéƒ½ä¼šè¢«å®Œå…¨å¤„ç†ã€‚</p>
<p><code>Storm</code> æä¾›äº†å‡ ä¸ªä¸åŒå±‚æ¬¡çš„ä¿è¯æ¶ˆæ¯å¤„ç†çš„æ–¹å¼,ä¾‹å¦‚æœ€ä½³åŠªåŠ›,è‡³å°‘ä¸€æ¬¡,åªæœ‰ä¸€æ¬¡ä¸‰ç§æ–¹å¼ã€‚ä¸‹æ–‡åŸºäºâ€œè‡³å°‘ä¸€æ¬¡â€æ–¹å¼.</p>
<p><strong>æ¶ˆæ¯è¢«â€å®Œæ•´å¤„ç†â€çš„å«ä¹‰?</strong></p>
<p>ä»spoutå‘å°„çš„ä¸€ä¸ªtupleå¯ä»¥å¼•èµ·å…¶å®ƒæˆåƒä¸Šä¸‡ä¸ªtupleå› å®ƒè€Œäº§ç”Ÿ ã€‚ä¸¾ä¾‹ï¼šç»Ÿè®¡æ¯ä¸ªå•è¯å‡ºç°æ¬¡æ•°çš„Topology.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</div><div class="line">builder.setSpout(<span class="string">"sentences"</span>, <span class="keyword">new</span> KestrelSpout(<span class="string">"kestrel.backtype.com"</span>,</div><div class="line">                                               <span class="number">22133</span>,</div><div class="line">                                               <span class="string">"sentence_queue"</span>,</div><div class="line">                                               <span class="keyword">new</span> StringScheme()));</div><div class="line">builder.setBolt(<span class="string">"split"</span>, <span class="keyword">new</span> SplitSentence(), <span class="number">10</span>)</div><div class="line">        .shuffleGrouping(<span class="string">"sentences"</span>);</div><div class="line">builder.setBolt(<span class="string">"count"</span>, <span class="keyword">new</span> WordCount(), <span class="number">20</span>)</div><div class="line">        .fieldsGrouping(<span class="string">"split"</span>, <span class="keyword">new</span> Fields(<span class="string">"word"</span>));</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªtopologyä»Kestrelé˜Ÿåˆ—ä¸­è¯»å–å¥å­ï¼Œå¹¶å°†å¥å­åˆ†å‰²æˆä¸€ä¸ªä¸ªçš„å•è¯ï¼Œæœ€åå‘é€çš„æ˜¯å„ä¸ªå•è¯å‡ºç°çš„æ¬¡æ•°ã€‚ä»spoutå‘å‡ºçš„tupleå°†ä¼šåœ¨ä¸‹æ¸¸è§¦å‘ç”Ÿæˆæ›´å¤šçš„tupleï¼šå¥å­ä¸­çš„æ¯ä¸ªå•è¯ä¼šå½¢æˆä¸€ä¸ªtupleä»¥åŠåé¢æ¯ä¸ªå•è¯çš„è®¡æ•°ä¼šå½¢æˆæ–°çš„tupleã€‚ä»¥ä¸‹æ˜¯tupleæ„æˆçš„æ¶ˆæ¯æ ‘æˆ–è€…è¯´tupleæ ‘:</p>
<p><img src="http://storm.apache.org/releases/current/images/tuple_tree.png" alt="Tuple tree"></p>
<p>å½“è¿™æ£µtupleæ ‘è¢«å®Œå…¨ä½¿ç”¨å¹¶ä¸”è¿™æ£µæ ‘ä¸­çš„æ‰€æœ‰çš„æ¶ˆæ¯éƒ½è¢«å®Œå…¨çš„å¤„ç†è¿‡äº†ï¼Œstormå°±è®¤ä¸ºspoutå‘å‡ºçš„tupleï¼ˆè¿™ä¸ªtupleæ˜¯æ ‘ä¸­çš„æ ¹èŠ‚ç‚¹ï¼‰è¢«â€å®Œå…¨å¤„ç†â€äº†ã€‚è€Œå½“è¿™æ£µæ ‘ä¸­çš„æ‰€æœ‰æ¶ˆæ¯åœ¨ç‰¹å®šçš„æ—¶é—´å†…æ²¡æœ‰è¢«å®Œå…¨çš„å¤„ç†ï¼Œstormå°±è®¤ä¸ºè¯¥tupleå°±æ˜¯æœªè¢«å®Œå…¨å¤„ç†çš„ã€‚å…¶ä¸­ï¼Œå¤„ç†çš„æ—¶é™å¯ä»¥é€šè¿‡<a href="http://storm.apache.org/javadoc/apidocs/backtype/storm/Config.html#TOPOLOGY_MESSAGE_TIMEOUT_SECS" target="_blank" rel="external">Config.TOPOLOGY_MESSAGE_TIMEOUT_SECS</a> è¿›è¡Œè®¾ç½®ï¼Œé»˜è®¤æ˜¯30ç§’ã€‚</p>
<p><strong>æ¶ˆæ¯è¢«å®Œå…¨å¤„ç†æˆ–è€…æœªè¢«å®Œå…¨å¤„ç†åˆ†åˆ«ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</strong></p>
<p>ä¸ºäº†ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹çœ‹spoutå‘å‡ºçš„tupleçš„ç”Ÿå‘½å‘¨æœŸã€‚è¿™é‡Œç»™å‡ºäº†spoutséœ€è¦å®ç°çš„æ¥å£ä½œä¸ºå‚è€ƒï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ISpout</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">open</span><span class="params">(Map conf, TopologyContext context, SpoutOutputCollector collector)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">nextTuple</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ack</span><span class="params">(Object msgId)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fail</span><span class="params">(Object msgId)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼ŒStormé€šè¿‡è°ƒç”¨Spoutä¸­çš„nextTupleæ–¹æ³•æ¥è¯·æ±‚ä¸€ä¸ªtupleã€‚Spoutä½¿ç”¨openæ–¹æ³•ä¸­æä¾›çš„SpoutOutputCollectorçš„å®ä¾‹æ¥å‘å®ƒçš„è¾“å‡ºæµä¸­å‘é€tupleï¼ˆcollector.emit()ï¼‰ã€‚å½“å‘é€ä¸€ä¸ªtupleæ—¶ï¼ŒSpoutä¼šæä¾›ä¸€ä¸ªâ€message idâ€ï¼Œåé¢å°†ä¼šç”¨è¿™ä¸ªâ€message idâ€æ¥æ ‡è¯†ç›¸åº”çš„tupleã€‚ä¾‹å¦‚:KestrelSpoutä»kestrelé˜Ÿåˆ—ä¸­è¯»å–ä¸€æ¡æ¶ˆæ¯å¹¶ä»¥Kestrelä¸­æ¶ˆæ¯çš„idä½œä¸ºtupleçš„â€message idâ€æ¥å‘é€è¯¥tupleã€‚é€šè¿‡SpoutOutputCollectorçš„å®ä¾‹_collectoræ¥å‘é€æ–¹å¼å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">_collector.emit(<span class="keyword">new</span> Values(<span class="string">"field1"</span>, <span class="string">"field2"</span>, <span class="number">3</span>) , msgId);</div></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ï¼Œè¯¥tupleè¢«å‘é€è‡³æ¶ˆè´¹boltsï¼ŒStormæ¥è·Ÿè¸ªä»¥è¯¥tupleä¸ºæ ¹èŠ‚ç‚¹ç”Ÿæˆçš„æ¶ˆæ¯æ ‘ã€‚å¦‚æœStormæ£€æµ‹åˆ°ä¸€ä¸ªtupleè¢«â€å®Œå…¨å¤„ç†â€äº†ï¼ŒStormå°†ä¼šæ ¹æ®message idè°ƒç”¨èµ·å§‹æ—¶<code>Spout</code> taskï¼ˆè¿™é‡Œè®¾è®¡åˆ°å¹¶å‘ï¼Œä¸€ä¸ªspoutå¯èƒ½äº§ç”Ÿå¤šä¸ªspout taskï¼Œå„ä¸ªtaskéƒ½ä¼šäº§ç”Ÿtupleï¼‰ä¸­çš„<code>ack</code>æ–¹æ³•ã€‚åŒæ ·çš„ï¼Œå¦‚æœtupleåœ¨è§„å®šæ—¶é—´å†…æœªè¢«â€å®Œå…¨å¤„ç†â€,Stormå°±ä¼šè°ƒç”¨failæ–¹æ³•ã€‚è°ƒç”¨ackæˆ–è€…failåœ¨ç”Ÿæˆè¯¥tupleçš„Spout taskä¸Šè¿›è¡Œçš„ã€‚å› æ­¤ï¼Œä¸€ä¸ªSpoutåœ¨æ‰§è¡Œæ—¶äº§ç”Ÿäº†å¤šä¸ªtasksï¼Œä¸€ä¸ªtupleçš„ackæˆ–failä¸ä¼šåˆéç”Ÿæˆè¯¥tupleçš„taskæ¥å®Œæˆã€‚</p>
<p>ç”¨KestrelSpoutæ¥çœ‹çœ‹Spoutåœ¨æ¶ˆæ¯å¤„ç†ä¿è¯æœºåˆ¶ä¸­åšäº†äº›ä»€ä¹ˆã€‚å½“KestrelSpoutä»Kestrelé˜Ÿåˆ—ä¸­è·å–ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œå®ƒä¼šâ€opensâ€(æ‰“å¼€)è¿™ä¸ªæ¶ˆæ¯ã€‚è¿™æ„å‘³ç€è¯¥æ¶ˆæ¯è¿˜å¹¶æ²¡æœ‰ä»é˜Ÿåˆ—ä¸­æå–å‡ºæ¥ï¼Œè€Œæ˜¯å¤„äºä¸€ç§â€pendingâ€ï¼ˆå¾…å¤„ç†ï¼‰çš„çŠ¶æ€ï¼Œç­‰å¾…ç¡®å®šè¿™æ¡æ¶ˆæ¯è¢«ç¡®å®çš„å¤„ç†å®Œæˆã€‚å¤„äºâ€pendingâ€çŠ¶æ€çš„æ¶ˆæ¯ä¸ä¼šè¢«å‘é€åˆ°è¯¥é˜Ÿåˆ—çš„å…¶ä»–æ¶ˆè´¹è€…ä¸­ã€‚å¦å¤–ï¼Œå¦‚æœå®¢æˆ·ç«¯æ–­å¼€äº†è¿æ¥ï¼Œæ‰€æœ‰â€pendingâ€çŠ¶æ€ä¸‹çš„æ¶ˆæ¯éƒ½å°†å›å½’é˜Ÿåˆ—ä¸­çš„æ­£å¸¸çŠ¶æ€ã€‚å½“ä¸€ä¸ªæ¶ˆæ¯è¢«â€opendâ€(æ‰“å¼€)ï¼ŒKestrelå°†ä¼šæä¾›è¯¥æ¶ˆæ¯çš„æ•°æ®ä»¥åŠè¯¥æ¶ˆæ¯çš„å”¯ä¸€çš„idç»™ç›¸åº”çš„å®¢æˆ·ç«¯ã€‚KestrelSpoutå°±ä½¿ç”¨è¿™ä¸ªidä½œä¸ºtupleçš„â€message idâ€ã€‚å½“KestrelSpoutä¸­çš„ackæˆ–è€…failè¢«è°ƒç”¨æ—¶ï¼ŒKestrelSpoutå°†ä¼šå‘é€ackæˆ–è€…failæ¶ˆæ¯å¹¶é™„ä¸Šmessage idç»™Kestrelï¼Œä»¥ä¾¿Kestrelå°†è¯¥æ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­è¸¢å‡ºæˆ–è€…è®©è¯¥æ¶ˆæ¯å›å½’æ­£å¸¸çŠ¶æ€ç­‰å¾…ä¸‹æ¬¡â€openâ€ã€‚</p>
<p><strong>Stormçš„å¯é æ€§API</strong></p>
<p>ä½œä¸ºä¸€ä¸ªç”¨æˆ·ï¼Œæˆ‘ä»¬ä½¿ç”¨stormçš„å¯é æ€§èƒ½åŠ›æ—¶éœ€è¦åšä¸¤ä»¶äº‹ã€‚1.å½“æˆ‘ä»¬åœ¨æ¶ˆæ¯æ ‘ä¸­å»ºç«‹äº†æ–°çš„è¿æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰Stormã€‚2.å½“æˆ‘ä»¬å¤„ç†å®Œäº†å•ä¸ªçš„tupleï¼ˆè¿™é‡Œtupleæ˜¯æ•´ä¸ªè¿‡ç¨‹ä¸­äº§ç”Ÿçš„tupleä¸å•å•åªæ ¹èŠ‚ç‚¹çš„é‚£ä¸ªtupleï¼‰ä¹Ÿéœ€è¦å‘Šè¯‰Stormã€‚é€šè¿‡ä»¥ä¸Šä¸¤ç‚¹ï¼ŒStormå°±å¯ä»¥æ£€æµ‹tupleæ ‘æ˜¯å¦å¤„ç†å®Œæˆï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„ackæˆ–è€…failã€‚Storm APIæä¾›äº†ç®€æ´çš„æ–¹æ¡ˆæ¥å®Œæˆä¸Šè¿°ä»»åŠ¡ã€‚</p>
<p>ç¡®å®štupleæ ‘ä¸­çš„ä¸€ä¸ªè¿æ¥å«åšâ€anchoringâ€ï¼ˆé”šå®šï¼‰ã€‚Anchoringå°†åœ¨å‘é€ä¸€ä¸ªæ–°tupleçš„æ—¶å€™å°±å®Œæˆã€‚æˆ‘ä»¬çœ‹ä¸‹é¢è¿™ä¸ªboltä¾‹å­ã€‚è¿™ä¸ªboltå°†ä¸€ä¸ªåŒ…å«ä¸€ä¸ªå¥å­çš„tupleåˆ†å‰²æˆå¤šä¸ªå•è¯tupleï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplitSentence</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</div><div class="line">        OutputCollector _collector;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map conf, TopologyContext context, OutputCollector collector)</span> </span>&#123;</div><div class="line">            _collector = collector;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</div><div class="line">            String sentence = tuple.getString(<span class="number">0</span>);</div><div class="line">            <span class="keyword">for</span>(String word: sentence.split(<span class="string">" "</span>)) &#123;</div><div class="line">                _collector.emit(tuple, <span class="keyword">new</span> Values(word));</div><div class="line">            &#125;</div><div class="line">            _collector.ack(tuple);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</div><div class="line">            declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"word"</span>));</div><div class="line">        &#125;        </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æ¯ä¸ªå•è¯tupleé€šè¿‡<code>_collector.emit(tuple,new Values(word))</code>ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆæœ¬ä¾‹ä¸­çš„tupleï¼‰æ¥anchoredï¼ˆé”šå®šï¼‰ã€‚å› ä¸ºå•è¯tupleå·²ç»è¢«é”šå®šäº†ï¼Œå¦‚æœä¸‹æ¸¸çš„tupleå‡ºç°å¤„ç†å¤±è´¥çš„æƒ…å†µï¼Œå¤„äºæ ‘æ ¹èŠ‚ç‚¹çš„spout tupleå°±ä¼šè¿›è¡Œé‡å‘ã€‚å¦‚æœæˆ‘ä»¬ä»¥<code>_collector.emit(new Values(word))</code>çš„æ–¹å¼å‘é€tupleï¼Œæ˜¾ç„¶è¿™ç§æ–¹å¼å‘é€çš„tupleæ˜¯æ²¡æœ‰è¢«é”šå®šçš„ã€‚å¦‚æœä¸‹æ¸¸å¤„ç†å¤±è´¥ï¼Œä¹Ÿä¸ä¼šé‡å‘ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®å…·ä½“çš„å®¹é”™éœ€è¦æ¥é€‰æ‹©ç›¸åº”çš„æ–¹å¼ã€‚ä¸€ä¸ªè¾“å‡ºçš„tupleå¯ä»¥è¢«å¤šä¸ªè¾“å…¥tupleé”šå®šã€‚å½“éœ€è¦è¿›è¡Œæµè¿æ¥ï¼ˆjoinï¼‰æˆ–è€…æ±‡èšï¼ˆaggregationï¼‰æ—¶ï¼Œè¿™ä¸ªåŠŸèƒ½éå¸¸æœ‰ç”¨ã€‚ä¸€ä¸ªå¤šé”šå®šçš„ï¼ˆmulti-anchoredï¼‰tupleå¤„ç†å¤±è´¥å°†å¯èƒ½ä¼šå¼•èµ·spoutsçš„å¤šä¸ªtupleçš„é‡å‘ã€‚é€šè¿‡ä»¥ä¸‹æ–¹å¼å¯ä»¥å®Œæˆå¤šé”šå®šï¼ˆmulti-anchoredï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">List&lt;Tuple&gt; anchors = <span class="keyword">new</span> ArrayList&lt;Tuple&gt;();</div><div class="line">anchors.add(tuple1);</div><div class="line">anchors.add(tuple2);</div><div class="line">_collector.emit(anchors, <span class="keyword">new</span> Values(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>));</div></pre></td></tr></table></figure>
<p>å¤šé”šå®šå°†è¾“å‡ºçš„tupleåŠ å…¥äº†ä¸€ä¸ªå¤štupleæ ‘ï¼ˆå…¶å®å·²ç„¶ä¸æ˜¯ä¸€ä¸ªæ ‘ç»“æ„ï¼Œè€Œæ˜¯ä¸€ä¸ªæœ‰å‘æ— ç¯å›¾DAGï¼Œå…¶å®æ ‘å°±æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„DAGå˜›ï¼‰å¯ä»¥ç§°ä¸ºtuple-DAGï¼š</p>
<p><img src="http://storm.apache.org/releases/current/images/tuple-dag.png" alt="Tuple DAG"></p>
<p><code>Anchoring</code>ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿä½¿tupleæ ‘å…·ä½“åŒ–ã€‚å¦‚ä½•æ¥ç¡®å®šå•ä¸ªtupleçš„å¤„ç†æ˜¯å¦å®Œæˆ: è¿™æ˜¯é€šè¿‡OutputCollectorä¸­çš„ackä»¥åŠfailæ¥å®ç°çš„ã€‚ä¾‹å¦‚ï¼Œä¸Šé¢çš„SplitSentenceä¾‹å­ï¼Œå®ƒåœ¨å‘é€å®Œæ‰€æœ‰çš„å•è¯tuplesåè¿›è¡Œäº†ackã€‚</p>
<p>å¯ä»¥é€šè¿‡OutputCollectorä¸­çš„failæ–¹æ³•æ¥è¿…é€Ÿé€šçŸ¥ä½äºæ ¹èŠ‚ç‚¹çš„spout tupleã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±æ— éœ€ç­‰åˆ°è¶…å‡ºæ—¶é™æ‰å‘é€failæ¶ˆæ¯ã€‚</p>
<p>æ¯ä¸ªtupleéƒ½å¿…é¡»è¿›è¡Œackæˆ–è€…failã€‚Stormä½¿ç”¨å†…å­˜æ¥è·Ÿè¸ªæ¯ä¸ªtupleï¼Œæ‰€ä»¥å¦‚æœä¸å¯¹æ¯ä¸ªtupleè¿›è¡Œackæˆ–è€…failï¼Œè´Ÿè´£è·Ÿè¸ªtupleçš„ä»»åŠ¡å°†ä¸€ç›´è¿è¡Œï¼Œç›´åˆ°å†…å­˜ç”¨å…‰ã€‚</p>
<p>å¤§å¤šæ•°boltséƒ½ä»¥ç§é€šç”¨çš„æ¨¡å¼æ¥è¯»å–è¾“å…¥çš„tupleï¼Œå‘é€tupleï¼Œä»¥åŠåœ¨executeæ–¹æ³•çš„ç»“å°¾å¤„æ¥ackè¿™ä¸ªtupleã€‚è¿™ç§çš„boltsè¢«å½’åˆ°äº†è¿‡æ»¤å™¨æˆ–è€…è¯´ç®€å•å‡½æ•°è¿™ä¸€ç±»ã€‚Stormä¸­æœ‰ä¸€ä¸ªBasicBoltæ¥å£åŒ…å«äº†è¿™ä¸€æ¨¡å¼ã€‚å°†SplitSentenceæ”¹æˆBasicBoltçš„å½¢å¼:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplitSentence</span> <span class="keyword">extends</span> <span class="title">BaseBasicBolt</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple, BasicOutputCollector collector)</span> </span>&#123;</div><div class="line">            String sentence = tuple.getString(<span class="number">0</span>);</div><div class="line">            <span class="keyword">for</span>(String word: sentence.split(<span class="string">" "</span>)) &#123;</div><div class="line">                collector.emit(<span class="keyword">new</span> Values(word));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</div><div class="line">            declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"word"</span>));</div><div class="line">        &#125;        </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªå®ç°æ¯”ä»¥å‰çš„æ›´åŠ ç®€æ´,ä½†æ˜¯åŠŸèƒ½ä¸Šæ˜¯ä¸€æ ·çš„ã€‚Tuplesåœ¨BasicOutputCollectorä¸­æ˜¯è‡ªåŠ¨ä¸è¾“å…¥çš„tupleé”šå®šçš„ï¼ˆä¸éœ€è¦æˆ‘ä»¬å¡«tupleå‚æ•°ï¼‰ã€‚å¹¶ä¸”å½“executeæ–¹æ³•å®Œæˆæ—¶è¾“å…¥tupleä¹Ÿæ˜¯è‡ªåŠ¨çš„è¿›è¡Œackã€‚ç›¸åï¼Œboltsè¿›è¡Œaggregationsï¼ˆæ±‡èšï¼‰æˆ–è€…joinsï¼ˆè¿æ¥ï¼‰æ—¶ï¼Œå°†ä¼šæ¨è¿Ÿackç›´åˆ°åœ¨æ‰¹é‡çš„tuplesçš„åŸºç¡€ä¸Šè®¡ç®—å‡ºäº†ç»“æœä¹‹åã€‚Aggregationsä»¥åŠjoinså°†ä¼šå¯¹ä»–ä»¬çš„output tuplesè¿›è¡Œå¤šé”šå®š,è¿™äº›ä¸œè¥¿è¶…å‡ºIBasicBoltçš„ç®€å•æ¨¡å¼ã€‚</p>
<p><strong>Stormå¦‚ä½•æœ‰æ•ˆçš„å®ç°å¯é æ€§</strong></p>
<p>åœ¨Storm topologyä¸­æœ‰ä¸€ç³»åˆ—ç‰¹æ®Šçš„â€ackerâ€å®ƒä»¬ä¼šä¸ºæ¯ä¸ªspout tupleè¿½è¸ªDAGä¸­çš„tuplesã€‚å½“ä¸€ä¸ªackeræ£€æµ‹åˆ°ä¸€ä¸ªDAGå®Œæˆäº†ï¼Œå®ƒå°†ä¼šå‘é€ä¸€æ¡æ¶ˆæ¯ç»™ç”Ÿæˆäº†è¯¥spout tupleçš„taskæ¥è¿›è¡Œç¡®è®¤ã€‚ï¼ˆè¿™é‡Œï¼Œå¤§å®¶è‚¯å®šä¼šæœ‰ç–‘æƒ‘ï¼Œæ¯æ¬¡tupleå‘é€æ—¶éƒ½è¿›è¡Œäº†ackï¼Œä¸ºä»€ä¹ˆè¿˜æœ‰ackerã€‚answerï¼šæ¯æ¬¡çš„ackæ˜¯å‘ŠçŸ¥ackeræœ¬æ¬¡çš„å¤„ç†å®Œäº†ã€‚è€Œackerè¦è¿›è¡Œæ±‡æ€»å‘Šè¯‰æ ¹èŠ‚ç‚¹taskæ‰€æœ‰çš„tupleéƒ½å¤„ç†å®Œæˆäº†ï¼‰ã€‚å¯ä»¥é€šè¿‡<a href="http://storm.apache.org/javadoc/apidocs/backtype/storm/Config.html#TOPOLOGY_ACKER_EXECUTORS" target="_blank" rel="external">Config.TOPOLOGY_ACKER_EXECUTORS</a>æ¥è®¾ç½®ackerçš„ä¸ªæ•°ã€‚Stormé»˜è®¤ackerçš„ä¸ªæ•°ä¸workerçš„ä¸ªæ•°ä¸€æ ·ã€‚â€“å½“æˆ‘ä»¬éœ€è¦å¤„ç†å¤§é‡çš„æ¶ˆæ¯æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½å°±éœ€è¦æé«˜è¿™ä¸ªackerçš„é‡äº†ã€‚</p>
<p>ç†è§£Stormçš„å¯é æ€§çš„æœ€å¥½æ–¹å¼æ˜¯ç ”ç©¶tuplesä»¥åŠtuple DAGçš„ç”Ÿå‘½å‘¨æœŸã€‚å½“tupleåœ¨topologyä¸­ç”Ÿæˆæ—¶ï¼Œæ— è®ºæ˜¯spoutè¿˜æ˜¯boltç”Ÿæˆçš„tupleï¼Œéƒ½å°†è¢«èµ‹äºˆä¸€ä¸ª64bitçš„éšæœºidã€‚è¿™äº›idå°±è¢«ackersç”¨æ¥è·Ÿè¸ªè¿™ä¸ªtuple DAGä¸­çš„æ¯ä¸ªspout tupleã€‚</p>
<p>æ¯ä¸ªtupleéƒ½çŸ¥é“æ‰€æœ‰ä¸å…¶ä½äºåŒä¸ªDAGçš„spout tuplesçš„idã€‚å½“æˆ‘ä»¬å‘é€ä¸€ä¸ªæ–°çš„tupleæ—¶ï¼Œspout tupleçš„idå°†ä¼šé€šè¿‡é”šå®šè¿™ä¸ªæ–¹å¼æ‹·è´åˆ°æ–°çš„tupleä¸­ã€‚å½“è¯¥tupleè¿›è¡Œackï¼Œå®ƒä¼šå‘é€ä¸€æ¡æ¶ˆæ¯ç»™ç›¸åº”çš„acker taskå‘Šè¯‰å…¶tupel DAGçš„å˜åŒ–æƒ…å†µã€‚ç™½è¯ä¸€ç‚¹ï¼šè¯¥tupleè¯´ï¼šæˆ‘å·²ç»å®Œæˆäº†è¯¥idå·çš„spout tupleæ¥çš„è®¡ç®—ï¼Œç„¶åè¿™äº›æ˜¯é”šå®šäº†æˆ‘çš„æ–°çš„tupleã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœtuples Dä¸Eæ˜¯åœ¨Cçš„åŸºç¡€ä¸Šç”Ÿæˆçš„ï¼Œé‚£ä¹ˆä¸‹é¢å°±æ˜¯å½“C ackä»¥åï¼Œtuple DAGçš„å˜åŒ–ï¼ˆæ‰“çº¢å‰è¯´æ˜å°±æ˜¯ackäº†ï¼‰ï¼š</p>
<p><img src="http://img.blog.csdn.net/20151012163509158" alt="img"></p>
<p>ç”±äºCè¢«ackæ—¶ï¼ŒDä¸Eåˆè¢«åŠ å…¥åˆ°äº†DAGä¸­ï¼Œæ•…è¿™ä¸ªDAGè¿˜æ²¡æœ‰è¢«å®Œå…¨å¤„ç†ã€‚</p>
<p>è¿™é‡Œæœ‰äº›ç»†èŠ‚éœ€è¦è¯´æ˜ï¼Œä¸Šé¢å·²ç»æè¿‡ï¼Œä½ å¯ä»¥è‡ªå·±è®¾ç½®ä»»æ„æ•°é‡çš„acker tasksã€‚è¿™å°±ä¼šå¯¼è‡´å‡ºç°é—®é¢˜ï¼šå½“ä¸€ä¸ªtupleè¢«ackäº†ï¼Œå®ƒå¦‚ä½•çŸ¥é“å®ƒè¯¥å‘å“ªä¸ªacker taskå‘æ¶ˆæ¯ï¼Ÿ</p>
<p>Stormä½¿ç”¨mod hashingçš„æ–¹å¼å°†spout tuple idæ˜ å°„ç»™ç›¸åº”çš„acker taskã€‚å› ä¸ºæ¯ä¸€ä¸ªtupleçŸ¥é“å®ƒæ‰€æœ‰çš„spoutçš„tuple idï¼Œ æ‰€ä»¥å®ƒè‡ªç„¶å¯ä»¥ç®—å‡ºè¦é€šçŸ¥å“ªä¸ªackerï¼ˆè¿™é‡Œæ³¨æ„å› ä¸ºä¸€ä¸ªtupleå¯èƒ½å­˜åœ¨äºå¤šä¸ªtupleæ ‘ï¼‰ã€‚</p>
<p>å¦ä¸€ä¸ªç»†èŠ‚æ˜¯acker taskå¦‚ä½•çŸ¥é“å‘å“ªä¸ªspout taskå‘é€æ¶ˆæ¯ï¼Ÿ</p>
<p>å½“spout taskå‘å‡ºä¸€ä¸ªæ–°çš„tupleæ—¶ï¼Œå®ƒä¼šç®€å•çš„å‘ä¸€ä¸ªæ¶ˆæ¯ç»™ä¸€ä¸ªåˆé€‚çš„acker,å¹¶ä¸”å‘Šè¯‰ackerå®ƒè‡ªå·±çš„id(taskid),è¿™æ ·stormå°±æœ‰äº†taskid-tupleidçš„å¯¹åº”å…³ç³»ã€‚å› æ­¤acker taskå¯ä»¥æ ¹æ®spout task idæ¥ç¡®å®šå½“tupleå®Œæˆåå‘ç›¸åº”çš„spout taskå‘æ¶ˆæ¯ã€‚</p>
<p>Acker taskså¹¶ä¸æ˜¯æ˜¾å¼çš„è¿½è¸ªtuple DAGï¼ˆè¿™ä¼šä½¿å¾—å•å•è¿è¡Œacker taskå°±è€—å…‰å†…å­˜ï¼‰ï¼Œè€Œæ˜¯ackerç”¨äº†ä¸€ç§ä¸åŒçš„æ–¹å¼ï¼Œä½¿å¾—å¯¹äºæ¯ä¸ªspout tupleæ‰€éœ€è¦çš„å†…å­˜é‡æ˜¯æ’å®šçš„ï¼ˆ20 bytes)ã€‚è¿™ç§è¿½è¸ªç®—æ³•æ˜¯Stormçš„å…³é”®ï¼Œä¹Ÿæ˜¯stormçš„ä¸€ä¸ªä¸»è¦çªç ´ã€‚</p>
<p>acker taskå­˜å‚¨äº†ä¸€ä¸ªspout tuple idåˆ°ä¸€ä¸ªå€¼å¯¹ï¼ˆvalue1ï¼Œvalue2ï¼‰çš„æ˜ å°„ ã€‚value1æ˜¯spout task idç”¨æ¥åœ¨å®Œæˆå¤„ç†tupleçš„æ—¶å€™å‘é€æ¶ˆæ¯ç”¨çš„ã€‚value2æ˜¯ä¸€ä¸ª64bitçš„æ•°å­—å«åšâ€ack valâ€ï¼ˆackå˜é‡ï¼‰:ack valæ˜¯æ•´ä¸ªtupleæ ‘çš„çŠ¶æ€çš„ä¸€ä¸ªè¡¨ç¤ºï¼Œä¸ç®¡è¿™æ£µæ ‘å¤šå¤§, å®ƒåªæ˜¯ç®€å•åœ°æŠŠè¿™æ£µæ ‘ä¸Šçš„æ‰€æœ‰åˆ›å»ºçš„tupleid/ackçš„tupleidä¸€èµ·å¼‚æˆ–(XOR)ã€‚ã€‚</p>
<p>å½“acker taskå‘ç°ackå˜é‡çš„å€¼ä¸º0æ—¶ï¼Œé‚£å°±è¯´æ˜tupleæ ‘å·²ç»å®Œå…¨å¤„ç†äº†ã€‚å› ä¸ºtuple idæ˜¯éšæœºçš„64bitæ•°ï¼Œæ‰€ä»¥å¦‚æœå› ä¸ºä¸åŒçš„æ•°å¼‚æˆ–äº§ç”Ÿ0çš„æ¦‚ç‡æ˜¯ç‰¹åˆ«å°çš„ã€‚ç»æ•°å­¦è®¡ç®—ï¼Œæ¯ç§’10kæ¬¡çš„ackï¼Œä¹Ÿéœ€è¦50000000å¹´æ‰ä¼šå‡ºç°ä¸€æ¬¡ä¸Šè¿°é”™è¯¯æƒ…å†µã€‚è€Œä¸”å³ä½¿å‡ºç°äº†ä¸Šè¿°é”™è¯¯ï¼Œä¹Ÿä»…ä»…æ˜¯é€ æˆäº†ä¸€æ¬¡æ•°æ®çš„ä¸¢å¤±ï¼Œå¦‚æœç¢°å·§è¿™æ¬¡å¤„ç†æ˜¯å¤±è´¥çš„ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œåœ¨å„ç§å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œstormå¦‚ä½•é¿å…æ•°æ®ä¸¢å¤±:</p>
<ul>
<li>ç”±äºtask diedï¼Œtupleæœªè¿›è¡Œack:è¿™ç§æƒ…å†µä¸‹ï¼Œå¤„ç†å°†è¶…æ—¶ï¼Œspout tupleå°†é‡å‘</li>
<li>Acker task dies:è¿™ç§æƒ…å†µä¸‹æ‰€æœ‰è¯¥Acker taskè·Ÿè¸ªä¸‹çš„spout tupleéƒ½å°†å› ä¸ºè¶…æ—¶è€Œé‡å‘</li>
<li>Spout task dies:è¿™ç§æƒ…å†µä¸‹Spoutçš„æºå¤´å°†è¿›è¡Œæ¶ˆæ¯é‡å‘ï¼Œä¾‹å¦‚ï¼šå½“ä¸æ¶ˆè´¹å®¢æˆ·ç«¯å¤±å»è¿æ¥åï¼ŒKestrelå’ŒRabbitMQå°†ä¼šæŠŠæ‰€æœ‰çš„â€å¾…å¤„ç†â€æ¶ˆæ¯å›å¤æ­£å¸¸ã€‚</li>
</ul>
<p>ä½ å¯ä»¥çœ‹åˆ°ï¼ŒStormçš„å¯é æ€§æœºåˆ¶æ˜¯å®Œå…¨åˆ†å¸ƒå¼ã€å¯æ‰©å±•ä»¥åŠå®¹é”™çš„ã€‚</p>
<p>è°ƒæ•´stormçš„å¯é æ€§</p>
<p>Acker tasksæ˜¯è½»é‡çº§çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨topologyå¹¶ä¸éœ€è¦éƒ¨ç½²å¤ªå¤šã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡Storm UIæ¥ç›‘æ§ä»–çš„æ€§èƒ½ã€‚å¦‚æœæµé‡ä¸å¤ªå¯¹ï¼Œæˆ‘ä»¬å¯èƒ½å°±éœ€è¦åŠ å¤§acker taskçš„é‡äº†ã€‚</p>
<p>å¦‚æœå¯é æ€§å¯¹ä½ æ¥è¯´ä¸å¤ªé‡è¦ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸è¿½è¸ªtupleäº†ã€‚è¿™å°†ä½¿æ¶ˆæ¯çš„ä¼ è¾“é‡ä¸‹é™ä¸€åŠã€‚å¦å¤–ï¼Œä¸‹æ¸¸çš„tupleä¹Ÿä¸éœ€è¦æ‹·è´spout tuple idï¼Œè¿™ä¹Ÿå°†å‡å°‘å¸¦å®½ä½¿ç”¨ã€‚</p>
<p>æˆ‘ä»¬æœ‰ä¸‰ç§æ–¹å¼æ¥ç§»é™¤å¯é æ€§ã€‚ç¬¬ä¸€ç§æ˜¯è®¾ç½®Config.TOPOLOGY_ACKERSä¸º0 ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒStormå°†ä¼šåœ¨spoutå‘é€äº†tupleåå°±è°ƒç”¨spoutçš„ackæ–¹æ³•ã€‚å› æ­¤DAGå°±ä¸ä¼šè¢«è¿½è¸ªã€‚</p>
<p>ç¬¬äºŒç§æ–¹å¼æ˜¯å°†æ¶ˆæ¯çš„message idç½®ä¸ºnullã€‚é€šè¿‡åœ¨SpoutOutputcollector.emitå‚æ•°ä¸­è®¾ç½®message idä¸ºnullï¼Œå°±å¯ä»¥å…³é—­å¯¹å½“å‰spout tupleçš„è¿½è¸ªã€‚</p>
<p>ç¬¬ä¸‰ç§æ–¹å¼å°±æ˜¯ä¹‹å‰æåˆ°è¿‡çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä¸å¯¹ä¸‹æ¸¸çš„tupleè¿›è¡Œé”šå®šï¼ˆanchorï¼‰ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[zookeeper åˆ†å¸ƒå¼é”]]></title>
      <url>http://zsr.github.io/2016/08/29/zookeeper-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
      <content type="html"><![CDATA[<h2 id="åˆ†å¸ƒå¼é”"><a href="#åˆ†å¸ƒå¼é”" class="headerlink" title="åˆ†å¸ƒå¼é”"></a>åˆ†å¸ƒå¼é”</h2><p>åˆ†å¸ƒå¼çš„é”å…¨å±€åŒæ­¥ï¼Œ è¿™æ„å‘³ç€ä»»ä½•ä¸€ä¸ªæ—¶é—´ç‚¹ä¸ä¼šæœ‰ä¸¤ä¸ªå®¢æˆ·ç«¯éƒ½æ‹¥æœ‰ç›¸åŒçš„é”ã€‚</p>
<h3 id="å¯é‡å…¥é”Shared-Reentrant-Lock"><a href="#å¯é‡å…¥é”Shared-Reentrant-Lock" class="headerlink" title="å¯é‡å…¥é”Shared Reentrant Lock"></a>å¯é‡å…¥é”Shared Reentrant Lock</h3><p>Sharedæ„å‘³ç€é”æ˜¯å…¨å±€å¯è§çš„ï¼Œ å®¢æˆ·ç«¯éƒ½å¯ä»¥è¯·æ±‚é”ã€‚ Reentrantå’ŒJDKçš„ReentrantLockç±»ä¼¼ï¼Œ æ„å‘³ç€åŒä¸€ä¸ªå®¢æˆ·ç«¯åœ¨æ‹¥æœ‰é”çš„åŒæ—¶ï¼Œå¯ä»¥å¤šæ¬¡è·å–ï¼Œä¸ä¼šè¢«é˜»å¡ã€‚å®ƒæ˜¯ç”±ç±»<code>InterProcessMutex</code>æ¥å®ç°ã€‚<br>å®ƒçš„æ„é€ å‡½æ•°ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">InterProcessMutex</span><span class="params">(CuratorFramework client, String path)</span></span></div></pre></td></tr></table></figure>
<p>é€šè¿‡<code>acquire</code>è·å¾—é”ï¼Œå¹¶æä¾›è¶…æ—¶æœºåˆ¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Acquire the mutex - blocking until it's available. Note: the same thread can call acquire</div><div class="line">* re-entrantly. Each call to acquire must be balanced by a call to release()</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">()</span></span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* Acquire the mutex - blocks until it's available or the given time expires. Note: the same </div><div class="line">* thread can call acquire re-entrantly. Each call to acquire that returns true must be </div><div class="line">* balanced by a call to release()</div><div class="line">* Parameters:</div><div class="line">* time - time to wait</div><div class="line">* unit - time unit</div><div class="line">* Returns:</div><div class="line">* true if the mutex was acquired, false if not</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acquire</span><span class="params">(<span class="keyword">long</span> time,</span></div><div class="line">                       TimeUnit unit)</div></pre></td></tr></table></figure>
<p>é€šè¿‡<code>release()</code>æ–¹æ³•é‡Šæ”¾é”ã€‚InterProcessMutex å®ä¾‹å¯ä»¥é‡ç”¨ã€‚</p>
<p><strong>Revoking</strong><br>ZooKeeper recipes wikiå®šä¹‰äº†å¯åå•†çš„æ’¤é”€æœºåˆ¶ã€‚<br>ä¸ºäº†æ’¤é”€mutex, è°ƒç”¨ä¸‹é¢çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* å°†é”è®¾ä¸ºå¯æ’¤é”€çš„. å½“åˆ«çš„è¿›ç¨‹æˆ–çº¿ç¨‹æƒ³è®©ä½ é‡Šæ”¾é”æ˜¯Listenerä¼šè¢«è°ƒç”¨ã€‚</div><div class="line">* Parameters:</div><div class="line">* listener - the listener</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makeRevocable</span><span class="params">(RevocationListener&lt;T&gt; listener)</span></span></div></pre></td></tr></table></figure>
<p>å¦‚æœè¯·æ±‚æ’¤é”€å½“å‰çš„é”ï¼Œ è°ƒç”¨<code>Revoker</code>æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Utility to mark a lock for revocation. Assuming that the lock has been registered</div><div class="line">* with a RevocationListener, it will get called and the lock should be released. Note,</div><div class="line">* however, that revocation is cooperative.</div><div class="line">* Parameters:</div><div class="line">* client - the client</div><div class="line">* path - the path of the lock - usually from something like </div><div class="line">* InterProcessMutex.getParticipantNodes()</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">attemptRevoke</span><span class="params">(CuratorFramework client,</span></span></div><div class="line">                                 String path)</div><div class="line">                         <span class="keyword">throws</span> Exception</div></pre></td></tr></table></figure>
<a id="more"></a>
<p><strong>é”™è¯¯å¤„ç†</strong><br>è¿˜æ˜¯å¼ºçƒˆæ¨èä½ ä½¿ç”¨<code>ConnectionStateListener</code>å¤„ç†è¿æ¥çŠ¶æ€çš„æ”¹å˜ã€‚ å½“è¿æ¥LOSTæ—¶ä½ ä¸å†æ‹¥æœ‰é”ã€‚</p>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„å…±äº«èµ„æºï¼Œ è¿™ä¸ªèµ„æºæœŸæœ›åªèƒ½å•çº¿ç¨‹çš„è®¿é—®ï¼Œå¦åˆ™ä¼šæœ‰å¹¶å‘é—®é¢˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.curator.lock;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicBoolean;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Simulates some external resource that can only be access by one process at a time</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FakeLimitedResource</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean inUse = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">use</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    <span class="comment">// çœŸå®ç¯å¢ƒä¸­æˆ‘ä»¬ä¼šåœ¨è¿™é‡Œè®¿é—®/ç»´æŠ¤ä¸€ä¸ªå…±äº«çš„èµ„æº</span></div><div class="line">    <span class="comment">//è¿™ä¸ªä¾‹å­åœ¨ä½¿ç”¨é”çš„æƒ…å†µä¸‹ä¸ä¼šéæ³•å¹¶å‘å¼‚å¸¸IllegalStateException</span></div><div class="line">	<span class="comment">//ä½†æ˜¯åœ¨æ— é”çš„æƒ…å†µç”±äºsleepäº†ä¸€æ®µæ—¶é—´ï¼Œå¾ˆå®¹æ˜“æŠ›å‡ºå¼‚å¸¸</span></div><div class="line">    <span class="keyword">if</span> (!inUse.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Needs to be used by one client at a time"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      Thread.sleep((<span class="keyword">long</span>) (<span class="number">3</span> * Math.random()));</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      inUse.set(<span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶ååˆ›å»ºä¸€ä¸ª<code>ExampleClientThatLocks</code>ç±»ï¼Œ å®ƒè´Ÿè´£è¯·æ±‚é”ï¼Œ ä½¿ç”¨èµ„æºï¼Œé‡Šæ”¾é”è¿™æ ·ä¸€ä¸ªå®Œæ•´çš„è®¿é—®è¿‡ç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.curator.lock;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.locks.InterProcessMutex;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleClientThatLocks</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> InterProcessMutex lock;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> FakeLimitedResource resource;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String clientName;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ExampleClientThatLocks</span><span class="params">(CuratorFramework client, String lockPath, FakeLimitedResource resource,</span></span></div><div class="line">      String clientName) &#123;</div><div class="line">    <span class="keyword">this</span>.resource = resource;</div><div class="line">    <span class="keyword">this</span>.clientName = clientName;</div><div class="line">    lock = <span class="keyword">new</span> InterProcessMutex(client, lockPath);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!lock.acquire(time, unit)) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(clientName + <span class="string">" could not acquire the lock"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      System.out.println(clientName + <span class="string">" has the lock"</span>);</div><div class="line">      resource.use();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      System.out.println(clientName + <span class="string">" releasing the lock"</span>);</div><div class="line">      lock.release(); <span class="comment">// always release the lock in a finally block</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€ååˆ›å»ºä¸»ç¨‹åºæ¥æµ‹è¯•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.curator.lock;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</div><div class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</div><div class="line"><span class="keyword">import</span> org.apache.curator.test.TestingServer;</div><div class="line"><span class="keyword">import</span> org.apache.curator.utils.CloseableUtils;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterProcessMutexExample</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> QTY = <span class="number">5</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REPETITIONS = QTY * <span class="number">10</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/examples/locks"</span>;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">final</span> FakeLimitedResource resource = <span class="keyword">new</span> FakeLimitedResource();</div><div class="line">    ExecutorService service = Executors.newFixedThreadPool(QTY);</div><div class="line">    <span class="keyword">final</span> TestingServer server = <span class="keyword">new</span> TestingServer();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; QTY; ++i) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = i;</div><div class="line">        Callable&lt;Void&gt; task = <span class="keyword">new</span> Callable&lt;Void&gt;() &#123;</div><div class="line">          <span class="meta">@Override</span></div><div class="line">          <span class="function"><span class="keyword">public</span> Void <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">              client.start();</div><div class="line">              <span class="keyword">final</span> ExampleClientThatLocks example = <span class="keyword">new</span> ExampleClientThatLocks(client, PATH, resource, <span class="string">"Client "</span> + index);</div><div class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; REPETITIONS; ++j) &#123;</div><div class="line">                example.doWork(<span class="number">10</span>, TimeUnit.SECONDS);</div><div class="line">              &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">              e.printStackTrace();</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">              CloseableUtils.closeQuietly(client);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">          &#125;</div><div class="line">        &#125;;</div><div class="line">        service.submit(task);</div><div class="line">      &#125;</div><div class="line">      service.shutdown();</div><div class="line">      service.awaitTermination(<span class="number">10</span>, TimeUnit.MINUTES);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      CloseableUtils.closeQuietly(server);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»£ç ä¹Ÿå¾ˆç®€å•ï¼Œç”Ÿæˆ10ä¸ªclientï¼Œ æ¯ä¸ªclienté‡å¤æ‰§è¡Œ10æ¬¡ è¯·æ±‚é”â€“è®¿é—®èµ„æºâ€“é‡Šæ”¾é”çš„è¿‡ç¨‹ã€‚æ¯ä¸ªclientéƒ½åœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸­ã€‚ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé”æ˜¯éšæœºçš„è¢«æ¯ä¸ªå®ä¾‹æ’ä»–æ€§çš„ä½¿ç”¨ã€‚</p>
<p>æ—¢ç„¶æ˜¯å¯é‡ç”¨çš„ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¤šæ¬¡è°ƒç”¨<code>acquire</code>,åœ¨çº¿ç¨‹æ‹¥æœ‰é”æ—¶å®ƒæ€»æ˜¯è¿”å›trueã€‚</p>
<p>ä¸åº”è¯¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­ç”¨åŒä¸€ä¸ªInterProcessMutexï¼Œ ä½ å¯ä»¥åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½ç”Ÿæˆä¸€ä¸ªInterProcessMutexå®ä¾‹ï¼Œå®ƒä»¬çš„pathéƒ½ä¸€æ ·ï¼Œè¿™æ ·å®ƒä»¬å¯ä»¥å…±äº«åŒä¸€ä¸ªé”ã€‚</p>
<h3 id="ä¸å¯é‡å…¥é”Shared-Lock"><a href="#ä¸å¯é‡å…¥é”Shared-Lock" class="headerlink" title="ä¸å¯é‡å…¥é”Shared Lock"></a>ä¸å¯é‡å…¥é”Shared Lock</h3><p>è¿™ä¸ªé”å’Œä¸Šé¢çš„ç›¸æ¯”ï¼Œå°±æ˜¯å°‘äº†<code>Reentrant</code>çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ„å‘³ç€å®ƒä¸èƒ½åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­é‡å…¥ã€‚<br>è¿™ä¸ªç±»æ˜¯<code>InterProcessSemaphoreMutex</code>ã€‚<br>ä½¿ç”¨æ–¹æ³•å’Œä¸Šé¢çš„ç±»ç±»ä¼¼ã€‚</p>
<p>å°†ä¸Šé¢çš„ä¾‹å­ä¿®æ”¹ä¸€ä¸‹ï¼Œæµ‹è¯•ä¸€ä¸‹å®ƒçš„é‡å…¥ã€‚ä¿®æ”¹<code>ExampleClientThatLocks.doWork</code>,è¿ç»­ä¸¤æ¬¡<code>acquire</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">	<span class="keyword">if</span> (!lock.acquire(time, unit)) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(clientName + <span class="string">" could not acquire the lock"</span>);</div><div class="line">	&#125;</div><div class="line">	System.out.println(clientName + <span class="string">" has the lock"</span>);</div><div class="line">	<span class="keyword">if</span> (!lock.acquire(time, unit)) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(clientName + <span class="string">" could not acquire the lock"</span>);</div><div class="line">	&#125;</div><div class="line">	System.out.println(clientName + <span class="string">" has the lock again"</span>);</div><div class="line">	</div><div class="line">	<span class="keyword">try</span> &#123;			</div><div class="line">		resource.use(); <span class="comment">//access resource exclusively</span></div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		System.out.println(clientName + <span class="string">" releasing the lock"</span>);</div><div class="line">		lock.release(); <span class="comment">// always release the lock in a finally block</span></div><div class="line">		lock.release(); <span class="comment">// always release the lock in a finally block</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„:</strong>æˆ‘ä»¬ä¹Ÿéœ€è¦è°ƒç”¨<code>release</code>ä¸¤æ¬¡ã€‚è¿™å’ŒJDKçš„ReentrantLockç”¨æ³•ä¸€è‡´ã€‚å¦‚æœå°‘è°ƒç”¨ä¸€æ¬¡<code>release</code>ï¼Œåˆ™æ­¤çº¿ç¨‹ä¾ç„¶æ‹¥æœ‰é”ã€‚<br>ä¸Šé¢çš„ä»£ç æ²¡æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å¤šæ¬¡è°ƒç”¨<code>acquire</code>ï¼Œåç»­çš„<code>acquire</code>ä¹Ÿä¸ä¼šé˜»å¡ã€‚<br>å°†ä¸Šé¢çš„<code>InterProcessMutex</code>æ¢æˆä¸å¯é‡å…¥é”<code>InterProcessSemaphoreMutex</code>,å¦‚æœå†è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œç»“æœå°±ä¼šå‘ç°çº¿ç¨‹è¢«é˜»å¡å†ç¬¬äºŒä¸ª<code>acquire</code>ä¸Šã€‚ ä¹Ÿå°±æ˜¯æ­¤é”ä¸æ˜¯å¯é‡å…¥çš„ã€‚</p>
<h3 id="å¯é‡å…¥è¯»å†™é”Shared-Reentrant-Read-Write-Lock"><a href="#å¯é‡å…¥è¯»å†™é”Shared-Reentrant-Read-Write-Lock" class="headerlink" title="å¯é‡å…¥è¯»å†™é”Shared Reentrant Read Write Lock"></a>å¯é‡å…¥è¯»å†™é”Shared Reentrant Read Write Lock</h3><p>ç±»ä¼¼JDKçš„<code>ReentrantReadWriteLock</code>.<br>ä¸€ä¸ªè¯»å†™é”ç®¡ç†ä¸€å¯¹ç›¸å…³çš„é”ã€‚ ä¸€ä¸ªè´Ÿè´£è¯»æ“ä½œï¼Œå¦å¤–ä¸€ä¸ªè´Ÿè´£å†™æ“ä½œã€‚ è¯»æ“ä½œåœ¨å†™é”æ²¡è¢«ä½¿ç”¨æ—¶å¯åŒæ—¶ç”±å¤šä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œè€Œå†™é”ä½¿ç”¨æ—¶ä¸å…è®¸è¯» (é˜»å¡)ã€‚<br>æ­¤é”æ˜¯å¯é‡å…¥çš„ã€‚ä¸€ä¸ªæ‹¥æœ‰å†™é”çš„çº¿ç¨‹å¯é‡å…¥è¯»é”ï¼Œä½†æ˜¯è¯»é”å´ä¸èƒ½è¿›å…¥å†™é”ã€‚<br>è¿™ä¹Ÿæ„å‘³ç€å†™é”å¯ä»¥é™çº§æˆè¯»é”ï¼Œ æ¯”å¦‚è¯·æ±‚å†™é” â€”&gt;è¯»é” â€”-&gt;é‡Šæ”¾å†™é”ã€‚ ä»è¯»é”å‡çº§æˆå†™é”æ˜¯ä¸æˆçš„ã€‚</p>
<p>ä¸»è¦ç”±ä¸¤ä¸ªç±»å®ç°ï¼š</p>
<ul>
<li>InterProcessReadWriteLock</li>
<li>InterProcessLock</li>
</ul>
<p>ä½¿ç”¨æ—¶é¦–å…ˆåˆ›å»ºä¸€ä¸ª<code>InterProcessReadWriteLock</code>å®ä¾‹ï¼Œç„¶åå†æ ¹æ®ä½ çš„éœ€æ±‚å¾—åˆ°è¯»é”æˆ–è€…å†™é”ï¼Œ è¯»å†™é”çš„ç±»å‹æ˜¯<code>InterProcessLock</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> InterProcessLock <span class="title">readLock</span><span class="params">()</span></span></div><div class="line"><span class="keyword">public</span> InterProcessLock <span class="title">writeLock</span><span class="params">()</span></div></pre></td></tr></table></figure>
<p>ä¾‹å­å’Œä¸Šé¢çš„ç±»ä¼¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.curator.lock;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.locks.InterProcessMutex;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.locks.InterProcessReadWriteLock;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleClientReadWriteLocks</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> InterProcessReadWriteLock lock;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> InterProcessMutex readLock;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> InterProcessMutex writeLock;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> FakeLimitedResource resource;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String clientName;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ExampleClientReadWriteLocks</span><span class="params">(CuratorFramework client, String lockPath, FakeLimitedResource resource,</span></span></div><div class="line">      String clientName) &#123;</div><div class="line">    <span class="keyword">this</span>.resource = resource;</div><div class="line">    <span class="keyword">this</span>.clientName = clientName;</div><div class="line">    lock = <span class="keyword">new</span> InterProcessReadWriteLock(client, lockPath);</div><div class="line">    readLock = lock.readLock();</div><div class="line">    writeLock = lock.writeLock();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!writeLock.acquire(time, unit)) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(clientName + <span class="string">" could not acquire the writeLock"</span>);</div><div class="line">    &#125;</div><div class="line">    System.out.println(clientName + <span class="string">" has the writeLock"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!readLock.acquire(time, unit)) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(clientName + <span class="string">" could not acquire the readLock"</span>);</div><div class="line">    &#125;</div><div class="line">    System.out.println(clientName + <span class="string">" has the readLock too"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      resource.use(); <span class="comment">// access resource exclusively</span></div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      System.out.println(clientName + <span class="string">" releasing the lock"</span>);</div><div class="line">      readLock.release(); <span class="comment">// always release the lock in a finally block</span></div><div class="line">      writeLock.release(); <span class="comment">// always release the lock in a finally block</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªç±»ä¸­æˆ‘ä»¬é¦–å…ˆè¯·æ±‚äº†ä¸€ä¸ªå†™é”ï¼Œ ç„¶åé™çº§æˆè¯»é”ã€‚ æ‰§è¡Œä¸šåŠ¡å¤„ç†ï¼Œç„¶åé‡Šæ”¾è¯»å†™é”ã€‚</p>
<h3 id="ä¿¡å·é‡Shared-Semaphore"><a href="#ä¿¡å·é‡Shared-Semaphore" class="headerlink" title="ä¿¡å·é‡Shared Semaphore"></a>ä¿¡å·é‡Shared Semaphore</h3><p>ä¸€ä¸ªè®¡æ•°çš„ä¿¡å·é‡ç±»ä¼¼JDKçš„Semaphoreã€‚ JDKä¸­Semaphoreç»´æŠ¤çš„ä¸€ç»„è®¸å¯(permits)ï¼Œè€ŒCuratorä¸­ç§°ä¹‹ä¸ºç§Ÿçº¦(Lease)ã€‚<br>æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å†³å®šsemaphoreçš„æœ€å¤§ç§Ÿçº¦æ•°ã€‚ç¬¬ä¸€ç§æ–¹å¼æ˜¯æœ‰ç”¨æˆ·ç»™å®šçš„pathå†³å®šã€‚ç¬¬äºŒç§æ–¹å¼ä½¿ç”¨<code>SharedCountReader</code>ç±»ã€‚<br>å¦‚æœä¸ä½¿ç”¨SharedCountReader, æ²¡æœ‰å†…éƒ¨ä»£ç æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å‡å®šæœ‰10ä¸ªç§Ÿçº¦è€Œè¿›ç¨‹Bå‡å®šæœ‰20ä¸ªç§Ÿçº¦ã€‚ æ‰€ä»¥æ‰€æœ‰çš„å®ä¾‹å¿…é¡»ä½¿ç”¨ç›¸åŒçš„numberOfLeaseså€¼.</p>
<p>è¿™æ¬¡è°ƒç”¨<code>acquire</code>ä¼šè¿”å›ä¸€ä¸ªç§Ÿçº¦å¯¹è±¡ã€‚ å®¢æˆ·ç«¯å¿…é¡»åœ¨finallyä¸­closeè¿™äº›ç§Ÿçº¦å¯¹è±¡ï¼Œå¦åˆ™è¿™äº›ç§Ÿçº¦ä¼šä¸¢å¤±æ‰ã€‚ ä½†æ˜¯ï¼Œ ä½†æ˜¯ï¼Œå¦‚æœå®¢æˆ·ç«¯sessionç”±äºæŸç§åŸå› æ¯”å¦‚crashä¸¢æ‰ï¼Œ é‚£ä¹ˆè¿™äº›å®¢æˆ·ç«¯æŒæœ‰çš„ç§Ÿçº¦ä¼šè‡ªåŠ¨closeï¼Œ è¿™æ ·å…¶å®ƒå®¢æˆ·ç«¯å¯ä»¥ç»§ç»­ä½¿ç”¨è¿™äº›ç§Ÿçº¦ã€‚<br>ç§Ÿçº¦è¿˜å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è¿”è¿˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnAll</span><span class="params">(Collection&lt;Lease&gt; leases)</span></span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnLease</span><span class="params">(Lease lease)</span></div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„:</strong>ä¸€æ¬¡ä½ å¯ä»¥è¯·æ±‚å¤šä¸ªç§Ÿçº¦ï¼Œå¦‚æœSemaphoreå½“å‰çš„ç§Ÿçº¦ä¸å¤Ÿï¼Œåˆ™è¯·æ±‚çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚ åŒæ—¶è¿˜æä¾›äº†è¶…æ—¶çš„é‡è½½æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Lease <span class="title">acquire</span><span class="params">()</span></span></div><div class="line"><span class="keyword">public</span> Collection&lt;Lease&gt; <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> qty)</span></div><div class="line"><span class="keyword">public</span> Lease <span class="title">acquire</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span></div><div class="line"><span class="keyword">public</span> Collection&lt;Lease&gt; <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> qty, <span class="keyword">long</span> time, TimeUnit unit)</span></div></pre></td></tr></table></figure>
<p>ä¸»è¦ç±»æœ‰:</p>
<ul>
<li>InterProcessSemaphoreV2</li>
<li>Lease</li>
<li>SharedCountReader</li>
</ul>
<p>ä¸‹é¢æ˜¯ä½¿ç”¨çš„ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.curator.lock;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Collection;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.locks.InterProcessSemaphoreV2;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.locks.Lease;</div><div class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</div><div class="line"><span class="keyword">import</span> org.apache.curator.test.TestingServer;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterProcessSemaphoreExample</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_LEASE = <span class="number">10</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/examples/locks"</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    FakeLimitedResource resource = <span class="keyword">new</span> FakeLimitedResource();</div><div class="line">    <span class="keyword">try</span> (TestingServer server = <span class="keyword">new</span> TestingServer()) &#123;</div><div class="line">      CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(),</div><div class="line">          <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</div><div class="line">      client.start();</div><div class="line">      InterProcessSemaphoreV2 semaphore = <span class="keyword">new</span> InterProcessSemaphoreV2(client, PATH, MAX_LEASE);</div><div class="line">      Collection&lt;Lease&gt; leases = semaphore.acquire(<span class="number">5</span>);</div><div class="line">      System.out.println(<span class="string">"get "</span> + leases.size() + <span class="string">" leases"</span>);</div><div class="line">      Lease lease = semaphore.acquire();</div><div class="line">      System.out.println(<span class="string">"get another lease"</span>);</div><div class="line">      resource.use();</div><div class="line">      Collection&lt;Lease&gt; leases2 = semaphore.acquire(<span class="number">5</span>, <span class="number">10</span>, TimeUnit.SECONDS);</div><div class="line">      System.out.println(<span class="string">"Should timeout and acquire return "</span> + leases2);</div><div class="line">      System.out.println(<span class="string">"return one lease"</span>);</div><div class="line">      semaphore.returnLease(lease);</div><div class="line">      System.out.println(<span class="string">"return another 5 leases"</span>);</div><div class="line">      semaphore.returnAll(leases);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆå…ˆè·å¾—äº†5ä¸ªç§Ÿçº¦ï¼Œ æœ€åæˆ‘ä»¬æŠŠå®ƒè¿˜ç»™äº†semaphoreã€‚<br>æ¥ç€è¯·æ±‚äº†ä¸€ä¸ªç§Ÿçº¦ï¼Œå› ä¸ºsemaphoreè¿˜æœ‰5ä¸ªç§Ÿçº¦ï¼Œæ‰€ä»¥è¯·æ±‚å¯ä»¥æ»¡è¶³ï¼Œè¿”å›ä¸€ä¸ªç§Ÿçº¦ï¼Œè¿˜å‰©4ä¸ªç§Ÿçº¦ã€‚<br>ç„¶åå†è¯·æ±‚ä¸€ä¸ªç§Ÿçº¦ï¼Œå› ä¸ºç§Ÿçº¦ä¸å¤Ÿï¼Œé˜»å¡åˆ°è¶…æ—¶ï¼Œè¿˜æ˜¯æ²¡èƒ½æ»¡è¶³ï¼Œè¿”å›ç»“æœä¸ºnullã€‚</p>
<p>ä¸Šé¢æ‰€è®²çš„é”éƒ½æ˜¯å…¬å¹³é”(fair)ã€‚ ä»ZooKeeperçš„è§’åº¦çœ‹ï¼Œ æ¯ä¸ªå®¢æˆ·ç«¯éƒ½æŒ‰ç…§è¯·æ±‚çš„é¡ºåºè·å¾—é”ï¼Œç›¸å½“å…¬å¹³ã€‚</p>
<h3 id="å¤šé”å¯¹è±¡-Multi-Shared-Lock"><a href="#å¤šé”å¯¹è±¡-Multi-Shared-Lock" class="headerlink" title="å¤šé”å¯¹è±¡ Multi Shared Lock"></a>å¤šé”å¯¹è±¡ Multi Shared Lock</h3><p>Multi Shared Lockæ˜¯ä¸€ä¸ªé”çš„å®¹å™¨ã€‚ å½“è°ƒç”¨<code>acquire</code>ï¼Œ æ‰€æœ‰çš„é”éƒ½ä¼šè¢«<code>acquire</code>ï¼Œå¦‚æœè¯·æ±‚å¤±è´¥ï¼Œæ‰€æœ‰çš„é”éƒ½ä¼šè¢«releaseã€‚ åŒæ ·è°ƒç”¨releaseæ—¶æ‰€æœ‰çš„é”éƒ½è¢«release(å¤±è´¥è¢«å¿½ç•¥)ã€‚<br>åŸºæœ¬ä¸Šï¼Œå®ƒå°±æ˜¯ç»„é”çš„ä»£è¡¨ï¼Œåœ¨å®ƒä¸Šé¢çš„è¯·æ±‚é‡Šæ”¾æ“ä½œéƒ½ä¼šä¼ é€’ç»™å®ƒåŒ…å«çš„æ‰€æœ‰çš„é”ã€‚</p>
<p>ä¸»è¦æ¶‰åŠä¸¤ä¸ªç±»ï¼š</p>
<ul>
<li>InterProcessMultiLock</li>
<li>InterProcessLock</li>
</ul>
<p>å®ƒçš„æ„é€ å‡½æ•°éœ€è¦åŒ…å«çš„é”çš„é›†åˆï¼Œæˆ–è€…ä¸€ç»„ZooKeeperçš„pathã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">InterProcessMultiLock</span><span class="params">(List&lt;InterProcessLock&gt; locks)</span></span></div><div class="line"><span class="keyword">public</span> <span class="title">InterProcessMultiLock</span><span class="params">(CuratorFramework client, List&lt;String&gt; paths)</span></div></pre></td></tr></table></figure>
<p>ç”¨æ³•å’ŒShared Lockç›¸åŒã€‚</p>
<p>ä¾‹å­å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.curator.lock;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Arrays;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.locks.InterProcessLock;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.locks.InterProcessMultiLock;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.locks.InterProcessMutex;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.locks.InterProcessSemaphoreMutex;</div><div class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</div><div class="line"><span class="keyword">import</span> org.apache.curator.test.TestingServer;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterProcessMultiLockExample</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH1 = <span class="string">"/examples/locks1"</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH2 = <span class="string">"/examples/locks2"</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    FakeLimitedResource resource = <span class="keyword">new</span> FakeLimitedResource();</div><div class="line">    <span class="keyword">try</span> (TestingServer server = <span class="keyword">new</span> TestingServer()) &#123;</div><div class="line">      CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(),</div><div class="line">          <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</div><div class="line">      client.start();</div><div class="line"></div><div class="line">      InterProcessLock lock1 = <span class="keyword">new</span> InterProcessMutex(client, PATH1);</div><div class="line">      InterProcessLock lock2 = <span class="keyword">new</span> InterProcessSemaphoreMutex(client, PATH2);</div><div class="line"></div><div class="line">      InterProcessMultiLock lock = <span class="keyword">new</span> InterProcessMultiLock(Arrays.asList(lock1, lock2));</div><div class="line">      <span class="keyword">if</span> (!lock.acquire(<span class="number">10</span>, TimeUnit.SECONDS)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"could not acquire the lock"</span>);</div><div class="line">      &#125;</div><div class="line">      System.out.println(<span class="string">"has the lock"</span>);</div><div class="line"></div><div class="line">      System.out.println(<span class="string">"has the lock1: "</span> + lock1.isAcquiredInThisProcess());</div><div class="line">      System.out.println(<span class="string">"has the lock2: "</span> + lock2.isAcquiredInThisProcess());</div><div class="line"></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        resource.use(); <span class="comment">// access resource exclusively</span></div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        System.out.println(<span class="string">"releasing the lock"</span>);</div><div class="line">        lock.release(); <span class="comment">// always release the lock in a finally block</span></div><div class="line">      &#125;</div><div class="line">      System.out.println(<span class="string">"has the lock1: "</span> + lock1.isAcquiredInThisProcess());</div><div class="line">      System.out.println(<span class="string">"has the lock2: "</span> + lock2.isAcquiredInThisProcess());</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ–°å»ºä¸€ä¸ªInterProcessMultiLockï¼Œ åŒ…å«ä¸€ä¸ªé‡å…¥é”å’Œä¸€ä¸ªéé‡å…¥é”ã€‚<br>è°ƒç”¨<code>acquire</code>åå¯ä»¥çœ‹åˆ°çº¿ç¨‹åŒæ—¶æ‹¥æœ‰äº†è¿™ä¸¤ä¸ªé”ã€‚<br>è°ƒç”¨<code>release</code>çœ‹åˆ°è¿™ä¸¤ä¸ªé”éƒ½è¢«é‡Šæ”¾äº†ã€‚</p>
<p><strong>æ³¨æ„ï¼š</strong>å¼ºçƒˆæ¨èä½¿ç”¨ConnectionStateListenerç›‘æ§è¿æ¥çš„çŠ¶æ€ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[zookeeper leaderé€‰ä¸¾]]></title>
      <url>http://zsr.github.io/2016/08/29/zookeeper-leader%E9%80%89%E4%B8%BE/</url>
      <content type="html"><![CDATA[<h2 id="Leaderé€‰ä¸¾"><a href="#Leaderé€‰ä¸¾" class="headerlink" title="Leaderé€‰ä¸¾"></a>Leaderé€‰ä¸¾</h2><p>åœ¨å®é™…ä½¿ç”¨ZooKeeperå¼€å‘ä¸­ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„æ˜¯<a href="http://curator.apache.org/index.html" target="_blank" rel="external">Apache Curator</a>ã€‚ åœ¨ä½¿ç”¨ZK APIå¼€å‘æ—¶ä¼šé‡åˆ°è®©äººå¤´ç–¼çš„å‡ ä¸ªé—®é¢˜ï¼ŒZKè¿æ¥ç®¡ç†ã€SESSIONå¤±æ•ˆç­‰ä¸€äº›å¼‚å¸¸é—®é¢˜çš„å¤„ç†ï¼ŒCuratoræ›¿æˆ‘ä»¬è§£å†³äº†è¿™äº›é—®é¢˜ï¼Œé€šè¿‡å¯¹ZKè¿æ¥çŠ¶æ€çš„ç›‘æ§æ¥åšå‡ºç›¸åº”çš„é‡è¿ç­‰æ“ä½œï¼Œå¹¶è§¦å‘äº‹ä»¶ã€‚</p>
<p>æ›´å¥½çš„åœ°æ–¹æ˜¯Curatorå¯¹ZKçš„ä¸€äº›åº”ç”¨åœºæ™¯æä¾›äº†éå¸¸å¥½çš„å®ç°ï¼Œè€Œä¸”æœ‰å¾ˆå¤šæ‰©å……ï¼Œè¿™äº›éƒ½ç¬¦åˆZKä½¿ç”¨è§„èŒƒã€‚<br>å®ƒçš„ä¸»è¦ç»„ä»¶ä¸ºï¼š</p>
<ul>
<li><strong>Recipes</strong>: ZooKeeperçš„ç³»åˆ—recipeå®ç°, åŸºäº Curator Framework.**</li>
<li><strong>Framework</strong>: å°è£…äº†å¤§é‡ZooKeeperå¸¸ç”¨APIæ“ä½œï¼Œé™ä½äº†ä½¿ç”¨éš¾åº¦, åŸºäºZookeeperå¢åŠ äº†ä¸€äº›æ–°ç‰¹æ€§ï¼Œå¯¹ZooKeeperé“¾æ¥çš„ç®¡ç†ï¼Œå¯¹é“¾æ¥ä¸¢å¤±è‡ªåŠ¨é‡æ–°é“¾æ¥ã€‚**</li>
<li><strong>Utilities</strong>: ä¸€äº›ZooKeeperæ“ä½œçš„å·¥å…·ç±»åŒ…æ‹¬ZKçš„é›†ç¾¤æµ‹è¯•å·¥å…·è·¯å¾„ç”Ÿæˆç­‰éå¸¸æœ‰ç”¨ï¼Œåœ¨Curator-ClientåŒ…ä¸‹org.apache.curator.utilsã€‚</li>
<li><strong>Client</strong>: ZooKeeperçš„å®¢æˆ·ç«¯APIå°è£…ï¼Œæ›¿ä»£å®˜æ–¹ ZooKeeper classï¼Œè§£å†³äº†ä¸€äº›ç¹çä½çº§çš„å¤„ç†ï¼Œæä¾›ä¸€äº›å·¥å…·ç±»ã€‚</li>
<li><strong>Errors</strong>: å¼‚å¸¸å¤„ç†, è¿æ¥å¼‚å¸¸ç­‰</li>
<li><strong>Extensions</strong>: å¯¹curator-recipesçš„æ‰©å±•å®ç°ï¼Œæ‹†åˆ†ä¸ºcurator-: stuck_out_tongue_closed_eyes: iscoveryå’Œcurator-: stuck_out_tongue_closed_eyes: iscovery-serveræä¾›åŸºäºRESTfulçš„Recipes WEBæœåŠ¡.</li>
</ul>
<p>åœ¨åˆ†å¸ƒå¼è®¡ç®—ä¸­ï¼Œ leader electionæ˜¯å¾ˆé‡è¦çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œ è¿™ä¸ªé€‰ä¸¾è¿‡ç¨‹æ˜¯è¿™æ ·å­çš„ï¼š æŒ‡æ´¾ä¸€ä¸ªè¿›ç¨‹ä½œä¸ºç»„ç»‡è€…ï¼Œå°†ä»»åŠ¡åˆ†å‘ç»™å„èŠ‚ç‚¹ã€‚ åœ¨ä»»åŠ¡å¼€å§‹å‰ï¼Œ å“ªä¸ªèŠ‚ç‚¹éƒ½ä¸çŸ¥é“è°æ˜¯leaderæˆ–è€…coordinator. å½“é€‰ä¸¾ç®—æ³•å¼€å§‹æ‰§è¡Œåï¼Œ æ¯ä¸ªèŠ‚ç‚¹æœ€ç»ˆä¼šå¾—åˆ°ä¸€ä¸ªå”¯ä¸€çš„èŠ‚ç‚¹ä½œä¸ºä»»åŠ¡leader.<br>é™¤æ­¤ä¹‹å¤–ï¼Œ é€‰ä¸¾è¿˜ç»å¸¸ä¼šå‘ç”Ÿåœ¨leaderæ„å¤–å®•æœºçš„æƒ…å†µä¸‹ï¼Œæ–°çš„leaderè¦è¢«é€‰ä¸¾å‡ºæ¥ã€‚</p>
<p>Curator æœ‰ä¸¤ç§é€‰ä¸¾recipeï¼Œ å¯ä»¥æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„ã€‚</p>
<h3 id="Leader-latch"><a href="#Leader-latch" class="headerlink" title="Leader latch"></a>Leader latch</h3><p>ä½¿ç”¨<code>LeaderLatch</code>ç±»é€‰ä¸¾çš„ä¾‹å­.</p>
<p>æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LeaderLatch</span><span class="params">(CuratorFramework client, String latchPath)</span></span></div><div class="line"><span class="keyword">public</span> <span class="title">LeaderLatch</span><span class="params">(CuratorFramework client, String latchPath,  String id)</span></div></pre></td></tr></table></figure>
<p>å¯åŠ¨LeaderLatch: <code>leaderLatch.start();</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Add this instance to the leadership election and attempt to acquire leadership.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@throws</span> Exception errors</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span></div><div class="line">    &#123;</div><div class="line">        Preconditions.checkState(state.compareAndSet(State.LATENT, State.STARTED), <span class="string">"Cannot be started more than once"</span>);</div><div class="line"></div><div class="line">        startTask.set(AfterConnectionEstablished.execute(client, <span class="keyword">new</span> Runnable()</div><div class="line">                &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">try</span></div><div class="line">                        &#123;</div><div class="line">                            internalStart();</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">finally</span></div><div class="line">                        &#123;</div><div class="line">                            startTask.set(<span class="keyword">null</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä¸€æ—¦å¯åŠ¨ï¼Œ LeaderLatchä¼šå’Œå…¶å®ƒä½¿ç”¨ç›¸åŒlatch pathçš„å…¶å®ƒLeaderLatchäº¤æ¶‰ï¼Œç„¶åéšæœºçš„é€‰æ‹©å…¶ä¸­ä¸€ä¸ªä½œä¸ºleaderã€‚ å¯ä»¥éšæ—¶æŸ¥çœ‹ä¸€ä¸ªç»™å®šçš„å®ä¾‹æ˜¯å¦æ˜¯leader:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasLeadership</span><span class="params">()</span></span></div></pre></td></tr></table></figure>
<p>LeaderLatchåœ¨è¯·æ±‚æˆä¸ºleadershipæ—¶æœ‰blockæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span></span></div><div class="line">     <span class="keyword">throws</span> InterruptedException, EOFException</div><div class="line">   &#123;</div><div class="line">     <span class="keyword">synchronized</span> (<span class="keyword">this</span>)</div><div class="line">     &#123;</div><div class="line">       <span class="keyword">while</span> ((<span class="keyword">this</span>.state.get() == State.STARTED) &amp;&amp; (!<span class="keyword">this</span>.hasLeadership.get()))</div><div class="line">       &#123;</div><div class="line">         wait();</div><div class="line">       &#125;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.state.get() != State.STARTED)</div><div class="line">     &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> EOFException();</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line">Causes the current thread to wait until <span class="keyword">this</span> instance acquires leadership</div><div class="line">unless the thread is interrupted or closed.</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> timeout,</span></span></div><div class="line">                     TimeUnit unit)</div><div class="line">            <span class="keyword">throws</span> InterruptedException</div></pre></td></tr></table></figure>
<p>ä¸€æ—¦ä¸ä½¿ç”¨LeaderLatchäº†ï¼Œå¿…é¡»è°ƒç”¨<code>close</code>æ–¹æ³•ã€‚ å¦‚æœå®ƒæ˜¯leader,ä¼šé‡Šæ”¾leadershipï¼Œ å…¶å®ƒçš„å‚ä¸è€…å°†ä¼šé‡æ–°é€‰ä¸¾ä¸€ä¸ªleaderã€‚</p>
<p><strong>å¼‚å¸¸å¤„ç†</strong><br>LeaderLatchå®ä¾‹å¯ä»¥å¢åŠ ConnectionStateListeneræ¥ç›‘å¬ç½‘ç»œè¿æ¥é—®é¢˜ã€‚ å½“ SUSPENDED æˆ– LOST æ—¶, leaderä¸å†è®¤ä¸ºè‡ªå·±è¿˜æ˜¯leader.å½“LOST è¿æ¥é‡è¿å RECONNECTED,LeaderLatchä¼šåˆ é™¤å…ˆå‰çš„ZNodeç„¶åé‡æ–°åˆ›å»ºä¸€ä¸ª.<br>LeaderLatchç”¨æˆ·å¿…é¡»è€ƒè™‘å¯¼è‡´leadershipä¸¢å¤±çš„è¿æ¥é—®é¢˜ã€‚ å¼ºçƒˆæ¨èä½ ä½¿ç”¨ConnectionStateListenerã€‚</p>
<a id="more"></a>
<p><strong>LeaderLatchæ¡ˆä¾‹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.curator;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.BufferedReader;</div><div class="line"><span class="keyword">import</span> java.io.InputStreamReader;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.leader.LeaderLatch;</div><div class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</div><div class="line"><span class="keyword">import</span> org.apache.curator.utils.CloseableUtils;</div><div class="line"><span class="keyword">import</span> org.apache.curator.test.TestingServer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.common.collect.Lists;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeaderLatchExample</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CLIENT_QTY = <span class="number">10</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/examples/leader"</span>;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    List&lt;CuratorFramework&gt; clients = Lists.newArrayList();</div><div class="line">    List&lt;LeaderLatch&gt; examples = Lists.newArrayList();</div><div class="line">    TestingServer server = <span class="keyword">new</span> TestingServer();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CLIENT_QTY; ++i) &#123;</div><div class="line">        CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</div><div class="line">        clients.add(client);</div><div class="line">        LeaderLatch example = <span class="keyword">new</span> LeaderLatch(client, PATH, <span class="string">"Client #"</span> + i);</div><div class="line">        examples.add(example);</div><div class="line">        client.start();</div><div class="line">        example.start();</div><div class="line">      &#125;</div><div class="line">      Thread.sleep(<span class="number">2000</span>);</div><div class="line">      LeaderLatch currentLeader = <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CLIENT_QTY; ++i) &#123;</div><div class="line">        LeaderLatch example = examples.get(i);</div><div class="line">        <span class="keyword">if</span> (example.hasLeadership())</div><div class="line">          currentLeader = example;</div><div class="line">      &#125;</div><div class="line">      System.out.println(<span class="string">"current leader is "</span> + currentLeader.getId());</div><div class="line">      System.out.println(<span class="string">"release the leader "</span> + currentLeader.getId());</div><div class="line">      currentLeader.close();</div><div class="line">      examples.get(<span class="number">0</span>).await(<span class="number">2</span>, TimeUnit.SECONDS);</div><div class="line">      System.out.println(<span class="string">"Client #0 maybe is elected as the leader or not although it want to be"</span>);</div><div class="line">      System.out.println(<span class="string">"the new leader is "</span> + examples.get(<span class="number">0</span>).getLeader().getId());</div><div class="line">      </div><div class="line">      System.out.println(<span class="string">"Press enter/return to quit\n"</span>);</div><div class="line">      <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in)).readLine();</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      System.out.println(<span class="string">"Shutting down..."</span>);</div><div class="line">      <span class="keyword">for</span> (LeaderLatch exampleClient : examples) &#123;</div><div class="line">        CloseableUtils.closeQuietly(exampleClient);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">for</span> (CuratorFramework client : clients) &#123;</div><div class="line">        CloseableUtils.closeQuietly(client);</div><div class="line">      &#125;</div><div class="line">      CloseableUtils.closeQuietly(server);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆåˆ›å»ºäº†10ä¸ªLeaderLatchï¼Œå¯åŠ¨åå®ƒä»¬ä¸­çš„ä¸€ä¸ªä¼šè¢«é€‰ä¸¾ä¸ºleaderã€‚ å› ä¸ºé€‰ä¸¾ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œstartåå¹¶ä¸èƒ½é©¬ä¸Šå°±å¾—åˆ°leaderã€‚<br>é€šè¿‡<code>hasLeadership</code>æŸ¥çœ‹è‡ªå·±æ˜¯å¦æ˜¯leaderï¼Œ å¦‚æœæ˜¯çš„è¯è¿”å›trueã€‚<br>å¯ä»¥é€šè¿‡<code>.getLeader().getId()</code>å¯ä»¥å¾—åˆ°å½“å‰çš„leaderçš„IDã€‚<br>åªèƒ½é€šè¿‡<code>close</code>é‡Šæ”¾å½“å‰çš„é¢†å¯¼æƒã€‚<br><code>await</code>æ˜¯ä¸€ä¸ªé˜»å¡æ–¹æ³•ï¼Œ å°è¯•è·å–leaderåœ°ä½ï¼Œä½†æ˜¯æœªå¿…èƒ½é€‰ä¸­ã€‚</p>
<h3 id="Leader-Election"><a href="#Leader-Election" class="headerlink" title="Leader Election"></a>Leader Election</h3><p>Curatorè¿˜æä¾›äº†å¦å¤–ä¸€ç§é€‰ä¸¾æ–¹æ³•ã€‚<br>ä¸»è¦æ¶‰åŠä»¥ä¸‹å››ä¸ªç±»ï¼š</p>
<ul>
<li>LeaderSelector</li>
<li>LeaderSelectorListener</li>
<li>LeaderSelectorListenerAdapter</li>
<li>CancelLeadershipException</li>
</ul>
<p>é‡è¦çš„æ˜¯LeaderSelectorç±»ï¼Œå®ƒçš„æ„é€ å‡½æ•°ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LeaderSelector</span><span class="params">(CuratorFramework client, String mutexPath,LeaderSelectorListener listener)</span></span></div><div class="line"><span class="keyword">public</span> <span class="title">LeaderSelector</span><span class="params">(CuratorFramework client, String mutexPath, ThreadFactory threadFactory, Executor executor, LeaderSelectorListener listener)</span></div></pre></td></tr></table></figure>
<p>ç±»ä¼¼LeaderLatch,å¿…é¡»<code>start</code>: <code>leaderSelector.start();</code><br>ä¸€æ—¦å¯åŠ¨ï¼Œå½“å®ä¾‹å–å¾—é¢†å¯¼æƒæ—¶ä½ çš„listenerçš„<code>takeLeadership()</code>æ–¹æ³•è¢«è°ƒç”¨. è€ŒtakeLeadership()æ–¹æ³•åªæœ‰é¢†å¯¼æƒè¢«é‡Šæ”¾æ—¶æ‰è¿”å›ã€‚<br>å½“ä½ ä¸å†ä½¿ç”¨<code>LeaderSelector</code>å®ä¾‹æ—¶ï¼Œéœ€è¦è°ƒç”¨å®ƒçš„closeæ–¹æ³•</p>
<p><strong>å¼‚å¸¸å¤„ç†</strong><br>LeaderSelectorListenerç±»ç»§æ‰¿ConnectionStateListenerã€‚LeaderSelectorå¿…é¡»å°å¿ƒè¿æ¥çŠ¶æ€çš„æ”¹å˜. å¦‚æœå®ä¾‹æˆä¸ºleader, å®ƒåº”è¯¥å“åº”SUSPENDED æˆ– LOST. å½“ SUSPENDED çŠ¶æ€å‡ºç°æ—¶ï¼Œ å®ä¾‹å¿…é¡»å‡å®šåœ¨é‡æ–°è¿æ¥æˆåŠŸä¹‹å‰å®ƒå¯èƒ½ä¸å†æ˜¯leaderäº†ã€‚ å¦‚æœLOSTçŠ¶æ€å‡ºç°ï¼Œ å®ä¾‹ä¸å†æ˜¯leaderï¼Œ takeLeadershipæ–¹æ³•è¿”å›.</p>
<p><strong>æ³¨æ„ï¼š</strong>æ¨èå¤„ç†æ–¹å¼æ˜¯å½“æ”¶åˆ°SUSPENDED æˆ– LOSTæ—¶æŠ›å‡ºCancelLeadershipExceptionå¼‚å¸¸. è¿™ä¼šå¯¼è‡´LeaderSelectorå®ä¾‹ä¸­æ–­å¹¶å–æ¶ˆæ‰§è¡ŒtakeLeadershipæ–¹æ³•çš„å¼‚å¸¸. è¿™éå¸¸é‡è¦ï¼Œ ä½ å¿…é¡»è€ƒè™‘æ‰©å±•LeaderSelectorListenerAdapter. LeaderSelectorListenerAdapteræä¾›äº†æ¨èçš„å¤„ç†é€»è¾‘ã€‚</p>
<p><strong>LeaderSelectoræ¡ˆä¾‹</strong></p>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªExampleClientç±»ï¼Œ å®ƒç»§æ‰¿LeaderSelectorListenerAdapterï¼Œ å®ƒå®ç°äº†takeLeadershipæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.curator;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.Closeable;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.leader.LeaderSelector;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.leader.LeaderSelectorListenerAdapter;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * An example leader selector client. Note that &#123;<span class="doctag">@link</span> LeaderSelectorListenerAdapter&#125; which has the</div><div class="line"> * recommended handling for connection state issues</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleClient</span> <span class="keyword">extends</span> <span class="title">LeaderSelectorListenerAdapter</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> LeaderSelector leaderSelector;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger leaderCount = <span class="keyword">new</span> AtomicInteger();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ExampleClient</span><span class="params">(CuratorFramework client, String path, String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.name = name;</div><div class="line"></div><div class="line">    <span class="comment">// create a leader selector using the given path for management</span></div><div class="line">    <span class="comment">// all participants in a given leader selection must use the same path</span></div><div class="line">    <span class="comment">// ExampleClient here is also a LeaderSelectorListener but this isn't required</span></div><div class="line">    leaderSelector = <span class="keyword">new</span> LeaderSelector(client, path, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="comment">// for most cases you will want your instance to requeue when it relinquishes leadership</span></div><div class="line">    leaderSelector.autoRequeue();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">// the selection for this instance doesn't start until the leader selector is started</span></div><div class="line">    <span class="comment">// leader selection is done in the background so this call to leaderSelector.start() returns</span></div><div class="line">    <span class="comment">// immediately</span></div><div class="line">    leaderSelector.start();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    leaderSelector.close();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeLeadership</span><span class="params">(CuratorFramework client)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="comment">// we are now the leader. This method should not return until we want to relinquish leadership</span></div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> waitSeconds = (<span class="keyword">int</span>) (<span class="number">5</span> * Math.random()) + <span class="number">1</span>;</div><div class="line"></div><div class="line">    System.out.println(name + <span class="string">" is now the leader. Waiting "</span> + waitSeconds + <span class="string">" seconds..."</span>);</div><div class="line">    System.out.println(name + <span class="string">" has been leader "</span> + leaderCount.getAndIncrement() + <span class="string">" time(s) before."</span>);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      Thread.sleep(TimeUnit.SECONDS.toMillis(waitSeconds));</div><div class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">      System.err.println(name + <span class="string">" was interrupted."</span>);</div><div class="line">      Thread.currentThread().interrupt();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      System.out.println(name + <span class="string">" relinquishing leadership.\n"</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥åœ¨takeLeadershipè¿›è¡Œä»»åŠ¡çš„åˆ†é…ç­‰ç­‰ï¼Œå¹¶ä¸”ä¸è¦è¿”å›ï¼Œå¦‚æœä½ æƒ³è¦è¦æ­¤å®ä¾‹ä¸€ç›´æ˜¯leaderçš„è¯å¯ä»¥åŠ ä¸€ä¸ªæ­»å¾ªç¯ã€‚<br><code>leaderSelector.autoRequeue();</code>ï¼šä¿è¯åœ¨æ­¤å®ä¾‹é‡Šæ”¾é¢†å¯¼æƒä¹‹åè¿˜å¯èƒ½è·å¾—é¢†å¯¼æƒã€‚<br>åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨AtomicIntegeræ¥è®°å½•æ­¤clientè·å¾—é¢†å¯¼æƒçš„æ¬¡æ•°ï¼Œ å®ƒæ˜¯å…¬å¹³çš„ï¼Œ æ¯ä¸ªclientæœ‰å¹³ç­‰çš„æœºä¼šè·å¾—é¢†å¯¼æƒã€‚</p>
<p><strong>æµ‹è¯•ä»£ç </strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.curator;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.BufferedReader;</div><div class="line"><span class="keyword">import</span> java.io.InputStreamReader;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</div><div class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</div><div class="line"><span class="keyword">import</span> org.apache.curator.test.TestingServer;</div><div class="line"><span class="keyword">import</span> org.apache.curator.utils.CloseableUtils;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.common.collect.Lists;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeaderSelectorExample</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CLIENT_QTY = <span class="number">10</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/examples/leader"</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="comment">// all of the useful sample code is in ExampleClient.java</span></div><div class="line"></div><div class="line">    System.out.println(<span class="string">"Create "</span> + CLIENT_QTY</div><div class="line">        + <span class="string">" clients, have each negotiate for leadership and then wait a random number of seconds before letting another leader election occur."</span>);</div><div class="line">    System.out.println(</div><div class="line">        <span class="string">"Notice that leader election is fair: all clients will become leader and will do so the same number of times."</span>);</div><div class="line"></div><div class="line">    List&lt;CuratorFramework&gt; clients = Lists.newArrayList();</div><div class="line">    List&lt;ExampleClient&gt; examples = Lists.newArrayList();</div><div class="line">    TestingServer server = <span class="keyword">new</span> TestingServer();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CLIENT_QTY; ++i) &#123;</div><div class="line">        CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(),</div><div class="line">            <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</div><div class="line">        clients.add(client);</div><div class="line"></div><div class="line">        ExampleClient example = <span class="keyword">new</span> ExampleClient(client, PATH, <span class="string">"Client #"</span> + i);</div><div class="line">        examples.add(example);</div><div class="line"></div><div class="line">        client.start();</div><div class="line">        example.start();</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      System.out.println(<span class="string">"Press enter/return to quit\n"</span>);</div><div class="line">      <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in)).readLine();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      System.out.println(<span class="string">"Shutting down..."</span>);</div><div class="line"></div><div class="line">      <span class="keyword">for</span> (ExampleClient exampleClient : examples) &#123;</div><div class="line">        CloseableUtils.closeQuietly(exampleClient);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">for</span> (CuratorFramework client : clients) &#123;</div><div class="line">        CloseableUtils.closeQuietly(client);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      CloseableUtils.closeQuietly(server);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸LeaderLatchç›¸æ¯”ï¼Œ é€šè¿‡<code>LeaderSelectorListener</code>å¯ä»¥å¯¹é¢†å¯¼æƒè¿›è¡Œæ§åˆ¶ï¼Œ åœ¨é€‚å½“çš„æ—¶å€™é‡Šæ”¾é¢†å¯¼æƒï¼Œè¿™æ ·æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å¯èƒ½è·å¾—é¢†å¯¼æƒã€‚ è€ŒLeaderLatché™¤éè°ƒç”¨closeæ–¹æ³•ï¼Œå¦åˆ™å®ƒä¸ä¼šé‡Šæ”¾é¢†å¯¼æƒã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[java mock]]></title>
      <url>http://zsr.github.io/2016/08/26/java-mock/</url>
      <content type="html"><![CDATA[<h3 id="Mock-æµ‹è¯•"><a href="#Mock-æµ‹è¯•" class="headerlink" title="Mock æµ‹è¯•"></a>Mock æµ‹è¯•</h3><p>Mock æœ€å¤§çš„åŠŸèƒ½æ˜¯å¸®ä½ æŠŠå•å…ƒæµ‹è¯•çš„è€¦åˆåˆ†è§£å¼€ï¼Œå¦‚æœä½ çš„ä»£ç å¯¹å¦ä¸€ä¸ªç±»æˆ–è€…æ¥å£æœ‰ä¾èµ–ï¼Œå®ƒèƒ½å¤Ÿå¸®ä½ æ¨¡æ‹Ÿè¿™äº›ä¾èµ–ï¼Œå¹¶å¸®ä½ éªŒè¯æ‰€è°ƒç”¨çš„ä¾èµ–çš„è¡Œä¸ºã€‚</p>
<p>æ¯”å¦‚ä¸€æ®µä»£ç æœ‰è¿™æ ·çš„ä¾èµ–ï¼š</p>
<p><img src="http://media.techtarget.com/tss/static/articles/content/JMockTestDrivenDev/images/image004.jpg" alt="img"></p>
<p>å½“æˆ‘ä»¬éœ€è¦æµ‹è¯•Aç±»çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ Mockï¼Œåˆ™æˆ‘ä»¬éœ€è¦æŠŠæ•´ä¸ªä¾èµ–æ ‘éƒ½æ„å»ºå‡ºæ¥ï¼Œè€Œä½¿ç”¨ Mock çš„è¯å°±å¯ä»¥å°†ç»“æ„åˆ†è§£å¼€ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š</p>
<p><img src="http://media.techtarget.com/tss/static/articles/content/JMockTestDrivenDev/images/image010.jpg" alt="img"></p>
<p>mockå¯¹è±¡å°±æ˜¯åœ¨è°ƒè¯•æœŸé—´ç”¨æ¥ä½œä¸ºçœŸå®å¯¹è±¡çš„æ›¿ä»£å“ã€‚</p>
<p>mockæµ‹è¯•å°±æ˜¯åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå¯¹é‚£äº›ä¸å®¹æ˜“æ„å»ºçš„å¯¹è±¡ç”¨ä¸€ä¸ªè™šæ‹Ÿå¯¹è±¡æ¥ä»£æ›¿æµ‹è¯•çš„æ–¹æ³•å°±å«mockæµ‹è¯•ã€‚</p>
<h3 id="Mock-å¯¹è±¡ä½¿ç”¨èŒƒç•´"><a href="#Mock-å¯¹è±¡ä½¿ç”¨èŒƒç•´" class="headerlink" title="Mock å¯¹è±¡ä½¿ç”¨èŒƒç•´"></a>Mock å¯¹è±¡ä½¿ç”¨èŒƒç•´</h3><ul>
<li>çœŸå®å¯¹è±¡å…·æœ‰ä¸å¯ç¡®å®šçš„è¡Œä¸ºï¼Œäº§ç”Ÿä¸å¯é¢„æµ‹çš„æ•ˆæœï¼Œï¼ˆå¦‚ï¼šè‚¡ç¥¨è¡Œæƒ…ï¼Œå¤©æ°”é¢„æŠ¥ï¼‰ </li>
<li>çœŸå®å¯¹è±¡å¾ˆéš¾è¢«åˆ›å»ºçš„ </li>
<li>çœŸå®å¯¹è±¡çš„æŸäº›è¡Œä¸ºå¾ˆéš¾è¢«è§¦å‘ </li>
<li>çœŸå®å¯¹è±¡å®é™…ä¸Šè¿˜ä¸å­˜åœ¨çš„ï¼ˆå’Œå…¶ä»–å¼€å‘å°ç»„æˆ–è€…å’Œæ–°çš„ç¡¬ä»¶æ‰“äº¤é“ï¼‰ç­‰ç­‰</li>
</ul>
<a id="more"></a>
<h3 id="Mockito-ä½¿ç”¨"><a href="#Mockito-ä½¿ç”¨" class="headerlink" title="Mockito ä½¿ç”¨"></a>Mockito ä½¿ç”¨</h3><h4 id="å£°æ˜-mockito-ä¾èµ–"><a href="#å£°æ˜-mockito-ä¾èµ–" class="headerlink" title="å£°æ˜ mockito ä¾èµ–"></a>å£°æ˜ mockito ä¾èµ–</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.mockito&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;mockito-core&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;2.0.111-beta&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><h4 id="1-éªŒè¯è¡Œä¸º"><a href="#1-éªŒè¯è¡Œä¸º" class="headerlink" title="1. éªŒè¯è¡Œä¸º"></a>1. éªŒè¯è¡Œä¸º</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Let's import Mockito statically so that the code looks clearer</span></div><div class="line"> <span class="keyword">import</span> <span class="keyword">static</span> org.mockito.Mockito.*;</div><div class="line"></div><div class="line"> <span class="comment">//mock creation</span></div><div class="line"> List mockedList = mock(List.class);</div><div class="line"></div><div class="line"> <span class="comment">//using mock object</span></div><div class="line"> mockedList.add(<span class="string">"one"</span>);</div><div class="line"> mockedList.clear();</div><div class="line"></div><div class="line"> <span class="comment">//verification</span></div><div class="line"> verify(mockedList).add(<span class="string">"one"</span>);</div><div class="line"> verify(mockedList).clear();</div></pre></td></tr></table></figure>
<p>ä¸€æ—¦åˆ›å»º mock å°†ä¼šè®°å¾—æ‰€æœ‰çš„äº¤äº’ã€‚ä½ å¯ä»¥é€‰æ‹©éªŒè¯ä½ æ„Ÿå…´è¶£çš„ä»»ä½•äº¤äº’</p>
<h4 id="2-stubbing"><a href="#2-stubbing" class="headerlink" title="2. stubbing"></a>2. stubbing</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//You can mock concrete classes, not just interfaces</span></div><div class="line">LinkedList mockedList = mock(LinkedList.class);</div><div class="line"></div><div class="line"><span class="comment">//stubbing</span></div><div class="line">when(mockedList.get(<span class="number">0</span>)).thenReturn(<span class="string">"first"</span>);</div><div class="line">when(mockedList.get(<span class="number">1</span>)).thenThrow(<span class="keyword">new</span> RuntimeException());</div><div class="line"></div><div class="line"><span class="comment">//following prints "first"</span></div><div class="line">System.out.println(mockedList.get(<span class="number">0</span>));</div><div class="line"></div><div class="line"><span class="comment">//following throws runtime exception</span></div><div class="line">System.out.println(mockedList.get(<span class="number">1</span>));</div><div class="line"></div><div class="line"><span class="comment">//following prints "null" because get(999) was not stubbed</span></div><div class="line">System.out.println(mockedList.get(<span class="number">999</span>));</div><div class="line"></div><div class="line"><span class="comment">//Although it is possible to verify a stubbed invocation, usually it's just redundant</span></div><div class="line"><span class="comment">//If your code cares what get(0) returns, then something else breaks (often even before verify() gets executed).</span></div><div class="line"><span class="comment">//If your code doesn't care what get(0) returns, then it should not be stubbed. Not convinced? See here.</span></div><div class="line">verify(mockedList).get(<span class="number">0</span>);</div></pre></td></tr></table></figure>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½ä¼šè¿”å›å€¼ï¼Œä¸€ä¸ª mock å°†è¿”å›è¦ä¹ˆ nullï¼Œä¸€ä¸ªåŸå§‹/åŸºæœ¬ç±»å‹çš„åŒ…è£…å€¼æˆ–é€‚å½“çš„ç©ºé›†ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ª int/Integer å°±æ˜¯ 0ï¼Œè€Œå¯¹äº boolean/Boolean å°±æ˜¯ falseã€‚</li>
<li>Stubbing å¯ä»¥è¢«è¦†ç›–ã€‚</li>
<li>ä¸€æ—¦ stubï¼Œè¯¥æ–¹æ³•å°†å§‹ç»ˆè¿”å›ä¸€ä¸ª stub çš„å€¼ï¼Œæ— è®ºå®ƒæœ‰å¤šå°‘æ¬¡è¢«è°ƒç”¨ã€‚</li>
<li>æœ€åçš„ stubbing æ˜¯å¾ˆé‡è¦çš„ - å½“ä½ ä½¿ç”¨ç›¸åŒçš„å‚æ•° stub å¤šæ¬¡åŒæ ·çš„æ–¹æ³•ã€‚æ¢å¥è¯è¯´ï¼šstubbing çš„é¡ºåºæ˜¯é‡è¦çš„ï¼Œä½†å®ƒå”¯ä¸€æœ‰æ„ä¹‰çš„å´å¾ˆå°‘ï¼Œä¾‹å¦‚å½“ stubbing å®Œå…¨ç›¸åŒçš„æ–¹æ³•è°ƒç”¨ï¼Œæˆ–è€…æœ‰æ—¶å½“å‚æ•°åŒ¹é…å™¨çš„ä½¿ç”¨ï¼Œç­‰ç­‰ã€‚</li>
</ul>
<h4 id="3-å‚æ•°åŒ¹é…å™¨"><a href="#3-å‚æ•°åŒ¹é…å™¨" class="headerlink" title="3. å‚æ•°åŒ¹é…å™¨"></a>3. å‚æ•°åŒ¹é…å™¨</h4><p>Mockito éªŒè¯å‚æ•°å€¼ä½¿ç”¨ Java æ–¹å¼ï¼šé€šè¿‡ä½¿ç”¨ equals() æ–¹æ³•ã€‚æœ‰æ—¶ï¼Œå½“éœ€è¦é¢å¤–çš„çµæ´»æ€§ï¼Œå¯ä»¥ä½¿ç”¨å‚æ•°åŒ¹é…å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//stubbing using built-in anyInt() argument matcher</span></div><div class="line">when(mockedList.get(anyInt())).thenReturn(<span class="string">"element"</span>);</div><div class="line"></div><div class="line"><span class="comment">//stubbing using custom matcher (let's say isValid() returns your own matcher implementation):</span></div><div class="line">when(mockedList.contains(argThat(isValid()))).thenReturn(<span class="string">"element"</span>);</div><div class="line"></div><div class="line"><span class="comment">//following prints "element"</span></div><div class="line">System.out.println(mockedList.get(<span class="number">999</span>));</div><div class="line"></div><div class="line"><span class="comment">//you can also verify using an argument matcher</span></div><div class="line">verify(mockedList).get(anyInt());</div></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºéªŒè¯ï¼Œä½†åŒæ ·é€‚ç”¨äº stubbingï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">verify(mock).someMethod(anyInt(), anyString(), eq(<span class="string">"third argument"</span>));</div><div class="line"><span class="comment">//above is correct - eq() is also an argument matcher</span></div><div class="line"></div><div class="line">verify(mock).someMethod(anyInt(), anyString(), <span class="string">"third argument"</span>);</div><div class="line"><span class="comment">//above is incorrect - exception will be thrown because third argument is given without an argument matcher.</span></div></pre></td></tr></table></figure>
<h4 id="4-è°ƒç”¨é¢å¤–çš„è°ƒç”¨æ•°å­—-at-least-never"><a href="#4-è°ƒç”¨é¢å¤–çš„è°ƒç”¨æ•°å­—-at-least-never" class="headerlink" title="4. è°ƒç”¨é¢å¤–çš„è°ƒç”¨æ•°å­—/at least / never"></a>4. è°ƒç”¨é¢å¤–çš„è°ƒç”¨æ•°å­—/at least / never</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//using mock</span></div><div class="line">mockedList.add(<span class="string">"once"</span>);</div><div class="line"></div><div class="line">mockedList.add(<span class="string">"twice"</span>);</div><div class="line">mockedList.add(<span class="string">"twice"</span>);</div><div class="line"></div><div class="line">mockedList.add(<span class="string">"three times"</span>);</div><div class="line">mockedList.add(<span class="string">"three times"</span>);</div><div class="line">mockedList.add(<span class="string">"three times"</span>);</div><div class="line"></div><div class="line"><span class="comment">//following two verifications work exactly the same - times(1) is used by default</span></div><div class="line">verify(mockedList).add(<span class="string">"once"</span>);</div><div class="line">verify(mockedList, times(<span class="number">1</span>)).add(<span class="string">"once"</span>);</div><div class="line"></div><div class="line"><span class="comment">//exact number of invocations verification</span></div><div class="line">verify(mockedList, times(<span class="number">2</span>)).add(<span class="string">"twice"</span>);</div><div class="line">verify(mockedList, times(<span class="number">3</span>)).add(<span class="string">"three times"</span>);</div><div class="line"></div><div class="line"><span class="comment">//verification using never(). never() is an alias to times(0)</span></div><div class="line">verify(mockedList, never()).add(<span class="string">"never happened"</span>);</div><div class="line"></div><div class="line"><span class="comment">//verification using atLeast()/atMost()</span></div><div class="line">verify(mockedList, atLeastOnce()).add(<span class="string">"three times"</span>);</div><div class="line">verify(mockedList, atLeast(<span class="number">2</span>)).add(<span class="string">"five times"</span>);</div><div class="line">verify(mockedList, atMost(<span class="number">5</span>)).add(<span class="string">"three times"</span>);</div></pre></td></tr></table></figure>
<p>times(1) æ˜¯é»˜è®¤çš„ï¼Œå› æ­¤ï¼Œä½¿ç”¨çš„ times(1) å¯ä»¥æ˜¾ç¤ºçš„çœç•¥ã€‚</p>
<h4 id="5-Stubbing-void-æ–¹æ³•å¤„ç†å¼‚å¸¸"><a href="#5-Stubbing-void-æ–¹æ³•å¤„ç†å¼‚å¸¸" class="headerlink" title="5. Stubbing void æ–¹æ³•å¤„ç†å¼‚å¸¸"></a>5. Stubbing void æ–¹æ³•å¤„ç†å¼‚å¸¸</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">doThrow(<span class="keyword">new</span> RuntimeException()).when(mockedList).clear();</div><div class="line"></div><div class="line"><span class="comment">//following throws RuntimeException:</span></div><div class="line">mockedList.clear();</div></pre></td></tr></table></figure>
<h4 id="6-æœ‰åºçš„éªŒè¯"><a href="#6-æœ‰åºçš„éªŒè¯" class="headerlink" title="6. æœ‰åºçš„éªŒè¯"></a>6. æœ‰åºçš„éªŒè¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// A. Single mock whose methods must be invoked in a particular order</span></div><div class="line">List singleMock = mock(List.class);</div><div class="line"></div><div class="line"><span class="comment">//using a single mock</span></div><div class="line">singleMock.add(<span class="string">"was added first"</span>);</div><div class="line">singleMock.add(<span class="string">"was added second"</span>);</div><div class="line"></div><div class="line"><span class="comment">//create an inOrder verifier for a single mock</span></div><div class="line">InOrder inOrder = inOrder(singleMock);</div><div class="line"></div><div class="line"><span class="comment">//following will make sure that add is first called with "was added first, then with "was added second"</span></div><div class="line">inOrder.verify(singleMock).add(<span class="string">"was added first"</span>);</div><div class="line">inOrder.verify(singleMock).add(<span class="string">"was added second"</span>);</div><div class="line"></div><div class="line"><span class="comment">// B. Multiple mocks that must be used in a particular order</span></div><div class="line">List firstMock = mock(List.class);</div><div class="line">List secondMock = mock(List.class);</div><div class="line"></div><div class="line"><span class="comment">//using mocks</span></div><div class="line">firstMock.add(<span class="string">"was called first"</span>);</div><div class="line">secondMock.add(<span class="string">"was called second"</span>);</div><div class="line"></div><div class="line"><span class="comment">//create inOrder object passing any mocks that need to be verified in order</span></div><div class="line">InOrder inOrder = inOrder(firstMock, secondMock);</div><div class="line"></div><div class="line"><span class="comment">//following will make sure that firstMock was called before secondMock</span></div><div class="line">inOrder.verify(firstMock).add(<span class="string">"was called first"</span>);</div><div class="line">inOrder.verify(secondMock).add(<span class="string">"was called second"</span>);</div><div class="line"></div><div class="line"><span class="comment">// Oh, and A + B can be mixed together at will</span></div></pre></td></tr></table></figure>
<p>æœ‰åºéªŒè¯æ˜¯ä¸ºäº†çµæ´» - ä¸å¿…ä¸€ä¸ªæ¥ä¸€ä¸ªéªŒè¯æ‰€æœ‰çš„äº¤äº’ã€‚</p>
<p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡åˆ›å»º InOrder å¯¹è±¡ä¼ é€’åªä¸æœ‰åºéªŒè¯ç›¸å…³çš„ mock ã€‚</p>
<h4 id="7-ç¡®ä¿-mock-ä¸Šä¸ä¼šå‘ç”Ÿäº¤äº’"><a href="#7-ç¡®ä¿-mock-ä¸Šä¸ä¼šå‘ç”Ÿäº¤äº’" class="headerlink" title="7. ç¡®ä¿ mock ä¸Šä¸ä¼šå‘ç”Ÿäº¤äº’"></a>7. ç¡®ä¿ mock ä¸Šä¸ä¼šå‘ç”Ÿäº¤äº’</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//using mocks - only mockOne is interacted</span></div><div class="line">mockOne.add(<span class="string">"one"</span>);</div><div class="line"></div><div class="line"><span class="comment">//ordinary verification</span></div><div class="line">verify(mockOne).add(<span class="string">"one"</span>);</div><div class="line"></div><div class="line"><span class="comment">//verify that method was never called on a mock</span></div><div class="line">verify(mockOne, never()).add(<span class="string">"two"</span>);</div><div class="line"></div><div class="line"><span class="comment">//verify that other mocks were not interacted</span></div><div class="line">verifyZeroInteractions(mockTwo, mockThree);</div></pre></td></tr></table></figure>
<h4 id="8-å¯»æ‰¾å¤šä½™çš„è°ƒç”¨"><a href="#8-å¯»æ‰¾å¤šä½™çš„è°ƒç”¨" class="headerlink" title="8. å¯»æ‰¾å¤šä½™çš„è°ƒç”¨"></a>8. å¯»æ‰¾å¤šä½™çš„è°ƒç”¨</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//using mocks</span></div><div class="line">mockedList.add(<span class="string">"one"</span>);</div><div class="line">mockedList.add(<span class="string">"two"</span>);</div><div class="line"></div><div class="line">verify(mockedList).add(<span class="string">"one"</span>);</div><div class="line"></div><div class="line"><span class="comment">//following verification will fail</span></div><div class="line">verifyNoMoreInteractions(mockedList);</div></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šä¸å»ºè®® verifyNoMoreInteractions() åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•ä¸­ä½¿ç”¨ã€‚ verifyNoMoreInteractions() æ˜¯ä»äº¤äº’æµ‹è¯•å·¥å…·åŒ…ä¸€ä¸ªæ–¹ä¾¿çš„æ–­è¨€ã€‚åªæœ‰ä¸å®ƒçš„ç›¸å…³æ—¶æ‰ä½¿ç”¨å®ƒã€‚æ»¥ç”¨å®ƒå¯¼è‡´éš¾ä»¥ç»´æŠ¤ã€‚</p>
<h4 id="9-æ ‡å‡†åˆ›å»º-mock-æ–¹å¼-ä½¿ç”¨-Mock-æ³¨è§£"><a href="#9-æ ‡å‡†åˆ›å»º-mock-æ–¹å¼-ä½¿ç”¨-Mock-æ³¨è§£" class="headerlink" title="9. æ ‡å‡†åˆ›å»º mock æ–¹å¼ - ä½¿ç”¨ @Mock æ³¨è§£"></a>9. æ ‡å‡†åˆ›å»º mock æ–¹å¼ - ä½¿ç”¨ <code>@Mock</code> æ³¨è§£</h4><ul>
<li>æœ€å°åŒ–å¯é‡ç”¨ mock åˆ›å»ºä»£ç </li>
<li>ä½¿æµ‹è¯•ç±»æ›´åŠ å¯è¯»æ€§</li>
<li>ä½¿éªŒè¯é”™è¯¯æ›´åŠ æ˜“è¯»ï¼Œå› ä¸ºå­—æ®µåç§°ç”¨äºå”¯ä¸€è¯†åˆ« mock</li>
</ul>
<p>public class ArticleManagerTest {</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Mock</span> <span class="keyword">private</span> ArticleCalculator calculator;</div><div class="line"><span class="meta">@Mock</span> <span class="keyword">private</span> ArticleDatabase database;</div><div class="line"><span class="meta">@Mock</span> <span class="keyword">private</span> UserProvider userProvider;</div><div class="line"></div><div class="line"><span class="keyword">private</span> ArticleManager manager;</div></pre></td></tr></table></figure>
<p>åœ¨åŸºç¡€ç±»æˆ–è€…æµ‹è¯• runner é‡Œé¢ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MockitoAnnotations.initMocks(testClass);</div></pre></td></tr></table></figure>
<p>å¯ä»¥ä½¿ç”¨å†…å»º runner: <a href="http://site.mockito.org/mockito/docs/current/org/mockito/runners/MockitoJUnitRunner.html" target="_blank" rel="external">MockitoJUnitRunner</a> æˆ–è€… rule: <a href="http://site.mockito.org/mockito/docs/current/org/mockito/junit/MockitoRule.html" target="_blank" rel="external">MockitoRule</a></p>
<p>æ›´å¤šè¯¦è§ <a href="http://site.mockito.org/mockito/docs/current/org/mockito/MockitoAnnotations.html" target="_blank" rel="external">MockitoAnnotations</a></p>
<h4 id="10-Stubbing-è¿ç»­è°ƒç”¨ï¼ˆè¿­ä»£å™¨å¼çš„-stubbingï¼‰"><a href="#10-Stubbing-è¿ç»­è°ƒç”¨ï¼ˆè¿­ä»£å™¨å¼çš„-stubbingï¼‰" class="headerlink" title="10. Stubbing è¿ç»­è°ƒç”¨ï¼ˆè¿­ä»£å™¨å¼çš„ stubbingï¼‰"></a>10. Stubbing è¿ç»­è°ƒç”¨ï¼ˆè¿­ä»£å™¨å¼çš„ stubbingï¼‰</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">when(mock.someMethod(<span class="string">"some arg"</span>))</div><div class="line"> .thenThrow(<span class="keyword">new</span> RuntimeException())</div><div class="line"> .thenReturn(<span class="string">"foo"</span>);</div><div class="line"></div><div class="line"><span class="comment">//First call: throws runtime exception:</span></div><div class="line">mock.someMethod(<span class="string">"some arg"</span>);</div><div class="line"></div><div class="line"><span class="comment">//Second call: prints "foo"</span></div><div class="line">System.out.println(mock.someMethod(<span class="string">"some arg"</span>));</div><div class="line"></div><div class="line"><span class="comment">//Any consecutive call: prints "foo" as well (last stubbing wins).</span></div><div class="line">System.out.println(mock.someMethod(<span class="string">"some arg"</span>));</div></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç²¾ç®€ç‰ˆæœ¬ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">when(mock.someMethod(<span class="string">"some arg"</span>))</div><div class="line"> .thenReturn(<span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span>);</div></pre></td></tr></table></figure>
<h4 id="11-å›è°ƒ-Stubbing"><a href="#11-å›è°ƒ-Stubbing" class="headerlink" title="11. å›è°ƒ Stubbing"></a>11. å›è°ƒ Stubbing</h4><p>å…è®¸ä½¿ç”¨æ³›å‹ <a href="http://site.mockito.org/mockito/docs/current/org/mockito/stubbing/Answer.html" target="_blank" rel="external">Answer</a> æ¥å£ã€‚</p>
<p>ç„¶è€Œï¼Œè¿™æ˜¯ä¸åŒ…æ‹¬åœ¨æœ€åˆçš„ Mockito å¦ä¸€ä¸ªæœ‰äº‰è®®çš„åŠŸèƒ½ã€‚å»ºè®®åªéœ€ç”¨thenReturn() æˆ– thenThrow() æ¥ stubbing ï¼Œè¿™åœ¨æµ‹è¯•/æµ‹è¯•é©±åŠ¨ä¸­åº”ç”¨ç®€æ´ä¸ç®€å•çš„ä»£ç è¶³å¤Ÿäº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœæœ‰ä¸€ä¸ªéœ€è¦ stub åˆ°æ³›å‹ Answer æ¥å£ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">when(mock.someMethod(anyString())).thenAnswer(<span class="keyword">new</span> Answer() &#123;</div><div class="line">   <span class="function">Object <span class="title">answer</span><span class="params">(InvocationOnMock invocation)</span> </span>&#123;</div><div class="line">       Object[] args = invocation.getArguments();</div><div class="line">       Object mock = invocation.getMock();</div><div class="line">       <span class="keyword">return</span> <span class="string">"called with arguments: "</span> + args;</div><div class="line">   &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//the following prints "called with arguments: foo"</span></div><div class="line">System.out.println(mock.someMethod(<span class="string">"foo"</span>));</div></pre></td></tr></table></figure>
<h3 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹:"></a>æ¡ˆä¾‹:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SalaryService</span> </span>&#123;</div><div class="line"></div><div class="line">Â  Â  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BigDecimal minimumSalary = <span class="keyword">new</span> BigDecimal(<span class="number">20000</span>);</div><div class="line"></div><div class="line">Â  Â  <span class="meta">@Autowired</span></div><div class="line">Â  Â  <span class="keyword">private</span> EmployeeDAO employeeDAO;</div><div class="line"></div><div class="line">Â  Â  <span class="meta">@Autowired</span></div><div class="line">Â  Â  <span class="keyword">private</span> TaxCalculator taxCalculator;</div><div class="line"></div><div class="line">Â  Â  <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getNetSalary</span><span class="params">(<span class="keyword">long</span> employeeId)</span> </span>&#123;</div><div class="line">Â  Â  Â  Â  BigDecimal netSalary = <span class="keyword">null</span>;</div><div class="line">Â  Â  Â  Â  BigDecimal grossSalary = employeeDAO.getAnnualSalary(employeeId);</div><div class="line">Â  Â  Â  Â  BigDecimal taxes = taxCalculator.calculateTaxes(grossSalary);</div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (taxedSalaryIsGreaterThanMinimumSalary(grossSalary)) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  netSalary = grossSalary.subtract(taxes);</div><div class="line">Â  Â  Â  Â  &#125; <span class="keyword">else</span> &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  netSalary = grossSalary;</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line"></div><div class="line">Â  Â  Â  Â  <span class="keyword">return</span> netSalary;</div><div class="line">Â  Â  &#125;</div><div class="line"></div><div class="line">Â  Â  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">taxedSalaryIsGreaterThanMinimumSalary</span><span class="params">(BigDecimal taxedSalary)</span> </span>&#123;</div><div class="line">Â  Â  Â  Â  <span class="keyword">return</span> taxedSalary.compareTo(minimumSalary) == <span class="number">1</span>;</div><div class="line">Â  Â  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmployeeDAO</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getAnnualSalary</span><span class="params">(<span class="keyword">long</span> employeeId)</span> </span>&#123;</div><div class="line">        <span class="comment">// conncetTODB</span></div><div class="line">        <span class="comment">// run select for employeeId;</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(<span class="number">70000</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaxCalculator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">calculateTaxes</span><span class="params">(BigDecimal salary)</span> </span>&#123;</div><div class="line">        BigDecimal result = salary.multiply(<span class="keyword">new</span> BigDecimal(<span class="number">200</span>));</div><div class="line">        <span class="comment">// some other weird calculation ....</span></div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æµ‹è¯•æ¡ˆä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SalaryServiceTest</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> UserId = <span class="number">123l</span>;</div><div class="line"></div><div class="line">  <span class="meta">@InjectMocks</span></div><div class="line">  <span class="keyword">private</span> SalaryService salaryService;</div><div class="line"></div><div class="line">  <span class="meta">@Mock</span></div><div class="line">  <span class="keyword">private</span> EmployeeDAO employeeDAO;</div><div class="line"></div><div class="line">  <span class="meta">@Mock</span></div><div class="line">  <span class="keyword">private</span> TaxCalculator taxCalculator;</div><div class="line"></div><div class="line">  <span class="meta">@Before</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">      MockitoAnnotations.initMocks(<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Test</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMinimumSalary</span><span class="params">()</span> </span>&#123;</div><div class="line">      BigDecimal annualSalary = <span class="keyword">new</span> BigDecimal(<span class="number">10000</span>);</div><div class="line">      Mockito.when(employeeDAO.getAnnualSalary(UserId)).thenReturn(annualSalary);</div><div class="line">      Mockito.when(taxCalculator.calculateTaxes(annualSalary)).thenReturn(<span class="keyword">new</span> BigDecimal(<span class="number">1000</span>));</div><div class="line">      BigDecimal actual = salaryService.getNetSalary(UserId);</div><div class="line">      assertThat(actual.compareTo(<span class="keyword">new</span> BigDecimal(<span class="number">10000</span>)), is(<span class="number">0</span>));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Test</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMaximumSalary</span><span class="params">()</span> </span>&#123;</div><div class="line">      BigDecimal annualSalary = <span class="keyword">new</span> BigDecimal(<span class="number">80000</span>);</div><div class="line">      Mockito.when(employeeDAO.getAnnualSalary(UserId)).thenReturn(annualSalary);</div><div class="line">      Mockito.when(taxCalculator.calculateTaxes(annualSalary)).thenReturn(<span class="keyword">new</span> BigDecimal(<span class="number">8000</span>));</div><div class="line">      BigDecimal actual = salaryService.getNetSalary(UserId);</div><div class="line">      assertThat(actual.compareTo(<span class="keyword">new</span> BigDecimal(<span class="number">72000</span>)), is(<span class="number">0</span>));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.vogella.com/tutorials/Mockito/article.html#prerequisites" target="_blank" rel="external">Mockito</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[zookeeper å®‰è£…]]></title>
      <url>http://zsr.github.io/2016/08/24/zookeeper-%E5%AE%89%E8%A3%85/</url>
      <content type="html"><![CDATA[<h1 id="Zookeeper-å®‰è£…åŠé…ç½®ï¼ˆMacï¼‰"><a href="#Zookeeper-å®‰è£…åŠé…ç½®ï¼ˆMacï¼‰" class="headerlink" title="Zookeeper å®‰è£…åŠé…ç½®ï¼ˆMacï¼‰"></a>Zookeeper å®‰è£…åŠé…ç½®ï¼ˆMacï¼‰</h1><p>Zookeeper åˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶æ˜¯ Apache Hadoop çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œå®ƒä¸»è¦æ˜¯ç”¨æ¥è§£å†³åˆ†å¸ƒå¼åº”ç”¨ä¸­ç»å¸¸é‡åˆ°çš„ä¸€äº›æ•°æ®ç®¡ç†é—®é¢˜ï¼Œå¦‚ï¼šç»Ÿä¸€å‘½åæœåŠ¡ã€çŠ¶æ€åŒæ­¥æœåŠ¡ã€é›†ç¾¤ç®¡ç†ã€åˆ†å¸ƒå¼åº”ç”¨é…ç½®é¡¹çš„ç®¡ç†ç­‰ã€‚</p>
<h3 id="Zookeeper-çš„å®‰è£…"><a href="#Zookeeper-çš„å®‰è£…" class="headerlink" title="Zookeeper çš„å®‰è£…"></a>Zookeeper çš„å®‰è£…</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ä¸‹è½½åœ°å€ï¼šhttp://www.apache.org/dyn/closer.cgi/zookeeper</div></pre></td></tr></table></figure>
<p>é¦–å…ˆä»å®˜ç½‘ä¸‹è½½ZooKeeperå‹ç¼©åŒ…ï¼Œç„¶åè§£å‹ä¸‹è½½å¾—åˆ°çš„ZooKeeperå‹ç¼©åŒ…ï¼Œå‘ç°æœ‰â€œbinï¼Œconfï¼Œlibâ€ç­‰ç›®å½•ã€‚â€œbinç›®å½•â€ä¸­å­˜æ”¾æœ‰è¿è¡Œè„šæœ¬ï¼›â€œconfç›®å½•â€ä¸­å­˜æ”¾æœ‰é…ç½®æ–‡ä»¶ï¼›â€œlibç›®å½•â€ä¸­å­˜æ”¾æœ‰è¿è¡Œæ‰€éœ€è¦ç¬¬ä¸‰æ–¹åº“ã€‚<br>è§£å‹æ–‡ä»¶ï¼š </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar zxvf zookeeper-3.4.8.tar.gz</div></pre></td></tr></table></figure>
<h3 id="Zookeeper-çš„é…ç½®"><a href="#Zookeeper-çš„é…ç½®" class="headerlink" title="Zookeeper çš„é…ç½®"></a>Zookeeper çš„é…ç½®</h3><h4 id="ä¼ªåˆ†å¸ƒå¼éƒ¨ç½²"><a href="#ä¼ªåˆ†å¸ƒå¼éƒ¨ç½²" class="headerlink" title="ä¼ªåˆ†å¸ƒå¼éƒ¨ç½²"></a>ä¼ªåˆ†å¸ƒå¼éƒ¨ç½²</h4><ol>
<li>åœ¨â€œconfâ€ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ªåä¸ºâ€œzoo.cfgâ€çš„æ–‡ä»¶ï¼Œå‡†å¤‡éƒ¨ç½²3ä¸ªèŠ‚ç‚¹ï¼Œå…¶ä¸­å†…å®¹å¦‚ä¸‹ï¼š</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">   tickTime=2000</div><div class="line">initLimit=5</div><div class="line">syncLimit=2</div><div class="line">dataDir=/Users/nali/program/zookeeper-3.4.8_1/data</div><div class="line">dataLogDir=/Users/nali/program/zookeeper-3.4.8_1/logs </div><div class="line">clientPort=2181(ä¸åŒèŠ‚ç‚¹æ³¨æ„ä¸åŒ)</div><div class="line">server.1=127.0.0.1:2888:3888</div><div class="line">server.2=127.0.0.1:2889:3889</div><div class="line">server.3=127.0.0.1:2890:3890</div></pre></td></tr></table></figure>
<p><strong>å‚æ•°è¯´æ˜:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#tickTime: å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æˆ–è€…æœåŠ¡ç«¯å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´ç»´æŒå¿ƒè·³çš„æ—¶é—´é—´éš”ï¼Œå•ä½æ¯«ç§’ã€‚</div><div class="line"></div><div class="line">#initLimitï¼šzookeeperé›†ç¾¤ä¸­çš„åŒ…å«å¤šå°server, å…¶ä¸­ä¸€å°ä¸ºleader, é›†ç¾¤ä¸­å…¶ä½™çš„serverä¸ºfollower.</div><div class="line">initLimitå‚æ•°é…ç½®åˆå§‹åŒ–è¿æ¥æ—¶, followerå’Œleaderä¹‹é—´çš„æœ€é•¿å¿ƒè·³æ—¶é—´. æ­¤æ—¶è¯¥å‚æ•°è®¾ç½®ä¸º5, è¯´æ˜æ—¶é—´é™åˆ¶ä¸º5   å€tickTime, å³5*2000=10000ms=10s.</div><div class="line"></div><div class="line">#syncLimitï¼šè¯¥å‚æ•°é…ç½®leaderå’Œfollowerä¹‹é—´å‘é€æ¶ˆæ¯, è¯·æ±‚å’Œåº”ç­”çš„æœ€å¤§æ—¶é—´é•¿åº¦. æ­¤æ—¶è¯¥å‚æ•°è®¾ç½®ä¸º2, è¯´æ˜æ—¶é—´é™åˆ¶ä¸º2å€tickTime, å³4000ms.</div><div class="line"></div><div class="line">#dataDir: æ•°æ®æ–‡ä»¶å­˜æ”¾ç›®å½•,å¯ä»¥æ˜¯ä»»æ„ç›®å½•</div><div class="line"></div><div class="line">#dataLogDir: ç”¨æ¥é‡åšæ•°æ®çš„äº‹åŠ¡æ—¥å¿—æ–‡ä»¶å­˜æ”¾ç›®å½•.</div><div class="line"></div><div class="line">#clientPort: ç›‘å¬clientè¿æ¥çš„ç«¯å£å·.</div><div class="line"></div><div class="line">#server.1ï¼Œserver.2ï¼Œserver.3: è¡¨ç¤ºèŠ‚ç‚¹ç¼–å·ï¼Œåè¾¹ç”¨å†’å·éš”å¼€çš„ä¸‰ä¸ªæ•°å­—ï¼Œåˆ†åˆ«è¡¨ç¤ºèŠ‚ç‚¹çš„ipï¼Œäº¤æ¢æ•°æ®çš„ç«¯å£å·ï¼ŒæŸä¸ªèŠ‚ç‚¹æŒ‚æ‰ä¹‹åä¸“é—¨ç”¨æ¥é€‰ä¸¾çš„ç«¯å£å·ã€‚</div></pre></td></tr></table></figure>
<font color="red">æ³¨ï¼šinitLimitï¼ŒsyncLimitåœ¨å•èŠ‚ç‚¹éƒ¨ç½²æ¨¡å¼ä¸‹ï¼Œä¸éœ€è¦é…ç½®ã€‚</font>

<ol>
<li>åœ¨dataDirç›®å½•ä¸‹åˆ›å»ºmyidæ–‡ä»¶ï¼Œå†™å…¥è¯¥èŠ‚ç‚¹çš„ç¼–å· 1 ã€‚è¿™æ ·ä¸€ä¸ªèŠ‚ç‚¹å°±é…ç½®å®Œæˆäº†ã€‚</li>
<li>å¤åˆ¶ zookeeper-3.4.8-1 åˆ° zookeeper-3.4.8-2å’Œ zookeeper-3.4.8-3ï¼Œè¦ä¿®æ”¹çš„åœ°æ–¹æ˜¯ zoo.cfgé‡Œçš„ dataDir,dataLogDir,clientPortã€‚è¿˜æœ‰éœ€è¦åœ¨è‡ªå·±çš„dataç›®å½•ä¸‹æ–°å»ºmyidæ–‡ä»¶ï¼Œå†™å…¥è‡ªå·±çš„ç¼–å·ã€‚</li>
</ol>
<table>
<thead>
<tr>
<th>myid</th>
<th>Dataç›®å½•</th>
<th>Client</th>
<th>Server</th>
<th>Leader</th>
<th>é…ç½®æ–‡ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>/zookeeper-3.4.8_1/data</td>
<td>2181</td>
<td>2888</td>
<td>3888</td>
<td>z1.cfg</td>
</tr>
<tr>
<td>2</td>
<td>/zookeeper-3.4.8_2/data</td>
<td>2182</td>
<td>2889</td>
<td>3889</td>
<td>z2.cfg</td>
</tr>
<tr>
<td>3</td>
<td>/zookeeper-3.4.8_3/data</td>
<td>2183</td>
<td>2890</td>
<td>3890</td>
<td>z3.cfg</td>
</tr>
</tbody>
</table>
<ol>
<li>å¯åŠ¨å’Œæµ‹è¯•</li>
</ol>
<p>åˆ†åˆ«è¿›å…¥ä¸‰ä¸ªèŠ‚ç‚¹çš„binç›®å½•ï¼Œå¯åŠ¨zookeeperï¼Œè¿è¡Œ./zkServer.sh startã€‚</p>
<p>æ³¨ï¼šå‰è¾¹èŠ‚ç‚¹å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šæŠ›å‡ºä¸€äº›é”™è¯¯ï¼Œå¯å¿½ç•¥ã€‚è¿™æ˜¯å› ä¸ºå¦å¤–çš„èŠ‚ç‚¹æ²¡å¯åŠ¨ï¼Œå¯¼è‡´çš„é€šä¿¡å¼‚å¸¸ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:program nali$ <span class="built_in">cd</span> zookeeper-3.4.8_3/bin/</div><div class="line">nalideMacBook-Pro-4:bin nali$ ./zkServer.sh start</div><div class="line">ZooKeeper JMX enabled by default</div><div class="line">Using config: /Users/nali/program/zookeeper-3.4.8_3/bin/../conf/zoo.cfg</div><div class="line">Starting zookeeper ... STARTED</div></pre></td></tr></table></figure>
<p>â€‹       </p>
<p>å¯ä»¥ç”¨è‡ªå¸¦çš„åŸºäºtelnetçš„å®¢æˆ·ç«¯æµ‹è¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯å¦å¯åŠ¨æˆåŠŸã€‚éšä¾¿è¿›å…¥ä¸€ä¸ªèŠ‚ç‚¹çš„binç›®å½•ï¼Œæ¯”å¦‚èŠ‚ç‚¹0</p>
<p>./zkCli.sh -server 127.0.0.1:2180ï¼Œéšä¾¿è¾“å…¥ä¸€ä¸ªå­—ç¬¦ï¼Œä»–ä¼šè·³å‡ºhelpç•Œé¢ã€‚è¯´æ˜æœåŠ¡ç«¯å¯åŠ¨æˆåŠŸã€‚  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:bin nali$ ./zkCli.sh -server 127.0.0.1:2181</div><div class="line">Connecting to 127.0.0.1:2181</div><div class="line">2016-08-25 21:02:28,712 [myid:] - INFO  [main:Environment@100] - Client environment:zookeeper.version=3.4.8--1, built on 02/06/2016 03:18 GMT</div><div class="line">2016-08-25 21:02:28,715 [myid:] - INFO  [main:Environment@100] - Client environment:host.name=192.168.120.222</div><div class="line">2016-08-25 21:02:28,715 [myid:] - INFO  [main:Environment@100] - Client environment:java.version=1.8.0_91</div><div class="line">2016-08-25 21:02:28,717 [myid:] - INFO  [main:Environment@100] - Client environment:java.vendor=Oracle Corporation</div><div class="line">2016-08-25 21:02:28,717 [myid:] - INFO  [main:Environment@100] - Client environment:java.home=/Library/Java/JavaVirtualMachines/jdk1.8.0_91.jdk/Contents/Home/jre</div><div class="line">2016-08-25 21:02:28,717 [myid:] - INFO  [main:Environment@100] - Client environment:java.class.path=/Users/nali/program/zookeeper-3.4.8_1/bin/../build/classes:/Users/nali/program/zookeeper-3.4.8_1/bin/../build/lib/*.jar:/Users/nali/program/zookeeper-3.4.8_1/bin/../lib/slf4j-log4j12-1.6.1.jar:/Users/nali/program/zookeeper-3.4.8_1/bin/../lib/slf4j-api-1.6.1.jar:/Users/nali/program/zookeeper-3.4.8_1/bin/../lib/netty-3.7.0.Final.jar:/Users/nali/program/zookeeper-3.4.8_1/bin/../lib/<span class="built_in">log</span>4j-1.2.16.jar:/Users/nali/program/zookeeper-3.4.8_1/bin/../lib/jline-0.9.94.jar:/Users/nali/program/zookeeper-3.4.8_1/bin/../zookeeper-3.4.8.jar:/Users/nali/program/zookeeper-3.4.8_1/bin/../src/java/lib/*.jar:/Users/nali/program/zookeeper-3.4.8_1/bin/../conf:</div><div class="line">2016-08-25 21:02:28,718 [myid:] - INFO  [main:Environment@100] - Client environment:java.library.path=/Users/nali/Library/Java/Extensions:/Library/Java/Extensions:/Network/Library/Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java:.</div><div class="line">2016-08-25 21:02:28,718 [myid:] - INFO  [main:Environment@100] - Client environment:java.io.tmpdir=/var/folders/jr/rgnrtr4n13n3d6tbwsch9_qr0000gn/T/</div><div class="line">2016-08-25 21:02:28,718 [myid:] - INFO  [main:Environment@100] - Client environment:java.compiler=&lt;NA&gt;</div><div class="line">2016-08-25 21:02:28,718 [myid:] - INFO  [main:Environment@100] - Client environment:os.name=Mac OS X</div><div class="line">2016-08-25 21:02:28,719 [myid:] - INFO  [main:Environment@100] - Client environment:os.arch=x86_64</div><div class="line">2016-08-25 21:02:28,719 [myid:] - INFO  [main:Environment@100] - Client environment:os.version=10.11.4</div><div class="line">2016-08-25 21:02:28,719 [myid:] - INFO  [main:Environment@100] - Client environment:user.name=nali</div><div class="line">2016-08-25 21:02:28,719 [myid:] - INFO  [main:Environment@100] - Client environment:user.home=/Users/nali</div><div class="line">2016-08-25 21:02:28,719 [myid:] - INFO  [main:Environment@100] - Client environment:user.dir=/Users/nali/program/zookeeper-3.4.8_1/bin</div><div class="line">2016-08-25 21:02:28,721 [myid:] - INFO  [main:ZooKeeper@438] - Initiating client connection, connectString=127.0.0.1:2181 sessionTimeout=30000 watcher=org.apache.zookeeper.ZooKeeperMain<span class="variable">$MyWatcher</span>@531d72ca</div><div class="line">Welcome to ZooKeeper!</div></pre></td></tr></table></figure>
<ol>
<li>Zookeeperå¸¸ç”¨å‘½ä»¤<ul>
<li>ZooKeeperæœåŠ¡ç«¯å‘½ä»¤:<ul>
<li>å¯åŠ¨ZKæœåŠ¡:  bin/zkServer.sh start</li>
<li>æŸ¥çœ‹ZKæœåŠ¡çŠ¶æ€: bin/zkServer.sh status</li>
<li>åœæ­¢ZKæœåŠ¡:  bin/zkServer.sh stop</li>
<li>é‡å¯ZKæœåŠ¡:  bin/zkServer.sh restart</li>
</ul>
</li>
<li>zkå®¢æˆ·ç«¯å‘½ä»¤<ul>
<li>æ˜¾ç¤ºæ ¹ç›®å½•ä¸‹ã€æ–‡ä»¶ï¼š ls / ä½¿ç”¨ ls å‘½ä»¤æ¥æŸ¥çœ‹å½“å‰ ZooKeeper ä¸­æ‰€åŒ…å«çš„å†…å®¹</li>
<li>æ˜¾ç¤ºæ ¹ç›®å½•ä¸‹ã€æ–‡ä»¶ï¼š ls2 / æŸ¥çœ‹å½“å‰èŠ‚ç‚¹æ•°æ®å¹¶èƒ½çœ‹åˆ°æ›´æ–°æ¬¡æ•°ç­‰æ•°æ®</li>
<li>åˆ›å»ºæ–‡ä»¶ï¼Œå¹¶è®¾ç½®åˆå§‹å†…å®¹ï¼š create /zk â€œtestâ€ åˆ›å»ºä¸€ä¸ªæ–°çš„ znodeèŠ‚ç‚¹â€œ zk â€ä»¥åŠä¸å®ƒå…³è”çš„å­—ç¬¦</li>
<li>è·å–æ–‡ä»¶å†…å®¹ï¼š get /zk ç¡®è®¤ znode æ˜¯å¦åŒ…å«æˆ‘ä»¬æ‰€åˆ›å»ºçš„å­—ç¬¦ä¸²</li>
<li>ä¿®æ”¹æ–‡ä»¶å†…å®¹ï¼š set /zk â€œzkbakâ€ å¯¹ zk æ‰€å…³è”çš„å­—ç¬¦ä¸²è¿›è¡Œè®¾ç½®</li>
<li>åˆ é™¤æ–‡ä»¶ï¼š delete /zk å°†åˆšæ‰åˆ›å»ºçš„ znode åˆ é™¤</li>
<li>é€€å‡ºå®¢æˆ·ç«¯ï¼š quit</li>
<li>å¸®åŠ©å‘½ä»¤ï¼š help</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>zookeeperä»…ä»…æ˜¯ç»´æŠ¤äº†ä¸€ä¸ªåˆ†å¸ƒå¼çš„æ ‘å½¢ç›®å½•ã€‚å¦‚ä¸‹å›¾ã€‚å®ƒé€šè¿‡<a href="http://baike.baidu.com/view/8438269.htm" target="_blank" rel="external">fast paxosç®—æ³•</a>ä¿è¯å¤šä¸ªèŠ‚ç‚¹ä¸Šznodeçš„æ•°æ®ä¸€è‡´æ€§ã€‚ä¸€å¥—zookeeperå¯ä»¥åŒæ—¶ç»™å¤šä¸ªåº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œåªéœ€è¦éš”ç¦»å¥½å„è‡ªçš„path~ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¤šä¸ªç¨‹åºï¼Œæ¯”å¦‚hadoopï¼Œhbaseï¼Œstromå…±ç”¨ä¸€å¥—zookeeperä¹Ÿæ˜¯å¸¸äº‹ã€‚ç»“æ„å¦‚ä¸‹å›¾ã€‚</p>
<p><img src="http://dl2.iteye.com/upload/attachment/0099/3476/b395cbf0-55aa-387e-af65-b5bcd9fcf234.jpg" alt="img"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Guava cache]]></title>
      <url>http://zsr.github.io/2016/08/24/Guava-cache/</url>
      <content type="html"><![CDATA[<h1 id="Guava-Cache"><a href="#Guava-Cache" class="headerlink" title="Guava Cache"></a>Guava Cache</h1><p>Guava cacheæ˜¯ä¸€ä¸ªåº”ç”¨å†…ç¼“å­˜(ä¸€èˆ¬ä½œä¸ºåº”ç”¨çš„æœ¬åœ°ç¼“å­˜ï¼Œredisä½œä¸ºé›†ä¸­å¼åˆ†å¸ƒå¼ç¼“å­˜)ã€‚</p>
<p>ä¸€ä¸ªç¼“å­˜éœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼š</p>
<ul>
<li>ç¼“å­˜è¯»å–å¤±è´¥å¦‚ä½•åŠ è½½æ•°æ®</li>
<li>åŠ è½½ç­–ç•¥ï¼ˆåŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼‰</li>
<li>ç¼“å­˜è¿‡æœŸé—®é¢˜</li>
<li>ç»Ÿè®¡ç¼“å­˜å‘½ä¸­æƒ…å†µ</li>
<li>ç¼“å­˜æ•°æ®å¤±æ•ˆæ—¶è®¾ç½®ç›‘å¬</li>
<li>ç¼“å­˜æ»¡æ—¶æ›¿æ¢ç­–ç•¥ï¼ˆLRUã€FIFOï¼‰</li>
<li>â€¦â€¦</li>
</ul>
<h3 id="Guavaç®€å•çš„ç¤ºä¾‹ï¼š"><a href="#Guavaç®€å•çš„ç¤ºä¾‹ï¼š" class="headerlink" title="Guavaç®€å•çš„ç¤ºä¾‹ï¼š"></a>Guavaç®€å•çš„ç¤ºä¾‹ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</div><div class="line">    CacheLoader&lt;String, String&gt; loader = <span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            System.out.println(<span class="string">"call.."</span>);</div><div class="line">            <span class="keyword">return</span> key.toUpperCase();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">//fluenté£æ ¼...</span></div><div class="line">    LoadingCache&lt;String, String&gt; cache = CacheBuilder.newBuilder().build(loader);</div><div class="line">    System.out.println(cache.size());</div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"aaa"</span>));</div><div class="line">    System.out.println(cache.size());</div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"aaa"</span>));</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        System.out.println(cache.get(<span class="string">"cjp"</span>));</div><div class="line">    &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">        <span class="comment">// TODO Auto-generated catch block</span></div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯¥ç¤ºä¾‹ä¸­ï¼Œä»…ä»…å°†ä¸€ä¸ªç±»å‹æ˜¯å­—ç¬¦ä¸²ä½œä¸ºkeyï¼Œvalueä¸ºå®ƒçš„å¤§å†™å½¢å¼ã€‚è¿è¡Œçš„ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">0</div><div class="line">call..</div><div class="line">AAA</div><div class="line">1</div><div class="line">AAA</div><div class="line">call..</div><div class="line">CJP</div></pre></td></tr></table></figure>
<p>Guavaçš„ç¼“å­˜æ˜¯ä¸€ä¸ªLoadingCacheå®ä¾‹ï¼Œé€šè¿‡CacheBuilderåˆ›å»ºè¯¥å®ä¾‹ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªCacheLoaderï¼ŒCacheLoaderå®ä¾‹æ³¨æ˜äº†åœ¨ç¼“å­˜è¯»å–å¤±è´¥æ—¶å¦‚ä½•åŠ è½½æ•°æ®ï¼Œå¼€å§‹æ—¶ï¼Œç¼“å­˜ä¸­æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œsizeä¸º0ï¼Œå½“å–aaaçš„æ—¶å€™ï¼Œè§¦å‘äº†ç¼“å­˜åŠ è½½æ•°æ®ï¼Œè¾“å‡ºcallâ€¦ï¼Œè™½ç„¶ç¼“å­˜çš„sizeå˜æˆäº†1ã€‚ç„¶åå†å–aaaæ—¶ï¼Œå› ä¸ºç¼“å­˜ä¸­å·²ç»æœ‰äº†è¯¥keyå¯¹åº”çš„valueï¼Œå°±æ²¡æœ‰è§¦å‘åŠ è½½ã€‚</p>
<p>éœ€è¦æ³¨æ„ä¸€ä¸‹getUncheckedæ–¹æ³•å’Œgetæ–¹æ³•çš„ä¸åŒï¼Œå‰è€…ä¸å¯¹å¯èƒ½çš„å¼‚å¸¸åšæ£€æŸ¥ï¼Œè°ƒç”¨ä»£ç ä¸éœ€è¦æ˜¾å¼çš„æ•æ‰å¼‚å¸¸ï¼Œè€Œåè€…è°ƒç”¨ä»£ç éœ€è¦æ˜¾å¼çš„æ•è·å¼‚å¸¸ã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ç¤ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ°ä½¿ç”¨guavaå®ç°ä¸€ä¸ªç¼“å­˜éå¸¸ç®€å•ï¼Œå¦‚æœå°†åˆ›å»ºCacheLoaderå®ä¾‹å’Œbuild LoadingCacheçš„ä¸¤è¡Œä»£ç åˆå¹¶ï¼Œä½¿ç”¨ä»…ä¸€è¡Œä»£ç å°±å¯ä»¥å®ç°ä¸€ä¸ªç¼“å­˜ï¼Œå¹¶ä¸”Guavaçš„ç¼“å­˜æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥æ”¾å¿ƒçš„åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</p>
<h3 id="å¤æ‚ä¸€ç‚¹çš„ä¾‹å­"><a href="#å¤æ‚ä¸€ç‚¹çš„ä¾‹å­" class="headerlink" title="å¤æ‚ä¸€ç‚¹çš„ä¾‹å­:"></a>å¤æ‚ä¸€ç‚¹çš„ä¾‹å­:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="comment">//ç¼“å­˜åŒæ­¥åˆ é™¤</span></div><div class="line">    LoadingCache&lt;String, String&gt; cache = CacheBuilder.newBuilder().expireAfterWrite(<span class="number">5</span>, TimeUnit.SECONDS).maximumSize(<span class="number">3</span>).recordStats().removalListener(<span class="keyword">new</span> RemovalListener&lt;String, String&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;String, String&gt; notification)</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"remove key["</span> + notification.getKey() + <span class="string">"],value["</span> + notification.getValue() + <span class="string">"],remove reason["</span> + notification.getCause() + <span class="string">"]"</span>);</div><div class="line">            System.out.println(<span class="string">"remove thread name "</span> + Thread.currentThread().getName());</div><div class="line">        &#125;</div><div class="line">    &#125;).build(<span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            System.out.println(<span class="string">"key["</span> + key + <span class="string">"] to upper case"</span>);</div><div class="line">            <span class="keyword">return</span> key.toUpperCase();</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"a"</span>));</div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"b"</span>));</div><div class="line">    System.out.println(<span class="string">"thread name "</span> + Thread.currentThread().getName());</div><div class="line">    cache.invalidate(<span class="string">"b"</span>);<span class="comment">//åˆ é™¤keyä¸ºbçš„å€¼</span></div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"a"</span>));</div><div class="line">    Thread.sleep(<span class="number">5000</span>);</div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"c"</span>));</div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"a"</span>));</div><div class="line">    System.out.println(cache.stats().toString());</div><div class="line">    System.out.println(<span class="string">"end"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">key[a] to upper <span class="keyword">case</span></div><div class="line">A</div><div class="line">key[b] to upper <span class="keyword">case</span></div><div class="line">B</div><div class="line">thread name main</div><div class="line">remove key[b],value[B],remove reason[EXPLICIT]</div><div class="line">remove thread name main A</div><div class="line">remove key[a],value[A],remove reason[EXPIRED]</div><div class="line">remove thread name main key[c] to upper <span class="keyword">case</span></div><div class="line">C</div><div class="line">key[a] to upper <span class="keyword">case</span></div><div class="line">A</div><div class="line">CacheStats&#123;hitCount=1, missCount=4, loadSuccessCount=4, loadExceptionCount=0, totalLoadTime=3460000, evictionCount=1&#125;</div><div class="line">end</div></pre></td></tr></table></figure>
<p>åˆ›å»ºäº†ä¸€ä¸ªç¨å¤æ‚çš„LoadingCacheå®ä¾‹ã€‚å„æ–¹æ³•æ„ä¹‰å¦‚ä¸‹ï¼š</p>
<p><strong>expireAfterWrite</strong>ï¼šå†™å…¥ç¼“å­˜åçš„è¿‡æœŸæ—¶é—´<br><strong>maximumSize</strong>ï¼šç¼“å­˜çš„æœ€å¤šå­˜æ”¾å…ƒç´ ä¸ªæ•°<br><strong>recordStats</strong>ï¼šå¯¹ç¼“å­˜å‘½ä¸­æƒ…å†µè¿›è¡Œç»Ÿè®¡<br><strong>removalListener</strong>ï¼šè®¾ç½®ç¼“å­˜æ•°æ®å¤±æ•ˆæ—¶ç›‘å¬å™¨</p>
<p>Guavaä¸­å¾ˆå¤šåœ°æ–¹éƒ½æ˜¯è¿™ç§fluentçš„æ–¹å¼.</p>
<p>åœ¨åˆ é™¤çš„ç›‘å¬å™¨ä¸­æ‰“å°çº¿ç¨‹çš„åå­—æ˜¯ä¸ºäº†æ˜¾ç¤ºè¯¥ç›‘å¬å™¨æ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„ã€‚å¯ä»¥çœ‹åˆ°åˆ é™¤ç›‘å¬æ˜¯åŒæ­¥çš„ï¼Œå› ä¸ºå’Œä¸»çº¿ç¨‹çš„åå­—æ˜¯ä¸€æ ·çš„ï¼Œå…¶å®å¯ä»¥ç†è§£ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰æŒ‡å®šé¢å¤–çš„çº¿ç¨‹æ± ã€‚åˆ é™¤ç›‘å¬å™¨ä¸­å¯ä»¥çœ‹åˆ°åˆ é™¤çš„keyã€valueã€causeã€‚ä¸»çº¿ç¨‹sleep 5såï¼Œç¼“å­˜ä¸­keyä¸ºaçš„å…ƒç´ å°±è¿‡æœŸäº†ï¼Œå¯ä»¥çœ‹åˆ°ç›‘å¬å™¨è¢«è°ƒç”¨ï¼Œæœ€åé€šè¿‡cache.stats()å–å¾—ç¼“å­˜å‘½ä¸­çš„æƒ…å†µç»Ÿè®¡ã€‚å¯ä»¥çœ‹åˆ°å‘½ä¸­1æ¬¡ï¼Œmissäº†4æ¬¡ï¼ˆloadäº†4æ¬¡ï¼‰ï¼Œäº‹å®ä¸Šçš„ç¡®å¦‚æ­¤ã€‚</p>
<p>å¯ä»¥é€šè¿‡RemovalListeners.asynchronousæ–¹æ³•å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªå¼‚æ­¥çš„listenerå¯¹è±¡ã€‚å¦‚ä¸‹æ–¹å¼åˆ›å»ºLoadingCacheï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">LoadingCache&lt;String, String&gt; cache = CacheBuilder.newBuilder().expireAfterWrite(<span class="number">5</span>, TimeUnit.SECONDS).maximumSize(<span class="number">3</span>).recordStats().removalListener(RemovalListeners.asynchronous(<span class="keyword">new</span> RemovalListener&lt;String, String&gt;() &#123;</div><div class="line">    <span class="comment">//åˆ é™¤ç¼“å­˜ç›‘å¬å™¨å¼‚æ­¥åˆ é™¤</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;String, String&gt; notification)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"remove key["</span> + notification.getKey() + <span class="string">"],value["</span> + notification.getValue() + <span class="string">"],remove reason["</span> + notification.getCause() + <span class="string">"]"</span>);</div><div class="line">        System.out.println(<span class="string">"remove thread name "</span> + Thread.currentThread().getName());</div><div class="line">    &#125;</div><div class="line">&#125;, Executors.newCachedThreadPool())).build(<span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        System.out.println(<span class="string">"key["</span> + key + <span class="string">"] to upper case"</span>);</div><div class="line">        <span class="keyword">return</span> key.toUpperCase();</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>RemovalListeners.asynchronousæ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯RemovalListenerå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ¥æ”¶ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¿™æ ·å°±å¯ä»¥å¼‚æ­¥çš„è®¾ç½®åˆ é™¤ç›‘å¬å™¨äº†ã€‚è¿è¡Œå¯ä»¥çœ‹åˆ°ä¸»çº¿ç¨‹çš„çº¿ç¨‹åå’Œç›‘å¬å™¨ä¸­çš„çº¿ç¨‹åæ˜¯ä¸åŒçš„ã€‚</p>
<p>ä¸Šé¢åˆ›å»ºç¼“å­˜çš„æ–¹å¼æ˜¯é€šè¿‡expireAfterWriteæŒ‡å®šå…ƒç´ çš„è¿‡æœŸæ—¶é—´ï¼Œè¾¾åˆ°é‡æ–°åŠ è½½çš„ã€‚ä¹Ÿå°±æ˜¯è¯´å½“è¿‡æœŸåï¼Œè¿™ä¸ªå…ƒç´ å°±ä¸å­˜åœ¨äº†ï¼Œå†è·å–çš„æ—¶å€™å°±è¦é€šè¿‡loadé‡æ–°åŠ è½½ï¼Œå½“åŠ è½½çš„æ—¶å€™ï¼Œè·å–valueçš„ä¸»çº¿ç¨‹å¿…é¡»åŒæ­¥çš„ç­‰ç¼“å­˜åŠ è½½å®Œè·å¾—æ•°æ®åæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚è¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šé™åˆ¶äº†è®¿é—®é€Ÿåº¦ã€‚</p>
<p>å¦‚æœæ•°æ®é‡ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œå°±ä¸å¿…ä½¿ç”¨è¿‡æœŸæ—¶é—´è¿™ç§æ–¹å¼ï¼Œè€Œä½¿ç”¨åˆ·æ–°ï¼Œä½¿ç”¨refreshAfterWriteæŒ‡å®šåˆ·æ–°çš„æ—¶é—´é—´éš”ã€‚çœ‹å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    LoadingCache&lt;String, String&gt; cache = CacheBuilder.newBuilder().recordStats().refreshAfterWrite(<span class="number">3</span>, TimeUnit.SECONDS).build(<span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            System.out.println(<span class="string">"load key["</span> + key + <span class="string">"]"</span>);</div><div class="line">            <span class="keyword">return</span> key.toUpperCase();</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">reload</span><span class="params">(String key, String oldValue)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            System.out.println(<span class="string">"reload key["</span> + key + <span class="string">"],oldValue["</span> + oldValue + <span class="string">"]"</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.reload(key, oldValue);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"a"</span>));</div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"b"</span>));</div><div class="line">    cache.refresh(<span class="string">"a"</span>);</div><div class="line">    Thread.sleep(<span class="number">3000</span>);</div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"a"</span>));</div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"c"</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„refreshç¤ºä¾‹ï¼Œå¦‚æœä½¿ç”¨refreshAfterWriteï¼Œéœ€è¦å®ç°CacheLoaderçš„reloadæ–¹æ³•ï¼Œå¦‚æœä¸å®ç°ï¼Œä»–æœ‰ä¸€ä¸ªé»˜è®¤çš„å®ç°ï¼Œå°±æ˜¯æœ¬ç¤ºä¾‹å±•ç¤ºçš„ä»£ç ï¼Œç›´æ¥è°ƒç”¨loadæ–¹æ³•ã€‚ä»£ç çš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">load key[a]</div><div class="line">A</div><div class="line">load key[b] B</div><div class="line">reload key[a],oldValue[A]</div><div class="line">load key[a] reload key[a],oldValue[A]</div><div class="line">load key[a] A</div><div class="line">load key[c] C</div></pre></td></tr></table></figure>
<p>æœ¬ä¾‹ä¸­åˆ·æ–°çš„æ—¶é—´è®¾ç½®ä¸º3sï¼Œå†ç¬¬ä¸€æ¬¡æ˜¾å¼çš„è°ƒç”¨<code>cache.refresh(&quot;a&quot;)</code>çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°reloadæ–¹æ³•è¢«è°ƒç”¨äº†ã€‚ä½†æ˜¯reloadç›´æ¥èµ°é»˜è®¤çš„å®ç°ï¼Œè°ƒç”¨äº†loadæ–¹æ³•ï¼Œæ‰€ä»¥æ¥ç€å°±è¾“å‡ºäº†<code>load key[a]</code>å½“ä¸»çº¿ç¨‹sleep 3såï¼Œå†å–açš„å€¼æ—¶å› ä¸ºè¶…è¿‡åˆ·æ–°é—´éš”ï¼Œåˆä¼šè°ƒç”¨reloadæ–¹æ³•ã€‚å¯ä»¥æƒ³è±¡è¿™é‡Œçš„reloadè‚¯å®šæ˜¯ä»¥åŒæ­¥çš„æ–¹å¼è¿›è¡Œçš„ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰æŒ‡å®šé¢å¤–çš„çº¿ç¨‹æ± ç”¨æ¥æ‰§è¡Œreloadæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´å½“åˆ°è¾¾åˆ·æ–°æ—¶é—´é—´éš”åï¼Œå–valueçš„ä¸»çº¿ç¨‹è¿˜æ˜¯è¦ç­‰refreshç»“æŸï¼Œæ‰èƒ½æ‹¿åˆ°æ•°æ®åæ‰§è¡Œï¼Œè¿™å’Œåˆšæ‰çš„expireAfterWriteæ–¹å¼å·®ä¸å¤šã€‚Guavaæä¾›äº†å¼‚æ­¥åˆ·æ–°çš„æ–¹å¼,çœ‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * ç¼“å­˜å¤±æ•ˆæ—¶å¼‚æ­¥é‡ç°åŠ è½½ï¼Œç¼“å­˜è°ƒç”¨è€…æ°¸è¿œä¸ç”¨é˜»å¡ç­‰</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> InterruptedException</div><div class="line"> */</div><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    LoadingCache&lt;String, String&gt; cache = CacheBuilder.newBuilder().recordStats().refreshAfterWrite(<span class="number">3</span>, TimeUnit.SECONDS).build(<span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            System.out.println(<span class="string">"load key["</span> + key + <span class="string">"]"</span>);</div><div class="line">            <span class="keyword">return</span> key.toUpperCase();</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">reload</span><span class="params">(<span class="keyword">final</span> String key, String oldValue)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            ListenableFutureTask&lt;String&gt; task = ListenableFutureTask.create(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    System.out.println(<span class="string">"reload key["</span> + key + <span class="string">"] synchronize at thread["</span> + Thread.currentThread().getName() + <span class="string">"],this will take 1 second..."</span>);</div><div class="line">                    Thread.sleep(<span class="number">1000</span>);</div><div class="line">                    System.out.println(<span class="string">"reload end..."</span>);</div><div class="line">                    <span class="keyword">return</span> key.toUpperCase();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            Executors.newCachedThreadPool().execute(task);</div><div class="line">            System.out.println(<span class="string">"reload key["</span> + key + <span class="string">"],oldValue["</span> + oldValue + <span class="string">"]"</span>);</div><div class="line">            <span class="keyword">return</span> task;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">//æ³¨æ„ï¼šå¦‚æœé‡æ¥æ²¡æœ‰è¢«getè¿‡ï¼Œåœ¨ç¼“å­˜ä¸­å®Œå…¨æ²¡æœ‰ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ä¼šæ‰§è¡Œloadï¼Œç„¶ååŠ å…¥åˆ°cacheä¸­ï¼Œåªæœ‰è¢«åŠ å…¥åˆ°å…¶ä¸­çš„</span></div><div class="line">    <span class="comment">//åˆ°è¾¾å¤±æ•ˆæ—¶é—´åï¼Œå†è¢«åŠ è½½çš„æ—¶å€™æ‰ä¼šè§¦å‘reload</span></div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"a"</span>));</div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"b"</span>));</div><div class="line">    cache.refresh(<span class="string">"a"</span>);</div><div class="line">    Thread.sleep(<span class="number">3000</span>);</div><div class="line">    <span class="comment">//è¿™é‡Œçš„å–a ä¸ä¼šè§¦å‘reloadï¼Œå› ä¸ºä¸Šé¢refreshéœ€è¦è€—1sæ‰èƒ½ç»“æŸï¼Œè€Œä¸»çº¿ç¨‹è¿™é‡Œåªéœ€è¦ç­‰3s</span></div><div class="line">    <span class="comment">//æ‰€ä»¥è¿™é‡Œçš„aè¿˜æœ‰1sçš„å­˜æ´»æ—¶é—´</span></div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"a"</span>));</div><div class="line">    <span class="comment">//ä½†æ˜¯è¿™é‡Œçš„b å°±å¿…é¡»reloadäº†ï¼Œä½†æ˜¯reloadçš„è¿‡ç¨‹éœ€è¦æ³¨æ„ä¸‹ï¼šå…ˆè°ƒç”¨loadæ–¹æ³•ï¼Œç„¶åå‘ç°å¤±æ•ˆäº†ï¼Œä½†æ˜¯è¿˜ä¼šè¿”å›ä¹‹å‰</span></div><div class="line">    <span class="comment">//ç¼“å­˜ä¸­çš„å€¼ï¼ŒåŒæ—¶ä¼šåŠ è½½reloadï¼Œå› ä¸ºæ˜¯å¼‚æ­¥reloadï¼Œä¸»çº¿ç¨‹è¿™é‡Œä¸ç”¨ç­‰reloadç»“æŸï¼Œç»§ç»­å‘ä¸‹è¿è¡Œè·å–cçš„å€¼</span></div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"b"</span>));</div><div class="line">    System.out.println(cache.getUnchecked(<span class="string">"c"</span>));</div><div class="line">    <span class="comment">//è¿™é‡Œå†æš‚åœ5sæ˜¯ä¸ºäº†çœ‹æ¸…æ¥šä¸Šé¢reload bçš„ç»“æŸ</span></div><div class="line">    Thread.sleep(<span class="number">5000</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ¬ç¤ºä¾‹ä¾ç„¶è®¾ç½®refreshæ—¶é—´ä¸º3sã€‚é‡ç‚¹æ˜¯reloadæ–¹æ³•ï¼Œå…ˆæ‰“å°å‡ºreloadæ‰§è¡Œæ‰€åœ¨çš„çº¿ç¨‹åï¼Œä¸ºäº†èƒ½æ¸…æ¥šçš„çœ‹åˆ°ä¸»çº¿ç¨‹ä¸éœ€è¦ç­‰refreshå®Œï¼Œè¿™é‡Œsleepäº†1sã€‚å…¶ä»–ä»£ç è·Ÿä¹‹å‰çš„å·®ä¸å¤šï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">load key[a]</div><div class="line">A</div><div class="line">load key[b] B</div><div class="line">reload key[a],oldValue[A]</div><div class="line">reload key[a] synchronize at thread[pool-1-thread-1],this will take 1 second...</div><div class="line">reload end...</div><div class="line">A</div><div class="line">reload key[b],oldValue[B]</div><div class="line">B</div><div class="line">load key[c] C</div><div class="line">reload key[b] synchronize at thread[pool-2-thread-1],this will take 1 second...</div><div class="line">reload end...</div></pre></td></tr></table></figure>
<p>å½“æ‰§è¡Œ<code>cache.refresh(&quot;a&quot;)</code>ä»£ç çš„æ—¶å€™ï¼Œè°ƒç”¨äº†reloadæ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°reloadæ‰€åœ¨çº¿ç¨‹åæ˜¯çº¿ç¨‹æ± ä¸­çš„ã€‚è¿™å¥ä»£ç ç´§æ¥ç€ä¸»çº¿ç¨‹sleepäº†3sï¼Œç„¶ååˆå»å–açš„å€¼ï¼ŒæŒ‰ç†è¯´è¿™æ—¶å€™aåº”è¯¥åˆ°è¾¾äº†åˆ·æ–°çš„æ—¶é—´é—´éš”äº†ï¼Œä½†æ˜¯å› ä¸ºä¹‹å‰çš„reloadæ–¹æ³•æ‰§è¡Œå°±éœ€è¦1sï¼Œæ‰€ä»¥å¯¹äºaæ¥è¯´ï¼Œè¿˜æœ‰1sçš„åˆ·æ–°æ—¶é—´å‰©ä½™ï¼Œæ‰€ä»¥è¿™æ—¶å–açš„å€¼ï¼Œå¹¶ä¸ä¼šè§¦å‘reloadã€‚è€Œç´§æ¥ç€å–bçš„å€¼å°±ä¸åŒäº†ï¼Œå› ä¸ºbæ²¡æœ‰è¢«refreshè¿‡ï¼Œè¿™æ—¶å€™å–bçš„å€¼è¾¾åˆ°äº†åˆ·æ–°çš„æ—¶é—´é—´éš”ï¼Œæ‰€ä»¥ä¼šè§¦å‘reload bã€‚ä½†æ˜¯å› ä¸ºæ˜¯å¼‚æ­¥çš„åˆ·æ–°ï¼Œä¸»çº¿ç¨‹æ ¹æœ¬ä¸ç”¨ç­‰åˆ·æ–°å®Œï¼Œæ‰€ä»¥ç«‹å³è¾“å‡ºäº†åŸæ¥æ—§çš„å€¼Bï¼Œå¹¶ç«‹å³è¾“å‡ºäº†load cçš„ç»“æœï¼Œç„¶åæ‰çœ‹åˆ° reload bçš„è¿‡ç¨‹åœ¨ç»§ç»­è¿›è¡Œï¼Œç›´åˆ°ç»“æŸã€‚</p>
<p>å¼‚æ­¥åˆ·æ–°ï¼Œä¸»çº¿ç¨‹æ°¸è¿œä¸ç”¨ç­‰ç¼“å­˜çš„åŠ è½½ï¼ç°åœ¨åœ¨å·¥ä½œä¸­æ‰€æœ‰ä½¿ç”¨Guava caheçš„åœ°æ–¹å…¨éƒ¨é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚</p>
<p><strong>æ³¨æ„å¦‚ä¸‹å‡ ç‚¹ï¼š</strong></p>
<ul>
<li>refreshAfterWriteå’ŒexpireAfterWriteçš„åŒºåˆ«<ul>
<li>refreshAfterWriteåªä¸è¿‡åœ¨åˆ·æ–°æ—¶é—´é—´éš”åˆ°çš„æ—¶å€™ï¼Œè°ƒç”¨reloadæ–¹æ³•è·å–å¯¹äºçš„keyå¯¹äºçš„valueåæ›¿æ¢å½“å‰å†…å­˜ä¸­çš„keyå€¼ã€‚åŸæ¥å†…å­˜ä¸­çš„keyå¯¹äºçš„valueæ˜¯ä¸€ç›´å­˜åœ¨çš„ã€‚</li>
<li>expireAfterWriteæ–¹å¼å½“è¾¾åˆ°è¿‡æœŸæ—¶é—´åï¼Œå†…å­˜ä¸­çš„å¯¹åº”çš„key-valueå°±è¢«åˆ é™¤äº†ï¼ˆåº”è¯¥æ˜¯è¢«åŠ¨åˆ é™¤æ–¹å¼ï¼Œå…¶å®è¿˜åœ¨å†…å­˜ä¸­ï¼Œè·å–keyçš„ç¬é—´è¢«åˆ é™¤ï¼‰ã€‚åªèƒ½é€šè¿‡loadæ–¹æ³•é‡æ–°åŠ è½½keyå¯¹äºçš„valueã€‚</li>
</ul>
</li>
<li>refreshæ–¹å¼å¹¶ä¸æ˜¯è¾¾åˆ°æ—¶é—´é—´éš”åå°±ç«‹å³åˆ·æ–°ï¼Œè€Œæ˜¯åœ¨getæ•°æ®çš„æ—¶å€™ï¼Œå‘ç°è¶…è¿‡åˆ·æ–°æ—¶é—´é—´éš”äº†æ‰ä¼šåˆ·æ–°ï¼Œæ˜¯è¢«åŠ¨çš„æ–¹å¼ã€‚</li>
<li>åªæœ‰ç¼“å­˜ä¸­å­˜åœ¨çš„keyï¼Œåœ¨åˆ°è¾¾åˆ·æ–°æ—¶é—´æ—¶ï¼Œæ‰ä¼šé€šè¿‡reloadåˆ·æ–°ï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰å¯¹åº”keyçš„valueï¼Œç¬¬ä¸€æ¬¡æ°¸è¿œæ˜¯è°ƒç”¨loadåŠ è½½æ•°æ®ã€‚</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Guava future]]></title>
      <url>http://zsr.github.io/2016/08/24/Guava-future/</url>
      <content type="html"><![CDATA[<h2 id="Guava-Future"><a href="#Guava-Future" class="headerlink" title="Guava Future"></a>Guava Future</h2><h3 id="åŒæ­¥ã€å¼‚æ­¥ã€é˜»å¡ã€éé˜»å¡"><a href="#åŒæ­¥ã€å¼‚æ­¥ã€é˜»å¡ã€éé˜»å¡" class="headerlink" title="åŒæ­¥ã€å¼‚æ­¥ã€é˜»å¡ã€éé˜»å¡"></a>åŒæ­¥ã€å¼‚æ­¥ã€é˜»å¡ã€éé˜»å¡</h3><ul>
<li><p>åŒæ­¥ï¼šæ‰€è°“åŒæ­¥ï¼Œå°±æ˜¯åœ¨å‘å‡ºä¸€ä¸ªåŠŸèƒ½è°ƒç”¨æ—¶ï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥è°ƒç”¨å°±ä¸è¿”å›ã€‚ä¹Ÿå°±æ˜¯å¿…é¡»ä¸€ä»¶ä¸€ä»¶äº‹åš,ç­‰å‰ä¸€ä»¶åšå®Œäº†æ‰èƒ½åšä¸‹ä¸€ä»¶äº‹ã€‚</p>
</li>
<li><p>å¼‚æ­¥ï¼šå¼‚æ­¥çš„æ¦‚å¿µå’ŒåŒæ­¥ç›¸å¯¹ã€‚å½“ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœã€‚å®é™…å¤„ç†è¿™ä¸ªè°ƒç”¨çš„éƒ¨ä»¶åœ¨å®Œæˆåï¼Œé€šè¿‡çŠ¶æ€ã€é€šçŸ¥å’Œå›è°ƒæ¥é€šçŸ¥è°ƒç”¨è€…ã€‚</p>
</li>
<li><p>é˜»å¡ï¼šé˜»å¡è°ƒç”¨æ˜¯æŒ‡è°ƒç”¨ç»“æœè¿”å›ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼ˆçº¿ç¨‹è¿›å…¥éå¯æ‰§è¡ŒçŠ¶æ€ï¼Œåœ¨è¿™ä¸ªçŠ¶æ€ä¸‹ï¼Œcpuä¸ä¼šç»™çº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡ï¼Œå³çº¿ç¨‹æš‚åœè¿è¡Œï¼‰ã€‚å‡½æ•°åªæœ‰åœ¨å¾—åˆ°ç»“æœä¹‹åæ‰ä¼šè¿”å›ã€‚</p>
</li>
<li><p>éé˜»å¡ï¼šéé˜»å¡å’Œé˜»å¡çš„æ¦‚å¿µç›¸å¯¹åº”ï¼ŒæŒ‡åœ¨ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥å‡½æ•°ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œè€Œä¼šç«‹åˆ»è¿”å›ã€‚</p>
</li>
</ul>
<h3 id="å¹¶å‘"><a href="#å¹¶å‘" class="headerlink" title="å¹¶å‘"></a>å¹¶å‘</h3><p>çº¿ç¨‹çš„å¹¶å‘æ–¹å¼ä¸€èˆ¬æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>å¼‚æ­¥æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œä¸éœ€è¦è¿”å›ç»“æœ</li>
<li>éœ€è¦å¼‚æ­¥æ‰§è¡Œè¿”å›ç»“æœ</li>
</ul>
<p>ç¬¬ä¸€ç§ï¼Œç›´æ¥å¾€çº¿ç¨‹æ± ä¸­ä»Runnableå¯¹è±¡ï¼Œä»£ç å¤§æ¦‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Executors.newCachedThreadPool().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//do something</span></div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>ç¬¬äºŒç§ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>ä¸»çº¿ç¨‹blockåˆ°æ•°æ®</li>
<li>è®¾ç½®å›è°ƒ</li>
</ul>
<p>JDKæä¾›çš„æ–¹å¼å°±æ˜¯ä¸»çº¿ç¨‹blockåˆ°æ•°æ®ï¼Œç±»ä¼¼å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Future&lt;Object&gt; future = Executors.newCachedThreadPool().submit(<span class="keyword">new</span> Callable&lt;Object&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">Object data = future.get();<span class="comment">//blockç›´åˆ°æ‹¿åˆ°æ•°æ®</span></div></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹å¼ç¼ºç‚¹å¾ˆæ˜¾ç„¶ï¼Œä¸»çº¿ç¨‹é˜»å¡ã€‚è€ŒJDKå¯¹Futureè®¾ç½®å›è°ƒæ²¡æœ‰ç›¸åº”çš„æ–¹æ³•ï¼ŒGuavaæ‰©å±•äº†è¿™ä¸€ç‚¹ï¼Œå¼•å…¥ListenableFutureï¼Œå¯ä»¥å¯¹ListenableFutureè®¾ç½®å›è°ƒã€‚</p>
<a id="more"></a>
<h2 id="ListenableFuture"><a href="#ListenableFuture" class="headerlink" title="ListenableFuture"></a>ListenableFuture</h2><p>Guavaä¸ºJavaå¹¶è¡Œç¼–ç¨‹Futureæä¾›äº†å¾ˆå¤šæœ‰ç”¨æ‰©å±•ï¼Œå…¶ä¸»è¦æ¥å£ä¸ºListenableFutureï¼Œå¹¶å€ŸåŠ©äºFuturesé™æ€æ‰©å±•ã€‚è·å¾—ListenableFutureå®ä¾‹æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p>
<ul>
<li>å‘è£…é¥°åçš„çº¿ç¨‹æ± ä¸­æäº¤callable</li>
<li>å°†æ™®é€šçš„futureè½¬æ¢ä¸ºlistenableFuture</li>
</ul>
<p>ç»§æ‰¿è‡³Futureçš„ListenableFutureï¼Œå…è®¸æˆ‘ä»¬æ·»åŠ å›è°ƒå‡½æ•°åœ¨çº¿ç¨‹è¿ç®—å®Œæˆæ—¶è¿”å›å€¼æˆ–è€…æ–¹æ³•æ‰§è¡Œå®Œæˆç«‹å³è¿”å›ã€‚</p>
<p>å¯¹ListenableFutureæ·»åŠ å›è°ƒå‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Futures.addCallback(ListenableFuture&lt;V&gt;, FutureCallback&lt;V&gt;, Executor)</div></pre></td></tr></table></figure>
<p>å…¶ä¸­ FutureCallbackæ˜¯ä¸€ä¸ªåŒ…å«onSuccess(V),onFailure(Throwable)çš„æ¥å£ã€‚</p>
<p>ä½¿ç”¨å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Futures.addCallback(ListenableFuture, <span class="keyword">new</span> FutureCallback&lt;Object&gt;() &#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Object result)</span> </span>&#123;</div><div class="line">        System.out.printf(<span class="string">"onSuccess with: %s%n"</span>, result);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable thrown)</span> </span>&#123;</div><div class="line">        System.out.printf(<span class="string">"onFailure %s%n"</span>, thrown.getMessage());</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>åŒæ—¶Guavaä¸­Futureså¯¹äºFutureæ‰©å±•è¿˜æœ‰ï¼š</p>
<ul>
<li>transformï¼šå¯¹äºListenableFutureçš„è¿”å›å€¼è¿›è¡Œè½¬æ¢ã€‚</li>
<li>allAsListï¼šå¯¹å¤šä¸ªListenableFutureçš„åˆå¹¶ï¼Œè¿”å›ä¸€ä¸ªå½“æ‰€æœ‰FutureæˆåŠŸæ—¶è¿”å›å¤šä¸ªFutureè¿”å›å€¼ç»„æˆçš„Listå¯¹è±¡ã€‚æ³¨ï¼šå½“å…¶ä¸­ä¸€ä¸ªFutureå¤±è´¥æˆ–è€…å–æ¶ˆçš„æ—¶å€™ï¼Œå°†ä¼šè¿›å…¥å¤±è´¥æˆ–è€…å–æ¶ˆã€‚</li>
<li>successfulAsListï¼šå’ŒallAsListç›¸ä¼¼ï¼Œå”¯ä¸€å·®åˆ«æ˜¯å¯¹äºå¤±è´¥æˆ–å–æ¶ˆçš„Futureè¿”å›å€¼ç”¨nullä»£æ›¿ã€‚ä¸ä¼šè¿›å…¥å¤±è´¥æˆ–è€…å–æ¶ˆæµç¨‹ã€‚</li>
<li>immediateFuture/immediateCancelledFutureï¼š ç«‹å³è¿”å›ä¸€ä¸ªå¾…è¿”å›å€¼çš„ListenableFutureã€‚</li>
<li>makeChecked: å°†ListenableFuture è½¬æ¢æˆCheckedFutureã€‚CheckedFuture æ˜¯ä¸€ä¸ªListenableFuture ï¼Œå…¶ä¸­åŒ…å«äº†å¤šä¸ªç‰ˆæœ¬çš„get æ–¹æ³•ï¼Œæ–¹æ³•å£°æ˜æŠ›å‡ºæ£€æŸ¥å¼‚å¸¸.è¿™æ ·ä½¿å¾—åˆ›å»ºä¸€ä¸ªåœ¨æ‰§è¡Œé€»è¾‘ä¸­å¯ä»¥æŠ›å‡ºå¼‚å¸¸çš„Futureæ›´åŠ å®¹æ˜“</li>
<li>JdkFutureAdapters.listenInPoolThread(future): guavaåŒæ—¶æä¾›äº†å°†JDK Futureè½¬æ¢ä¸ºListenableFutureçš„æ¥å£å‡½æ•°ã€‚</li>
</ul>
<h3 id="è£…é¥°çº¿ç¨‹æ± "><a href="#è£…é¥°çº¿ç¨‹æ± " class="headerlink" title="è£…é¥°çº¿ç¨‹æ± "></a>è£…é¥°çº¿ç¨‹æ± </h3><p>Guavaæä¾›äº†æ–¹æ³•å°†JDKçš„çº¿ç¨‹æ± è£…é¥°æˆä¸€ä¸ªâ€œå¯ç›‘å¬çš„çº¿ç¨‹æ± â€ã€‚çœ‹å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    ExecutorService threadPool = Executors.newFixedThreadPool(<span class="number">3</span>, <span class="keyword">new</span> ThreadFactory() &#123;</div><div class="line">        <span class="keyword">private</span> AtomicLong index = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable runnable)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Thread(runnable, <span class="string">"commons-thread-"</span> + index.incrementAndGet());</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    ListeningExecutorService listeningExecutorService = MoreExecutors.listeningDecorator(threadPool);</div><div class="line">    ListenableFuture&lt;String&gt; listenableFuture = listeningExecutorService.submit(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            Thread.sleep(<span class="number">3000</span>);</div><div class="line">            <span class="comment">//System.out.println(1 / 0);</span></div><div class="line">            <span class="keyword">return</span> <span class="string">"world"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"> 	<span class="comment">//1)ç›‘å¬</span></div><div class="line">    listenableFuture.addListener(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"can't get return value"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;, MoreExecutors.directExecutor());</div><div class="line"></div><div class="line">    <span class="comment">//2)å›è°ƒ</span></div><div class="line">    Futures.addCallback(listenableFuture, <span class="keyword">new</span> FutureCallback&lt;String&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String result)</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"the result of future is: "</span> + result);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"exception:"</span> + t.getMessage());</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    Thread.sleep(<span class="number">5000</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç å…ˆå®šä¹‰äº†æ™®é€šçš„çº¿ç¨‹æ± ï¼ŒGuavaé€šè¿‡<code>MoreExecutors.listeningDecorator(threadPool)</code>å°†æ™®é€šçš„çº¿ç¨‹æ± è£…é¥°æˆä¸€ä¸ªå¯ç›‘å¬çš„çº¿ç¨‹æ± ï¼Œå‘è£…é¥°åçš„çº¿ç¨‹æ± ä¸­æäº¤callableï¼Œå°±å¯ä»¥è·å¾—listenableFutureå®ä¾‹äº†ã€‚</p>
<p>å¯ä»¥å¯¹listenableFutureè®¾ç½®listener(æ–¹æ³•ï¼šaddListener )ï¼ŒåŒæ—¶æŒ‡å®šlistenæ‰§è¡Œçš„çº¿ç¨‹æ± ï¼Œä¹Ÿå¯ä»¥è®¾ç½®å›è°ƒ(æ–¹æ³•ï¼šFutures.addCallback )ï¼Œè·å–listenableFutureçš„ç»“æœã€‚</p>
<ul>
<li><p>æ–¹æ³•ä¸€ï¼šé€šè¿‡ListenableFutureçš„addListeneræ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">listenableFuture.addListener(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="meta">@Override</span></div><div class="line">Â  Â  Â  Â  Â  Â  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">try</span> &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  System.out.println(<span class="string">"get listenable future's result "</span> + listenableFuture.get());</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.printStackTrace();</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.printStackTrace();</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  Â  Â  &#125;, executorService);</div></pre></td></tr></table></figure>
</li>
<li><p>æ–¹æ³•äºŒï¼šé€šè¿‡Futuresçš„é™æ€æ–¹æ³•addCallbackç»™ListenableFutureæ·»åŠ å›è°ƒå‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Futures.addCallback(listenableFuture, <span class="keyword">new</span> FutureCallback&lt;Integer&gt;() &#123;</div><div class="line">  Â  Â  Â  Â  Â  Â  <span class="meta">@Override</span></div><div class="line">  Â  Â  Â  Â  Â  Â  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Integer result)</span> </span>&#123;</div><div class="line">  Â  Â  Â  Â  Â  Â  Â  Â  System.out.println(<span class="string">"get listenable future's result with callback "</span> + result);</div><div class="line">  Â  Â  Â  Â  Â  Â  &#125;</div><div class="line"></div><div class="line">  Â  Â  Â  Â  Â  Â  <span class="meta">@Override</span></div><div class="line">  Â  Â  Â  Â  Â  Â  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">  Â  Â  Â  Â  Â  Â  Â  Â  t.printStackTrace();</div><div class="line">  Â  Â  Â  Â  Â  Â  &#125;</div><div class="line">  Â  Â  Â  Â  &#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>æ¨èä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼Œå› ä¸ºç¬¬äºŒç§æ–¹æ³•å¯ä»¥ç›´æ¥å¾—åˆ°Futureçš„è¿”å›å€¼ï¼Œæˆ–è€…å¤„ç†é”™è¯¯æƒ…å†µã€‚æœ¬è´¨ä¸Šç¬¬äºŒç§æ–¹æ³•æ˜¯é€šè¿‡è°ƒåŠ¨ç¬¬ä¸€ç§æ–¹æ³•å®ç°çš„ï¼Œåšäº†è¿›ä¸€æ­¥çš„å°è£…ã€‚</p>
<p>å¦å¤–ListenableFutureæ¥å£è¿˜æœ‰å…¶ä»–å‡ ç§å†…ç½®å…·ä½“å®ç°ï¼š</p>
<ul>
<li>SettableFutureï¼šä¸éœ€è¦å®ç°ä¸€ä¸ªæ–¹æ³•æ¥è®¡ç®—è¿”å›å€¼ï¼Œè€Œåªéœ€è¦è¿”å›ä¸€ä¸ªå›ºå®šå€¼æ¥åšä¸ºè¿”å›å€¼ï¼Œå¯ä»¥é€šè¿‡ç¨‹åºè®¾ç½®æ­¤Futureçš„è¿”å›å€¼æˆ–è€…å¼‚å¸¸ä¿¡æ¯</li>
<li>CheckedFutureï¼š è¿™æ˜¯ä¸€ä¸ªç»§æ‰¿è‡ªListenableFutureæ¥å£ï¼Œä»–æä¾›äº†checkedGet()æ–¹æ³•ï¼Œæ­¤æ–¹æ³•åœ¨Futureæ‰§è¡Œå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œå¯ä»¥æŠ›å‡ºæŒ‡å®šç±»å‹çš„å¼‚å¸¸ã€‚</li>
</ul>
<p>å¯ä»¥åœ¨callableå†…éƒ¨æ•è·å¼‚å¸¸ï¼Œä¹Ÿå¯ä»¥æŠ›å‡ºï¼Œåœ¨å›è°ƒçš„onFailureä¸­å¤„ç†å¼‚å¸¸ã€‚</p>
<p>ä¸Šé¢æ¼”ç¤ºçš„æ˜¯å¯¹JDKæ™®é€šçš„çº¿ç¨‹æ± ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å¯¹æ—¶é—´è°ƒåº¦çš„çº¿ç¨‹æ± è¿›è¡Œè£…é¥°ã€‚ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * æ¼”ç¤ºå®šæ—¶è°ƒåº¦çº¿ç¨‹æ± è£…é¥°æˆlistençš„æ•ˆæœ</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> InterruptedException</div><div class="line"> */</div><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    ListeningScheduledExecutorService listeningScheduledExecutorService = MoreExecutors.listeningDecorator(Executors.newScheduledThreadPool(<span class="number">3</span>));</div><div class="line">    <span class="comment">//åªæœ‰callableæ‰å¯¹åº”æœ‰future</span></div><div class="line">    ListenableScheduledFuture&lt;?&gt; listenableScheduledFuture = listeningScheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"hello world"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;, <span class="number">5</span>, <span class="number">3</span>, TimeUnit.SECONDS);</div><div class="line"></div><div class="line">    <span class="comment">//å› ä¸ºä¸Šé¢çš„ä¼ çš„æ˜¯runnableï¼Œæ‰€ä»¥æ²¡æœ‰è¿”å›å€¼ï¼Œæ²¡æœ‰è¿”å›å€¼å°±ä¸ä¼šè§¦å‘futureçš„callBack</span></div><div class="line">    Futures.addCallback(listenableScheduledFuture, <span class="keyword">new</span> FutureCallback&lt;Object&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Object result)</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"not result: "</span> + result);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    Thread.sleep(<span class="number">12000</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è£…é¥°åçš„å¯ç›‘å¬çš„æ—¶é—´è°ƒåº¦çº¿ç¨‹æ± ä½¿ç”¨æ–¹å¼å’ŒåŸæ¥ä¸€æ ·ã€‚è¿™é‡Œè°ƒåº¦äº†ä¸€ä¸ªrunnableå¯¹è±¡ã€‚å»¶è¿Ÿ5såï¼Œæ¯3sæ‰§è¡Œä¸€æ¬¡ã€‚å› ä¸ºrunnableæ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥ä¸‹é¢çš„å›è°ƒä¸ä¼šè¢«è°ƒç”¨ã€‚å½“ç„¶å¯ä»¥å‘è£…é¥°åçš„çº¿ç¨‹æ± ä¸­æäº¤callableï¼Œè¿™æ ·å›è°ƒå°±ä¼šæ‰§è¡Œã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    ListeningScheduledExecutorService listeningScheduledExecutorService = MoreExecutors.listeningDecorator(Executors.newScheduledThreadPool(<span class="number">3</span>));</div><div class="line">    ListenableScheduledFuture&lt;String&gt; schedule = listeningScheduledExecutorService.schedule(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"world"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;, <span class="number">3</span>, TimeUnit.SECONDS);</div><div class="line">    Futures.addCallback(schedule, <span class="keyword">new</span> FutureCallback&lt;String&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String result)</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"hello "</span> + result);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    Thread.sleep(<span class="number">4000</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å°†Futureè½¬æ¢ä¸ºListenerableFuture"><a href="#å°†Futureè½¬æ¢ä¸ºListenerableFuture" class="headerlink" title="å°†Futureè½¬æ¢ä¸ºListenerableFuture"></a>å°†Futureè½¬æ¢ä¸ºListenerableFuture</h3><p>Guavaæä¾›äº†æ–¹æ³•å°†æ™®é€šçš„futureè½¬æ¢ä¸ºlistenerableFutureï¼Œä»¥ä¾¿äºæ·»åŠ å›è°ƒã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * æ¼”ç¤ºå°†jdkçš„futureè½¬æ¢ä¸ºListenableFuture</div><div class="line"> */</div><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</div><div class="line">    ExecutorService threadPool = Executors.newFixedThreadPool(<span class="number">3</span>);</div><div class="line">    System.out.println(Thread.currentThread().getName());</div><div class="line">    Future&lt;String&gt; future = threadPool.submit(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            System.out.println(Thread.currentThread().getName());</div><div class="line">            <span class="keyword">return</span> <span class="string">"world"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    ListenableFuture&lt;String&gt; listenableFuture = JdkFutureAdapters.listenInPoolThread(future);</div><div class="line">    Futures.addCallback(listenableFuture, <span class="keyword">new</span> FutureCallback&lt;String&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String result)</span> </span>&#123;</div><div class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">": hello "</span> + result);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">    &#125;, threadPool);<span class="comment">//MoreExecutors.directExecutor();è¿™ç§æ–¹å¼æ‹¿åˆ°çš„çº¿ç¨‹æ± è¿˜æ˜¯å½“å‰çš„ç°åœºç¯å¢ƒï¼Œè¿˜æ˜¯åŒæ­¥çš„ã€‚</span></div><div class="line">  System.out.println(<span class="string">"end."</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡<code>JdkFutureAdapters.listenInPoolThread(future)</code>è½¬æ¢ä¸€ä¸ªæ™®é€šçš„futureã€‚è®¾ç½®å›è°ƒæ—¶ï¼Œå¯ä»¥æŒ‡å®šå›è°ƒæ‰§è¡Œçš„çº¿ç¨‹æ± ã€‚</p>
<p>Guavaæä¾›çš„listenerableFutureå¤„ç†å¯ä»¥è®¾ç½®å›è°ƒï¼Œè¿˜èƒ½é€šè¿‡functionè¿›è¡Œå˜æ¢ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[java future]]></title>
      <url>http://zsr.github.io/2016/08/23/java-future/</url>
      <content type="html"><![CDATA[<h2 id="Callableã€Futureå’ŒFutureTask"><a href="#Callableã€Futureå’ŒFutureTask" class="headerlink" title="Callableã€Futureå’ŒFutureTask"></a>Callableã€Futureå’ŒFutureTask</h2><p>åˆ›å»ºçº¿ç¨‹çš„2ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ç›´æ¥ç»§æ‰¿Threadï¼Œå¦å¤–ä¸€ç§å°±æ˜¯å®ç°Runnableæ¥å£ã€‚è¿™2ç§æ–¹å¼éƒ½æœ‰ä¸€ä¸ªç¼ºé™·å°±æ˜¯ï¼šåœ¨æ‰§è¡Œå®Œä»»åŠ¡ä¹‹åæ— æ³•è·å–æ‰§è¡Œç»“æœã€‚</p>
<p>å¦‚æœéœ€è¦è·å–æ‰§è¡Œç»“æœï¼Œå°±å¿…é¡»é€šè¿‡å…±äº«å˜é‡æˆ–è€…ä½¿ç”¨çº¿ç¨‹é€šä¿¡çš„æ–¹å¼æ¥è¾¾åˆ°æ•ˆæœï¼Œè¿™æ ·ä½¿ç”¨èµ·æ¥å°±æ¯”è¾ƒéº»çƒ¦ã€‚è€Œè‡ªä»Java 1.5å¼€å§‹ï¼Œå°±æä¾›äº†Callableå’ŒFutureï¼Œé€šè¿‡å®ƒä»¬å¯ä»¥åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åå¾—åˆ°ä»»åŠ¡æ‰§è¡Œç»“æœã€‚</p>
<h3 id="Callableä¸Runnable"><a href="#Callableä¸Runnable" class="headerlink" title="Callableä¸Runnable"></a>Callableä¸Runnable</h3><p>java.lang.Runnable:å®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œåœ¨å®ƒé‡Œé¢åªå£°æ˜äº†ä¸€ä¸ªrun()æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”±äºrun()æ–¹æ³•è¿”å›å€¼ä¸ºvoidç±»å‹ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œå®Œä»»åŠ¡ä¹‹åæ— æ³•è¿”å›ä»»ä½•ç»“æœã€‚</p>
<p>Callableä½äºjava.util.concurrentåŒ…ä¸‹ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œåœ¨å®ƒé‡Œé¢ä¹Ÿåªå£°æ˜äº†ä¸€ä¸ªæ–¹æ³•call()ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callable</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Computes a result, or throws an exception if unable to do so.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> computed result</div><div class="line">     * <span class="doctag">@throws</span> Exception if unable to compute a result</div><div class="line">     */</div><div class="line">    <span class="function">V <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªæ³›å‹æ¥å£ï¼Œcall()å‡½æ•°è¿”å›çš„ç±»å‹å°±æ˜¯ä¼ é€’è¿›æ¥çš„Vç±»å‹ã€‚<br>ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯é…åˆExecutorServiceæ¥ä½¿ç”¨çš„ï¼Œåœ¨ExecutorServiceæ¥å£ä¸­å£°æ˜äº†è‹¥å¹²ä¸ªsubmitæ–¹æ³•çš„é‡è½½ç‰ˆæœ¬ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span></span>;</div><div class="line">&lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Runnable task, T result)</span></span>;</div><div class="line">Future&lt;?&gt; submit(Runnable task);</div></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ä¸ªsubmitæ–¹æ³•é‡Œé¢çš„å‚æ•°ç±»å‹å°±æ˜¯Callableã€‚<br>ä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨ç¬¬ä¸€ä¸ªsubmitæ–¹æ³•å’Œç¬¬ä¸‰ä¸ªsubmitæ–¹æ³•ï¼Œç¬¬äºŒä¸ªsubmitæ–¹æ³•å¾ˆå°‘ä½¿ç”¨ã€‚</p>
<h3 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h3><p>Futureå°±æ˜¯å¯¹äºå…·ä½“çš„Runnableæˆ–è€…Callableä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿›è¡Œå–æ¶ˆã€æŸ¥è¯¢æ˜¯å¦å®Œæˆã€è·å–ç»“æœã€‚å¿…è¦æ—¶å¯ä»¥é€šè¿‡getæ–¹æ³•è·å–æ‰§è¡Œç»“æœï¼Œè¯¥æ–¹æ³•ä¼šé˜»å¡ç›´åˆ°ä»»åŠ¡è¿”å›ç»“æœã€‚</p>
<p>Futureç±»ä½äºjava.util.concurrentåŒ…ä¸‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCancelled</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException</span>;</div><div class="line">    <span class="function">V <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></div><div class="line">        <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨Futureæ¥å£ä¸­å£°æ˜äº†5ä¸ªæ–¹æ³•ï¼Œä¸‹é¢ä¾æ¬¡è§£é‡Šæ¯ä¸ªæ–¹æ³•çš„ä½œç”¨ï¼š</p>
<ul>
<li>cancelæ–¹æ³•ç”¨æ¥å–æ¶ˆä»»åŠ¡ï¼Œå¦‚æœå–æ¶ˆä»»åŠ¡æˆåŠŸåˆ™è¿”å›trueï¼Œå¦‚æœå–æ¶ˆä»»åŠ¡å¤±è´¥åˆ™è¿”å›falseã€‚å‚æ•°mayInterruptIfRunningè¡¨ç¤ºæ˜¯å¦å…è®¸å–æ¶ˆæ­£åœ¨æ‰§è¡Œå´æ²¡æœ‰æ‰§è¡Œå®Œæ¯•çš„ä»»åŠ¡ï¼Œå¦‚æœè®¾ç½®trueï¼Œåˆ™è¡¨ç¤ºå¯ä»¥å–æ¶ˆæ­£åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä»»åŠ¡ã€‚å¦‚æœä»»åŠ¡å·²ç»å®Œæˆï¼Œåˆ™æ— è®ºmayInterruptIfRunningä¸ºtrueè¿˜æ˜¯falseï¼Œæ­¤æ–¹æ³•è‚¯å®šè¿”å›falseï¼Œå³å¦‚æœå–æ¶ˆå·²ç»å®Œæˆçš„ä»»åŠ¡ä¼šè¿”å›falseï¼›å¦‚æœä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè‹¥mayInterruptIfRunningè®¾ç½®ä¸ºtrueï¼Œåˆ™è¿”å›trueï¼Œè‹¥mayInterruptIfRunningè®¾ç½®ä¸ºfalseï¼Œåˆ™è¿”å›falseï¼›å¦‚æœä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œï¼Œåˆ™æ— è®ºmayInterruptIfRunningä¸ºtrueè¿˜æ˜¯falseï¼Œè‚¯å®šè¿”å›trueã€‚</li>
<li>isCancelledæ–¹æ³•è¡¨ç¤ºä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆæˆåŠŸï¼Œå¦‚æœåœ¨ä»»åŠ¡æ­£å¸¸å®Œæˆå‰è¢«å–æ¶ˆæˆåŠŸï¼Œåˆ™è¿”å› trueã€‚</li>
<li>isDoneæ–¹æ³•è¡¨ç¤ºä»»åŠ¡æ˜¯å¦å·²ç»å®Œæˆï¼Œè‹¥ä»»åŠ¡å®Œæˆï¼Œåˆ™è¿”å›trueï¼›</li>
<li>get()æ–¹æ³•ç”¨æ¥è·å–æ‰§è¡Œç»“æœï¼Œè¿™ä¸ªæ–¹æ³•ä¼šäº§ç”Ÿé˜»å¡ï¼Œä¼šä¸€ç›´ç­‰åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ‰è¿”å›ï¼›</li>
<li>get(long timeout, TimeUnit unit)ç”¨æ¥è·å–æ‰§è¡Œç»“æœï¼Œå¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…ï¼Œè¿˜æ²¡è·å–åˆ°ç»“æœï¼Œå°±ç›´æ¥è¿”å›nullã€‚</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´Futureæä¾›äº†ä¸‰ç§åŠŸèƒ½ï¼š</p>
<ul>
<li>1)åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆï¼›</li>
<li>2)èƒ½å¤Ÿä¸­æ–­ä»»åŠ¡ï¼›</li>
<li>3)èƒ½å¤Ÿè·å–ä»»åŠ¡æ‰§è¡Œç»“æœã€‚</li>
</ul>
<p>å› ä¸ºFutureåªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ‰€ä»¥æ˜¯æ— æ³•ç›´æ¥ç”¨æ¥åˆ›å»ºå¯¹è±¡ä½¿ç”¨çš„ï¼Œå› æ­¤å°±æœ‰äº†FutureTaskã€‚</p>
<a id="more"></a>
<h4 id="Callable-Future-è·å–æ‰§è¡Œç»“æœ"><a href="#Callable-Future-è·å–æ‰§è¡Œç»“æœ" class="headerlink" title="Callable+Future è·å–æ‰§è¡Œç»“æœ"></a>Callable+Future è·å–æ‰§è¡Œç»“æœ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.Date;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Future;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCallable</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">String</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Thread.sleep(<span class="number">1000</span>);</div><div class="line">        <span class="comment">//return the thread name executing this callable task</span></div><div class="line">        <span class="keyword">return</span> Thread.currentThread().getName();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</div><div class="line">        <span class="comment">//Get ExecutorService from Executors utility class, thread pool size is 10</span></div><div class="line">        ExecutorService executor = Executors.newFixedThreadPool(<span class="number">10</span>);</div><div class="line">        <span class="comment">//create a list to hold the Future object associated with Callable</span></div><div class="line">        List&lt;Future&lt;String&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;Future&lt;String&gt;&gt;();</div><div class="line">        <span class="comment">//Create MyCallable instance</span></div><div class="line">        Callable&lt;String&gt; callable = <span class="keyword">new</span> MyCallable();</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt; <span class="number">100</span>; i++)&#123;</div><div class="line">            <span class="comment">//submit Callable tasks to be executed by thread pool</span></div><div class="line">            Future&lt;String&gt; future = executor.submit(callable);</div><div class="line">            <span class="comment">//add Future to the list, we can get return value using Future</span></div><div class="line">            list.add(future);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span>(Future&lt;String&gt; fut : list)&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//print the return value of Future, notice the output delay in console</span></div><div class="line">                <span class="comment">// because Future.get() waits for task to get completed</span></div><div class="line">                System.out.println(<span class="keyword">new</span> Date()+ <span class="string">"::"</span>+fut.get());</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//shut down the executor service now</span></div><div class="line">        executor.shutdown();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœ:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">Tue Aug 23 12:02:44 CST 2016::pool-1-thread-1</div><div class="line">Tue Aug 23 12:02:45 CST 2016::pool-1-thread-2</div><div class="line">Tue Aug 23 12:02:45 CST 2016::pool-1-thread-3</div><div class="line">Tue Aug 23 12:02:45 CST 2016::pool-1-thread-4</div><div class="line">Tue Aug 23 12:02:45 CST 2016::pool-1-thread-5</div><div class="line">Tue Aug 23 12:02:45 CST 2016::pool-1-thread-6</div><div class="line">Tue Aug 23 12:02:45 CST 2016::pool-1-thread-7</div><div class="line">Tue Aug 23 12:02:45 CST 2016::pool-1-thread-8</div><div class="line">Tue Aug 23 12:02:45 CST 2016::pool-1-thread-9</div><div class="line">Tue Aug 23 12:02:45 CST 2016::pool-1-thread-10</div><div class="line">Tue Aug 23 12:02:45 CST 2016::pool-1-thread-8</div><div class="line">Tue Aug 23 12:02:46 CST 2016::pool-1-thread-4</div><div class="line">Tue Aug 23 12:02:46 CST 2016::pool-1-thread-7</div><div class="line">Tue Aug 23 12:02:46 CST 2016::pool-1-thread-9</div><div class="line">Tue Aug 23 12:02:46 CST 2016::pool-1-thread-1</div><div class="line">Tue Aug 23 12:02:46 CST 2016::pool-1-thread-5</div><div class="line">Tue Aug 23 12:02:46 CST 2016::pool-1-thread-3</div><div class="line">Tue Aug 23 12:02:46 CST 2016::pool-1-thread-6</div><div class="line">Tue Aug 23 12:02:46 CST 2016::pool-1-thread-2</div><div class="line">Tue Aug 23 12:02:46 CST 2016::pool-1-thread-10</div><div class="line">........I</div></pre></td></tr></table></figure>
<h3 id="FutureTask"><a href="#FutureTask" class="headerlink" title="FutureTask"></a>FutureTask</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹FutureTaskçš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureTask</span>&lt;<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">RunnableFuture</span>&lt;<span class="title">V</span>&gt;</span></div></pre></td></tr></table></figure>
<p>FutureTaskç±»å®ç°äº†RunnableFutureæ¥å£ï¼ŒRunnableFutureæ¥å£çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RunnableFuture</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Runnable</span>, <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>RunnableFutureç»§æ‰¿äº†Runnableæ¥å£å’ŒFutureæ¥å£ï¼Œè€ŒFutureTaskå®ç°äº†RunnableFutureæ¥å£ã€‚æ‰€ä»¥å®ƒæ—¢å¯ä»¥ä½œä¸ºRunnableè¢«çº¿ç¨‹æ‰§è¡Œï¼Œåˆå¯ä»¥ä½œä¸ºFutureå¾—åˆ°Callableçš„è¿”å›å€¼ã€‚</p>
<p>FutureTaskæä¾›äº†2ä¸ªæ„é€ å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">FutureTask</span><span class="params">(Callable&lt;V&gt; callable)</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">FutureTask</span><span class="params">(Runnable runnable, V result)</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Callable-FutureTaskè·å–æ‰§è¡Œç»“æœ"><a href="#Callable-FutureTaskè·å–æ‰§è¡Œç»“æœ" class="headerlink" title="Callable+FutureTaskè·å–æ‰§è¡Œç»“æœ"></a>Callable+FutureTaskè·å–æ‰§è¡Œç»“æœ</h4><ul>
<li>Callable å®ç°</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCallable</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">String</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">long</span> waitTime;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MyCallable</span><span class="params">(<span class="keyword">int</span> timeInMillis)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.waitTime=timeInMillis;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		Thread.sleep(waitTime);</div><div class="line">        <span class="comment">//return the thread name executing this callable task</span></div><div class="line">        <span class="keyword">return</span> Thread.currentThread().getName();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>FutureTask å®ç°</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.FutureTask;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureTaskExample</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		MyCallable callable1 = <span class="keyword">new</span> MyCallable(<span class="number">1000</span>);</div><div class="line">		MyCallable callable2 = <span class="keyword">new</span> MyCallable(<span class="number">2000</span>);</div><div class="line"></div><div class="line">		FutureTask&lt;String&gt; futureTask1 = <span class="keyword">new</span> FutureTask&lt;String&gt;(callable1);</div><div class="line">		FutureTask&lt;String&gt; futureTask2 = <span class="keyword">new</span> FutureTask&lt;String&gt;(callable2);</div><div class="line"></div><div class="line">		ExecutorService executor = Executors.newFixedThreadPool(<span class="number">2</span>);</div><div class="line">		executor.execute(futureTask1);</div><div class="line">		executor.execute(futureTask2);</div><div class="line">		</div><div class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="keyword">if</span>(futureTask1.isDone() &amp;&amp; futureTask2.isDone())&#123;</div><div class="line">					System.out.println(<span class="string">"Done"</span>);</div><div class="line">					<span class="comment">//shut down executor service</span></div><div class="line">					executor.shutdown();</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125;</div><div class="line">				</div><div class="line">				<span class="keyword">if</span>(!futureTask1.isDone())&#123;</div><div class="line">				<span class="comment">//wait indefinitely for future task to complete</span></div><div class="line">				System.out.println(<span class="string">"FutureTask1 output="</span>+futureTask1.get());</div><div class="line">				&#125;</div><div class="line">				</div><div class="line">				System.out.println(<span class="string">"Waiting for FutureTask2 to complete"</span>);</div><div class="line">				String s = futureTask2.get(<span class="number">200L</span>, TimeUnit.MILLISECONDS);</div><div class="line">				<span class="keyword">if</span>(s !=<span class="keyword">null</span>)&#123;</div><div class="line">					System.out.println(<span class="string">"FutureTask2 output="</span>+s);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;<span class="keyword">catch</span>(TimeoutException e)&#123;</div><div class="line">				<span class="comment">//do nothing</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœ:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">FutureTask1 output=pool-1-thread-1</div><div class="line">Waiting <span class="keyword">for</span> FutureTask2 to complete</div><div class="line">Waiting <span class="keyword">for</span> FutureTask2 to complete</div><div class="line">Waiting <span class="keyword">for</span> FutureTask2 to complete</div><div class="line">Waiting <span class="keyword">for</span> FutureTask2 to complete</div><div class="line">Waiting <span class="keyword">for</span> FutureTask2 to complete</div><div class="line">FutureTask2 output=pool-1-thread-2</div><div class="line">Done</div></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Spring è‡ªå®šä¹‰æ ‡ç­¾]]></title>
      <url>http://zsr.github.io/2016/08/22/Spring-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%87%E7%AD%BE/</url>
      <content type="html"><![CDATA[<h2 id="Spring-è‡ªå®šä¹‰æ ‡ç­¾"><a href="#Spring-è‡ªå®šä¹‰æ ‡ç­¾" class="headerlink" title="Spring è‡ªå®šä¹‰æ ‡ç­¾"></a>Spring è‡ªå®šä¹‰æ ‡ç­¾</h2><p>æ­¥éª¤:</p>
<ol>
<li><p>ç¼–å†™java bean</p>
</li>
<li><p>ç¼–å†™xsdé…ç½®æ–‡ä»¶</p>
</li>
<li><p>ç¼–å†™spring.handlerså’Œspring.schmas</p>
</li>
<li><p>ç¼–å†™applicationContext.xml</p>
</li>
<li><p>ç¼–å†™NamespaceHandlerå’ŒBeanDefinitionParser</p>
</li>
</ol>
<h3 id="é¡¹ç›®ç›®å½•ç»“æ„"><a href="#é¡¹ç›®ç›®å½•ç»“æ„" class="headerlink" title="é¡¹ç›®ç›®å½•ç»“æ„"></a>é¡¹ç›®ç›®å½•ç»“æ„</h3><h3 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h3><h4 id="1-ç¼–å†™java-bean"><a href="#1-ç¼–å†™java-bean" class="headerlink" title="1. ç¼–å†™java bean"></a>1. ç¼–å†™java bean</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">package com.zsr.spring.schema;</div><div class="line"></div><div class="line">public class User &#123;</div><div class="line"></div><div class="line">  private String id;</div><div class="line">  private String name;</div><div class="line">  private String sex;</div><div class="line">  private int age;</div><div class="line"></div><div class="line">  public String getId() &#123;</div><div class="line">    return id;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public void setId(String id) &#123;</div><div class="line">    this.id = id;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public String getName() &#123;</div><div class="line">    return name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public void setName(String name) &#123;</div><div class="line">    this.name = name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public String getSex() &#123;</div><div class="line">    return sex;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public void setSex(String sex) &#123;</div><div class="line">    this.sex = sex;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public int getAge() &#123;</div><div class="line">    return age;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public void setAge(int age) &#123;</div><div class="line">    this.age = age;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-å®šä¹‰ä¸€ä¸ªXSDæ–‡ä»¶"><a href="#2-å®šä¹‰ä¸€ä¸ªXSDæ–‡ä»¶" class="headerlink" title="2. å®šä¹‰ä¸€ä¸ªXSDæ–‡ä»¶"></a>2. å®šä¹‰ä¸€ä¸ªXSDæ–‡ä»¶</h4><p>META-INF/user-1.0.xsdæ–‡ä»¶:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;xsd:schema xmlns=&quot;http://zsr.github.io/schema/test&quot;</div><div class="line">  xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">  xmlns:tool=&quot;http://www.springframework.org/schema/tool&quot; xmlns:beans=&quot;http://www.springframework.org/schema/beans&quot;</div><div class="line">  targetNamespace=&quot;http://zsr.github.io/schema/test&quot;&gt;</div><div class="line"></div><div class="line">  &lt;xsd:import namespace=&quot;http://www.springframework.org/schema/beans&quot; /&gt;</div><div class="line">  &lt;xsd:import namespace=&quot;http://www.springframework.org/schema/tool&quot; /&gt;</div><div class="line"></div><div class="line">  &lt;xsd:annotation&gt;</div><div class="line">    &lt;xsd:documentation&gt;&lt;![CDATA[ Namespace support for the test]]&gt;&lt;/xsd:documentation&gt;</div><div class="line">  &lt;/xsd:annotation&gt;</div><div class="line"></div><div class="line">  &lt;xsd:element name=&quot;user&quot;&gt;</div><div class="line">    &lt;xsd:complexType&gt;</div><div class="line">      &lt;xsd:attribute name=&quot;id&quot; type=&quot;xsd:string&quot; use=&quot;required&quot;&gt;</div><div class="line">        &lt;xsd:annotation&gt;</div><div class="line">          &lt;xsd:documentation&gt;</div><div class="line">            &lt;![CDATA[</div><div class="line">              Unique id</div><div class="line">            ]]&gt;</div><div class="line">          &lt;/xsd:documentation&gt;</div><div class="line">        &lt;/xsd:annotation&gt;</div><div class="line">      &lt;/xsd:attribute&gt;</div><div class="line"></div><div class="line">      &lt;xsd:attribute name=&quot;name&quot; type=&quot;xsd:string&quot;&gt;</div><div class="line">        &lt;xsd:annotation&gt;</div><div class="line">          &lt;xsd:documentation&gt;å§“å&lt;/xsd:documentation&gt;</div><div class="line">        &lt;/xsd:annotation&gt;</div><div class="line">      &lt;/xsd:attribute&gt;</div><div class="line"></div><div class="line">      &lt;xsd:attribute name=&quot;sex&quot; type=&quot;xsd:string&quot;&gt;</div><div class="line">        &lt;xsd:annotation&gt;</div><div class="line">          &lt;xsd:documentation&gt;æ€§åˆ«&lt;/xsd:documentation&gt;</div><div class="line">        &lt;/xsd:annotation&gt;</div><div class="line">      &lt;/xsd:attribute&gt;</div><div class="line"></div><div class="line">      &lt;xsd:attribute name=&quot;age&quot; type=&quot;xsd:int&quot;&gt;</div><div class="line">        &lt;xsd:annotation&gt;</div><div class="line">          &lt;xsd:documentation&gt;å¹´é¾„&lt;/xsd:documentation&gt;</div><div class="line">        &lt;/xsd:annotation&gt;</div><div class="line">      &lt;/xsd:attribute&gt;</div><div class="line">    &lt;/xsd:complexType&gt;</div><div class="line">  &lt;/xsd:element&gt;</div><div class="line"></div><div class="line">&lt;/xsd:schema&gt;</div></pre></td></tr></table></figure>
<h4 id="3-æ–°å»ºspring-handlersï¼Œ-spring-shcemas"><a href="#3-æ–°å»ºspring-handlersï¼Œ-spring-shcemas" class="headerlink" title="3. æ–°å»ºspring.handlersï¼Œ spring.shcemas"></a>3. æ–°å»ºspring.handlersï¼Œ spring.shcemas</h4><p>åœ¨é¡¹ç›®çš„META-INFç›®å½•ä¸‹æ–°å»ºä¸¤ä¸ªæ–‡ä»¶spring.handlersï¼Œå’Œspring.shcemas.</p>
<ul>
<li>Spring.handlers</li>
</ul>
<p>åœ¨ç±»org.springframework.beans.factory.xml.DefaultNamespaceHandlerResolverä¸­å·²ç»å†™æ­»äº†è¦å–mappingçš„handlerMappingsLocationçš„è·¯å¾„:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public static finalString DEFAULT_HANDLER_MAPPINGS_LOCATION =&quot;META-INF/spring.handlers&quot;;</div></pre></td></tr></table></figure>
<p>spring.handlerså†…å®¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http\://www.zsr.com/schema/test=com.zsr.spring.schema.MyNamespaceHandler</div></pre></td></tr></table></figure>
<ul>
<li>Spring.Schemas </li>
</ul>
<p>åœ¨org.springframework.beans.factory.xml.PluggableSchemaResolverè¿™ä¸ªç±»ä¸­<br>åŒæ ·å†™æ­»äº†ä½ç½®:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public static finalString DEFAULT_SCHEMA_MAPPINGS_LOCATION = &quot;META-INF/spring.schemas&quot;;</div></pre></td></tr></table></figure>
<p>spring.schemaså†…å®¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http\://www.zsr.com/schema/test/user-1.0.xsd=META-INF/user-1.0.xsd</div></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–çš„æ—¶å€™ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™ä¼šè°ƒç”¨:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PropertiesLoaderUtils.loadAllProperties(this.schemaMappingsLocation,this.classLoader)</div></pre></td></tr></table></figure>
<p>æŠŠæ‰€æœ‰çš„æ–‡ä»¶ååŒ…å«çš„å–å‡ºæ¥æ”¾å…¥mapä¸­ã€‚</p>
<h4 id="4-ç¼–å†™applicationContext-xml"><a href="#4-ç¼–å†™applicationContext-xml" class="headerlink" title="4. ç¼–å†™applicationContext.xml"></a>4. ç¼–å†™applicationContext.xml</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</div><div class="line">  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:test=&quot;http://www.zsr.com/schema/test&quot;</div><div class="line">  xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans </div><div class="line">    http://www.springframework.org/schema/beans/spring-beans-3.1.xsd    </div><div class="line">    http://www.zsr.com/schema/test </div><div class="line">    http://www.zsr.com/schema/test/user-1.0.xsd&quot;&gt;</div><div class="line"></div><div class="line">  &lt;test:user id=&quot;zsr&quot; name=&quot;zsr&quot; sex=&quot;male&quot; age=&quot;24&quot; /&gt;</div><div class="line"></div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure>
<h4 id="5-ç¼–å†™NamespaceHandlerå’ŒBeanDefinitionParser"><a href="#5-ç¼–å†™NamespaceHandlerå’ŒBeanDefinitionParser" class="headerlink" title="5. ç¼–å†™NamespaceHandlerå’ŒBeanDefinitionParser"></a>5. ç¼–å†™NamespaceHandlerå’ŒBeanDefinitionParser</h4><ul>
<li>NamespaceHandler</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">package com.zsr.spring.schema;</div><div class="line"></div><div class="line">import org.springframework.beans.factory.xml.NamespaceHandlerSupport;</div><div class="line"></div><div class="line">public class MyNamespaceHandler extends NamespaceHandlerSupport &#123;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  public void init() &#123;</div><div class="line">    registerBeanDefinitionParser(&quot;user&quot;, new UserBeanDefinitionParser());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>BeanDefinitionParser</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">package com.zsr.spring.schema;</div><div class="line"></div><div class="line">import org.springframework.beans.factory.support.BeanDefinitionBuilder;</div><div class="line">import org.springframework.beans.factory.xml.AbstractSingleBeanDefinitionParser;</div><div class="line">import org.w3c.dom.Element;</div><div class="line"></div><div class="line">public class UserBeanDefinitionParser extends AbstractSingleBeanDefinitionParser &#123;</div><div class="line"></div><div class="line">  protected static final String USER_ID = &quot;id&quot;;</div><div class="line">  protected static final String USER_NAME = &quot;name&quot;;</div><div class="line">  protected static final String USER_AGE = &quot;age&quot;;</div><div class="line">  protected static final String USER_SEX = &quot;sex&quot;;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  protected Class&lt;?&gt; getBeanClass(Element element) &#123;</div><div class="line">    return User.class;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  protected void doParse(Element element, BeanDefinitionBuilder builder) &#123;</div><div class="line">    String id = element.getAttribute(USER_ID);</div><div class="line">    String name = element.getAttribute(USER_NAME);</div><div class="line">    String sex = element.getAttribute(USER_SEX);</div><div class="line">    int age = Integer.parseInt(element.getAttribute(USER_AGE));</div><div class="line"></div><div class="line">    builder.addPropertyValue(USER_ID, id);</div><div class="line">    builder.addPropertyValue(USER_NAME, name);</div><div class="line">    builder.addPropertyValue(USER_SEX, sex);</div><div class="line">    builder.addPropertyValue(USER_AGE, age);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Google MapReduceä¸­æ–‡ç‰ˆ]]></title>
      <url>http://zsr.github.io/2016/08/19/Google-MapReduce/</url>
      <content type="html"><![CDATA[<h2 id="Google-MapReduceä¸­æ–‡ç‰ˆ"><a href="#Google-MapReduceä¸­æ–‡ç‰ˆ" class="headerlink" title="Google MapReduceä¸­æ–‡ç‰ˆ"></a>Google MapReduceä¸­æ–‡ç‰ˆ</h2><pre><code>è¯‘è€…: alex
</code></pre><h3 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h3><p>MapReduceæ˜¯ä¸€ä¸ªç¼–ç¨‹æ¨¡å‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¤„ç†å’Œç”Ÿæˆè¶…å¤§æ•°æ®é›†çš„ç®—æ³•æ¨¡å‹çš„ç›¸å…³å®ç°ã€‚ç”¨æˆ·é¦–å…ˆåˆ›å»ºä¸€ä¸ªMapå‡½æ•°å¤„ç†ä¸€ä¸ªåŸºäº key/value pairçš„æ•°æ®é›†åˆï¼Œè¾“å‡ºä¸­é—´çš„åŸºäºkey/value pairçš„æ•°æ®é›†åˆï¼›ç„¶åå†åˆ›å»ºä¸€ä¸ªReduceå‡½æ•°ç”¨æ¥åˆå¹¶æ‰€æœ‰çš„å…·æœ‰ç›¸åŒä¸­é—´keyå€¼çš„ä¸­é—´valueå€¼ã€‚ç°å®ä¸–ç•Œä¸­æœ‰å¾ˆå¤šæ»¡è¶³ä¸Šè¿°å¤„ç†æ¨¡å‹çš„ä¾‹å­ï¼Œæœ¬è®ºæ–‡å°†è¯¦ç»†æè¿°è¿™ä¸ªæ¨¡å‹ã€‚</p>
<p>MapReduceæ¶æ„çš„ç¨‹åºèƒ½å¤Ÿåœ¨å¤§é‡çš„æ™®é€šé…ç½®çš„è®¡ç®—æœºä¸Šå®ç°å¹¶è¡ŒåŒ–å¤„ç†ã€‚è¿™ä¸ªç³»ç»Ÿåœ¨è¿è¡Œæ—¶åªå…³å¿ƒï¼šå¦‚ä½•åˆ†å‰²è¾“å…¥æ•°æ®ï¼Œåœ¨å¤§é‡è®¡ç®—æœºç»„æˆçš„ é›†ç¾¤ä¸Šçš„è°ƒåº¦ï¼Œé›†ç¾¤ä¸­è®¡ç®—æœºçš„é”™è¯¯å¤„ç†ï¼Œç®¡ç†é›†ç¾¤ä¸­è®¡ç®—æœºä¹‹é—´å¿…è¦çš„é€šä¿¡ã€‚é‡‡ç”¨MapReduceæ¶æ„å¯ä»¥ä½¿é‚£äº›æ²¡æœ‰å¹¶è¡Œè®¡ç®—å’Œåˆ†å¸ƒå¼å¤„ç†ç³»ç»Ÿå¼€å‘ç»éªŒçš„ ç¨‹åºå‘˜æœ‰æ•ˆåˆ©ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸°å¯Œèµ„æºã€‚</p>
<p>æˆ‘ä»¬çš„MapReduceå®ç°è¿è¡Œåœ¨è§„æ¨¡å¯ä»¥çµæ´»è°ƒæ•´çš„ç”±æ™®é€šæœºå™¨ç»„æˆçš„é›†ç¾¤ä¸Šï¼šä¸€ä¸ªå…¸å‹çš„MapReduceè®¡ç®—å¾€å¾€ç”±å‡ åƒå°æœºå™¨ç»„æˆã€å¤„ç† ä»¥TBè®¡ç®—çš„æ•°æ®ã€‚ç¨‹åºå‘˜å‘ç°è¿™ä¸ªç³»ç»Ÿéå¸¸å¥½ç”¨ï¼šå·²ç»å®ç°äº†æ•°ä»¥ç™¾è®¡çš„MapReduceç¨‹åºï¼Œåœ¨Googleçš„é›†ç¾¤ä¸Šï¼Œæ¯å¤©éƒ½æœ‰1000å¤šä¸ª MapReduceç¨‹åºåœ¨æ‰§è¡Œã€‚</p>
<h3 id="1ã€ä»‹ç»"><a href="#1ã€ä»‹ç»" class="headerlink" title="1ã€ä»‹ç»"></a>1ã€ä»‹ç»</h3><p>åœ¨è¿‡å»çš„5å¹´é‡Œï¼ŒåŒ…æ‹¬æœ¬æ–‡ä½œè€…åœ¨å†…çš„Googleçš„å¾ˆå¤šç¨‹åºå‘˜ï¼Œä¸ºäº†å¤„ç†æµ·é‡çš„åŸå§‹æ•°æ®ï¼Œå·²ç»å®ç°äº†æ•°ä»¥ç™¾è®¡çš„ã€ä¸“ç”¨çš„è®¡ç®—æ–¹æ³•ã€‚è¿™äº›è®¡ç®—æ–¹æ³• ç”¨æ¥å¤„ç†å¤§é‡çš„åŸå§‹æ•°æ®ï¼Œæ¯”å¦‚ï¼Œæ–‡æ¡£æŠ“å–ï¼ˆç±»ä¼¼ç½‘ç»œçˆ¬è™«çš„ç¨‹åºï¼‰ã€Webè¯·æ±‚æ—¥å¿—ç­‰ç­‰ï¼›ä¹Ÿä¸ºäº†è®¡ç®—å¤„ç†å„ç§ç±»å‹çš„è¡ç”Ÿæ•°æ®ï¼Œæ¯”å¦‚å€’æ’ç´¢å¼•ã€Webæ–‡æ¡£çš„å›¾ ç»“æ„çš„å„ç§è¡¨ç¤ºå½¢åŠ¿ã€æ¯å°ä¸»æœºä¸Šç½‘ç»œçˆ¬è™«æŠ“å–çš„é¡µé¢æ•°é‡çš„æ±‡æ€»ã€æ¯å¤©è¢«è¯·æ±‚çš„æœ€å¤šçš„æŸ¥è¯¢çš„é›†åˆç­‰ç­‰ã€‚å¤§å¤šæ•°è¿™æ ·çš„æ•°æ®å¤„ç†è¿ç®—åœ¨æ¦‚å¿µä¸Šå¾ˆå®¹æ˜“ç†è§£ã€‚ç„¶è€Œç”± äºè¾“å…¥çš„æ•°æ®é‡å·¨å¤§ï¼Œå› æ­¤è¦æƒ³åœ¨å¯æ¥å—çš„æ—¶é—´å†…å®Œæˆè¿ç®—ï¼Œåªæœ‰å°†è¿™äº›è®¡ç®—åˆ†å¸ƒåœ¨æˆç™¾ä¸Šåƒçš„ä¸»æœºä¸Šã€‚å¦‚ä½•å¤„ç†å¹¶è¡Œè®¡ç®—ã€å¦‚ä½•åˆ†å‘æ•°æ®ã€å¦‚ä½•å¤„ç†é”™è¯¯ï¼Ÿæ‰€æœ‰è¿™ äº›é—®é¢˜ç»¼åˆåœ¨ä¸€èµ·ï¼Œéœ€è¦å¤§é‡çš„ä»£ç å¤„ç†ï¼Œå› æ­¤ä¹Ÿä½¿å¾—åŸæœ¬ç®€å•çš„è¿ç®—å˜å¾—éš¾ä»¥å¤„ç†ã€‚</p>
<p>ä¸ºäº†è§£å†³ä¸Šè¿°å¤æ‚çš„é—®é¢˜ï¼Œæˆ‘ä»¬è®¾è®¡ä¸€ä¸ªæ–°çš„æŠ½è±¡æ¨¡å‹ï¼Œä½¿ç”¨è¿™ä¸ªæŠ½è±¡æ¨¡å‹ï¼Œæˆ‘ä»¬åªè¦è¡¨è¿°æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„ç®€å•è¿ç®—å³å¯ï¼Œè€Œä¸å¿…å…³å¿ƒå¹¶è¡Œè®¡ç®—ã€å®¹é”™ã€ æ•°æ®åˆ†å¸ƒã€è´Ÿè½½å‡è¡¡ç­‰å¤æ‚çš„ç»†èŠ‚ï¼Œè¿™äº›é—®é¢˜éƒ½è¢«å°è£…åœ¨äº†ä¸€ä¸ªåº“é‡Œé¢ã€‚è®¾è®¡è¿™ä¸ªæŠ½è±¡æ¨¡å‹çš„çµæ„Ÿæ¥è‡ªLispå’Œè®¸å¤šå…¶ä»–å‡½æ•°å¼è¯­è¨€çš„Mapå’ŒReduceçš„åŸ è¯­ã€‚æˆ‘ä»¬æ„è¯†åˆ°æˆ‘ä»¬å¤§å¤šæ•°çš„è¿ç®—éƒ½åŒ…å«è¿™æ ·çš„æ“ä½œï¼šåœ¨è¾“å…¥æ•°æ®çš„â€œé€»è¾‘â€è®°å½•ä¸Šåº”ç”¨Mapæ“ä½œå¾—å‡ºä¸€ä¸ªä¸­é—´key/value pairé›†åˆï¼Œç„¶ååœ¨æ‰€æœ‰å…·æœ‰ç›¸åŒkeyå€¼çš„valueå€¼ä¸Šåº”ç”¨Reduceæ“ä½œï¼Œä»è€Œè¾¾åˆ°åˆå¹¶ä¸­é—´çš„æ•°æ®ï¼Œå¾—åˆ°ä¸€ä¸ªæƒ³è¦çš„ç»“æœçš„ç›®çš„ã€‚ä½¿ç”¨ MapReduceæ¨¡å‹ï¼Œå†ç»“åˆç”¨æˆ·å®ç°çš„Mapå’ŒReduceå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥éå¸¸å®¹æ˜“çš„å®ç°å¤§è§„æ¨¡å¹¶è¡ŒåŒ–è®¡ç®—ï¼›é€šè¿‡MapReduceæ¨¡å‹è‡ªå¸¦çš„â€œå† æ¬¡æ‰§è¡Œâ€ï¼ˆre-executionï¼‰åŠŸèƒ½ï¼Œä¹Ÿæä¾›äº†åˆçº§çš„å®¹ç¾å®ç°æ–¹æ¡ˆã€‚</p>
<p>è¿™ä¸ªå·¥ä½œ(å®ç°ä¸€ä¸ªMapReduceæ¡†æ¶æ¨¡å‹)çš„ä¸»è¦è´¡çŒ®æ˜¯é€šè¿‡ç®€å•çš„æ¥å£æ¥å®ç°è‡ªåŠ¨çš„å¹¶è¡ŒåŒ–å’Œå¤§è§„æ¨¡çš„åˆ†å¸ƒå¼è®¡ç®—ï¼Œé€šè¿‡ä½¿ç”¨MapReduceæ¨¡å‹æ¥å£å®ç°åœ¨å¤§é‡æ™®é€šçš„PCæœºä¸Šé«˜æ€§èƒ½è®¡ç®—ã€‚</p>
<p>ç¬¬äºŒéƒ¨åˆ†æè¿°åŸºæœ¬çš„ç¼–ç¨‹æ¨¡å‹å’Œä¸€äº›ä½¿ç”¨æ¡ˆä¾‹ã€‚ç¬¬ä¸‰éƒ¨åˆ†æè¿°äº†ä¸€ä¸ªç»è¿‡è£å‰ªçš„ã€é€‚åˆæˆ‘ä»¬çš„åŸºäºé›†ç¾¤çš„è®¡ç®—ç¯å¢ƒçš„MapReduceå®ç°ã€‚ç¬¬å››éƒ¨åˆ† æè¿°æˆ‘ä»¬è®¤ä¸ºåœ¨MapReduceç¼–ç¨‹æ¨¡å‹ä¸­ä¸€äº›å®ç”¨çš„æŠ€å·§ã€‚ç¬¬äº”éƒ¨åˆ†å¯¹äºå„ç§ä¸åŒçš„ä»»åŠ¡ï¼Œæµ‹é‡æˆ‘ä»¬MapReduceå®ç°çš„æ€§èƒ½ã€‚ç¬¬å…­éƒ¨åˆ†æ­ç¤ºäº†åœ¨ Googleå†…éƒ¨å¦‚ä½•ä½¿ç”¨MapReduceä½œä¸ºåŸºç¡€é‡å†™æˆ‘ä»¬çš„ç´¢å¼•ç³»ç»Ÿäº§å“ï¼ŒåŒ…æ‹¬å…¶å®ƒä¸€äº›ä½¿ç”¨MapReduceçš„ç»éªŒã€‚ç¬¬ä¸ƒéƒ¨åˆ†è®¨è®ºç›¸å…³çš„å’Œæœªæ¥çš„å·¥ä½œã€‚</p>
<h3 id="2ã€ç¼–ç¨‹æ¨¡å‹"><a href="#2ã€ç¼–ç¨‹æ¨¡å‹" class="headerlink" title="2ã€ç¼–ç¨‹æ¨¡å‹"></a>2ã€ç¼–ç¨‹æ¨¡å‹</h3><p>MapReduceç¼–ç¨‹æ¨¡å‹çš„åŸç†æ˜¯ï¼šåˆ©ç”¨ä¸€ä¸ªè¾“å…¥key/value pairé›†åˆæ¥äº§ç”Ÿä¸€ä¸ªè¾“å‡ºçš„key/value pairé›†åˆã€‚MapReduceåº“çš„ç”¨æˆ·ç”¨ä¸¤ä¸ªå‡½æ•°è¡¨è¾¾è¿™ä¸ªè®¡ç®—ï¼šMapå’ŒReduceã€‚</p>
<p>ç”¨æˆ·è‡ªå®šä¹‰çš„Mapå‡½æ•°æ¥å—ä¸€ä¸ªè¾“å…¥çš„key/value pairå€¼ï¼Œç„¶åäº§ç”Ÿä¸€ä¸ªä¸­é—´key/value pairå€¼çš„é›†åˆã€‚MapReduceåº“æŠŠæ‰€æœ‰å…·æœ‰ç›¸åŒä¸­é—´keyå€¼Içš„ä¸­é—´valueå€¼é›†åˆåœ¨ä¸€èµ·åä¼ é€’ç»™reduceå‡½æ•°ã€‚</p>
<p>ç”¨æˆ·è‡ªå®šä¹‰çš„Reduceå‡½æ•°æ¥å—ä¸€ä¸ªä¸­é—´keyçš„å€¼Iå’Œç›¸å…³çš„ä¸€ä¸ªvalueå€¼çš„é›†åˆã€‚Reduceå‡½æ•°åˆå¹¶è¿™äº›valueå€¼ï¼Œå½¢æˆä¸€ä¸ªè¾ƒå° çš„valueå€¼çš„é›†åˆã€‚ä¸€èˆ¬çš„ï¼Œæ¯æ¬¡Reduceå‡½æ•°è°ƒç”¨åªäº§ç”Ÿ0æˆ–1ä¸ªè¾“å‡ºvalueå€¼ã€‚é€šå¸¸æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªè¿­ä»£å™¨æŠŠä¸­é—´valueå€¼æä¾›ç»™Reduce å‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¤„ç†æ— æ³•å…¨éƒ¨æ”¾å…¥å†…å­˜ä¸­çš„å¤§é‡çš„valueå€¼çš„é›†åˆã€‚</p>
<h4 id="2-1ã€ä¾‹å­"><a href="#2-1ã€ä¾‹å­" class="headerlink" title="2.1ã€ä¾‹å­"></a>2.1ã€ä¾‹å­</h4><p>ä¾‹å¦‚ï¼Œè®¡ç®—ä¸€ä¸ªå¤§çš„æ–‡æ¡£é›†åˆä¸­æ¯ä¸ªå•è¯å‡ºç°çš„æ¬¡æ•°ï¼Œä¸‹é¢æ˜¯ä¼ªä»£ç æ®µï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">map(String key, String value):</div><div class="line">    // key: document name</div><div class="line">    // value: document contents</div><div class="line">    for each word w in value:</div><div class="line">        EmitIntermediate(w, â€œ1â€³);</div><div class="line">        </div><div class="line">reduce(String key, Iterator values):</div><div class="line">    // key: a word</div><div class="line">    // values: a list of counts</div><div class="line">    int result = 0;</div><div class="line">    for each v in values:</div><div class="line">        result += ParseInt(v);</div><div class="line">    Emit(AsString(result));</div></pre></td></tr></table></figure>
<p>Mapå‡½æ•°è¾“å‡ºæ–‡æ¡£ä¸­çš„æ¯ä¸ªè¯ã€ä»¥åŠè¿™ä¸ªè¯çš„å‡ºç°æ¬¡æ•°(åœ¨è¿™ä¸ªç®€å•çš„ä¾‹å­é‡Œå°±æ˜¯1)ã€‚Reduceå‡½æ•°æŠŠMapå‡½æ•°äº§ç”Ÿçš„æ¯ä¸€ä¸ªç‰¹å®šçš„è¯çš„è®¡æ•°ç´¯åŠ èµ·æ¥ã€‚</p>
<p>å¦å¤–ï¼Œç”¨æˆ·ç¼–å†™ä»£ç ï¼Œä½¿ç”¨è¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶çš„åå­—ã€å¯é€‰çš„è°ƒèŠ‚å‚æ•°æ¥å®Œæˆä¸€ä¸ªç¬¦åˆMapReduceæ¨¡å‹è§„èŒƒçš„å¯¹è±¡ï¼Œç„¶åè°ƒç”¨MapReduce å‡½æ•°ï¼Œå¹¶æŠŠè¿™ä¸ªè§„èŒƒå¯¹è±¡ä¼ é€’ç»™å®ƒã€‚ç”¨æˆ·çš„ä»£ç å’ŒMapReduceåº“é“¾æ¥åœ¨ä¸€èµ·(ç”¨C++å®ç°)ã€‚é™„å½•AåŒ…å«äº†è¿™ä¸ªå®ä¾‹çš„å…¨éƒ¨ç¨‹åºä»£ç ã€‚</p>
<h4 id="2-2ã€ç±»å‹"><a href="#2-2ã€ç±»å‹" class="headerlink" title="2.2ã€ç±»å‹"></a>2.2ã€ç±»å‹</h4><p>å°½ç®¡åœ¨å‰é¢ä¾‹å­çš„ä¼ªä»£ç ä¸­ä½¿ç”¨äº†ä»¥å­—ç¬¦ä¸²è¡¨ç¤ºçš„è¾“å…¥è¾“å‡ºå€¼ï¼Œä½†æ˜¯åœ¨æ¦‚å¿µä¸Šï¼Œç”¨æˆ·å®šä¹‰çš„Mapå’ŒReduceå‡½æ•°éƒ½æœ‰ç›¸å…³è”çš„ç±»å‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">map(k1,v1) -&gt;list(k2,v2)</div><div class="line"></div><div class="line">reduce(k2,list(v2)) -&gt;list(v2)</div></pre></td></tr></table></figure>
<p>æ¯”å¦‚ï¼Œè¾“å…¥çš„keyå’Œvalueå€¼ä¸è¾“å‡ºçš„keyå’Œvalueå€¼åœ¨ç±»å‹ä¸Šæ¨å¯¼çš„åŸŸä¸åŒã€‚æ­¤å¤–ï¼Œä¸­é—´keyå’Œvalueå€¼ä¸è¾“å‡ºkeyå’Œvalueå€¼åœ¨ç±»å‹ä¸Šæ¨å¯¼çš„åŸŸç›¸åŒã€‚<br><strong>ï¼ˆalexæ³¨ï¼šåŸæ–‡ä¸­è¿™ä¸ªdomainçš„å«ä¹‰ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œæˆ‘å‚è€ƒHadoopã€KFSç­‰å®ç°ï¼Œmapå’Œreduceéƒ½ä½¿ç”¨äº†æ³›å‹ï¼Œå› æ­¤ï¼Œæˆ‘æŠŠdomainç¿»è¯‘æˆç±»å‹æ¨å¯¼çš„åŸŸï¼‰</strong>ã€‚<br>æˆ‘ä»¬çš„C++ä¸­ä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹ä½œä¸ºç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°çš„è¾“å…¥è¾“å‡ºï¼Œç”¨æˆ·åœ¨è‡ªå·±çš„ä»£ç ä¸­å¯¹å­—ç¬¦ä¸²è¿›è¡Œé€‚å½“çš„ç±»å‹è½¬æ¢ã€‚</p>
<h4 id="2-3ã€æ›´å¤šçš„ä¾‹å­"><a href="#2-3ã€æ›´å¤šçš„ä¾‹å­" class="headerlink" title="2.3ã€æ›´å¤šçš„ä¾‹å­"></a>2.3ã€æ›´å¤šçš„ä¾‹å­</h4><p>è¿™é‡Œè¿˜æœ‰ä¸€äº›æœ‰è¶£çš„ç®€å•ä¾‹å­ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„ä½¿ç”¨MapReduceæ¨¡å‹æ¥è¡¨ç¤ºï¼š</p>
<ul>
<li>åˆ†å¸ƒå¼çš„Grepï¼šMapå‡½æ•°è¾“å‡ºåŒ¹é…æŸä¸ªæ¨¡å¼çš„ä¸€è¡Œï¼ŒReduceå‡½æ•°æ˜¯ä¸€ä¸ªæ’ç­‰å‡½æ•°ï¼Œå³æŠŠä¸­é—´æ•°æ®å¤åˆ¶åˆ°è¾“å‡ºã€‚</li>
<li>è®¡ç®—URLè®¿é—®é¢‘ç‡ï¼šMapå‡½æ•°å¤„ç†æ—¥å¿—ä¸­webé¡µé¢è¯·æ±‚çš„è®°å½•ï¼Œç„¶åè¾“å‡º(URL,1)ã€‚Reduceå‡½æ•°æŠŠç›¸åŒURLçš„valueå€¼éƒ½ç´¯åŠ èµ·æ¥ï¼Œäº§ç”Ÿ(URL,è®°å½•æ€»æ•°)ç»“æœã€‚</li>
<li>å€’è½¬ç½‘ç»œé“¾æ¥å›¾ï¼šMapå‡½æ•°åœ¨æºé¡µé¢ï¼ˆsourceï¼‰ä¸­æœç´¢æ‰€æœ‰çš„é“¾æ¥ç›®æ ‡ï¼ˆtargetï¼‰å¹¶è¾“å‡ºä¸º(target,source)ã€‚Reduceå‡½æ•°æŠŠç»™å®šé“¾æ¥ç›®æ ‡ï¼ˆtargetï¼‰çš„é“¾æ¥ç»„åˆæˆä¸€ä¸ªåˆ—è¡¨ï¼Œè¾“å‡º(target,list(source))ã€‚</li>
<li>æ¯ä¸ªä¸»æœºçš„æ£€ç´¢è¯å‘é‡ï¼šæ£€ç´¢è¯å‘é‡ç”¨ä¸€ä¸ª(è¯,é¢‘ç‡)åˆ—è¡¨æ¥æ¦‚è¿°å‡ºç°åœ¨æ–‡æ¡£æˆ–æ–‡æ¡£é›†ä¸­çš„æœ€é‡è¦çš„ä¸€äº›è¯ã€‚Mapå‡½æ•°ä¸ºæ¯ä¸€ä¸ªè¾“å…¥æ–‡æ¡£è¾“å‡º(ä¸»æœº å,æ£€ç´¢è¯å‘é‡)ï¼Œå…¶ä¸­ä¸»æœºåæ¥è‡ªæ–‡æ¡£çš„URLã€‚Reduceå‡½æ•°æ¥æ”¶ç»™å®šä¸»æœºçš„æ‰€æœ‰æ–‡æ¡£çš„æ£€ç´¢è¯å‘é‡ï¼Œå¹¶æŠŠè¿™äº›æ£€ç´¢è¯å‘é‡åŠ åœ¨ä¸€èµ·ï¼Œä¸¢å¼ƒæ‰ä½é¢‘çš„æ£€ç´¢ è¯ï¼Œè¾“å‡ºä¸€ä¸ªæœ€ç»ˆçš„(ä¸»æœºå,æ£€ç´¢è¯å‘é‡)ã€‚</li>
<li>å€’æ’ç´¢å¼•ï¼šMapå‡½æ•°åˆ†ææ¯ä¸ªæ–‡æ¡£è¾“å‡ºä¸€ä¸ª(è¯,æ–‡æ¡£å·)çš„åˆ—è¡¨ï¼ŒReduceå‡½æ•°çš„è¾“å…¥æ˜¯ä¸€ä¸ªç»™å®šè¯çš„æ‰€æœ‰ï¼ˆè¯ï¼Œæ–‡æ¡£å·ï¼‰ï¼Œæ’åºæ‰€æœ‰çš„æ–‡æ¡£å·ï¼Œè¾“å‡º(è¯,listï¼ˆæ–‡æ¡£å·ï¼‰)ã€‚æ‰€æœ‰çš„è¾“å‡ºé›†åˆå½¢æˆä¸€ä¸ªç®€å•çš„å€’æ’ç´¢å¼•ï¼Œå®ƒä»¥ä¸€ç§ç®€å•çš„ç®—æ³•è·Ÿè¸ªè¯åœ¨æ–‡æ¡£ä¸­çš„ä½ç½®ã€‚</li>
<li>åˆ†å¸ƒå¼æ’åºï¼šMapå‡½æ•°ä»æ¯ä¸ªè®°å½•æå–keyï¼Œè¾“å‡º(key,record)ã€‚Reduceå‡½æ•°ä¸æ”¹å˜ä»»ä½•çš„å€¼ã€‚è¿™ä¸ªè¿ç®—ä¾èµ–åˆ†åŒºæœºåˆ¶(åœ¨4.1æè¿°)å’Œæ’åºå±æ€§(åœ¨4.2æè¿°)ã€‚</li>
</ul>
<h3 id="3ã€å®ç°"><a href="#3ã€å®ç°" class="headerlink" title="3ã€å®ç°"></a>3ã€å®ç°</h3><p>MapReduceæ¨¡å‹å¯ä»¥æœ‰å¤šç§ä¸åŒçš„å®ç°æ–¹å¼ã€‚å¦‚ä½•æ­£ç¡®é€‰æ‹©å–å†³äºå…·ä½“çš„ç¯å¢ƒã€‚ä¾‹å¦‚ï¼Œä¸€ç§å®ç°æ–¹å¼é€‚ç”¨äºå°å‹çš„å…±äº«å†…å­˜æ–¹å¼çš„æœºå™¨ï¼Œå¦å¤–ä¸€ç§å®ç°æ–¹å¼åˆ™é€‚ç”¨äºå¤§å‹NUMAæ¶æ„çš„å¤šå¤„ç†å™¨çš„ä¸»æœºï¼Œè€Œæœ‰çš„å®ç°æ–¹å¼æ›´é€‚åˆå¤§å‹çš„ç½‘ç»œè¿æ¥é›†ç¾¤ã€‚</p>
<p>æœ¬ç« èŠ‚æè¿°ä¸€ä¸ªé€‚ç”¨äºGoogleå†…éƒ¨å¹¿æ³›ä½¿ç”¨çš„è¿ç®—ç¯å¢ƒçš„å®ç°ï¼šç”¨ä»¥å¤ªç½‘äº¤æ¢æœºè¿æ¥ã€ç”±æ™®é€šPCæœºç»„æˆçš„å¤§å‹é›†ç¾¤ã€‚åœ¨æˆ‘ä»¬çš„ç¯å¢ƒé‡ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>1.x86æ¶æ„ã€è¿è¡ŒLinuxæ“ä½œç³»ç»Ÿã€åŒå¤„ç†å™¨ã€2-4GBå†…å­˜çš„æœºå™¨ã€‚ </li>
<li>2.æ™®é€šçš„ç½‘ç»œç¡¬ä»¶è®¾å¤‡ï¼Œæ¯ä¸ªæœºå™¨çš„å¸¦å®½ä¸ºç™¾å…†æˆ–è€…åƒå…†ï¼Œä½†æ˜¯è¿œå°äºç½‘ç»œçš„å¹³å‡å¸¦å®½çš„ä¸€åŠã€‚ ï¼ˆalexæ³¨ï¼šè¿™é‡Œéœ€è¦ç½‘ç»œä¸“å®¶è§£é‡Šä¸€ä¸‹äº†ï¼‰ </li>
<li>3.é›†ç¾¤ä¸­åŒ…å«æˆç™¾ä¸Šåƒçš„æœºå™¨ï¼Œå› æ­¤ï¼Œæœºå™¨æ•…éšœæ˜¯å¸¸æ€ã€‚ </li>
<li>4.å­˜å‚¨ä¸ºå»‰ä»·çš„å†…ç½®IDEç¡¬ç›˜ã€‚ä¸€ä¸ªå†…éƒ¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿç”¨æ¥ç®¡ç†å­˜å‚¨åœ¨è¿™äº›ç£ç›˜ä¸Šçš„æ•°æ®ã€‚æ–‡ä»¶ç³»ç»Ÿé€šè¿‡æ•°æ®å¤åˆ¶æ¥åœ¨ä¸å¯é çš„ç¡¬ä»¶ä¸Šä¿è¯æ•°æ®çš„å¯é æ€§å’Œæœ‰æ•ˆæ€§ã€‚ </li>
<li>5.ç”¨æˆ·æäº¤å·¥ä½œï¼ˆjobï¼‰ç»™è°ƒåº¦ç³»ç»Ÿã€‚æ¯ä¸ªå·¥ä½œï¼ˆjobï¼‰éƒ½åŒ…å«ä¸€ç³»åˆ—çš„ä»»åŠ¡ï¼ˆtaskï¼‰ï¼Œè°ƒåº¦ç³»ç»Ÿå°†è¿™äº›ä»»åŠ¡è°ƒåº¦åˆ°é›†ç¾¤ä¸­å¤šå°å¯ç”¨çš„æœºå™¨ä¸Šã€‚</li>
</ul>
<h4 id="3-1ã€æ‰§è¡Œæ¦‚æ‹¬"><a href="#3-1ã€æ‰§è¡Œæ¦‚æ‹¬" class="headerlink" title="3.1ã€æ‰§è¡Œæ¦‚æ‹¬"></a>3.1ã€æ‰§è¡Œæ¦‚æ‹¬</h4><p>é€šè¿‡å°†Mapè°ƒç”¨çš„è¾“å…¥æ•°æ®è‡ªåŠ¨åˆ†å‰²ä¸ºMä¸ªæ•°æ®ç‰‡æ®µçš„é›†åˆï¼ŒMapè°ƒç”¨è¢«åˆ†å¸ƒåˆ°å¤šå°æœºå™¨ä¸Šæ‰§è¡Œã€‚è¾“å…¥çš„æ•°æ®ç‰‡æ®µèƒ½å¤Ÿåœ¨ä¸åŒçš„æœºå™¨ä¸Šå¹¶è¡Œå¤„ç†ã€‚ä½¿ ç”¨åˆ†åŒºå‡½æ•°å°†Mapè°ƒç”¨äº§ç”Ÿçš„ä¸­é—´keyå€¼åˆ†æˆRä¸ªä¸åŒåˆ†åŒºï¼ˆä¾‹å¦‚ï¼Œhash(key) mod Rï¼‰ï¼ŒReduceè°ƒç”¨ä¹Ÿè¢«åˆ†å¸ƒåˆ°å¤šå°æœºå™¨ä¸Šæ‰§è¡Œã€‚åˆ†åŒºæ•°é‡ï¼ˆRï¼‰å’Œåˆ†åŒºå‡½æ•°ç”±ç”¨æˆ·æ¥æŒ‡å®šã€‚</p>
<p><img src="/images/GoogleMR3-1.jpg"></p>
<p>å›¾1å±•ç¤ºäº†æˆ‘ä»¬çš„MapReduceå®ç°ä¸­æ“ä½œçš„å…¨éƒ¨æµç¨‹ã€‚å½“ç”¨æˆ·è°ƒç”¨MapReduceå‡½æ•°æ—¶ï¼Œå°†å‘ç”Ÿä¸‹é¢çš„ä¸€ç³»åˆ—åŠ¨ä½œï¼ˆä¸‹é¢çš„åºå·å’Œå›¾1ä¸­çš„åºå·ä¸€ä¸€å¯¹åº”ï¼‰ï¼š </p>
<ul>
<li><p>1.ç”¨æˆ·ç¨‹åºé¦–å…ˆè°ƒç”¨çš„MapReduceåº“å°†è¾“å…¥æ–‡ä»¶åˆ†æˆMä¸ªæ•°æ®ç‰‡åº¦ï¼Œæ¯ä¸ªæ•°æ®ç‰‡æ®µçš„å¤§å°ä¸€èˆ¬ä» 16MBåˆ°64MB(å¯ä»¥é€šè¿‡å¯é€‰çš„å‚æ•°æ¥æ§åˆ¶æ¯ä¸ªæ•°æ®ç‰‡æ®µçš„å¤§å°)ã€‚ç„¶åç”¨æˆ·ç¨‹åºåœ¨æœºç¾¤ä¸­åˆ›å»ºå¤§é‡çš„ç¨‹åºå‰¯æœ¬ã€‚ </p>
</li>
<li><p>2.è¿™äº›ç¨‹åºå‰¯æœ¬ä¸­çš„æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç¨‹åºâ€“masterã€‚å‰¯æœ¬ä¸­å…¶å®ƒçš„ç¨‹åºéƒ½æ˜¯workerç¨‹åºï¼Œç”±masteråˆ†é…ä»»åŠ¡ã€‚æœ‰Mä¸ªMapä»»åŠ¡å’ŒRä¸ªReduceä»»åŠ¡å°†è¢«åˆ†é…ï¼Œmasterå°†ä¸€ä¸ªMapä»»åŠ¡æˆ–Reduceä»»åŠ¡åˆ†é…ç»™ä¸€ä¸ªç©ºé—²çš„workerã€‚ </p>
</li>
<li><p>3.è¢«åˆ†é…äº†mapä»»åŠ¡çš„workerç¨‹åºè¯»å–ç›¸å…³çš„è¾“å…¥æ•°æ®ç‰‡æ®µï¼Œä»è¾“å…¥çš„æ•°æ®ç‰‡æ®µä¸­è§£æå‡ºkey/value pairï¼Œç„¶åæŠŠkey/value pairä¼ é€’ç»™ç”¨æˆ·è‡ªå®šä¹‰çš„Mapå‡½æ•°ï¼Œç”±Mapå‡½æ•°ç”Ÿæˆå¹¶è¾“å‡ºçš„ä¸­é—´key/value pairï¼Œå¹¶ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚ </p>
</li>
<li><p>4.ç¼“å­˜ä¸­çš„key/value pairé€šè¿‡åˆ†åŒºå‡½æ•°åˆ†æˆRä¸ªåŒºåŸŸï¼Œä¹‹åå‘¨æœŸæ€§çš„å†™å…¥åˆ°æœ¬åœ°ç£ç›˜ä¸Šã€‚ç¼“å­˜çš„key/value pairåœ¨æœ¬åœ°ç£ç›˜ä¸Šçš„å­˜å‚¨ä½ç½®å°†è¢«å›ä¼ ç»™masterï¼Œç”±masterè´Ÿè´£æŠŠè¿™äº›å­˜å‚¨ä½ç½®å†ä¼ é€ç»™Reduce workerã€‚</p>
</li>
<li><p>5.å½“Reduce workerç¨‹åºæ¥æ”¶åˆ°masterç¨‹åºå‘æ¥çš„æ•°æ®å­˜å‚¨ä½ç½®ä¿¡æ¯åï¼Œä½¿ç”¨RPCä»Map workeræ‰€åœ¨ä¸»æœºçš„ç£ç›˜ä¸Šè¯»å–è¿™äº›ç¼“å­˜æ•°æ®ã€‚å½“Reduce workerè¯»å–äº†æ‰€æœ‰çš„ä¸­é—´æ•°æ®åï¼Œé€šè¿‡å¯¹keyè¿›è¡Œæ’åºåä½¿å¾—å…·æœ‰ç›¸åŒkeyå€¼çš„æ•°æ®èšåˆåœ¨ä¸€èµ·ã€‚ç”±äºè®¸å¤šä¸åŒçš„keyå€¼ä¼šæ˜ å°„åˆ°ç›¸åŒçš„Reduce ä»»åŠ¡ä¸Šï¼Œå› æ­¤å¿…é¡»è¿›è¡Œæ’åºã€‚å¦‚æœä¸­é—´æ•°æ®å¤ªå¤§æ— æ³•åœ¨å†…å­˜ä¸­å®Œæˆæ’åºï¼Œé‚£ä¹ˆå°±è¦åœ¨å¤–éƒ¨è¿›è¡Œæ’åºã€‚ </p>
</li>
<li><p>6.Reduce workerç¨‹åºéå†æ’åºåçš„ä¸­é—´æ•°æ®ï¼Œå¯¹äºæ¯ä¸€ä¸ªå”¯ä¸€çš„ä¸­é—´keyå€¼ï¼ŒReduce workerç¨‹åºå°†è¿™ä¸ªkeyå€¼å’Œå®ƒç›¸å…³çš„ä¸­é—´valueå€¼çš„é›†åˆä¼ é€’ç»™ç”¨æˆ·è‡ªå®šä¹‰çš„Reduceå‡½æ•°ã€‚Reduceå‡½æ•°çš„è¾“å‡ºè¢«è¿½åŠ åˆ°æ‰€å±åˆ†åŒºçš„è¾“å‡ºæ–‡ä»¶ã€‚</p>
</li>
<li><p>7.å½“æ‰€æœ‰çš„Mapå’ŒReduceä»»åŠ¡éƒ½å®Œæˆä¹‹åï¼Œmasterå”¤é†’ç”¨æˆ·ç¨‹åºã€‚åœ¨è¿™ä¸ªæ—¶å€™ï¼Œåœ¨ç”¨æˆ·ç¨‹åºé‡Œçš„å¯¹MapReduceè°ƒç”¨æ‰è¿”å›ã€‚</p>
</li>
</ul>
<p>åœ¨æˆåŠŸå®Œæˆä»»åŠ¡ä¹‹åï¼ŒMapReduceçš„è¾“å‡ºå­˜æ”¾åœ¨Rä¸ªè¾“å‡ºæ–‡ä»¶ä¸­ï¼ˆå¯¹åº”æ¯ä¸ªReduceä»»åŠ¡äº§ç”Ÿä¸€ä¸ªè¾“å‡ºæ–‡ä»¶ï¼Œæ–‡ä»¶åç”±ç”¨æˆ·æŒ‡å®šï¼‰ã€‚ä¸€èˆ¬æƒ…å†µ ä¸‹ï¼Œç”¨æˆ·ä¸éœ€è¦å°†è¿™Rä¸ªè¾“å‡ºæ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶â€“ä»–ä»¬ç»å¸¸æŠŠè¿™äº›æ–‡ä»¶ä½œä¸ºå¦å¤–ä¸€ä¸ªMapReduceçš„è¾“å…¥ï¼Œæˆ–è€…åœ¨å¦å¤–ä¸€ä¸ªå¯ä»¥å¤„ç†å¤šä¸ªåˆ†å‰²æ–‡ä»¶çš„åˆ†å¸ƒå¼ åº”ç”¨ä¸­ä½¿ç”¨ã€‚</p>
<h4 id="3-2ã€Masteræ•°æ®ç»“æ„"><a href="#3-2ã€Masteræ•°æ®ç»“æ„" class="headerlink" title="3.2ã€Masteræ•°æ®ç»“æ„"></a>3.2ã€Masteræ•°æ®ç»“æ„</h4><p>MasteræŒæœ‰ä¸€äº›æ•°æ®ç»“æ„ï¼Œå®ƒå­˜å‚¨æ¯ä¸€ä¸ªMapå’ŒReduceä»»åŠ¡çš„çŠ¶æ€ï¼ˆç©ºé—²ã€å·¥ä½œä¸­æˆ–å®Œæˆ)ï¼Œä»¥åŠWorkeræœºå™¨(éç©ºé—²ä»»åŠ¡çš„æœºå™¨)çš„æ ‡è¯†ã€‚</p>
<p>Masterå°±åƒä¸€ä¸ªæ•°æ®ç®¡é“ï¼Œä¸­é—´æ–‡ä»¶å­˜å‚¨åŒºåŸŸçš„ä½ç½®ä¿¡æ¯é€šè¿‡è¿™ä¸ªç®¡é“ä»Mapä¼ é€’åˆ°Reduceã€‚å› æ­¤ï¼Œå¯¹äºæ¯ä¸ªå·²ç»å®Œæˆçš„Mapä»» åŠ¡ï¼Œmasterå­˜å‚¨äº†Mapä»»åŠ¡äº§ç”Ÿçš„Rä¸ªä¸­é—´æ–‡ä»¶å­˜å‚¨åŒºåŸŸçš„å¤§å°å’Œä½ç½®ã€‚å½“Mapä»»åŠ¡å®Œæˆæ—¶ï¼ŒMasteræ¥æ”¶åˆ°ä½ç½®å’Œå¤§å°çš„æ›´æ–°ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯è¢«é€ æ­¥é€’å¢çš„æ¨é€ç»™é‚£äº›æ­£åœ¨å·¥ä½œçš„Reduceä»»åŠ¡ã€‚</p>
<h4 id="3-3ã€å®¹é”™"><a href="#3-3ã€å®¹é”™" class="headerlink" title="3.3ã€å®¹é”™"></a>3.3ã€å®¹é”™</h4><p>å› ä¸ºMapReduceåº“çš„è®¾è®¡åˆè¡·æ˜¯ä½¿ç”¨ç”±æˆç™¾ä¸Šåƒçš„æœºå™¨ç»„æˆçš„é›†ç¾¤æ¥å¤„ç†è¶…å¤§è§„æ¨¡çš„æ•°æ®ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªåº“å¿…é¡»è¦èƒ½å¾ˆå¥½çš„å¤„ç†æœºå™¨æ•…éšœã€‚</p>
<ul>
<li><strong>workeræ•…éšœ:</strong></li>
</ul>
<p>masterå‘¨æœŸæ€§çš„pingæ¯ä¸ªworkerã€‚å¦‚æœåœ¨ä¸€ä¸ªçº¦å®šçš„æ—¶é—´èŒƒå›´å†…æ²¡æœ‰æ”¶åˆ°workerè¿”å›çš„ä¿¡æ¯ï¼Œmasterå°†æŠŠè¿™ä¸ª workeræ ‡è®°ä¸ºå¤±æ•ˆã€‚æ‰€æœ‰ç”±è¿™ä¸ªå¤±æ•ˆçš„workerå®Œæˆçš„Mapä»»åŠ¡è¢«é‡è®¾ä¸ºåˆå§‹çš„ç©ºé—²çŠ¶æ€ï¼Œä¹‹åè¿™äº›ä»»åŠ¡å°±å¯ä»¥è¢«å®‰æ’ç»™å…¶ä»–çš„workerã€‚åŒæ · çš„ï¼Œworkerå¤±æ•ˆæ—¶æ­£åœ¨è¿è¡Œçš„Mapæˆ–Reduceä»»åŠ¡ä¹Ÿå°†è¢«é‡æ–°ç½®ä¸ºç©ºé—²çŠ¶æ€ï¼Œç­‰å¾…é‡æ–°è°ƒåº¦ã€‚</p>
<p>å½“workeræ•…éšœæ—¶ï¼Œç”±äºå·²ç»å®Œæˆçš„Mapä»»åŠ¡çš„è¾“å‡ºå­˜å‚¨åœ¨è¿™å°æœºå™¨ä¸Šï¼ŒMapä»»åŠ¡çš„è¾“å‡ºå·²ä¸å¯è®¿é—®äº†ï¼Œå› æ­¤å¿…é¡»é‡æ–°æ‰§è¡Œã€‚è€Œå·²ç»å®Œæˆçš„Reduceä»»åŠ¡çš„è¾“å‡ºå­˜å‚¨åœ¨å…¨å±€æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œå› æ­¤ä¸éœ€è¦å†æ¬¡æ‰§è¡Œã€‚</p>
<p>å½“ä¸€ä¸ªMapä»»åŠ¡é¦–å…ˆè¢«worker Aæ‰§è¡Œï¼Œä¹‹åç”±äºworker Aå¤±æ•ˆäº†åˆè¢«è°ƒåº¦åˆ°worker Bæ‰§è¡Œï¼Œè¿™ä¸ªâ€œé‡æ–°æ‰§è¡Œâ€çš„åŠ¨ä½œä¼šè¢«é€šçŸ¥ç»™æ‰€æœ‰æ‰§è¡ŒReduceä»»åŠ¡çš„workerã€‚ä»»ä½•è¿˜æ²¡æœ‰ä»worker Aè¯»å–æ•°æ®çš„Reduceä»»åŠ¡å°†ä»worker Bè¯»å–æ•°æ®ã€‚</p>
<p>MapReduceå¯ä»¥å¤„ç†å¤§è§„æ¨¡workerå¤±æ•ˆçš„æƒ…å†µã€‚æ¯”å¦‚ï¼Œåœ¨ä¸€ä¸ªMapReduceæ“ä½œæ‰§è¡ŒæœŸé—´ï¼Œåœ¨æ­£åœ¨è¿è¡Œçš„é›†ç¾¤ä¸Šè¿›è¡Œç½‘ç»œç»´æŠ¤å¼•èµ· 80å°æœºå™¨åœ¨å‡ åˆ†é’Ÿå†…ä¸å¯è®¿é—®äº†ï¼ŒMapReduce masteråªéœ€è¦ç®€å•çš„å†æ¬¡æ‰§è¡Œé‚£äº›ä¸å¯è®¿é—®çš„workerå®Œæˆçš„å·¥ä½œï¼Œä¹‹åç»§ç»­æ‰§è¡Œæœªå®Œæˆçš„ä»»åŠ¡ï¼Œç›´åˆ°æœ€ç»ˆå®Œæˆè¿™ä¸ªMapReduceæ“ä½œã€‚</p>
<ul>
<li><strong>masterå¤±è´¥ </strong></li>
</ul>
<p>ä¸€ä¸ªç®€å•çš„è§£å†³åŠæ³•æ˜¯è®©masterå‘¨æœŸæ€§çš„å°†ä¸Šé¢æè¿°çš„æ•°æ®ç»“æ„ ï¼ˆalexæ³¨ï¼šæŒ‡3.2èŠ‚ï¼‰çš„ å†™å…¥ç£ç›˜ï¼Œå³æ£€æŸ¥ç‚¹ï¼ˆcheckpointï¼‰ã€‚å¦‚æœè¿™ä¸ªmasterä»»åŠ¡å¤±æ•ˆäº†ï¼Œå¯ä»¥ä»æœ€åä¸€ä¸ªæ£€æŸ¥ç‚¹ï¼ˆcheckpointï¼‰å¼€å§‹å¯åŠ¨å¦ä¸€ä¸ª masterè¿›ç¨‹ã€‚ç„¶è€Œï¼Œç”±äºåªæœ‰ä¸€ä¸ªmasterè¿›ç¨‹ï¼Œmasterå¤±æ•ˆåå†æ¢å¤æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œå› æ­¤æˆ‘ä»¬ç°åœ¨çš„å®ç°æ˜¯å¦‚æœmasterå¤±æ•ˆï¼Œå°±ä¸­æ­¢ MapReduceè¿ç®—ã€‚å®¢æˆ·å¯ä»¥æ£€æŸ¥åˆ°è¿™ä¸ªçŠ¶æ€ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®éœ€è¦é‡æ–°æ‰§è¡ŒMapReduceæ“ä½œã€‚</p>
<ul>
<li><strong>åœ¨å¤±æ•ˆæ–¹é¢çš„å¤„ç†æœºåˆ¶</strong></li>
</ul>
<p>å½“ç”¨æˆ·æä¾›çš„Mapå’ŒReduceæ“ä½œæ˜¯è¾“å…¥ç¡®å®šæ€§å‡½æ•°ï¼ˆå³ç›¸åŒçš„è¾“å…¥äº§ç”Ÿç›¸åŒçš„è¾“å‡ºï¼‰æ—¶ï¼Œæˆ‘ä»¬çš„åˆ†å¸ƒå¼å®ç°åœ¨ä»»ä½•æƒ…å†µä¸‹çš„è¾“å‡ºéƒ½å’Œæ‰€æœ‰ç¨‹åºæ²¡æœ‰å‡ºç°ä»»ä½•é”™è¯¯ã€é¡ºåºçš„æ‰§è¡Œäº§ç”Ÿçš„è¾“å‡ºæ˜¯ä¸€æ ·çš„ã€‚</p>
<p>æˆ‘ä»¬ä¾èµ–å¯¹Mapå’ŒReduceä»»åŠ¡çš„è¾“å‡ºæ˜¯åŸå­æäº¤çš„æ¥å®Œæˆè¿™ä¸ªç‰¹æ€§ã€‚æ¯ä¸ªå·¥ä½œä¸­çš„ä»»åŠ¡æŠŠå®ƒçš„è¾“å‡ºå†™åˆ°ç§æœ‰çš„ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚æ¯ä¸ªReduceä»» åŠ¡ç”Ÿæˆä¸€ä¸ªè¿™æ ·çš„æ–‡ä»¶ï¼Œè€Œæ¯ä¸ªMapä»»åŠ¡åˆ™ç”ŸæˆRä¸ªè¿™æ ·çš„æ–‡ä»¶ï¼ˆä¸€ä¸ªReduceä»»åŠ¡å¯¹åº”ä¸€ä¸ªæ–‡ä»¶ï¼‰ã€‚å½“ä¸€ä¸ªMapä»»åŠ¡å®Œæˆçš„æ—¶ï¼Œworkerå‘é€ä¸€ä¸ªåŒ… å«Rä¸ªä¸´æ—¶æ–‡ä»¶åçš„å®Œæˆæ¶ˆæ¯ç»™masterã€‚å¦‚æœmasterä»ä¸€ä¸ªå·²ç»å®Œæˆçš„Mapä»»åŠ¡å†æ¬¡æ¥æ”¶åˆ°åˆ°ä¸€ä¸ªå®Œæˆæ¶ˆæ¯ï¼Œmasterå°†å¿½ç•¥è¿™ä¸ªæ¶ˆæ¯ï¼›å¦ åˆ™ï¼Œmasterå°†è¿™Rä¸ªæ–‡ä»¶çš„åå­—è®°å½•åœ¨æ•°æ®ç»“æ„é‡Œã€‚</p>
<p>å½“Reduceä»»åŠ¡å®Œæˆæ—¶ï¼ŒReduce workerè¿›ç¨‹ä»¥åŸå­çš„æ–¹å¼æŠŠä¸´æ—¶æ–‡ä»¶é‡å‘½åä¸ºæœ€ç»ˆçš„è¾“å‡ºæ–‡ä»¶ã€‚å¦‚æœåŒä¸€ä¸ªReduceä»»åŠ¡åœ¨å¤šå°æœºå™¨ä¸Šæ‰§è¡Œï¼Œé’ˆå¯¹åŒä¸€ä¸ªæœ€ç»ˆçš„è¾“å‡ºæ–‡ä»¶å°†æœ‰å¤šä¸ªé‡å‘½å æ“ä½œæ‰§è¡Œã€‚æˆ‘ä»¬ä¾èµ–åº•å±‚æ–‡ä»¶ç³»ç»Ÿæä¾›çš„é‡å‘½åæ“ä½œçš„åŸå­æ€§æ¥ä¿è¯æœ€ç»ˆçš„æ–‡ä»¶ç³»ç»ŸçŠ¶æ€ä»…ä»…åŒ…å«ä¸€ä¸ªReduceä»»åŠ¡äº§ç”Ÿçš„æ•°æ®ã€‚</p>
<p>ä½¿ç”¨MapReduceæ¨¡å‹çš„ç¨‹åºå‘˜å¯ä»¥å¾ˆå®¹æ˜“çš„ç†è§£ä»–ä»¬ç¨‹åºçš„è¡Œä¸ºï¼Œå› ä¸ºæˆ‘ä»¬ç»å¤§å¤šæ•°çš„Mapå’ŒReduceæ“ä½œæ˜¯ç¡®å®šæ€§çš„ï¼Œè€Œä¸”å­˜åœ¨è¿™æ ·çš„ä¸€ä¸ª äº‹å®ï¼šæˆ‘ä»¬çš„å¤±æ•ˆå¤„ç†æœºåˆ¶ç­‰ä»·äºä¸€ä¸ªé¡ºåºçš„æ‰§è¡Œçš„æ“ä½œã€‚å½“Mapæˆ–/å’ŒReduceæ“ä½œæ˜¯ä¸ç¡®å®šæ€§çš„æ—¶å€™ï¼Œæˆ‘ä»¬æä¾›è™½ç„¶è¾ƒå¼±ä½†æ˜¯ä¾ç„¶åˆç†çš„å¤„ç†æœºåˆ¶ã€‚å½“ä½¿ ç”¨éç¡®å®šæ“ä½œçš„æ—¶å€™ï¼Œä¸€ä¸ªReduceä»»åŠ¡R1çš„è¾“å‡ºç­‰ä»·äºä¸€ä¸ªéç¡®å®šæ€§ç¨‹åºé¡ºåºæ‰§è¡Œäº§ç”Ÿæ—¶çš„è¾“å‡ºã€‚ä½†æ˜¯ï¼Œå¦ä¸€ä¸ªReduceä»»åŠ¡R2çš„è¾“å‡ºä¹Ÿè®¸ç¬¦åˆä¸€ä¸ª ä¸åŒçš„éç¡®å®šé¡ºåºç¨‹åºæ‰§è¡Œäº§ç”Ÿçš„R2çš„è¾“å‡ºã€‚</p>
<p>è€ƒè™‘Mapä»»åŠ¡Må’ŒReduceä»»åŠ¡R1ã€R2çš„æƒ…å†µã€‚æˆ‘ä»¬è®¾å®še(Ri)æ˜¯Riå·²ç»æäº¤çš„æ‰§è¡Œè¿‡ç¨‹ï¼ˆæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªè¿™æ ·çš„æ‰§è¡Œè¿‡ç¨‹ï¼‰ã€‚å½“e(R1)è¯»å–äº†ç”±Mä¸€æ¬¡æ‰§è¡Œäº§ç”Ÿçš„è¾“å‡ºï¼Œè€Œe(R2)è¯»å–äº†ç”±Mçš„å¦ä¸€æ¬¡æ‰§è¡Œäº§ç”Ÿçš„è¾“å‡ºï¼Œå¯¼è‡´äº†è¾ƒå¼±çš„å¤±æ•ˆå¤„ç†ã€‚</p>
<h4 id="3-4ã€å­˜å‚¨ä½ç½®"><a href="#3-4ã€å­˜å‚¨ä½ç½®" class="headerlink" title="3.4ã€å­˜å‚¨ä½ç½®"></a>3.4ã€å­˜å‚¨ä½ç½®</h4><p>åœ¨æˆ‘ä»¬çš„è®¡ç®—è¿è¡Œç¯å¢ƒä¸­ï¼Œç½‘ç»œå¸¦å®½æ˜¯ä¸€ä¸ªç›¸å½“åŒ®ä¹çš„èµ„æºã€‚æˆ‘ä»¬é€šè¿‡å°½é‡æŠŠè¾“å…¥æ•°æ®(ç”±GFSç®¡ç†)å­˜å‚¨åœ¨é›†ç¾¤ä¸­æœºå™¨çš„æœ¬åœ°ç£ç›˜ä¸Šæ¥èŠ‚çœç½‘ç»œå¸¦ å®½ã€‚GFSæŠŠæ¯ä¸ªæ–‡ä»¶æŒ‰64MBä¸€ä¸ªBlockåˆ†éš”ï¼Œæ¯ä¸ªBlockä¿å­˜åœ¨å¤šå°æœºå™¨ä¸Šï¼Œç¯å¢ƒä¸­å°±å­˜æ”¾äº†å¤šä»½æ‹·è´(ä¸€èˆ¬æ˜¯3ä¸ªæ‹·è´)ã€‚MapReduceçš„ masteråœ¨è°ƒåº¦Mapä»»åŠ¡æ—¶ä¼šè€ƒè™‘è¾“å…¥æ–‡ä»¶çš„ä½ç½®ä¿¡æ¯ï¼Œå°½é‡å°†ä¸€ä¸ªMapä»»åŠ¡è°ƒåº¦åœ¨åŒ…å«ç›¸å…³è¾“å…¥æ•°æ®æ‹·è´çš„æœºå™¨ä¸Šæ‰§è¡Œï¼›å¦‚æœä¸Šè¿°åŠªåŠ›å¤±è´¥ äº†ï¼Œmasterå°†å°è¯•åœ¨ä¿å­˜æœ‰è¾“å…¥æ•°æ®æ‹·è´çš„æœºå™¨é™„è¿‘çš„æœºå™¨ä¸Šæ‰§è¡ŒMapä»»åŠ¡(ä¾‹å¦‚ï¼Œåˆ†é…åˆ°ä¸€ä¸ªå’ŒåŒ…å«è¾“å…¥æ•°æ®çš„æœºå™¨åœ¨ä¸€ä¸ªswitché‡Œçš„ workeræœºå™¨ä¸Šæ‰§è¡Œ)ã€‚å½“åœ¨ä¸€ä¸ªè¶³å¤Ÿå¤§çš„clusteré›†ç¾¤ä¸Šè¿è¡Œå¤§å‹MapReduceæ“ä½œçš„æ—¶å€™ï¼Œå¤§éƒ¨åˆ†çš„è¾“å…¥æ•°æ®éƒ½èƒ½ä»æœ¬åœ°æœºå™¨è¯»å–ï¼Œå› æ­¤æ¶ˆè€— éå¸¸å°‘çš„ç½‘ç»œå¸¦å®½ã€‚</p>
<h4 id="3-5ã€ä»»åŠ¡ç²’åº¦"><a href="#3-5ã€ä»»åŠ¡ç²’åº¦" class="headerlink" title="3.5ã€ä»»åŠ¡ç²’åº¦"></a>3.5ã€ä»»åŠ¡ç²’åº¦</h4><p>å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬æŠŠMapæ‹†åˆ†æˆäº†Mä¸ªç‰‡æ®µã€æŠŠReduceæ‹†åˆ†æˆRä¸ªç‰‡æ®µæ‰§è¡Œã€‚ç†æƒ³æƒ…å†µä¸‹ï¼ŒMå’ŒRåº”å½“æ¯”é›†ç¾¤ä¸­workerçš„æœºå™¨æ•°é‡è¦å¤šå¾— å¤šã€‚åœ¨æ¯å°workeræœºå™¨éƒ½æ‰§è¡Œå¤§é‡çš„ä¸åŒä»»åŠ¡èƒ½å¤Ÿæé«˜é›†ç¾¤çš„åŠ¨æ€çš„è´Ÿè½½å‡è¡¡èƒ½åŠ›ï¼Œå¹¶ä¸”èƒ½å¤ŸåŠ å¿«æ•…éšœæ¢å¤çš„é€Ÿåº¦ï¼šå¤±æ•ˆæœºå™¨ä¸Šæ‰§è¡Œçš„å¤§é‡Mapä»»åŠ¡éƒ½å¯ä»¥ åˆ†å¸ƒåˆ°æ‰€æœ‰å…¶ä»–çš„workeræœºå™¨ä¸Šå»æ‰§è¡Œã€‚</p>
<p>ä½†æ˜¯å®é™…ä¸Šï¼Œåœ¨æˆ‘ä»¬çš„å…·ä½“å®ç°ä¸­å¯¹Må’ŒRçš„å–å€¼éƒ½æœ‰ä¸€å®šçš„å®¢è§‚é™åˆ¶ï¼Œå› ä¸ºmasterå¿…é¡»æ‰§è¡ŒO(M+R)æ¬¡è°ƒåº¦ï¼Œå¹¶ä¸”åœ¨å†…å­˜ä¸­ä¿å­˜O(M <em> R)ä¸ªçŠ¶æ€ï¼ˆå¯¹å½±å“å†…å­˜ä½¿ç”¨çš„å› ç´ è¿˜æ˜¯æ¯”è¾ƒå°çš„ï¼šO(M </em> R)å—çŠ¶æ€ï¼Œå¤§æ¦‚æ¯å¯¹Mapä»»åŠ¡/Reduceä»»åŠ¡1ä¸ªå­—èŠ‚å°±å¯ä»¥äº†ï¼‰ã€‚</p>
<p>æ›´è¿›ä¸€æ­¥ï¼ŒRå€¼é€šå¸¸æ˜¯ç”±ç”¨æˆ·æŒ‡å®šçš„ï¼Œå› ä¸ºæ¯ä¸ªReduceä»»åŠ¡æœ€ç»ˆéƒ½ä¼šç”Ÿæˆä¸€ä¸ªç‹¬ç«‹çš„è¾“å‡ºæ–‡ä»¶ã€‚å®é™…ä½¿ç”¨æ—¶æˆ‘ä»¬ä¹Ÿå€¾å‘äºé€‰æ‹©åˆé€‚çš„Må€¼ï¼Œä»¥ä½¿å¾— æ¯ä¸€ä¸ªç‹¬ç«‹ä»»åŠ¡éƒ½æ˜¯å¤„ç†å¤§çº¦16Måˆ°64Mçš„è¾“å…¥æ•°æ®ï¼ˆè¿™æ ·ï¼Œä¸Šé¢æå†™çš„è¾“å…¥æ•°æ®æœ¬åœ°å­˜å‚¨ä¼˜åŒ–ç­–ç•¥æ‰æœ€æœ‰æ•ˆï¼‰ï¼Œå¦å¤–ï¼Œæˆ‘ä»¬æŠŠRå€¼è®¾ç½®ä¸ºæˆ‘ä»¬æƒ³ä½¿ç”¨çš„ workeræœºå™¨æ•°é‡çš„å°çš„å€æ•°ã€‚æˆ‘ä»¬é€šå¸¸ä¼šç”¨è¿™æ ·çš„æ¯”ä¾‹æ¥æ‰§è¡ŒMapReduceï¼šM=200000ï¼ŒR=5000ï¼Œä½¿ç”¨2000å°workeræœºå™¨ã€‚</p>
<h4 id="3-6ã€å¤‡ç”¨ä»»åŠ¡"><a href="#3-6ã€å¤‡ç”¨ä»»åŠ¡" class="headerlink" title="3.6ã€å¤‡ç”¨ä»»åŠ¡"></a>3.6ã€å¤‡ç”¨ä»»åŠ¡</h4><p>å½±å“ä¸€ä¸ªMapReduceçš„æ€»æ‰§è¡Œæ—¶é—´æœ€é€šå¸¸çš„å› ç´ æ˜¯â€œè½ä¼è€…â€ï¼šåœ¨è¿ç®—è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰ä¸€å°æœºå™¨èŠ±äº†å¾ˆé•¿çš„æ—¶é—´æ‰å®Œæˆæœ€åå‡ ä¸ªMapæˆ–Reduceä»»åŠ¡ï¼Œå¯¼è‡´MapReduceæ“ä½œæ€»çš„æ‰§è¡Œæ—¶é—´è¶…è¿‡é¢„æœŸã€‚å‡ºç°â€œè½ä¼è€…â€çš„åŸå› éå¸¸å¤šã€‚æ¯”å¦‚ï¼šå¦‚æœä¸€ä¸ªæœºå™¨çš„ç¡¬ç›˜å‡ºäº†é—®é¢˜ï¼Œåœ¨è¯»å–çš„æ—¶å€™è¦ç» å¸¸çš„è¿›è¡Œè¯»å–çº é”™æ“ä½œï¼Œå¯¼è‡´è¯»å–æ•°æ®çš„é€Ÿåº¦ä»30M/sé™ä½åˆ°1M/sã€‚å¦‚æœclusterçš„è°ƒåº¦ç³»ç»Ÿåœ¨è¿™å°æœºå™¨ä¸Šåˆè°ƒåº¦äº†å…¶ä»–çš„ä»»åŠ¡ï¼Œç”±äºCPUã€å†…å­˜ã€æœ¬åœ°ç¡¬ç›˜å’Œç½‘ç»œå¸¦å®½ç­‰ç«äº‰å› ç´ çš„å­˜åœ¨ï¼Œå¯¼è‡´æ‰§è¡ŒMapReduceä»£ç çš„æ‰§è¡Œæ•ˆç‡æ›´åŠ ç¼“æ…¢ã€‚æˆ‘ä»¬æœ€è¿‘é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜æ˜¯ç”±äºæœºå™¨çš„åˆå§‹åŒ–ä»£ç æœ‰bugï¼Œå¯¼è‡´å…³é—­äº†çš„å¤„ç†å™¨çš„ç¼“å­˜ï¼šåœ¨è¿™äº›æœºå™¨ä¸Šæ‰§è¡Œä»»åŠ¡çš„æ€§èƒ½å’Œæ­£å¸¸æƒ…å†µç›¸å·®ä¸Šç™¾å€ã€‚</p>
<p>æˆ‘ä»¬æœ‰ä¸€ä¸ªé€šç”¨çš„æœºåˆ¶æ¥å‡å°‘â€œè½ä¼è€…â€å‡ºç°çš„æƒ…å†µã€‚å½“ä¸€ä¸ªMapReduceæ“ä½œæ¥è¿‘å®Œæˆçš„æ—¶å€™ï¼Œmasterè°ƒåº¦å¤‡ç”¨ï¼ˆbackupï¼‰ä»»åŠ¡è¿› ç¨‹æ¥æ‰§è¡Œå‰©ä¸‹çš„ã€å¤„äºå¤„ç†ä¸­çŠ¶æ€ï¼ˆin-progressï¼‰çš„ä»»åŠ¡ã€‚æ— è®ºæ˜¯æœ€åˆçš„æ‰§è¡Œè¿›ç¨‹ã€è¿˜æ˜¯å¤‡ç”¨ï¼ˆbackupï¼‰ä»»åŠ¡è¿›ç¨‹å®Œæˆäº†ä»»åŠ¡ï¼Œæˆ‘ä»¬éƒ½æŠŠè¿™ä¸ªä»» åŠ¡æ ‡è®°æˆä¸ºå·²ç»å®Œæˆã€‚æˆ‘ä»¬è°ƒä¼˜äº†è¿™ä¸ªæœºåˆ¶ï¼Œé€šå¸¸åªä¼šå ç”¨æ¯”æ­£å¸¸æ“ä½œå¤šå‡ ä¸ªç™¾åˆ†ç‚¹çš„è®¡ç®—èµ„æºã€‚æˆ‘ä»¬å‘ç°é‡‡ç”¨è¿™æ ·çš„æœºåˆ¶å¯¹äºå‡å°‘è¶…å¤§MapReduceæ“ä½œçš„ æ€»å¤„ç†æ—¶é—´æ•ˆæœæ˜¾è‘—ã€‚ä¾‹å¦‚ï¼Œåœ¨5.3èŠ‚æè¿°çš„æ’åºä»»åŠ¡ï¼Œåœ¨å…³é—­æ‰å¤‡ç”¨ä»»åŠ¡çš„æƒ…å†µä¸‹è¦å¤šèŠ±44%çš„æ—¶é—´å®Œæˆæ’åºä»»åŠ¡ã€‚</p>
<h3 id="4ã€æŠ€å·§"><a href="#4ã€æŠ€å·§" class="headerlink" title="4ã€æŠ€å·§"></a>4ã€æŠ€å·§</h3><p>è™½ç„¶ç®€å•çš„Mapå’ŒReduceå‡½æ•°æä¾›çš„åŸºæœ¬åŠŸèƒ½å·²ç»èƒ½å¤Ÿæ»¡è¶³å¤§éƒ¨åˆ†çš„è®¡ç®—éœ€è¦ï¼Œæˆ‘ä»¬è¿˜æ˜¯å‘æ˜å‡ºäº†ä¸€äº›æœ‰ä»·å€¼çš„æ‰©å±•åŠŸèƒ½ã€‚æœ¬èŠ‚å°†æè¿°è¿™äº›æ‰©å±•åŠŸèƒ½ã€‚</p>
<h4 id="4-1ã€åˆ†åŒºå‡½æ•°"><a href="#4-1ã€åˆ†åŒºå‡½æ•°" class="headerlink" title="4.1ã€åˆ†åŒºå‡½æ•°"></a>4.1ã€åˆ†åŒºå‡½æ•°</h4><p>MapReduceçš„ä½¿ç”¨è€…é€šå¸¸ä¼šæŒ‡å®šReduceä»»åŠ¡å’ŒReduceä»»åŠ¡è¾“å‡ºæ–‡ä»¶çš„æ•°é‡ï¼ˆRï¼‰ã€‚æˆ‘ä»¬åœ¨ä¸­é—´keyä¸Šä½¿ç”¨åˆ†åŒºå‡½æ•°æ¥å¯¹æ•°æ®è¿›è¡Œ åˆ†åŒºï¼Œä¹‹åå†è¾“å…¥åˆ°åç»­ä»»åŠ¡æ‰§è¡Œè¿›ç¨‹ã€‚ä¸€ä¸ªç¼ºçœçš„åˆ†åŒºå‡½æ•°æ˜¯ä½¿ç”¨hashæ–¹æ³•(æ¯”å¦‚ï¼Œhash(key) mod R)è¿›è¡Œåˆ†åŒºã€‚hashæ–¹æ³•èƒ½äº§ç”Ÿéå¸¸å¹³è¡¡çš„åˆ†åŒºã€‚ç„¶è€Œï¼Œæœ‰çš„æ—¶å€™ï¼Œå…¶å®ƒçš„ä¸€äº›åˆ†åŒºå‡½æ•°å¯¹keyå€¼è¿›è¡Œçš„åˆ†åŒºå°†éå¸¸æœ‰ç”¨ã€‚æ¯”å¦‚ï¼Œè¾“å‡ºçš„keyå€¼æ˜¯URLsï¼Œæˆ‘ä»¬å¸Œæœ›æ¯ä¸ªä¸»æœºçš„æ‰€æœ‰æ¡ç›®ä¿æŒåœ¨åŒä¸€ä¸ªè¾“å‡ºæ–‡ä»¶ä¸­ã€‚ä¸ºäº†æ”¯æŒç±»ä¼¼çš„æƒ…å†µï¼ŒMapReduceåº“çš„ç”¨æˆ·éœ€è¦æä¾›ä¸“é—¨çš„åˆ†åŒºå‡½æ•°ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ â€œhash(Hostname(urlkey)) mod Râ€ä½œä¸ºåˆ†åŒºå‡½æ•°å°±å¯ä»¥æŠŠæ‰€æœ‰æ¥è‡ªåŒä¸€ä¸ªä¸»æœºçš„URLsä¿å­˜åœ¨åŒä¸€ä¸ªè¾“å‡ºæ–‡ä»¶ä¸­ã€‚</p>
<h4 id="4-2ã€é¡ºåºä¿è¯"><a href="#4-2ã€é¡ºåºä¿è¯" class="headerlink" title="4.2ã€é¡ºåºä¿è¯"></a>4.2ã€é¡ºåºä¿è¯</h4><p>æˆ‘ä»¬ç¡®ä¿åœ¨ç»™å®šçš„åˆ†åŒºä¸­ï¼Œä¸­é—´key/value pairæ•°æ®çš„å¤„ç†é¡ºåºæ˜¯æŒ‰ç…§keyå€¼å¢é‡é¡ºåºå¤„ç†çš„ã€‚è¿™æ ·çš„é¡ºåºä¿è¯å¯¹æ¯ä¸ªåˆ†æˆç”Ÿæˆä¸€ä¸ªæœ‰åºçš„è¾“å‡ºæ–‡ä»¶ï¼Œè¿™å¯¹äºéœ€è¦å¯¹è¾“å‡ºæ–‡ä»¶æŒ‰keyå€¼éšæœºå­˜å–çš„åº”ç”¨éå¸¸æœ‰æ„ä¹‰ï¼Œå¯¹åœ¨æ’åºè¾“å‡ºçš„æ•°æ®é›†ä¹Ÿå¾ˆæœ‰å¸®åŠ©ã€‚</p>
<h4 id="4-3ã€Combinerå‡½æ•°"><a href="#4-3ã€Combinerå‡½æ•°" class="headerlink" title="4.3ã€Combinerå‡½æ•°"></a>4.3ã€Combinerå‡½æ•°</h4><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒMapå‡½æ•°äº§ç”Ÿçš„ä¸­é—´keyå€¼çš„é‡å¤æ•°æ®ä¼šå å¾ˆå¤§çš„æ¯”é‡ï¼Œå¹¶ä¸”ï¼Œç”¨æˆ·è‡ªå®šä¹‰çš„Reduceå‡½æ•°æ»¡è¶³ç»“åˆå¾‹å’Œäº¤æ¢å¾‹ã€‚åœ¨2.1èŠ‚çš„ è¯æ•°ç»Ÿè®¡ç¨‹åºæ˜¯ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚ç”±äºè¯é¢‘ç‡å€¾å‘äºä¸€ä¸ªzipfåˆ†å¸ƒ(é½å¤«åˆ†å¸ƒ)ï¼Œæ¯ä¸ªMapä»»åŠ¡å°†äº§ç”Ÿæˆåƒä¸Šä¸‡ä¸ªè¿™æ ·çš„è®°å½•ã€‚æ‰€ æœ‰çš„è¿™äº›è®°å½•å°†é€šè¿‡ç½‘ç»œè¢«å‘é€åˆ°ä¸€ä¸ªå•ç‹¬çš„Reduceä»»åŠ¡ï¼Œç„¶åç”±è¿™ä¸ªReduceä»»åŠ¡æŠŠæ‰€æœ‰è¿™äº›è®°å½•ç´¯åŠ èµ·æ¥äº§ç”Ÿä¸€ä¸ªæ•°å­—ã€‚æˆ‘ä»¬å…è®¸ç”¨æˆ·æŒ‡å®šä¸€ä¸ªå¯é€‰ çš„combinerå‡½æ•°ï¼Œcombinerå‡½æ•°é¦–å…ˆåœ¨æœ¬åœ°å°†è¿™äº›è®°å½•è¿›è¡Œä¸€æ¬¡åˆå¹¶ï¼Œç„¶åå°†åˆå¹¶çš„ç»“æœå†é€šè¿‡ç½‘ç»œå‘é€å‡ºå»ã€‚</p>
<p>Combinerå‡½æ•°åœ¨æ¯å°æ‰§è¡ŒMapä»»åŠ¡çš„æœºå™¨ä¸Šéƒ½ä¼šè¢«æ‰§è¡Œä¸€æ¬¡ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒCombinerå’ŒReduceå‡½æ•°æ˜¯ä¸€æ ·çš„ã€‚ Combinerå‡½æ•°å’ŒReduceå‡½æ•°ä¹‹é—´å”¯ä¸€çš„åŒºåˆ«æ˜¯MapReduceåº“æ€æ ·æ§åˆ¶å‡½æ•°çš„è¾“å‡ºã€‚Reduceå‡½æ•°çš„è¾“å‡ºè¢«ä¿å­˜åœ¨æœ€ç»ˆçš„è¾“å‡ºæ–‡ä»¶é‡Œï¼Œè€Œ Combinerå‡½æ•°çš„è¾“å‡ºè¢«å†™åˆ°ä¸­é—´æ–‡ä»¶é‡Œï¼Œç„¶åè¢«å‘é€ç»™Reduceä»»åŠ¡ã€‚</p>
<p>éƒ¨åˆ†çš„åˆå¹¶ä¸­é—´ç»“æœå¯ä»¥æ˜¾è‘—çš„æé«˜ä¸€äº›MapReduceæ“ä½œçš„é€Ÿåº¦ã€‚é™„å½•AåŒ…å«ä¸€ä¸ªä½¿ç”¨combinerå‡½æ•°çš„ä¾‹å­ã€‚</p>
<h4 id="4-4ã€è¾“å…¥å’Œè¾“å‡ºçš„ç±»å‹"><a href="#4-4ã€è¾“å…¥å’Œè¾“å‡ºçš„ç±»å‹" class="headerlink" title="4.4ã€è¾“å…¥å’Œè¾“å‡ºçš„ç±»å‹"></a>4.4ã€è¾“å…¥å’Œè¾“å‡ºçš„ç±»å‹</h4><p>MapReduceåº“æ”¯æŒå‡ ç§ä¸åŒçš„æ ¼å¼çš„è¾“å…¥æ•°æ®ã€‚æ¯”å¦‚ï¼Œæ–‡æœ¬æ¨¡å¼çš„è¾“å…¥æ•°æ®çš„æ¯ä¸€è¡Œè¢«è§†ä¸ºæ˜¯ä¸€ä¸ªkey/value pairã€‚keyæ˜¯æ–‡ä»¶çš„åç§»é‡ï¼Œvalueæ˜¯é‚£ä¸€è¡Œçš„å†…å®¹ã€‚å¦å¤–ä¸€ç§å¸¸è§çš„æ ¼å¼æ˜¯ä»¥keyè¿›è¡Œæ’åºæ¥å­˜å‚¨çš„key/value pairçš„åºåˆ—ã€‚æ¯ç§è¾“å…¥ç±»å‹çš„å®ç°éƒ½å¿…é¡»èƒ½å¤ŸæŠŠè¾“å…¥æ•°æ®åˆ†å‰²æˆæ•°æ®ç‰‡æ®µï¼Œè¯¥æ•°æ®ç‰‡æ®µèƒ½å¤Ÿç”±å•ç‹¬çš„Mapä»»åŠ¡æ¥è¿›è¡Œåç»­å¤„ç†(ä¾‹å¦‚ï¼Œæ–‡æœ¬æ¨¡å¼çš„èŒƒå›´åˆ†å‰²å¿… é¡»ç¡®ä¿ä»…ä»…åœ¨æ¯è¡Œçš„è¾¹ç•Œè¿›è¡ŒèŒƒå›´åˆ†å‰²)ã€‚è™½ç„¶å¤§å¤šæ•°MapReduceçš„ä½¿ç”¨è€…ä»…ä»…ä½¿ç”¨å¾ˆå°‘çš„é¢„å®šä¹‰è¾“å…¥ç±»å‹å°±æ»¡è¶³è¦æ±‚äº†ï¼Œä½†æ˜¯ä½¿ç”¨è€…ä¾ç„¶å¯ä»¥é€šè¿‡æä¾›ä¸€ ä¸ªç®€å•çš„Readeræ¥å£å®ç°å°±èƒ½å¤Ÿæ”¯æŒä¸€ä¸ªæ–°çš„è¾“å…¥ç±»å‹ã€‚</p>
<p>Readerå¹¶éä¸€å®šè¦ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªä»æ•°æ®åº“é‡Œè¯»è®°å½•çš„Readerï¼Œæˆ–è€…ä»å†…å­˜ä¸­çš„æ•°æ®ç»“æ„è¯»å–æ•°æ®çš„Readerã€‚</p>
<p>ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€äº›é¢„å®šä¹‰çš„è¾“å‡ºæ•°æ®çš„ç±»å‹ï¼Œé€šè¿‡è¿™äº›é¢„å®šä¹‰ç±»å‹èƒ½å¤Ÿäº§ç”Ÿä¸åŒæ ¼å¼çš„æ•°æ®ã€‚ç”¨æˆ·é‡‡ç”¨ç±»ä¼¼æ·»åŠ æ–°çš„è¾“å…¥æ•°æ®ç±»å‹çš„æ–¹å¼å¢åŠ æ–°çš„è¾“å‡ºç±»å‹ã€‚</p>
<h4 id="4-5ã€å‰¯ä½œç”¨"><a href="#4-5ã€å‰¯ä½œç”¨" class="headerlink" title="4.5ã€å‰¯ä½œç”¨"></a>4.5ã€å‰¯ä½œç”¨</h4><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒMapReduceçš„ä½¿ç”¨è€…å‘ç°ï¼Œå¦‚æœåœ¨Mapå’Œ/æˆ–Reduceæ“ä½œè¿‡ç¨‹ä¸­å¢åŠ è¾…åŠ©çš„è¾“å‡ºæ–‡ä»¶ä¼šæ¯”è¾ƒçœäº‹ã€‚æˆ‘ä»¬ä¾é ç¨‹åºwriteræŠŠè¿™ç§â€œå‰¯ä½œç”¨â€å˜æˆåŸå­çš„å’Œå¹‚ç­‰çš„ <strong>ï¼ˆalexæ³¨ï¼šå¹‚ç­‰çš„æŒ‡ä¸€ä¸ªæ€»æ˜¯äº§ç”Ÿç›¸åŒç»“æœçš„æ•°å­¦è¿ç®—ï¼‰</strong>ã€‚é€šå¸¸åº”ç”¨ç¨‹åºé¦–å…ˆæŠŠè¾“å‡ºç»“æœå†™åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œåœ¨è¾“å‡ºå…¨éƒ¨æ•°æ®ä¹‹åï¼Œåœ¨ä½¿ç”¨ç³»ç»Ÿçº§çš„åŸå­æ“ä½œrenameé‡æ–°å‘½åè¿™ä¸ªä¸´æ—¶æ–‡ä»¶ã€‚</p>
<p>å¦‚æœä¸€ä¸ªä»»åŠ¡äº§ç”Ÿäº†å¤šä¸ªè¾“å‡ºæ–‡ä»¶ï¼Œæˆ‘ä»¬æ²¡æœ‰æä¾›ç±»ä¼¼ä¸¤é˜¶æ®µæäº¤çš„åŸå­æ“ä½œæ”¯æŒè¿™ç§æƒ…å†µã€‚å› æ­¤ï¼Œå¯¹äºä¼šäº§ç”Ÿå¤šä¸ªè¾“å‡ºæ–‡ä»¶ã€å¹¶ä¸”å¯¹äºè·¨æ–‡ä»¶æœ‰ä¸€è‡´æ€§è¦æ±‚çš„ä»»åŠ¡ï¼Œéƒ½å¿…é¡»æ˜¯ç¡®å®šæ€§çš„ä»»åŠ¡ã€‚ä½†æ˜¯åœ¨å®é™…åº”ç”¨è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªé™åˆ¶è¿˜æ²¡æœ‰ç»™æˆ‘ä»¬å¸¦æ¥è¿‡éº»çƒ¦ã€‚</p>
<h4 id="4-6ã€è·³è¿‡æŸåçš„è®°å½•"><a href="#4-6ã€è·³è¿‡æŸåçš„è®°å½•" class="headerlink" title="4.6ã€è·³è¿‡æŸåçš„è®°å½•"></a>4.6ã€è·³è¿‡æŸåçš„è®°å½•</h4><p>æœ‰æ—¶å€™ï¼Œç”¨æˆ·ç¨‹åºä¸­çš„bugå¯¼è‡´Mapæˆ–è€…Reduceå‡½æ•°åœ¨å¤„ç†æŸäº›è®°å½•çš„æ—¶å€™crashæ‰ï¼ŒMapReduceæ“ä½œæ— æ³•é¡ºåˆ©å®Œæˆã€‚æƒ¯å¸¸çš„åš æ³•æ˜¯ä¿®å¤bugåå†æ¬¡æ‰§è¡ŒMapReduceæ“ä½œï¼Œä½†æ˜¯ï¼Œæœ‰æ—¶å€™æ‰¾å‡ºè¿™äº›bugå¹¶ä¿®å¤å®ƒä»¬ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ï¼›è¿™äº›bugä¹Ÿè®¸æ˜¯åœ¨ç¬¬ä¸‰æ–¹åº“é‡Œè¾¹ï¼Œè€Œæˆ‘ä»¬æ‰‹ å¤´æ²¡æœ‰è¿™äº›åº“çš„æºä»£ç ã€‚è€Œä¸”åœ¨å¾ˆå¤šæ—¶å€™ï¼Œå¿½ç•¥ä¸€äº›æœ‰é—®é¢˜çš„è®°å½•ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ªå·¨å¤§çš„æ•°æ®é›†ä¸Šè¿›è¡Œç»Ÿè®¡åˆ†æçš„æ—¶å€™ã€‚æˆ‘ä»¬æä¾›äº†ä¸€ç§æ‰§è¡Œæ¨¡å¼ï¼Œåœ¨ è¿™ç§æ¨¡å¼ä¸‹ï¼Œä¸ºäº†ä¿è¯ä¿è¯æ•´ä¸ªå¤„ç†èƒ½ç»§ç»­è¿›è¡Œï¼ŒMapReduceä¼šæ£€æµ‹å“ªäº›è®°å½•å¯¼è‡´ç¡®å®šæ€§çš„crashï¼Œå¹¶ä¸”è·³è¿‡è¿™äº›è®°å½•ä¸å¤„ç†ã€‚</p>
<p>æ¯ä¸ªworkerè¿›ç¨‹éƒ½è®¾ç½®äº†ä¿¡å·å¤„ç†å‡½æ•°æ•è·å†…å­˜æ®µå¼‚å¸¸ï¼ˆsegmentation violationï¼‰å’Œæ€»çº¿é”™è¯¯ï¼ˆbus errorï¼‰ã€‚åœ¨æ‰§è¡ŒMapæˆ–è€…Reduceæ“ä½œä¹‹å‰ï¼ŒMapReduceåº“é€šè¿‡å…¨å±€å˜é‡ä¿å­˜è®°å½•åºå·ã€‚å¦‚æœç”¨æˆ·ç¨‹åºè§¦å‘äº†ä¸€ä¸ªç³»ç»Ÿä¿¡å·ï¼Œæ¶ˆæ¯å¤„ç†å‡½æ•°å°† ç”¨â€œæœ€åä¸€å£æ°”â€é€šè¿‡UDPåŒ…å‘masterå‘é€å¤„ç†çš„æœ€åä¸€æ¡è®°å½•çš„åºå·ã€‚å½“masterçœ‹åˆ°åœ¨å¤„ç†æŸæ¡ç‰¹å®šè®°å½•ä¸æ­¢å¤±è´¥ä¸€æ¬¡æ—¶ï¼Œmasterå°±æ ‡å¿—ç€ æ¡è®°å½•éœ€è¦è¢«è·³è¿‡ï¼Œå¹¶ä¸”åœ¨ä¸‹æ¬¡é‡æ–°æ‰§è¡Œç›¸å…³çš„Mapæˆ–è€…Reduceä»»åŠ¡çš„æ—¶å€™è·³è¿‡è¿™æ¡è®°å½•ã€‚</p>
<h4 id="4-7ã€æœ¬åœ°æ‰§è¡Œ"><a href="#4-7ã€æœ¬åœ°æ‰§è¡Œ" class="headerlink" title="4.7ã€æœ¬åœ°æ‰§è¡Œ"></a>4.7ã€æœ¬åœ°æ‰§è¡Œ</h4><p>è°ƒè¯•Mapå’ŒReduceå‡½æ•°çš„bugæ˜¯éå¸¸å›°éš¾çš„ï¼Œå› ä¸ºå®é™…æ‰§è¡Œæ“ä½œæ—¶ä¸ä½†æ˜¯åˆ†å¸ƒåœ¨ç³»ç»Ÿä¸­æ‰§è¡Œçš„ï¼Œè€Œä¸”é€šå¸¸æ˜¯åœ¨å¥½å‡ åƒå°è®¡ç®—æœºä¸Šæ‰§è¡Œï¼Œå…·ä½“çš„ æ‰§è¡Œä½ç½®æ˜¯ç”±masterè¿›è¡ŒåŠ¨æ€è°ƒåº¦çš„ï¼Œè¿™åˆå¤§å¤§å¢åŠ äº†è°ƒè¯•çš„éš¾åº¦ã€‚ä¸ºäº†ç®€åŒ–è°ƒè¯•ã€profileå’Œå°è§„æ¨¡æµ‹è¯•ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€å¥—MapReduceåº“çš„ æœ¬åœ°å®ç°ç‰ˆæœ¬ï¼Œé€šè¿‡ä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬çš„MapReduceåº“ï¼ŒMapReduceæ“ä½œåœ¨æœ¬åœ°è®¡ç®—æœºä¸Šé¡ºåºçš„æ‰§è¡Œã€‚ç”¨æˆ·å¯ä»¥æ§åˆ¶MapReduceæ“ä½œçš„æ‰§è¡Œï¼Œ å¯ä»¥æŠŠæ“ä½œé™åˆ¶åˆ°ç‰¹å®šçš„Mapä»»åŠ¡ä¸Šã€‚ç”¨æˆ·é€šè¿‡è®¾å®šç‰¹åˆ«çš„æ ‡å¿—æ¥åœ¨æœ¬åœ°æ‰§è¡Œä»–ä»¬çš„ç¨‹åºï¼Œä¹‹åå°±å¯ä»¥å¾ˆå®¹æ˜“çš„ä½¿ç”¨æœ¬åœ°è°ƒè¯•å’Œæµ‹è¯•å·¥å…·ï¼ˆæ¯”å¦‚gdbï¼‰ã€‚</p>
<h4 id="4-8ã€çŠ¶æ€ä¿¡æ¯"><a href="#4-8ã€çŠ¶æ€ä¿¡æ¯" class="headerlink" title="4.8ã€çŠ¶æ€ä¿¡æ¯"></a>4.8ã€çŠ¶æ€ä¿¡æ¯</h4><p>masterä½¿ç”¨åµŒå…¥å¼çš„HTTPæœåŠ¡å™¨ï¼ˆå¦‚Jettyï¼‰æ˜¾ç¤ºä¸€ç»„çŠ¶æ€ä¿¡æ¯é¡µé¢ï¼Œç”¨æˆ·å¯ä»¥ç›‘æ§å„ç§æ‰§è¡ŒçŠ¶æ€ã€‚çŠ¶æ€ä¿¡æ¯é¡µé¢æ˜¾ç¤ºäº†åŒ…æ‹¬è®¡ç®—æ‰§è¡Œçš„ è¿›åº¦ï¼Œæ¯”å¦‚å·²ç»å®Œæˆäº†å¤šå°‘ä»»åŠ¡ã€æœ‰å¤šå°‘ä»»åŠ¡æ­£åœ¨å¤„ç†ã€è¾“å…¥çš„å­—èŠ‚æ•°ã€ä¸­é—´æ•°æ®çš„å­—èŠ‚æ•°ã€è¾“å‡ºçš„å­—èŠ‚æ•°ã€å¤„ç†ç™¾åˆ†æ¯”ç­‰ç­‰ã€‚é¡µé¢è¿˜åŒ…å«äº†æŒ‡å‘æ¯ä¸ªä»»åŠ¡çš„ stderrå’Œstdoutæ–‡ä»¶çš„é“¾æ¥ã€‚ç”¨æˆ·æ ¹æ®è¿™äº›æ•°æ®é¢„æµ‹è®¡ç®—éœ€è¦æ‰§è¡Œå¤§çº¦å¤šé•¿æ—¶é—´ã€æ˜¯å¦éœ€è¦å¢åŠ é¢å¤–çš„è®¡ç®—èµ„æºã€‚è¿™äº›é¡µé¢ä¹Ÿå¯ä»¥ç”¨æ¥åˆ†æä»€ä¹ˆæ—¶å€™è®¡ ç®—æ‰§è¡Œçš„æ¯”é¢„æœŸçš„è¦æ…¢ã€‚</p>
<p>å¦å¤–ï¼Œå¤„äºæœ€é¡¶å±‚çš„çŠ¶æ€é¡µé¢æ˜¾ç¤ºäº†å“ªäº›workerå¤±æ•ˆäº†ï¼Œä»¥åŠä»–ä»¬å¤±æ•ˆçš„æ—¶å€™æ­£åœ¨è¿è¡Œçš„Mapå’ŒReduceä»»åŠ¡ã€‚è¿™äº›ä¿¡æ¯å¯¹äºè°ƒè¯•ç”¨æˆ·ä»£ç ä¸­çš„bugå¾ˆæœ‰å¸®åŠ©ã€‚</p>
<h4 id="4-9ã€è®¡æ•°å™¨"><a href="#4-9ã€è®¡æ•°å™¨" class="headerlink" title="4.9ã€è®¡æ•°å™¨"></a>4.9ã€è®¡æ•°å™¨</h4><p>MapReduceåº“ä½¿ç”¨è®¡æ•°å™¨ç»Ÿè®¡ä¸åŒäº‹ä»¶å‘ç”Ÿæ¬¡æ•°ã€‚æ¯”å¦‚ï¼Œç”¨æˆ·å¯èƒ½æƒ³ç»Ÿè®¡å·²ç»å¤„ç†äº†å¤šå°‘ä¸ªå•è¯ã€å·²ç»ç´¢å¼•çš„å¤šå°‘ç¯‡Germanæ–‡æ¡£ç­‰ç­‰ã€‚</p>
<p>ä¸ºäº†ä½¿ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œç”¨æˆ·åœ¨ç¨‹åºä¸­åˆ›å»ºä¸€ä¸ªå‘½åçš„è®¡æ•°å™¨å¯¹è±¡ï¼Œåœ¨Mapå’ŒReduceå‡½æ•°ä¸­ç›¸åº”çš„å¢åŠ è®¡æ•°å™¨çš„å€¼ã€‚ä¾‹å¦‚ï¼š </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Counter* uppercase;</div><div class="line">uppercase = GetCounter(â€œuppercaseâ€);</div><div class="line">map(String name, String contents):</div><div class="line"> for each word w in contents:</div><div class="line">  if (IsCapitalized(w)):</div><div class="line">   uppercase-&gt;Increment();</div><div class="line">  EmitIntermediate(w, â€œ1â€³);</div></pre></td></tr></table></figure>
<p>è¿™äº›è®¡æ•°å™¨çš„å€¼å‘¨æœŸæ€§çš„ä»å„ä¸ªå•ç‹¬çš„workeræœºå™¨ä¸Šä¼ é€’ç»™masterï¼ˆé™„åŠ åœ¨pingçš„åº”ç­”åŒ…ä¸­ä¼ é€’ï¼‰ã€‚masteræŠŠæ‰§è¡ŒæˆåŠŸçš„Mapå’ŒReduceä»»åŠ¡çš„è®¡æ•°å™¨å€¼è¿›è¡Œç´¯è®¡ï¼Œå½“MapReduceæ“ä½œå®Œæˆä¹‹åï¼Œè¿”å›ç»™ç”¨æˆ·ä»£ç ã€‚</p>
<p>è®¡æ•°å™¨å½“å‰çš„å€¼ä¹Ÿä¼šæ˜¾ç¤ºåœ¨masterçš„çŠ¶æ€é¡µé¢ä¸Šï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥çœ‹åˆ°å½“å‰è®¡ç®—çš„è¿›åº¦ã€‚å½“ç´¯åŠ è®¡æ•°å™¨çš„å€¼çš„æ—¶å€™ï¼Œmasterè¦æ£€æŸ¥é‡å¤è¿è¡Œçš„Mapæˆ–è€…Reduceä»»åŠ¡ï¼Œé¿å…é‡å¤ç´¯åŠ ï¼ˆä¹‹å‰æåˆ°çš„å¤‡ç”¨ä»»åŠ¡å’Œå¤±æ•ˆåé‡æ–°æ‰§è¡Œä»»åŠ¡è¿™ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´ç›¸åŒçš„ä»»åŠ¡è¢«å¤šæ¬¡æ‰§è¡Œï¼‰ã€‚</p>
<p>æœ‰äº›è®¡æ•°å™¨çš„å€¼æ˜¯ç”±MapReduceåº“è‡ªåŠ¨ç»´æŒçš„ï¼Œæ¯”å¦‚å·²ç»å¤„ç†çš„è¾“å…¥çš„key/value pairçš„æ•°é‡ã€è¾“å‡ºçš„key/value pairçš„æ•°é‡ç­‰ç­‰ã€‚</p>
<p>è®¡æ•°å™¨æœºåˆ¶å¯¹äºMapReduceæ“ä½œçš„å®Œæ•´æ€§æ£€æŸ¥éå¸¸æœ‰ç”¨ã€‚æ¯”å¦‚ï¼Œåœ¨æŸäº›MapReduceæ“ä½œä¸­ï¼Œç”¨æˆ·éœ€è¦ç¡®ä¿è¾“å‡ºçš„key value pairç²¾ç¡®çš„ç­‰äºè¾“å…¥çš„key value pairï¼Œæˆ–è€…å¤„ç†çš„Germanæ–‡æ¡£æ•°é‡åœ¨å¤„ç†çš„æ•´ä¸ªæ–‡æ¡£æ•°é‡ä¸­å±äºåˆç†èŒƒå›´ã€‚</p>
<h3 id="5ã€æ€§èƒ½"><a href="#5ã€æ€§èƒ½" class="headerlink" title="5ã€æ€§èƒ½"></a>5ã€æ€§èƒ½</h3><p>æœ¬èŠ‚æˆ‘ä»¬ç”¨åœ¨ä¸€ä¸ªå¤§å‹é›†ç¾¤ä¸Šè¿è¡Œçš„ä¸¤ä¸ªè®¡ç®—æ¥è¡¡é‡MapReduceçš„æ€§èƒ½ã€‚ä¸€ä¸ªè®¡ç®—åœ¨å¤§çº¦1TBçš„æ•°æ®ä¸­è¿›è¡Œç‰¹å®šçš„æ¨¡å¼åŒ¹é…ï¼Œå¦ä¸€ä¸ªè®¡ç®—å¯¹å¤§çº¦1TBçš„æ•°æ®è¿›è¡Œæ’åºã€‚</p>
<p>è¿™ä¸¤ä¸ªç¨‹åºåœ¨å¤§é‡çš„ä½¿ç”¨MapReduceçš„å®é™…åº”ç”¨ä¸­æ˜¯éå¸¸å…¸å‹çš„ â€” ä¸€ç±»æ˜¯å¯¹æ•°æ®æ ¼å¼è¿›è¡Œè½¬æ¢ï¼Œä»ä¸€ç§è¡¨ç°å½¢å¼è½¬æ¢ä¸ºå¦å¤–ä¸€ç§è¡¨ç°å½¢å¼ï¼›å¦ä¸€ç±»æ˜¯ä»æµ·é‡æ•°æ®ä¸­æŠ½å–å°‘éƒ¨åˆ†çš„ç”¨æˆ·æ„Ÿå…´è¶£çš„æ•°æ®ã€‚</p>
<h4 id="5-1ã€é›†ç¾¤é…ç½®"><a href="#5-1ã€é›†ç¾¤é…ç½®" class="headerlink" title="5.1ã€é›†ç¾¤é…ç½®"></a>5.1ã€é›†ç¾¤é…ç½®</h4><p>æ‰€æœ‰è¿™äº›ç¨‹åºéƒ½è¿è¡Œåœ¨ä¸€ä¸ªå¤§çº¦ç”±1800å°æœºå™¨æ„æˆçš„é›†ç¾¤ä¸Šã€‚æ¯å°æœºå™¨é…ç½®2ä¸ª2Gä¸»é¢‘ã€æ”¯æŒè¶…çº¿ç¨‹çš„Intel Xeonå¤„ç†å™¨ï¼Œ4GBçš„ç‰©ç†å†…å­˜ï¼Œä¸¤ä¸ª160GBçš„IDEç¡¬ç›˜å’Œä¸€ä¸ªåƒå…†ä»¥å¤ªç½‘å¡ã€‚è¿™äº›æœºå™¨éƒ¨ç½²åœ¨ä¸€ä¸ªä¸¤å±‚çš„æ ‘å½¢äº¤æ¢ç½‘ç»œä¸­ï¼Œåœ¨rootèŠ‚ç‚¹å¤§æ¦‚æœ‰ 100-200GBPSçš„ä¼ è¾“å¸¦å®½ã€‚æ‰€æœ‰è¿™äº›æœºå™¨éƒ½é‡‡ç”¨ç›¸åŒçš„éƒ¨ç½²ï¼ˆå¯¹ç­‰éƒ¨ç½²ï¼‰ï¼Œå› æ­¤ä»»æ„ä¸¤ç‚¹ä¹‹é—´çš„ç½‘ç»œæ¥å›æ—¶é—´å°äº1æ¯«ç§’ã€‚</p>
<p>åœ¨4GBå†…å­˜é‡Œï¼Œå¤§æ¦‚æœ‰1-1.5Gç”¨äºè¿è¡Œåœ¨é›†ç¾¤ä¸Šçš„å…¶ä»–ä»»åŠ¡ã€‚æµ‹è¯•ç¨‹åºåœ¨å‘¨æœ«ä¸‹åˆå¼€å§‹æ‰§è¡Œï¼Œè¿™æ—¶ä¸»æœºçš„CPUã€ç£ç›˜å’Œç½‘ç»œåŸºæœ¬ä¸Šå¤„äºç©ºé—²çŠ¶æ€ã€‚</p>
<h4 id="5-2ã€GREP"><a href="#5-2ã€GREP" class="headerlink" title="5.2ã€GREP"></a>5.2ã€GREP</h4><p>è¿™ä¸ªåˆ†å¸ƒå¼çš„grepç¨‹åºéœ€è¦æ‰«æå¤§æ¦‚10çš„10æ¬¡æ–¹ä¸ªç”±100ä¸ªå­—èŠ‚ç»„æˆçš„è®°å½•ï¼ŒæŸ¥æ‰¾å‡ºç°æ¦‚ç‡è¾ƒå°çš„3ä¸ªå­—ç¬¦çš„æ¨¡å¼ï¼ˆè¿™ä¸ªæ¨¡å¼åœ¨92337ä¸ªè®°å½•ä¸­å‡ºç°ï¼‰ã€‚è¾“å…¥æ•°æ®è¢«æ‹†åˆ†æˆå¤§çº¦64Mçš„Blockï¼ˆM=15000ï¼‰ï¼Œæ•´ä¸ªè¾“å‡ºæ•°æ®å­˜æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼ˆR=1ï¼‰ã€‚</p>
<p><img src="/images/GoogleMR5-2.jpg"></p>
<p>å›¾2æ˜¾ç¤ºäº†è¿™ä¸ªè¿ç®—éšæ—¶é—´çš„å¤„ç†è¿‡ç¨‹ã€‚å…¶ä¸­Yè½´è¡¨ç¤ºè¾“å…¥æ•°æ®çš„å¤„ç†é€Ÿåº¦ã€‚å¤„ç†é€Ÿåº¦éšç€å‚ä¸MapReduceè®¡ç®—çš„æœºå™¨æ•°é‡çš„å¢åŠ è€Œå¢åŠ ï¼Œå½“ 1764å°workerå‚ä¸è®¡ç®—çš„æ—¶ï¼Œå¤„ç†é€Ÿåº¦è¾¾åˆ°äº†30GB/sã€‚å½“Mapä»»åŠ¡ç»“æŸçš„æ—¶å€™ï¼Œå³åœ¨è®¡ç®—å¼€å§‹å80ç§’ï¼Œè¾“å…¥çš„å¤„ç†é€Ÿåº¦é™åˆ°0ã€‚æ•´ä¸ªè®¡ç®—è¿‡ç¨‹ ä»å¼€å§‹åˆ°ç»“æŸä¸€å…±èŠ±äº†å¤§æ¦‚150ç§’ã€‚è¿™åŒ…æ‹¬äº†å¤§çº¦ä¸€åˆ†é’Ÿçš„åˆå§‹å¯åŠ¨é˜¶æ®µã€‚åˆå§‹å¯åŠ¨é˜¶æ®µæ¶ˆè€—çš„æ—¶é—´åŒ…æ‹¬äº†æ˜¯æŠŠè¿™ä¸ªç¨‹åºä¼ é€åˆ°å„ä¸ªworkeræœºå™¨ä¸Šçš„æ—¶é—´ã€ ç­‰å¾…GFSæ–‡ä»¶ç³»ç»Ÿæ‰“å¼€1000ä¸ªè¾“å…¥æ–‡ä»¶é›†åˆçš„æ—¶é—´ã€è·å–ç›¸å…³çš„æ–‡ä»¶æœ¬åœ°ä½ç½®ä¼˜åŒ–ä¿¡æ¯çš„æ—¶é—´ã€‚</p>
<h4 id="5-3ã€æ’åº"><a href="#5-3ã€æ’åº" class="headerlink" title="5.3ã€æ’åº"></a>5.3ã€æ’åº</h4><p>æ’åºç¨‹åºå¤„ç†10çš„10æ¬¡æ–¹ä¸ª100ä¸ªå­—èŠ‚ç»„æˆçš„è®°å½•ï¼ˆå¤§æ¦‚1TBçš„æ•°æ®ï¼‰ã€‚è¿™ä¸ªç¨‹åºæ¨¡ä»¿TeraSort benchmark[10]ã€‚</p>
<p>æ’åºç¨‹åºç”±ä¸åˆ°50è¡Œä»£ç ç»„æˆã€‚åªæœ‰ä¸‰è¡Œçš„Mapå‡½æ•°ä»æ–‡æœ¬è¡Œä¸­è§£æå‡º10ä¸ªå­—èŠ‚çš„keyå€¼ä½œä¸ºæ’åºçš„keyï¼Œå¹¶ä¸”æŠŠè¿™ä¸ªkeyå’ŒåŸå§‹æ–‡æœ¬è¡Œä½œ ä¸ºä¸­é—´çš„key/value pairå€¼è¾“å‡ºã€‚æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªå†…ç½®çš„æ’ç­‰å‡½æ•°ä½œä¸ºReduceæ“ä½œå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æŠŠä¸­é—´çš„key/value pairå€¼ä¸ä½œä»»ä½•æ”¹å˜è¾“å‡ºã€‚æœ€ç»ˆæ’åºç»“æœè¾“å‡ºåˆ°ä¸¤è·¯å¤åˆ¶çš„GFSæ–‡ä»¶ç³»ç»Ÿï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œç¨‹åºè¾“å‡º2TBçš„æ•°æ®ï¼‰ã€‚</p>
<p>å¦‚å‰æ‰€è¿°ï¼Œè¾“å…¥æ•°æ®è¢«åˆ†æˆ64MBçš„Blockï¼ˆM=15000ï¼‰ã€‚æˆ‘ä»¬æŠŠæ’åºåçš„è¾“å‡ºç»“æœåˆ†åŒºåå­˜å‚¨åˆ°4000ä¸ªæ–‡ä»¶ï¼ˆR=4000ï¼‰ã€‚åˆ†åŒºå‡½æ•°ä½¿ç”¨keyçš„åŸå§‹å­—èŠ‚æ¥æŠŠæ•°æ®åˆ†åŒºåˆ°Rä¸ªç‰‡æ®µä¸­ã€‚</p>
<p>åœ¨è¿™ä¸ªbenchmarkæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„åˆ†åŒºå‡½æ•°çŸ¥é“keyçš„åˆ†åŒºæƒ…å†µã€‚é€šå¸¸å¯¹äºæ’åºç¨‹åºæ¥è¯´ï¼Œæˆ‘ä»¬ä¼šå¢åŠ ä¸€ä¸ªé¢„å¤„ç†çš„MapReduceæ“ä½œç”¨äºé‡‡æ ·keyå€¼çš„åˆ†å¸ƒæƒ…å†µï¼Œé€šè¿‡é‡‡æ ·çš„æ•°æ®æ¥è®¡ç®—å¯¹æœ€ç»ˆæ’åºå¤„ç†çš„åˆ†åŒºç‚¹ã€‚</p>
<p><img src="/images/GoogleMR5-3.jpg"></p>
<p>å›¾ä¸‰ï¼ˆaï¼‰æ˜¾ç¤ºäº†è¿™ä¸ªæ’åºç¨‹åºçš„æ­£å¸¸æ‰§è¡Œè¿‡ç¨‹ã€‚å·¦ä¸Šçš„å›¾æ˜¾ç¤ºäº†è¾“å…¥æ•°æ®è¯»å–çš„é€Ÿåº¦ã€‚æ•°æ®è¯»å–é€Ÿåº¦å³°å€¼ä¼šè¾¾åˆ°13GB/sï¼Œå¹¶ä¸”æ‰€æœ‰Mapä»»åŠ¡å®Œ æˆä¹‹åï¼Œå³å¤§çº¦200ç§’ä¹‹åè¿…é€Ÿæ»‘è½åˆ°0ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ’åºç¨‹åºè¾“å…¥æ•°æ®è¯»å–é€Ÿåº¦å°äºåˆ†å¸ƒå¼grepç¨‹åºã€‚è¿™æ˜¯å› ä¸ºæ’åºç¨‹åºçš„Mapä»»åŠ¡èŠ±äº†å¤§çº¦ä¸€åŠçš„ å¤„ç†æ—¶é—´å’ŒI/Oå¸¦å®½æŠŠä¸­é—´è¾“å‡ºç»“æœå†™åˆ°æœ¬åœ°ç¡¬ç›˜ã€‚ç›¸åº”çš„åˆ†å¸ƒå¼grepç¨‹åºçš„ä¸­é—´ç»“æœè¾“å‡ºå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</p>
<p>å·¦è¾¹ä¸­é—´çš„å›¾æ˜¾ç¤ºäº†ä¸­é—´æ•°æ®ä»Mapä»»åŠ¡å‘é€åˆ°Reduceä»»åŠ¡çš„ç½‘ç»œé€Ÿåº¦ã€‚è¿™ä¸ªè¿‡ç¨‹ä»ç¬¬ä¸€ä¸ªMapä»»åŠ¡å®Œæˆä¹‹åå°±å¼€å§‹ç¼“æ…¢å¯åŠ¨äº†ã€‚å›¾ç¤ºçš„ç¬¬ä¸€ ä¸ªé«˜å³°æ˜¯å¯åŠ¨äº†ç¬¬ä¸€æ‰¹å¤§æ¦‚1700ä¸ªReduceä»»åŠ¡ï¼ˆæ•´ä¸ªMapReduceåˆ†å¸ƒåˆ°å¤§æ¦‚1700å°æœºå™¨ä¸Šï¼Œæ¯å°æœºå™¨1æ¬¡æœ€å¤šæ‰§è¡Œ1ä¸ªReduceä»» åŠ¡ï¼‰ã€‚æ’åºç¨‹åºè¿è¡Œå¤§çº¦300ç§’åï¼Œç¬¬ä¸€æ‰¹å¯åŠ¨çš„Reduceä»»åŠ¡æœ‰äº›å®Œæˆäº†ï¼Œæˆ‘ä»¬å¼€å§‹æ‰§è¡Œå‰©ä¸‹çš„Reduceä»»åŠ¡ã€‚æ‰€æœ‰çš„å¤„ç†åœ¨å¤§çº¦600ç§’åç»“æŸã€‚</p>
<p>å·¦ä¸‹å›¾è¡¨ç¤ºReduceä»»åŠ¡æŠŠæ’åºåçš„æ•°æ®å†™åˆ°æœ€ç»ˆçš„è¾“å‡ºæ–‡ä»¶çš„é€Ÿåº¦ã€‚åœ¨ç¬¬ä¸€ä¸ªæ’åºé˜¶æ®µç»“æŸå’Œæ•°æ®å¼€å§‹å†™å…¥ç£ç›˜ä¹‹é—´æœ‰ä¸€ä¸ªå°çš„å»¶æ—¶ï¼Œè¿™æ˜¯å› ä¸º workeræœºå™¨æ­£åœ¨å¿™äºæ’åºä¸­é—´æ•°æ®ã€‚ç£ç›˜å†™å…¥é€Ÿåº¦åœ¨2-4GB/sæŒç»­ä¸€æ®µæ—¶é—´ã€‚è¾“å‡ºæ•°æ®å†™å…¥ç£ç›˜å¤§çº¦æŒç»­850ç§’ã€‚è®¡å…¥åˆå§‹å¯åŠ¨éƒ¨åˆ†çš„æ—¶é—´ï¼Œæ•´ä¸ªè¿ ç®—æ¶ˆè€—äº†891ç§’ã€‚è¿™ä¸ªé€Ÿåº¦å’ŒTeraSort benchmark[18]çš„æœ€é«˜çºªå½•1057ç§’ç›¸å·®ä¸å¤šã€‚</p>
<p>è¿˜æœ‰ä¸€äº›å€¼å¾—æ³¨æ„çš„ç°è±¡ï¼šè¾“å…¥æ•°æ®çš„è¯»å–é€Ÿåº¦æ¯”æ’åºé€Ÿåº¦å’Œè¾“å‡ºæ•°æ®å†™å…¥ç£ç›˜é€Ÿåº¦è¦é«˜ä¸å°‘ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„è¾“å…¥æ•°æ®æœ¬åœ°åŒ–ä¼˜åŒ–ç­–ç•¥èµ·äº†ä½œç”¨ â€” ç»å¤§éƒ¨åˆ†æ•°æ®éƒ½æ˜¯ä»æœ¬åœ°ç¡¬ç›˜è¯»å–çš„ï¼Œä»è€ŒèŠ‚çœäº†ç½‘ç»œå¸¦å®½ã€‚æ’åºé€Ÿåº¦æ¯”è¾“å‡ºæ•°æ®å†™å…¥åˆ°ç£ç›˜çš„é€Ÿåº¦å¿«ï¼Œè¿™æ˜¯å› ä¸ºè¾“å‡ºæ•°æ®å†™äº†ä¸¤ä»½ï¼ˆæˆ‘ä»¬ä½¿ç”¨äº†2è·¯çš„GFSæ–‡ä»¶ ç³»ç»Ÿï¼Œå†™å…¥å¤åˆ¶èŠ‚ç‚¹çš„åŸå› æ˜¯ä¸ºäº†ä¿è¯æ•°æ®å¯é æ€§å’Œå¯ç”¨æ€§ï¼‰ã€‚æˆ‘ä»¬æŠŠè¾“å‡ºæ•°æ®å†™å…¥åˆ°ä¸¤ä¸ªå¤åˆ¶èŠ‚ç‚¹çš„åŸå› æ˜¯å› ä¸ºè¿™æ˜¯åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„ä¿è¯æ•°æ®å¯é æ€§å’Œå¯ç”¨æ€§çš„å® ç°æœºåˆ¶ã€‚å¦‚æœåº•å±‚æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ç±»ä¼¼å®¹é”™ç¼–ç <a href="erasure coding">14</a>çš„æ–¹å¼è€Œä¸æ˜¯å¤åˆ¶çš„æ–¹å¼ä¿è¯æ•°æ®çš„å¯é æ€§å’Œå¯ç”¨æ€§ï¼Œé‚£ä¹ˆåœ¨è¾“å‡ºæ•°æ®å†™å…¥ç£ç›˜çš„æ—¶å€™ï¼Œå°±å¯ä»¥é™ä½ç½‘ç»œå¸¦å®½çš„ä½¿ç”¨ã€‚</p>
<h4 id="5-4ã€é«˜æ•ˆçš„backupä»»åŠ¡"><a href="#5-4ã€é«˜æ•ˆçš„backupä»»åŠ¡" class="headerlink" title="5.4ã€é«˜æ•ˆçš„backupä»»åŠ¡"></a>5.4ã€é«˜æ•ˆçš„backupä»»åŠ¡</h4><p>å›¾ä¸‰ï¼ˆbï¼‰æ˜¾ç¤ºäº†å…³é—­äº†å¤‡ç”¨ä»»åŠ¡åæ’åºç¨‹åºæ‰§è¡Œæƒ…å†µã€‚æ‰§è¡Œçš„è¿‡ç¨‹å’Œå›¾3ï¼ˆaï¼‰å¾ˆç›¸ä¼¼ï¼Œé™¤äº†è¾“å‡ºæ•°æ®å†™ç£ç›˜çš„åŠ¨ä½œåœ¨æ—¶é—´ä¸Šæ‹–äº†ä¸€ä¸ªå¾ˆé•¿çš„å°¾å·´ï¼Œè€Œ ä¸”åœ¨è¿™æ®µæ—¶é—´é‡Œï¼Œå‡ ä¹æ²¡æœ‰ä»€ä¹ˆå†™å…¥åŠ¨ä½œã€‚åœ¨960ç§’åï¼Œåªæœ‰5ä¸ªReduceä»»åŠ¡æ²¡æœ‰å®Œæˆã€‚è¿™äº›æ‹–åè…¿çš„ä»»åŠ¡åˆæ‰§è¡Œäº†300ç§’æ‰å®Œæˆã€‚æ•´ä¸ªè®¡ç®—æ¶ˆè€—äº† 1283ç§’ï¼Œå¤šäº†44%çš„æ‰§è¡Œæ—¶é—´ã€‚</p>
<h4 id="5-5ã€å¤±æ•ˆçš„æœºå™¨"><a href="#5-5ã€å¤±æ•ˆçš„æœºå™¨" class="headerlink" title="5.5ã€å¤±æ•ˆçš„æœºå™¨"></a>5.5ã€å¤±æ•ˆçš„æœºå™¨</h4><p>åœ¨å›¾ä¸‰ï¼ˆcï¼‰ä¸­æ¼”ç¤ºçš„æ’åºç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åœ¨ç¨‹åºå¼€å§‹åå‡ åˆ†é’Ÿæœ‰æ„çš„killäº†1746ä¸ªworkerä¸­çš„200ä¸ªã€‚é›†ç¾¤åº•å±‚çš„è°ƒåº¦ç«‹åˆ»åœ¨è¿™äº›æœºå™¨ä¸Šé‡æ–°å¼€å§‹æ–°çš„workerå¤„ç†è¿›ç¨‹ï¼ˆå› ä¸ºåªæ˜¯workeræœºå™¨ä¸Šçš„å¤„ç†è¿›ç¨‹è¢«killäº†ï¼Œæœºå™¨æœ¬èº«è¿˜åœ¨å·¥ä½œï¼‰ã€‚</p>
<p>å›¾ä¸‰ï¼ˆcï¼‰æ˜¾ç¤ºå‡ºäº†ä¸€ä¸ªâ€œè´Ÿâ€çš„è¾“å…¥æ•°æ®è¯»å–é€Ÿåº¦ï¼Œè¿™æ˜¯å› ä¸ºä¸€äº›å·²ç»å®Œæˆçš„Mapä»»åŠ¡ä¸¢å¤±äº†ï¼ˆç”±äºç›¸åº”çš„æ‰§è¡ŒMapä»»åŠ¡çš„workerè¿›ç¨‹è¢« killäº†ï¼‰ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œè¿™äº›ä»»åŠ¡ã€‚ç›¸å…³Mapä»»åŠ¡å¾ˆå¿«å°±è¢«é‡æ–°æ‰§è¡Œäº†ã€‚æ•´ä¸ªè¿ç®—åœ¨933ç§’å†…å®Œæˆï¼ŒåŒ…æ‹¬äº†åˆå§‹å¯åŠ¨æ—¶é—´ï¼ˆåªæ¯”æ­£å¸¸æ‰§è¡Œå¤šæ¶ˆè€—äº†5%çš„æ—¶é—´ï¼‰ã€‚</p>
<h3 id="6ã€ç»éªŒ"><a href="#6ã€ç»éªŒ" class="headerlink" title="6ã€ç»éªŒ"></a>6ã€ç»éªŒ</h3><p>æˆ‘ä»¬åœ¨2003å¹´1æœˆå®Œæˆäº†ç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„MapReduceåº“ï¼Œåœ¨2003å¹´8æœˆçš„ç‰ˆæœ¬æœ‰äº†æ˜¾è‘—çš„å¢å¼ºï¼Œè¿™åŒ…æ‹¬äº†è¾“å…¥æ•°æ®æœ¬åœ°ä¼˜åŒ–ã€ workeræœºå™¨ä¹‹é—´çš„åŠ¨æ€è´Ÿè½½å‡è¡¡ç­‰ç­‰ã€‚ä»é‚£ä»¥åï¼Œæˆ‘ä»¬æƒŠå–œçš„å‘ç°ï¼ŒMapReduceåº“èƒ½å¹¿æ³›åº”ç”¨äºæˆ‘ä»¬æ—¥å¸¸å·¥ä½œä¸­é‡åˆ°çš„å„ç±»é—®é¢˜ã€‚å®ƒç°åœ¨åœ¨ Googleå†…éƒ¨å„ä¸ªé¢†åŸŸå¾—åˆ°å¹¿æ³›åº”ç”¨ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>å¤§è§„æ¨¡æœºå™¨å­¦ä¹ é—®é¢˜</li>
<li>Google Newså’ŒFroogleäº§å“çš„é›†ç¾¤é—®é¢˜</li>
<li>ä»å…¬ä¼—æŸ¥è¯¢äº§å“ï¼ˆæ¯”å¦‚Googleçš„Zeitgeistï¼‰çš„æŠ¥å‘Šä¸­æŠ½å–æ•°æ®ã€‚</li>
<li>ä»å¤§é‡çš„æ–°åº”ç”¨å’Œæ–°äº§å“çš„ç½‘é¡µä¸­æå–æœ‰ç”¨ä¿¡æ¯ï¼ˆæ¯”å¦‚ï¼Œä»å¤§é‡çš„ä½ç½®æœç´¢ç½‘é¡µä¸­æŠ½å–åœ°ç†ä½ç½®ä¿¡æ¯ï¼‰ã€‚</li>
<li>å¤§è§„æ¨¡çš„å›¾å½¢è®¡ç®—ã€‚</li>
</ul>
<p><img src="/images/GoogleMR6.jpg"></p>
<p>å›¾å››æ˜¾ç¤ºäº†åœ¨æˆ‘ä»¬çš„æºä»£ç ç®¡ç†ç³»ç»Ÿä¸­ï¼Œéšç€æ—¶é—´æ¨ç§»ï¼Œç‹¬ç«‹çš„MapReduceç¨‹åºæ•°é‡çš„æ˜¾è‘—å¢åŠ ã€‚ä»2003å¹´æ—©äº›æ—¶å€™çš„0ä¸ªå¢é•¿åˆ°2004 å¹´9æœˆä»½çš„å·®ä¸å¤š900ä¸ªä¸åŒçš„ç¨‹åºã€‚MapReduceçš„æˆåŠŸå–å†³äºé‡‡ç”¨MapReduceåº“èƒ½å¤Ÿåœ¨ä¸åˆ°åŠä¸ªå°æ—¶æ—¶é—´å†…å†™å‡ºä¸€ä¸ªç®€å•çš„ç¨‹åºï¼Œè¿™ä¸ªç®€å•çš„ ç¨‹åºèƒ½å¤Ÿåœ¨ä¸Šåƒå°æœºå™¨çš„ç»„æˆçš„é›†ç¾¤ä¸Šåšå¤§è§„æ¨¡å¹¶å‘å¤„ç†ï¼Œè¿™æå¤§çš„åŠ å¿«äº†å¼€å‘å’ŒåŸå½¢è®¾è®¡çš„å‘¨æœŸã€‚å¦å¤–ï¼Œé‡‡ç”¨MapReduceåº“ï¼Œå¯ä»¥è®©å®Œå…¨æ²¡æœ‰åˆ†å¸ƒå¼å’Œ/ æˆ–å¹¶è¡Œç³»ç»Ÿå¼€å‘ç»éªŒçš„ç¨‹åºå‘˜å¾ˆå®¹æ˜“çš„åˆ©ç”¨å¤§é‡çš„èµ„æºï¼Œå¼€å‘å‡ºåˆ†å¸ƒå¼å’Œ/æˆ–å¹¶è¡Œå¤„ç†çš„åº”ç”¨ã€‚</p>
<p><img src="/images/GoogleMR6-2.jpg"></p>
<p>åœ¨æ¯ä¸ªä»»åŠ¡ç»“æŸçš„æ—¶å€™ï¼ŒMapReduceåº“ç»Ÿè®¡è®¡ç®—èµ„æºçš„ä½¿ç”¨çŠ¶å†µã€‚åœ¨è¡¨1ï¼Œæˆ‘ä»¬åˆ—å‡ºäº†2004å¹´8æœˆä»½MapReduceè¿è¡Œçš„ä»»åŠ¡æ‰€å ç”¨çš„ç›¸å…³èµ„æºã€‚</p>
<h4 id="6-1ã€å¤§è§„æ¨¡ç´¢å¼•"><a href="#6-1ã€å¤§è§„æ¨¡ç´¢å¼•" class="headerlink" title="6.1ã€å¤§è§„æ¨¡ç´¢å¼•"></a>6.1ã€å¤§è§„æ¨¡ç´¢å¼•</h4><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒMapReduceæœ€æˆåŠŸçš„åº”ç”¨å°±æ˜¯é‡å†™äº†Googleç½‘ç»œæœç´¢æœåŠ¡æ‰€ä½¿ç”¨åˆ°çš„indexç³»ç»Ÿã€‚ç´¢å¼•ç³»ç»Ÿçš„è¾“å…¥æ•°æ®æ˜¯ç½‘ç»œçˆ¬è™«æŠ“å–å›æ¥çš„æµ·é‡çš„æ–‡æ¡£ï¼Œè¿™äº›æ–‡æ¡£æ•°æ®éƒ½ä¿å­˜åœ¨GFSæ–‡ä»¶ç³»ç»Ÿé‡Œã€‚è¿™äº›æ–‡æ¡£åŸå§‹å†…å®¹ ï¼ˆalexæ³¨ï¼šraw contentsï¼Œæˆ‘è®¤ä¸ºå°±æ˜¯ç½‘é¡µä¸­çš„å‰”é™¤htmlæ ‡è®°åçš„å†…å®¹ã€pdfå’Œwordç­‰æœ‰æ ¼å¼æ–‡æ¡£ä¸­æå–çš„æ–‡æœ¬å†…å®¹ç­‰ï¼‰çš„å¤§å°è¶…è¿‡äº†20TBã€‚ç´¢å¼•ç¨‹åºæ˜¯é€šè¿‡ä¸€ç³»åˆ—çš„MapReduceæ“ä½œï¼ˆå¤§çº¦5åˆ°10æ¬¡ï¼‰æ¥å»ºç«‹ç´¢å¼•ã€‚ä½¿ç”¨MapReduceï¼ˆæ›¿æ¢ä¸Šä¸€ä¸ªç‰¹åˆ«è®¾è®¡çš„ã€åˆ†å¸ƒå¼å¤„ç†çš„ç´¢å¼•ç¨‹åºï¼‰å¸¦æ¥è¿™äº›å¥½å¤„ï¼š</p>
<ul>
<li><p>å®ç°ç´¢å¼•éƒ¨åˆ†çš„ä»£ç ç®€å•ã€å°å·§ã€å®¹æ˜“ç†è§£ï¼Œå› ä¸ºå¯¹äºå®¹é”™ã€åˆ†å¸ƒå¼ä»¥åŠå¹¶è¡Œè®¡ç®—çš„å¤„ç†éƒ½æ˜¯MapReduceåº“æä¾›çš„ã€‚æ¯”å¦‚ï¼Œä½¿ç”¨MapReduceåº“ï¼Œè®¡ç®—çš„ä»£ç è¡Œæ•°ä»åŸæ¥çš„3800è¡ŒC++ä»£ç å‡å°‘åˆ°å¤§æ¦‚700è¡Œä»£ç ã€‚</p>
</li>
<li><p>MapReduceåº“çš„æ€§èƒ½å·²ç»è¶³å¤Ÿå¥½äº†ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æŠŠåœ¨æ¦‚å¿µä¸Šä¸ç›¸å…³çš„è®¡ç®—æ­¥éª¤åˆ†å¼€å¤„ç†ï¼Œè€Œä¸æ˜¯æ··åœ¨ä¸€èµ·ä»¥æœŸå‡å°‘æ•°æ®ä¼ é€’çš„é¢å¤–æ¶ˆè€—ã€‚æ¦‚å¿µ ä¸Šä¸ç›¸å…³çš„è®¡ç®—æ­¥éª¤çš„éš”ç¦»ä¹Ÿä½¿å¾—æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“æ”¹å˜ç´¢å¼•å¤„ç†æ–¹å¼ã€‚æ¯”å¦‚ï¼Œå¯¹ä¹‹å‰çš„ç´¢å¼•ç³»ç»Ÿçš„ä¸€ä¸ªå°æ›´æ”¹å¯èƒ½è¦è€—è´¹å¥½å‡ ä¸ªæœˆçš„æ—¶é—´ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ MapReduceçš„æ–°ç³»ç»Ÿä¸Šï¼Œè¿™æ ·çš„æ›´æ”¹åªéœ€è¦èŠ±å‡ å¤©æ—¶é—´å°±å¯ä»¥äº†ã€‚</p>
</li>
<li><p>ç´¢å¼•ç³»ç»Ÿçš„æ“ä½œç®¡ç†æ›´å®¹æ˜“äº†ã€‚å› ä¸ºç”±æœºå™¨å¤±æ•ˆã€æœºå™¨å¤„ç†é€Ÿåº¦ç¼“æ…¢ã€ä»¥åŠç½‘ç»œçš„ç¬é—´é˜»å¡ç­‰å¼•èµ·çš„ç»å¤§éƒ¨åˆ†é—®é¢˜éƒ½å·²ç»ç”±MapReduceåº“è§£å†³äº†ï¼Œä¸å†éœ€è¦æ“ä½œäººå‘˜çš„ä»‹å…¥äº†ã€‚å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ç´¢å¼•ç³»ç»Ÿé›†ç¾¤ä¸­å¢åŠ æœºå™¨çš„ç®€å•æ–¹æ³•æé«˜æ•´ä½“å¤„ç†æ€§èƒ½ã€‚</p>
</li>
</ul>
<h3 id="7ã€ç›¸å…³å·¥ä½œ"><a href="#7ã€ç›¸å…³å·¥ä½œ" class="headerlink" title="7ã€ç›¸å…³å·¥ä½œ"></a>7ã€ç›¸å…³å·¥ä½œ</h3><p>å¾ˆå¤šç³»ç»Ÿéƒ½æä¾›äº†ä¸¥æ ¼çš„ç¼–ç¨‹æ¨¡å¼ï¼Œå¹¶ä¸”é€šè¿‡å¯¹ç¼–ç¨‹çš„ä¸¥æ ¼é™åˆ¶æ¥å®ç°å¹¶è¡Œè®¡ç®—ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç»“åˆå‡½æ•°å¯ä»¥é€šè¿‡æŠŠNä¸ªå…ƒç´ çš„æ•°ç»„çš„å‰ç¼€åœ¨Nä¸ªå¤„ç†å™¨ä¸Šä½¿ç”¨å¹¶è¡Œå‰ç¼€ç®—æ³•ï¼Œåœ¨log Nçš„æ—¶é—´å†…è®¡ç®—å®Œ[6ï¼Œ9ï¼Œ13]ã€‚MapReduceå¯ä»¥çœ‹ä½œæ˜¯æˆ‘ä»¬ç»“åˆåœ¨çœŸå®ç¯å¢ƒä¸‹å¤„ç†æµ·é‡æ•°æ®çš„ç»éªŒï¼Œå¯¹è¿™äº›ç»å…¸æ¨¡å‹è¿›è¡Œç®€åŒ–å’Œèƒå–çš„æˆæœã€‚æ›´åŠ å€¼å¾—éª„å‚²çš„æ˜¯ï¼Œæˆ‘ä»¬è¿˜å®ç°äº†åŸºäºä¸Šåƒå°å¤„ç†å™¨çš„é›†ç¾¤çš„å®¹é”™å¤„ç†ã€‚ç›¸æ¯”è€Œè¨€ï¼Œå¤§éƒ¨åˆ†å¹¶å‘å¤„ç†ç³»ç»Ÿéƒ½åªåœ¨å°è§„æ¨¡çš„é›†ç¾¤ä¸Šå®ç°ï¼Œå¹¶ä¸”æŠŠå®¹é”™å¤„ç†äº¤ç»™äº†ç¨‹åºå‘˜ã€‚</p>
<p>Bulk Synchronous Programming[17]å’Œä¸€äº›MPIåŸè¯­[11]æä¾›äº†æ›´é«˜çº§åˆ«çš„å¹¶è¡Œå¤„ç†æŠ½è±¡ï¼Œå¯ä»¥æ›´å®¹æ˜“å†™å‡ºå¹¶è¡Œå¤„ç†çš„ç¨‹åºã€‚MapReduceå’Œè¿™äº›ç³»ç»Ÿçš„ å…³é”®ä¸åŒä¹‹å¤„åœ¨äºï¼ŒMapReduceåˆ©ç”¨é™åˆ¶æ€§ç¼–ç¨‹æ¨¡å¼å®ç°äº†ç”¨æˆ·ç¨‹åºçš„è‡ªåŠ¨å¹¶å‘å¤„ç†ï¼Œå¹¶ä¸”æä¾›äº†é€æ˜çš„å®¹é”™å¤„ç†ã€‚</p>
<p>æˆ‘ä»¬æ•°æ®æœ¬åœ°ä¼˜åŒ–ç­–ç•¥çš„çµæ„Ÿæ¥æºäºactive disks[12,15]ç­‰æŠ€æœ¯ï¼Œåœ¨active disksä¸­ï¼Œè®¡ç®—ä»»åŠ¡æ˜¯å°½é‡æ¨é€åˆ°æ•°æ®å­˜å‚¨çš„èŠ‚ç‚¹å¤„ç† <strong>ï¼ˆalexæ³¨ï¼šå³é è¿‘æ•°æ®æºå¤„ç†ï¼‰</strong>ï¼Œè¿™æ ·å°±å‡å°‘äº†ç½‘ç»œå’ŒIOå­ç³»ç»Ÿçš„ååé‡ã€‚æˆ‘ä»¬åœ¨æŒ‚è½½å‡ ä¸ªç¡¬ç›˜çš„æ™®é€šæœºå™¨ä¸Šæ‰§è¡Œæˆ‘ä»¬çš„è¿ç®—ï¼Œè€Œä¸æ˜¯åœ¨ç£ç›˜å¤„ç†å™¨ä¸Šæ‰§è¡Œæˆ‘ä»¬çš„å·¥ä½œï¼Œä½†æ˜¯è¾¾åˆ°çš„ç›®çš„ä¸€æ ·çš„ã€‚</p>
<p>æˆ‘ä»¬çš„å¤‡ç”¨ä»»åŠ¡æœºåˆ¶å’ŒCharlotte System[3]æå‡ºçš„eagerè°ƒåº¦æœºåˆ¶æ¯”è¾ƒç±»ä¼¼ã€‚Eagerè°ƒåº¦æœºåˆ¶çš„ä¸€ä¸ªç¼ºç‚¹æ˜¯å¦‚æœä¸€ä¸ªä»»åŠ¡åå¤å¤±æ•ˆï¼Œé‚£ä¹ˆæ•´ä¸ªè®¡ç®—å°±ä¸èƒ½å®Œæˆã€‚æˆ‘ä»¬é€šè¿‡å¿½ç•¥å¼•èµ·æ•…éšœçš„è®°å½•çš„æ–¹å¼åœ¨æŸç§ç¨‹åº¦ä¸Šè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>MapReduceçš„å®ç°ä¾èµ–äºä¸€ä¸ªå†…éƒ¨çš„é›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼Œè¿™ä¸ªé›†ç¾¤ç®¡ç†ç³»ç»Ÿè´Ÿè´£åœ¨ä¸€ä¸ªè¶…å¤§çš„ã€å…±äº«æœºå™¨çš„é›†ç¾¤ä¸Šåˆ†å¸ƒå’Œè¿è¡Œç”¨æˆ·ä»»åŠ¡ã€‚è™½ç„¶è¿™ä¸ªä¸æ˜¯æœ¬è®ºæ–‡çš„é‡ç‚¹ï¼Œä½†æ˜¯æœ‰å¿…è¦æä¸€ä¸‹ï¼Œè¿™ä¸ªé›†ç¾¤ç®¡ç†ç³»ç»Ÿåœ¨ç†å¿µä¸Šå’Œå…¶å®ƒç³»ç»Ÿï¼Œå¦‚Condor[16]æ˜¯ä¸€æ ·ã€‚</p>
<p>MapReduceåº“çš„æ’åºæœºåˆ¶å’ŒNOW-Sort[1]çš„æ“ä½œä¸Šå¾ˆç±»ä¼¼ã€‚è¯»å–è¾“å…¥æºçš„æœºå™¨ï¼ˆmap workersï¼‰æŠŠå¾…æ’åºçš„æ•°æ®è¿›è¡Œåˆ†åŒºåï¼Œå‘é€åˆ°Rä¸ªReduce workerä¸­çš„ä¸€ä¸ªè¿›è¡Œå¤„ç†ã€‚æ¯ä¸ªReduce workeråœ¨æœ¬åœ°å¯¹æ•°æ®è¿›è¡Œæ’åºï¼ˆå°½å¯èƒ½åœ¨å†…å­˜ä¸­æ’åºï¼‰ã€‚å½“ç„¶ï¼ŒNOW-Sortæ²¡æœ‰ç»™ç”¨æˆ·è‡ªå®šä¹‰çš„Mapå’ŒReduceå‡½æ•°çš„æœºä¼šï¼Œå› æ­¤ä¸å…·å¤‡ MapReduceåº“å¹¿æ³›çš„å®ç”¨æ€§ã€‚</p>
<p>River[2]æä¾›äº†ä¸€ä¸ªç¼–ç¨‹æ¨¡å‹ï¼šå¤„ç†è¿›ç¨‹é€šè¿‡åˆ†å¸ƒå¼é˜Ÿåˆ—ä¼ é€æ•°æ®çš„æ–¹å¼è¿›è¡Œäº’ç›¸é€šè®¯ã€‚å’ŒMapReduceç±»ä¼¼ï¼ŒRiverç³»ç»Ÿå°è¯•åœ¨ä¸ å¯¹ç­‰çš„ç¡¬ä»¶ç¯å¢ƒä¸‹ï¼Œæˆ–è€…åœ¨ç³»ç»Ÿé¢ ç°¸çš„æƒ…å†µä¸‹ä¹Ÿèƒ½æä¾›è¿‘ä¼¼å¹³å‡çš„æ€§èƒ½ã€‚Riveræ˜¯é€šè¿‡ç²¾å¿ƒè°ƒåº¦ç¡¬ç›˜å’Œç½‘ç»œçš„é€šè®¯æ¥å¹³è¡¡ä»»åŠ¡çš„å®Œæˆæ—¶é—´ã€‚MapReduce åº“é‡‡ç”¨äº†å…¶å®ƒçš„æ–¹æ³•ã€‚é€šè¿‡å¯¹ç¼–ç¨‹æ¨¡å‹è¿›è¡Œé™åˆ¶ï¼ŒMapReduceæ¡†æ¶æŠŠé—®é¢˜åˆ†è§£æˆä¸ºå¤§é‡çš„â€œå°â€ä»»åŠ¡ã€‚è¿™äº›ä»»åŠ¡åœ¨å¯ç”¨çš„workeré›†ç¾¤ä¸ŠåŠ¨æ€çš„è°ƒåº¦ï¼Œ è¿™æ ·å¿«é€Ÿçš„workerå°±å¯ä»¥æ‰§è¡Œæ›´å¤šçš„ä»»åŠ¡ã€‚é€šè¿‡å¯¹ç¼–ç¨‹æ¨¡å‹è¿›è¡Œé™åˆ¶ï¼Œæˆ‘ä»¬å¯ç”¨åœ¨å·¥ä½œæ¥è¿‘å®Œæˆçš„æ—¶å€™è°ƒåº¦å¤‡ç”¨ä»»åŠ¡ï¼Œç¼©çŸ­åœ¨ç¡¬ä»¶é…ç½®ä¸å‡è¡¡çš„æƒ…å†µä¸‹ç¼©å°æ•´ ä¸ªæ“ä½œå®Œæˆçš„æ—¶é—´ï¼ˆæ¯”å¦‚æœ‰çš„æœºå™¨æ€§èƒ½å·®ã€æˆ–è€…æœºå™¨è¢«æŸäº›æ“ä½œé˜»å¡äº†ï¼‰ã€‚</p>
<p>BAD-FS[5]é‡‡ç”¨äº†å’ŒMapReduceå®Œå…¨ä¸åŒçš„ç¼–ç¨‹æ¨¡å¼ï¼Œå®ƒæ˜¯é¢å‘å¹¿åŸŸç½‘çš„ã€‚ä¸è¿‡ï¼Œè¿™ä¸¤ä¸ªç³»ç»Ÿæœ‰ä¸¤ä¸ªåŸºç¡€åŠŸèƒ½å¾ˆç±»ä¼¼ã€‚</p>
<ul>
<li><p>ï¼ˆ1ï¼‰ä¸¤ä¸ªç³»ç»Ÿé‡‡ç”¨é‡æ–°æ‰§è¡Œçš„æ–¹å¼æ¥é˜²æ­¢ç”±äºå¤±æ•ˆå¯¼è‡´çš„æ•°æ®ä¸¢å¤±ã€‚</p>
</li>
<li><p>ï¼ˆ2ï¼‰ä¸¤ä¸ªéƒ½ä½¿ç”¨æ•°æ®æœ¬åœ°åŒ–è°ƒåº¦ç­–ç•¥ï¼Œå‡å°‘ç½‘ç»œé€šè®¯çš„æ•°æ®é‡ã€‚</p>
</li>
</ul>
<p>TACC[7]æ˜¯ä¸€ä¸ªç”¨äºç®€åŒ–æ„é€ é«˜å¯ç”¨æ€§ç½‘ç»œæœåŠ¡çš„ç³»ç»Ÿã€‚å’ŒMapReduceä¸€æ ·ï¼Œå®ƒä¹Ÿä¾é é‡æ–°æ‰§è¡Œæœºåˆ¶æ¥å®ç°çš„å®¹é”™å¤„ç†ã€‚</p>
<h3 id="8ã€ç»“æŸè¯­"><a href="#8ã€ç»“æŸè¯­" class="headerlink" title="8ã€ç»“æŸè¯­"></a>8ã€ç»“æŸè¯­</h3><p>MapReduceç¼–ç¨‹æ¨¡å‹åœ¨Googleå†…éƒ¨æˆåŠŸåº”ç”¨äºå¤šä¸ªé¢†åŸŸã€‚æˆ‘ä»¬æŠŠè¿™ç§æˆåŠŸå½’ç»“ä¸ºå‡ ä¸ªæ–¹é¢ï¼šé¦–å…ˆï¼Œç”±äºMapReduceå°è£…äº†å¹¶è¡Œå¤„ ç†ã€å®¹é”™å¤„ç†ã€æ•°æ®æœ¬åœ°åŒ–ä¼˜åŒ–ã€è´Ÿè½½å‡è¡¡ç­‰ç­‰æŠ€æœ¯éš¾ç‚¹çš„ç»†èŠ‚ï¼Œè¿™ä½¿å¾—MapReduceåº“æ˜“äºä½¿ç”¨ã€‚å³ä¾¿å¯¹äºå®Œå…¨æ²¡æœ‰å¹¶è¡Œæˆ–è€…åˆ†å¸ƒå¼ç³»ç»Ÿå¼€å‘ç»éªŒçš„ç¨‹åºå‘˜ è€Œè¨€ï¼›å…¶æ¬¡ï¼Œå¤§é‡ä¸åŒç±»å‹çš„é—®é¢˜éƒ½å¯ä»¥é€šè¿‡MapReduceç®€å•çš„è§£å†³ã€‚æ¯”å¦‚ï¼ŒMapReduceç”¨äºç”ŸæˆGoogleçš„ç½‘ç»œæœç´¢æœåŠ¡æ‰€éœ€è¦çš„æ•°æ®ã€ç”¨ æ¥æ’åºã€ç”¨æ¥æ•°æ®æŒ–æ˜ã€ç”¨äºæœºå™¨å­¦ä¹ ï¼Œä»¥åŠå¾ˆå¤šå…¶å®ƒçš„ç³»ç»Ÿï¼›ç¬¬ä¸‰ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªåœ¨æ•°åƒå°è®¡ç®—æœºç»„æˆçš„å¤§å‹é›†ç¾¤ä¸Šçµæ´»éƒ¨ç½²è¿è¡Œçš„MapReduceã€‚è¿™ä¸ª å®ç°ä½¿å¾—æœ‰æ•ˆåˆ©ç”¨è¿™äº›ä¸°å¯Œçš„è®¡ç®—èµ„æºå˜å¾—éå¸¸ç®€å•ï¼Œå› æ­¤ä¹Ÿé€‚åˆç”¨æ¥è§£å†³Googleé‡åˆ°çš„å…¶ä»–å¾ˆå¤šéœ€è¦å¤§é‡è®¡ç®—çš„é—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿä»MapReduceå¼€å‘è¿‡ç¨‹ä¸­å­¦åˆ°äº†ä¸å°‘ä¸œè¥¿ã€‚é¦–å…ˆï¼Œçº¦æŸç¼–ç¨‹æ¨¡å¼ä½¿å¾—å¹¶è¡Œå’Œåˆ†å¸ƒå¼è®¡ç®—éå¸¸å®¹æ˜“ï¼Œä¹Ÿæ˜“äºæ„é€ å®¹é”™çš„è®¡ç®—ç¯å¢ƒï¼›å…¶æ¬¡ï¼Œç½‘ç»œå¸¦ å®½æ˜¯ç¨€æœ‰èµ„æºã€‚å¤§é‡çš„ç³»ç»Ÿä¼˜åŒ–æ˜¯é’ˆå¯¹å‡å°‘ç½‘ç»œä¼ è¾“é‡ä¸ºç›®çš„çš„ï¼šæœ¬åœ°ä¼˜åŒ–ç­–ç•¥ä½¿å¤§é‡çš„æ•°æ®ä»æœ¬åœ°ç£ç›˜è¯»å–ï¼Œä¸­é—´æ–‡ä»¶å†™å…¥æœ¬åœ°ç£ç›˜ã€å¹¶ä¸”åªå†™ä¸€ä»½ä¸­é—´æ–‡ä»¶ä¹ŸèŠ‚ çº¦äº†ç½‘ç»œå¸¦å®½ï¼›ç¬¬ä¸‰ï¼Œå¤šæ¬¡æ‰§è¡Œç›¸åŒçš„ä»»åŠ¡å¯ä»¥å‡å°‘æ€§èƒ½ç¼“æ…¢çš„æœºå™¨å¸¦æ¥çš„è´Ÿé¢å½±å“<strong>ï¼ˆalexæ³¨ï¼šå³ç¡¬ä»¶é…ç½®çš„ä¸å¹³è¡¡ï¼‰</strong>ï¼ŒåŒæ—¶è§£å†³äº†ç”±äºæœºå™¨å¤±æ•ˆå¯¼è‡´çš„æ•°æ®ä¸¢å¤±é—®é¢˜ã€‚</p>
<h3 id="9ã€å‚è€ƒèµ„æ–™"><a href="#9ã€å‚è€ƒèµ„æ–™" class="headerlink" title="9ã€å‚è€ƒèµ„æ–™"></a>9ã€å‚è€ƒèµ„æ–™</h3><p>[1] Andrea C. Arpaci-Dusseau, Remzi H. Arpaci-Dusseau,David E. Culler, Joseph M. Hellerstein, and David A. Patterson.High-performance sorting on networks of workstations.In Proceedings of the 1997 ACM SIGMOD InternationalConference on Management of Data, Tucson,Arizona, May 1997.<br>[2] Remzi H. Arpaci-Dusseau, Eric Anderson, NoahTreuhaft, David E. Culler, Joseph M. Hellerstein, David Patterson, and Kathy Yelick. Cluster I/O with River:Making the fast case common. In Proceedings of the Sixth Workshop on Input/Output in Parallel and Distributed Systems (IOPADS â€™99), pages 10.22, Atlanta, Georgia, May 1999.<br>[3] Arash Baratloo, Mehmet Karaul, Zvi Kedem, and Peter Wyckoff. Charlotte: Metacomputing on the web. In Proceedings of the 9th International Conference on Parallel and Distributed Computing Systems, 1996. [4] Luiz A. Barroso, Jeffrey Dean, and Urs HÂ¨olzle. Web search for a planet: The Google cluster architecture. IEEE Micro, 23(2):22.28, April 2003.<br>[5] John Bent, Douglas Thain, Andrea C.Arpaci-Dusseau, Remzi H. Arpaci-Dusseau, and Miron Livny. Explicit control in a batch-aware distributed file system. In Proceedings of the 1st USENIX Symposium on Networked Systems Design and Implementation NSDI, March 2004.<br>[6] Guy E. Blelloch. Scans as primitive parallel operations.IEEE Transactions on Computers, C-38(11), November 1989.<br>[7] Armando Fox, Steven D. Gribble, Yatin Chawathe, Eric A. Brewer, and Paul Gauthier. Cluster-based scalable network services. In Proceedings of the 16th ACM Symposium on Operating System Principles, pages 78. 91, Saint-Malo, France, 1997.<br>[8] Sanjay Ghemawat, Howard Gobioff, and Shun-Tak Leung. The Google file system. In 19th Symposium on Operating Systems Principles, pages 29.43, Lake George, New York, 2003. To appear in OSDI 2004 12<br>[9] S. Gorlatch. Systematic efficient parallelization of scan and other list homomorphisms. In L. Bouge, P. Fraigniaud, A. Mignotte, and Y. Robert, editors, Euro-Parâ€™96. Parallel Processing, Lecture Notes in Computer Science 1124, pages 401.408. Springer-Verlag, 1996.<br>[10] Jim Gray. Sort benchmark home page. <a href="http://research.microsoft.com/barc/SortBenchmark/" target="_blank" rel="external">http://research.microsoft.com/barc/SortBenchmark/</a>.<br>[11] William Gropp, Ewing Lusk, and Anthony Skjellum. Using MPI: Portable Parallel Programming with the Message-Passing Interface. MIT Press, Cambridge, MA, 1999.<br>[12] L. Huston, R. Sukthankar, R.Wickremesinghe, M. Satyanarayanan, G. R. Ganger, E. Riedel, and A. Ailamaki. Diamond: A storage architecture for early discard in interactive search. In Proceedings of the 2004 USENIX File and Storage Technologies FAST Conference, April 2004.<br>[13] Richard E. Ladner and Michael J. Fischer. Parallel prefix computation. Journal of the ACM, 27(4):831.838, 1980.<br>[14] Michael O. Rabin. Efficient dispersal of information for security, load balancing and fault tolerance. Journal of the ACM, 36(2):335.348, 1989.<br>[15] Erik Riedel, Christos Faloutsos, Garth A. Gibson, and David Nagle. Active disks for large-scale data processing. IEEE Computer, pages 68.74, June 2001.<br>[16] Douglas Thain, Todd Tannenbaum, and Miron Livny. Distributed computing in practice: The Condor experience. Concurrency and Computation: Practice and Experience, 2004.<br>[17] L. G. Valiant. A bridging model for parallel computation. Communications of the ACM, 33(8):103.111, 1997.<br>[18] Jim Wyllie. Spsort: How to sort a terabyte quickly. <a href="http://alme1.almaden.ibm.com/cs/spsort.pdf" target="_blank" rel="external">http://alme1.almaden.ibm.com/cs/spsort.pdf</a>.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Google GFSæ–‡ä»¶ç³»ç»Ÿ]]></title>
      <url>http://zsr.github.io/2016/08/19/Google-GFS%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
      <content type="html"><![CDATA[<h1 id="The-Google-File-Systemä¸­æ–‡ç‰ˆ"><a href="#The-Google-File-Systemä¸­æ–‡ç‰ˆ" class="headerlink" title="The Google File Systemä¸­æ–‡ç‰ˆ"></a>The Google File Systemä¸­æ–‡ç‰ˆ</h1><p>è¯‘è€…ï¼šalex</p>
<h3 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h3><p>æˆ‘ä»¬è®¾è®¡å¹¶å®ç°äº†Google GFSæ–‡ä»¶ç³»ç»Ÿï¼Œä¸€ä¸ªé¢å‘å¤§è§„æ¨¡æ•°æ®å¯†é›†å‹åº”ç”¨çš„ã€å¯ä¼¸ç¼©çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€‚GFSè™½ç„¶è¿è¡Œåœ¨å»‰ä»·çš„æ™®éç¡¬ä»¶è®¾å¤‡ä¸Šï¼Œä½†æ˜¯å®ƒä¾ç„¶äº†æä¾›ç¾éš¾å†—ä½™çš„èƒ½åŠ›ï¼Œä¸ºå¤§é‡å®¢æˆ·æœºæä¾›äº†é«˜æ€§èƒ½çš„æœåŠ¡ã€‚</p>
<p>è™½ç„¶GFSçš„è®¾è®¡ç›®æ ‡ä¸è®¸å¤šä¼ ç»Ÿçš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿæœ‰å¾ˆå¤šç›¸åŒä¹‹å¤„ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬çš„è®¾è®¡è¿˜æ˜¯ä»¥æˆ‘ä»¬å¯¹è‡ªå·±çš„åº”ç”¨çš„è´Ÿè½½æƒ…å†µå’ŒæŠ€æœ¯ç¯å¢ƒçš„åˆ†æä¸ºåŸºç¡€ çš„ï¼Œä¸ç®¡ç°åœ¨è¿˜æ˜¯å°†æ¥ï¼ŒGFSå’Œæ—©æœŸçš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„è®¾æƒ³éƒ½æœ‰æ˜æ˜¾çš„ä¸åŒã€‚æ‰€ä»¥æˆ‘ä»¬é‡æ–°å®¡è§†äº†ä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿåœ¨è®¾è®¡ä¸Šçš„æŠ˜è¡·é€‰æ‹©ï¼Œè¡ç”Ÿå‡ºäº†å®Œå…¨ä¸åŒçš„è®¾è®¡ æ€è·¯ã€‚</p>
<p>GFSå®Œå…¨æ»¡è¶³äº†æˆ‘ä»¬å¯¹å­˜å‚¨çš„éœ€æ±‚ã€‚GFSä½œä¸ºå­˜å‚¨å¹³å°å·²ç»è¢«å¹¿æ³›çš„éƒ¨ç½²åœ¨Googleå†…éƒ¨ï¼Œå­˜å‚¨æˆ‘ä»¬çš„æœåŠ¡äº§ç”Ÿå’Œå¤„ç†çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜ç”¨äºé‚£äº› éœ€è¦å¤§è§„æ¨¡æ•°æ®é›†çš„ç ”ç©¶å’Œå¼€å‘å·¥ä½œã€‚ç›®å‰ä¸ºæ­¢ï¼Œæœ€å¤§çš„ä¸€ä¸ªé›†ç¾¤åˆ©ç”¨æ•°åƒå°æœºå™¨çš„æ•°åƒä¸ªç¡¬ç›˜ï¼Œæä¾›äº†æ•°ç™¾TBçš„å­˜å‚¨ç©ºé—´ï¼ŒåŒæ—¶ä¸ºæ•°ç™¾ä¸ªå®¢æˆ·æœºæœåŠ¡ã€‚</p>
<p>åœ¨æœ¬è®ºæ–‡ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†èƒ½å¤Ÿæ”¯æŒåˆ†å¸ƒå¼åº”ç”¨çš„æ–‡ä»¶ç³»ç»Ÿæ¥å£çš„æ‰©å±•ï¼Œè®¨è®ºæˆ‘ä»¬è®¾è®¡çš„è®¸å¤šæ–¹é¢ï¼Œæœ€ååˆ—å‡ºäº†å°è§„æ¨¡æ€§èƒ½æµ‹è¯•ä»¥åŠçœŸå®ç”Ÿäº§ç³»ç»Ÿä¸­æ€§èƒ½ç›¸å…³æ•°æ®ã€‚</p>
<h3 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h3><p>ä¸ºäº†æ»¡è¶³Googleè¿…é€Ÿå¢é•¿çš„æ•°æ®å¤„ç†éœ€æ±‚ï¼Œæˆ‘ä»¬è®¾è®¡å¹¶å®ç°äº†Googleæ–‡ä»¶ç³»ç»Ÿ(Google File System â€“ GFS)ã€‚GFSä¸ä¼ ç»Ÿçš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿæœ‰ç€å¾ˆå¤šç›¸åŒçš„è®¾è®¡ç›®æ ‡ï¼Œæ¯”å¦‚ï¼Œæ€§èƒ½ã€å¯ä¼¸ç¼©æ€§ã€å¯é æ€§ä»¥åŠå¯ç”¨æ€§ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬çš„è®¾è®¡è¿˜åŸºäºæˆ‘ä»¬å¯¹æˆ‘ä»¬è‡ªå·±çš„åº”ç”¨ çš„è´Ÿè½½æƒ…å†µå’ŒæŠ€æœ¯ç¯å¢ƒçš„è§‚å¯Ÿçš„å½±å“ï¼Œä¸ç®¡ç°åœ¨è¿˜æ˜¯å°†æ¥ï¼ŒGFSå’Œæ—©æœŸæ–‡ä»¶ç³»ç»Ÿçš„å‡è®¾éƒ½æœ‰æ˜æ˜¾çš„ä¸åŒã€‚æ‰€ä»¥æˆ‘ä»¬é‡æ–°å®¡è§†äº†ä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿåœ¨è®¾è®¡ä¸Šçš„æŠ˜è¡·é€‰æ‹©ï¼Œ è¡ç”Ÿå‡ºäº†å®Œå…¨ä¸åŒçš„è®¾è®¡æ€è·¯ã€‚</p>
<ul>
<li><p>é¦–å…ˆï¼Œç»„ä»¶å¤±æ•ˆè¢«è®¤ä¸ºæ˜¯å¸¸æ€äº‹ä»¶ï¼Œè€Œä¸æ˜¯æ„å¤–äº‹ä»¶ã€‚GFSåŒ…æ‹¬å‡ ç™¾ç”šè‡³å‡ åƒå°æ™®é€šçš„å»‰ä»·è®¾å¤‡ç»„è£…çš„å­˜å‚¨æœºå™¨ï¼ŒåŒæ—¶è¢«ç›¸å½“æ•°é‡çš„å®¢æˆ·æœºè®¿é—®ã€‚ GFSç»„ä»¶çš„æ•°é‡å’Œè´¨é‡å¯¼è‡´åœ¨äº‹å®ä¸Šï¼Œä»»ä½•ç»™å®šæ—¶é—´å†…éƒ½æœ‰å¯èƒ½å‘ç”ŸæŸäº›ç»„ä»¶æ— æ³•å·¥ä½œï¼ŒæŸäº›ç»„ä»¶æ— æ³•ä»å®ƒä»¬ç›®å‰çš„å¤±æ•ˆçŠ¶æ€ä¸­æ¢å¤ã€‚æˆ‘ä»¬é‡åˆ°è¿‡å„ç§å„æ ·çš„é—® é¢˜ï¼Œæ¯”å¦‚åº”ç”¨ç¨‹åºbugã€æ“ä½œç³»ç»Ÿçš„bugã€äººä¸ºå¤±è¯¯ï¼Œç”šè‡³è¿˜æœ‰ç¡¬ç›˜ã€å†…å­˜ã€è¿æ¥å™¨ã€ç½‘ç»œä»¥åŠç”µæºå¤±æ•ˆç­‰é€ æˆçš„é—®é¢˜ã€‚æ‰€ä»¥ï¼ŒæŒç»­çš„ç›‘æ§ã€é”™è¯¯ä¾¦æµ‹ã€ç¾éš¾å†— ä½™ä»¥åŠè‡ªåŠ¨æ¢å¤çš„æœºåˆ¶å¿…é¡»é›†æˆåœ¨GFSä¸­ã€‚</p>
</li>
<li><p>å…¶æ¬¡ï¼Œä»¥é€šå¸¸çš„æ ‡å‡†è¡¡é‡ï¼Œæˆ‘ä»¬çš„æ–‡ä»¶éå¸¸å·¨å¤§ã€‚æ•°GBçš„æ–‡ä»¶éå¸¸æ™®éã€‚æ¯ä¸ªæ–‡ä»¶é€šå¸¸éƒ½åŒ…å«è®¸å¤šåº”ç”¨ç¨‹åºå¯¹è±¡ï¼Œæ¯”å¦‚webæ–‡æ¡£ã€‚å½“æˆ‘ä»¬ç»å¸¸éœ€è¦å¤„ ç†å¿«é€Ÿå¢é•¿çš„ã€å¹¶ä¸”ç”±æ•°äº¿ä¸ªå¯¹è±¡æ„æˆçš„ã€æ•°ä»¥TBçš„æ•°æ®é›†æ—¶ï¼Œé‡‡ç”¨ç®¡ç†æ•°äº¿ä¸ªKBå¤§å°çš„å°æ–‡ä»¶çš„æ–¹å¼æ˜¯éå¸¸ä¸æ˜æ™ºçš„ï¼Œå°½ç®¡æœ‰äº›æ–‡ä»¶ç³»ç»Ÿæ”¯æŒè¿™æ ·çš„ç®¡ç†æ–¹ å¼ã€‚å› æ­¤ï¼Œè®¾è®¡çš„å‡è®¾æ¡ä»¶å’Œå‚æ•°ï¼Œæ¯”å¦‚I/Oæ“ä½œå’ŒBlockçš„å°ºå¯¸éƒ½éœ€è¦é‡æ–°è€ƒè™‘ã€‚</p>
</li>
<li><p>ç¬¬ä¸‰ï¼Œç»å¤§éƒ¨åˆ†æ–‡ä»¶çš„ä¿®æ”¹æ˜¯é‡‡ç”¨åœ¨æ–‡ä»¶å°¾éƒ¨è¿½åŠ æ•°æ®ï¼Œè€Œä¸æ˜¯è¦†ç›–åŸæœ‰æ•°æ®çš„æ–¹å¼ã€‚å¯¹æ–‡ä»¶çš„éšæœºå†™å…¥æ“ä½œåœ¨å®é™…ä¸­å‡ ä¹ä¸å­˜åœ¨ã€‚ä¸€æ—¦å†™å®Œä¹‹åï¼Œå¯¹æ–‡ ä»¶çš„æ“ä½œå°±åªæœ‰è¯»ï¼Œè€Œä¸”é€šå¸¸æ˜¯æŒ‰é¡ºåºè¯»ã€‚å¤§é‡çš„æ•°æ®ç¬¦åˆè¿™äº›ç‰¹æ€§ï¼Œæ¯”å¦‚ï¼šæ•°æ®åˆ†æç¨‹åºæ‰«æçš„è¶…å¤§çš„æ•°æ®é›†ï¼›æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºç”Ÿæˆçš„è¿ç»­çš„æ•°æ®æµï¼›å­˜æ¡£çš„ æ•°æ®ï¼›ç”±ä¸€å°æœºå™¨ç”Ÿæˆã€å¦å¤–ä¸€å°æœºå™¨å¤„ç†çš„ä¸­é—´æ•°æ®ï¼Œè¿™äº›ä¸­é—´æ•°æ®çš„å¤„ç†å¯èƒ½æ˜¯åŒæ—¶è¿›è¡Œçš„ã€ä¹Ÿå¯èƒ½æ˜¯åç»­æ‰å¤„ç†çš„ã€‚å¯¹äºè¿™ç§é’ˆå¯¹æµ·é‡æ–‡ä»¶çš„è®¿é—®æ¨¡å¼ï¼Œå®¢æˆ· ç«¯å¯¹æ•°æ®å—ç¼“å­˜æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæ•°æ®çš„è¿½åŠ æ“ä½œæ˜¯æ€§èƒ½ä¼˜åŒ–å’ŒåŸå­æ€§ä¿è¯çš„ä¸»è¦è€ƒé‡å› ç´ ã€‚</p>
</li>
<li><p>ç¬¬å››ï¼Œåº”ç”¨ç¨‹åºå’Œæ–‡ä»¶ç³»ç»ŸAPIçš„ååŒè®¾è®¡æé«˜äº†æ•´ä¸ªç³»ç»Ÿçš„çµæ´»æ€§ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬æ”¾æ¾äº†å¯¹GFSä¸€è‡´æ€§æ¨¡å‹çš„è¦æ±‚ï¼Œè¿™æ ·å°±å‡è½»äº†æ–‡ä»¶ç³»ç»Ÿå¯¹åº”ç”¨ç¨‹ åºçš„è‹›åˆ»è¦æ±‚ï¼Œå¤§å¤§ç®€åŒ–äº†GFSçš„è®¾è®¡ã€‚æˆ‘ä»¬å¼•å…¥äº†åŸå­æ€§çš„è®°å½•è¿½åŠ æ“ä½œï¼Œä»è€Œä¿è¯å¤šä¸ªå®¢æˆ·ç«¯èƒ½å¤ŸåŒæ—¶è¿›è¡Œè¿½åŠ æ“ä½œï¼Œä¸éœ€è¦é¢å¤–çš„åŒæ­¥æ“ä½œæ¥ä¿è¯æ•°æ®çš„ä¸€ è‡´æ€§ã€‚æœ¬æ–‡åé¢è¿˜æœ‰å¯¹è¿™äº›é—®é¢˜çš„ç»†èŠ‚çš„è¯¦ç»†è®¨è®ºã€‚</p>
</li>
</ul>
<p>Googleå·²ç»é’ˆå¯¹ä¸åŒçš„åº”ç”¨éƒ¨ç½²äº†å¤šå¥—GFSé›†ç¾¤ã€‚æœ€å¤§çš„ä¸€ä¸ªé›†ç¾¤æ‹¥æœ‰è¶…è¿‡1000ä¸ªå­˜å‚¨èŠ‚ç‚¹ï¼Œè¶…è¿‡300TBçš„ç¡¬ç›˜ç©ºé—´ï¼Œè¢«ä¸åŒæœºå™¨ä¸Šçš„æ•°ç™¾ä¸ªå®¢æˆ·ç«¯è¿ç»­ä¸æ–­çš„é¢‘ç¹è®¿é—®ã€‚ </p>
<h3 id="2-è®¾è®¡æ¦‚è¿°"><a href="#2-è®¾è®¡æ¦‚è¿°" class="headerlink" title="2 è®¾è®¡æ¦‚è¿°"></a>2 è®¾è®¡æ¦‚è¿°</h3><h4 id="2-1-è®¾è®¡é¢„æœŸ"><a href="#2-1-è®¾è®¡é¢„æœŸ" class="headerlink" title="2.1 è®¾è®¡é¢„æœŸ"></a>2.1 è®¾è®¡é¢„æœŸ</h4><p>åœ¨è®¾è®¡æ»¡è¶³æˆ‘ä»¬éœ€æ±‚çš„æ–‡ä»¶ç³»ç»Ÿæ—¶å€™ï¼Œæˆ‘ä»¬çš„è®¾è®¡ç›®æ ‡æ—¢æœ‰æœºä¼šã€åˆæœ‰æŒ‘æˆ˜ã€‚ä¹‹å‰æˆ‘ä»¬å·²ç»æåˆ°äº†ä¸€äº›éœ€è¦å…³æ³¨çš„å…³é”®ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬å°†è®¾è®¡çš„é¢„æœŸç›®æ ‡çš„ç»†èŠ‚å±•å¼€è®¨è®ºã€‚</p>
<ul>
<li><p>ç³»ç»Ÿç”±è®¸å¤šå»‰ä»·çš„æ™®é€šç»„ä»¶ç»„æˆï¼Œç»„ä»¶å¤±æ•ˆæ˜¯ä¸€ç§å¸¸æ€ã€‚ç³»ç»Ÿå¿…é¡»æŒç»­ç›‘æ§è‡ªèº«çš„çŠ¶æ€ï¼Œå®ƒå¿…é¡»å°†ç»„ä»¶å¤±æ•ˆä½œä¸ºä¸€ç§å¸¸æ€ï¼Œèƒ½å¤Ÿè¿…é€Ÿåœ°ä¾¦æµ‹ã€å†—ä½™å¹¶æ¢å¤å¤±æ•ˆçš„ç»„ä»¶ã€‚</p>
</li>
<li><p>ç³»ç»Ÿå­˜å‚¨ä¸€å®šæ•°é‡çš„å¤§æ–‡ä»¶ã€‚æˆ‘ä»¬é¢„æœŸä¼šæœ‰å‡ ç™¾ä¸‡æ–‡ä»¶ï¼Œæ–‡ä»¶çš„å¤§å°é€šå¸¸åœ¨100MBæˆ–è€…ä»¥ä¸Šã€‚æ•°ä¸ªGBå¤§å°çš„æ–‡ä»¶ä¹Ÿæ˜¯æ™®éå­˜åœ¨ï¼Œå¹¶ä¸”è¦èƒ½å¤Ÿè¢«æœ‰æ•ˆçš„ç®¡ç†ã€‚ç³»ç»Ÿä¹Ÿå¿…é¡»æ”¯æŒå°æ–‡ä»¶ï¼Œä½†æ˜¯ä¸éœ€è¦é’ˆå¯¹å°æ–‡ä»¶åšä¸“é—¨çš„ä¼˜åŒ–ã€‚</p>
</li>
<li><p>ç³»ç»Ÿçš„å·¥ä½œè´Ÿè½½ä¸»è¦ç”±ä¸¤ç§è¯»æ“ä½œç»„æˆï¼šå¤§è§„æ¨¡çš„æµå¼è¯»å–å’Œå°è§„æ¨¡çš„éšæœºè¯»å–ã€‚å¤§è§„æ¨¡çš„æµå¼è¯»å–é€šå¸¸ä¸€æ¬¡è¯»å–æ•°ç™¾KBçš„æ•°æ®ï¼Œæ›´å¸¸è§çš„æ˜¯ä¸€æ¬¡è¯»å– 1MBç”šè‡³æ›´å¤šçš„æ•°æ®ã€‚æ¥è‡ªåŒä¸€ä¸ªå®¢æˆ·æœºçš„è¿ç»­æ“ä½œé€šå¸¸æ˜¯è¯»å–åŒä¸€ä¸ªæ–‡ä»¶ä¸­è¿ç»­çš„ä¸€ä¸ªåŒºåŸŸã€‚å°è§„æ¨¡çš„éšæœºè¯»å–é€šå¸¸æ˜¯åœ¨æ–‡ä»¶æŸä¸ªéšæœºçš„ä½ç½®è¯»å–å‡ ä¸ªKBæ•° æ®ã€‚å¦‚æœåº”ç”¨ç¨‹åºå¯¹æ€§èƒ½éå¸¸å…³æ³¨ï¼Œé€šå¸¸çš„åšæ³•æ˜¯æŠŠå°è§„æ¨¡çš„éšæœºè¯»å–æ“ä½œåˆå¹¶å¹¶æ’åºï¼Œä¹‹åæŒ‰é¡ºåºæ‰¹é‡è¯»å–ï¼Œè¿™æ ·å°±é¿å…äº†åœ¨æ–‡ä»¶ä¸­å‰åæ¥å›çš„ç§»åŠ¨è¯»å–ä½ç½®ã€‚</p>
</li>
<li><p>ç³»ç»Ÿçš„å·¥ä½œè´Ÿè½½è¿˜åŒ…æ‹¬è®¸å¤šå¤§è§„æ¨¡çš„ã€é¡ºåºçš„ã€æ•°æ®è¿½åŠ æ–¹å¼çš„å†™æ“ä½œã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯æ¬¡å†™å…¥çš„æ•°æ®çš„å¤§å°å’Œå¤§è§„æ¨¡è¯»ç±»ä¼¼ã€‚æ•°æ®ä¸€æ—¦è¢«å†™å…¥åï¼Œæ–‡ä»¶å°±å¾ˆå°‘ä¼šè¢«ä¿®æ”¹äº†ã€‚ç³»ç»Ÿæ”¯æŒå°è§„æ¨¡çš„éšæœºä½ç½®å†™å…¥æ“ä½œï¼Œä½†æ˜¯å¯èƒ½æ•ˆç‡ä¸å½°ã€‚</p>
</li>
<li><p>ç³»ç»Ÿå¿…é¡»é«˜æ•ˆçš„ã€è¡Œä¸ºå®šä¹‰æ˜ç¡®çš„å®ç°å¤šå®¢æˆ·ç«¯å¹¶è¡Œè¿½åŠ æ•°æ®åˆ°åŒä¸€ä¸ªæ–‡ä»¶é‡Œçš„è¯­æ„ã€‚æˆ‘ä»¬çš„æ–‡ä»¶é€šå¸¸è¢«ç”¨äºâ€ç”Ÿäº§è€…-æ¶ˆè´¹è€…â€œé˜Ÿåˆ—ï¼Œæˆ–è€…å…¶å®ƒå¤šè·¯æ–‡ä»¶åˆå¹¶æ“ä½œã€‚é€šå¸¸ä¼šæœ‰æ•°ç™¾ä¸ªç”Ÿäº§è€…ï¼Œæ¯ä¸ªç”Ÿäº§è€…è¿› ç¨‹è¿è¡Œåœ¨ä¸€å°æœºå™¨ä¸Šï¼ŒåŒæ—¶å¯¹ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œè¿½åŠ æ“ä½œã€‚ä½¿ç”¨æœ€å°çš„åŒæ­¥å¼€é”€æ¥å®ç°çš„åŸå­çš„å¤šè·¯è¿½åŠ æ•°æ®æ“ä½œæ˜¯å¿…ä¸å¯å°‘çš„ã€‚æ–‡ä»¶å¯ä»¥åœ¨ç¨åè¯»å–ï¼Œæˆ–è€…æ˜¯æ¶ˆè´¹è€…åœ¨ è¿½åŠ çš„æ“ä½œçš„åŒæ—¶è¯»å–æ–‡ä»¶ã€‚</p>
</li>
<li><p>é«˜æ€§èƒ½çš„ç¨³å®šç½‘ç»œå¸¦å®½è¿œæ¯”ä½å»¶è¿Ÿé‡è¦ã€‚æˆ‘ä»¬çš„ç›®æ ‡ç¨‹åºç»å¤§éƒ¨åˆ†è¦æ±‚èƒ½å¤Ÿé«˜é€Ÿç‡çš„ã€å¤§æ‰¹é‡çš„å¤„ç†æ•°æ®ï¼Œæå°‘æœ‰ç¨‹åºå¯¹å•ä¸€çš„è¯»å†™æ“ä½œæœ‰ä¸¥æ ¼çš„å“åº”æ—¶é—´è¦æ±‚ã€‚</p>
</li>
</ul>
<h4 id="2-2-æ¥å£"><a href="#2-2-æ¥å£" class="headerlink" title="2.2 æ¥å£"></a>2.2 æ¥å£</h4><p>GFSæä¾›äº†ä¸€å¥—ç±»ä¼¼ä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿçš„APIæ¥å£å‡½æ•°ï¼Œè™½ç„¶å¹¶ä¸æ˜¯ä¸¥æ ¼æŒ‰ç…§POSIXç­‰æ ‡å‡†APIçš„å½¢å¼å®ç°çš„ã€‚æ–‡ä»¶ä»¥åˆ†å±‚ç›®å½•çš„å½¢å¼ç»„ç»‡ï¼Œç”¨è·¯å¾„åæ¥æ ‡è¯†ã€‚æˆ‘ä»¬æ”¯æŒå¸¸ç”¨çš„æ“ä½œï¼Œå¦‚åˆ›å»ºæ–°æ–‡ä»¶ã€åˆ é™¤æ–‡ä»¶ã€æ‰“å¼€æ–‡ä»¶ã€å…³é—­æ–‡ä»¶ã€è¯»å’Œå†™æ–‡ä»¶ã€‚</p>
<p>å¦å¤–ï¼ŒGFSæä¾›äº†å¿«ç…§å’Œè®°å½•è¿½åŠ æ“ä½œã€‚å¿«ç…§ä»¥å¾ˆä½çš„æˆæœ¬åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•æ ‘çš„æ‹·è´ã€‚è®°å½•è¿½åŠ æ“ä½œå…è®¸å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶å¯¹ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œæ•°æ®è¿½ åŠ æ“ä½œï¼ŒåŒæ—¶ä¿è¯æ¯ä¸ªå®¢æˆ·ç«¯çš„è¿½åŠ æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ã€‚è¿™å¯¹äºå®ç°å¤šè·¯ç»“æœåˆå¹¶ï¼Œä»¥åŠâ€ç”Ÿäº§è€…-æ¶ˆè´¹è€…â€é˜Ÿåˆ—éå¸¸æœ‰ç”¨ï¼Œå¤šä¸ªå®¢æˆ·ç«¯å¯ä»¥åœ¨ä¸éœ€è¦é¢å¤–çš„åŒæ­¥é” å®šçš„æƒ…å†µä¸‹ï¼ŒåŒæ—¶å¯¹ä¸€ä¸ªæ–‡ä»¶è¿½åŠ æ•°æ®ã€‚æˆ‘ä»¬å‘ç°è¿™äº›ç±»å‹çš„æ–‡ä»¶å¯¹äºæ„å»ºå¤§å‹åˆ†å¸ƒåº”ç”¨æ˜¯éå¸¸é‡è¦çš„ã€‚å¿«ç…§å’Œè®°å½•è¿½åŠ æ“ä½œå°†åœ¨3.4å’Œ3.3èŠ‚åˆ†åˆ«è®¨è®ºã€‚</p>
<h4 id="2-3-æ¶æ„"><a href="#2-3-æ¶æ„" class="headerlink" title="2.3 æ¶æ„"></a>2.3 æ¶æ„</h4><p>ä¸€ä¸ªGFSé›†ç¾¤åŒ…å«ä¸€ä¸ªå•ç‹¬çš„MasterèŠ‚ç‚¹<strong>(alexæ³¨ï¼šè¿™é‡Œçš„ä¸€ä¸ªå• ç‹¬çš„MasterèŠ‚ç‚¹çš„å«ä¹‰æ˜¯GFSç³»ç»Ÿä¸­åªå­˜åœ¨ä¸€ä¸ªé€»è¾‘ä¸Šçš„Masterç»„ä»¶ã€‚åé¢æˆ‘ä»¬è¿˜ä¼šæåˆ°MasterèŠ‚ç‚¹å¤åˆ¶ï¼Œå› æ­¤ï¼Œä¸ºäº†ç†è§£æ–¹ä¾¿ï¼Œæˆ‘ä»¬æŠŠ MasterèŠ‚ç‚¹è§†ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œä¸€ä¸ªé€»è¾‘çš„MasterèŠ‚ç‚¹åŒ…æ‹¬ä¸¤å°ç‰©ç†ä¸»æœºï¼Œå³ä¸¤å°MasteræœåŠ¡å™¨ï¼‰</strong>ã€å¤šå° ChunkæœåŠ¡å™¨ï¼Œå¹¶ä¸”åŒæ—¶è¢«å¤šä¸ªå®¢æˆ·ç«¯è®¿é—®ï¼Œå¦‚å›¾1æ‰€ç¤ºã€‚æ‰€æœ‰çš„è¿™äº›æœºå™¨é€šå¸¸éƒ½æ˜¯æ™®é€šçš„Linuxæœºå™¨ï¼Œè¿è¡Œç€ç”¨æˆ·çº§åˆ«(user-level)çš„æœåŠ¡ è¿›ç¨‹ã€‚æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„æŠŠChunkæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ”¾åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œå‰ææ˜¯æœºå™¨èµ„æºå…è®¸ï¼Œå¹¶ä¸”æˆ‘ä»¬èƒ½å¤Ÿæ¥å—ä¸å¯é çš„åº”ç”¨ç¨‹åºä»£ç å¸¦æ¥çš„ç¨³å®šæ€§é™ä½çš„é£é™©ã€‚</p>
<p><img src="/images/GFS2-3.jpg"></p>
<p>GFSå­˜å‚¨çš„æ–‡ä»¶éƒ½è¢«åˆ†å‰²æˆå›ºå®šå¤§å°çš„Chunkã€‚åœ¨Chunkåˆ›å»ºçš„æ—¶å€™ï¼ŒMasteræœåŠ¡å™¨ä¼šç»™æ¯ä¸ªChunkåˆ†é…ä¸€ä¸ªä¸å˜çš„ã€å…¨çƒå”¯ä¸€çš„ 64ä½çš„Chunkæ ‡è¯†ã€‚ChunkæœåŠ¡å™¨æŠŠChunkä»¥linuxæ–‡ä»¶çš„å½¢å¼ä¿å­˜åœ¨æœ¬åœ°ç¡¬ç›˜ä¸Šï¼Œå¹¶ä¸”æ ¹æ®æŒ‡å®šçš„Chunkæ ‡è¯†å’Œå­—èŠ‚èŒƒå›´æ¥è¯»å†™å—æ•°æ®ã€‚ å‡ºäºå¯é æ€§çš„è€ƒè™‘ï¼Œæ¯ä¸ªå—éƒ½ä¼šå¤åˆ¶åˆ°å¤šä¸ªå—æœåŠ¡å™¨ä¸Šã€‚ç¼ºçœæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨3ä¸ªå­˜å‚¨å¤åˆ¶èŠ‚ç‚¹ï¼Œä¸è¿‡ç”¨æˆ·å¯ä»¥ä¸ºä¸åŒçš„æ–‡ä»¶å‘½åç©ºé—´è®¾å®šä¸åŒçš„å¤åˆ¶çº§åˆ«ã€‚</p>
<p>MasterèŠ‚ç‚¹ç®¡ç†æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®ã€‚è¿™äº›å…ƒæ•°æ®åŒ…æ‹¬åå­—ç©ºé—´ã€è®¿é—®æ§åˆ¶ä¿¡æ¯ã€æ–‡ä»¶å’ŒChunkçš„æ˜ å°„ä¿¡æ¯ã€ä»¥åŠå½“å‰Chunkçš„ä½ç½®ä¿¡æ¯ã€‚MasterèŠ‚ç‚¹è¿˜ç®¡ç†ç€ç³»ç»ŸèŒƒå›´å†…çš„æ´»åŠ¨ï¼Œæ¯”å¦‚ï¼ŒChunkç§Ÿç”¨ç®¡ç† <strong>(alexæ³¨ï¼šBDBä¹Ÿæœ‰å…³äºleaseçš„æè¿°ï¼Œä¸çŸ¥é“æ˜¯å¦ç›¸åŒ)</strong>ã€å­¤å„¿Chunk <strong>(alexæ³¨ï¼šorphaned chunks)</strong>çš„å›æ”¶ã€ä»¥åŠChunkåœ¨ChunkæœåŠ¡å™¨ä¹‹é—´çš„è¿ç§»ã€‚MasterèŠ‚ç‚¹ä½¿ç”¨å¿ƒè·³ä¿¡æ¯å‘¨æœŸåœ°å’Œæ¯ä¸ªChunkæœåŠ¡å™¨é€šè®¯ï¼Œå‘é€æŒ‡ä»¤åˆ°å„ä¸ªChunkæœåŠ¡å™¨å¹¶æ¥æ”¶ChunkæœåŠ¡å™¨çš„çŠ¶æ€ä¿¡æ¯ã€‚</p>
<p>GFSå®¢æˆ·ç«¯ä»£ç ä»¥åº“çš„å½¢å¼è¢«é“¾æ¥åˆ°å®¢æˆ·ç¨‹åºé‡Œã€‚å®¢æˆ·ç«¯ä»£ç å®ç°äº†GFSæ–‡ä»¶ç³»ç»Ÿçš„APIæ¥å£å‡½æ•°ã€åº”ç”¨ç¨‹åºä¸MasterèŠ‚ç‚¹å’ŒChunkæœ åŠ¡å™¨é€šè®¯ã€ä»¥åŠå¯¹æ•°æ®è¿›è¡Œè¯»å†™æ“ä½œã€‚å®¢æˆ·ç«¯å’ŒMasterèŠ‚ç‚¹çš„é€šä¿¡åªè·å–å…ƒæ•°æ®ï¼Œæ‰€æœ‰çš„æ•°æ®æ“ä½œéƒ½æ˜¯ç”±å®¢æˆ·ç«¯ç›´æ¥å’ŒChunkæœåŠ¡å™¨è¿›è¡Œäº¤äº’çš„ã€‚æˆ‘ä»¬ä¸ æä¾›POSIXæ ‡å‡†çš„APIçš„åŠŸèƒ½ï¼Œå› æ­¤ï¼ŒGFS APIè°ƒç”¨ä¸éœ€è¦æ·±å…¥åˆ°Linux vnodeçº§åˆ«ã€‚</p>
<p>æ— è®ºæ˜¯å®¢æˆ·ç«¯è¿˜æ˜¯ChunkæœåŠ¡å™¨éƒ½ä¸éœ€è¦ç¼“å­˜æ–‡ä»¶æ•°æ®ã€‚å®¢æˆ·ç«¯ç¼“å­˜æ•°æ®å‡ ä¹æ²¡æœ‰ä»€ä¹ˆç”¨å¤„ï¼Œå› ä¸ºå¤§éƒ¨åˆ†ç¨‹åºè¦ä¹ˆä»¥æµçš„æ–¹å¼è¯»å–ä¸€ä¸ªå·¨å¤§æ–‡ä»¶ï¼Œè¦ ä¹ˆå·¥ä½œé›†å¤ªå¤§æ ¹æœ¬æ— æ³•è¢«ç¼“å­˜ã€‚æ— éœ€è€ƒè™‘ç¼“å­˜ç›¸å…³çš„é—®é¢˜ä¹Ÿç®€åŒ–äº†å®¢æˆ·ç«¯å’Œæ•´ä¸ªç³»ç»Ÿçš„è®¾è®¡å’Œå®ç°ã€‚ï¼ˆä¸è¿‡ï¼Œå®¢æˆ·ç«¯ä¼šç¼“å­˜å…ƒæ•°æ®ã€‚ï¼‰ChunkæœåŠ¡å™¨ä¸éœ€è¦ç¼“å­˜ æ–‡ä»¶æ•°æ®çš„åŸå› æ˜¯ï¼ŒChunkä»¥æœ¬åœ°æ–‡ä»¶çš„æ–¹å¼ä¿å­˜ï¼ŒLinuxæ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¼šæŠŠç»å¸¸è®¿é—®çš„æ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚</p>
<h4 id="2-4-å•ä¸€MasterèŠ‚ç‚¹"><a href="#2-4-å•ä¸€MasterèŠ‚ç‚¹" class="headerlink" title="2.4 å•ä¸€MasterèŠ‚ç‚¹"></a>2.4 å•ä¸€MasterèŠ‚ç‚¹</h4><p>å•ä¸€çš„MasterèŠ‚ç‚¹çš„ç­–ç•¥å¤§å¤§ç®€åŒ–äº†æˆ‘ä»¬çš„è®¾è®¡ã€‚å•ä¸€çš„MasterèŠ‚ç‚¹å¯ä»¥é€šè¿‡å…¨å±€çš„ä¿¡æ¯ç²¾ç¡®å®šä½Chunkçš„ä½ç½®ä»¥åŠè¿›è¡Œå¤åˆ¶å†³ç­–ã€‚å¦ å¤–ï¼Œæˆ‘ä»¬å¿…é¡»å‡å°‘å¯¹MasterèŠ‚ç‚¹çš„è¯»å†™ï¼Œé¿å…MasterèŠ‚ç‚¹æˆä¸ºç³»ç»Ÿçš„ç“¶é¢ˆã€‚å®¢æˆ·ç«¯å¹¶ä¸é€šè¿‡MasterèŠ‚ç‚¹è¯»å†™æ–‡ä»¶æ•°æ®ã€‚åä¹‹ï¼Œå®¢æˆ·ç«¯å‘ MasterèŠ‚ç‚¹è¯¢é—®å®ƒåº”è¯¥è”ç³»çš„ChunkæœåŠ¡å™¨ã€‚å®¢æˆ·ç«¯å°†è¿™äº›å…ƒæ•°æ®ä¿¡æ¯ç¼“å­˜ä¸€æ®µæ—¶é—´ï¼Œåç»­çš„æ“ä½œå°†ç›´æ¥å’ŒChunkæœåŠ¡å™¨è¿›è¡Œæ•°æ®è¯»å†™æ“ä½œã€‚</p>
<p>æˆ‘ä»¬åˆ©ç”¨å›¾1è§£é‡Šä¸€ä¸‹ä¸€æ¬¡ç®€å•è¯»å–çš„æµç¨‹ã€‚é¦–å…ˆï¼Œå®¢æˆ·ç«¯æŠŠæ–‡ä»¶åå’Œç¨‹åºæŒ‡å®šçš„å­—èŠ‚åç§»ï¼Œæ ¹æ®å›ºå®šçš„Chunkå¤§å°ï¼Œè½¬æ¢æˆæ–‡ä»¶çš„Chunkç´¢ å¼•ã€‚ç„¶åï¼Œå®ƒæŠŠæ–‡ä»¶åå’ŒChunkç´¢å¼•å‘é€ç»™MasterèŠ‚ç‚¹ã€‚MasterèŠ‚ç‚¹å°†ç›¸åº”çš„Chunkæ ‡è¯†å’Œå‰¯æœ¬çš„ä½ç½®ä¿¡æ¯å‘è¿˜ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯ç”¨æ–‡ä»¶åå’Œ Chunkç´¢å¼•ä½œä¸ºkeyç¼“å­˜è¿™äº›ä¿¡æ¯ã€‚</p>
<p>ä¹‹åå®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ°å…¶ä¸­çš„ä¸€ä¸ªå‰¯æœ¬å¤„ï¼Œä¸€èˆ¬ä¼šé€‰æ‹©æœ€è¿‘çš„ã€‚è¯·æ±‚ä¿¡æ¯åŒ…å«äº†Chunkçš„æ ‡è¯†å’Œå­—èŠ‚èŒƒå›´ã€‚åœ¨å¯¹è¿™ä¸ªChunkçš„åç»­è¯»å–æ“ä½œä¸­ï¼Œ å®¢æˆ·ç«¯ä¸å¿…å†å’ŒMasterèŠ‚ç‚¹é€šè®¯äº†ï¼Œé™¤éç¼“å­˜çš„å…ƒæ•°æ®ä¿¡æ¯è¿‡æœŸæˆ–è€…æ–‡ä»¶è¢«é‡æ–°æ‰“å¼€ã€‚å®é™…ä¸Šï¼Œå®¢æˆ·ç«¯é€šå¸¸ä¼šåœ¨ä¸€æ¬¡è¯·æ±‚ä¸­æŸ¥è¯¢å¤šä¸ªChunkä¿¡ æ¯ï¼ŒMasterèŠ‚ç‚¹çš„å›åº”ä¹Ÿå¯èƒ½åŒ…å«äº†ç´§è·Ÿç€è¿™äº›è¢«è¯·æ±‚çš„Chunkåé¢çš„Chunkçš„ä¿¡æ¯ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™äº›é¢å¤–çš„ä¿¡æ¯åœ¨æ²¡æœ‰ä»»ä½•ä»£ä»·çš„æƒ…å†µä¸‹ï¼Œé¿ å…äº†å®¢æˆ·ç«¯å’ŒMasterèŠ‚ç‚¹æœªæ¥å¯èƒ½ä¼šå‘ç”Ÿçš„å‡ æ¬¡é€šè®¯ã€‚</p>
<h4 id="2-5-Chunkå°ºå¯¸"><a href="#2-5-Chunkå°ºå¯¸" class="headerlink" title="2.5 Chunkå°ºå¯¸"></a>2.5 Chunkå°ºå¯¸</h4><p>Chunkçš„å¤§å°æ˜¯å…³é”®çš„è®¾è®¡å‚æ•°ä¹‹ä¸€ã€‚æˆ‘ä»¬é€‰æ‹©äº†64MBï¼Œè¿™ä¸ªå°ºå¯¸è¿œè¿œå¤§äºä¸€èˆ¬æ–‡ä»¶ç³»ç»Ÿçš„Block sizeã€‚æ¯ä¸ªChunkçš„å‰¯æœ¬éƒ½ä»¥æ™®é€šLinuxæ–‡ä»¶çš„å½¢å¼ä¿å­˜åœ¨ChunkæœåŠ¡å™¨ä¸Šï¼Œåªæœ‰åœ¨éœ€è¦çš„æ—¶å€™æ‰æ‰©å¤§ã€‚æƒ°æ€§ç©ºé—´åˆ†é…ç­–ç•¥é¿å…äº†å› å†…éƒ¨ç¢ç‰‡é€ æˆ çš„ç©ºé—´æµªè´¹ï¼Œå†…éƒ¨ç¢ç‰‡æˆ–è®¸æ˜¯å¯¹é€‰æ‹©è¿™ä¹ˆå¤§çš„Chunkå°ºå¯¸æœ€å…·äº‰è®®ä¸€ç‚¹ã€‚</p>
<p>é€‰æ‹©è¾ƒå¤§çš„Chunkå°ºå¯¸æœ‰å‡ ä¸ªé‡è¦çš„ä¼˜ç‚¹ã€‚é¦–å…ˆï¼Œå®ƒå‡å°‘äº†å®¢æˆ·ç«¯å’ŒMasterèŠ‚ç‚¹é€šè®¯çš„éœ€æ±‚ï¼Œå› ä¸ºåªéœ€è¦ä¸€æ¬¡å’ŒMaterèŠ‚ç‚¹çš„é€šä¿¡å°±å¯ä»¥ è·å–Chunkçš„ä½ç½®ä¿¡æ¯ï¼Œä¹‹åå°±å¯ä»¥å¯¹åŒä¸€ä¸ªChunkè¿›è¡Œå¤šæ¬¡çš„è¯»å†™æ“ä½œã€‚è¿™ç§æ–¹å¼å¯¹é™ä½æˆ‘ä»¬çš„å·¥ä½œè´Ÿè½½æ¥è¯´æ•ˆæœæ˜¾è‘—ï¼Œå› ä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºé€šå¸¸æ˜¯è¿ç»­ è¯»å†™å¤§æ–‡ä»¶ã€‚å³ä½¿æ˜¯å°è§„æ¨¡çš„éšæœºè¯»å–ï¼Œé‡‡ç”¨è¾ƒå¤§çš„Chunkå°ºå¯¸ä¹Ÿå¸¦æ¥æ˜æ˜¾çš„å¥½å¤„ï¼Œå®¢æˆ·ç«¯å¯ä»¥è½»æ¾çš„ç¼“å­˜ä¸€ä¸ªæ•°TBçš„å·¥ä½œæ•°æ®é›†æ‰€æœ‰çš„Chunkä½ç½®ä¿¡ æ¯ã€‚å…¶æ¬¡ï¼Œé‡‡ç”¨è¾ƒå¤§çš„Chunkå°ºå¯¸ï¼Œå®¢æˆ·ç«¯èƒ½å¤Ÿå¯¹ä¸€ä¸ªå—è¿›è¡Œå¤šæ¬¡æ“ä½œï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡ä¸ChunkæœåŠ¡å™¨ä¿æŒè¾ƒé•¿æ—¶é—´çš„TCPè¿æ¥æ¥å‡å°‘ç½‘ç»œè´Ÿè½½ã€‚ç¬¬ ä¸‰ï¼Œé€‰ç”¨è¾ƒå¤§çš„Chunkå°ºå¯¸å‡å°‘äº†MasterèŠ‚ç‚¹éœ€è¦ä¿å­˜çš„å…ƒæ•°æ®çš„æ•°é‡ã€‚è¿™å°±å…è®¸æˆ‘ä»¬æŠŠå…ƒæ•°æ®å…¨éƒ¨æ”¾åœ¨å†…å­˜ä¸­ï¼Œåœ¨2.6.1èŠ‚æˆ‘ä»¬ä¼šè®¨è®ºå…ƒæ•°æ®å…¨éƒ¨ æ”¾åœ¨å†…å­˜ä¸­å¸¦æ¥çš„é¢å¤–çš„å¥½å¤„ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œå³ä½¿é…åˆæƒ°æ€§ç©ºé—´åˆ†é…ï¼Œé‡‡ç”¨è¾ƒå¤§çš„Chunkå°ºå¯¸ä¹Ÿæœ‰å…¶ç¼ºé™·ã€‚å°æ–‡ä»¶åŒ…å«è¾ƒå°‘çš„Chunkï¼Œç”šè‡³åªæœ‰ä¸€ä¸ªChunkã€‚å½“æœ‰è®¸å¤šçš„å®¢æˆ· ç«¯å¯¹åŒä¸€ä¸ªå°æ–‡ä»¶è¿›è¡Œå¤šæ¬¡çš„è®¿é—®æ—¶ï¼Œå­˜å‚¨è¿™äº›Chunkçš„ChunkæœåŠ¡å™¨å°±ä¼šå˜æˆçƒ­ç‚¹ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œç”±äºæˆ‘ä»¬çš„ç¨‹åºé€šå¸¸æ˜¯è¿ç»­çš„è¯»å–åŒ…å«å¤šä¸ª Chunkçš„å¤§æ–‡ä»¶ï¼Œçƒ­ç‚¹è¿˜ä¸æ˜¯ä¸»è¦çš„é—®é¢˜ã€‚</p>
<p>ç„¶è€Œï¼Œå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡æŠŠGFSç”¨äºæ‰¹å¤„ç†é˜Ÿåˆ—ç³»ç»Ÿçš„æ—¶å€™ï¼Œçƒ­ç‚¹çš„é—®é¢˜è¿˜æ˜¯äº§ç”Ÿäº†ï¼šä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶åœ¨GFSä¸Šä¿å­˜ä¸ºsingle-chunkæ–‡ä»¶ï¼Œ ä¹‹åè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶åœ¨æ•°ç™¾å°æœºå™¨ä¸ŠåŒæ—¶å¯åŠ¨ã€‚å­˜æ”¾è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„å‡ ä¸ªChunkæœåŠ¡å™¨è¢«æ•°ç™¾ä¸ªå®¢æˆ·ç«¯çš„å¹¶å‘è¯·æ±‚è®¿é—®å¯¼è‡´ç³»ç»Ÿå±€éƒ¨è¿‡è½½ã€‚æˆ‘ä»¬é€šè¿‡ä½¿ç”¨æ›´å¤§ çš„å¤åˆ¶å‚æ•°æ¥ä¿å­˜å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä»¥åŠé”™å¼€æ‰¹å¤„ç†é˜Ÿåˆ—ç³»ç»Ÿç¨‹åºçš„å¯åŠ¨æ—¶é—´çš„æ–¹æ³•è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ä¸€ä¸ªå¯èƒ½çš„é•¿æ•ˆè§£å†³æ–¹æ¡ˆæ˜¯ï¼Œåœ¨è¿™ç§çš„æƒ…å†µä¸‹ï¼Œå…è®¸å®¢æˆ·ç«¯ä»å…¶å®ƒ å®¢æˆ·ç«¯è¯»å–æ•°æ®ã€‚</p>
<h4 id="2-6-å…ƒæ•°æ®"><a href="#2-6-å…ƒæ•°æ®" class="headerlink" title="2.6 å…ƒæ•°æ®"></a>2.6 å…ƒæ•°æ®</h4><p>MasteræœåŠ¡å™¨ <strong>ï¼ˆalexæ³¨ï¼šæ³¨æ„é€»è¾‘çš„MasterèŠ‚ç‚¹å’Œç‰©ç†çš„MasteræœåŠ¡å™¨çš„åŒºåˆ«ã€‚åç»­æˆ‘ä»¬è°ˆçš„æ˜¯æ¯ä¸ªMasteræœåŠ¡å™¨çš„è¡Œä¸ºï¼Œå¦‚å­˜å‚¨ã€å†…å­˜ç­‰ç­‰ï¼Œå› æ­¤æˆ‘ä»¬å°†å…¨éƒ¨ä½¿ç”¨ç‰©ç†åç§°ï¼‰</strong>å­˜å‚¨3ç§ä¸»è¦ç±»å‹çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬ï¼šæ–‡ä»¶å’ŒChunkçš„å‘½åç©ºé—´ã€æ–‡ä»¶å’ŒChunkçš„å¯¹åº”å…³ç³»ã€æ¯ä¸ªChunkå‰¯æœ¬çš„å­˜æ”¾åœ°ç‚¹ã€‚æ‰€æœ‰çš„å…ƒæ•°æ®éƒ½ä¿å­˜åœ¨ MasteræœåŠ¡å™¨çš„å†…å­˜ä¸­ã€‚å‰ä¸¤ç§ç±»å‹çš„å…ƒæ•°æ®ï¼ˆå‘½åç©ºé—´ã€æ–‡ä»¶å’ŒChunkçš„å¯¹åº”å…³ç³»ï¼‰åŒæ—¶ä¹Ÿä¼šä»¥è®°å½•å˜æ›´æ—¥å¿—çš„æ–¹å¼è®°å½•åœ¨æ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿæ—¥å¿—æ–‡ä»¶ ä¸­ï¼Œæ—¥å¿—æ–‡ä»¶å­˜å‚¨åœ¨æœ¬åœ°ç£ç›˜ä¸Šï¼ŒåŒæ—¶æ—¥å¿—ä¼šè¢«å¤åˆ¶åˆ°å…¶å®ƒçš„è¿œç¨‹MasteræœåŠ¡å™¨ä¸Šã€‚é‡‡ç”¨ä¿å­˜å˜æ›´æ—¥å¿—çš„æ–¹å¼ï¼Œæˆ‘ä»¬èƒ½å¤Ÿç®€å•å¯é çš„æ›´æ–°MasteræœåŠ¡å™¨ çš„çŠ¶æ€ï¼Œå¹¶ä¸”ä¸ç”¨æ‹…å¿ƒMasteræœåŠ¡å™¨å´©æºƒå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é£é™©ã€‚MasteræœåŠ¡å™¨ä¸ä¼šæŒä¹…ä¿å­˜Chunkä½ç½®ä¿¡æ¯ã€‚MasteræœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶ï¼Œæˆ– è€…æœ‰æ–°çš„ChunkæœåŠ¡å™¨åŠ å…¥æ—¶ï¼Œå‘å„ä¸ªChunkæœåŠ¡å™¨è½®è¯¢å®ƒä»¬æ‰€å­˜å‚¨çš„Chunkçš„ä¿¡æ¯ã€‚</p>
<h5 id="2-6-1-å†…å­˜ä¸­çš„æ•°æ®ç»“æ„"><a href="#2-6-1-å†…å­˜ä¸­çš„æ•°æ®ç»“æ„" class="headerlink" title="2.6.1 å†…å­˜ä¸­çš„æ•°æ®ç»“æ„"></a>2.6.1 å†…å­˜ä¸­çš„æ•°æ®ç»“æ„</h5><p>å› ä¸ºå…ƒæ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ‰€ä»¥MasteræœåŠ¡å™¨çš„æ“ä½œé€Ÿåº¦éå¸¸å¿«ã€‚å¹¶ä¸”ï¼ŒMasteræœåŠ¡å™¨å¯ä»¥åœ¨åå°ç®€å•è€Œé«˜æ•ˆçš„å‘¨æœŸæ€§æ‰«æè‡ªå·±ä¿å­˜çš„å…¨éƒ¨ çŠ¶æ€ä¿¡æ¯ã€‚è¿™ç§å‘¨æœŸæ€§çš„çŠ¶æ€æ‰«æä¹Ÿç”¨äºå®ç°Chunkåƒåœ¾æ”¶é›†ã€åœ¨ChunkæœåŠ¡å™¨å¤±æ•ˆçš„æ—¶é‡æ–°å¤åˆ¶æ•°æ®ã€é€šè¿‡Chunkçš„è¿ç§»å®ç°è·¨ChunkæœåŠ¡å™¨çš„ è´Ÿè½½å‡è¡¡ä»¥åŠç£ç›˜ä½¿ç”¨çŠ¶å†µç»Ÿè®¡ç­‰åŠŸèƒ½ã€‚4.3å’Œ4.4ç« èŠ‚å°†æ·±å…¥è®¨è®ºè¿™äº›è¡Œä¸ºã€‚</p>
<p>å°†å…ƒæ•°æ®å…¨éƒ¨ä¿å­˜åœ¨å†…å­˜ä¸­çš„æ–¹æ³•æœ‰æ½œåœ¨é—®é¢˜ï¼šChunkçš„æ•°é‡ä»¥åŠæ•´ä¸ªç³»ç»Ÿçš„æ‰¿è½½èƒ½åŠ›éƒ½å—é™äºMasteræœåŠ¡å™¨æ‰€æ‹¥æœ‰çš„å†…å­˜å¤§å°ã€‚ä½†æ˜¯åœ¨å®é™… åº”ç”¨ä¸­ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ã€‚MasteræœåŠ¡å™¨åªéœ€è¦ä¸åˆ°64ä¸ªå­—èŠ‚çš„å…ƒæ•°æ®å°±èƒ½å¤Ÿç®¡ç†ä¸€ä¸ª64MBçš„Chunkã€‚ç”±äºå¤§å¤šæ•°æ–‡ä»¶éƒ½åŒ…å«å¤šä¸ª Chunkï¼Œå› æ­¤ç»å¤§å¤šæ•°Chunkéƒ½æ˜¯æ»¡çš„ï¼Œé™¤äº†æ–‡ä»¶çš„æœ€åä¸€ä¸ªChunkæ˜¯éƒ¨åˆ†å¡«å……çš„ã€‚åŒæ ·çš„ï¼Œæ¯ä¸ªæ–‡ä»¶çš„åœ¨å‘½åç©ºé—´ä¸­çš„æ•°æ®å¤§å°é€šå¸¸åœ¨64å­—èŠ‚ä»¥ ä¸‹ï¼Œå› ä¸ºä¿å­˜çš„æ–‡ä»¶åæ˜¯ç”¨å‰ç¼€å‹ç¼©ç®—æ³•å‹ç¼©è¿‡çš„ã€‚</p>
<p>å³ä¾¿æ˜¯éœ€è¦æ”¯æŒæ›´å¤§çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ºMasteræœåŠ¡å™¨å¢åŠ é¢å¤–å†…å­˜çš„è´¹ç”¨æ˜¯å¾ˆå°‘çš„ï¼Œè€Œé€šè¿‡å¢åŠ æœ‰é™çš„è´¹ç”¨ï¼Œæˆ‘ä»¬å°±èƒ½å¤ŸæŠŠå…ƒæ•°æ®å…¨éƒ¨ä¿å­˜åœ¨å†…å­˜é‡Œï¼Œå¢å¼ºäº†ç³»ç»Ÿçš„ç®€æ´æ€§ã€å¯é æ€§ã€é«˜æ€§èƒ½å’Œçµæ´»æ€§ã€‚</p>
<h5 id="2-6-2-Chunkä½ç½®ä¿¡æ¯"><a href="#2-6-2-Chunkä½ç½®ä¿¡æ¯" class="headerlink" title="2.6.2 Chunkä½ç½®ä¿¡æ¯"></a>2.6.2 Chunkä½ç½®ä¿¡æ¯</h5><p>MasteræœåŠ¡å™¨å¹¶ä¸ä¿å­˜æŒä¹…åŒ–ä¿å­˜å“ªä¸ªChunkæœåŠ¡å™¨å­˜æœ‰æŒ‡å®šChunkçš„å‰¯æœ¬çš„ä¿¡æ¯ã€‚MasteræœåŠ¡å™¨åªæ˜¯åœ¨å¯åŠ¨çš„æ—¶å€™è½®è¯¢Chunkæœ åŠ¡å™¨ä»¥è·å–è¿™äº›ä¿¡æ¯ã€‚MasteræœåŠ¡å™¨èƒ½å¤Ÿä¿è¯å®ƒæŒæœ‰çš„ä¿¡æ¯å§‹ç»ˆæ˜¯æœ€æ–°çš„ï¼Œå› ä¸ºå®ƒæ§åˆ¶äº†æ‰€æœ‰çš„Chunkä½ç½®çš„åˆ†é…ï¼Œè€Œä¸”é€šè¿‡å‘¨æœŸæ€§çš„å¿ƒè·³ä¿¡æ¯ç›‘æ§ ChunkæœåŠ¡å™¨çš„çŠ¶æ€ã€‚</p>
<p>æœ€åˆè®¾è®¡æ—¶ï¼Œæˆ‘ä»¬è¯•å›¾æŠŠChunkçš„ä½ç½®ä¿¡æ¯æŒä¹…çš„ä¿å­˜åœ¨MasteræœåŠ¡å™¨ä¸Šï¼Œä½†æ˜¯åæ¥æˆ‘ä»¬å‘ç°åœ¨å¯åŠ¨çš„æ—¶å€™è½®è¯¢ChunkæœåŠ¡å™¨ï¼Œä¹‹åå®šæœŸè½®è¯¢ æ›´æ–°çš„æ–¹å¼æ›´ç®€å•ã€‚è¿™ç§è®¾è®¡ç®€åŒ–äº†åœ¨æœ‰ChunkæœåŠ¡å™¨åŠ å…¥é›†ç¾¤ã€ç¦»å¼€é›†ç¾¤ã€æ›´åã€å¤±æ•ˆã€ä»¥åŠé‡å¯çš„æ—¶å€™ï¼ŒMasteræœåŠ¡å™¨å’ŒChunkæœåŠ¡å™¨æ•°æ®åŒæ­¥ çš„é—®é¢˜ã€‚åœ¨ä¸€ä¸ªæ‹¥æœ‰æ•°ç™¾å°æœåŠ¡å™¨çš„é›†ç¾¤ä¸­ï¼Œè¿™ç±»äº‹ä»¶ä¼šé¢‘ç¹çš„å‘ç”Ÿã€‚</p>
<p>å¯ä»¥ä»å¦å¤–ä¸€ä¸ªè§’åº¦å»ç†è§£è¿™ä¸ªè®¾è®¡å†³ç­–ï¼šåªæœ‰ChunkæœåŠ¡å™¨æ‰èƒ½æœ€ç»ˆç¡®å®šä¸€ä¸ªChunkæ˜¯å¦åœ¨å®ƒçš„ç¡¬ç›˜ä¸Šã€‚æˆ‘ä»¬ä»æ²¡æœ‰è€ƒè™‘è¿‡åœ¨MasteræœåŠ¡å™¨ ä¸Šç»´æŠ¤ä¸€ä¸ªè¿™äº›ä¿¡æ¯çš„å…¨å±€è§†å›¾ï¼Œå› ä¸ºChunkæœåŠ¡å™¨çš„é”™è¯¯å¯èƒ½ä¼šå¯¼è‡´Chunkè‡ªåŠ¨æ¶ˆå¤±(æ¯”å¦‚ï¼Œç¡¬ç›˜æŸåäº†æˆ–è€…æ— æ³•è®¿é—®äº†)ï¼Œäº¦æˆ–è€…æ“ä½œäººå‘˜å¯èƒ½ä¼šé‡å‘½ åä¸€ä¸ªChunkæœåŠ¡å™¨ã€‚</p>
<h5 id="2-6-3-æ“ä½œæ—¥å¿—"><a href="#2-6-3-æ“ä½œæ—¥å¿—" class="headerlink" title="2.6.3 æ“ä½œæ—¥å¿—"></a>2.6.3 æ“ä½œæ—¥å¿—</h5><p>æ“ä½œæ—¥å¿—åŒ…å«äº†å…³é”®çš„å…ƒæ•°æ®å˜æ›´å†å²è®°å½•ã€‚è¿™å¯¹GFSéå¸¸é‡è¦ã€‚è¿™ä¸ä»…ä»…æ˜¯å› ä¸ºæ“ä½œæ—¥å¿—æ˜¯å…ƒæ•°æ®å”¯ä¸€çš„æŒä¹…åŒ–å­˜å‚¨è®°å½•ï¼Œå®ƒä¹Ÿä½œä¸ºåˆ¤æ–­åŒæ­¥æ“ä½œé¡ºåºçš„é€»è¾‘æ—¶é—´åŸºçº¿<strong>ï¼ˆalexæ³¨ï¼šä¹Ÿå°±æ˜¯é€šè¿‡é€»è¾‘æ—¥å¿—çš„åºå·ä½œä¸ºæ“ä½œå‘ç”Ÿçš„é€»è¾‘æ—¶é—´ï¼Œç±»ä¼¼äºäº‹åŠ¡ç³»ç»Ÿä¸­çš„LSNï¼‰</strong>ã€‚æ–‡ä»¶å’ŒChunkï¼Œè¿åŒå®ƒä»¬çš„ç‰ˆæœ¬(å‚è€ƒ4.5èŠ‚)ï¼Œéƒ½ç”±å®ƒä»¬åˆ›å»ºçš„é€»è¾‘æ—¶é—´å”¯ä¸€çš„ã€æ°¸ä¹…çš„æ ‡è¯†ã€‚</p>
<p>æ“ä½œæ—¥å¿—éå¸¸é‡è¦ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿æ—¥å¿—æ–‡ä»¶çš„å®Œæ•´ï¼Œç¡®ä¿åªæœ‰åœ¨å…ƒæ•°æ®çš„å˜åŒ–è¢«æŒä¹…åŒ–åï¼Œæ—¥å¿—æ‰å¯¹å®¢æˆ·ç«¯æ˜¯å¯è§çš„ã€‚å¦åˆ™ï¼Œå³ä½¿Chunkæœ¬èº«æ²¡æœ‰å‡ºç°ä»» ä½•é—®é¢˜ï¼Œæˆ‘ä»¬ä»æœ‰å¯èƒ½ä¸¢å¤±æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œæˆ–è€…ä¸¢å¤±å®¢æˆ·ç«¯æœ€è¿‘çš„æ“ä½œã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¼šæŠŠæ—¥å¿—å¤åˆ¶åˆ°å¤šå°è¿œç¨‹æœºå™¨ï¼Œå¹¶ä¸”åªæœ‰æŠŠç›¸åº”çš„æ—¥å¿—è®°å½•å†™å…¥åˆ°æœ¬åœ°ä»¥åŠè¿œç¨‹ æœºå™¨çš„ç¡¬ç›˜åï¼Œæ‰ä¼šå“åº”å®¢æˆ·ç«¯çš„æ“ä½œè¯·æ±‚ã€‚MasteræœåŠ¡å™¨ä¼šæ”¶é›†å¤šä¸ªæ—¥å¿—è®°å½•åæ‰¹é‡å¤„ç†ï¼Œä»¥å‡å°‘å†™å…¥ç£ç›˜å’Œå¤åˆ¶å¯¹ç³»ç»Ÿæ•´ä½“æ€§èƒ½çš„å½±å“ã€‚</p>
<p>MasteræœåŠ¡å™¨åœ¨ç¾éš¾æ¢å¤æ—¶ï¼Œé€šè¿‡é‡æ¼”æ“ä½œæ—¥å¿—æŠŠæ–‡ä»¶ç³»ç»Ÿæ¢å¤åˆ°æœ€è¿‘çš„çŠ¶æ€ã€‚ä¸ºäº†ç¼©çŸ­Masterå¯åŠ¨çš„æ—¶é—´ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿æ—¥å¿—è¶³å¤Ÿå° <strong>ï¼ˆalexæ³¨ï¼šå³é‡æ¼”ç³»ç»Ÿæ“ä½œçš„æ—¥å¿—é‡å°½é‡çš„å°‘ï¼‰</strong>ã€‚MasteræœåŠ¡å™¨åœ¨æ—¥å¿—å¢é•¿åˆ°ä¸€å®šé‡æ—¶å¯¹ç³»ç»ŸçŠ¶æ€åšä¸€æ¬¡Checkpoint <strong>(alexæ³¨ï¼šCheckpointæ˜¯ä¸€ç§è¡Œä¸ºï¼Œä¸€ç§å¯¹æ•°æ®åº“çŠ¶æ€ä½œä¸€æ¬¡å¿«ç…§çš„è¡Œä¸º)</strong>ï¼Œå°†æ‰€æœ‰çš„çŠ¶æ€æ•°æ®å†™å…¥ä¸€ä¸ªCheckpointæ–‡ä»¶ <strong>ï¼ˆalexæ³¨ï¼šå¹¶åˆ é™¤ä¹‹å‰çš„æ—¥å¿—æ–‡ä»¶ï¼‰</strong>ã€‚ åœ¨ç¾éš¾æ¢å¤çš„æ—¶å€™ï¼ŒMasteræœåŠ¡å™¨å°±é€šè¿‡ä»ç£ç›˜ä¸Šè¯»å–è¿™ä¸ªCheckpointæ–‡ä»¶ï¼Œä»¥åŠé‡æ¼”Checkpointä¹‹åçš„æœ‰é™ä¸ªæ—¥å¿—æ–‡ä»¶å°±èƒ½å¤Ÿæ¢å¤ç³»ç»Ÿã€‚Checkpointæ–‡ä»¶ä»¥å‹ç¼©B-æ ‘å½¢åŠ¿çš„æ•°æ®ç»“æ„å­˜å‚¨ï¼Œå¯ä»¥ç›´æ¥æ˜ å°„åˆ°å†…å­˜ï¼Œåœ¨ç”¨äºå‘½åç©ºé—´æŸ¥è¯¢æ—¶æ— éœ€é¢å¤–çš„è§£æã€‚è¿™å¤§å¤§æé«˜äº†æ¢å¤é€Ÿåº¦ï¼Œå¢å¼ºäº†å¯ç”¨æ€§ã€‚</p>
<p>ç”±äºåˆ›å»ºä¸€ä¸ªCheckpointæ–‡ä»¶éœ€è¦ä¸€å®šçš„æ—¶é—´ï¼Œæ‰€ä»¥MasteræœåŠ¡å™¨çš„å†…éƒ¨çŠ¶æ€è¢«ç»„ç»‡ä¸ºä¸€ç§æ ¼å¼ï¼Œè¿™ç§æ ¼å¼è¦ç¡®ä¿åœ¨Checkpoint è¿‡ç¨‹ä¸­ä¸ä¼šé˜»å¡æ­£åœ¨è¿›è¡Œçš„ä¿®æ”¹æ“ä½œã€‚MasteræœåŠ¡å™¨ä½¿ç”¨ç‹¬ç«‹çš„çº¿ç¨‹åˆ‡æ¢åˆ°æ–°çš„æ—¥å¿—æ–‡ä»¶å’Œåˆ›å»ºæ–°çš„Checkpointæ–‡ä»¶ã€‚æ–°çš„Checkpoint æ–‡ä»¶åŒ…æ‹¬åˆ‡æ¢å‰æ‰€æœ‰çš„ä¿®æ”¹ã€‚å¯¹äºä¸€ä¸ªåŒ…å«æ•°ç™¾ä¸‡ä¸ªæ–‡ä»¶çš„é›†ç¾¤ï¼Œåˆ›å»ºä¸€ä¸ªCheckpointæ–‡ä»¶éœ€è¦1åˆ†é’Ÿå·¦å³çš„æ—¶é—´ã€‚åˆ›å»ºå®Œæˆåï¼ŒCheckpoint æ–‡ä»¶ä¼šè¢«å†™å…¥åœ¨æœ¬åœ°å’Œè¿œç¨‹çš„ç¡¬ç›˜é‡Œã€‚</p>
<p>MasteræœåŠ¡å™¨æ¢å¤åªéœ€è¦æœ€æ–°çš„Checkpointæ–‡ä»¶å’Œåç»­çš„æ—¥å¿—æ–‡ä»¶ã€‚æ—§çš„Checkpointæ–‡ä»¶å’Œæ—¥å¿—æ–‡ä»¶å¯ä»¥è¢«åˆ é™¤ï¼Œä½†æ˜¯ä¸ºäº†åº”å¯¹ç¾éš¾æ€§çš„æ•…éšœ<strong>ï¼ˆalexæ³¨ï¼šcatastrophesï¼Œæ•°æ®å¤‡ä»½ç›¸å…³æ–‡æ¡£ä¸­ç»å¸¸ä¼šé‡åˆ°è¿™ä¸ªè¯ï¼Œè¡¨ç¤ºä¸€ç§è¶…å‡ºé¢„æœŸèŒƒå›´çš„ç¾éš¾æ€§äº‹ä»¶ï¼‰</strong>ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå¤šä¿å­˜ä¸€äº›å†å²æ–‡ä»¶ã€‚Checkpointå¤±è´¥ä¸ä¼šå¯¹æ­£ç¡®æ€§äº§ç”Ÿä»»ä½•å½±å“ï¼Œå› ä¸ºæ¢å¤åŠŸèƒ½çš„ä»£ç å¯ä»¥æ£€æµ‹å¹¶è·³è¿‡æ²¡æœ‰å®Œæˆçš„Checkpointæ–‡ä»¶ã€‚</p>
<h4 id="2-7-ä¸€è‡´æ€§æ¨¡å‹"><a href="#2-7-ä¸€è‡´æ€§æ¨¡å‹" class="headerlink" title="2.7 ä¸€è‡´æ€§æ¨¡å‹"></a>2.7 ä¸€è‡´æ€§æ¨¡å‹</h4><p>GFSæ”¯æŒä¸€ä¸ªå®½æ¾çš„ä¸€è‡´æ€§æ¨¡å‹ï¼Œè¿™ä¸ªæ¨¡å‹èƒ½å¤Ÿå¾ˆå¥½çš„æ”¯æ’‘æˆ‘ä»¬çš„é«˜åº¦åˆ†å¸ƒçš„åº”ç”¨ï¼ŒåŒæ—¶è¿˜ä¿æŒäº†ç›¸å¯¹ç®€å•ä¸”å®¹æ˜“å®ç°çš„ä¼˜ç‚¹ã€‚æœ¬èŠ‚æˆ‘ä»¬è®¨è®ºGFSçš„ä¸€è‡´ æ€§çš„ä¿éšœæœºåˆ¶ï¼Œä»¥åŠå¯¹åº”ç”¨ç¨‹åºçš„æ„ä¹‰ã€‚æˆ‘ä»¬ä¹Ÿç€é‡æè¿°äº†GFSå¦‚ä½•ç®¡ç†è¿™äº›ä¸€è‡´æ€§ä¿éšœæœºåˆ¶ï¼Œä½†æ˜¯å®ç°çš„ç»†èŠ‚å°†åœ¨æœ¬è®ºæ–‡çš„å…¶å®ƒéƒ¨åˆ†è®¨è®ºã€‚</p>
<h5 id="2-7-1-GFSä¸€è‡´æ€§ä¿éšœæœºåˆ¶"><a href="#2-7-1-GFSä¸€è‡´æ€§ä¿éšœæœºåˆ¶" class="headerlink" title="2.7.1 GFSä¸€è‡´æ€§ä¿éšœæœºåˆ¶"></a>2.7.1 GFSä¸€è‡´æ€§ä¿éšœæœºåˆ¶</h5><p>æ–‡ä»¶å‘½åç©ºé—´çš„ä¿®æ”¹ï¼ˆä¾‹å¦‚ï¼Œæ–‡ä»¶åˆ›å»ºï¼‰æ˜¯åŸå­æ€§çš„ã€‚å®ƒä»¬ä»…ç”±MasterèŠ‚ç‚¹çš„æ§åˆ¶ï¼šå‘½åç©ºé—´é”æä¾›äº†åŸå­æ€§å’Œæ­£ç¡®æ€§ï¼ˆ4.1ç« ï¼‰çš„ä¿éšœï¼›MasterèŠ‚ç‚¹çš„æ“ä½œæ—¥å¿—å®šä¹‰äº†è¿™äº›æ“ä½œåœ¨å…¨å±€çš„é¡ºåºï¼ˆ2.6.3ç« ï¼‰ã€‚</p>
<p><img src="/images/GFS2-7.jpg"></p>
<p>æ•°æ®ä¿®æ”¹åæ–‡ä»¶region<strong>ï¼ˆalexæ³¨ï¼šregionè¿™ä¸ªè¯ç”¨ä¸­æ–‡éå¸¸éš¾ä»¥è¡¨è¾¾ï¼Œæˆ‘è®¤ä¸ºåº”è¯¥æ˜¯ä¿®æ”¹æ“ä½œæ‰€æ¶‰åŠçš„æ–‡ä»¶ä¸­çš„æŸä¸ªèŒƒå›´ï¼‰</strong>çš„çŠ¶æ€å–å†³äºæ“ä½œçš„ç±»å‹ã€æˆåŠŸä¸å¦ã€ä»¥åŠæ˜¯å¦åŒæ­¥ä¿®æ”¹ã€‚è¡¨1æ€»ç»“äº†å„ç§æ“ä½œçš„ç»“æœã€‚å¦‚æœæ‰€æœ‰å®¢æˆ·ç«¯ï¼Œæ— è®ºä»å“ªä¸ªå‰¯æœ¬è¯»å–ï¼Œè¯»åˆ°çš„æ•°æ®éƒ½ä¸€æ ·ï¼Œé‚£ä¹ˆæˆ‘ä»¬è®¤ä¸ºæ–‡ ä»¶regionæ˜¯â€œä¸€è‡´çš„â€ï¼›å¦‚æœå¯¹æ–‡ä»¶çš„æ•°æ®ä¿®æ”¹ä¹‹åï¼Œregionæ˜¯ä¸€è‡´çš„ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯èƒ½å¤Ÿçœ‹åˆ°å†™å…¥æ“ä½œå…¨éƒ¨çš„å†…å®¹ï¼Œé‚£ä¹ˆè¿™ä¸ªregionæ˜¯â€œå·²å®šä¹‰ çš„â€ã€‚å½“ä¸€ä¸ªæ•°æ®ä¿®æ”¹æ“ä½œæˆåŠŸæ‰§è¡Œï¼Œå¹¶ä¸”æ²¡æœ‰å—åˆ°åŒæ—¶æ‰§è¡Œçš„å…¶å®ƒå†™å…¥æ“ä½œçš„å¹²æ‰°ï¼Œé‚£ä¹ˆå½±å“çš„regionå°±æ˜¯å·²å®šä¹‰çš„ï¼ˆéšå«äº†ä¸€è‡´æ€§ï¼‰ï¼šæ‰€æœ‰çš„å®¢æˆ·ç«¯éƒ½å¯ ä»¥çœ‹åˆ°å†™å…¥çš„å†…å®¹ã€‚å¹¶è¡Œä¿®æ”¹æ“ä½œæˆåŠŸå®Œæˆä¹‹åï¼Œregionå¤„äºä¸€è‡´çš„ã€æœªå®šä¹‰çš„çŠ¶æ€ï¼šæ‰€æœ‰çš„å®¢æˆ·ç«¯çœ‹åˆ°åŒæ ·çš„æ•°æ®ï¼Œä½†æ˜¯æ— æ³•è¯»åˆ°ä»»ä½•ä¸€æ¬¡å†™å…¥æ“ä½œå†™å…¥çš„ æ•°æ®ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæ–‡ä»¶regionå†…åŒ…å«äº†æ¥è‡ªå¤šä¸ªä¿®æ”¹æ“ä½œçš„ã€æ··æ‚çš„æ•°æ®ç‰‡æ®µã€‚å¤±è´¥çš„ä¿®æ”¹æ“ä½œå¯¼è‡´ä¸€ä¸ªregionå¤„äºä¸ä¸€è‡´çŠ¶æ€ï¼ˆåŒæ—¶ä¹Ÿæ˜¯æœªå®šä¹‰ çš„ï¼‰ï¼šä¸åŒçš„å®¢æˆ·åœ¨ä¸åŒçš„æ—¶é—´ä¼šçœ‹åˆ°ä¸åŒçš„æ•°æ®ã€‚åé¢æˆ‘ä»¬å°†æè¿°åº”ç”¨å¦‚ä½•åŒºåˆ†å·²å®šä¹‰å’Œæœªå®šä¹‰çš„regionã€‚åº”ç”¨ç¨‹åºæ²¡æœ‰å¿…è¦å†å»ç»†åˆ†æœªå®šä¹‰region çš„ä¸åŒç±»å‹ã€‚</p>
<p>æ•°æ®ä¿®æ”¹æ“ä½œåˆ†ä¸ºå†™å…¥æˆ–è€…è®°å½•è¿½åŠ ä¸¤ç§ã€‚å†™å…¥æ“ä½œæŠŠæ•°æ®å†™åœ¨åº”ç”¨ç¨‹åºæŒ‡å®šçš„æ–‡ä»¶åç§»ä½ç½®ä¸Šã€‚å³ä½¿æœ‰å¤šä¸ªä¿®æ”¹æ“ä½œå¹¶è¡Œæ‰§è¡Œæ—¶ï¼Œè®°å½•è¿½åŠ æ“ä½œè‡³å°‘å¯ä»¥æŠŠæ•°æ®åŸå­æ€§çš„è¿½åŠ åˆ°æ–‡ä»¶ä¸­ä¸€æ¬¡ï¼Œä½†æ˜¯åç§»ä½ç½®æ˜¯ç”±GFSé€‰æ‹©çš„ï¼ˆ3.3ç« ï¼‰ <strong>ï¼ˆalexæ³¨ï¼šè¿™å¥è¯æœ‰ç‚¹è´¹è§£ï¼Œå…¶å«ä¹‰æ˜¯æ‰€æœ‰çš„è¿½åŠ å†™å…¥éƒ½ä¼šæˆåŠŸï¼Œä½†æ˜¯æœ‰å¯èƒ½è¢«æ‰§è¡Œäº†å¤šæ¬¡ï¼Œè€Œä¸”æ¯æ¬¡è¿½åŠ çš„æ–‡ä»¶åç§»é‡ç”±GFSè‡ªå·±è®¡ç®—ï¼‰ã€‚</strong> ï¼ˆç›¸æ¯”è€Œè¨€ï¼Œé€šå¸¸è¯´çš„è¿½åŠ æ“ä½œå†™çš„åç§»ä½ç½®æ˜¯æ–‡ä»¶çš„å°¾éƒ¨ã€‚ï¼‰GFSè¿”å›ç»™å®¢æˆ·ç«¯ä¸€ä¸ªåç§»é‡ï¼Œè¡¨ç¤ºäº†åŒ…å«äº†å†™å…¥è®°å½•çš„ã€å·²å®šä¹‰çš„regionçš„èµ·ç‚¹ã€‚å¦ å¤–ï¼ŒGFSå¯èƒ½ä¼šåœ¨æ–‡ä»¶ä¸­é—´æ’å…¥å¡«å……æ•°æ®æˆ–è€…é‡å¤è®°å½•ã€‚è¿™äº›æ•°æ®å æ®çš„æ–‡ä»¶regionè¢«è®¤å®šæ˜¯ä¸ä¸€è‡´çš„ï¼Œè¿™äº›æ•°æ®é€šå¸¸æ¯”ç”¨æˆ·æ•°æ®å°çš„å¤šã€‚</p>
<p>ç»è¿‡äº†ä¸€ç³»åˆ—çš„æˆåŠŸçš„ä¿®æ”¹æ“ä½œä¹‹åï¼ŒGFSç¡®ä¿è¢«ä¿®æ”¹çš„æ–‡ä»¶regionæ˜¯å·²å®šä¹‰çš„ï¼Œå¹¶ä¸”åŒ…å«æœ€åä¸€æ¬¡ä¿®æ”¹æ“ä½œå†™å…¥çš„æ•°æ®ã€‚GFSé€šè¿‡ä»¥ä¸‹æªæ–½ç¡®ä¿ ä¸Šè¿°è¡Œä¸ºï¼š</p>
<ul>
<li>ï¼ˆaï¼‰ å¯¹Chunkçš„æ‰€æœ‰å‰¯æœ¬çš„ä¿®æ”¹æ“ä½œé¡ºåºä¸€è‡´ï¼ˆ3.1ç« ï¼‰</li>
<li>ï¼ˆbï¼‰ä½¿ç”¨Chunkçš„ç‰ˆæœ¬å·æ¥æ£€æµ‹å‰¯æœ¬æ˜¯å¦å› ä¸ºå®ƒæ‰€åœ¨çš„ChunkæœåŠ¡å™¨å®•æœºï¼ˆ4.5ç« ï¼‰è€Œé”™è¿‡äº†ä¿®æ”¹æ“ä½œè€Œå¯¼è‡´å…¶å¤±æ•ˆã€‚å¤±æ•ˆçš„å‰¯æœ¬ä¸ä¼šå†è¿›è¡Œä»»ä½•ä¿®æ”¹æ“ä½œï¼ŒMasteræœåŠ¡å™¨ä¹Ÿä¸å†è¿”å›è¿™ä¸ªChunkå‰¯æœ¬çš„ä½ç½®ä¿¡æ¯ç»™å®¢æˆ·ç«¯ã€‚å®ƒä»¬ä¼šè¢«åƒåœ¾æ”¶é›†ç³» ç»Ÿå°½å¿«å›æ”¶ã€‚</li>
</ul>
<p>ç”±äºChunkä½ç½®ä¿¡æ¯ä¼šè¢«å®¢æˆ·ç«¯ç¼“å­˜ï¼Œæ‰€ä»¥åœ¨ä¿¡æ¯åˆ·æ–°å‰ï¼Œå®¢æˆ·ç«¯æœ‰å¯èƒ½ä»ä¸€ä¸ªå¤±æ•ˆçš„å‰¯æœ¬è¯»å–äº†æ•°æ®ã€‚åœ¨ç¼“å­˜çš„è¶…æ—¶æ—¶é—´å’Œæ–‡ä»¶ä¸‹ä¸€æ¬¡è¢«æ‰“å¼€çš„æ—¶ é—´ä¹‹é—´å­˜åœ¨ä¸€ä¸ªæ—¶é—´çª—ï¼Œæ–‡ä»¶å†æ¬¡è¢«æ‰“å¼€åä¼šæ¸…é™¤ç¼“å­˜ä¸­ä¸è¯¥æ–‡ä»¶æœ‰å…³çš„æ‰€æœ‰Chunkä½ç½®ä¿¡æ¯ã€‚è€Œä¸”ï¼Œç”±äºæˆ‘ä»¬çš„æ–‡ä»¶å¤§å¤šæ•°éƒ½æ˜¯åªè¿›è¡Œè¿½åŠ æ“ä½œçš„ï¼Œæ‰€ä»¥ï¼Œä¸€ ä¸ªå¤±æ•ˆçš„å‰¯æœ¬é€šå¸¸è¿”å›ä¸€ä¸ªæå‰ç»“æŸçš„Chunkè€Œä¸æ˜¯è¿‡æœŸçš„æ•°æ®ã€‚å½“ä¸€ä¸ªReader <strong>ï¼ˆalexæ³¨ï¼šæœ¬æ–‡ä¸­å°†ç”¨åˆ°ä¸¤ä¸ªä¸“æœ‰åè¯ï¼ŒReaderå’ŒWriterï¼Œåˆ†åˆ«è¡¨ç¤ºæ‰§è¡ŒGFSè¯»å–å’Œå†™å…¥æ“ä½œçš„ç¨‹åºï¼‰</strong>é‡æ–°å°è¯•å¹¶è”ç»œMasteræœåŠ¡å™¨æ—¶ï¼Œå®ƒå°±ä¼šç«‹åˆ»å¾—åˆ°æœ€æ–°çš„Chunkä½ç½®ä¿¡æ¯ã€‚</p>
<p>å³ä½¿åœ¨ä¿®æ”¹æ“ä½œæˆåŠŸæ‰§è¡Œå¾ˆé•¿æ—¶é—´ä¹‹åï¼Œç»„ä»¶çš„å¤±æ•ˆä¹Ÿå¯èƒ½æŸåæˆ–è€…åˆ é™¤æ•°æ®ã€‚GFSé€šè¿‡MasteræœåŠ¡å™¨å’Œæ‰€æœ‰ChunkæœåŠ¡å™¨çš„å®šæœŸâ€œæ¡æ‰‹â€ æ¥æ‰¾åˆ°å¤±æ•ˆçš„ChunkæœåŠ¡å™¨ï¼Œå¹¶ä¸”ä½¿ç”¨Checksumæ¥æ ¡éªŒæ•°æ®æ˜¯å¦æŸåï¼ˆ5.2ç« ï¼‰ã€‚ä¸€æ—¦å‘ç°é—®é¢˜ï¼Œæ•°æ®è¦å°½å¿«åˆ©ç”¨æœ‰æ•ˆçš„å‰¯æœ¬è¿›è¡Œæ¢å¤ï¼ˆ4.3 ç« ï¼‰ã€‚åªæœ‰å½“ä¸€ä¸ªChunkçš„æ‰€æœ‰å‰¯æœ¬åœ¨GFSæ£€æµ‹åˆ°é”™è¯¯å¹¶é‡‡å–åº”å¯¹æªæ–½ä¹‹å‰å…¨éƒ¨ä¸¢å¤±ï¼Œè¿™ä¸ªChunkæ‰ä¼šä¸å¯é€†è½¬çš„ä¸¢å¤±ã€‚åœ¨ä¸€èˆ¬æƒ…å†µä¸‹GFSçš„ååº”æ—¶é—´ <strong>ï¼ˆalexæ³¨ï¼šæŒ‡MasterèŠ‚ç‚¹æ£€æµ‹åˆ°é”™è¯¯å¹¶é‡‡å–åº”å¯¹æªæ–½ï¼‰</strong>æ˜¯å‡ åˆ†é’Ÿã€‚å³ä½¿åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒChunkä¹Ÿåªæ˜¯ä¸å¯ç”¨äº†ï¼Œè€Œä¸æ˜¯æŸåäº†ï¼šåº”ç”¨ç¨‹åºä¼šæ”¶åˆ°æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯è€Œä¸æ˜¯æŸåçš„æ•°æ®ã€‚</p>
<h5 id="2-7-2-ç¨‹åºçš„å®ç°"><a href="#2-7-2-ç¨‹åºçš„å®ç°" class="headerlink" title="2.7.2 ç¨‹åºçš„å®ç°"></a>2.7.2 ç¨‹åºçš„å®ç°</h5><p>ä½¿ç”¨GFSçš„åº”ç”¨ç¨‹åºå¯ä»¥åˆ©ç”¨ä¸€äº›ç®€å•æŠ€æœ¯å®ç°è¿™ä¸ªå®½æ¾çš„ä¸€è‡´æ€§æ¨¡å‹ï¼Œè¿™äº›æŠ€æœ¯ä¹Ÿç”¨æ¥å®ç°ä¸€äº›å…¶å®ƒçš„ç›®æ ‡åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼šå°½é‡é‡‡ç”¨è¿½åŠ å†™å…¥è€Œä¸æ˜¯è¦†ç›–ï¼ŒCheckpointï¼Œè‡ªéªŒè¯çš„å†™å…¥æ“ä½œï¼Œè‡ªæ ‡è¯†çš„è®°å½•ã€‚</p>
<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„åº”ç”¨ç¨‹åºå¯¹æ–‡ä»¶çš„å†™å…¥æ“ä½œéƒ½æ˜¯å°½é‡é‡‡ç”¨æ•°æ®è¿½åŠ æ–¹å¼ï¼Œè€Œä¸æ˜¯è¦†ç›–æ–¹å¼ã€‚ä¸€ç§å…¸å‹çš„åº”ç”¨ï¼Œåº”ç”¨ç¨‹åºä»å¤´åˆ°å°¾å†™å…¥æ•°æ®ï¼Œç”Ÿ æˆäº†ä¸€ä¸ªæ–‡ä»¶ã€‚å†™å…¥æ‰€æœ‰æ•°æ®ä¹‹åï¼Œåº”ç”¨ç¨‹åºè‡ªåŠ¨å°†æ–‡ä»¶æ”¹åä¸ºä¸€ä¸ªæ°¸ä¹…ä¿å­˜çš„æ–‡ä»¶åï¼Œæˆ–è€…å‘¨æœŸæ€§çš„ä½œCheckpointï¼Œè®°å½•æˆåŠŸå†™å…¥äº†å¤šå°‘æ•°æ®ã€‚ Checkpointæ–‡ä»¶å¯ä»¥åŒ…å«ç¨‹åºçº§åˆ«çš„æ ¡éªŒå’Œã€‚Readersä»…æ ¡éªŒå¹¶å¤„ç†ä¸Šä¸ªCheckpointä¹‹åäº§ç”Ÿçš„æ–‡ä»¶regionï¼Œè¿™äº›æ–‡ä»¶ regionçš„çŠ¶æ€ä¸€å®šæ˜¯å·²å®šä¹‰çš„ã€‚è¿™ä¸ªæ–¹æ³•æ»¡è¶³äº†æˆ‘ä»¬ä¸€è‡´æ€§å’Œå¹¶å‘å¤„ç†çš„è¦æ±‚ã€‚è¿½åŠ å†™å…¥æ¯”éšæœºä½ç½®å†™å…¥æ›´åŠ æœ‰æ•ˆç‡ï¼Œå¯¹åº”ç”¨ç¨‹åºçš„å¤±è´¥å¤„ç†æ›´å…·æœ‰å¼¹æ€§ã€‚ Checkpointå¯ä»¥è®©Writerä»¥æ¸è¿›çš„æ–¹å¼é‡æ–°å¼€å§‹ï¼Œå¹¶ä¸”å¯ä»¥é˜²æ­¢Readerå¤„ç†å·²ç»è¢«æˆåŠŸå†™å…¥ï¼Œä½†æ˜¯ä»åº”ç”¨ç¨‹åºçš„è§’åº¦æ¥çœ‹è¿˜å¹¶æœªå®Œæˆçš„æ•° æ®ã€‚</p>
<p>æˆ‘ä»¬å†æ¥åˆ†æå¦ä¸€ç§å…¸å‹çš„åº”ç”¨ã€‚è®¸å¤šåº”ç”¨ç¨‹åºå¹¶è¡Œçš„è¿½åŠ æ•°æ®åˆ°åŒä¸€ä¸ªæ–‡ä»¶ï¼Œæ¯”å¦‚è¿›è¡Œç»“æœçš„åˆå¹¶æˆ–è€…æ˜¯ä¸€ä¸ªç”Ÿäº§è€…-æ¶ˆè´¹è€…é˜Ÿåˆ—ã€‚è®°å½•è¿½åŠ æ–¹å¼çš„ â€œè‡³å°‘ä¸€æ¬¡è¿½åŠ â€çš„ç‰¹æ€§ä¿è¯äº†Writerçš„è¾“å‡ºã€‚Readersä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•æ¥å¤„ç†å¶ç„¶æ€§çš„å¡«å……æ•°æ®å’Œé‡å¤å†…å®¹ã€‚Writersåœ¨æ¯æ¡å†™å…¥çš„è®°å½•ä¸­éƒ½ åŒ…å«äº†é¢å¤–çš„ä¿¡æ¯ï¼Œä¾‹å¦‚Checksumï¼Œç”¨æ¥éªŒè¯å®ƒçš„æœ‰æ•ˆæ€§ã€‚Readerå¯ä»¥åˆ©ç”¨Checksumè¯†åˆ«å’ŒæŠ›å¼ƒé¢å¤–çš„å¡«å……æ•°æ®å’Œè®°å½•ç‰‡æ®µã€‚å¦‚æœåº”ç”¨ä¸èƒ½ å®¹å¿å¶å°”çš„é‡å¤å†…å®¹(æ¯”å¦‚ï¼Œå¦‚æœè¿™äº›é‡å¤æ•°æ®è§¦å‘äº†éå¹‚ç­‰æ“ä½œ)ï¼Œå¯ä»¥ç”¨è®°å½•çš„å”¯ä¸€æ ‡è¯†ç¬¦æ¥è¿‡æ»¤å®ƒä»¬ï¼Œè¿™äº›å”¯ä¸€æ ‡è¯†ç¬¦é€šå¸¸ç”¨äºå‘½åç¨‹åºä¸­å¤„ç†çš„å®ä½“å¯¹è±¡ï¼Œ ä¾‹å¦‚webæ–‡æ¡£ã€‚è¿™äº›è®°å½•I/OåŠŸèƒ½ <strong>ï¼ˆalexæ³¨ï¼šThese functionalities for record I/Oï¼‰</strong>ï¼ˆé™¤äº†å‰”é™¤é‡å¤æ•°æ®ï¼‰éƒ½åŒ…å«åœ¨æˆ‘ä»¬çš„ç¨‹åºå…±äº«çš„åº“ä¸­ï¼Œå¹¶ä¸”é€‚ç”¨äºGoogleå†…éƒ¨çš„å…¶å®ƒçš„æ–‡ä»¶æ¥å£å®ç°ã€‚æ‰€ä»¥ï¼Œç›¸åŒåºåˆ—çš„è®°å½•ï¼ŒåŠ ä¸Šä¸€äº›å¶å°”å‡ºç°çš„é‡å¤æ•°æ®ï¼Œéƒ½è¢«åˆ†å‘åˆ°Readeräº†ã€‚</p>
<h3 id="3-ç³»ç»Ÿäº¤äº’"><a href="#3-ç³»ç»Ÿäº¤äº’" class="headerlink" title="3. ç³»ç»Ÿäº¤äº’"></a>3. ç³»ç»Ÿäº¤äº’</h3><p>æˆ‘ä»¬åœ¨è®¾è®¡è¿™ä¸ªç³»ç»Ÿæ—¶ï¼Œä¸€ä¸ªé‡è¦çš„åŸåˆ™æ˜¯æœ€å°åŒ–æ‰€æœ‰æ“ä½œå’ŒMasterèŠ‚ç‚¹çš„äº¤äº’ã€‚å¸¦ç€è¿™æ ·çš„è®¾è®¡ç†å¿µï¼Œæˆ‘ä»¬ç°åœ¨æè¿°ä¸€ä¸‹å®¢æˆ·æœºã€MasteræœåŠ¡å™¨å’ŒChunkæœåŠ¡å™¨å¦‚ä½•è¿›è¡Œäº¤äº’ï¼Œä»¥å®ç°æ•°æ®ä¿®æ”¹æ“ä½œã€åŸå­çš„è®°å½•è¿½åŠ æ“ä½œä»¥åŠå¿«ç…§åŠŸèƒ½ã€‚</p>
<h4 id="3-1-ç§Ÿçº¦ï¼ˆleaseï¼‰å’Œå˜æ›´é¡ºåº"><a href="#3-1-ç§Ÿçº¦ï¼ˆleaseï¼‰å’Œå˜æ›´é¡ºåº" class="headerlink" title="3.1 ç§Ÿçº¦ï¼ˆleaseï¼‰å’Œå˜æ›´é¡ºåº"></a>3.1 ç§Ÿçº¦ï¼ˆleaseï¼‰å’Œå˜æ›´é¡ºåº</h4><p><strong>ï¼ˆalexæ³¨ï¼šleaseæ˜¯æ•°æ®åº“ä¸­çš„ä¸€ä¸ªæœ¯è¯­ï¼‰</strong></p>
<p>å˜æ›´æ˜¯ä¸€ä¸ªä¼šæ”¹å˜Chunkå†…å®¹æˆ–è€…å…ƒæ•°æ®çš„æ“ä½œï¼Œæ¯”å¦‚å†™å…¥æ“ä½œæˆ–è€…è®°å½•è¿½åŠ æ“ä½œã€‚å˜æ›´æ“ä½œä¼šåœ¨Chunkçš„æ‰€æœ‰å‰¯æœ¬ä¸Šæ‰§è¡Œã€‚æˆ‘ä»¬ä½¿ç”¨ç§Ÿçº¦ ï¼ˆleaseï¼‰æœºåˆ¶æ¥ä¿æŒå¤šä¸ªå‰¯æœ¬é—´å˜æ›´é¡ºåºçš„ä¸€è‡´æ€§ã€‚MasterèŠ‚ç‚¹ä¸ºChunkçš„ä¸€ä¸ªå‰¯æœ¬å»ºç«‹ä¸€ä¸ªç§Ÿçº¦ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå‰¯æœ¬å«åšä¸»Chunkã€‚ä¸» Chunkå¯¹Chunkçš„æ‰€æœ‰æ›´æ”¹æ“ä½œè¿›è¡Œåºåˆ—åŒ–ã€‚æ‰€æœ‰çš„å‰¯æœ¬éƒ½éµä»è¿™ä¸ªåºåˆ—è¿›è¡Œä¿®æ”¹æ“ä½œã€‚å› æ­¤ï¼Œä¿®æ”¹æ“ä½œå…¨å±€çš„é¡ºåºé¦–å…ˆç”±MasterèŠ‚ç‚¹é€‰æ‹©çš„ç§Ÿçº¦çš„ é¡ºåºå†³å®šï¼Œç„¶åç”±ç§Ÿçº¦ä¸­ä¸»Chunkåˆ†é…çš„åºåˆ—å·å†³å®šã€‚</p>
<p>è®¾è®¡ç§Ÿçº¦æœºåˆ¶çš„ç›®çš„æ˜¯ä¸ºäº†æœ€å°åŒ–MasterèŠ‚ç‚¹çš„ç®¡ç†è´Ÿæ‹…ã€‚ç§Ÿçº¦çš„åˆå§‹è¶…æ—¶è®¾ç½®ä¸º60ç§’ã€‚ä¸è¿‡ï¼Œåªè¦Chunkè¢«ä¿®æ”¹äº†ï¼Œä¸»Chunkå°±å¯ä»¥ ç”³è¯·æ›´é•¿çš„ç§ŸæœŸï¼Œé€šå¸¸ä¼šå¾—åˆ°MasterèŠ‚ç‚¹çš„ç¡®è®¤å¹¶æ”¶åˆ°ç§Ÿçº¦å»¶é•¿çš„æ—¶é—´ã€‚è¿™äº›ç§Ÿçº¦å»¶é•¿è¯·æ±‚å’Œæ‰¹å‡†çš„ä¿¡æ¯é€šå¸¸éƒ½æ˜¯é™„åŠ åœ¨MasterèŠ‚ç‚¹å’ŒChunkæœåŠ¡ å™¨ä¹‹é—´çš„å¿ƒè·³æ¶ˆæ¯ä¸­æ¥ä¼ é€’ã€‚æœ‰æ—¶MasterèŠ‚ç‚¹ä¼šè¯•å›¾æå‰å–æ¶ˆç§Ÿçº¦ï¼ˆä¾‹å¦‚ï¼ŒMasterèŠ‚ç‚¹æƒ³å–æ¶ˆåœ¨ä¸€ä¸ªå·²ç»è¢«æ”¹åçš„æ–‡ä»¶ä¸Šçš„ä¿®æ”¹æ“ä½œï¼‰ã€‚å³ä½¿ MasterèŠ‚ç‚¹å’Œä¸»Chunkå¤±å»è”ç³»ï¼Œå®ƒä»ç„¶å¯ä»¥å®‰å…¨åœ°åœ¨æ—§çš„ç§Ÿçº¦åˆ°æœŸåå’Œå¦å¤–ä¸€ä¸ªChunkå‰¯æœ¬ç­¾è®¢æ–°çš„ç§Ÿçº¦ã€‚</p>
<p><img src="/images/GFS3-1.jpg"></p>
<ul>
<li><p>1.å®¢æˆ·æœºå‘MasterèŠ‚ç‚¹è¯¢é—®å“ªä¸€ä¸ªChunkæœåŠ¡å™¨æŒæœ‰å½“å‰çš„ç§Ÿçº¦ï¼Œä»¥åŠå…¶å®ƒå‰¯æœ¬çš„ä½ç½®ã€‚å¦‚æœæ²¡æœ‰ä¸€ä¸ªChunkæŒæœ‰ç§Ÿçº¦ï¼ŒMasterèŠ‚ç‚¹å°±é€‰æ‹©å…¶ä¸­ä¸€ä¸ªå‰¯æœ¬å»ºç«‹ä¸€ä¸ªç§Ÿçº¦ï¼ˆè¿™ä¸ªæ­¥éª¤åœ¨å›¾ä¸Šæ²¡æœ‰æ˜¾ç¤ºï¼‰ã€‚</p>
</li>
<li><p>2.MasterèŠ‚ç‚¹å°†ä¸»Chunkçš„æ ‡è¯†ç¬¦ä»¥åŠå…¶å®ƒå‰¯æœ¬ï¼ˆåˆç§°ä¸ºsecondaryå‰¯æœ¬ã€äºŒçº§å‰¯æœ¬ï¼‰çš„ä½ç½®è¿”å›ç»™å®¢æˆ·æœºã€‚å®¢æˆ·æœºç¼“å­˜è¿™äº›æ•°æ®ä»¥ä¾¿ åç»­çš„æ“ä½œã€‚åªæœ‰åœ¨ä¸»Chunkä¸å¯ç”¨ï¼Œæˆ–è€…ä¸»Chunkå›å¤ä¿¡æ¯è¡¨æ˜å®ƒå·²ä¸å†æŒæœ‰ç§Ÿçº¦çš„æ—¶å€™ï¼Œå®¢æˆ·æœºæ‰éœ€è¦é‡æ–°è·ŸMasterèŠ‚ç‚¹è”ç³»ã€‚</p>
</li>
<li><p>3.å®¢æˆ·æœºæŠŠæ•°æ®æ¨é€åˆ°æ‰€æœ‰çš„å‰¯æœ¬ä¸Šã€‚å®¢æˆ·æœºå¯ä»¥ä»¥ä»»æ„çš„é¡ºåºæ¨é€æ•°æ®ã€‚ChunkæœåŠ¡å™¨æ¥æ”¶åˆ°æ•°æ®å¹¶ä¿å­˜åœ¨å®ƒçš„å†…éƒ¨LRUç¼“å­˜ä¸­ï¼Œä¸€ç›´åˆ°æ•°æ®è¢«ä½¿ ç”¨æˆ–è€…è¿‡æœŸäº¤æ¢å‡ºå»ã€‚ç”±äºæ•°æ®æµçš„ç½‘ç»œä¼ è¾“è´Ÿè½½éå¸¸é«˜ï¼Œé€šè¿‡åˆ†ç¦»æ•°æ®æµå’Œæ§åˆ¶æµï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºç½‘ç»œæ‹“æ‰‘æƒ…å†µå¯¹æ•°æ®æµè¿›è¡Œè§„åˆ’ï¼Œæé«˜ç³»ç»Ÿæ€§èƒ½ï¼Œè€Œä¸ç”¨å»ç†ä¼š å“ªä¸ªChunkæœåŠ¡å™¨ä¿å­˜äº†ä¸»Chunkã€‚3.2ç« èŠ‚ä¼šè¿›ä¸€æ­¥è®¨è®ºè¿™ç‚¹ã€‚</p>
</li>
<li><p>4.å½“æ‰€æœ‰çš„å‰¯æœ¬éƒ½ç¡®è®¤æ¥æ”¶åˆ°äº†æ•°æ®ï¼Œå®¢æˆ·æœºå‘é€å†™è¯·æ±‚åˆ°ä¸»ChunkæœåŠ¡å™¨ã€‚è¿™ä¸ªè¯·æ±‚æ ‡è¯†äº†æ—©å‰æ¨é€åˆ°æ‰€æœ‰å‰¯æœ¬çš„æ•°æ®ã€‚ä¸»Chunkä¸ºæ¥æ”¶åˆ°çš„æ‰€ æœ‰æ“ä½œåˆ†é…è¿ç»­çš„åºåˆ—å·ï¼Œè¿™äº›æ“ä½œå¯èƒ½æ¥è‡ªä¸åŒçš„å®¢æˆ·æœºï¼Œåºåˆ—å·ä¿è¯äº†æ“ä½œé¡ºåºæ‰§è¡Œã€‚å®ƒä»¥åºåˆ—å·çš„é¡ºåºæŠŠæ“ä½œåº”ç”¨åˆ°å®ƒè‡ªå·±çš„æœ¬åœ°çŠ¶æ€ä¸­ <strong>ï¼ˆalexæ³¨ï¼šä¹Ÿå°±æ˜¯åœ¨æœ¬åœ°æ‰§è¡Œè¿™äº›æ“ä½œï¼Œè¿™å¥è¯æŒ‰å­—é¢ç¿»è¯‘æœ‰ç‚¹è´¹è§£ï¼Œä¹Ÿè®¸åº”è¯¥ç¿»è¯‘ä¸ºâ€œå®ƒé¡ºåºæ‰§è¡Œè¿™äº›æ“ä½œï¼Œå¹¶æ›´æ–°è‡ªå·±çš„çŠ¶æ€â€ï¼‰ã€‚</strong></p>
</li>
<li><p>5.ä¸»ChunkæŠŠå†™è¯·æ±‚ä¼ é€’åˆ°æ‰€æœ‰çš„äºŒçº§å‰¯æœ¬ã€‚æ¯ä¸ªäºŒçº§å‰¯æœ¬ä¾ç…§ä¸»Chunkåˆ†é…çš„åºåˆ—å·ä»¥ç›¸åŒçš„é¡ºåºæ‰§è¡Œè¿™äº›æ“ä½œã€‚</p>
</li>
<li><p>6.æ‰€æœ‰çš„äºŒçº§å‰¯æœ¬å›å¤ä¸»Chunkï¼Œå®ƒä»¬å·²ç»å®Œæˆäº†æ“ä½œã€‚</p>
</li>
<li><p>7.ä¸»ChunkæœåŠ¡å™¨ <strong>ï¼ˆalexæ³¨ï¼šå³ä¸»Chunkæ‰€åœ¨çš„ChunkæœåŠ¡å™¨ï¼‰</strong>å› å¤å®¢æˆ·æœºã€‚ä»»ä½•å‰¯æœ¬äº§ç”Ÿçš„ä»»ä½•é”™è¯¯éƒ½ä¼šè¿”å›ç»™å®¢æˆ·æœºã€‚åœ¨å‡ºç°é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œå†™å…¥æ“ä½œå¯èƒ½åœ¨ä¸»Chunkå’Œä¸€äº›äºŒçº§å‰¯æœ¬æ‰§è¡ŒæˆåŠŸã€‚ï¼ˆå¦‚æœæ“ä½œåœ¨ä¸»Chunk ä¸Šå¤±è´¥äº†ï¼Œæ“ä½œå°±ä¸ä¼šè¢«åˆ†é…åºåˆ—å·ï¼Œä¹Ÿä¸ä¼šè¢«ä¼ é€’ã€‚ï¼‰å®¢æˆ·ç«¯çš„è¯·æ±‚è¢«ç¡®è®¤ä¸ºå¤±è´¥ï¼Œè¢«ä¿®æ”¹çš„regionå¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ã€‚æˆ‘ä»¬çš„å®¢æˆ·æœºä»£ç é€šè¿‡é‡å¤æ‰§è¡Œå¤± è´¥çš„æ“ä½œæ¥å¤„ç†è¿™æ ·çš„é”™è¯¯ã€‚åœ¨ä»å¤´å¼€å§‹é‡å¤æ‰§è¡Œä¹‹å‰ï¼Œå®¢æˆ·æœºä¼šå…ˆä»æ­¥éª¤ï¼ˆ3ï¼‰åˆ°æ­¥éª¤ï¼ˆ7ï¼‰åšå‡ æ¬¡å°è¯•ã€‚</p>
</li>
</ul>
<p>å¦‚æœåº”ç”¨ç¨‹åºä¸€æ¬¡å†™å…¥çš„æ•°æ®é‡å¾ˆå¤§ï¼Œæˆ–è€…æ•°æ®è·¨è¶Šäº†å¤šä¸ªChunkï¼ŒGFSå®¢æˆ·æœºä»£ç ä¼šæŠŠå®ƒä»¬åˆ†æˆå¤šä¸ªå†™æ“ä½œã€‚è¿™äº›æ“ä½œéƒ½éµå¾ªå‰é¢æè¿°çš„æ§åˆ¶æµ ç¨‹ï¼Œä½†æ˜¯å¯èƒ½ä¼šè¢«å…¶å®ƒå®¢æˆ·æœºä¸ŠåŒæ—¶è¿›è¡Œçš„æ“ä½œæ‰“æ–­æˆ–è€…è¦†ç›–ã€‚å› æ­¤ï¼Œå…±äº«çš„æ–‡ä»¶regionçš„å°¾éƒ¨å¯èƒ½åŒ…å«æ¥è‡ªä¸åŒå®¢æˆ·æœºçš„æ•°æ®ç‰‡æ®µï¼Œå°½ç®¡å¦‚æ­¤ï¼Œç”±äºè¿™äº›åˆ† è§£åçš„å†™å…¥æ“ä½œåœ¨æ‰€æœ‰çš„å‰¯æœ¬ä¸Šéƒ½ä»¥ç›¸åŒçš„é¡ºåºæ‰§è¡Œå®Œæˆï¼ŒChunkçš„æ‰€æœ‰å‰¯æœ¬éƒ½æ˜¯ä¸€è‡´çš„ã€‚è¿™ä½¿æ–‡ä»¶regionå¤„äº2.7èŠ‚æè¿°çš„ä¸€è‡´çš„ã€ä½†æ˜¯æœªå®šä¹‰çš„çŠ¶ æ€ã€‚</p>
<h4 id="3-2-æ•°æ®æµ"><a href="#3-2-æ•°æ®æµ" class="headerlink" title="3.2 æ•°æ®æµ"></a>3.2 æ•°æ®æµ</h4><p>ä¸ºäº†æé«˜ç½‘ç»œæ•ˆç‡ï¼Œæˆ‘ä»¬é‡‡å–äº†æŠŠæ•°æ®æµå’Œæ§åˆ¶æµåˆ†å¼€çš„æªæ–½ã€‚åœ¨æ§åˆ¶æµä»å®¢æˆ·æœºåˆ°ä¸»Chunkã€ç„¶åå†åˆ°æ‰€æœ‰äºŒçº§å‰¯æœ¬çš„åŒæ—¶ï¼Œæ•°æ®ä»¥ç®¡é“çš„æ–¹å¼ï¼Œ é¡ºåºçš„æ²¿ç€ä¸€ä¸ªç²¾å¿ƒé€‰æ‹©çš„ChunkæœåŠ¡å™¨é“¾æ¨é€ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å……åˆ†åˆ©ç”¨æ¯å°æœºå™¨çš„å¸¦å®½ï¼Œé¿å…ç½‘ç»œç“¶é¢ˆå’Œé«˜å»¶æ—¶çš„è¿æ¥ï¼Œæœ€å°åŒ–æ¨é€æ‰€æœ‰æ•°æ®çš„å»¶æ—¶ã€‚</p>
<p>ä¸ºäº†å……åˆ†åˆ©ç”¨æ¯å°æœºå™¨çš„å¸¦å®½ï¼Œæ•°æ®æ²¿ç€ä¸€ä¸ªChunkæœåŠ¡å™¨é“¾é¡ºåºçš„æ¨é€ï¼Œè€Œä¸æ˜¯ä»¥å…¶å®ƒæ‹“æ‰‘å½¢å¼åˆ†æ•£æ¨é€ï¼ˆä¾‹å¦‚ï¼Œæ ‘å‹æ‹“æ‰‘ç»“æ„ï¼‰ã€‚çº¿æ€§æ¨é€æ¨¡å¼ä¸‹ï¼Œæ¯å°æœºå™¨æ‰€æœ‰çš„å‡ºå£å¸¦å®½éƒ½ç”¨äºä»¥æœ€å¿«çš„é€Ÿåº¦ä¼ è¾“æ•°æ®ï¼Œè€Œä¸æ˜¯åœ¨å¤šä¸ªæ¥å—è€…ä¹‹é—´åˆ†é…å¸¦å®½ã€‚</p>
<p>ä¸ºäº†å°½å¯èƒ½çš„é¿å…å‡ºç°ç½‘ç»œç“¶é¢ˆå’Œé«˜å»¶è¿Ÿçš„é“¾æ¥ï¼ˆegï¼Œinter-switchæœ€æœ‰å¯èƒ½å‡ºç°ç±»ä¼¼é—®é¢˜ï¼‰ï¼Œæ¯å°æœºå™¨éƒ½å°½é‡çš„åœ¨ç½‘ç»œæ‹“æ‰‘ä¸­é€‰æ‹©ä¸€å° è¿˜æ²¡æœ‰æ¥æ”¶åˆ°æ•°æ®çš„ã€ç¦»è‡ªå·±æœ€è¿‘çš„æœºå™¨ä½œä¸ºç›®æ ‡æ¨é€æ•°æ®ã€‚å‡è®¾å®¢æˆ·æœºæŠŠæ•°æ®ä»ChunkæœåŠ¡å™¨S1æ¨é€åˆ°S4ã€‚å®ƒæŠŠæ•°æ®æ¨é€åˆ°æœ€è¿‘çš„ChunkæœåŠ¡å™¨ S1ã€‚S1æŠŠæ•°æ®æ¨é€åˆ°S2ï¼Œå› ä¸ºS2å’ŒS4ä¸­æœ€æ¥è¿‘çš„æœºå™¨æ˜¯S2ã€‚åŒæ ·çš„ï¼ŒS2æŠŠæ•°æ®ä¼ é€’ç»™S3å’ŒS4ä¹‹é—´æ›´è¿‘çš„æœºå™¨ï¼Œä¾æ¬¡ç±»æ¨æ¨é€ä¸‹å»ã€‚æˆ‘ä»¬çš„ç½‘ç»œæ‹“ æ‰‘éå¸¸ç®€å•ï¼Œé€šè¿‡IPåœ°å€å°±å¯ä»¥è®¡ç®—å‡ºèŠ‚ç‚¹çš„â€œè·ç¦»â€ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬åˆ©ç”¨åŸºäºTCPè¿æ¥çš„ã€ç®¡é“å¼æ•°æ®æ¨é€æ–¹å¼æ¥æœ€å°åŒ–å»¶è¿Ÿã€‚ChunkæœåŠ¡å™¨æ¥æ”¶åˆ°æ•°æ®åï¼Œé©¬ä¸Šå¼€å§‹å‘å‰æ¨é€ã€‚ç®¡é“æ–¹å¼çš„æ•°æ®æ¨é€å¯¹æˆ‘ ä»¬å¸®åŠ©å¾ˆå¤§ï¼Œå› ä¸ºæˆ‘ä»¬é‡‡ç”¨å…¨åŒå·¥çš„äº¤æ¢ç½‘ç»œã€‚æ¥æ”¶åˆ°æ•°æ®åç«‹åˆ»å‘å‰æ¨é€ä¸ä¼šé™ä½æ¥æ”¶çš„é€Ÿåº¦ã€‚åœ¨æ²¡æœ‰ç½‘ç»œæ‹¥å¡çš„æƒ…å†µä¸‹ï¼Œä¼ é€Bå­—èŠ‚çš„æ•°æ®åˆ°Rä¸ªå‰¯æœ¬çš„ç†æƒ³æ—¶ é—´æ˜¯ B/T+RL ï¼ŒTæ˜¯ç½‘ç»œçš„ååé‡ï¼ŒLæ˜¯åœ¨ä¸¤å°æœºå™¨æ•°æ®ä¼ è¾“çš„å»¶è¿Ÿã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ç½‘ç»œè¿æ¥é€Ÿåº¦æ˜¯100Mbpsï¼ˆTï¼‰ï¼ŒLå°†è¿œå°äº1msã€‚å› æ­¤ï¼Œ1MBçš„æ•°æ®åœ¨ç† æƒ³æƒ…å†µä¸‹80mså·¦å³å°±èƒ½åˆ†å‘å‡ºå»ã€‚</p>
<h4 id="3-3-åŸå­çš„è®°å½•è¿½åŠ "><a href="#3-3-åŸå­çš„è®°å½•è¿½åŠ " class="headerlink" title="3.3 åŸå­çš„è®°å½•è¿½åŠ "></a>3.3 åŸå­çš„è®°å½•è¿½åŠ </h4><p>GFSæä¾›äº†ä¸€ç§åŸå­çš„æ•°æ®è¿½åŠ æ“ä½œâ€“è®°å½•è¿½åŠ ã€‚ä¼ ç»Ÿæ–¹å¼çš„å†™å…¥æ“ä½œï¼Œå®¢æˆ·ç¨‹åºä¼šæŒ‡å®šæ•°æ®å†™å…¥çš„åç§»é‡ã€‚å¯¹åŒä¸€ä¸ªregionçš„å¹¶è¡Œå†™å…¥æ“ä½œä¸ æ˜¯ä¸²è¡Œçš„ï¼šregionå°¾éƒ¨å¯èƒ½ä¼šåŒ…å«å¤šä¸ªä¸åŒå®¢æˆ·æœºå†™å…¥çš„æ•°æ®ç‰‡æ®µã€‚ä½¿ç”¨è®°å½•è¿½åŠ ï¼Œå®¢æˆ·æœºåªéœ€è¦æŒ‡å®šè¦å†™å…¥çš„æ•°æ®ã€‚GFSä¿è¯è‡³å°‘æœ‰ä¸€æ¬¡åŸå­çš„å†™å…¥æ“ä½œ æˆåŠŸæ‰§è¡Œï¼ˆå³å†™å…¥ä¸€ä¸ªé¡ºåºçš„byteæµï¼‰ï¼Œå†™å…¥çš„æ•°æ®è¿½åŠ åˆ°GFSæŒ‡å®šçš„åç§»ä½ç½®ä¸Šï¼Œä¹‹åGFSè¿”å›è¿™ä¸ªåç§»é‡ç»™å®¢æˆ·æœºã€‚è¿™ç±»ä¼¼äºåœ¨Unixæ“ä½œç³»ç»Ÿç¼–ç¨‹ ç¯å¢ƒä¸­ï¼Œå¯¹ä»¥O_APPENDæ¨¡å¼æ‰“å¼€çš„æ–‡ä»¶ï¼Œå¤šä¸ªå¹¶å‘å†™æ“ä½œåœ¨æ²¡æœ‰ç«æ€æ¡ä»¶æ—¶çš„è¡Œä¸ºã€‚</p>
<p>è®°å½•è¿½åŠ åœ¨æˆ‘ä»¬çš„åˆ†å¸ƒåº”ç”¨ä¸­éå¸¸é¢‘ç¹çš„ä½¿ç”¨ï¼Œåœ¨è¿™äº›åˆ†å¸ƒå¼åº”ç”¨ä¸­ï¼Œé€šå¸¸æœ‰å¾ˆå¤šçš„å®¢æˆ·æœºå¹¶è¡Œåœ°å¯¹åŒä¸€ä¸ªæ–‡ä»¶è¿½åŠ å†™å…¥æ•°æ®ã€‚å¦‚æœæˆ‘ä»¬é‡‡ç”¨ä¼ ç»Ÿæ–¹å¼çš„ æ–‡ä»¶å†™å…¥æ“ä½œï¼Œå®¢æˆ·æœºéœ€è¦é¢å¤–çš„å¤æ‚ã€æ˜‚è´µçš„åŒæ­¥æœºåˆ¶ï¼Œä¾‹å¦‚ä½¿ç”¨ä¸€ä¸ªåˆ†å¸ƒå¼çš„é”ç®¡ç†å™¨ã€‚åœ¨æˆ‘ä»¬çš„å·¥ä½œä¸­ï¼Œè¿™æ ·çš„æ–‡ä»¶é€šå¸¸ç”¨äºå¤šä¸ªç”Ÿäº§è€…/å•ä¸€æ¶ˆè´¹è€…çš„é˜Ÿåˆ— ç³»ç»Ÿï¼Œæˆ–è€…æ˜¯åˆå¹¶äº†æ¥è‡ªå¤šä¸ªå®¢æˆ·æœºçš„æ•°æ®çš„ç»“æœæ–‡ä»¶ã€‚</p>
<p>è®°å½•è¿½åŠ æ˜¯ä¸€ç§ä¿®æ”¹æ“ä½œï¼Œå®ƒä¹Ÿéµå¾ª3.1èŠ‚æè¿°çš„æ§åˆ¶æµç¨‹ï¼Œé™¤äº†åœ¨ä¸»Chunkæœ‰äº›é¢å¤–çš„æ§åˆ¶é€»è¾‘ã€‚å®¢æˆ·æœºæŠŠæ•°æ®æ¨é€ç»™æ–‡ä»¶æœ€åä¸€ä¸ªChunk çš„æ‰€æœ‰å‰¯æœ¬ï¼Œä¹‹åå‘é€è¯·æ±‚ç»™ä¸»Chunkã€‚ä¸»Chunkä¼šæ£€æŸ¥è¿™æ¬¡è®°å½•è¿½åŠ æ“ä½œæ˜¯å¦ä¼šä½¿Chunkè¶…è¿‡æœ€å¤§å°ºå¯¸ï¼ˆ64MBï¼‰ã€‚å¦‚æœè¶…è¿‡äº†æœ€å¤§å°ºå¯¸ï¼Œä¸» Chunké¦–å…ˆå°†å½“å‰Chunkå¡«å……åˆ°æœ€å¤§å°ºå¯¸ï¼Œä¹‹åé€šçŸ¥æ‰€æœ‰äºŒçº§å‰¯æœ¬åšåŒæ ·çš„æ“ä½œï¼Œç„¶åå›å¤å®¢æˆ·æœºè¦æ±‚å…¶å¯¹ä¸‹ä¸€ä¸ªChunké‡æ–°è¿›è¡Œè®°å½•è¿½åŠ æ“ä½œã€‚ï¼ˆè®° å½•è¿½åŠ çš„æ•°æ®å¤§å°ä¸¥æ ¼æ§åˆ¶åœ¨Chunkæœ€å¤§å°ºå¯¸çš„1/4ï¼Œè¿™æ ·å³ä½¿åœ¨æœ€åæƒ…å†µä¸‹ï¼Œæ•°æ®ç¢ç‰‡çš„æ•°é‡ä»ç„¶åœ¨å¯æ§çš„èŒƒå›´ã€‚ï¼‰é€šå¸¸æƒ…å†µä¸‹è¿½åŠ çš„è®°å½•ä¸è¶…è¿‡ Chunkçš„æœ€å¤§å°ºå¯¸ï¼Œä¸»ChunkæŠŠæ•°æ®è¿½åŠ åˆ°è‡ªå·±çš„å‰¯æœ¬å†…ï¼Œç„¶åé€šçŸ¥äºŒçº§å‰¯æœ¬æŠŠæ•°æ®å†™åœ¨è·Ÿä¸»Chunkä¸€æ ·çš„ä½ç½®ä¸Šï¼Œæœ€åå›å¤å®¢æˆ·æœºæ“ä½œæˆåŠŸã€‚</p>
<p>å¦‚æœè®°å½•è¿½åŠ æ“ä½œåœ¨ä»»ä½•ä¸€ä¸ªå‰¯æœ¬ä¸Šå¤±è´¥äº†ï¼Œå®¢æˆ·ç«¯å°±éœ€è¦é‡æ–°è¿›è¡Œæ“ä½œã€‚é‡æ–°è¿›è¡Œè®°å½•è¿½åŠ çš„ç»“æœæ˜¯ï¼ŒåŒä¸€ä¸ªChunkçš„ä¸åŒå‰¯æœ¬å¯èƒ½åŒ…å«ä¸åŒçš„æ•° æ®â€“é‡å¤åŒ…å«ä¸€ä¸ªè®°å½•å…¨éƒ¨æˆ–è€…éƒ¨åˆ†çš„æ•°æ®ã€‚GFSå¹¶ä¸ä¿è¯Chunkçš„æ‰€æœ‰å‰¯æœ¬åœ¨å­—èŠ‚çº§åˆ«æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚å®ƒåªä¿è¯æ•°æ®ä½œä¸ºä¸€ä¸ªæ•´ä½“åŸå­çš„è¢«è‡³å°‘å†™å…¥ä¸€æ¬¡ã€‚ è¿™ä¸ªç‰¹æ€§å¯ä»¥é€šè¿‡ç®€å•è§‚å¯Ÿæ¨å¯¼å‡ºæ¥ï¼šå¦‚æœæ“ä½œæˆåŠŸæ‰§è¡Œï¼Œæ•°æ®ä¸€å®šå·²ç»å†™å…¥åˆ°Chunkçš„æ‰€æœ‰å‰¯æœ¬çš„ç›¸åŒåç§»ä½ç½®ä¸Šã€‚è¿™ä¹‹åï¼Œæ‰€æœ‰çš„å‰¯æœ¬è‡³å°‘éƒ½åˆ°äº†è®°å½•å°¾éƒ¨ çš„é•¿åº¦ï¼Œä»»ä½•åç»­çš„è®°å½•éƒ½ä¼šè¿½åŠ åˆ°æ›´å¤§çš„åç§»åœ°å€ï¼Œæˆ–è€…æ˜¯ä¸åŒçš„Chunkä¸Šï¼Œå³ä½¿å…¶å®ƒçš„Chunkå‰¯æœ¬è¢«MasterèŠ‚ç‚¹é€‰ä¸ºäº†ä¸»Chunkã€‚å°±æˆ‘ä»¬çš„ ä¸€è‡´æ€§ä¿éšœæ¨¡å‹è€Œè¨€ï¼Œè®°å½•è¿½åŠ æ“ä½œæˆåŠŸå†™å…¥æ•°æ®çš„regionæ˜¯å·²å®šä¹‰çš„ï¼ˆå› æ­¤ä¹Ÿæ˜¯ä¸€è‡´çš„ï¼‰ï¼Œåä¹‹åˆ™æ˜¯ä¸ä¸€è‡´çš„ï¼ˆå› æ­¤ä¹Ÿå°±æ˜¯æœªå®šä¹‰çš„ï¼‰ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨ 2.7.2èŠ‚è®¨è®ºçš„ï¼Œæˆ‘ä»¬çš„ç¨‹åºå¯ä»¥å¤„ç†ä¸ä¸€è‡´çš„åŒºåŸŸã€‚</p>
<h4 id="3-4-å¿«ç…§"><a href="#3-4-å¿«ç…§" class="headerlink" title="3.4 å¿«ç…§"></a>3.4 å¿«ç…§</h4><p><strong>(alexæ³¨ï¼šè¿™ä¸€èŠ‚éå¸¸éš¾ä»¥ç†è§£ï¼Œæ€»çš„æ¥è¯´ä¾æ¬¡è®²è¿°äº†ä»€ä¹ˆæ˜¯å¿«ç…§ã€å¿«ç…§ä½¿ç”¨çš„COWæŠ€æœ¯ã€å¿«ç…§å¦‚ä½•ä¸å¹²æ‰°å½“å‰æ“ä½œ)</strong></p>
<p>å¿«ç…§æ“ä½œå‡ ä¹å¯ä»¥ç¬é—´å®Œæˆå¯¹ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•æ ‘ï¼ˆâ€œæºâ€ï¼‰åšä¸€ä¸ªæ‹·è´ï¼Œå¹¶ä¸”å‡ ä¹ä¸ä¼šå¯¹æ­£åœ¨è¿›è¡Œçš„å…¶å®ƒæ“ä½œé€ æˆä»»ä½•å¹²æ‰°ã€‚æˆ‘ä»¬çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨å¿«ç…§ è¿…é€Ÿçš„åˆ›å»ºä¸€ä¸ªå·¨å¤§çš„æ•°æ®é›†çš„åˆ†æ”¯æ‹·è´ï¼ˆè€Œä¸”ç»å¸¸æ˜¯é€’å½’çš„æ‹·è´æ‹·è´ï¼‰ï¼Œæˆ–è€…æ˜¯åœ¨åšå®éªŒæ€§çš„æ•°æ®æ“ä½œä¹‹å‰ï¼Œä½¿ç”¨å¿«ç…§æ“ä½œå¤‡ä»½å½“å‰çŠ¶æ€ï¼Œè¿™æ ·ä¹‹åå°±å¯ä»¥è½»æ¾çš„ æäº¤æˆ–è€…å›æ»šåˆ°å¤‡ä»½æ—¶çš„çŠ¶æ€ã€‚</p>
<p>å°±åƒAFS <strong>ï¼ˆalexæ³¨ï¼šAFSï¼Œå³Andrew File Systemï¼Œä¸€ç§åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼‰</strong>ï¼Œæˆ‘ ä»¬ç”¨æ ‡å‡†çš„copy-on-writeæŠ€æœ¯å®ç°å¿«ç…§ã€‚å½“MasterèŠ‚ç‚¹æ”¶åˆ°ä¸€ä¸ªå¿«ç…§è¯·æ±‚ï¼Œå®ƒé¦–å…ˆå–æ¶ˆä½œå¿«ç…§çš„æ–‡ä»¶çš„æ‰€æœ‰Chunkçš„ç§Ÿçº¦ã€‚è¿™ä¸ªæªæ–½ä¿è¯ äº†åç»­å¯¹è¿™äº›Chunkçš„å†™æ“ä½œéƒ½å¿…é¡»ä¸Masteräº¤äº’äº¤äº’ä»¥æ‰¾åˆ°ç§Ÿçº¦æŒæœ‰è€…ã€‚è¿™å°±ç»™MasterèŠ‚ç‚¹ä¸€ä¸ªç‡å…ˆåˆ›å»ºChunkçš„æ–°æ‹·è´çš„æœºä¼šã€‚</p>
<p>ç§Ÿçº¦å–æ¶ˆæˆ–è€…è¿‡æœŸä¹‹åï¼ŒMasterèŠ‚ç‚¹æŠŠè¿™ä¸ªæ“ä½œä»¥æ—¥å¿—çš„æ–¹å¼è®°å½•åˆ°ç¡¬ç›˜ä¸Šã€‚ç„¶åï¼ŒMasterèŠ‚ç‚¹é€šè¿‡å¤åˆ¶æºæ–‡ä»¶æˆ–è€…ç›®å½•çš„å…ƒæ•°æ®çš„æ–¹å¼ï¼ŒæŠŠè¿™æ¡æ—¥å¿—è®°å½•çš„å˜åŒ–åæ˜ åˆ°ä¿å­˜åœ¨å†…å­˜çš„çŠ¶æ€ä¸­ã€‚æ–°åˆ›å»ºçš„å¿«ç…§æ–‡ä»¶å’Œæºæ–‡ä»¶æŒ‡å‘å®Œå…¨ç›¸åŒçš„Chunkåœ°å€ã€‚</p>
<p>åœ¨å¿«ç…§æ“ä½œä¹‹åï¼Œå½“å®¢æˆ·æœºç¬¬ä¸€æ¬¡æƒ³å†™å…¥æ•°æ®åˆ°Chunk Cï¼Œå®ƒé¦–å…ˆä¼šå‘é€ä¸€ä¸ªè¯·æ±‚åˆ°MasterèŠ‚ç‚¹æŸ¥è¯¢å½“å‰çš„ç§Ÿçº¦æŒæœ‰è€…ã€‚MasterèŠ‚ç‚¹æ³¨æ„åˆ°Chunke Cçš„å¼•ç”¨è®¡æ•°è¶…è¿‡äº†1ã€‚ MasterèŠ‚ç‚¹ä¸ä¼šé©¬ä¸Šå›å¤å®¢æˆ·æœºçš„è¯·æ±‚ï¼Œè€Œæ˜¯é€‰æ‹©ä¸€ä¸ªæ–°çš„Chunkå¥æŸ„Câ€™ã€‚ä¹‹åï¼ŒMasterèŠ‚ç‚¹è¦æ±‚æ¯ä¸ªæ‹¥æœ‰Chunk Cå½“å‰å‰¯æœ¬çš„ChunkæœåŠ¡å™¨åˆ›å»ºä¸€ä¸ªå«åšCâ€™çš„æ–°Chunkã€‚é€šè¿‡åœ¨æºChunkæ‰€åœ¨ChunkæœåŠ¡å™¨ä¸Šåˆ›å»ºæ–°çš„Chunkï¼Œæˆ‘ä»¬ç¡®ä¿æ•°æ®åœ¨æœ¬åœ°è€Œä¸æ˜¯ é€šè¿‡ç½‘ç»œå¤åˆ¶ï¼ˆæˆ‘ä»¬çš„ç¡¬ç›˜æ¯”æˆ‘ä»¬çš„100Mbä»¥å¤ªç½‘å¤§çº¦å¿«3å€ï¼‰ã€‚ä»è¿™ç‚¹æ¥è®²ï¼Œè¯·æ±‚çš„å¤„ç†æ–¹å¼å’Œä»»ä½•å…¶å®ƒChunkæ²¡ä»€ä¹ˆä¸åŒï¼šMasterèŠ‚ç‚¹ç¡®ä¿æ–° Chunk Câ€™çš„ä¸€ä¸ªå‰¯æœ¬æ‹¥æœ‰ç§Ÿçº¦ï¼Œä¹‹åå›å¤å®¢æˆ·æœºï¼Œå®¢æˆ·æœºå¾—åˆ°å›å¤åå°±å¯ä»¥æ­£å¸¸çš„å†™è¿™ä¸ªChunkï¼Œè€Œä¸å¿…ç†ä¼šå®ƒæ˜¯ä»ä¸€ä¸ªå·²å­˜åœ¨çš„Chunkå…‹éš†å‡ºæ¥çš„ã€‚</p>
<h3 id="4-MasterèŠ‚ç‚¹çš„æ“ä½œ"><a href="#4-MasterèŠ‚ç‚¹çš„æ“ä½œ" class="headerlink" title="4. MasterèŠ‚ç‚¹çš„æ“ä½œ"></a>4. MasterèŠ‚ç‚¹çš„æ“ä½œ</h3><p>MasterèŠ‚ç‚¹æ‰§è¡Œæ‰€æœ‰çš„åç§°ç©ºé—´æ“ä½œã€‚æ­¤å¤–ï¼Œå®ƒè¿˜ç®¡ç†ç€æ•´ä¸ªç³»ç»Ÿé‡Œæ‰€æœ‰Chunkçš„å‰¯æœ¬ï¼šå®ƒå†³å®šChunkçš„å­˜å‚¨ä½ç½®ï¼Œåˆ›å»ºæ–°Chunkå’Œ å®ƒçš„å‰¯æœ¬ï¼Œåè°ƒå„ç§å„æ ·çš„ç³»ç»Ÿæ´»åŠ¨ä»¥ä¿è¯Chunkè¢«å®Œå…¨å¤åˆ¶ï¼Œåœ¨æ‰€æœ‰çš„ChunkæœåŠ¡å™¨ä¹‹é—´çš„è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œå›æ”¶ä¸å†ä½¿ç”¨çš„å­˜å‚¨ç©ºé—´ã€‚æœ¬èŠ‚æˆ‘ä»¬è®¨è®ºä¸Šè¿° çš„ä¸»é¢˜ã€‚</p>
<h4 id="4-1-åç§°ç©ºé—´ç®¡ç†å’Œé”"><a href="#4-1-åç§°ç©ºé—´ç®¡ç†å’Œé”" class="headerlink" title="4.1 åç§°ç©ºé—´ç®¡ç†å’Œé”"></a>4.1 åç§°ç©ºé—´ç®¡ç†å’Œé”</h4><p>MasterèŠ‚ç‚¹çš„å¾ˆå¤šæ“ä½œä¼šèŠ±è´¹å¾ˆé•¿çš„æ—¶é—´ï¼šæ¯”å¦‚ï¼Œå¿«ç…§æ“ä½œå¿…é¡»å–æ¶ˆChunkæœåŠ¡å™¨ä¸Šå¿«ç…§æ‰€æ¶‰åŠçš„æ‰€æœ‰çš„Chunkçš„ç§Ÿçº¦ã€‚æˆ‘ä»¬ä¸å¸Œæœ›åœ¨è¿™ äº›æ“ä½œçš„è¿è¡Œæ—¶ï¼Œå»¶ç¼“äº†å…¶å®ƒçš„MasterèŠ‚ç‚¹çš„æ“ä½œã€‚å› æ­¤ï¼Œæˆ‘ä»¬å…è®¸å¤šä¸ªæ“ä½œåŒæ—¶è¿›è¡Œï¼Œä½¿ç”¨åç§°ç©ºé—´çš„regionä¸Šçš„é”æ¥ä¿è¯æ‰§è¡Œçš„æ­£ç¡®é¡ºåºã€‚</p>
<p>ä¸åŒäºè®¸å¤šä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿï¼ŒGFSæ²¡æœ‰é’ˆå¯¹æ¯ä¸ªç›®å½•å®ç°èƒ½å¤Ÿåˆ—å‡ºç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„æ•°æ®ç»“æ„ã€‚GFSä¹Ÿä¸æ”¯æŒæ–‡ä»¶æˆ–è€…ç›®å½•çš„é“¾æ¥ï¼ˆå³Unixæœ¯è¯­ä¸­ çš„ç¡¬é“¾æ¥æˆ–è€…ç¬¦å·é“¾æ¥ï¼‰ã€‚åœ¨é€»è¾‘ä¸Šï¼ŒGFSçš„åç§°ç©ºé—´å°±æ˜¯ä¸€ä¸ªå…¨è·¯å¾„å’Œå…ƒæ•°æ®æ˜ å°„å…³ç³»çš„æŸ¥æ‰¾è¡¨ã€‚åˆ©ç”¨å‰ç¼€å‹ç¼©ï¼Œè¿™ä¸ªè¡¨å¯ä»¥é«˜æ•ˆçš„å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚åœ¨å­˜å‚¨åç§° ç©ºé—´çš„æ ‘å‹ç»“æ„ä¸Šï¼Œæ¯ä¸ªèŠ‚ç‚¹ï¼ˆç»å¯¹è·¯å¾„çš„æ–‡ä»¶åæˆ–ç»å¯¹è·¯å¾„çš„ç›®å½•åï¼‰éƒ½æœ‰ä¸€ä¸ªå…³è”çš„è¯»å†™é”ã€‚</p>
<p>æ¯ä¸ªMasterèŠ‚ç‚¹çš„æ“ä½œåœ¨å¼€å§‹ä¹‹å‰éƒ½è¦è·å¾—ä¸€ç³»åˆ—çš„é”ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œæ¶‰åŠ/d1/d2/â€¦/dn/leafï¼Œé‚£ä¹ˆæ“ä½œé¦–å…ˆè¦è· å¾—ç›®å½•/d1ï¼Œ/d1/d2ï¼Œâ€¦ï¼Œ/d1/d2/â€¦/dnçš„è¯»é”ï¼Œä»¥åŠ/d1/d2/â€¦/dn/leafçš„è¯»å†™é”ã€‚æ³¨æ„ï¼Œæ ¹æ®æ“ä½œçš„ä¸åŒï¼Œleafå¯ä»¥æ˜¯ ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç›®å½•ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¼”ç¤ºä¸€ä¸‹åœ¨/home/userè¢«å¿«ç…§åˆ°/save/userçš„æ—¶å€™ï¼Œé”æœºåˆ¶å¦‚ä½•é˜²æ­¢åˆ›å»ºæ–‡ä»¶/home/user/fooã€‚å¿«ç…§æ“ ä½œè·å–/homeå’Œ/saveçš„è¯»å–é”ï¼Œä»¥åŠ/home/userå’Œ/save/userçš„å†™å…¥é”ã€‚æ–‡ä»¶åˆ›å»ºæ“ä½œè·å¾—/homeå’Œ/home/userçš„ è¯»å–é”ï¼Œä»¥åŠ/home/user/fooçš„å†™å…¥é”ã€‚è¿™ä¸¤ä¸ªæ“ä½œè¦é¡ºåºæ‰§è¡Œï¼Œå› ä¸ºå®ƒä»¬è¯•å›¾è·å–çš„/home/userçš„é”æ˜¯ç›¸äº’å†²çªã€‚æ–‡ä»¶åˆ›å»ºæ“ä½œä¸éœ€è¦ è·å–çˆ¶ç›®å½•çš„å†™å…¥é”ï¼Œå› ä¸ºè¿™é‡Œæ²¡æœ‰â€ç›®å½•â€ï¼Œæˆ–è€…ç±»ä¼¼inodeç­‰ç”¨æ¥ç¦æ­¢ä¿®æ”¹çš„æ•°æ®ç»“æ„ã€‚æ–‡ä»¶åçš„è¯»å–é”è¶³ä»¥é˜²æ­¢çˆ¶ç›®å½•è¢«åˆ é™¤ã€‚</p>
<p>é‡‡ç”¨è¿™ç§é”æ–¹æ¡ˆçš„ä¼˜ç‚¹æ˜¯æ”¯æŒå¯¹åŒä¸€ç›®å½•çš„å¹¶è¡Œæ“ä½œã€‚æ¯”å¦‚ï¼Œå¯ä»¥å†åŒä¸€ä¸ªç›®å½•ä¸‹åŒæ—¶åˆ›å»ºå¤šä¸ªæ–‡ä»¶ï¼šæ¯ä¸€ä¸ªæ“ä½œéƒ½è·å–ä¸€ä¸ªç›®å½•åçš„ä¸Šçš„è¯»å–é”å’Œæ–‡ä»¶ åä¸Šçš„å†™å…¥é”ã€‚ç›®å½•åçš„è¯»å–é”è¶³ä»¥çš„é˜²æ­¢ç›®å½•è¢«åˆ é™¤ã€æ”¹åä»¥åŠè¢«å¿«ç…§ã€‚æ–‡ä»¶åçš„å†™å…¥é”åºåˆ—åŒ–æ–‡ä»¶åˆ›å»ºæ“ä½œï¼Œç¡®ä¿ä¸ä¼šå¤šæ¬¡åˆ›å»ºåŒåçš„æ–‡ä»¶ã€‚</p>
<p>å› ä¸ºåç§°ç©ºé—´å¯èƒ½æœ‰å¾ˆå¤šèŠ‚ç‚¹ï¼Œè¯»å†™é”é‡‡ç”¨æƒ°æ€§åˆ†é…ç­–ç•¥ï¼Œåœ¨ä¸å†ä½¿ç”¨çš„æ—¶å€™ç«‹åˆ»è¢«åˆ é™¤ã€‚åŒæ ·ï¼Œé”çš„è·å–ä¹Ÿè¦ä¾æ®ä¸€ä¸ªå…¨å±€ä¸€è‡´çš„é¡ºåºæ¥é¿å…æ­»é”ï¼šé¦–å…ˆæŒ‰åç§°ç©ºé—´çš„å±‚æ¬¡æ’åºï¼Œåœ¨åŒä¸€ä¸ªå±‚æ¬¡å†…æŒ‰å­—å…¸é¡ºåºæ’åºã€‚</p>
<h4 id="4-2-å‰¯æœ¬çš„ä½ç½®"><a href="#4-2-å‰¯æœ¬çš„ä½ç½®" class="headerlink" title="4.2 å‰¯æœ¬çš„ä½ç½®"></a>4.2 å‰¯æœ¬çš„ä½ç½®</h4><p>GFSé›†ç¾¤æ˜¯é«˜åº¦åˆ†å¸ƒçš„å¤šå±‚å¸ƒå±€ç»“æ„ï¼Œè€Œä¸æ˜¯å¹³é¢ç»“æ„ã€‚å…¸å‹çš„æ‹“æ‰‘ç»“æ„æ˜¯æœ‰æ•°ç™¾ä¸ªChunkæœåŠ¡å™¨å®‰è£…åœ¨è®¸å¤šæœºæ¶ä¸Šã€‚ChunkæœåŠ¡å™¨è¢«æ¥è‡ªåŒ ä¸€æˆ–è€…ä¸åŒæœºæ¶ä¸Šçš„æ•°ç™¾ä¸ªå®¢æˆ·æœºè½®æµè®¿é—®ã€‚ä¸åŒæœºæ¶ä¸Šçš„ä¸¤å°æœºå™¨é—´çš„é€šè®¯å¯èƒ½è·¨è¶Šä¸€ä¸ªæˆ–å¤šä¸ªç½‘ç»œäº¤æ¢æœºã€‚å¦å¤–ï¼Œæœºæ¶çš„å‡ºå…¥å¸¦å®½å¯èƒ½æ¯”æœºæ¶å†…æ‰€æœ‰æœºå™¨åŠ å’Œåœ¨ ä¸€èµ·çš„å¸¦å®½è¦å°ã€‚å¤šå±‚åˆ†å¸ƒæ¶æ„å¯¹æ•°æ®çš„çµæ´»æ€§ã€å¯é æ€§ä»¥åŠå¯ç”¨æ€§æ–¹é¢æå‡ºç‰¹æœ‰çš„æŒ‘æˆ˜ã€‚</p>
<p>Chunkå‰¯æœ¬ä½ç½®é€‰æ‹©çš„ç­–ç•¥æœåŠ¡ä¸¤å¤§ç›®æ ‡ï¼šæœ€å¤§åŒ–æ•°æ®å¯é æ€§å’Œå¯ç”¨æ€§ï¼Œæœ€å¤§åŒ–ç½‘ç»œå¸¦å®½åˆ©ç”¨ç‡ã€‚ä¸ºäº†å®ç°è¿™ä¸¤ä¸ªç›®çš„ï¼Œä»…ä»…æ˜¯åœ¨å¤šå°æœºå™¨ä¸Šåˆ†åˆ«å­˜ å‚¨è¿™äº›å‰¯æœ¬æ˜¯ä¸å¤Ÿçš„ï¼Œè¿™åªèƒ½é¢„é˜²ç¡¬ç›˜æŸåæˆ–è€…æœºå™¨å¤±æ•ˆå¸¦æ¥çš„å½±å“ï¼Œä»¥åŠæœ€å¤§åŒ–æ¯å°æœºå™¨çš„ç½‘ç»œå¸¦å®½åˆ©ç”¨ç‡ã€‚æˆ‘ä»¬å¿…é¡»åœ¨å¤šä¸ªæœºæ¶é—´åˆ†å¸ƒå‚¨å­˜Chunkçš„å‰¯æœ¬ã€‚ è¿™ä¿è¯Chunkçš„ä¸€äº›å‰¯æœ¬åœ¨æ•´ä¸ªæœºæ¶è¢«ç ´åæˆ–æ‰çº¿ï¼ˆæ¯”å¦‚ï¼Œå…±äº«èµ„æºï¼Œå¦‚ç”µæºæˆ–è€…ç½‘ç»œäº¤æ¢æœºé€ æˆçš„é—®é¢˜ï¼‰çš„æƒ…å†µä¸‹ä¾ç„¶å­˜åœ¨ä¸”ä¿æŒå¯ç”¨çŠ¶æ€ã€‚è¿™è¿˜æ„å‘³ç€åœ¨ç½‘ ç»œæµé‡æ–¹é¢ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹Chunkçš„è¯»æ“ä½œï¼Œèƒ½å¤Ÿæœ‰æ•ˆåˆ©ç”¨å¤šä¸ªæœºæ¶çš„æ•´åˆå¸¦å®½ã€‚å¦ä¸€æ–¹é¢ï¼Œå†™æ“ä½œå¿…é¡»å’Œå¤šä¸ªæœºæ¶ä¸Šçš„è®¾å¤‡è¿›è¡Œç½‘ç»œé€šä¿¡ï¼Œä½†æ˜¯è¿™ä¸ªä»£ä»·æ˜¯æˆ‘ä»¬ æ„¿æ„ä»˜å‡ºçš„ã€‚</p>
<h4 id="4-3-åˆ›å»ºï¼Œé‡æ–°å¤åˆ¶ï¼Œé‡æ–°è´Ÿè½½å‡è¡¡"><a href="#4-3-åˆ›å»ºï¼Œé‡æ–°å¤åˆ¶ï¼Œé‡æ–°è´Ÿè½½å‡è¡¡" class="headerlink" title="4.3 åˆ›å»ºï¼Œé‡æ–°å¤åˆ¶ï¼Œé‡æ–°è´Ÿè½½å‡è¡¡"></a>4.3 åˆ›å»ºï¼Œé‡æ–°å¤åˆ¶ï¼Œé‡æ–°è´Ÿè½½å‡è¡¡</h4><p>Chunkçš„å‰¯æœ¬æœ‰ä¸‰ä¸ªç”¨é€”ï¼šChunkåˆ›å»ºï¼Œé‡æ–°å¤åˆ¶å’Œé‡æ–°è´Ÿè½½å‡è¡¡ã€‚</p>
<p>å½“MasterèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªChunkæ—¶ï¼Œå®ƒä¼šé€‰æ‹©åœ¨å“ªé‡Œæ”¾ç½®åˆå§‹çš„ç©ºçš„å‰¯æœ¬ã€‚MasterèŠ‚ç‚¹ä¼šè€ƒè™‘å‡ ä¸ªå› ç´ ã€‚</p>
<ul>
<li>(1) æˆ‘ä»¬å¸Œæœ›åœ¨ä½äºå¹³å‡ç¡¬ç›˜ ä½¿ç”¨ç‡çš„ChunkæœåŠ¡å™¨ä¸Šå­˜å‚¨æ–°çš„å‰¯æœ¬ã€‚è¿™æ ·çš„åšæ³•æœ€ç»ˆèƒ½å¤Ÿå¹³è¡¡ChunkæœåŠ¡å™¨ä¹‹é—´çš„ç¡¬ç›˜ä½¿ç”¨ç‡ã€‚</li>
<li>(2) æˆ‘ä»¬å¸Œæœ›é™åˆ¶åœ¨æ¯ä¸ªChunkæœåŠ¡å™¨ä¸Šâ€æœ€ è¿‘â€çš„Chunkåˆ›å»ºæ“ä½œçš„æ¬¡æ•°ã€‚è™½ç„¶åˆ›å»ºæ“ä½œæœ¬èº«æ˜¯å»‰ä»·çš„ï¼Œä½†æ˜¯åˆ›å»ºæ“ä½œä¹Ÿæ„å‘³ç€éšä¹‹ä¼šæœ‰å¤§é‡çš„å†™å…¥æ•°æ®çš„æ“ä½œï¼Œå› ä¸ºChunkåœ¨WriterçœŸæ­£å†™å…¥ æ•°æ®çš„æ—¶å€™æ‰è¢«åˆ›å»ºï¼Œè€Œåœ¨æˆ‘ä»¬çš„â€è¿½åŠ ä¸€æ¬¡ï¼Œè¯»å–å¤šæ¬¡â€çš„å·¥ä½œæ¨¡å¼ä¸‹ï¼ŒChunkä¸€æ—¦å†™å…¥æˆåŠŸä¹‹åå°±ä¼šå˜ä¸ºåªè¯»çš„äº†ã€‚</li>
<li>(3) å¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å¸Œæœ›æŠŠ Chunkçš„å‰¯æœ¬åˆ†å¸ƒåœ¨å¤šä¸ªæœºæ¶ä¹‹é—´ã€‚</li>
</ul>
<p>å½“Chunkçš„æœ‰æ•ˆå‰¯æœ¬æ•°é‡å°‘äºç”¨æˆ·æŒ‡å®šçš„å¤åˆ¶å› æ•°çš„æ—¶å€™ï¼ŒMasterèŠ‚ç‚¹ä¼šé‡æ–°å¤åˆ¶å®ƒã€‚è¿™å¯èƒ½æ˜¯ç”±å‡ ä¸ªåŸå› å¼•èµ·çš„ï¼šä¸€ä¸ªChunkæœåŠ¡å™¨ä¸ å¯ç”¨äº†ï¼ŒChunkæœåŠ¡å™¨æŠ¥å‘Šå®ƒæ‰€å­˜å‚¨çš„ä¸€ä¸ªå‰¯æœ¬æŸåäº†ï¼ŒChunkæœåŠ¡å™¨çš„ä¸€ä¸ªç£ç›˜å› ä¸ºé”™è¯¯ä¸å¯ç”¨äº†ï¼Œæˆ–è€…Chunkå‰¯æœ¬çš„å¤åˆ¶å› æ•°æé«˜äº†ã€‚æ¯ä¸ªéœ€è¦è¢« é‡æ–°å¤åˆ¶çš„Chunkéƒ½ä¼šæ ¹æ®å‡ ä¸ªå› ç´ è¿›è¡Œæ’åºã€‚ä¸€ä¸ªå› ç´ æ˜¯Chunkç°æœ‰å‰¯æœ¬æ•°é‡å’Œå¤åˆ¶å› æ•°ç›¸å·®å¤šå°‘ã€‚ä¾‹å¦‚ï¼Œä¸¢å¤±ä¸¤ä¸ªå‰¯æœ¬çš„Chunkæ¯”ä¸¢å¤±ä¸€ä¸ªå‰¯æœ¬çš„ Chunkæœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚å¦å¤–ï¼Œæˆ‘ä»¬ä¼˜å…ˆé‡æ–°å¤åˆ¶æ´»è·ƒï¼ˆliveï¼‰æ–‡ä»¶çš„Chunkè€Œä¸æ˜¯æœ€è¿‘åˆšè¢«åˆ é™¤çš„æ–‡ä»¶çš„Chunkï¼ˆæŸ¥çœ‹4.4èŠ‚ï¼‰ã€‚æœ€åï¼Œä¸ºäº† æœ€å°åŒ–å¤±æ•ˆçš„Chunkå¯¹æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºçš„å½±å“ï¼Œæˆ‘ä»¬æé«˜ä¼šé˜»å¡å®¢æˆ·æœºç¨‹åºå¤„ç†æµç¨‹çš„Chunkçš„ä¼˜å…ˆçº§ã€‚</p>
<p>MasterèŠ‚ç‚¹é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„Chunkï¼Œç„¶åå‘½ä»¤æŸä¸ªChunkæœåŠ¡å™¨ç›´æ¥ä»å¯ç”¨çš„å‰¯æœ¬â€å…‹éš†â€ä¸€ä¸ªå‰¯æœ¬å‡ºæ¥ã€‚é€‰æ‹©æ–°å‰¯æœ¬çš„ä½ç½®çš„ç­–ç•¥å’Œ åˆ›å»ºæ—¶ç±»ä¼¼ï¼šå¹³è¡¡ç¡¬ç›˜ä½¿ç”¨ç‡ã€é™åˆ¶åŒä¸€å°ChunkæœåŠ¡å™¨ä¸Šçš„æ­£åœ¨è¿›è¡Œçš„å…‹éš†æ“ä½œçš„æ•°é‡ã€åœ¨æœºæ¶é—´åˆ†å¸ƒå‰¯æœ¬ã€‚ä¸ºäº†é˜²æ­¢å…‹éš†äº§ç”Ÿçš„ç½‘ç»œæµé‡å¤§å¤§è¶…è¿‡å®¢æˆ·æœºçš„ æµé‡ï¼ŒMasterèŠ‚ç‚¹å¯¹æ•´ä¸ªé›†ç¾¤å’Œæ¯ä¸ªChunkæœåŠ¡å™¨ä¸Šçš„åŒæ—¶è¿›è¡Œçš„å…‹éš†æ“ä½œçš„æ•°é‡éƒ½è¿›è¡Œäº†é™åˆ¶ã€‚å¦å¤–ï¼ŒChunkæœåŠ¡å™¨é€šè¿‡è°ƒèŠ‚å®ƒå¯¹æºChunkæœ åŠ¡å™¨è¯»è¯·æ±‚çš„é¢‘ç‡æ¥é™åˆ¶å®ƒç”¨äºå…‹éš†æ“ä½œçš„å¸¦å®½ã€‚</p>
<p>æœ€åï¼ŒMasteræœåŠ¡å™¨å‘¨æœŸæ€§åœ°å¯¹å‰¯æœ¬è¿›è¡Œé‡æ–°è´Ÿè½½å‡è¡¡ï¼šå®ƒæ£€æŸ¥å½“å‰çš„å‰¯æœ¬åˆ†å¸ƒæƒ…å†µï¼Œç„¶åç§»åŠ¨å‰¯æœ¬ä»¥ä¾¿æ›´å¥½çš„åˆ©ç”¨ç¡¬ç›˜ç©ºé—´ã€æ›´æœ‰æ•ˆçš„è¿›è¡Œè´Ÿè½½ å‡è¡¡ã€‚è€Œä¸”åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒMasteræœåŠ¡å™¨é€æ¸çš„å¡«æ»¡ä¸€ä¸ªæ–°çš„ChunkæœåŠ¡å™¨ï¼Œè€Œä¸æ˜¯åœ¨çŸ­æ—¶é—´å†…ç”¨æ–°çš„Chunkå¡«æ»¡å®ƒï¼Œä»¥è‡³äºè¿‡è½½ã€‚æ–°å‰¯æœ¬çš„å­˜å‚¨ä½ ç½®é€‰æ‹©ç­–ç•¥å’Œä¸Šé¢è®¨è®ºçš„ç›¸åŒã€‚å¦å¤–ï¼ŒMasterèŠ‚ç‚¹å¿…é¡»é€‰æ‹©å“ªä¸ªå‰¯æœ¬è¦è¢«ç§»èµ°ã€‚é€šå¸¸æƒ…å†µï¼ŒMasterèŠ‚ç‚¹ç§»èµ°é‚£äº›å‰©ä½™ç©ºé—´ä½äºå¹³å‡å€¼çš„ChunkæœåŠ¡ å™¨ä¸Šçš„å‰¯æœ¬ï¼Œä»è€Œå¹³è¡¡ç³»ç»Ÿæ•´ä½“çš„ç¡¬ç›˜ä½¿ç”¨ç‡ã€‚</p>
<h4 id="4-4-åƒåœ¾å›æ”¶"><a href="#4-4-åƒåœ¾å›æ”¶" class="headerlink" title="4.4 åƒåœ¾å›æ”¶"></a>4.4 åƒåœ¾å›æ”¶</h4><p>GFSåœ¨æ–‡ä»¶åˆ é™¤åä¸ä¼šç«‹åˆ»å›æ”¶å¯ç”¨çš„ç‰©ç†ç©ºé—´ã€‚GFSç©ºé—´å›æ”¶é‡‡ç”¨æƒ°æ€§çš„ç­–ç•¥ï¼Œåªåœ¨æ–‡ä»¶å’ŒChunkçº§çš„å¸¸è§„åƒåœ¾æ”¶é›†æ—¶è¿›è¡Œã€‚æˆ‘ä»¬å‘ç°è¿™ä¸ªæ–¹æ³•ä½¿ç³»ç»Ÿæ›´ç®€å•ã€æ›´å¯é ã€‚</p>
<h5 id="4-4-1-æœºåˆ¶"><a href="#4-4-1-æœºåˆ¶" class="headerlink" title="4.4.1 æœºåˆ¶"></a>4.4.1 æœºåˆ¶</h5><p>å½“ä¸€ä¸ªæ–‡ä»¶è¢«åº”ç”¨ç¨‹åºåˆ é™¤æ—¶ï¼ŒMasterèŠ‚ç‚¹è±¡å¯¹å¾…å…¶å®ƒä¿®æ”¹æ“ä½œä¸€æ ·ï¼Œç«‹åˆ»æŠŠåˆ é™¤æ“ä½œä»¥æ—¥å¿—çš„æ–¹å¼è®°å½•ä¸‹æ¥ã€‚ä½†æ˜¯ï¼ŒMasterèŠ‚ç‚¹å¹¶ä¸é©¬ä¸Š å›æ”¶èµ„æºï¼Œè€Œæ˜¯æŠŠæ–‡ä»¶åæ”¹ä¸ºä¸€ä¸ªåŒ…å«åˆ é™¤æ—¶é—´æˆ³çš„ã€éšè—çš„åå­—ã€‚å½“MasterèŠ‚ç‚¹å¯¹æ–‡ä»¶ç³»ç»Ÿå‘½åç©ºé—´åšå¸¸è§„æ‰«æçš„æ—¶å€™ï¼Œå®ƒä¼šåˆ é™¤æ‰€æœ‰ä¸‰å¤©å‰çš„éšè—æ–‡ä»¶ ï¼ˆè¿™ä¸ªæ—¶é—´é—´éš”æ˜¯å¯ä»¥è®¾ç½®çš„ï¼‰ã€‚ç›´åˆ°æ–‡ä»¶è¢«çœŸæ­£åˆ é™¤ï¼Œå®ƒä»¬ä»æ—§å¯ä»¥ç”¨æ–°çš„ç‰¹æ®Šçš„åå­—è¯»å–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŠŠéšè—æ–‡ä»¶æ”¹åä¸ºæ­£å¸¸æ˜¾ç¤ºçš„æ–‡ä»¶åçš„æ–¹å¼â€œååˆ é™¤â€ã€‚ å½“éšè—æ–‡ä»¶è¢«ä»åç§°ç©ºé—´ä¸­åˆ é™¤ï¼ŒMasteræœåŠ¡å™¨å†…å­˜ä¸­ä¿å­˜çš„è¿™ä¸ªæ–‡ä»¶çš„ç›¸å…³å…ƒæ•°æ®æ‰ä¼šè¢«åˆ é™¤ã€‚è¿™ä¹Ÿæœ‰æ•ˆçš„åˆ‡æ–­äº†æ–‡ä»¶å’Œå®ƒåŒ…å«çš„æ‰€æœ‰Chunkçš„è¿æ¥ <strong>ï¼ˆalexæ³¨ï¼šåŸæ–‡æ˜¯This effectively severs its links to all its chunksï¼‰ã€‚</strong></p>
<p>åœ¨å¯¹Chunkåå­—ç©ºé—´åšç±»ä¼¼çš„å¸¸è§„æ‰«ææ—¶ï¼ŒMasterèŠ‚ç‚¹æ‰¾åˆ°å­¤å„¿Chunkï¼ˆä¸è¢«ä»»ä½•æ–‡ä»¶åŒ…å«çš„Chunkï¼‰å¹¶åˆ é™¤å®ƒä»¬çš„å…ƒæ•°æ®ã€‚ ChunkæœåŠ¡å™¨åœ¨å’ŒMasterèŠ‚ç‚¹äº¤äº’çš„å¿ƒè·³ä¿¡æ¯ä¸­ï¼ŒæŠ¥å‘Šå®ƒæ‹¥æœ‰çš„Chunkå­é›†çš„ä¿¡æ¯ï¼ŒMasterèŠ‚ç‚¹å›å¤ChunkæœåŠ¡å™¨å“ªäº›Chunkåœ¨ MasterèŠ‚ç‚¹ä¿å­˜çš„å…ƒæ•°æ®ä¸­å·²ç»ä¸å­˜åœ¨äº†ã€‚ChunkæœåŠ¡å™¨å¯ä»¥ä»»æ„åˆ é™¤è¿™äº›Chunkçš„å‰¯æœ¬ã€‚</p>
<h5 id="4-4-2-è®¨è®º"><a href="#4-4-2-è®¨è®º" class="headerlink" title="4.4.2 è®¨è®º"></a>4.4.2 è®¨è®º</h5><p>è™½ç„¶åˆ†å¸ƒå¼åƒåœ¾å›æ”¶åœ¨ç¼–ç¨‹è¯­è¨€é¢†åŸŸæ˜¯ä¸€ä¸ªéœ€è¦å¤æ‚çš„æ–¹æ¡ˆæ‰èƒ½è§£å†³çš„éš¾é¢˜ï¼Œä½†æ˜¯åœ¨GFSç³»ç»Ÿä¸­æ˜¯éå¸¸ç®€å•çš„ã€‚æˆ‘ä»¬å¯ä»¥è½»æ˜“çš„å¾—åˆ°Chunkçš„æ‰€æœ‰ å¼•ç”¨ï¼šå®ƒä»¬éƒ½åªå­˜å‚¨åœ¨MasteræœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶åˆ°å—çš„æ˜ å°„è¡¨ä¸­ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥å¾ˆè½»æ˜“çš„å¾—åˆ°æ‰€æœ‰Chunkçš„å‰¯æœ¬ï¼šå®ƒä»¬éƒ½ä»¥Linuxæ–‡ä»¶çš„å½¢å¼å­˜å‚¨åœ¨ ChunkæœåŠ¡å™¨çš„æŒ‡å®šç›®å½•ä¸‹ã€‚æ‰€æœ‰MasterèŠ‚ç‚¹ä¸èƒ½è¯†åˆ«çš„å‰¯æœ¬éƒ½æ˜¯â€åƒåœ¾â€ã€‚</p>
<p>åƒåœ¾å›æ”¶åœ¨ç©ºé—´å›æ”¶æ–¹é¢ç›¸æ¯”ç›´æ¥åˆ é™¤æœ‰å‡ ä¸ªä¼˜åŠ¿ã€‚</p>
<ul>
<li>é¦–å…ˆï¼Œå¯¹äºç»„ä»¶å¤±æ•ˆæ˜¯å¸¸æ€çš„å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåƒåœ¾å›æ”¶æ–¹å¼ç®€å•å¯é ã€‚Chunkå¯èƒ½åœ¨æŸäº› ChunkæœåŠ¡å™¨åˆ›å»ºæˆåŠŸï¼ŒæŸäº›ChunkæœåŠ¡å™¨ä¸Šåˆ›å»ºå¤±è´¥ï¼Œå¤±è´¥çš„å‰¯æœ¬å¤„äºæ— æ³•è¢«MasterèŠ‚ç‚¹è¯†åˆ«çš„çŠ¶æ€ã€‚å‰¯æœ¬åˆ é™¤æ¶ˆæ¯å¯èƒ½ä¸¢å¤±ï¼ŒMasterèŠ‚ç‚¹ å¿…é¡»é‡æ–°å‘é€å¤±è´¥çš„åˆ é™¤æ¶ˆæ¯ï¼ŒåŒ…æ‹¬è‡ªèº«çš„å’ŒChunkæœåŠ¡å™¨çš„ <strong>ï¼ˆalexæ³¨ï¼šè‡ªèº«çš„æŒ‡åˆ é™¤metadataçš„æ¶ˆæ¯ï¼‰ã€‚</strong> åƒåœ¾å›æ”¶æä¾›äº†ä¸€è‡´çš„ã€å¯é çš„æ¸…é™¤æ— ç”¨å‰¯æœ¬çš„æ–¹æ³•ã€‚</li>
<li>ç¬¬äºŒï¼Œåƒåœ¾å›æ”¶æŠŠå­˜å‚¨ç©ºé—´çš„å›æ”¶æ“ä½œåˆå¹¶åˆ°MasterèŠ‚ç‚¹è§„å¾‹æ€§çš„åå°æ´»åŠ¨ä¸­ï¼Œæ¯”å¦‚ï¼Œä¾‹è¡Œæ‰«æå’Œä¸ ChunkæœåŠ¡å™¨æ¡æ‰‹ç­‰ã€‚å› æ­¤ï¼Œæ“ä½œè¢«æ‰¹é‡çš„æ‰§è¡Œï¼Œå¼€é”€ä¼šè¢«åˆ†æ•£ã€‚å¦å¤–ï¼Œåƒåœ¾å›æ”¶åœ¨MasterèŠ‚ç‚¹ç›¸å¯¹ç©ºé—²çš„æ—¶å€™å®Œæˆã€‚è¿™æ ·MasterèŠ‚ç‚¹å°±å¯ä»¥ç»™é‚£ äº›éœ€è¦å¿«é€Ÿååº”çš„å®¢æˆ·æœºè¯·æ±‚æä¾›æ›´å¿«æ·çš„å“åº”ã€‚</li>
<li>ç¬¬ä¸‰ï¼Œå»¶ç¼“å­˜å‚¨ç©ºé—´å›æ”¶ä¸ºæ„å¤–çš„ã€ä¸å¯é€†è½¬çš„åˆ é™¤æ“ä½œæä¾›äº†å®‰å…¨ä¿éšœã€‚</li>
</ul>
<p>æ ¹æ®æˆ‘ä»¬çš„ä½¿ç”¨ç»éªŒï¼Œå»¶è¿Ÿå›æ”¶ç©ºé—´çš„ä¸»è¦é—®é¢˜æ˜¯ï¼Œå»¶è¿Ÿå›æ”¶ä¼šé˜»ç¢ç”¨æˆ·è°ƒä¼˜å­˜å‚¨ç©ºé—´çš„ä½¿ç”¨ï¼Œç‰¹åˆ«æ˜¯å½“å­˜å‚¨ç©ºé—´æ¯”è¾ƒç´§ç¼ºçš„æ—¶å€™ã€‚å½“åº”ç”¨ç¨‹åºé‡å¤åˆ›å»º å’Œåˆ é™¤ä¸´æ—¶æ–‡ä»¶æ—¶ï¼Œé‡Šæ”¾çš„å­˜å‚¨ç©ºé—´ä¸èƒ½é©¬ä¸Šé‡ç”¨ã€‚æˆ‘ä»¬é€šè¿‡æ˜¾å¼çš„å†æ¬¡åˆ é™¤ä¸€ä¸ªå·²ç»è¢«åˆ é™¤çš„æ–‡ä»¶çš„æ–¹å¼åŠ é€Ÿç©ºé—´å›æ”¶çš„é€Ÿåº¦ã€‚æˆ‘ä»¬å…è®¸ç”¨æˆ·ä¸ºå‘½åç©ºé—´çš„ä¸åŒéƒ¨ åˆ†è®¾å®šä¸åŒçš„å¤åˆ¶å’Œå›æ”¶ç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·å¯ä»¥æŒ‡å®šæŸäº›ç›®å½•æ ‘ä¸‹é¢çš„æ–‡ä»¶ä¸åšå¤åˆ¶ï¼Œåˆ é™¤çš„æ–‡ä»¶è¢«å³æ—¶çš„ã€ä¸å¯æ¢å¤çš„ä»æ–‡ä»¶ç³»ç»Ÿç§»é™¤ã€‚</p>
<h4 id="4-5-è¿‡æœŸå¤±æ•ˆçš„å‰¯æœ¬æ£€æµ‹"><a href="#4-5-è¿‡æœŸå¤±æ•ˆçš„å‰¯æœ¬æ£€æµ‹" class="headerlink" title="4.5 è¿‡æœŸå¤±æ•ˆçš„å‰¯æœ¬æ£€æµ‹"></a>4.5 è¿‡æœŸå¤±æ•ˆçš„å‰¯æœ¬æ£€æµ‹</h4><p>å½“ChunkæœåŠ¡å™¨å¤±æ•ˆæ—¶ï¼ŒChunkçš„å‰¯æœ¬æœ‰å¯èƒ½å› é”™å¤±äº†ä¸€äº›ä¿®æ”¹æ“ä½œè€Œè¿‡æœŸå¤±æ•ˆã€‚MasterèŠ‚ç‚¹ä¿å­˜äº†æ¯ä¸ªChunkçš„ç‰ˆæœ¬å·ï¼Œç”¨æ¥åŒºåˆ†å½“å‰çš„å‰¯æœ¬å’Œè¿‡æœŸå‰¯æœ¬ã€‚</p>
<p>æ— è®ºä½•æ—¶ï¼Œåªè¦MasterèŠ‚ç‚¹å’ŒChunkç­¾è®¢ä¸€ä¸ªæ–°çš„ç§Ÿçº¦ï¼Œå®ƒå°±å¢åŠ Chunkçš„ç‰ˆæœ¬å·ï¼Œç„¶åé€šçŸ¥æœ€æ–°çš„å‰¯æœ¬ã€‚MasterèŠ‚ç‚¹å’Œè¿™äº›å‰¯æœ¬ éƒ½æŠŠæ–°çš„ç‰ˆæœ¬å·è®°å½•åœ¨å®ƒä»¬æŒä¹…åŒ–å­˜å‚¨çš„çŠ¶æ€ä¿¡æ¯ä¸­ã€‚è¿™ä¸ªåŠ¨ä½œå‘ç”Ÿåœ¨ä»»ä½•å®¢æˆ·æœºå¾—åˆ°é€šçŸ¥ä»¥å‰ï¼Œå› æ­¤ä¹Ÿæ˜¯å¯¹è¿™ä¸ªChunkå¼€å§‹å†™ä¹‹å‰ã€‚å¦‚æœæŸä¸ªå‰¯æœ¬æ‰€åœ¨çš„ ChunkæœåŠ¡å™¨æ­£å¥½å¤„äºå¤±æ•ˆçŠ¶æ€ï¼Œé‚£ä¹ˆå‰¯æœ¬çš„ç‰ˆæœ¬å·å°±ä¸ä¼šè¢«å¢åŠ ã€‚MasterèŠ‚ç‚¹åœ¨è¿™ä¸ªChunkæœåŠ¡å™¨é‡æ–°å¯åŠ¨ï¼Œå¹¶ä¸”å‘MasterèŠ‚ç‚¹æŠ¥å‘Šå®ƒæ‹¥æœ‰ çš„Chunkçš„é›†åˆä»¥åŠç›¸åº”çš„ç‰ˆæœ¬å·çš„æ—¶å€™ï¼Œå°±ä¼šæ£€æµ‹å‡ºå®ƒåŒ…å«è¿‡æœŸçš„Chunkã€‚å¦‚æœMasterèŠ‚ç‚¹çœ‹åˆ°ä¸€ä¸ªæ¯”å®ƒè®°å½•çš„ç‰ˆæœ¬å·æ›´é«˜çš„ç‰ˆæœ¬ å·ï¼ŒMasterèŠ‚ç‚¹ä¼šè®¤ä¸ºå®ƒå’ŒChunkæœåŠ¡å™¨ç­¾è®¢ç§Ÿçº¦çš„æ“ä½œå¤±è´¥äº†ï¼Œå› æ­¤ä¼šé€‰æ‹©æ›´é«˜çš„ç‰ˆæœ¬å·ä½œä¸ºå½“å‰çš„ç‰ˆæœ¬å·ã€‚</p>
<p>MasterèŠ‚ç‚¹åœ¨ä¾‹è¡Œçš„åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ç§»é™¤æ‰€æœ‰çš„è¿‡æœŸå¤±æ•ˆå‰¯æœ¬ã€‚åœ¨æ­¤ä¹‹å‰ï¼ŒMasterèŠ‚ç‚¹åœ¨å›å¤å®¢æˆ·æœºçš„Chunkä¿¡æ¯è¯·æ±‚çš„æ—¶å€™ï¼Œç®€å•çš„ è®¤ä¸ºé‚£äº›è¿‡æœŸçš„å—æ ¹æœ¬å°±ä¸å­˜åœ¨ã€‚å¦å¤–ä¸€é‡ä¿éšœæªæ–½æ˜¯ï¼ŒMasterèŠ‚ç‚¹åœ¨é€šçŸ¥å®¢æˆ·æœºå“ªä¸ªChunkæœåŠ¡å™¨æŒæœ‰ç§Ÿçº¦ã€æˆ–è€…æŒ‡ç¤ºChunkæœåŠ¡å™¨ä»å“ªä¸ªChunkæœåŠ¡å™¨è¿›è¡Œå…‹éš†æ—¶ï¼Œæ¶ˆæ¯ä¸­éƒ½é™„å¸¦äº†Chunkçš„ç‰ˆæœ¬å·ã€‚å®¢æˆ·æœºæˆ–è€…ChunkæœåŠ¡å™¨åœ¨æ‰§è¡Œæ“ä½œæ—¶éƒ½ä¼šéªŒè¯ç‰ˆæœ¬å·ä»¥ç¡®ä¿æ€»æ˜¯è®¿é—®å½“å‰ç‰ˆæœ¬çš„æ•°æ®ã€‚</p>
<h3 id="5-å®¹é”™å’Œè¯Šæ–­"><a href="#5-å®¹é”™å’Œè¯Šæ–­" class="headerlink" title="5. å®¹é”™å’Œè¯Šæ–­"></a>5. å®¹é”™å’Œè¯Šæ–­</h3><p>æˆ‘ä»¬åœ¨è®¾è®¡GFSæ—¶é‡åˆ°çš„æœ€å¤§æŒ‘æˆ˜ä¹‹ä¸€æ˜¯å¦‚ä½•å¤„ç†é¢‘ç¹å‘ç”Ÿçš„ç»„ä»¶å¤±æ•ˆã€‚ç»„ä»¶çš„æ•°é‡å’Œè´¨é‡è®©è¿™äº›é—®é¢˜å‡ºç°çš„é¢‘ç‡è¿œè¿œè¶…è¿‡ä¸€èˆ¬ç³»ç»Ÿæ„å¤–å‘ç”Ÿçš„é¢‘ç‡ï¼š æˆ‘ä»¬ä¸èƒ½å®Œå…¨ä¾èµ–æœºå™¨çš„ç¨³å®šæ€§ï¼Œä¹Ÿä¸èƒ½å®Œå…¨ç›¸ä¿¡ç¡¬ç›˜çš„å¯é æ€§ã€‚ç»„ä»¶çš„å¤±æ•ˆå¯èƒ½é€ æˆç³»ç»Ÿä¸å¯ç”¨ï¼Œæ›´ç³Ÿç³•çš„æ˜¯ï¼Œè¿˜å¯èƒ½äº§ç”Ÿä¸å®Œæ•´çš„æ•°æ®ã€‚æˆ‘ä»¬è®¨è®ºæˆ‘ä»¬å¦‚ä½•é¢å¯¹ è¿™äº›æŒ‘æˆ˜ï¼Œä»¥åŠå½“ç»„ä»¶å¤±æ•ˆä¸å¯é¿å…çš„å‘ç”Ÿæ—¶ï¼Œç”¨GFSè‡ªå¸¦å·¥å…·è¯Šæ–­ç³»ç»Ÿæ•…éšœã€‚</p>
<h4 id="5-1-é«˜å¯ç”¨æ€§"><a href="#5-1-é«˜å¯ç”¨æ€§" class="headerlink" title="5.1 é«˜å¯ç”¨æ€§"></a>5.1 é«˜å¯ç”¨æ€§</h4><p>åœ¨GFSé›†ç¾¤çš„æ•°ç™¾ä¸ªæœåŠ¡å™¨ä¹‹ä¸­ï¼Œåœ¨ä»»ä½•ç»™å®šçš„æ—¶é—´å¿…å®šä¼šæœ‰äº›æœåŠ¡å™¨æ˜¯ä¸å¯ç”¨çš„ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸¤æ¡ç®€å•ä½†æ˜¯æœ‰æ•ˆçš„ç­–ç•¥ä¿è¯æ•´ä¸ªç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ï¼šå¿«é€Ÿæ¢å¤å’Œå¤åˆ¶ã€‚</p>
<h5 id="5-1-1-å¿«é€Ÿæ¢å¤"><a href="#5-1-1-å¿«é€Ÿæ¢å¤" class="headerlink" title="5.1.1 å¿«é€Ÿæ¢å¤"></a>5.1.1 å¿«é€Ÿæ¢å¤</h5><p>ä¸ç®¡MasteræœåŠ¡å™¨å’ŒChunkæœåŠ¡å™¨æ˜¯å¦‚ä½•å…³é—­çš„ï¼Œå®ƒä»¬éƒ½è¢«è®¾è®¡ä¸ºå¯ä»¥åœ¨æ•°ç§’é’Ÿå†…æ¢å¤å®ƒä»¬çš„çŠ¶æ€å¹¶é‡æ–°å¯åŠ¨ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬å¹¶ä¸åŒºåˆ†æ­£å¸¸å…³é—­å’Œå¼‚å¸¸å…³é—­ï¼›é€šå¸¸ï¼Œæˆ‘ä»¬é€šè¿‡ç›´æ¥killæ‰è¿›ç¨‹æ¥å…³é—­æœåŠ¡å™¨ã€‚å®¢æˆ·æœºå’Œå…¶å®ƒçš„æœåŠ¡å™¨ä¼šæ„Ÿè§‰åˆ°ç³»ç»Ÿæœ‰ç‚¹é¢ ç°¸<strong> (alexæ³¨ï¼ša minor hiccup)</strong>ï¼Œæ­£åœ¨å‘å‡ºçš„è¯·æ±‚ä¼šè¶…æ—¶ï¼Œéœ€è¦é‡æ–°è¿æ¥åˆ°é‡å¯åçš„æœåŠ¡å™¨ï¼Œç„¶åé‡è¯•è¿™ä¸ªè¯·æ±‚ã€‚6.6.2ç« èŠ‚è®°å½•äº†å®æµ‹çš„å¯åŠ¨æ—¶é—´ã€‚</p>
<h5 id="5-1-2-Chunkå¤åˆ¶"><a href="#5-1-2-Chunkå¤åˆ¶" class="headerlink" title="5.1.2 Chunkå¤åˆ¶"></a>5.1.2 Chunkå¤åˆ¶</h5><p>æ­£å¦‚ä¹‹å‰è®¨è®ºçš„ï¼Œæ¯ä¸ªChunkéƒ½è¢«å¤åˆ¶åˆ°ä¸åŒæœºæ¶ä¸Šçš„ä¸åŒçš„ChunkæœåŠ¡å™¨ä¸Šã€‚ç”¨æˆ·å¯ä»¥ä¸ºæ–‡ä»¶å‘½åç©ºé—´çš„ä¸åŒéƒ¨åˆ†è®¾å®šä¸åŒçš„å¤åˆ¶çº§åˆ«ã€‚ç¼ºçœæ˜¯ 3ã€‚å½“æœ‰ChunkæœåŠ¡å™¨ç¦»çº¿äº†ï¼Œæˆ–è€…é€šè¿‡Chksumæ ¡éªŒï¼ˆå‚è€ƒ5.2èŠ‚ï¼‰å‘ç°äº†å·²ç»æŸåçš„æ•°æ®ï¼ŒMasterèŠ‚ç‚¹é€šè¿‡å…‹éš†å·²æœ‰çš„å‰¯æœ¬ä¿è¯æ¯ä¸ª Chunkéƒ½è¢«å®Œæ•´å¤åˆ¶<strong>ï¼ˆalexæ³¨ï¼šå³æ¯ä¸ªChunkéƒ½æœ‰å¤åˆ¶å› å­åˆ¶å®šçš„ä¸ªæ•°ä¸ªå‰¯æœ¬ï¼Œç¼ºçœæ˜¯3ï¼‰</strong>ã€‚è™½ç„¶Chunkå¤åˆ¶ç­–ç•¥å¯¹æˆ‘ä»¬éå¸¸æœ‰æ•ˆï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿåœ¨å¯»æ‰¾å…¶å®ƒå½¢å¼çš„è·¨æœåŠ¡å™¨çš„å†—ä½™è§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚ä½¿ç”¨å¥‡å¶æ ¡éªŒã€æˆ–è€…Erasure codes<strong>ï¼ˆalexæ³¨ï¼šErasure codesç”¨æ¥è§£å†³é“¾æ¥å±‚ä¸­ä¸ç›¸å…³çš„é”™è¯¯ï¼Œä»¥åŠç½‘ç»œæ‹¥å¡å’Œbufferé™åˆ¶é€ æˆçš„ä¸¢åŒ…é”™è¯¯ï¼‰</strong>æ¥è§£å†³æˆ‘ä»¬æ—¥ç›Šå¢é•¿çš„åªè¯»å­˜å‚¨éœ€æ±‚ã€‚æˆ‘ä»¬çš„ç³»ç»Ÿä¸»è¦çš„å·¥ä½œè´Ÿè½½æ˜¯è¿½åŠ æ–¹å¼çš„å†™å…¥å’Œè¯»å–æ“ä½œï¼Œå¾ˆå°‘æœ‰éšæœºçš„å†™å…¥æ“ä½œï¼Œå› æ­¤ï¼Œæˆ‘ä»¬è®¤ä¸ºåœ¨æˆ‘ä»¬è¿™ä¸ªé«˜åº¦è§£è€¦åˆçš„ç³»ç»Ÿæ¶æ„ä¸‹å®ç°è¿™äº›å¤æ‚çš„å†—ä½™æ–¹æ¡ˆå¾ˆæœ‰æŒ‘æˆ˜æ€§ï¼Œä½†å¹¶éä¸å¯å®ç°ã€‚</p>
<h5 id="5-1-3-MasteræœåŠ¡å™¨çš„å¤åˆ¶"><a href="#5-1-3-MasteræœåŠ¡å™¨çš„å¤åˆ¶" class="headerlink" title="5.1.3 MasteræœåŠ¡å™¨çš„å¤åˆ¶"></a>5.1.3 MasteræœåŠ¡å™¨çš„å¤åˆ¶</h5><p>ä¸ºäº†ä¿è¯MasteræœåŠ¡å™¨çš„å¯é æ€§ï¼ŒMasteræœåŠ¡å™¨çš„çŠ¶æ€ä¹Ÿè¦å¤åˆ¶ã€‚MasteræœåŠ¡å™¨æ‰€æœ‰çš„æ“ä½œæ—¥å¿—å’Œcheckpointæ–‡ä»¶éƒ½è¢«å¤ åˆ¶åˆ°å¤šå°æœºå™¨ä¸Šã€‚å¯¹MasteræœåŠ¡å™¨çŠ¶æ€çš„ä¿®æ”¹æ“ä½œèƒ½å¤Ÿæäº¤æˆåŠŸçš„å‰ææ˜¯ï¼Œæ“ä½œæ—¥å¿—å†™å…¥åˆ°MasteræœåŠ¡å™¨çš„å¤‡èŠ‚ç‚¹å’Œæœ¬æœºçš„ç£ç›˜ã€‚ç®€å•è¯´æ¥ï¼Œä¸€ä¸ª MasteræœåŠ¡è¿›ç¨‹è´Ÿè´£æ‰€æœ‰çš„ä¿®æ”¹æ“ä½œï¼ŒåŒ…æ‹¬åå°çš„æœåŠ¡ï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶ç­‰æ”¹å˜ç³»ç»Ÿå†…éƒ¨çŠ¶æ€æ´»åŠ¨ã€‚å½“å®ƒå¤±æ•ˆçš„æ—¶ï¼Œå‡ ä¹å¯ä»¥ç«‹åˆ»é‡æ–°å¯åŠ¨ã€‚å¦‚æœMaster è¿›ç¨‹æ‰€åœ¨çš„æœºå™¨æˆ–è€…ç£ç›˜å¤±æ•ˆäº†ï¼Œå¤„äºGFSç³»ç»Ÿå¤–éƒ¨çš„ç›‘æ§è¿›ç¨‹ä¼šåœ¨å…¶å®ƒçš„å­˜æœ‰å®Œæ•´æ“ä½œæ—¥å¿—çš„æœºå™¨ä¸Šå¯åŠ¨ä¸€ä¸ªæ–°çš„Masterè¿›ç¨‹ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è§„èŒƒçš„åå­—è®¿ é—®Masterï¼ˆæ¯”å¦‚gfs-testï¼‰èŠ‚ç‚¹ï¼Œè¿™ä¸ªåå­—ç±»ä¼¼DNSåˆ«åï¼Œå› æ­¤ä¹Ÿå°±å¯ä»¥åœ¨Masterè¿›ç¨‹è½¬åˆ°åˆ«çš„æœºå™¨ä¸Šæ‰§è¡Œæ—¶ï¼Œé€šè¿‡æ›´æ”¹åˆ«åçš„å®é™…æŒ‡å‘è®¿ é—®æ–°çš„MasterèŠ‚ç‚¹ã€‚</p>
<p>æ­¤å¤–ï¼ŒGFSä¸­è¿˜æœ‰äº›â€œå½±å­â€MasteræœåŠ¡å™¨ï¼Œè¿™äº›â€œå½±å­â€æœåŠ¡å™¨åœ¨â€œä¸»â€MasteræœåŠ¡å™¨å®•æœºçš„æ—¶å€™æä¾›æ–‡ä»¶ç³»ç»Ÿçš„åªè¯»è®¿é—®ã€‚å®ƒä»¬æ˜¯å½±å­ï¼Œ è€Œä¸æ˜¯é•œåƒï¼Œæ‰€ä»¥å®ƒä»¬çš„æ•°æ®å¯èƒ½æ¯”â€œä¸»â€MasteræœåŠ¡å™¨æ›´æ–°è¦æ…¢ï¼Œé€šå¸¸æ˜¯ä¸åˆ°1ç§’ã€‚å¯¹äºé‚£äº›ä¸ç»å¸¸æ”¹å˜çš„æ–‡ä»¶ã€æˆ–è€…é‚£äº›å…è®¸è·å–çš„æ•°æ®æœ‰å°‘é‡è¿‡æœŸçš„åº” ç”¨ç¨‹åºï¼Œâ€œå½±å­â€MasteræœåŠ¡å™¨èƒ½å¤Ÿæé«˜è¯»å–çš„æ•ˆç‡ã€‚äº‹å®ä¸Šï¼Œå› ä¸ºæ–‡ä»¶å†…å®¹æ˜¯ä»ChunkæœåŠ¡å™¨ä¸Šè¯»å–çš„ï¼Œå› æ­¤ï¼Œåº”ç”¨ç¨‹åºä¸ä¼šå‘ç°è¿‡æœŸçš„æ–‡ä»¶å†…å®¹ã€‚åœ¨ è¿™ä¸ªçŸ­æš‚çš„æ—¶é—´çª—å†…ï¼Œè¿‡æœŸçš„å¯èƒ½æ˜¯æ–‡ä»¶çš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚ç›®å½•çš„å†…å®¹æˆ–è€…è®¿é—®æ§åˆ¶ä¿¡æ¯ã€‚</p>
<p>â€œå½±å­â€MasteræœåŠ¡å™¨ä¸ºäº†ä¿æŒè‡ªèº«çŠ¶æ€æ˜¯æœ€æ–°çš„ï¼Œå®ƒä¼šè¯»å–ä¸€ä»½å½“å‰æ­£åœ¨è¿›è¡Œçš„æ“ä½œçš„æ—¥å¿—å‰¯æœ¬ï¼Œå¹¶ä¸”ä¾ç…§å’Œä¸»MasteræœåŠ¡å™¨å®Œå…¨ç›¸åŒçš„é¡ºåº æ¥æ›´æ”¹å†…éƒ¨çš„æ•°æ®ç»“æ„ã€‚å’Œä¸»MasteræœåŠ¡å™¨ä¸€æ ·ï¼Œâ€œå½±å­â€MasteræœåŠ¡å™¨åœ¨å¯åŠ¨çš„æ—¶å€™ä¹Ÿä¼šä»ChunkæœåŠ¡å™¨è½®è¯¢æ•°æ®ï¼ˆä¹‹åå®šæœŸæ‹‰æ•°æ®ï¼‰ï¼Œæ•°æ®ä¸­ åŒ…æ‹¬äº†Chunkå‰¯æœ¬çš„ä½ç½®ä¿¡æ¯ï¼›â€œå½±å­â€MasteræœåŠ¡å™¨ä¹Ÿä¼šå®šæœŸå’ŒChunkæœåŠ¡å™¨â€œæ¡æ‰‹â€æ¥ç¡®å®šå®ƒä»¬çš„çŠ¶æ€ã€‚åœ¨ä¸»MasteræœåŠ¡å™¨å› åˆ›å»ºå’Œåˆ é™¤ å‰¯æœ¬å¯¼è‡´å‰¯æœ¬ä½ç½®ä¿¡æ¯æ›´æ–°æ—¶ï¼Œâ€œå½±å­â€MasteræœåŠ¡å™¨æ‰å’Œä¸»MasteræœåŠ¡å™¨é€šä¿¡æ¥æ›´æ–°è‡ªèº«çŠ¶æ€ã€‚</p>
<p>5.2 æ•°æ®å®Œæ•´æ€§<br>æ¯ä¸ªChunkæœåŠ¡å™¨éƒ½ä½¿ç”¨Checksumæ¥æ£€æŸ¥ä¿å­˜çš„æ•°æ®æ˜¯å¦æŸåã€‚è€ƒè™‘åˆ°ä¸€ä¸ªGFSé›†ç¾¤é€šå¸¸éƒ½æœ‰å¥½å‡ ç™¾å°æœºå™¨ã€å‡ åƒå—ç¡¬ç›˜ï¼Œç£ç›˜æŸåå¯¼è‡´æ•°æ® åœ¨è¯»å†™è¿‡ç¨‹ä¸­æŸåæˆ–è€…ä¸¢å¤±æ˜¯éå¸¸å¸¸è§çš„ï¼ˆç¬¬7èŠ‚è®²äº†ä¸€ä¸ªåŸå› ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ«çš„Chunkå‰¯æœ¬æ¥è§£å†³æ•°æ®æŸåé—®é¢˜ï¼Œä½†æ˜¯è·¨è¶ŠChunkæœåŠ¡å™¨æ¯”è¾ƒå‰¯æœ¬æ¥ æ£€æŸ¥æ•°æ®æ˜¯å¦æŸåå¾ˆä¸å®é™…ã€‚å¦å¤–ï¼ŒGFSå…è®¸æœ‰æ­§ä¹‰çš„å‰¯æœ¬å­˜åœ¨ï¼šGFSä¿®æ”¹æ“ä½œçš„è¯­ä¹‰ï¼Œç‰¹åˆ«æ˜¯æ—©å…ˆè®¨è®ºè¿‡çš„åŸå­çºªå½•è¿½åŠ çš„æ“ä½œï¼Œå¹¶ä¸ä¿è¯å‰¯æœ¬å®Œå…¨ç›¸åŒ<strong>(alexæ³¨ï¼šå‰¯æœ¬ä¸æ˜¯byte-wiseå®Œå…¨ä¸€è‡´çš„))</strong>ã€‚å› æ­¤ï¼Œæ¯ä¸ªChunkæœåŠ¡å™¨å¿…é¡»ç‹¬ç«‹ç»´æŠ¤Checksumæ¥æ ¡éªŒè‡ªå·±çš„å‰¯æœ¬çš„å®Œæ•´æ€§ã€‚</p>
<p>æˆ‘ä»¬æŠŠæ¯ä¸ªChunkéƒ½åˆ†æˆ64KBå¤§å°çš„å—ã€‚æ¯ä¸ªå—éƒ½å¯¹åº”ä¸€ä¸ª32ä½çš„Checksumã€‚å’Œå…¶å®ƒå…ƒæ•°æ®ä¸€æ ·ï¼ŒChecksumä¸å…¶å®ƒçš„ç”¨æˆ·æ•°æ®æ˜¯åˆ†å¼€çš„ï¼Œå¹¶ä¸”ä¿å­˜åœ¨å†…å­˜å’Œç¡¬ç›˜ä¸Šï¼ŒåŒæ—¶ä¹Ÿè®°å½•æ“ä½œæ—¥å¿—ã€‚</p>
<p>å¯¹äºè¯»æ“ä½œæ¥è¯´ï¼Œåœ¨æŠŠæ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯æˆ–è€…å…¶å®ƒçš„ChunkæœåŠ¡å™¨ä¹‹å‰ï¼ŒChunkæœåŠ¡å™¨ä¼šæ ¡éªŒè¯»å–æ“ä½œæ¶‰åŠçš„èŒƒå›´å†…çš„å—çš„Checksumã€‚å› æ­¤ ChunkæœåŠ¡å™¨ä¸ä¼šæŠŠé”™è¯¯æ•°æ®ä¼ é€’åˆ°å…¶å®ƒçš„æœºå™¨ä¸Šã€‚å¦‚æœå‘ç”ŸæŸä¸ªå—çš„Checksumä¸æ­£ç¡®ï¼ŒChunkæœåŠ¡å™¨è¿”å›ç»™è¯·æ±‚è€…ä¸€ä¸ªé”™è¯¯ä¿¡æ¯ï¼Œå¹¶ä¸”é€šçŸ¥ MasteræœåŠ¡å™¨è¿™ä¸ªé”™è¯¯ã€‚ä½œä¸ºå›åº”ï¼Œè¯·æ±‚è€…åº”å½“ä»å…¶å®ƒå‰¯æœ¬è¯»å–æ•°æ®ï¼ŒMasteræœåŠ¡å™¨ä¹Ÿä¼šä»å…¶å®ƒå‰¯æœ¬å…‹éš†æ•°æ®è¿›è¡Œæ¢å¤ã€‚å½“ä¸€ä¸ªæ–°çš„å‰¯æœ¬å°±ç»ª åï¼ŒMasteræœåŠ¡å™¨é€šçŸ¥å‰¯æœ¬é”™è¯¯çš„ChunkæœåŠ¡å™¨åˆ æ‰é”™è¯¯çš„å‰¯æœ¬ã€‚</p>
<p>Checksumå¯¹è¯»æ“ä½œçš„æ€§èƒ½å½±å“å¾ˆå°ï¼Œå¯ä»¥åŸºäºå‡ ä¸ªåŸå› æ¥åˆ†æä¸€ä¸‹ã€‚å› ä¸ºå¤§éƒ¨åˆ†çš„è¯»æ“ä½œéƒ½è‡³å°‘è¦è¯»å–å‡ ä¸ªå—ï¼Œè€Œæˆ‘ä»¬åªéœ€è¦è¯»å–ä¸€å°éƒ¨åˆ†é¢å¤–çš„ç›¸ å…³æ•°æ®è¿›è¡Œæ ¡éªŒã€‚GFSå®¢æˆ·ç«¯ä»£ç é€šè¿‡æ¯æ¬¡æŠŠè¯»å–æ“ä½œéƒ½å¯¹é½åœ¨Checksum blockçš„è¾¹ç•Œä¸Šï¼Œè¿›ä¸€æ­¥å‡å°‘äº†è¿™äº›é¢å¤–çš„è¯»å–æ“ä½œçš„è´Ÿé¢å½±å“ã€‚å¦å¤–ï¼Œåœ¨ChunkæœåŠ¡å™¨ä¸Šï¼ŒChunksumçš„æŸ¥æ‰¾å’Œæ¯”è¾ƒä¸éœ€è¦I/Oæ“ ä½œï¼ŒChecksumçš„è®¡ç®—å¯ä»¥å’ŒI/Oæ“ä½œåŒæ—¶è¿›è¡Œã€‚</p>
<p>Checksumçš„è®¡ç®—é’ˆå¯¹åœ¨Chunkå°¾éƒ¨çš„è¿½åŠ å†™å…¥æ“ä½œä½œäº†é«˜åº¦ä¼˜åŒ–ï¼ˆä¸ä¹‹å¯¹åº”çš„æ˜¯è¦†ç›–ç°æœ‰æ•°æ®çš„å†™å…¥æ“ä½œï¼‰ï¼Œå› ä¸ºè¿™ç±»æ“ä½œåœ¨æˆ‘ä»¬çš„å·¥ä½œä¸­å äº† å¾ˆå¤§æ¯”ä¾‹ã€‚æˆ‘ä»¬åªå¢é‡æ›´æ–°æœ€åä¸€ä¸ªä¸å®Œæ•´çš„å—çš„Checksumï¼Œå¹¶ä¸”ç”¨æ‰€æœ‰çš„è¿½åŠ æ¥çš„æ–°Checksumå—æ¥è®¡ç®—æ–°çš„Checksumã€‚å³ä½¿æ˜¯æœ€åä¸€ä¸ª ä¸å®Œæ•´çš„Checksumå—å·²ç»æŸåäº†ï¼Œè€Œä¸”æˆ‘ä»¬ä¸èƒ½å¤Ÿé©¬ä¸Šæ£€æŸ¥å‡ºæ¥ï¼Œç”±äºæ–°çš„Checksumå’Œå·²æœ‰æ•°æ®ä¸å»åˆï¼Œåœ¨ä¸‹æ¬¡å¯¹è¿™ä¸ªå—è¿›è¡Œè¯»å–æ“ä½œçš„æ—¶å€™ï¼Œä¼š æ£€æŸ¥å‡ºæ•°æ®å·²ç»æŸåäº†ã€‚</p>
<p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¦‚æœå†™æ“ä½œè¦†ç›–å·²ç»å­˜åœ¨çš„ä¸€ä¸ªèŒƒå›´å†…çš„Chunkï¼Œæˆ‘ä»¬å¿…é¡»è¯»å–å’Œæ ¡éªŒè¢«è¦†ç›–çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå—ï¼Œç„¶åå†æ‰§è¡Œå†™æ“ä½œï¼›æ“ä½œå®Œæˆä¹‹åå†é‡ æ–°è®¡ç®—å’Œå†™å…¥æ–°çš„Checksumã€‚å¦‚æœæˆ‘ä»¬ä¸æ ¡éªŒç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªè¢«å†™çš„å—ï¼Œé‚£ä¹ˆæ–°çš„Checksumå¯èƒ½ä¼šéšè—æ²¡æœ‰è¢«è¦†ç›–åŒºåŸŸå†…çš„æ•°æ®é”™è¯¯ã€‚</p>
<p>åœ¨ChunkæœåŠ¡å™¨ç©ºé—²çš„æ—¶å€™ï¼Œå®ƒä¼šæ‰«æå’Œæ ¡éªŒæ¯ä¸ªä¸æ´»åŠ¨çš„Chunkçš„å†…å®¹ã€‚è¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿå‘ç°å¾ˆå°‘è¢«è¯»å–çš„Chunkæ˜¯å¦å®Œæ•´ã€‚ä¸€æ—¦å‘ç°æœ‰ Chunkçš„æ•°æ®æŸåï¼ŒMasterå¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ã€æ­£ç¡®çš„å‰¯æœ¬ï¼Œç„¶åæŠŠæŸåçš„å‰¯æœ¬åˆ é™¤æ‰ã€‚è¿™ä¸ªæœºåˆ¶ä¹Ÿé¿å…äº†éæ´»åŠ¨çš„ã€å·²æŸåçš„Chunkæ¬ºéª— MasterèŠ‚ç‚¹ï¼Œä½¿MasterèŠ‚ç‚¹è®¤ä¸ºå®ƒä»¬å·²ç»æœ‰äº†è¶³å¤Ÿå¤šçš„å‰¯æœ¬äº†ã€‚</p>
<h4 id="5-3-è¯Šæ–­å·¥å…·"><a href="#5-3-è¯Šæ–­å·¥å…·" class="headerlink" title="5.3 è¯Šæ–­å·¥å…·"></a>5.3 è¯Šæ–­å·¥å…·</h4><p>è¯¦å°½çš„ã€æ·±å…¥ç»†èŠ‚çš„è¯Šæ–­æ—¥å¿—ï¼Œåœ¨é—®é¢˜éš”ç¦»ã€è°ƒè¯•ã€ä»¥åŠæ€§èƒ½åˆ†æç­‰æ–¹é¢ç»™æˆ‘ä»¬å¸¦æ¥æ— æ³•ä¼°é‡çš„å¸®åŠ©ï¼ŒåŒæ—¶ä¹Ÿåªéœ€è¦å¾ˆå°çš„å¼€é”€ã€‚æ²¡æœ‰æ—¥å¿—çš„å¸®åŠ©ï¼Œæˆ‘ä»¬å¾ˆéš¾ ç†è§£çŸ­æš‚çš„ã€ä¸é‡å¤çš„æœºå™¨ä¹‹é—´çš„æ¶ˆæ¯äº¤äº’ã€‚GFSçš„æœåŠ¡å™¨ä¼šäº§ç”Ÿå¤§é‡çš„æ—¥å¿—ï¼Œè®°å½•äº†å¤§é‡å…³é”®çš„äº‹ä»¶ï¼ˆæ¯”å¦‚ï¼ŒChunkæœåŠ¡å™¨å¯åŠ¨å’Œå…³é—­ï¼‰ä»¥åŠæ‰€æœ‰çš„RPC çš„è¯·æ±‚å’Œå›å¤ã€‚è¿™äº›è¯Šæ–­æ—¥å¿—å¯ä»¥éšæ„åˆ é™¤ï¼Œå¯¹ç³»ç»Ÿçš„æ­£ç¡®è¿è¡Œä¸é€ æˆä»»ä½•å½±å“ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬åœ¨å­˜å‚¨ç©ºé—´å…è®¸çš„æƒ…å†µä¸‹ä¼šå°½é‡çš„ä¿å­˜è¿™äº›æ—¥å¿—ã€‚</p>
<p>RPCæ—¥å¿—åŒ…å«äº†ç½‘ç»œä¸Šå‘ç”Ÿçš„æ‰€æœ‰è¯·æ±‚å’Œå“åº”çš„è¯¦ç»†è®°å½•ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬è¯»å†™çš„æ–‡ä»¶æ•°æ®ã€‚é€šè¿‡åŒ¹é…è¯·æ±‚ä¸å›åº”ï¼Œä»¥åŠæ”¶é›†ä¸åŒæœºå™¨ä¸Šçš„RPCæ—¥å¿—è®°å½•ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ¼”æ‰€æœ‰çš„æ¶ˆæ¯äº¤äº’æ¥è¯Šæ–­é—®é¢˜ã€‚æ—¥å¿—è¿˜ç”¨æ¥è·Ÿè¸ªè´Ÿè½½æµ‹è¯•å’Œæ€§èƒ½åˆ†æã€‚</p>
<p>æ—¥å¿—å¯¹æ€§èƒ½çš„å½±å“å¾ˆå°ï¼ˆè¿œå°äºå®ƒå¸¦æ¥çš„å¥½å¤„ï¼‰ï¼Œå› ä¸ºè¿™äº›æ—¥å¿—çš„å†™å…¥æ–¹å¼æ˜¯é¡ºåºçš„ã€å¼‚æ­¥çš„ã€‚æœ€è¿‘å‘ç”Ÿçš„äº‹ä»¶æ—¥å¿—ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå¯ç”¨äºæŒç»­ä¸æ–­çš„åœ¨çº¿ç›‘æ§ã€‚</p>
<h3 id="6-åº¦é‡"><a href="#6-åº¦é‡" class="headerlink" title="6. åº¦é‡"></a>6. åº¦é‡</h3><p>æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€äº›å°è§„æ¨¡åŸºå‡†æµ‹è¯•æ¥å±•ç°GFSç³»ç»Ÿæ¶æ„å’Œå®ç°ä¸Šçš„ä¸€äº›å›ºæœ‰ç“¶é¢ˆï¼Œè¿˜æœ‰äº›æ¥è‡ªGoogleå†…éƒ¨ä½¿ç”¨çš„çœŸå®çš„GFSé›†ç¾¤çš„åŸºå‡†æ•°æ®ã€‚</p>
<h4 id="6-1-å°è§„æ¨¡åŸºå‡†æµ‹è¯•"><a href="#6-1-å°è§„æ¨¡åŸºå‡†æµ‹è¯•" class="headerlink" title="6.1 å°è§„æ¨¡åŸºå‡†æµ‹è¯•"></a>6.1 å°è§„æ¨¡åŸºå‡†æµ‹è¯•</h4><p>æˆ‘ä»¬åœ¨ä¸€ä¸ªåŒ…å«1å°MasteræœåŠ¡å™¨ï¼Œ2å°MasteræœåŠ¡å™¨å¤åˆ¶èŠ‚ç‚¹ï¼Œ16å°ChunkæœåŠ¡å™¨å’Œ16ä¸ªå®¢æˆ·æœºç»„æˆçš„GFSé›†ç¾¤ä¸Šæµ‹é‡æ€§èƒ½ã€‚æ³¨æ„ï¼Œé‡‡ç”¨è¿™æ ·çš„é›†ç¾¤é…ç½®æ–¹æ¡ˆåªæ˜¯ä¸ºäº†æ˜“äºæµ‹è¯•ã€‚å…¸å‹çš„GFSé›†ç¾¤æœ‰æ•°ç™¾ä¸ªChunkæœåŠ¡å™¨å’Œæ•°ç™¾ä¸ªå®¢æˆ·æœºã€‚</p>
<p>æ‰€æœ‰æœºå™¨çš„é…ç½®éƒ½ä¸€æ ·ï¼šä¸¤ä¸ªPIII 1.4GHzå¤„ç†å™¨ï¼Œ2GBå†…å­˜ï¼Œä¸¤ä¸ª80G/5400rpmçš„ç¡¬ç›˜ï¼Œä»¥åŠ100Mbpså…¨åŒå·¥ä»¥å¤ªç½‘è¿æ¥åˆ°ä¸€ä¸ªHP2524äº¤æ¢æœºã€‚GFSé›†ç¾¤ä¸­æ‰€æœ‰çš„ 19å°æœåŠ¡å™¨éƒ½è¿æ¥åœ¨ä¸€ä¸ªäº¤æ¢æœºï¼Œæ‰€æœ‰16å°å®¢æˆ·æœºè¿æ¥åˆ°å¦ä¸€ä¸ªäº¤æ¢æœºä¸Šã€‚ä¸¤ä¸ªäº¤æ¢æœºä¹‹é—´ä½¿ç”¨1Gbpsçš„çº¿è·¯è¿æ¥ã€‚</p>
<h5 id="6-1-1-è¯»å–"><a href="#6-1-1-è¯»å–" class="headerlink" title="6.1.1 è¯»å–"></a>6.1.1 è¯»å–</h5><p>Nä¸ªå®¢æˆ·æœºä»GFSæ–‡ä»¶ç³»ç»ŸåŒæ­¥è¯»å–æ•°æ®ã€‚æ¯ä¸ªå®¢æˆ·æœºä»320GBçš„æ–‡ä»¶é›†åˆä¸­éšæœºè¯»å–4MB regionçš„å†…å®¹ã€‚è¯»å–æ“ä½œé‡å¤æ‰§è¡Œ256æ¬¡ï¼Œå› æ­¤ï¼Œæ¯ä¸ªå®¢æˆ·æœºæœ€ç»ˆéƒ½è¯»å–1GBçš„æ•°æ®ã€‚æ‰€æœ‰çš„ChunkæœåŠ¡å™¨åŠ èµ·æ¥æ€»å…±åªæœ‰32GBçš„å†…å­˜ï¼Œå› æ­¤ï¼Œ æˆ‘ä»¬é¢„æœŸåªæœ‰æœ€å¤š10%çš„è¯»å–è¯·æ±‚å‘½ä¸­Linuxçš„æ–‡ä»¶ç³»ç»Ÿç¼“å†²ã€‚æˆ‘ä»¬çš„æµ‹è¯•ç»“æœåº”è¯¥å’Œä¸€ä¸ªåœ¨æ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿç¼“å­˜çš„æƒ…å†µä¸‹è¯»å–æµ‹è¯•çš„ç»“æœæ¥è¿‘ã€‚</p>
<p><img src="/images/GFS6-1-1.jpg"></p>
<p>å›¾ä¸‰ï¼šåˆè®¡ååé‡ï¼šä¸Šè¾¹çš„æ›²çº¿æ˜¾ç¤ºäº†æˆ‘ä»¬ç½‘ç»œæ‹“æ‰‘ä¸‹çš„åˆè®¡ç†è®ºååé‡ä¸Šé™ã€‚ä¸‹è¾¹çš„æ›²çº¿æ˜¾ç¤ºäº†è§‚æµ‹åˆ°çš„ååé‡ã€‚è¿™ä¸ªæ›²çº¿æœ‰ç€95%çš„å¯é æ€§ï¼Œå› ä¸ºæœ‰æ—¶å€™æµ‹é‡ä¼šä¸å¤Ÿç²¾ç¡®ã€‚</p>
<p>å›¾3ï¼ˆaï¼‰æ˜¾ç¤ºäº†Nä¸ªå®¢æˆ·æœºæ•´ä½“çš„è¯»å–é€Ÿåº¦ä»¥åŠè¿™ä¸ªé€Ÿåº¦çš„ç†è®ºæé™ã€‚å½“è¿æ¥ä¸¤ä¸ªäº¤æ¢æœºçš„1Gbpsçš„é“¾è·¯é¥±å’Œæ—¶ï¼Œæ•´ä½“è¯»å–é€Ÿåº¦è¾¾åˆ°ç†è®ºçš„æé™å€¼ æ˜¯125MB/Sï¼Œæˆ–è€…è¯´æ¯ä¸ªå®¢æˆ·æœºé…ç½®çš„100Mbpsç½‘å¡è¾¾åˆ°é¥±å’Œæ—¶ï¼Œæ¯ä¸ªå®¢æˆ·æœºè¯»å–é€Ÿåº¦çš„ç†è®ºæé™å€¼æ˜¯12.5MB/sã€‚å®æµ‹ç»“æœæ˜¯ï¼Œå½“ä¸€ä¸ªå®¢æˆ·æœº è¯»å–çš„æ—¶å€™ï¼Œè¯»å–çš„é€Ÿåº¦æ˜¯10MB/sï¼Œä¹Ÿå°±æ˜¯è¯´è¾¾åˆ°å®¢æˆ·æœºç†è®ºè¯»å–é€Ÿåº¦æé™å€¼çš„80%ã€‚å¯¹äº16ä¸ªå®¢æˆ·æœºï¼Œæ•´ä½“çš„è¯»å–é€Ÿåº¦è¾¾åˆ°äº†94MB/sï¼Œå¤§çº¦æ˜¯ç† è®ºæ•´ä½“è¯»å–é€Ÿåº¦æé™å€¼çš„75%ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªå®¢æˆ·æœºçš„è¯»å–é€Ÿåº¦æ˜¯6MB/sã€‚è¯»å–æ•ˆç‡ä»80%é™ä½åˆ°äº†75%ï¼Œä¸»è¦çš„åŸå› æ˜¯å½“è¯»å–çš„å®¢æˆ·æœºå¢åŠ æ—¶ï¼Œå¤šä¸ªå®¢ æˆ·æœºåŒæ—¶è¯»å–ä¸€ä¸ªChunkæœåŠ¡å™¨çš„å‡ ç‡ä¹Ÿå¢åŠ äº†ï¼Œå¯¼è‡´æ•´ä½“çš„è¯»å–æ•ˆç‡ä¸‹é™ã€‚</p>
<h5 id="6-1-2-å†™å…¥"><a href="#6-1-2-å†™å…¥" class="headerlink" title="6.1.2 å†™å…¥"></a>6.1.2 å†™å…¥</h5><p>Nä¸ªå®¢æˆ·æœºåŒæ—¶å‘Nä¸ªä¸åŒçš„æ–‡ä»¶ä¸­å†™å…¥æ•°æ®ã€‚æ¯ä¸ªå®¢æˆ·æœºä»¥æ¯æ¬¡1MBçš„é€Ÿåº¦è¿ç»­å†™å…¥1GBçš„æ•°æ®ã€‚å›¾3ï¼ˆbï¼‰æ˜¾ç¤ºäº†æ•´ä½“çš„å†™å…¥é€Ÿåº¦å’Œå®ƒä»¬ç†è®ºä¸Š çš„æé™å€¼ã€‚ç†è®ºä¸Šçš„æé™å€¼æ˜¯67MB/sï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦æŠŠæ¯ä¸€byteå†™å…¥åˆ°16ä¸ªChunkæœåŠ¡å™¨ä¸­çš„3ä¸ªä¸Šï¼Œè€Œæ¯ä¸ªChunkæœåŠ¡å™¨çš„è¾“å…¥è¿æ¥é€Ÿåº¦æ˜¯ 12.5MB/sã€‚</p>
<p>ä¸€ä¸ªå®¢æˆ·æœºçš„å†™å…¥é€Ÿåº¦æ˜¯6.3MBï¼Œå¤§æ¦‚æ˜¯ç†è®ºæé™å€¼çš„ä¸€åŠã€‚å¯¼è‡´è¿™ä¸ªç»“æœçš„ä¸»è¦åŸå› æ˜¯æˆ‘ä»¬çš„ç½‘ç»œåè®®æ ˆã€‚å®ƒä¸æˆ‘ä»¬æ¨é€æ•°æ®åˆ°ChunkæœåŠ¡å™¨æ—¶é‡‡ç”¨çš„ç®¡é“æ¨¡å¼ä¸ç›¸é€‚åº”ã€‚ä»ä¸€ä¸ªå‰¯æœ¬åˆ°å¦ä¸€ä¸ªå‰¯æœ¬çš„æ•°æ®ä¼ è¾“å»¶è¿Ÿé™ä½äº†æ•´ä¸ªçš„å†™å…¥é€Ÿåº¦ã€‚</p>
<p>16ä¸ªå®¢æˆ·æœºæ•´ä½“çš„å†™å…¥é€Ÿåº¦è¾¾åˆ°äº†35MB/sï¼ˆå³æ¯ä¸ªå®¢æˆ·æœº2.2MB/sï¼‰ï¼Œå¤§çº¦åªæ˜¯ç†è®ºæé™å€¼çš„ä¸€åŠã€‚å’Œå¤šä¸ªå®¢æˆ·æœºè¯»å–çš„æƒ…å½¢å¾ˆç±»å‹ï¼Œéš ç€å®¢æˆ·æœºæ•°é‡çš„å¢åŠ ï¼Œå¤šä¸ªå®¢æˆ·æœºåŒæ—¶å†™å…¥åŒä¸€ä¸ªChunkæœåŠ¡å™¨çš„å‡ ç‡ä¹Ÿå¢åŠ äº†ã€‚è€Œä¸”ï¼Œ16ä¸ªå®¢æˆ·æœºå¹¶è¡Œå†™å…¥å¯èƒ½å¼•èµ·çš„å†²çªæ¯”16ä¸ªå®¢æˆ·æœºå¹¶è¡Œè¯»å–è¦å¤§å¾— å¤šï¼Œå› ä¸ºæ¯ä¸ªå†™å…¥éƒ½ä¼šæ¶‰åŠä¸‰ä¸ªä¸åŒçš„å‰¯æœ¬ã€‚</p>
<p>å†™å…¥çš„é€Ÿåº¦æ¯”æˆ‘ä»¬æƒ³è±¡çš„è¦æ…¢ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™æ²¡æœ‰æˆä¸ºæˆ‘ä»¬çš„ä¸»è¦é—®é¢˜ï¼Œå› ä¸ºå³ä½¿åœ¨å•ä¸ªå®¢æˆ·æœºä¸Šèƒ½å¤Ÿæ„Ÿå—åˆ°å»¶æ—¶ï¼Œå®ƒä¹Ÿä¸ä¼šåœ¨æœ‰å¤§é‡å®¢æˆ·æœºçš„æ—¶å€™å¯¹æ•´ä½“çš„å†™å…¥å¸¦å®½é€ æˆæ˜¾è‘—çš„å½±å“ã€‚</p>
<h5 id="6-1-3-è®°å½•è¿½åŠ "><a href="#6-1-3-è®°å½•è¿½åŠ " class="headerlink" title="6.1.3 è®°å½•è¿½åŠ "></a>6.1.3 è®°å½•è¿½åŠ </h5><p>å›¾3ï¼ˆcï¼‰æ˜¾ç¤ºäº†è®°å½•è¿½åŠ æ“ä½œçš„æ€§èƒ½ã€‚Nä¸ªå®¢æˆ·æœºåŒæ—¶è¿½åŠ æ•°æ®åˆ°ä¸€ä¸ªæ–‡ä»¶ã€‚è®°å½•è¿½åŠ æ“ä½œçš„æ€§èƒ½å—é™äºä¿å­˜æ–‡ä»¶æœ€åä¸€ä¸ªChunkçš„ChunkæœåŠ¡å™¨ çš„å¸¦å®½ï¼Œè€Œä¸å®¢æˆ·æœºçš„æ•°é‡æ— å…³ã€‚è®°å½•è¿½åŠ çš„é€Ÿåº¦ç”±ä¸€ä¸ªå®¢æˆ·æœºçš„6.0MB/så¼€å§‹ï¼Œä¸‹é™åˆ°16ä¸ªå®¢æˆ·æœºçš„4.8MB/sä¸ºæ­¢ï¼Œé€Ÿåº¦çš„ä¸‹é™ä¸»è¦æ˜¯ç”±äºä¸åŒå®¢ æˆ·ç«¯çš„ç½‘ç»œæ‹¥å¡ä»¥åŠç½‘ç»œä¼ è¾“é€Ÿåº¦çš„ä¸åŒè€Œå¯¼è‡´çš„ã€‚</p>
<p>æˆ‘ä»¬çš„ç¨‹åºå€¾å‘äºåŒæ—¶å¤„ç†å¤šä¸ªè¿™æ ·çš„æ–‡ä»¶ã€‚æ¢å¥è¯è¯´ï¼Œå³Nä¸ªå®¢æˆ·æœºåŒæ—¶è¿½åŠ æ•°æ®åˆ°Mä¸ªå…±äº«æ–‡ä»¶ä¸­ï¼Œè¿™é‡ŒNå’ŒMéƒ½æ˜¯æ•°åæˆ–è€…æ•°ç™¾ä»¥ä¸Šã€‚æ‰€ä»¥ï¼Œåœ¨æˆ‘ä»¬çš„ å®é™…åº”ç”¨ä¸­ï¼ŒChunkæœåŠ¡å™¨çš„ç½‘ç»œæ‹¥å¡å¹¶æ²¡æœ‰æˆä¸ºä¸€ä¸ªä¸¥é‡é—®é¢˜ï¼Œå¦‚æœChunkæœåŠ¡å™¨çš„æŸä¸ªæ–‡ä»¶æ­£åœ¨å†™å…¥ï¼Œå®¢æˆ·æœºä¼šå»å†™å¦å¤–ä¸€ä¸ªæ–‡ä»¶ã€‚</p>
<h4 id="6-2-å®é™…åº”ç”¨ä¸­çš„é›†ç¾¤"><a href="#6-2-å®é™…åº”ç”¨ä¸­çš„é›†ç¾¤" class="headerlink" title="6.2 å®é™…åº”ç”¨ä¸­çš„é›†ç¾¤"></a>6.2 å®é™…åº”ç”¨ä¸­çš„é›†ç¾¤</h4><p>æˆ‘ä»¬ç°åœ¨æ¥ä»”ç»†è¯„ä¼°ä¸€ä¸‹Googleå†…éƒ¨æ­£åœ¨ä½¿ç”¨çš„ä¸¤ä¸ªé›†ç¾¤ï¼Œå®ƒä»¬å…·æœ‰ä¸€å®šçš„ä»£è¡¨æ€§ã€‚é›†ç¾¤Aé€šå¸¸è¢«ä¸Šç™¾ä¸ªå·¥ç¨‹å¸ˆç”¨äºç ”ç©¶å’Œå¼€å‘ã€‚å…¸å‹çš„ä»»åŠ¡æ˜¯è¢« äººå·¥åˆå§‹åŒ–åè¿ç»­è¿è¡Œæ•°ä¸ªå°æ—¶ã€‚å®ƒé€šå¸¸è¯»å–æ•°MBåˆ°æ•°TBçš„æ•°æ®ï¼Œä¹‹åè¿›è¡Œè½¬åŒ–æˆ–è€…åˆ†æï¼Œæœ€åæŠŠç»“æœå†™å›åˆ°é›†ç¾¤ä¸­ã€‚é›†ç¾¤Bä¸»è¦ç”¨äºå¤„ç†å½“å‰çš„ç”Ÿäº§æ•°æ®ã€‚é›† ç¾¤Bçš„ä»»åŠ¡æŒç»­çš„æ—¶é—´æ›´é•¿ï¼Œåœ¨å¾ˆå°‘äººå·¥å¹²é¢„çš„æƒ…å†µä¸‹ï¼ŒæŒç»­çš„ç”Ÿæˆå’Œå¤„ç†æ•°TBçš„æ•°æ®é›†ã€‚åœ¨è¿™ä¸¤ä¸ªæ¡ˆä¾‹ä¸­ï¼Œä¸€ä¸ªå•ç‹¬çš„â€ä»»åŠ¡â€éƒ½æ˜¯æŒ‡è¿è¡Œåœ¨å¤šä¸ªæœºå™¨ä¸Šçš„å¤šä¸ª è¿›ç¨‹ï¼Œå®ƒä»¬åŒæ—¶è¯»å–å’Œå†™å…¥å¤šä¸ªæ–‡ä»¶ã€‚</p>
<p><img src="/images/GFS6-2.jpg"></p>
<h5 id="6-2-1-å­˜å‚¨"><a href="#6-2-1-å­˜å‚¨" class="headerlink" title="6.2.1 å­˜å‚¨"></a>6.2.1 å­˜å‚¨</h5><p>å¦‚ä¸Šè¡¨å‰äº”è¡Œæ‰€æè¿°çš„ï¼Œä¸¤ä¸ªé›†ç¾¤éƒ½ç”±ä¸Šç™¾å°ChunkæœåŠ¡å™¨ç»„æˆï¼Œæ”¯æŒæ•°TBçš„ç¡¬ç›˜ç©ºé—´ï¼›ä¸¤ä¸ªé›†ç¾¤è™½ç„¶éƒ½å­˜å‚¨äº†å¤§é‡çš„æ•°æ®ï¼Œä½†æ˜¯è¿˜æœ‰å‰©ä½™çš„ç©ºé—´ã€‚ â€œå·²ç”¨ç©ºé—´â€åŒ…å«äº†æ‰€æœ‰çš„Chunkå‰¯æœ¬ã€‚å®é™…ä¸Šæ‰€æœ‰çš„æ–‡ä»¶éƒ½å¤åˆ¶äº†ä¸‰ä»½ã€‚å› æ­¤ï¼Œé›†ç¾¤å®é™…ä¸Šå„å­˜å‚¨äº†18TBå’Œ52TBçš„æ–‡ä»¶æ•°æ®ã€‚</p>
<p>ä¸¤ä¸ªé›†ç¾¤å­˜å‚¨çš„æ–‡ä»¶æ•°é‡éƒ½å·®ä¸å¤šï¼Œä½†æ˜¯é›†ç¾¤Bä¸Šæœ‰å¤§é‡çš„æ­»æ–‡ä»¶ã€‚æ‰€è°“â€œæ­»æ–‡ä»¶â€æ˜¯æŒ‡æ–‡ä»¶è¢«åˆ é™¤äº†æˆ–è€…æ˜¯è¢«æ–°ç‰ˆæœ¬çš„æ–‡ä»¶æ›¿æ¢äº†ï¼Œä½†æ˜¯å­˜å‚¨ç©ºé—´è¿˜æ²¡æœ‰æ¥å¾—åŠè¢«å›æ”¶ã€‚ç”±äºé›†ç¾¤Bå­˜å‚¨çš„æ–‡ä»¶è¾ƒå¤§ï¼Œå› æ­¤å®ƒçš„Chunkæ•°é‡ä¹Ÿæ¯”è¾ƒå¤šã€‚</p>
<h5 id="6-2-2-å…ƒæ•°æ®"><a href="#6-2-2-å…ƒæ•°æ®" class="headerlink" title="6.2.2 å…ƒæ•°æ®"></a>6.2.2 å…ƒæ•°æ®</h5><p>ChunkæœåŠ¡å™¨æ€»å…±ä¿å­˜äº†åå‡ GBçš„å…ƒæ•°æ®ï¼Œå¤§å¤šæ•°æ˜¯æ¥è‡ªç”¨æˆ·æ•°æ®çš„ã€64KBå¤§å°çš„å—çš„Checksumã€‚ä¿å­˜åœ¨ChunkæœåŠ¡å™¨ä¸Šå…¶å®ƒçš„å…ƒæ•°æ®æ˜¯Chunkçš„ç‰ˆæœ¬å·ä¿¡æ¯ï¼Œæˆ‘ä»¬åœ¨4.5èŠ‚æè¿°è¿‡ã€‚</p>
<p>åœ¨MasteræœåŠ¡å™¨ä¸Šä¿å­˜çš„å…ƒæ•°æ®å°±å°çš„å¤šäº†ï¼Œå¤§çº¦åªæœ‰æ•°åMBï¼Œæˆ–è€…è¯´å¹³å‡æ¯ä¸ªæ–‡ä»¶100å­—èŠ‚çš„å…ƒæ•°æ®ã€‚è¿™å’Œæˆ‘ä»¬è®¾æƒ³çš„æ˜¯ä¸€æ ·çš„ï¼ŒMaster æœåŠ¡å™¨çš„å†…å­˜å¤§å°åœ¨å®é™…åº”ç”¨ä¸­å¹¶ä¸ä¼šæˆä¸ºGFSç³»ç»Ÿå®¹é‡çš„ç“¶é¢ˆã€‚å¤§å¤šæ•°æ–‡ä»¶çš„å…ƒæ•°æ®éƒ½æ˜¯ä»¥å‰ç¼€å‹ç¼©æ¨¡å¼å­˜æ”¾çš„æ–‡ä»¶åã€‚MasteræœåŠ¡å™¨ä¸Šå­˜æ”¾çš„å…¶å®ƒå…ƒæ•° æ®åŒ…æ‹¬äº†æ–‡ä»¶çš„æ‰€æœ‰è€…å’Œæƒé™ã€æ–‡ä»¶åˆ°Chunkçš„æ˜ å°„å…³ç³»ï¼Œä»¥åŠæ¯ä¸€ä¸ªChunkçš„å½“å‰ç‰ˆæœ¬å·ã€‚æ­¤å¤–ï¼Œé’ˆå¯¹æ¯ä¸€ä¸ªChunkï¼Œæˆ‘ä»¬éƒ½ä¿å­˜äº†å½“å‰çš„å‰¯æœ¬ä½ç½® ä»¥åŠå¯¹å®ƒçš„å¼•ç”¨è®¡æ•°ï¼Œè¿™ä¸ªå¼•ç”¨è®¡æ•°ç”¨äºå®ç°å†™æ—¶æ‹·è´<strong>ï¼ˆalexæ³¨ï¼šå³COWï¼Œcopy-on-writeï¼‰ã€‚</strong></p>
<p>å¯¹äºæ¯ä¸€ä¸ªå•ç‹¬çš„æœåŠ¡å™¨ï¼Œæ— è®ºæ˜¯ChunkæœåŠ¡å™¨è¿˜æ˜¯MasteræœåŠ¡å™¨ï¼Œéƒ½åªä¿å­˜äº†50MBåˆ°100MBçš„å…ƒæ•°æ®ã€‚å› æ­¤ï¼Œæ¢å¤æœåŠ¡å™¨æ˜¯éå¸¸å¿«é€Ÿ çš„ï¼šåœ¨æœåŠ¡å™¨å“åº”å®¢æˆ·è¯·æ±‚ä¹‹å‰ï¼Œåªéœ€è¦èŠ±å‡ ç§’é’Ÿæ—¶é—´ä»ç£ç›˜ä¸Šè¯»å–è¿™äº›æ•°æ®å°±å¯ä»¥äº†ã€‚ä¸è¿‡ï¼ŒMasteræœåŠ¡å™¨ä¼šæŒç»­é¢ ç°¸ä¸€æ®µæ—¶é—´â€“é€šå¸¸æ˜¯30åˆ°60ç§’â€“ç›´ åˆ°å®ƒå®Œæˆè½®è¯¢æ‰€æœ‰çš„ChunkæœåŠ¡å™¨ï¼Œå¹¶è·å–åˆ°æ‰€æœ‰Chunkçš„ä½ç½®ä¿¡æ¯ã€‚</p>
<h5 id="6-2-3-è¯»å†™é€Ÿç‡"><a href="#6-2-3-è¯»å†™é€Ÿç‡" class="headerlink" title="6.2.3 è¯»å†™é€Ÿç‡"></a>6.2.3 è¯»å†™é€Ÿç‡</h5><p><img src="/images/GFS6-2-3.jpg"> </p>
<p>è¡¨ä¸‰æ˜¾ç¤ºäº†ä¸åŒæ—¶æ®µçš„è¯»å†™é€Ÿç‡ã€‚åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œè¿™ä¸¤ä¸ªé›†ç¾¤éƒ½è¿è¡Œäº†ä¸€å‘¨å·¦å³çš„æ—¶é—´ã€‚ï¼ˆè¿™ä¸¤ä¸ªé›†ç¾¤æœ€è¿‘éƒ½å› ä¸ºå‡çº§æ–°ç‰ˆæœ¬çš„GFSé‡æ–°å¯åŠ¨è¿‡äº†ï¼‰ã€‚</p>
<p>é›†ç¾¤é‡æ–°å¯åŠ¨åï¼Œå¹³å‡å†™å…¥é€Ÿç‡å°äº30MB/sã€‚å½“æˆ‘ä»¬æå–æ€§èƒ½æ•°æ®çš„æ—¶å€™ï¼Œé›†ç¾¤Bæ­£è¿›è¡Œå¤§é‡çš„å†™å…¥æ“ä½œï¼Œå†™å…¥é€Ÿåº¦è¾¾åˆ°äº†100MB/sï¼Œå¹¶ä¸”å› ä¸ºæ¯ä¸ªChunkéƒ½æœ‰ä¸‰ä¸ªå‰¯æœ¬çš„åŸå› ï¼Œç½‘ç»œè´Ÿè½½è¾¾åˆ°äº†300MB/sã€‚<br>è¯»å–é€Ÿç‡è¦æ¯”å†™å…¥é€Ÿç‡é«˜çš„å¤šã€‚æ­£å¦‚æˆ‘ä»¬è®¾æƒ³çš„é‚£æ ·ï¼Œæ€»çš„å·¥ä½œè´Ÿè½½ä¸­ï¼Œè¯»å–çš„æ¯”ä¾‹è¿œè¿œé«˜äºå†™å…¥çš„æ¯”ä¾‹ã€‚ä¸¤ä¸ªé›†ç¾¤éƒ½è¿›è¡Œç€ç¹é‡çš„è¯»å–æ“ä½œã€‚ç‰¹åˆ«æ˜¯ï¼Œ é›†ç¾¤Aåœ¨ä¸€å‘¨æ—¶é—´å†…éƒ½ç»´æŒäº†580MB/sçš„è¯»å–é€Ÿåº¦ã€‚é›†ç¾¤Açš„ç½‘ç»œé…ç½®å¯ä»¥æ”¯æŒ750MB/sçš„é€Ÿåº¦ï¼Œæ˜¾ç„¶ï¼Œå®ƒæœ‰æ•ˆçš„åˆ©ç”¨äº†èµ„æºã€‚é›†ç¾¤Bæ”¯æŒçš„å³°å€¼è¯»å– é€Ÿåº¦æ˜¯1300MB/sï¼Œä½†æ˜¯å®ƒçš„åº”ç”¨åªç”¨åˆ°äº†380MB/sã€‚ </p>
<h5 id="6-2-4-MasteræœåŠ¡å™¨çš„è´Ÿè½½"><a href="#6-2-4-MasteræœåŠ¡å™¨çš„è´Ÿè½½" class="headerlink" title="6.2.4 MasteræœåŠ¡å™¨çš„è´Ÿè½½"></a>6.2.4 MasteræœåŠ¡å™¨çš„è´Ÿè½½</h5><p>è¡¨3çš„æ•°æ®æ˜¾ç¤ºäº†å‘é€åˆ°MasteræœåŠ¡å™¨çš„æ“ä½œè¯·æ±‚å¤§æ¦‚æ˜¯æ¯ç§’é’Ÿ200åˆ°500ä¸ªã€‚MasteræœåŠ¡å™¨å¯ä»¥è½»æ¾çš„åº”ä»˜è¿™ä¸ªè¯·æ±‚é€Ÿåº¦ï¼Œæ‰€ä»¥MasteræœåŠ¡å™¨çš„å¤„ç†èƒ½åŠ›ä¸æ˜¯ç³»ç»Ÿçš„ç“¶é¢ˆã€‚</p>
<p>åœ¨æ—©æœŸç‰ˆæœ¬çš„GFSä¸­ï¼ŒMasteræœåŠ¡å™¨å¶å°”ä¼šæˆä¸ºç“¶é¢ˆã€‚å®ƒå¤§å¤šæ•°æ—¶é—´é‡Œéƒ½åœ¨é¡ºåºæ‰«ææŸä¸ªå¾ˆå¤§çš„ç›®å½•ï¼ˆåŒ…å«æ•°ä¸‡ä¸ªæ–‡ä»¶ï¼‰å»æŸ¥æ‰¾æŸä¸ªç‰¹å®šçš„æ–‡ ä»¶ã€‚å› æ­¤æˆ‘ä»¬ä¿®æ”¹äº†MasteræœåŠ¡å™¨çš„æ•°æ®ç»“æ„ï¼Œé€šè¿‡å¯¹åå­—ç©ºé—´è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾æ¥æé«˜æ•ˆç‡ã€‚ç°åœ¨MasteræœåŠ¡å™¨å¯ä»¥è½»æ¾çš„æ¯ç§’é’Ÿè¿›è¡Œæ•°åƒæ¬¡æ–‡ä»¶è®¿é—®ã€‚ å¦‚æœæœ‰éœ€è¦çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨åç§°ç©ºé—´æ•°æ®ç»“æ„ä¹‹å‰è®¾ç½®åç§°æŸ¥è¯¢ç¼“å†²çš„æ–¹å¼è¿›ä¸€æ­¥æé«˜é€Ÿåº¦ã€‚</p>
<h5 id="6-2-5-æ¢å¤æ—¶é—´"><a href="#6-2-5-æ¢å¤æ—¶é—´" class="headerlink" title="6.2.5 æ¢å¤æ—¶é—´"></a>6.2.5 æ¢å¤æ—¶é—´</h5><p>å½“æŸä¸ªChunkæœåŠ¡å™¨å¤±æ•ˆäº†ï¼Œä¸€äº›Chunkå‰¯æœ¬çš„æ•°é‡å¯èƒ½ä¼šä½äºå¤åˆ¶å› å­æŒ‡å®šçš„æ•°é‡ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡å…‹éš†å‰¯æœ¬ä½¿Chunkå‰¯æœ¬æ•°é‡è¾¾åˆ°å¤åˆ¶å›  å­æŒ‡å®šçš„æ•°é‡ã€‚æ¢å¤æ‰€æœ‰Chunkå‰¯æœ¬æ‰€èŠ±è´¹çš„æ—¶é—´å–å†³äºèµ„æºçš„æ•°é‡ã€‚åœ¨æˆ‘ä»¬çš„è¯•éªŒä¸­ï¼Œæˆ‘ä»¬æŠŠé›†ç¾¤Bä¸Šçš„ä¸€ä¸ªChunkæœåŠ¡å™¨Killæ‰ã€‚è¿™ä¸ªChunk æœåŠ¡å™¨ä¸Šå¤§çº¦æœ‰15000ä¸ªChunkï¼Œå…±è®¡600GBçš„æ•°æ®ã€‚ä¸ºäº†å‡å°å…‹éš†æ“ä½œå¯¹æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºçš„å½±å“ï¼Œä»¥åŠä¸ºGFSè°ƒåº¦å†³ç­–æä¾›ä¿®æ­£ç©ºé—´ï¼Œæˆ‘ä»¬ç¼º çœçš„æŠŠé›†ç¾¤ä¸­å¹¶å‘å…‹éš†æ“ä½œçš„æ•°é‡è®¾ç½®ä¸º91ä¸ªï¼ˆChunkæœåŠ¡å™¨çš„æ•°é‡çš„40%ï¼‰ï¼Œæ¯ä¸ªå…‹éš†æ“ä½œæœ€å¤šå…è®¸ä½¿ç”¨çš„å¸¦å®½æ˜¯6.25MB/sï¼ˆ50mbpsï¼‰ã€‚ æ‰€æœ‰çš„Chunkåœ¨23.2åˆ†é’Ÿå†…æ¢å¤äº†ï¼Œå¤åˆ¶çš„é€Ÿåº¦é«˜è¾¾440MB/sã€‚</p>
<p>åœ¨å¦å¤–ä¸€ä¸ªæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬Killæ‰äº†ä¸¤ä¸ªChunkæœåŠ¡å™¨ï¼Œæ¯ä¸ªChunkæœåŠ¡å™¨å¤§çº¦æœ‰16000ä¸ªChunkï¼Œå…±è®¡660GBçš„æ•°æ®ã€‚è¿™ä¸¤ä¸ª æ•…éšœå¯¼è‡´äº†266ä¸ªChunkåªæœ‰å•ä¸ªå‰¯æœ¬ã€‚è¿™266ä¸ªChunkè¢«GFSä¼˜å…ˆè°ƒåº¦è¿›è¡Œå¤åˆ¶ï¼Œåœ¨2åˆ†é’Ÿå†…æ¢å¤åˆ°è‡³å°‘æœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼›ç°åœ¨é›†ç¾¤è¢«å¸¦å…¥åˆ°å¦å¤–ä¸€ä¸ª çŠ¶æ€ï¼Œåœ¨è¿™ä¸ªçŠ¶æ€ä¸‹ï¼Œç³»ç»Ÿå¯ä»¥å®¹å¿å¦å¤–ä¸€ä¸ªChunkæœåŠ¡å™¨å¤±æ•ˆè€Œä¸ä¸¢å¤±æ•°æ®ã€‚</p>
<h4 id="6-3-å·¥ä½œè´Ÿè·åˆ†æ-Workload-Breakdown"><a href="#6-3-å·¥ä½œè´Ÿè·åˆ†æ-Workload-Breakdown" class="headerlink" title="6.3 å·¥ä½œè´Ÿè·åˆ†æ(Workload Breakdown)"></a>6.3 å·¥ä½œè´Ÿè·åˆ†æ(Workload Breakdown)</h4><p>æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¯¹ä¸¤ä¸ªGFSé›†ç¾¤å·¥ä½œè´Ÿè½½æƒ…å†µçš„è¯¦ç»†åˆ†æï¼Œè¿™ä¸¤ä¸ªé›†ç¾¤å’Œ6.2èŠ‚ä¸­çš„ç±»ä¼¼ï¼Œä½†æ˜¯ä¸å®Œå…¨ç›¸åŒã€‚é›†ç¾¤Xç”¨äºç ”ç©¶å’Œå¼€å‘ï¼Œé›†ç¾¤Yç”¨äºç”Ÿäº§æ•°æ®å¤„ç†ã€‚ </p>
<h5 id="6-3-1-æ–¹æ³•è®ºå’Œæ³¨æ„äº‹é¡¹"><a href="#6-3-1-æ–¹æ³•è®ºå’Œæ³¨æ„äº‹é¡¹" class="headerlink" title="6.3.1 æ–¹æ³•è®ºå’Œæ³¨æ„äº‹é¡¹"></a>6.3.1 æ–¹æ³•è®ºå’Œæ³¨æ„äº‹é¡¹</h5><p>æœ¬ç« èŠ‚åˆ—å‡ºçš„è¿™äº›ç»“æœæ•°æ®åªåŒ…æ‹¬å®¢æˆ·æœºå‘èµ·çš„åŸå§‹è¯·æ±‚ï¼Œå› æ­¤ï¼Œè¿™äº›ç»“æœèƒ½å¤Ÿåæ˜ æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¯¹GFSæ–‡ä»¶ç³»ç»Ÿäº§ç”Ÿçš„å…¨éƒ¨å·¥ä½œè´Ÿè½½ã€‚å®ƒä»¬ä¸åŒ…å« é‚£äº›ä¸ºäº†å®ç°å®¢æˆ·ç«¯è¯·æ±‚è€Œåœ¨æœåŠ¡å™¨é—´äº¤äº’çš„è¯·æ±‚ï¼Œä¹Ÿä¸åŒ…å«GFSå†…éƒ¨çš„åå°æ´»åŠ¨ç›¸å…³çš„è¯·æ±‚ï¼Œæ¯”å¦‚å‰å‘è½¬å‘çš„å†™æ“ä½œï¼Œæˆ–è€…é‡æ–°è´Ÿè½½å‡è¡¡ç­‰æ“ä½œã€‚</p>
<p>æˆ‘ä»¬ä»GFSæœåŠ¡å™¨è®°å½•çš„çœŸå®çš„RPCè¯·æ±‚æ—¥å¿—ä¸­æ¨å¯¼é‡å»ºå‡ºå…³äºIOæ“ä½œçš„ç»Ÿè®¡ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼ŒGFSå®¢æˆ·ç¨‹åºå¯èƒ½ä¼šæŠŠä¸€ä¸ªè¯»æ“ä½œåˆ†æˆå‡ ä¸ªRPCè¯· æ±‚æ¥æé«˜å¹¶è¡Œåº¦ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº›RPCè¯·æ±‚æ¨å¯¼å‡ºåŸå§‹çš„è¯»æ“ä½œã€‚å› ä¸ºæˆ‘ä»¬çš„è®¿é—®æ¨¡å¼æ˜¯é«˜åº¦ç¨‹å¼åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¤ä¸ºä»»ä½•ä¸ç¬¦åˆçš„æ•°æ®éƒ½æ˜¯è¯¯å·®<strong> (alexæ³¨ï¼šSince our access patterns are highly stylized, we expect any error to be in the noise)</strong>ã€‚åº”ç”¨ç¨‹åºå¦‚æœèƒ½å¤Ÿè®°å½•æ›´è¯¦å°½çš„æ—¥å¿—ï¼Œå°±æœ‰å¯èƒ½æä¾›æ›´å‡†ç¡®çš„è¯Šæ–­æ•°æ®ï¼›ä½†æ˜¯ä¸ºäº†è¿™ä¸ªç›®çš„å»é‡æ–°ç¼–è¯‘å’Œé‡æ–°å¯åŠ¨æ•°åƒä¸ªæ­£åœ¨è¿è¡Œçš„å®¢æˆ·æœºæ˜¯ä¸ç°å®çš„ï¼Œè€Œä¸”ä»é‚£ä¹ˆå¤šå®¢æˆ·æœºä¸Šæ”¶é›†ç»“æœä¹Ÿæ˜¯ä¸ªç¹é‡çš„å·¥ä½œã€‚</p>
<p>åº”è¯¥é¿å…ä»æˆ‘ä»¬çš„å·¥ä½œè´Ÿè·æ•°æ®ä¸­è¿‡åº¦çš„å½’çº³å‡ºæ™®éçš„ç»“è®º<strong> (alexæ³¨ï¼šå³ä¸è¦æŠŠæœ¬èŠ‚çš„æ•°æ®ä½œä¸ºåŸºç¡€çš„æŒ‡å¯¼æ€§æ•°æ®)</strong>ã€‚å› ä¸ºGoogleå®Œå…¨æ§åˆ¶ç€GFSå’Œä½¿ç”¨GFSçš„åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥ï¼Œåº”ç”¨ç¨‹åºéƒ½é’ˆå¯¹GFSåšäº†ä¼˜åŒ–ï¼ŒåŒæ—¶ï¼ŒGFSä¹Ÿæ˜¯ä¸ºäº†è¿™äº›åº”ç”¨ç¨‹åºè€Œè®¾è®¡çš„ã€‚è¿™æ ·çš„ç›¸äº’ä½œç”¨ä¹Ÿå¯èƒ½å­˜åœ¨äºä¸€èˆ¬ç¨‹åºå’Œæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­è¿™æ ·çš„ä½œç”¨å½±å“å¯èƒ½æ›´æ˜¾è‘—ã€‚</p>
<h5 id="6-3-2-ChunkæœåŠ¡å™¨å·¥ä½œè´Ÿè·"><a href="#6-3-2-ChunkæœåŠ¡å™¨å·¥ä½œè´Ÿè·" class="headerlink" title="6.3.2 ChunkæœåŠ¡å™¨å·¥ä½œè´Ÿè·"></a>6.3.2 ChunkæœåŠ¡å™¨å·¥ä½œè´Ÿè·</h5><p><img src="/images/GFS6-3-2.jpg"></p>
<p>è¡¨4æ˜¾ç¤ºäº†æ“ä½œæŒ‰æ¶‰åŠçš„æ•°æ®é‡å¤§å°çš„åˆ†å¸ƒæƒ…å†µã€‚è¯»å–æ“ä½œæŒ‰æ“ä½œæ¶‰åŠçš„æ•°æ®é‡å¤§å°å‘ˆç°äº†åŒå³°åˆ†å¸ƒã€‚å°çš„è¯»å–æ“ä½œï¼ˆå°äº64KBï¼‰ä¸€èˆ¬æ˜¯ç”±æŸ¥æ‰¾æ“ä½œçš„å®¢æˆ·ç«¯å‘èµ·çš„ï¼Œç›®çš„åœ¨äºä»å·¨å¤§çš„æ–‡ä»¶ä¸­æŸ¥æ‰¾å°å—çš„æ•°æ®ã€‚å¤§çš„è¯»å–æ“ä½œï¼ˆå¤§äº512KBï¼‰ä¸€èˆ¬æ˜¯ä»å¤´åˆ°å°¾é¡ºåºçš„è¯»å–æ•´ä¸ªæ–‡ä»¶ã€‚</p>
<p>åœ¨é›†ç¾¤Yä¸Šï¼Œæœ‰ç›¸å½“æ•°é‡çš„è¯»æ“ä½œæ²¡æœ‰è¿”å›ä»»ä½•çš„æ•°æ®ã€‚åœ¨æˆ‘ä»¬çš„åº”ç”¨ä¸­ï¼Œå°¤å…¶æ˜¯åœ¨ç”Ÿäº§ç³»ç»Ÿä¸­ï¼Œç»å¸¸ä½¿ç”¨æ–‡ä»¶ä½œä¸ºç”Ÿäº§è€…-æ¶ˆè´¹è€…é˜Ÿåˆ—ã€‚ç”Ÿäº§è€…å¹¶è¡Œçš„å‘æ–‡ ä»¶ä¸­è¿½åŠ æ•°æ®ï¼ŒåŒæ—¶ï¼Œæ¶ˆè´¹è€…ä»æ–‡ä»¶çš„å°¾éƒ¨è¯»å–æ•°æ®ã€‚æŸäº›æƒ…å†µä¸‹ï¼Œæ¶ˆè´¹è€…è¯»å–çš„é€Ÿåº¦è¶…è¿‡äº†ç”Ÿäº§è€…å†™å…¥çš„é€Ÿåº¦ï¼Œè¿™å°±ä¼šå¯¼è‡´æ²¡æœ‰è¯»åˆ°ä»»ä½•æ•°æ®çš„æƒ…å†µã€‚é›†ç¾¤Xé€šå¸¸ ç”¨äºçŸ­æš‚çš„æ•°æ®åˆ†æä»»åŠ¡ï¼Œè€Œä¸æ˜¯é•¿æ—¶é—´è¿è¡Œçš„åˆ†å¸ƒå¼åº”ç”¨ï¼Œå› æ­¤ï¼Œé›†ç¾¤Xå¾ˆå°‘å‡ºç°è¿™ç§æƒ…å†µã€‚</p>
<p>å†™æ“ä½œæŒ‰æ•°æ®é‡å¤§å°ä¹ŸåŒæ ·å‘ˆç°ä¸ºåŒå³°åˆ†å¸ƒã€‚å¤§çš„å†™æ“ä½œï¼ˆè¶…è¿‡256KBï¼‰é€šå¸¸æ˜¯ç”±äºWriterä½¿ç”¨äº†ç¼“å­˜æœºåˆ¶å¯¼è‡´çš„ã€‚Writerç¼“å­˜è¾ƒå°çš„æ•°æ®ï¼Œé€šè¿‡é¢‘ç¹çš„Checkpointæˆ–è€…åŒæ­¥æ“ä½œï¼Œæˆ–è€…åªæ˜¯ç®€å•çš„ç»Ÿè®¡å°çš„å†™å…¥ï¼ˆå°äº64KBï¼‰çš„æ•°æ®é‡<strong>(alexæ³¨ï¼šå³æ±‡é›†å¤šæ¬¡å°çš„å†™å…¥æ“ä½œï¼Œå½“æ•°æ®é‡è¾¾åˆ°ä¸€ä¸ªé˜ˆå€¼ï¼Œä¸€æ¬¡å†™å…¥)</strong>ï¼Œä¹‹åæ‰¹é‡å†™å…¥ã€‚</p>
<p>å†æ¥è§‚å¯Ÿä¸€ä¸‹è®°å½•è¿½åŠ æ“ä½œã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é›†ç¾¤Yä¸­å¤§çš„è®°å½•è¿½åŠ æ“ä½œæ‰€å æ¯”ä¾‹æ¯”é›†ç¾¤Xå¤šçš„å¤šï¼Œè¿™æ˜¯å› ä¸ºé›†ç¾¤Yç”¨äºæˆ‘ä»¬çš„ç”Ÿäº§ç³»ç»Ÿï¼Œé’ˆå¯¹GFSåšäº†æ›´å…¨é¢çš„è°ƒä¼˜ã€‚</p>
<p><img src="/images/GFS6-3-2-2.jpg"></p>
<p>è¡¨5æ˜¾ç¤ºäº†æŒ‰æ“ä½œæ¶‰åŠçš„æ•°æ®é‡çš„å¤§å°ç»Ÿè®¡å‡ºæ¥çš„æ€»æ•°æ®ä¼ è¾“é‡ã€‚åœ¨æ‰€æœ‰çš„æ“ä½œä¸­ï¼Œå¤§çš„æ“ä½œï¼ˆè¶…è¿‡256KBï¼‰å æ®äº†ä¸»è¦çš„ä¼ è¾“é‡ã€‚å°çš„è¯»å–ï¼ˆå°äº64KBï¼‰è™½ç„¶ä¼ è¾“çš„æ•°æ®é‡æ¯”è¾ƒå°‘ï¼Œä½†æ˜¯åœ¨è¯»å–çš„æ•°æ®é‡ä¸­ä»å äº†ç›¸å½“çš„æ¯”ä¾‹ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ–‡ä»¶ä¸­éšæœºSeekçš„å·¥ä½œè´Ÿè·è€Œå¯¼è‡´çš„ã€‚</p>
<h5 id="6-3-3-è®°å½•è¿½åŠ -vs-å†™æ“ä½œ"><a href="#6-3-3-è®°å½•è¿½åŠ -vs-å†™æ“ä½œ" class="headerlink" title="6.3.3 è®°å½•è¿½åŠ  vs. å†™æ“ä½œ"></a>6.3.3 è®°å½•è¿½åŠ  vs. å†™æ“ä½œ</h5><p>è®°å½•è¿½åŠ æ“ä½œåœ¨æˆ‘ä»¬çš„ç”Ÿäº§ç³»ç»Ÿä¸­å¤§é‡ä½¿ç”¨ã€‚å¯¹äºé›†ç¾¤Xï¼Œè®°å½•è¿½åŠ æ“ä½œå’Œæ™®é€šå†™æ“ä½œçš„æ¯”ä¾‹æŒ‰ç…§å­—èŠ‚æ¯”æ˜¯108:1ï¼ŒæŒ‰ç…§æ“ä½œæ¬¡æ•°æ¯”æ˜¯8:1ã€‚å¯¹äº ä½œä¸ºæˆ‘ä»¬çš„ç”Ÿäº§ç³»ç»Ÿçš„é›†ç¾¤Yæ¥è¯´ï¼Œè¿™ä¸¤ä¸ªæ¯”ä¾‹åˆ†åˆ«æ˜¯3.7:1å’Œ2.5:1ã€‚æ›´è¿›ä¸€æ­¥ï¼Œè¿™ä¸€ç»„æ•°æ®è¯´æ˜åœ¨æˆ‘ä»¬çš„ä¸¤ä¸ªé›†ç¾¤ä¸Šï¼Œè®°å½•è¿½åŠ æ“ä½œæ‰€å æ¯”ä¾‹éƒ½è¦æ¯”å†™ æ“ä½œè¦å¤§ã€‚å¯¹äºé›†ç¾¤Xï¼Œåœ¨æ•´ä¸ªæµ‹é‡è¿‡ç¨‹ä¸­ï¼Œè®°å½•è¿½åŠ æ“ä½œæ‰€å æ¯”ç‡éƒ½æ¯”è¾ƒä½ï¼Œå› æ­¤ç»“æœä¼šå—åˆ°ä¸€ä¸¤ä¸ªä½¿ç”¨æŸäº›ç‰¹å®šå¤§å°çš„bufferçš„åº”ç”¨ç¨‹åºçš„å½±å“ã€‚</p>
<p>å¦‚åŒæˆ‘ä»¬æ‰€é¢„æœŸçš„ï¼Œæˆ‘ä»¬çš„æ•°æ®ä¿®æ”¹æ“ä½œä¸»è¦æ˜¯è®°å½•è¿½åŠ æ“ä½œè€Œä¸æ˜¯è¦†ç›–æ–¹å¼çš„å†™æ“ä½œã€‚æˆ‘ä»¬æµ‹é‡äº†ç¬¬ä¸€ä¸ªå‰¯æœ¬çš„æ•°æ®è¦†ç›–å†™çš„æƒ…å†µã€‚è¿™è¿‘ä¼¼äºä¸€ä¸ªå®¢æˆ·æœºæ•… æ„è¦†ç›–åˆšåˆšå†™å…¥çš„æ•°æ®ï¼Œè€Œä¸æ˜¯å¢åŠ æ–°çš„æ•°æ®ã€‚å¯¹äºé›†ç¾¤Xï¼Œè¦†ç›–å†™æ“ä½œåœ¨å†™æ“ä½œæ‰€å æ®å­—èŠ‚ä¸Šçš„æ¯”ä¾‹å°äº0.0001%ï¼Œåœ¨æ‰€å æ®æ“ä½œæ•°é‡ä¸Šçš„æ¯”ä¾‹å°äº 0.0003%ã€‚å¯¹äºé›†ç¾¤Yï¼Œè¿™ä¸¤ä¸ªæ¯”ç‡éƒ½æ˜¯0.05%ã€‚è™½ç„¶è¿™åªæ˜¯æŸä¸€ç‰‡æ–­çš„æƒ…å†µï¼Œä½†æ˜¯ä»ç„¶é«˜äºæˆ‘ä»¬çš„é¢„æœŸã€‚è¿™æ˜¯ç”±äºè¿™äº›è¦†ç›–å†™çš„æ“ä½œï¼Œå¤§éƒ¨åˆ†æ˜¯ç”±äºå®¢ æˆ·ç«¯åœ¨å‘ç”Ÿé”™è¯¯æˆ–è€…è¶…æ—¶ä»¥åé‡è¯•çš„æƒ…å†µã€‚è¿™åœ¨æœ¬è´¨ä¸Šåº”è¯¥ä¸ç®—ä½œå·¥ä½œè´Ÿè·çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯é‡è¯•æœºåˆ¶äº§ç”Ÿçš„ç»“æœã€‚</p>
<h5 id="6-3-4-Masterçš„å·¥ä½œè´Ÿè·"><a href="#6-3-4-Masterçš„å·¥ä½œè´Ÿè·" class="headerlink" title="6.3.4 Masterçš„å·¥ä½œè´Ÿè·"></a>6.3.4 Masterçš„å·¥ä½œè´Ÿè·</h5><p><img src="/images/GFS6-3-4.jpg"></p>
<p>è¡¨6æ˜¾ç¤ºäº†MasteræœåŠ¡å™¨ä¸Šçš„è¯·æ±‚æŒ‰ç±»å‹åŒºåˆ†çš„æ˜ç»†è¡¨ã€‚å¤§éƒ¨åˆ†çš„è¯·æ±‚éƒ½æ˜¯è¯»å–æ“ä½œæŸ¥è¯¢Chunkä½ç½®ä¿¡æ¯ï¼ˆFindLocationï¼‰ã€ä»¥åŠä¿®æ”¹æ“ä½œæŸ¥è¯¢leaseæŒæœ‰è€…çš„ä¿¡æ¯ï¼ˆFindLease-Lockerï¼‰ã€‚</p>
<p>é›†ç¾¤Xå’ŒYåœ¨åˆ é™¤è¯·æ±‚çš„æ•°é‡ä¸Šæœ‰ç€æ˜æ˜¾çš„ä¸åŒï¼Œå› ä¸ºé›†ç¾¤Yå­˜å‚¨äº†ç”Ÿäº§æ•°æ®ï¼Œä¸€èˆ¬ä¼šé‡æ–°ç”Ÿæˆæ•°æ®ä»¥åŠç”¨æ–°ç‰ˆæœ¬çš„æ•°æ®æ›¿æ¢æ—§æœ‰çš„æ•°æ®ã€‚æ•°é‡ä¸Šçš„å·®å¼‚ ä¹Ÿè¢«éšè—åœ¨äº†Openè¯·æ±‚ä¸­ï¼Œå› ä¸ºæ—§ç‰ˆæœ¬çš„æ–‡ä»¶å¯èƒ½åœ¨ä»¥é‡æ–°å†™å…¥çš„æ¨¡å¼æ‰“å¼€æ—¶ï¼Œéšå¼çš„è¢«åˆ é™¤äº†ï¼ˆç±»ä¼¼UNIXçš„openå‡½æ•°ä¸­çš„â€œwâ€æ¨¡å¼ï¼‰ã€‚</p>
<p>FindMatchingFilesæ˜¯ä¸€ä¸ªæ¨¡å¼åŒ¹é…è¯·æ±‚ï¼Œæ”¯æŒâ€œlsâ€ä»¥åŠå…¶å®ƒç±»ä¼¼çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€‚ä¸åŒäºMasteræœåŠ¡å™¨çš„å…¶å®ƒè¯·æ±‚ï¼Œå®ƒå¯ èƒ½ä¼šæ£€ç´¢namespaceçš„å¤§éƒ¨åˆ†å†…å®¹ï¼Œå› æ­¤æ˜¯éå¸¸æ˜‚è´µçš„æ“ä½œã€‚é›†ç¾¤Yçš„è¿™ç±»è¯·æ±‚è¦å¤šä¸€äº›ï¼Œå› ä¸ºè‡ªåŠ¨åŒ–æ•°æ®å¤„ç†çš„ä»»åŠ¡è¿›ç¨‹éœ€è¦æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿçš„å„ä¸ªéƒ¨åˆ†ï¼Œ ä»¥ä¾¿ä»å…¨å±€ä¸Šäº†è§£åº”ç”¨ç¨‹åºçš„çŠ¶æ€ã€‚ä¸ä¹‹ä¸åŒçš„æ˜¯ï¼Œé›†ç¾¤Xçš„åº”ç”¨ç¨‹åºæ›´åŠ å€¾å‘äºç”±å•ç‹¬çš„ç”¨æˆ·æ§åˆ¶ï¼Œé€šå¸¸é¢„å…ˆçŸ¥é“è‡ªå·±æ‰€éœ€è¦ä½¿ç”¨çš„å…¨éƒ¨æ–‡ä»¶çš„åç§°ã€‚</p>
<h3 id="7-ç»éªŒ"><a href="#7-ç»éªŒ" class="headerlink" title="7. ç»éªŒ"></a>7. ç»éªŒ</h3><p>åœ¨å»ºé€ å’Œéƒ¨ç½²GFSçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å†äº†å„ç§å„æ ·çš„é—®é¢˜ï¼Œæœ‰äº›æ˜¯æ“ä½œä¸Šçš„ï¼Œæœ‰äº›æ˜¯æŠ€æœ¯ä¸Šçš„ã€‚</p>
<p>èµ·åˆï¼ŒGFSè¢«è®¾æƒ³ä¸ºæˆ‘ä»¬çš„ç”Ÿäº§ç³»ç»Ÿçš„åç«¯æ–‡ä»¶ç³»ç»Ÿã€‚éšç€æ—¶é—´æ¨ç§»ï¼Œåœ¨GFSçš„ä½¿ç”¨ä¸­é€æ­¥çš„å¢åŠ äº†å¯¹ç ”ç©¶å’Œå¼€å‘ä»»åŠ¡çš„æ”¯æŒã€‚æˆ‘ä»¬å¼€å§‹å¢åŠ ä¸€äº›å° çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æƒé™å’Œé…é¢ï¼Œåˆ°äº†ç°åœ¨ï¼ŒGFSå·²ç»åˆæ­¥æ”¯æŒäº†è¿™äº›åŠŸèƒ½ã€‚è™½ç„¶æˆ‘ä»¬ç”Ÿäº§ç³»ç»Ÿæ˜¯ä¸¥æ ¼å—æ§çš„ï¼Œä½†æ˜¯ç”¨æˆ·å±‚å´ä¸æ€»æ˜¯è¿™æ ·çš„ã€‚éœ€è¦æ›´å¤šçš„åŸºç¡€æ¶æ„æ¥é˜²æ­¢ ç”¨æˆ·é—´çš„ç›¸äº’å¹²æ‰°ã€‚</p>
<p>æˆ‘ä»¬æœ€å¤§çš„é—®é¢˜æ˜¯ç£ç›˜ä»¥åŠå’ŒLinuxç›¸å…³çš„é—®é¢˜ã€‚å¾ˆå¤šç£ç›˜éƒ½å£°ç§°å®ƒä»¬æ”¯æŒæŸä¸ªèŒƒå›´å†…çš„Linux IDEç¡¬ç›˜é©±åŠ¨ç¨‹åºï¼Œä½†æ˜¯å®é™…åº”ç”¨ä¸­åæ˜ å‡ºæ¥çš„æƒ…å†µå´ä¸æ˜¯è¿™æ ·ï¼Œå®ƒä»¬åªæ”¯æŒæœ€æ–°çš„é©±åŠ¨ã€‚å› ä¸ºåè®®ç‰ˆæœ¬å¾ˆæ¥è¿‘ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†ç£ç›˜éƒ½å¯ä»¥ç”¨ï¼Œä½†æ˜¯å¶å°”ä¹Ÿä¼šæœ‰ç”±äº åè®®ä¸åŒ¹é…ï¼Œå¯¼è‡´é©±åŠ¨å’Œå†…æ ¸å¯¹äºé©±åŠ¨å™¨çš„çŠ¶æ€åˆ¤æ–­å¤±è¯¯ã€‚è¿™ä¼šå¯¼è‡´æ•°æ®å› ä¸ºå†…æ ¸ä¸­çš„é—®é¢˜æ„å¤–çš„è¢«ç ´åäº†ã€‚è¿™ä¸ªé—®é¢˜ä¿ƒä½¿æˆ‘ä»¬ä½¿ç”¨Checksumæ¥æ ¡éªŒæ•°æ®ï¼Œ åŒæ—¶æˆ‘ä»¬ä¹Ÿä¿®æ”¹å†…æ ¸æ¥å¤„ç†è¿™äº›å› ä¸ºåè®®ä¸åŒ¹é…å¸¦æ¥çš„é—®é¢˜ã€‚</p>
<p>è¾ƒæ—©çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨Linux 2.2å†…æ ¸æ—¶é‡åˆ°äº†äº›é—®é¢˜ï¼Œä¸»è¦æ˜¯fsync()çš„æ•ˆç‡é—®é¢˜ã€‚å®ƒçš„æ•ˆç‡ä¸æ–‡ä»¶çš„å¤§å°è€Œä¸æ˜¯æ–‡ä»¶ä¿®æ”¹éƒ¨åˆ†çš„å¤§å°æœ‰å…³ã€‚è¿™åœ¨æˆ‘ä»¬çš„æ“ä½œæ—¥å¿—æ–‡ä»¶è¿‡å¤§æ—¶ç»™å‡ºäº†éš¾ é¢˜ï¼Œå°¤å…¶æ˜¯åœ¨æˆ‘ä»¬å°šæœªå®ç°Checkpointçš„æ—¶å€™ã€‚æˆ‘ä»¬è´¹äº†å¾ˆå¤§çš„åŠ›æ°”ç”¨åŒæ­¥å†™æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æœ€åè¿˜æ˜¯ç§»æ¤åˆ°äº†Linux2.4å†…æ ¸ä¸Šã€‚</p>
<p>å¦ä¸€ä¸ªå’ŒLinuxç›¸å…³çš„é—®é¢˜æ˜¯å•ä¸ªè¯»å†™é”çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æŸä¸€ä¸ªåœ°å€ç©ºé—´çš„ä»»æ„ä¸€ä¸ªçº¿ç¨‹éƒ½å¿…é¡»åœ¨ä»ç£ç›˜page inï¼ˆè¯»é”ï¼‰çš„æ—¶å€™å…ˆholdä½ï¼Œæˆ–è€…åœ¨mmap()è°ƒç”¨ï¼ˆå†™é”ï¼‰çš„æ—¶å€™æ”¹å†™åœ°å€ç©ºé—´ã€‚æˆ‘ä»¬å‘ç°å³ä½¿æˆ‘ä»¬çš„ç³»ç»Ÿè´Ÿè½½å¾ˆè½»çš„æƒ…å†µä¸‹ä¹Ÿä¼šæœ‰å¶å°”çš„è¶…æ—¶ï¼Œæˆ‘ä»¬èŠ± è´¹äº†å¾ˆå¤šçš„ç²¾åŠ›å»æŸ¥æ‰¾èµ„æºçš„ç“¶é¢ˆæˆ–è€…ç¡¬ä»¶çš„é—®é¢˜ã€‚æœ€åæˆ‘ä»¬ç»ˆäºå‘ç°è¿™ä¸ªå•ä¸ªé”åœ¨ç£ç›˜çº¿ç¨‹äº¤æ¢ä»¥å‰æ˜ å°„çš„æ•°æ®åˆ°ç£ç›˜çš„æ—¶å€™ï¼Œé”ä½äº†å½“å‰çš„ç½‘ç»œçº¿ç¨‹ï¼Œé˜»æ­¢å®ƒæŠŠ æ–°æ•°æ®æ˜ å°„åˆ°å†…å­˜ã€‚ç”±äºæˆ‘ä»¬çš„æ€§èƒ½ä¸»è¦å—é™äºç½‘ç»œæ¥å£ï¼Œè€Œä¸æ˜¯å†…å­˜copyçš„å¸¦å®½ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ç”¨pread()æ›¿ä»£mmap()ï¼Œç”¨äº†ä¸€ä¸ªé¢å¤–çš„copy åŠ¨ä½œæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>å°½ç®¡å¶å°”è¿˜æ˜¯æœ‰å…¶å®ƒçš„é—®é¢˜ï¼ŒLinuxçš„å¼€æ”¾æºä»£ç è¿˜æ˜¯ä½¿æˆ‘ä»¬èƒ½å¤Ÿå¿«é€Ÿæ¢ç©¶å’Œç†è§£ç³»ç»Ÿçš„è¡Œä¸ºã€‚åœ¨é€‚å½“çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæ”¹è¿›å†…æ ¸å¹¶ä¸”å’Œå…¬å¼€æºç ç»„ç»‡å…±äº«è¿™äº›æ”¹åŠ¨ã€‚</p>
<h3 id="8-ç›¸å…³å·¥ä½œ"><a href="#8-ç›¸å…³å·¥ä½œ" class="headerlink" title="8. ç›¸å…³å·¥ä½œ"></a>8. ç›¸å…³å·¥ä½œ</h3><p>å’Œå…¶å®ƒçš„å¤§å‹åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”å¦‚AFS[5]ç±»ä¼¼ï¼ŒGFSæä¾›äº†ä¸€ä¸ªä¸ä½ç½®æ— å…³çš„åå­—ç©ºé—´ï¼Œè¿™ä½¿å¾—æ•°æ®å¯ä»¥ä¸ºäº†è´Ÿè½½å‡è¡¡æˆ–è€…ç¾éš¾å†—ä½™ç­‰ç›®çš„åœ¨ ä¸åŒä½ç½®é€æ˜çš„è¿ç§»ã€‚ä¸åŒäºAFSçš„æ˜¯ï¼ŒGFSæŠŠæ–‡ä»¶åˆ†å¸ƒå­˜å‚¨åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œè¿™ç§æ–¹å¼æ›´ç±»ä¼¼Xfs[1]å’ŒSwift[3]ï¼Œè¿™æ˜¯ä¸ºäº†æé«˜æ•´ä½“æ€§èƒ½ä»¥ åŠç¾éš¾å†—ä½™çš„èƒ½åŠ›ã€‚</p>
<p>ç”±äºç£ç›˜ç›¸å¯¹æ¥è¯´æ¯”è¾ƒä¾¿å®œï¼Œå¹¶ä¸”å¤åˆ¶çš„æ–¹å¼æ¯”RAID[9]æ–¹æ³•ç®€å•çš„å¤šï¼ŒGFSç›®å‰åªä½¿ç”¨å¤åˆ¶çš„æ–¹å¼æ¥è¿›è¡Œå†—ä½™ï¼Œå› æ­¤è¦æ¯”xFSæˆ–è€…Swiftå ç”¨æ›´å¤šçš„è£¸å­˜å‚¨ç©ºé—´ <strong>(alexæ³¨ï¼šRaw storageï¼Œè£¸ç›˜çš„ç©ºé—´)</strong>ã€‚</p>
<p>ä¸AFSã€xFSã€Frangipani[12]ä»¥åŠIntermezzo[6]ç­‰æ–‡ä»¶ç³»ç»Ÿä¸åŒçš„æ˜¯ï¼ŒGFSå¹¶æ²¡æœ‰åœ¨æ–‡ä»¶ç³»ç»Ÿå±‚é¢æä¾›ä»»ä½• Cacheæœºåˆ¶ã€‚æˆ‘ä»¬ä¸»è¦çš„å·¥ä½œåœ¨å•ä¸ªåº”ç”¨ç¨‹åºæ‰§è¡Œçš„æ—¶å€™å‡ ä¹ä¸ä¼šé‡å¤è¯»å–æ•°æ®ï¼Œå› ä¸ºå®ƒä»¬çš„å·¥ä½œæ–¹å¼è¦ä¹ˆæ˜¯æµå¼çš„è¯»å–ä¸€ä¸ªå¤§å‹çš„æ•°æ®é›†ï¼Œè¦ä¹ˆæ˜¯åœ¨å¤§å‹çš„æ•° æ®é›†ä¸­éšæœºSeekåˆ°æŸä¸ªä½ç½®ï¼Œä¹‹åæ¯æ¬¡è¯»å–å°‘é‡çš„æ•°æ®ã€‚</p>
<p>æŸäº›åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”å¦‚Frangipaniã€xFSã€Minnesotaâ€™s GFS[11]ã€GPFS[10]ï¼Œå»æ‰äº†ä¸­å¿ƒæœåŠ¡å™¨ï¼Œåªä¾èµ–äºåˆ†å¸ƒå¼ç®—æ³•æ¥ä¿è¯ä¸€è‡´æ€§å’Œå¯ç®¡ç†æ€§ã€‚æˆ‘ä»¬é€‰æ‹©äº†ä¸­å¿ƒæœåŠ¡å™¨çš„æ–¹æ³•ï¼Œç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–è®¾è®¡ï¼Œå¢ åŠ å¯é æ€§ï¼Œèƒ½å¤Ÿçµæ´»æ‰©å±•ã€‚ç‰¹åˆ«å€¼å¾—ä¸€æçš„æ˜¯ï¼Œç”±äºå¤„äºä¸­å¿ƒä½ç½®çš„MasteræœåŠ¡å™¨ä¿å­˜æœ‰å‡ ä¹æ‰€æœ‰çš„Chunkç›¸å…³ä¿¡æ¯ï¼Œå¹¶ä¸”æ§åˆ¶ç€Chunkçš„æ‰€æœ‰å˜ æ›´ï¼Œå› æ­¤ï¼Œå®ƒæå¤§åœ°ç®€åŒ–äº†åŸæœ¬éå¸¸å¤æ‚çš„Chunkåˆ†é…å’Œå¤åˆ¶ç­–ç•¥çš„å®ç°æ–¹æ³•ã€‚æˆ‘ä»¬é€šè¿‡å‡å°‘MasteræœåŠ¡å™¨ä¿å­˜çš„çŠ¶æ€ä¿¡æ¯çš„æ•°é‡ï¼Œä»¥åŠå°†Master æœåŠ¡å™¨çš„çŠ¶æ€å¤åˆ¶åˆ°å…¶å®ƒèŠ‚ç‚¹æ¥ä¿è¯ç³»ç»Ÿçš„ç¾éš¾å†—ä½™èƒ½åŠ›ã€‚æ‰©å±•èƒ½åŠ›å’Œé«˜å¯ç”¨æ€§ï¼ˆå¯¹äºè¯»å–ï¼‰ç›®å‰æ˜¯é€šè¿‡æˆ‘ä»¬çš„å½±å­MasteræœåŠ¡å™¨æœºåˆ¶æ¥ä¿è¯çš„ã€‚å¯¹ MasteræœåŠ¡å™¨çŠ¶æ€æ›´æ”¹æ˜¯é€šè¿‡é¢„å†™æ—¥å¿—çš„æ–¹å¼å®ç°æŒä¹…åŒ–ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒæ•´ä¸ºä½¿ç”¨ç±»ä¼¼Harp[7]ä¸­çš„primary-copyæ–¹æ¡ˆï¼Œä»è€Œæä¾›æ¯” æˆ‘ä»¬ç°åœ¨çš„æ–¹æ¡ˆæ›´ä¸¥æ ¼çš„ä¸€è‡´æ€§ä¿è¯ã€‚</p>
<p>æˆ‘ä»¬è§£å†³äº†ä¸€ä¸ªéš¾é¢˜ï¼Œè¿™ä¸ªéš¾é¢˜ç±»ä¼¼Lustre[8]åœ¨å¦‚ä½•åœ¨æœ‰å¤§é‡å®¢æˆ·ç«¯æ—¶ä¿éšœç³»ç»Ÿæ•´ä½“æ€§èƒ½é‡åˆ°çš„é—®é¢˜ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬é€šè¿‡åªå…³æ³¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åº çš„éœ€æ±‚ï¼Œè€Œä¸æ˜¯æä¾›ä¸€ä¸ªå…¼å®¹POSIXçš„æ–‡ä»¶ç³»ç»Ÿï¼Œä»è€Œè¾¾åˆ°äº†ç®€åŒ–é—®é¢˜çš„ç›®çš„ã€‚æ­¤å¤–ï¼ŒGFSè®¾è®¡é¢„æœŸæ˜¯ä½¿ç”¨å¤§é‡çš„ä¸å¯é èŠ‚ç‚¹ç»„å»ºé›†ç¾¤ï¼Œå› æ­¤ï¼Œç¾éš¾å†—ä½™æ–¹æ¡ˆ æ˜¯æˆ‘ä»¬è®¾è®¡çš„æ ¸å¿ƒã€‚</p>
<p>GFSå¾ˆç±»ä¼¼NASDæ¶æ„[4]ã€‚NASDæ¶æ„æ˜¯åŸºäºç½‘ç»œç£ç›˜çš„ï¼Œè€ŒGFSä½¿ç”¨çš„æ˜¯æ™®é€šè®¡ç®—æœºä½œä¸ºChunkæœåŠ¡å™¨ï¼Œå°±åƒNASDåŸå½¢ä¸­æ–¹æ¡ˆä¸€ æ ·ã€‚æ‰€ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬çš„ChunkæœåŠ¡å™¨é‡‡ç”¨æƒ°æ€§åˆ†é…å›ºå®šå¤§å°çš„Chunkçš„æ–¹å¼ï¼Œè€Œä¸æ˜¯åˆ†é…å˜é•¿çš„å¯¹è±¡å­˜å‚¨ç©ºé—´ã€‚æ­¤å¤–ï¼ŒGFSå®ç°äº†è¯¸å¦‚é‡æ–°è´Ÿè½½å‡è¡¡ã€ å¤åˆ¶ã€æ¢å¤æœºåˆ¶ç­‰ç­‰åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦çš„ç‰¹æ€§ã€‚</p>
<p>ä¸åŒäºä¸Minnesotaâ€™s GFSå’ŒNASDï¼Œæˆ‘ä»¬å¹¶ä¸æ”¹å˜å­˜å‚¨è®¾å¤‡çš„Model <strong>(alexæ³¨ï¼šå¯¹è¿™ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸äº†è§£ï¼Œå› ä¸ºä¸å¤ªæ˜ç™½æ”¹å˜å­˜å‚¨è®¾å¤‡çš„Modelç”¨æ¥åšä»€ä¹ˆï¼Œè¿™ä¸æ˜ç™½è¿™ä¸ªmodelæ˜¯æ¨¡å‹ã€è¿˜æ˜¯å‹å·)</strong>ã€‚æˆ‘ä»¬åªå…³æ³¨ç”¨æ™®é€šçš„è®¾å¤‡æ¥è§£å†³éå¸¸å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ—¥å¸¸çš„æ•°æ®å¤„ç†ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡åŸå­çš„è®°å½•è¿½åŠ æ“ä½œå®ç°äº†ç”Ÿäº§è€…-æ¶ˆè´¹è€…é˜Ÿåˆ—ï¼Œè¿™ä¸ªé—®é¢˜ç±»ä¼¼River[2]ä¸­çš„åˆ†å¸ƒå¼é˜Ÿåˆ—ã€‚Riverä½¿ç”¨çš„æ˜¯è·¨ä¸»æœºçš„ã€åŸºäºå†…å­˜çš„ åˆ†å¸ƒå¼é˜Ÿåˆ—ï¼Œä¸ºäº†å®ç°è¿™ä¸ªé˜Ÿåˆ—ï¼Œå¿…é¡»ä»”ç»†æ§åˆ¶æ•°æ®æµï¼›è€ŒGFSé‡‡ç”¨å¯ä»¥è¢«ç”Ÿäº§è€…å¹¶å‘è¿½åŠ è®°å½•çš„æŒä¹…åŒ–çš„æ–‡ä»¶çš„æ–¹å¼å®ç°ã€‚Riveræ¨¡å¼æ”¯æŒm-åˆ°-nçš„åˆ† å¸ƒå¼é˜Ÿåˆ—ï¼Œä½†æ˜¯ç¼ºå°‘ç”±æŒä¹…åŒ–å­˜å‚¨æä¾›çš„å®¹é”™æœºåˆ¶ï¼ŒGFSåªæ”¯æŒm-åˆ°-1çš„é˜Ÿåˆ—ã€‚å¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥åŒæ—¶è¯»å–ä¸€ä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯å®ƒä»¬è¾“å…¥æµçš„åŒºé—´å¿…é¡»æ˜¯å¯¹é½çš„ã€‚</p>
<h3 id="9-ç»“æŸè¯­"><a href="#9-ç»“æŸè¯­" class="headerlink" title="9. ç»“æŸè¯­"></a>9. ç»“æŸè¯­</h3><p>Googleæ–‡ä»¶ç³»ç»Ÿå±•ç¤ºäº†ä¸€ä¸ªä½¿ç”¨æ™®é€šç¡¬ä»¶æ”¯æŒå¤§è§„æ¨¡æ•°æ®å¤„ç†çš„ç³»ç»Ÿçš„ç‰¹è´¨ã€‚è™½ç„¶ä¸€äº›è®¾è®¡è¦ç‚¹éƒ½æ˜¯é’ˆå¯¹æˆ‘ä»¬çš„ç‰¹æ®Šçš„éœ€è¦å®šåˆ¶çš„ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰å¾ˆå¤šç‰¹æ€§é€‚ç”¨äºç±»ä¼¼è§„æ¨¡çš„å’Œæˆæœ¬çš„æ•°æ®å¤„ç†ä»»åŠ¡ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ ¹æ®æˆ‘ä»¬å½“å‰çš„å’Œå¯é¢„æœŸçš„å°†æ¥çš„åº”ç”¨è§„æ¨¡å’ŒæŠ€æœ¯ç¯å¢ƒæ¥è¯„ä¼°ä¼ ç»Ÿçš„ æ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æ€§ã€‚æˆ‘ä»¬çš„è¯„ä¼°ç»“æœå°†æˆ‘ä»¬å¼•å¯¼åˆ°ä¸€ä¸ªä½¿ç”¨å®Œå…¨ä¸åŒäºä¼ ç»Ÿçš„è®¾è®¡æ€è·¯ä¸Šã€‚æ ¹æ®æˆ‘ä»¬çš„è®¾è®¡æ€è·¯ï¼Œæˆ‘ä»¬è®¤ä¸ºç»„ä»¶å¤±æ•ˆæ˜¯å¸¸æ€è€Œä¸æ˜¯å¼‚å¸¸ï¼Œé’ˆå¯¹é‡‡ç”¨è¿½åŠ  æ–¹å¼ï¼ˆæœ‰å¯èƒ½æ˜¯å¹¶å‘è¿½åŠ ï¼‰å†™å…¥ã€ç„¶åå†è¯»å–ï¼ˆé€šå¸¸åºåˆ—åŒ–è¯»å–ï¼‰çš„å¤§æ–‡ä»¶è¿›è¡Œä¼˜åŒ–ï¼Œä»¥åŠæ‰©å±•æ ‡å‡†æ–‡ä»¶ç³»ç»Ÿæ¥å£ã€æ”¾æ¾æ¥å£é™åˆ¶æ¥æ”¹è¿›æ•´ä¸ªç³»ç»Ÿã€‚</p>
<p>æˆ‘ä»¬ç³»ç»Ÿé€šè¿‡æŒç»­ç›‘æ§ï¼Œå¤åˆ¶å…³é”®æ•°æ®ï¼Œå¿«é€Ÿå’Œè‡ªåŠ¨æ¢å¤æä¾›ç¾éš¾å†—ä½™ã€‚ Chunkå¤åˆ¶ä½¿å¾—æˆ‘ä»¬å¯ä»¥å¯¹ChunkæœåŠ¡å™¨çš„å¤±æ•ˆè¿›è¡Œå®¹é”™ã€‚é«˜é¢‘ç‡çš„ç»„ä»¶å¤±æ•ˆè¦æ±‚ç³»ç»Ÿå…·å¤‡åœ¨çº¿ä¿®å¤æœºåˆ¶ï¼Œèƒ½å¤Ÿå‘¨æœŸæ€§çš„ã€é€æ˜çš„ä¿®å¤æŸåçš„æ•°æ®ï¼Œä¹Ÿèƒ½å¤Ÿ ç¬¬ä¸€æ—¶é—´é‡æ–°å»ºç«‹ä¸¢å¤±çš„å‰¯æœ¬ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ä½¿ç”¨Checksumåœ¨ç£ç›˜æˆ–è€…IDEå­ç³»ç»Ÿçº§åˆ«æ£€æµ‹æ•°æ®æŸåï¼Œåœ¨è¿™æ ·ç£ç›˜æ•°é‡æƒŠäººçš„å¤§ç³»ç»Ÿä¸­ï¼ŒæŸåç‡æ˜¯ç›¸å½“é«˜ çš„ã€‚</p>
<p>æˆ‘ä»¬çš„è®¾è®¡ä¿è¯äº†åœ¨æœ‰å¤§é‡çš„å¹¶å‘è¯»å†™æ“ä½œæ—¶èƒ½å¤Ÿæä¾›å¾ˆé«˜çš„åˆè®¡ååé‡ã€‚æˆ‘ä»¬é€šè¿‡åˆ†ç¦»æ§åˆ¶æµå’Œæ•°æ®æµæ¥å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæ§åˆ¶æµåœ¨MasteræœåŠ¡å™¨å¤„ç†ï¼Œè€Œæ•°æ®æµåœ¨ChunkæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å¤„ç†ã€‚å½“ä¸€èˆ¬çš„æ“ä½œæ¶‰åŠåˆ°MasteræœåŠ¡å™¨æ—¶ï¼Œç”±äºGFSé€‰æ‹©çš„Chunkå°ºå¯¸è¾ƒå¤§<strong>(alexæ³¨ï¼šä»è€Œå‡å°äº†å…ƒæ•°æ®çš„å¤§å°)</strong>ï¼Œä»¥åŠé€šè¿‡Chunk Leaseå°†æ§åˆ¶æƒé™ç§»äº¤ç»™ä¸»å‰¯æœ¬ï¼Œè¿™äº›æªæ–½å°†MasteræœåŠ¡å™¨çš„è´Ÿæ‹…é™åˆ°æœ€ä½ã€‚è¿™ä½¿å¾—ä¸€ä¸ªç®€å•ã€ä¸­å¿ƒçš„Masterä¸ä¼šæˆä¸ºæˆä¸ºç“¶é¢ˆã€‚æˆ‘ä»¬ç›¸ä¿¡æˆ‘ä»¬å¯¹ç½‘ç»œåè®®æ ˆçš„ä¼˜åŒ–å¯ä»¥æå‡å½“å‰å¯¹äºæ¯å®¢æˆ·ç«¯çš„å†™å…¥ååé‡é™åˆ¶ã€‚</p>
<p>GFSæˆåŠŸçš„å®ç°äº†æˆ‘ä»¬å¯¹å­˜å‚¨çš„éœ€æ±‚ï¼Œåœ¨Googleå†…éƒ¨ï¼Œæ— è®ºæ˜¯ä½œä¸ºç ”ç©¶å’Œå¼€å‘çš„å­˜å‚¨å¹³å°ï¼Œè¿˜æ˜¯ä½œä¸ºç”Ÿäº§ç³»ç»Ÿçš„æ•°æ®å¤„ç†å¹³å°ï¼Œéƒ½å¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ã€‚å®ƒæ˜¯æˆ‘ä»¬æŒç»­åˆ›æ–°å’Œå¤„ç†æ•´ä¸ªWEBèŒƒå›´å†…çš„éš¾é¢˜çš„ä¸€ä¸ªé‡è¦å·¥å…·ã€‚<br>è‡´è°¢<br>We wish to thankt he following people for their contributions to the system or the paper. Brain Bershad (our shepherd) and the anonymous reviewers gave us valuable comments and suggestions. Anurag Acharya, Jeff Dean, and David des-Jardins contributed to the early design. Fay Chang worked on comparison of replicas across chunkservers. Guy Edjlali worked on storage quota. Markus Gutschke worked on a testing frameworkan d security enhancements. David<br>Kramer worked on performance enhancements. Fay Chang, Urs Hoelzle, Max Ibel, Sharon Perl, Rob Pike, and Debby Wallach commented on earlier drafts of the paper. Many of our colleagues at Google bravely trusted their data to a new file system and gave us useful feedback. Yoshka helped with early testing.<br>å‚è€ƒ<br>[1] Thomas Anderson, Michael Dahlin, Jeanna Neefe, David Patterson, Drew Roselli, and Randolph Wang. Serverless networkfil e systems. In Proceedings of the 15th ACM Symposium on Operating System Principles, pages 109â€“126, Copper Mountain Resort, Colorado, December 1995.<br>[2] Remzi H. Arpaci-Dusseau, Eric Anderson, Noah Treuhaft, David E. Culler, Joseph M. Hellerstein, David Patterson, and Kathy Yelick. Cluster I/O with River: Making the fast case common. In Proceedings of the Sixth Workshop on Input/Output in Parallel and Distributed Systems (IOPADS â€™99), pages 10â€“22, Atlanta, Georgia, May 1999.<br>[3] Luis-Felipe Cabrera and Darrell D. E. Long. Swift: Using distributed disks triping to provide high I/O data rates. Computer Systems, 4(4):405â€“436, 1991.</p>
<p>[4] Garth A. Gibson, David F. Nagle, Khalil Amiri, Jeff Butler, Fay W. Chang, Howard Gobioff, Charles Hardin, ErikR iedel, David Rochberg, and Jim Zelenka. A cost-effective, high-bandwidth storage architecture. In Proceedings of the 8th Architectural Support for Programming Languages and Operating Systems, pages 92â€“103, San Jose, California, October 1998.</p>
<p>[5] John Howard, Michael Kazar, Sherri Menees, David Nichols, Mahadev Satyanarayanan, Robert Sidebotham, and Michael West. Scale and performance in a distributed file system. ACM Transactions on Computer Systems, 6(1):51â€“81, February 1988.<br>[6] InterMezzo. <a href="http://www.inter-mezzo.org" target="_blank" rel="external">http://www.inter-mezzo.org</a> , 2003.</p>
<p>[7] Barbara Liskov, Sanjay Ghemawat, Robert Gruber, Paul Johnson, Liuba Shrira, and Michael Williams. Replication in the Harp file system. In 13th Symposium on Operating System Principles, pages 226â€“238, Pacific Grove, CA, October 1991.<br>[8] Lustre. <a href="http://www.lustreorg" target="_blank" rel="external">http://www.lustreorg</a> , 2003.</p>
<p>[9] David A. Patterson, Garth A. Gibson, and Randy H. Katz. A case for redundant arrays of inexpensive disks (RAID). In Proceedings of the 1988 ACM SIGMOD International Conference on Management of Data, pages 109â€“116, Chicago, Illinois, September 1988.<br>[10] FrankS chmuck and Roger Haskin. GPFS: A shared-diskfi le system for large computing clusters. In Proceedings of the First USENIX Conference on File and Storage Technologies, pages 231â€“244, Monterey, California, January 2002.</p>
<p>[11] Steven R. Soltis, Thomas M. Ruwart, and Matthew T.Oâ€™Keefe. The Gobal File System. In Proceedings of the Fifth NASA Goddard Space Flight Center Conference on Mass Storage Systems and Technologies, College Park, Maryland, September 1996.<br>[12] Chandramohan A. Thekkath, Timothy Mann, and Edward K. Lee. Frangipani: A scalable distributed file system. In Proceedings of the 16th ACM Symposium on Operating System Principles, pages 224â€“237, Saint-Malo, France, October 1997</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[gulp jså‹ç¼©]]></title>
      <url>http://zsr.github.io/2016/08/19/gulp-js%E5%8E%8B%E7%BC%A9/</url>
      <content type="html"><![CDATA[<h4 id="å®‰è£…nodejsã€gulp"><a href="#å®‰è£…nodejsã€gulp" class="headerlink" title="å®‰è£…nodejsã€gulp"></a>å®‰è£…nodejsã€gulp</h4><ul>
<li>å®‰è£… nodejs</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install node</div></pre></td></tr></table></figure>
<ul>
<li>å®‰è£… gulp</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g gulp</div></pre></td></tr></table></figure>
<h4 id="å®‰è£…gulpæ’ä»¶"><a href="#å®‰è£…gulpæ’ä»¶" class="headerlink" title="å®‰è£…gulpæ’ä»¶"></a>å®‰è£…gulpæ’ä»¶</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install gulp-htmlmin gulp-imagemin imagemin-pngcrush gulp-minify-css gulp-jshint gulp-uglify gulp-concat gulp-rename gulp-notify --save-dev</div></pre></td></tr></table></figure>
<h4 id="gulpé…ç½®æ–‡ä»¶"><a href="#gulpé…ç½®æ–‡ä»¶" class="headerlink" title="gulpé…ç½®æ–‡ä»¶"></a>gulpé…ç½®æ–‡ä»¶</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">//åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºgulpfile.jsï¼Œä»£ç å¦‚ä¸‹ï¼š</div><div class="line"> </div><div class="line">// å¼•å…¥ gulp</div><div class="line">var gulp = require(&apos;gulp&apos;);</div><div class="line"> </div><div class="line">// å¼•å…¥ç»„ä»¶</div><div class="line">var htmlmin = require(&apos;gulp-htmlmin&apos;), //htmlå‹ç¼©</div><div class="line">    imagemin = require(&apos;gulp-imagemin&apos;),//å›¾ç‰‡å‹ç¼©</div><div class="line">    pngcrush = require(&apos;imagemin-pngcrush&apos;),</div><div class="line">    minifycss = require(&apos;gulp-minify-css&apos;),//csså‹ç¼©</div><div class="line">    jshint = require(&apos;gulp-jshint&apos;),//jsæ£€æµ‹</div><div class="line">    uglify = require(&apos;gulp-uglify&apos;),//jså‹ç¼©</div><div class="line">    concat = require(&apos;gulp-concat&apos;),//æ–‡ä»¶åˆå¹¶</div><div class="line">    rename = require(&apos;gulp-rename&apos;),//æ–‡ä»¶æ›´å</div><div class="line">    notify = require(&apos;gulp-notify&apos;);//æç¤ºä¿¡æ¯</div><div class="line"> </div><div class="line">// å‹ç¼©html</div><div class="line">gulp.task(&apos;html&apos;, function() &#123;</div><div class="line">  return gulp.src(&apos;src/*.html&apos;)</div><div class="line">    .pipe(htmlmin(&#123;collapseWhitespace: true&#125;))</div><div class="line">    .pipe(gulp.dest(&apos;./dest&apos;))</div><div class="line">    .pipe(notify(&#123; message: &apos;html task ok&apos; &#125;));</div><div class="line"> </div><div class="line">&#125;);</div><div class="line"> </div><div class="line">// å‹ç¼©å›¾ç‰‡</div><div class="line">gulp.task(&apos;img&apos;, function() &#123;</div><div class="line">  return gulp.src(&apos;src/images/*&apos;)</div><div class="line">    .pipe(imagemin(&#123;</div><div class="line">        progressive: true,</div><div class="line">        svgoPlugins: [&#123;removeViewBox: false&#125;],</div><div class="line">        use: [pngcrush()]</div><div class="line">    &#125;))</div><div class="line">    .pipe(gulp.dest(&apos;./dest/images/&apos;))</div><div class="line">    .pipe(notify(&#123; message: &apos;img task ok&apos; &#125;));</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">// åˆå¹¶ã€å‹ç¼©ã€é‡å‘½åcss</div><div class="line">gulp.task(&apos;css&apos;, function() &#123;</div><div class="line">  return gulp.src(&apos;src/css/*.css&apos;)</div><div class="line">    .pipe(concat(&apos;main.css&apos;))</div><div class="line">    .pipe(gulp.dest(&apos;dest/css&apos;))</div><div class="line">    .pipe(rename(&#123; suffix: &apos;.min&apos; &#125;))</div><div class="line">    .pipe(minifycss())</div><div class="line">    .pipe(gulp.dest(&apos;dest/css&apos;))</div><div class="line">    .pipe(notify(&#123; message: &apos;css task ok&apos; &#125;));</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">// æ£€æŸ¥js</div><div class="line">gulp.task(&apos;lint&apos;, function() &#123;</div><div class="line">  return gulp.src(&apos;src/js/*.js&apos;)</div><div class="line">    .pipe(jshint())</div><div class="line">    .pipe(jshint.reporter(&apos;default&apos;))</div><div class="line">    .pipe(notify(&#123; message: &apos;lint task ok&apos; &#125;));</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">// åˆå¹¶ã€å‹ç¼©jsæ–‡ä»¶</div><div class="line">gulp.task(&apos;js&apos;, function() &#123;</div><div class="line">  return gulp.src(&apos;src/js/*.js&apos;)</div><div class="line">    .pipe(concat(&apos;all.js&apos;))</div><div class="line">    .pipe(gulp.dest(&apos;dest/js&apos;))</div><div class="line">    .pipe(rename(&#123; suffix: &apos;.min&apos; &#125;))</div><div class="line">    .pipe(uglify())</div><div class="line">    .pipe(gulp.dest(&apos;dest/js&apos;))</div><div class="line">    .pipe(notify(&#123; message: &apos;js task ok&apos; &#125;));</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">// é»˜è®¤ä»»åŠ¡</div><div class="line">gulp.task(&apos;default&apos;, function()&#123;</div><div class="line">  gulp.run(&apos;img&apos;, &apos;css&apos;, &apos;lint&apos;, &apos;js&apos;, &apos;html&apos;);</div><div class="line"> </div><div class="line">  // ç›‘å¬htmlæ–‡ä»¶å˜åŒ–</div><div class="line">  gulp.watch(&apos;src/*.html&apos;, function()&#123;</div><div class="line">    gulp.run(&apos;html&apos;);</div><div class="line">  &#125;);</div><div class="line"> </div><div class="line">  // Watch .css files</div><div class="line">  gulp.watch(&apos;src/css/*.css&apos;, [&apos;css&apos;]);</div><div class="line"> </div><div class="line">  // Watch .js files</div><div class="line">  gulp.watch(&apos;src/js/*.js&apos;, [&apos;lint&apos;, &apos;js&apos;]);</div><div class="line"> </div><div class="line">  // Watch image files</div><div class="line">  gulp.watch(&apos;src/images/*&apos;, [&apos;img&apos;]);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[B+æ ‘ç´¢å¼•]]></title>
      <url>http://zsr.github.io/2016/08/18/B+%E6%A0%91%E7%B4%A2%E5%BC%95/</url>
      <content type="html"><![CDATA[<h2 id="Mysql-ç´¢å¼•åŸç†"><a href="#Mysql-ç´¢å¼•åŸç†" class="headerlink" title="Mysql ç´¢å¼•åŸç†"></a>Mysql ç´¢å¼•åŸç†</h2><h3 id="B-æ ‘"><a href="#B-æ ‘" class="headerlink" title="B-æ ‘"></a>B-æ ‘</h3><p>B-æ ‘,è¿™é‡Œçš„ B è¡¨ç¤º balance( å¹³è¡¡çš„æ„æ€),B-æ ‘æ˜¯ä¸€ç§å¤šè·¯è‡ªå¹³è¡¡çš„æœç´¢æ ‘<br>å®ƒç±»ä¼¼æ™®é€šçš„å¹³è¡¡äºŒå‰æ ‘ï¼Œä¸åŒçš„ä¸€ç‚¹æ˜¯B-æ ‘å…è®¸æ¯ä¸ªèŠ‚ç‚¹æœ‰æ›´å¤šçš„å­èŠ‚ç‚¹ã€‚ä¸‹å›¾æ˜¯ B-æ ‘çš„ç®€åŒ–å›¾.</p>
<p><img src="/images/B-æ ‘.jpg"></p>
<p>B-æ ‘æœ‰å¦‚ä¸‹ç‰¹ç‚¹:</p>
<ul>
<li>æ‰€æœ‰é”®å€¼åˆ†å¸ƒåœ¨æ•´é¢—æ ‘ä¸­ï¼›</li>
<li>ä»»ä½•ä¸€ä¸ªå…³é”®å­—å‡ºç°ä¸”åªå‡ºç°åœ¨ä¸€ä¸ªç»“ç‚¹ä¸­ï¼›</li>
<li>æœç´¢æœ‰å¯èƒ½åœ¨éå¶å­ç»“ç‚¹ç»“æŸï¼›</li>
<li>åœ¨å…³é”®å­—å…¨é›†å†…åšä¸€æ¬¡æŸ¥æ‰¾,æ€§èƒ½é€¼è¿‘äºŒåˆ†æŸ¥æ‰¾ï¼›</li>
</ul>
<h3 id="B-æ ‘-1"><a href="#B-æ ‘-1" class="headerlink" title="B+æ ‘"></a>B+æ ‘</h3><p>B+æ ‘æ˜¯B-æ ‘çš„å˜ä½“ï¼Œä¹Ÿæ˜¯ä¸€ç§å¤šè·¯æœç´¢æ ‘, å®ƒä¸B-æ ‘çš„ä¸åŒä¹‹å¤„åœ¨äº:</p>
<p>æ‰€æœ‰å…³é”®å­—å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹å‡ºç°,å†…éƒ¨èŠ‚ç‚¹(éå¶å­èŠ‚ç‚¹å¹¶ä¸å­˜å‚¨çœŸæ­£çš„data)<br>ä¸ºæ‰€æœ‰å¶å­ç»“ç‚¹å¢åŠ äº†ä¸€ä¸ªé“¾æŒ‡é’ˆ</p>
<p>ç®€åŒ– B+æ ‘ å¦‚ä¸‹å›¾</p>
<p><img src="/images/B+æ ‘.jpg"></p>
<h3 id="ä¸ºä»€ä¹ˆä½¿ç”¨B-B-Tree"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨B-B-Tree" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨B-/B+ Tree"></a>ä¸ºä»€ä¹ˆä½¿ç”¨B-/B+ Tree</h3><p>çº¢é»‘æ ‘ç­‰æ•°æ®ç»“æ„ä¹Ÿå¯ä»¥ç”¨æ¥å®ç°ç´¢å¼•ï¼Œä½†æ˜¯æ–‡ä»¶ç³»ç»ŸåŠæ•°æ®åº“ç³»ç»Ÿæ™®éé‡‡ç”¨B-/+Treeä½œä¸ºç´¢å¼•ç»“æ„ã€‚MySQL æ˜¯åŸºäºç£ç›˜çš„æ•°æ®åº“ç³»ç»Ÿ,ç´¢å¼•å¾€å¾€ä»¥ç´¢å¼•æ–‡ä»¶çš„å½¢å¼å­˜å‚¨çš„ç£ç›˜ä¸Š,ç´¢å¼•æŸ¥æ‰¾è¿‡ç¨‹ä¸­å°±è¦äº§ç”Ÿç£ç›˜I/Oæ¶ˆè€—,ç›¸å¯¹äºå†…å­˜å­˜å–ï¼ŒI/Oå­˜å–çš„æ¶ˆè€—è¦é«˜å‡ ä¸ªæ•°é‡çº§,ç´¢å¼•çš„ç»“æ„ç»„ç»‡è¦å°½é‡å‡å°‘æŸ¥æ‰¾è¿‡ç¨‹ä¸­ç£ç›˜I/Oçš„å­˜å–æ¬¡æ•°ã€‚ä¸ºä»€ä¹ˆä½¿ç”¨B-/+Treeï¼Œè¿˜è·Ÿç£ç›˜å­˜å–åŸç†æœ‰å…³ã€‚</p>
<h4 id="å±€éƒ¨æ€§åŸç†ä¸ç£ç›˜é¢„è¯»"><a href="#å±€éƒ¨æ€§åŸç†ä¸ç£ç›˜é¢„è¯»" class="headerlink" title="å±€éƒ¨æ€§åŸç†ä¸ç£ç›˜é¢„è¯»"></a>å±€éƒ¨æ€§åŸç†ä¸ç£ç›˜é¢„è¯»</h4><p>ç£ç›˜è¯»å–æ•°æ®é çš„æ˜¯æœºæ¢°è¿åŠ¨ï¼Œæ¯æ¬¡è¯»å–æ•°æ®èŠ±è´¹çš„æ—¶é—´å¯ä»¥åˆ†ä¸ºå¯»é“æ—¶é—´ã€æ—‹è½¬å»¶è¿Ÿã€ä¼ è¾“æ—¶é—´ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå¯»é“æ—¶é—´æŒ‡çš„æ˜¯ç£è‡‚ç§»åŠ¨åˆ°æŒ‡å®šç£é“æ‰€éœ€è¦çš„æ—¶é—´ï¼Œä¸»æµç£ç›˜ä¸€èˆ¬åœ¨5msä»¥ä¸‹ï¼›æ—‹è½¬å»¶è¿Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸å¬è¯´çš„ç£ç›˜è½¬é€Ÿï¼Œæ¯”å¦‚ä¸€ä¸ªç£ç›˜7200è½¬ï¼Œè¡¨ç¤ºæ¯åˆ†é’Ÿèƒ½è½¬7200æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´1ç§’é’Ÿèƒ½è½¬120æ¬¡ï¼Œæ—‹è½¬å»¶è¿Ÿå°±æ˜¯1/120/2 = 4.17msï¼›ä¼ è¾“æ—¶é—´æŒ‡çš„æ˜¯ä»ç£ç›˜è¯»å‡ºæˆ–å°†æ•°æ®å†™å…¥ç£ç›˜çš„æ—¶é—´ï¼Œä¸€èˆ¬åœ¨é›¶ç‚¹å‡ æ¯«ç§’ï¼Œç›¸å¯¹äºå‰ä¸¤ä¸ªæ—¶é—´å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚é‚£ä¹ˆè®¿é—®ä¸€æ¬¡ç£ç›˜çš„æ—¶é—´ï¼Œå³ä¸€æ¬¡ç£ç›˜IOçš„æ—¶é—´çº¦ç­‰äº5+4.17 = 9mså·¦å³ï¼Œå¬èµ·æ¥è¿˜æŒºä¸é”™çš„ï¼Œä½†è¦çŸ¥é“ä¸€å°500 -MIPSçš„æœºå™¨æ¯ç§’å¯ä»¥æ‰§è¡Œ5äº¿æ¡æŒ‡ä»¤ï¼Œå› ä¸ºæŒ‡ä»¤ä¾é çš„æ˜¯ç”µçš„æ€§è´¨ï¼Œæ¢å¥è¯è¯´æ‰§è¡Œä¸€æ¬¡IOçš„æ—¶é—´å¯ä»¥æ‰§è¡Œ40ä¸‡æ¡æŒ‡ä»¤ï¼Œæ•°æ®åº“åŠ¨è¾„åä¸‡ç™¾ä¸‡ä¹ƒè‡³åƒä¸‡çº§æ•°æ®ï¼Œæ¯æ¬¡9æ¯«ç§’çš„æ—¶é—´ï¼Œæ˜¾ç„¶æ˜¯ä¸ªç¾éš¾ã€‚</p>
<p>ç”±äºç£ç›˜çš„å­˜å–é€Ÿåº¦ä¸å†…å­˜ä¹‹é—´é¸¿æ²Ÿ(è®¿é—®ç£ç›˜çš„æˆæœ¬å¤§æ¦‚æ˜¯è®¿é—®å†…å­˜çš„åä¸‡å€å·¦å³),ä¸ºäº†æé«˜æ•ˆç‡,è¦å°½é‡å‡å°‘ç£ç›˜I/O.ç£ç›˜å¾€å¾€ä¸æ˜¯ä¸¥æ ¼æŒ‰éœ€è¯»å–ï¼Œè€Œæ˜¯æ¯æ¬¡éƒ½ä¼šé¢„è¯»,ç£ç›˜è¯»å–å®Œéœ€è¦çš„æ•°æ®,ä¼šé¡ºåºå‘åè¯»ä¸€å®šé•¿åº¦çš„æ•°æ®æ”¾å…¥å†…å­˜ã€‚è€Œè¿™æ ·åšçš„ç†è®ºä¾æ®æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­è‘—åçš„å±€éƒ¨æ€§åŸç†ï¼š</p>
<ul>
<li>å½“ä¸€ä¸ªæ•°æ®è¢«ç”¨åˆ°æ—¶ï¼Œå…¶é™„è¿‘çš„æ•°æ®ä¹Ÿé€šå¸¸ä¼šé©¬ä¸Šè¢«ä½¿ç”¨</li>
<li>ç¨‹åºè¿è¡ŒæœŸé—´æ‰€éœ€è¦çš„æ•°æ®é€šå¸¸æ¯”è¾ƒé›†ä¸­</li>
</ul>
<p>ç”±äºç£ç›˜é¡ºåºè¯»å–çš„æ•ˆç‡å¾ˆé«˜(ä¸éœ€è¦å¯»é“æ—¶é—´ï¼Œåªéœ€å¾ˆå°‘çš„æ—‹è½¬æ—¶é—´)ï¼Œå› æ­¤å¯¹äºå…·æœ‰å±€éƒ¨æ€§çš„ç¨‹åºæ¥è¯´ï¼Œé¢„è¯»å¯ä»¥æé«˜I/Oæ•ˆç‡.é¢„è¯»çš„é•¿åº¦ä¸€èˆ¬ä¸ºé¡µ(page)çš„æ•´å€æ•°ã€‚</p>
<p><strong>MySQL(é»˜è®¤ä½¿ç”¨InnoDBå¼•æ“),å°†è®°å½•æŒ‰ç…§é¡µçš„æ–¹å¼è¿›è¡Œç®¡ç†,æ¯é¡µå¤§å°é»˜è®¤ä¸º16K(è¿™ä¸ªå€¼å¯ä»¥ä¿®æ”¹).linux é»˜è®¤é¡µå¤§å°ä¸º4K(æ¯ä¸€æ¬¡IOè¯»å–çš„æ•°æ®ç§°ä¹‹ä¸ºä¸€é¡µ)</strong></p>
<h3 id="B-Treeç´¢å¼•çš„æ€§èƒ½åˆ†æ"><a href="#B-Treeç´¢å¼•çš„æ€§èƒ½åˆ†æ" class="headerlink" title="B-/+Treeç´¢å¼•çš„æ€§èƒ½åˆ†æ"></a>B-/+Treeç´¢å¼•çš„æ€§èƒ½åˆ†æ</h3><p>å®é™…å®ç°B-Treeè¿˜éœ€è¦ä½¿ç”¨å¦‚ä¸‹æŠ€å·§ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">æ¯æ¬¡æ–°å»ºèŠ‚ç‚¹æ—¶ï¼Œç›´æ¥ç”³è¯·ä¸€ä¸ªé¡µçš„ç©ºé—´ï¼Œè¿™æ ·å°±ä¿è¯ä¸€ä¸ªèŠ‚ç‚¹ç‰©ç†ä¸Šä¹Ÿå­˜å‚¨åœ¨ä¸€ä¸ªé¡µé‡Œï¼ŒåŠ ä¹‹è®¡ç®—æœºå­˜å‚¨åˆ†é…éƒ½æ˜¯æŒ‰é¡µå¯¹é½çš„ï¼Œå°±å®ç°äº†ä¸€ä¸ªç»“ç‚¹åªéœ€ä¸€æ¬¡I/Oã€‚</div><div class="line">å‡è®¾ B-Tree çš„é«˜åº¦ä¸º h,B-Treeä¸­ä¸€æ¬¡æ£€ç´¢æœ€å¤šéœ€è¦h-1æ¬¡I/Oï¼ˆæ ¹èŠ‚ç‚¹å¸¸é©»å†…å­˜ï¼‰ï¼Œæ¸è¿›å¤æ‚åº¦ä¸ºO(h)=O(logdN)O(h)=O(logdN)ã€‚ä¸€èˆ¬å®é™…åº”ç”¨ä¸­ï¼Œå‡ºåº¦dæ˜¯éå¸¸å¤§çš„æ•°å­—ï¼Œé€šå¸¸è¶…è¿‡100ï¼Œå› æ­¤héå¸¸å°ï¼ˆé€šå¸¸ä¸è¶…è¿‡3ï¼‰ã€‚</div><div class="line">è€Œçº¢é»‘æ ‘è¿™ç§ç»“æ„ï¼Œhæ˜æ˜¾è¦æ·±çš„å¤šã€‚ç”±äºé€»è¾‘ä¸Šå¾ˆè¿‘çš„èŠ‚ç‚¹ï¼ˆçˆ¶å­ï¼‰ç‰©ç†ä¸Šå¯èƒ½å¾ˆè¿œï¼Œæ— æ³•åˆ©ç”¨å±€éƒ¨æ€§ï¼Œæ‰€ä»¥çº¢é»‘æ ‘çš„I/Oæ¸è¿›å¤æ‚åº¦ä¹Ÿä¸ºO(h)ï¼Œæ•ˆç‡æ˜æ˜¾æ¯”B-Treeå·®å¾ˆå¤šã€‚</div></pre></td></tr></table></figure>
<h3 id="ä¸ºä»€ä¹ˆä½¿ç”¨-B-æ ‘"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨-B-æ ‘" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨ B+æ ‘"></a>ä¸ºä»€ä¹ˆä½¿ç”¨ B+æ ‘</h3><ul>
<li>B+æ ‘æ›´é€‚åˆå¤–éƒ¨å­˜å‚¨,ç”±äºå†…èŠ‚ç‚¹æ— <code>data</code>åŸŸ,ä¸€ä¸ªç»“ç‚¹å¯ä»¥å­˜å‚¨æ›´å¤šçš„å†…ç»“ç‚¹,æ¯ä¸ªèŠ‚ç‚¹èƒ½ç´¢å¼•çš„èŒƒå›´æ›´å¤§æ›´ç²¾ç¡®,ä¹Ÿæ„å‘³ç€ B+æ ‘å•æ¬¡ç£ç›˜IOçš„ä¿¡æ¯é‡å¤§äºB-æ ‘,I/Oæ•ˆç‡æ›´é«˜ã€‚</li>
<li>Mysqlæ˜¯ä¸€ç§å…³ç³»å‹æ•°æ®åº“ï¼ŒåŒºé—´è®¿é—®æ˜¯å¸¸è§çš„ä¸€ç§æƒ…å†µï¼ŒB+æ ‘å¶èŠ‚ç‚¹å¢åŠ çš„é“¾æŒ‡é’ˆ,åŠ å¼ºäº†åŒºé—´è®¿é—®æ€§ï¼Œå¯ä½¿ç”¨åœ¨èŒƒå›´åŒºé—´æŸ¥è¯¢ç­‰ï¼Œè€ŒB-æ ‘æ¯ä¸ªèŠ‚ç‚¹ key å’Œ data åœ¨ä¸€èµ·ï¼Œåˆ™æ— æ³•åŒºé—´æŸ¥æ‰¾ã€‚</li>
</ul>
<h3 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a>å‚è€ƒï¼š</h3><p><a href="https://segmentfault.com/a/1190000004690721" target="_blank" rel="external">MySQLç´¢å¼•ç»“æ„</a></p>
<p><a href="http://blog.codinglabs.org/articles/theory-of-mysql-index.html" target="_blank" rel="external">MySQLç´¢å¼•èƒŒåçš„æ•°æ®ç»“æ„åŠç®—æ³•åŸç†</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[mysql é”]]></title>
      <url>http://zsr.github.io/2016/08/18/mysql-%E9%94%81/</url>
      <content type="html"><![CDATA[<h2 id="mysql-é”æœºåˆ¶"><a href="#mysql-é”æœºåˆ¶" class="headerlink" title="mysql é”æœºåˆ¶"></a>mysql é”æœºåˆ¶</h2><p>æ•°æ®åº“ä¸ºäº†ç»´æŠ¤äº‹åŠ¡çš„æ€§è´¨ï¼Œå°¤å…¶æ˜¯ä¸€è‡´æ€§å’Œéš”ç¦»æ€§ï¼Œä¸€èˆ¬ä½¿ç”¨åŠ é”è¿™ç§æ–¹å¼ã€‚åŒæ—¶æ•°æ®åº“åˆæ˜¯ä¸ªé«˜å¹¶å‘çš„åº”ç”¨ï¼ŒåŒä¸€æ—¶é—´ä¼šæœ‰å¤§é‡çš„å¹¶å‘è®¿é—®ï¼Œå¦‚æœåŠ é”è¿‡åº¦ï¼Œä¼šæå¤§çš„é™ä½å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚æ‰€ä»¥å¯¹äºåŠ é”çš„å¤„ç†ï¼Œå¯ä»¥è¯´å°±æ˜¯æ•°æ®åº“å¯¹äºäº‹åŠ¡å¤„ç†çš„ç²¾é«“æ‰€åœ¨ã€‚</p>
<h3 id="æ‚²è§‚é”å’Œä¹è§‚é”"><a href="#æ‚²è§‚é”å’Œä¹è§‚é”" class="headerlink" title="æ‚²è§‚é”å’Œä¹è§‚é”"></a>æ‚²è§‚é”å’Œä¹è§‚é”</h3><ul>
<li><p>æ‚²è§‚é”</p>
<p>æ­£å¦‚å…¶åï¼Œå®ƒæŒ‡çš„æ˜¯å¯¹æ•°æ®è¢«å¤–ç•Œï¼ˆåŒ…æ‹¬æœ¬ç³»ç»Ÿå½“å‰çš„å…¶ä»–äº‹åŠ¡ï¼Œä»¥åŠæ¥è‡ªå¤–éƒ¨ç³»ç»Ÿçš„äº‹åŠ¡å¤„ç†ï¼‰ä¿®æ”¹æŒä¿å®ˆæ€åº¦ï¼Œå› æ­¤ï¼Œåœ¨æ•´ä¸ªæ•°æ®å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå°†æ•°æ®å¤„äºé”å®šçŠ¶æ€ã€‚æ‚²è§‚é”çš„å®ç°ï¼Œå¾€å¾€ä¾é æ•°æ®åº“æä¾›çš„é”æœºåˆ¶ï¼ˆä¹Ÿåªæœ‰æ•°æ®åº“å±‚æä¾›çš„é”æœºåˆ¶æ‰èƒ½çœŸæ­£ä¿è¯æ•°æ®è®¿é—®çš„æ’ä»–æ€§ï¼Œå¦åˆ™ï¼Œå³ä½¿åœ¨æœ¬ç³»ç»Ÿä¸­å®ç°äº†åŠ é”æœºåˆ¶ï¼Œä¹Ÿæ— æ³•ä¿è¯å¤–éƒ¨ç³»ç»Ÿä¸ä¼šä¿®æ”¹æ•°æ®ï¼‰ã€‚</p>
<p>åœ¨æ‚²è§‚é”çš„æƒ…å†µä¸‹ï¼Œä¸ºäº†ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ€§ï¼Œå°±éœ€è¦ä¸€è‡´æ€§é”å®šè¯»ã€‚è¯»å–æ•°æ®æ—¶ç»™åŠ é”ï¼Œå…¶å®ƒäº‹åŠ¡æ— æ³•ä¿®æ”¹è¿™äº›æ•°æ®ã€‚ä¿®æ”¹åˆ é™¤æ•°æ®æ—¶ä¹Ÿè¦åŠ é”ï¼Œå…¶å®ƒäº‹åŠ¡æ— æ³•è¯»å–è¿™äº›æ•°æ®ã€‚</p>
</li>
<li><p>ä¹è§‚é”</p>
<p>ç›¸å¯¹æ‚²è§‚é”è€Œè¨€ï¼Œä¹è§‚é”æœºåˆ¶é‡‡å–äº†æ›´åŠ å®½æ¾çš„åŠ é”æœºåˆ¶ã€‚æ‚²è§‚é”å¤§å¤šæ•°æƒ…å†µä¸‹ä¾é æ•°æ®åº“çš„é”æœºåˆ¶å®ç°ï¼Œä»¥ä¿è¯æ“ä½œæœ€å¤§ç¨‹åº¦çš„ç‹¬å æ€§ã€‚ä½†éšä¹‹è€Œæ¥çš„å°±æ˜¯æ•°æ®åº“æ€§èƒ½çš„å¤§é‡å¼€é”€ï¼Œç‰¹åˆ«æ˜¯å¯¹é•¿äº‹åŠ¡è€Œè¨€ï¼Œè¿™æ ·çš„å¼€é”€å¾€å¾€æ— æ³•æ‰¿å—ã€‚</p>
</li>
</ul>
<p>ä¹è§‚é”ï¼Œå¤§å¤šæ˜¯åŸºäºæ•°æ®ç‰ˆæœ¬ï¼ˆ Version ï¼‰è®°å½•æœºåˆ¶å®ç°ã€‚æ•°æ®ç‰ˆæœ¬:å³ä¸ºæ•°æ®å¢åŠ ä¸€ä¸ªç‰ˆæœ¬æ ‡è¯†ï¼Œåœ¨åŸºäºæ•°æ®åº“è¡¨çš„ç‰ˆæœ¬è§£å†³æ–¹æ¡ˆä¸­ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡ä¸ºæ•°æ®åº“è¡¨å¢åŠ ä¸€ä¸ª â€œversionâ€ å­—æ®µæ¥å®ç°ã€‚è¯»å–å‡ºæ•°æ®æ—¶ï¼Œå°†æ­¤ç‰ˆæœ¬å·ä¸€åŒè¯»å‡ºï¼Œä¹‹åæ›´æ–°æ—¶ï¼Œå¯¹æ­¤ç‰ˆæœ¬å·åŠ ä¸€ã€‚æ­¤æ—¶ï¼Œå°†æäº¤æ•°æ®çš„ç‰ˆæœ¬æ•°æ®ä¸æ•°æ®åº“è¡¨å¯¹åº”è®°å½•çš„å½“å‰ç‰ˆæœ¬ä¿¡æ¯è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœæäº¤çš„æ•°æ®ç‰ˆæœ¬å·å¤§äºæ•°æ®åº“è¡¨å½“å‰ç‰ˆæœ¬å·ï¼Œåˆ™äºˆä»¥æ›´æ–°ï¼Œå¦åˆ™è®¤ä¸ºæ˜¯è¿‡æœŸæ•°æ®ã€‚</p>
<h3 id="å¤šç‰ˆæœ¬çš„å¹¶å‘æ§åˆ¶åè®®-ä»¥ä¹è§‚é”ä¸ºç†è®ºåŸºç¡€"><a href="#å¤šç‰ˆæœ¬çš„å¹¶å‘æ§åˆ¶åè®®-ä»¥ä¹è§‚é”ä¸ºç†è®ºåŸºç¡€" class="headerlink" title="å¤šç‰ˆæœ¬çš„å¹¶å‘æ§åˆ¶åè®®(ä»¥ä¹è§‚é”ä¸ºç†è®ºåŸºç¡€)"></a>å¤šç‰ˆæœ¬çš„å¹¶å‘æ§åˆ¶åè®®(ä»¥ä¹è§‚é”ä¸ºç†è®ºåŸºç¡€)</h3><p>MySQL InnoDBå­˜å‚¨å¼•æ“ï¼Œå®ç°çš„æ˜¯åŸºäºå¤šç‰ˆæœ¬çš„å¹¶å‘æ§åˆ¶åè®®â€”â€”MVCC (Multi-Version Concurrency Control) (æ³¨ï¼šä¸MVCCç›¸å¯¹çš„ï¼Œæ˜¯åŸºäºé”çš„å¹¶å‘æ§åˆ¶ï¼ŒLock-Based Concurrency Control)ã€‚MVCCæœ€å¤§çš„å¥½å¤„ï¼šè¯»ä¸åŠ é”ï¼Œè¯»å†™ä¸å†²çªã€‚åœ¨è¯»å¤šå†™å°‘çš„OLTPåº”ç”¨ä¸­ï¼Œè¯»å†™ä¸å†²çªæ˜¯éå¸¸é‡è¦çš„ï¼Œæå¤§çš„å¢åŠ äº†ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½ï¼Œç°é˜¶æ®µå‡ ä¹æ‰€æœ‰çš„RDBMSï¼Œéƒ½æ”¯æŒäº†MVCCã€‚</p>
<p>åœ¨MVCCå¹¶å‘æ§åˆ¶ä¸­ï¼Œè¯»æ“ä½œå¯ä»¥åˆ†æˆä¸¤ç±»ï¼šå¿«ç…§è¯» (snapshot read)ä¸å½“å‰è¯» (current read)ã€‚å¿«ç…§è¯»ï¼Œè¯»å–çš„æ˜¯è®°å½•çš„å¯è§ç‰ˆæœ¬ (æœ‰å¯èƒ½æ˜¯å†å²ç‰ˆæœ¬)ï¼Œä¸ç”¨åŠ é”ã€‚å½“å‰è¯»ï¼Œè¯»å–çš„æ˜¯è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶ä¸”ï¼Œå½“å‰è¯»è¿”å›çš„è®°å½•ï¼Œéƒ½ä¼šåŠ ä¸Šé”ï¼Œä¿è¯å…¶ä»–äº‹åŠ¡ä¸ä¼šå†å¹¶å‘ä¿®æ”¹è¿™æ¡è®°å½•ã€‚</p>
<p>ä»¥MySQL InnoDBä¸ºä¾‹ï¼š</p>
<ul>
<li>å¿«ç…§è¯»ï¼šç®€å•çš„selectæ“ä½œï¼Œå±äºå¿«ç…§è¯»ï¼Œä¸åŠ é”ã€‚(å½“ç„¶ï¼Œä¹Ÿæœ‰ä¾‹å¤–ï¼Œä¸‹é¢ä¼šåˆ†æ)<ul>
<li>select * from table where ?;</li>
</ul>
</li>
<li><p>å½“å‰è¯»ï¼šç‰¹æ®Šçš„è¯»æ“ä½œï¼Œæ’å…¥/æ›´æ–°/åˆ é™¤æ“ä½œï¼Œå±äºå½“å‰è¯»ï¼Œéœ€è¦åŠ é”ã€‚</p>
<ul>
<li>select * from table where ? lock in share mode;</li>
<li>select * from table where ? for update;</li>
<li>insert into table values (â€¦);</li>
<li>update table set ? where ?;</li>
<li>delete from table where ?;</li>
</ul>
<p>æ‰€æœ‰ä»¥ä¸Šçš„è¯­å¥ï¼Œéƒ½å±äºå½“å‰è¯»ï¼Œè¯»å–è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ã€‚å¹¶ä¸”ï¼Œè¯»å–ä¹‹åï¼Œè¿˜éœ€è¦ä¿è¯å…¶ä»–å¹¶å‘äº‹åŠ¡ä¸èƒ½ä¿®æ”¹å½“å‰è®°å½•ï¼Œå¯¹è¯»å–è®°å½•åŠ é”ã€‚å…¶ä¸­ï¼Œé™¤äº†ç¬¬ä¸€æ¡è¯­å¥ï¼Œå¯¹è¯»å–è®°å½•åŠ Sé” (å…±äº«é”)å¤–ï¼Œå…¶ä»–çš„æ“ä½œï¼Œéƒ½åŠ çš„æ˜¯Xé” (æ’å®ƒé”)ã€‚</p>
</li>
</ul>
<p>æ’å…¥/æ›´æ–°/åˆ é™¤ æ“ä½œï¼Œéƒ½å½’ä¸ºå½“å‰è¯».å¦‚æ›´æ–° æ“ä½œï¼Œåœ¨æ•°æ®åº“ä¸­çš„æ‰§è¡Œæµç¨‹ï¼š</p>
<p><img src="/images/mysqlé”æœºåˆ¶1-1.jpg"></p>
<p>ä»å›¾ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªUpdateæ“ä½œçš„å…·ä½“æµç¨‹ã€‚å½“Update SQLè¢«å‘ç»™MySQLåï¼ŒMySQL Serverä¼šæ ¹æ®whereæ¡ä»¶ï¼Œè¯»å–ç¬¬ä¸€æ¡æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œç„¶åInnoDBå¼•æ“ä¼šå°†ç¬¬ä¸€æ¡è®°å½•è¿”å›ï¼Œå¹¶åŠ é” (current read)ã€‚å¾…MySQL Serveræ”¶åˆ°è¿™æ¡åŠ é”çš„è®°å½•ä¹‹åï¼Œä¼šå†å‘èµ·ä¸€ä¸ªUpdateè¯·æ±‚ï¼Œæ›´æ–°è¿™æ¡è®°å½•ã€‚ä¸€æ¡è®°å½•æ“ä½œå®Œæˆï¼Œå†è¯»å–ä¸‹ä¸€æ¡è®°å½•ï¼Œç›´è‡³æ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„è®°å½•ä¸ºæ­¢ã€‚å› æ­¤ï¼ŒUpdateæ“ä½œå†…éƒ¨ï¼Œå°±åŒ…å«äº†ä¸€ä¸ªå½“å‰è¯»ã€‚åŒç†ï¼ŒDeleteæ“ä½œä¹Ÿä¸€æ ·ã€‚Insertæ“ä½œä¼šç¨å¾®æœ‰äº›ä¸åŒï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯Insertæ“ä½œå¯èƒ½ä¼šè§¦å‘Unique Keyçš„å†²çªæ£€æŸ¥ï¼Œä¹Ÿä¼šè¿›è¡Œä¸€ä¸ªå½“å‰è¯»ã€‚</p>
<p><strong>æ³¨ï¼šæ ¹æ®ä¸Šå›¾çš„äº¤äº’ï¼Œé’ˆå¯¹ä¸€æ¡å½“å‰è¯»çš„SQLè¯­å¥ï¼ŒInnoDBä¸MySQL Serverçš„äº¤äº’ï¼Œæ˜¯ä¸€æ¡ä¸€æ¡è¿›è¡Œçš„ï¼Œå› æ­¤ï¼ŒåŠ é”ä¹Ÿæ˜¯ä¸€æ¡ä¸€æ¡è¿›è¡Œçš„ã€‚å…ˆå¯¹ä¸€æ¡æ»¡è¶³æ¡ä»¶çš„è®°å½•åŠ é”ï¼Œè¿”å›ç»™MySQL Serverï¼Œåšä¸€äº›DMLæ“ä½œ(æ•°æ®æ“çºµè¯­è¨€DML:insert, update, delete)ï¼›ç„¶ååœ¨è¯»å–ä¸‹ä¸€æ¡åŠ é”ï¼Œç›´è‡³è¯»å–å®Œæ¯•ã€‚</strong></p>
<a id="more"></a>
<h4 id="MVCCåœ¨MySQLçš„InnoDBä¸­çš„å®ç°"><a href="#MVCCåœ¨MySQLçš„InnoDBä¸­çš„å®ç°" class="headerlink" title="MVCCåœ¨MySQLçš„InnoDBä¸­çš„å®ç°"></a>MVCCåœ¨MySQLçš„InnoDBä¸­çš„å®ç°</h4><p>åœ¨InnoDBä¸­ï¼Œä¼šåœ¨æ¯è¡Œæ•°æ®åæ·»åŠ ä¸¤ä¸ªé¢å¤–çš„éšè—çš„å€¼æ¥å®ç°MVCCï¼Œè¿™ä¸¤ä¸ªå€¼ä¸€ä¸ªè®°å½•è¿™è¡Œæ•°æ®ä½•æ—¶è¢«åˆ›å»ºï¼Œå¦å¤–ä¸€ä¸ªè®°å½•è¿™è¡Œæ•°æ®ä½•æ—¶è¿‡æœŸï¼ˆæˆ–è€…è¢«åˆ é™¤ï¼‰ã€‚ åœ¨å®é™…æ“ä½œä¸­ï¼Œå­˜å‚¨çš„å¹¶ä¸æ˜¯æ—¶é—´ï¼Œè€Œæ˜¯äº‹åŠ¡çš„ç‰ˆæœ¬å·(<strong>åˆ†åˆ«è¡¨ç¤ºè¯¥è¡Œåˆ›å»ºçš„ç‰ˆæœ¬å’Œåˆ é™¤çš„ç‰ˆæœ¬</strong>)ï¼Œæ¯å¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡ï¼Œäº‹åŠ¡çš„ç‰ˆæœ¬å·å°±ä¼šé€’å¢ã€‚ åœ¨å¯é‡è¯»Repeatable readsäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼š</p>
<ul>
<li>SELECTæ—¶:æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶innodbä¼šè¿”å›è¯¥è¡Œæ•°æ®ï¼š1)è¯»å–åˆ›å»ºç‰ˆæœ¬å·&lt;=å½“å‰äº‹åŠ¡ç‰ˆæœ¬å·,2)åˆ é™¤ç‰ˆæœ¬å·ä¸ºç©ºæˆ–&gt;å½“å‰äº‹åŠ¡ç‰ˆæœ¬å·ã€‚</li>
<li>INSERTæ—¶:å°†æ–°æ’å…¥çš„è¡Œçš„åˆ›å»ºç‰ˆæœ¬å·è®¾ç½®ä¸ºå½“å‰ç³»ç»Ÿçš„ç‰ˆæœ¬å·ã€‚</li>
<li>DELETEæ—¶:å°†è¦åˆ é™¤çš„è¡Œçš„åˆ é™¤ç‰ˆæœ¬å·è®¾ç½®ä¸ºå½“å‰ç³»ç»Ÿçš„ç‰ˆæœ¬å·ã€‚</li>
<li>UPDATEæ—¶:ä¸æ‰§è¡ŒåŸåœ°updateï¼Œè€Œæ˜¯è½¬æ¢æˆinsert + deleteã€‚å°†æ—§è¡Œçš„åˆ é™¤ç‰ˆæœ¬å·è®¾ç½®ä¸ºå½“å‰ç‰ˆæœ¬å·ï¼Œå¹¶å°†æ–°è¡ŒinsertåŒæ—¶è®¾ç½®åˆ›å»ºç‰ˆæœ¬å·ä¸ºå½“å‰ç‰ˆæœ¬å·ã€‚</li>
</ul>
<p>å…¶ä¸­ï¼Œå†™æ“ä½œï¼ˆinsertã€deleteå’Œupdateï¼‰æ‰§è¡Œæ—¶ï¼Œéœ€è¦å°†ç³»ç»Ÿç‰ˆæœ¬å·é€’å¢ã€‚<br>ç”±äºæ—§æ•°æ®å¹¶ä¸çœŸæ­£çš„åˆ é™¤ï¼Œæ‰€ä»¥å¿…é¡»å¯¹è¿™äº›æ•°æ®è¿›è¡Œæ¸…ç†ï¼Œinnodbä¼šå¼€å¯ä¸€ä¸ªåå°çº¿ç¨‹æ‰§è¡Œæ¸…ç†å·¥ä½œï¼Œå…·ä½“çš„è§„åˆ™æ˜¯å°†åˆ é™¤ç‰ˆæœ¬å·å°äºå½“å‰ç³»ç»Ÿç‰ˆæœ¬çš„è¡Œåˆ é™¤ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšpurgeã€‚</p>
<p>é€šè¿‡MVCCï¼Œè™½ç„¶æ¯è¡Œè®°å½•éƒ½éœ€è¦é¢å¤–çš„å­˜å‚¨ç©ºé—´ï¼Œæ›´å¤šçš„è¡Œæ£€æŸ¥å·¥ä½œä»¥åŠä¸€äº›é¢å¤–çš„ç»´æŠ¤å·¥ä½œï¼Œä½†å¯ä»¥å‡å°‘é”çš„ä½¿ç”¨ï¼Œå¤§å¤šæ•°è¯»æ“ä½œéƒ½ä¸ç”¨åŠ é”ï¼Œè¯»æ•°æ®æ“ä½œå¾ˆç®€å•ï¼Œæ€§èƒ½å¾ˆå¥½ï¼Œå¹¶ä¸”ä¹Ÿèƒ½ä¿è¯åªä¼šè¯»å–åˆ°ç¬¦åˆæ ‡å‡†çš„è¡Œï¼Œä¹Ÿåªé”ä½å¿…è¦è¡Œã€‚</p>
<h3 id="ä¸¤æ®µé”"><a href="#ä¸¤æ®µé”" class="headerlink" title="ä¸¤æ®µé”"></a>ä¸¤æ®µé”</h3><p>æ•°æ®åº“éµå¾ªçš„æ˜¯ä¸¤æ®µé”åè®®ï¼Œå°†äº‹åŠ¡åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼ŒåŠ é”é˜¶æ®µå’Œè§£é”é˜¶æ®µ</p>
<p>åŠ é”é˜¶æ®µï¼šåœ¨è¯¥é˜¶æ®µå¯ä»¥è¿›è¡ŒåŠ é”æ“ä½œã€‚åœ¨å¯¹ä»»ä½•æ•°æ®è¿›è¡Œè¯»æ“ä½œä¹‹å‰è¦ç”³è¯·å¹¶è·å¾—Sé”ï¼ˆå…±äº«é”ï¼Œå…¶å®ƒäº‹åŠ¡å¯ä»¥ç»§ç»­åŠ å…±äº«é”ï¼Œä½†ä¸èƒ½åŠ æ’å®ƒé”ï¼‰ï¼Œåœ¨è¿›è¡Œå†™æ“ä½œä¹‹å‰è¦ç”³è¯·å¹¶è·å¾—Xé”ï¼ˆæ’å®ƒé”ï¼Œå…¶å®ƒäº‹åŠ¡ä¸èƒ½å†è·å¾—ä»»ä½•é”ï¼‰ã€‚åŠ é”ä¸æˆåŠŸï¼Œåˆ™äº‹åŠ¡è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°åŠ é”æˆåŠŸæ‰ç»§ç»­æ‰§è¡Œã€‚<br>è§£é”é˜¶æ®µï¼šå½“äº‹åŠ¡é‡Šæ”¾äº†ä¸€ä¸ªå°é”ä»¥åï¼Œäº‹åŠ¡è¿›å…¥è§£é”é˜¶æ®µï¼Œåœ¨è¯¥é˜¶æ®µåªèƒ½è¿›è¡Œè§£é”æ“ä½œä¸èƒ½å†è¿›è¡ŒåŠ é”æ“ä½œã€‚</p>
<p>ä»¥mysqlä¸ºä¾‹ï¼š</p>
<p><img src="/images/mysqlé”æœºåˆ¶1-2.jpg"></p>
<p>ä¸¤æ®µé”åè®®å¯ä»¥ä¿è¯äº‹åŠ¡çš„å¹¶å‘è°ƒåº¦æ˜¯ä¸²è¡ŒåŒ–ï¼ŒåŠ é”é˜¶æ®µï¼šåªåŠ é”ï¼Œä¸æ”¾é”ã€‚è§£é”é˜¶æ®µï¼šåªæ”¾é”ï¼Œä¸åŠ é”ã€‚</p>
<h3 id="äº‹åŠ¡çš„å››ç§éš”ç¦»çº§åˆ«"><a href="#äº‹åŠ¡çš„å››ç§éš”ç¦»çº§åˆ«" class="headerlink" title="äº‹åŠ¡çš„å››ç§éš”ç¦»çº§åˆ«"></a>äº‹åŠ¡çš„å››ç§éš”ç¦»çº§åˆ«</h3><p>äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">éš”ç¦»çº§åˆ«</th>
<th style="text-align:center">è„è¯»ï¼ˆDirty Read)</th>
<th style="text-align:center">ä¸å¯é‡å¤è¯»ï¼ˆNonRepeatable Read)</th>
<th style="text-align:center">å¹»è¯»ï¼ˆPhantom Read)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">æœªæäº¤è¯»ï¼ˆRead uncommittedï¼‰</td>
<td style="text-align:center">å¯èƒ½</td>
<td style="text-align:center">å¯èƒ½</td>
<td style="text-align:center">å¯èƒ½</td>
</tr>
<tr>
<td style="text-align:center">å·²æäº¤è¯»ï¼ˆRead committedï¼‰</td>
<td style="text-align:center">ä¸å¯èƒ½</td>
<td style="text-align:center">å¯èƒ½</td>
<td style="text-align:center">å¯èƒ½</td>
</tr>
<tr>
<td style="text-align:center">å¯é‡å¤è¯»ï¼ˆRepeatable readï¼‰</td>
<td style="text-align:center">ä¸å¯èƒ½</td>
<td style="text-align:center">ä¸å¯èƒ½</td>
<td style="text-align:center">å¯èƒ½</td>
</tr>
<tr>
<td style="text-align:center">å¯ä¸²è¡ŒåŒ–ï¼ˆSerializable ï¼‰</td>
<td style="text-align:center">ä¸å¯èƒ½</td>
<td style="text-align:center">ä¸å¯èƒ½</td>
<td style="text-align:center">ä¸å¯èƒ½</td>
</tr>
</tbody>
</table>
<ul>
<li>æœªæäº¤è¯»(Read Uncommitted)ï¼šå…è®¸è„è¯»ï¼Œä¹Ÿå°±æ˜¯å¯èƒ½è¯»å–åˆ°å…¶ä»–ä¼šè¯ä¸­æœªæäº¤äº‹åŠ¡ä¿®æ”¹çš„æ•°æ®</li>
<li>æäº¤è¯»(Read Committed)ï¼šåªèƒ½è¯»å–åˆ°å·²ç»æäº¤çš„æ•°æ®ã€‚Oracleç­‰å¤šæ•°æ•°æ®åº“é»˜è®¤éƒ½æ˜¯è¯¥çº§åˆ« (ä¸é‡å¤è¯»);é’ˆå¯¹å½“å‰è¯»ï¼ŒRCéš”ç¦»çº§åˆ«ä¿è¯å¯¹è¯»å–åˆ°çš„è®°å½•åŠ é” (è®°å½•é”)ï¼Œå­˜åœ¨å¹»è¯»ç°è±¡ã€‚</li>
<li>å¯é‡å¤è¯»(Repeated Read)ï¼šå¯é‡å¤è¯»ã€‚åœ¨åŒä¸€ä¸ªäº‹åŠ¡å†…çš„æŸ¥è¯¢éƒ½æ˜¯äº‹åŠ¡å¼€å§‹æ—¶åˆ»ä¸€è‡´çš„ï¼Œ<strong>InnoDBé»˜è®¤çº§åˆ«</strong>ã€‚åœ¨SQLæ ‡å‡†ä¸­ï¼Œè¯¥éš”ç¦»çº§åˆ«æ¶ˆé™¤äº†ä¸å¯é‡å¤è¯»ï¼Œä½†æ˜¯è¿˜å­˜åœ¨å¹»è±¡è¯»;mysql RRéš”ç¦»çº§åˆ«ä¿è¯å¯¹è¯»å–åˆ°çš„è®°å½•åŠ é” (è®°å½•é”)ï¼ŒåŒæ—¶ä¿è¯å¯¹<strong>è¯»å–çš„èŒƒå›´åŠ é”(GAPé—´éš™é”)</strong>ï¼Œæ–°çš„æ»¡è¶³æŸ¥è¯¢æ¡ä»¶çš„è®°å½•ä¸èƒ½å¤Ÿæ’å…¥,ä¸å­˜åœ¨å¹»è¯»ç°è±¡ã€‚</li>
<li>ä¸²è¡Œè¯»(Serializable)ï¼šå®Œå…¨ä¸²è¡ŒåŒ–çš„è¯»ï¼Œæ¯æ¬¡è¯»éƒ½éœ€è¦è·å¾—è¡¨çº§å…±äº«é”ï¼Œè¯»å†™ç›¸äº’éƒ½ä¼šé˜»å¡</li>
</ul>
<h4 id="ä¸å¯é‡å¤è¯»å’Œå¹»è¯»çš„åŒºåˆ«"><a href="#ä¸å¯é‡å¤è¯»å’Œå¹»è¯»çš„åŒºåˆ«" class="headerlink" title="ä¸å¯é‡å¤è¯»å’Œå¹»è¯»çš„åŒºåˆ«"></a>ä¸å¯é‡å¤è¯»å’Œå¹»è¯»çš„åŒºåˆ«</h4><p>ä¸å¯é‡å¤è¯»é‡ç‚¹åœ¨äºupdateå’Œdeleteï¼Œè€Œå¹»è¯»çš„é‡ç‚¹åœ¨äºinsertã€‚</p>
<p>å¦‚æœä½¿ç”¨é”æœºåˆ¶æ¥å®ç°è¿™ä¸¤ç§éš”ç¦»çº§åˆ«ï¼Œåœ¨å¯é‡å¤è¯»ä¸­ï¼Œè¯¥sqlç¬¬ä¸€æ¬¡è¯»å–åˆ°æ•°æ®åï¼Œå°±å°†è¿™äº›æ•°æ®åŠ é”ï¼Œå…¶å®ƒäº‹åŠ¡æ— æ³•ä¿®æ”¹è¿™äº›æ•°æ®ï¼Œå°±å¯ä»¥å®ç°å¯é‡å¤è¯»äº†ã€‚ä½†è¿™ç§æ–¹æ³•å´æ— æ³•é”ä½insertçš„æ•°æ®ï¼Œæ‰€ä»¥å½“äº‹åŠ¡Aå…ˆå‰è¯»å–äº†æ•°æ®ï¼Œæˆ–è€…ä¿®æ”¹äº†å…¨éƒ¨æ•°æ®ï¼Œäº‹åŠ¡Bè¿˜æ˜¯å¯ä»¥insertæ•°æ®æäº¤ï¼Œè¿™æ—¶äº‹åŠ¡Aå°±ä¼šå‘ç°è«åå…¶å¦™å¤šäº†ä¸€æ¡ä¹‹å‰æ²¡æœ‰çš„æ•°æ®ï¼Œè¿™å°±æ˜¯å¹»è¯»ï¼Œä¸èƒ½é€šè¿‡è¡Œé”æ¥é¿å…ã€‚éœ€è¦Serializableéš”ç¦»çº§åˆ« ï¼Œè¯»ç”¨è¯»é”ï¼Œå†™ç”¨å†™é”ï¼Œè¯»é”å’Œå†™é”äº’æ–¥ï¼Œè¿™ä¹ˆåšå¯ä»¥æœ‰æ•ˆçš„é¿å…å¹»è¯»ã€ä¸å¯é‡å¤è¯»ã€è„è¯»ç­‰é—®é¢˜ï¼Œä½†ä¼šæå¤§çš„é™ä½æ•°æ®åº“çš„å¹¶å‘èƒ½åŠ›ã€‚</p>
<h3 id="ä¸€æ¡ç®€å•SQLçš„åŠ é”å®ç°åˆ†æ"><a href="#ä¸€æ¡ç®€å•SQLçš„åŠ é”å®ç°åˆ†æ" class="headerlink" title="ä¸€æ¡ç®€å•SQLçš„åŠ é”å®ç°åˆ†æ"></a>ä¸€æ¡ç®€å•SQLçš„åŠ é”å®ç°åˆ†æ</h3><p>ä¾‹å­ï¼š</p>
<p>å½“idåˆ—æ˜¯äºŒçº§éå”¯ä¸€ç´¢å¼•ï¼ŒRRéš”ç¦»çº§åˆ«</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SQL1ï¼šselect * from t1 where id = 10;</div><div class="line">SQL2ï¼šdelete from t1 where id = 10;</div></pre></td></tr></table></figure>
<p>SQL1ä¸ºç®€å•çš„selectè¯­å¥ï¼Œå¿«ç…§è¯»ä¸ç”¨åŠ é”ã€‚</p>
<p>Repeatable Readéš”ç¦»çº§åˆ«ï¼Œidä¸Šæœ‰ä¸€ä¸ªéå”¯ä¸€ç´¢å¼•ï¼Œæ‰§è¡Œdelete from t1 where id = 10; å‡è®¾é€‰æ‹©idåˆ—ä¸Šçš„ç´¢å¼•è¿›è¡Œæ¡ä»¶è¿‡æ»¤ï¼Œæœ€åçš„åŠ é”è¡Œä¸ºï¼Œæ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼ŸåŒæ ·çœ‹ä¸‹é¢è¿™å¹…å›¾ï¼š</p>
<p><img src="/images/mysqlé”æœºåˆ¶1-3.jpg"></p>
<p>GAPé”ï¼Œå°±æ˜¯RRéš”ç¦»çº§åˆ«ç›¸å¯¹äºRCéš”ç¦»çº§åˆ«ï¼Œä¸ä¼šå‡ºç°å¹»è¯»çš„å…³é”®ã€‚ç¡®å®ï¼ŒGAPé”é”ä½çš„ä½ç½®ï¼Œä¹Ÿä¸æ˜¯è®°å½•æœ¬èº«ï¼Œè€Œæ˜¯ä¸¤æ¡è®°å½•ä¹‹é—´çš„GAPã€‚æ‰€è°“å¹»è¯»ï¼Œå°±æ˜¯åŒä¸€ä¸ªäº‹åŠ¡ï¼Œè¿ç»­åšä¸¤æ¬¡å½“å‰è¯» (ä¾‹å¦‚ï¼šselect * from t1 where id = 10 for update;)ï¼Œé‚£ä¹ˆè¿™ä¸¤æ¬¡å½“å‰è¯»è¿”å›çš„æ˜¯å®Œå…¨ç›¸åŒçš„è®°å½• (è®°å½•æ•°é‡ä¸€è‡´ï¼Œè®°å½•æœ¬èº«ä¹Ÿä¸€è‡´)ï¼Œç¬¬äºŒæ¬¡çš„å½“å‰è¯»ï¼Œä¸ä¼šæ¯”ç¬¬ä¸€æ¬¡è¿”å›æ›´å¤šçš„è®°å½• (å¹»è±¡)ã€‚</p>
<p>å¦‚ä½•ä¿è¯ä¸¤æ¬¡å½“å‰è¯»è¿”å›ä¸€è‡´çš„è®°å½•ï¼Œé‚£å°±éœ€è¦åœ¨ç¬¬ä¸€æ¬¡å½“å‰è¯»ä¸ç¬¬äºŒæ¬¡å½“å‰è¯»ä¹‹é—´ï¼Œå…¶ä»–çš„äº‹åŠ¡ä¸ä¼šæ’å…¥æ–°çš„æ»¡è¶³æ¡ä»¶çš„è®°å½•å¹¶æäº¤ã€‚ä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼ŒGAPé”åº”è¿è€Œç”Ÿã€‚</p>
<p>å¦‚å›¾ä¸­æ‰€ç¤ºï¼Œæœ‰å“ªäº›ä½ç½®å¯ä»¥æ’å…¥æ–°çš„æ»¡è¶³æ¡ä»¶çš„é¡¹ (id = 10)ï¼Œè€ƒè™‘åˆ°B+æ ‘ç´¢å¼•çš„æœ‰åºæ€§ï¼Œæ»¡è¶³æ¡ä»¶çš„é¡¹ä¸€å®šæ˜¯è¿ç»­å­˜æ”¾çš„ã€‚è®°å½•[6,c]ä¹‹å‰ï¼Œä¸ä¼šæ’å…¥id=10çš„è®°å½•ï¼›[6,c]ä¸[10,b]é—´å¯ä»¥æ’å…¥[10, aa]ï¼›[10,b]ä¸[10,d]é—´ï¼Œå¯ä»¥æ’å…¥æ–°çš„[10,bb],[10,c]ç­‰ï¼›[10,d]ä¸[11,f]é—´å¯ä»¥æ’å…¥æ»¡è¶³æ¡ä»¶çš„[10,e],[10,z]ç­‰ï¼›è€Œ[11,f]ä¹‹åä¹Ÿä¸ä¼šæ’å…¥æ»¡è¶³æ¡ä»¶çš„è®°å½•ã€‚å› æ­¤ï¼Œä¸ºäº†ä¿è¯[6,c]ä¸[10,b]é—´ï¼Œ[10,b]ä¸[10,d]é—´ï¼Œ[10,d]ä¸[11,f]ä¸ä¼šæ’å…¥æ–°çš„æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼ŒMySQLé€‰æ‹©äº†ç”¨GAPé”ï¼Œå°†è¿™ä¸‰ä¸ªGAPç»™é”èµ·æ¥ã€‚</p>
<p>Insertæ“ä½œï¼Œå¦‚insert [10,aa]ï¼Œé¦–å…ˆä¼šå®šä½åˆ°[6,c]ä¸[10,b]é—´ï¼Œç„¶ååœ¨æ’å…¥å‰ï¼Œä¼šæ£€æŸ¥è¿™ä¸ªGAPæ˜¯å¦å·²ç»è¢«é”ä¸Šï¼Œå¦‚æœè¢«é”ä¸Šï¼Œåˆ™Insertä¸èƒ½æ’å…¥è®°å½•ã€‚å› æ­¤ï¼Œé€šè¿‡ç¬¬ä¸€éçš„å½“å‰è¯»ï¼Œä¸ä»…å°†æ»¡è¶³æ¡ä»¶çš„è®°å½•é”ä¸Š (Xé”)ï¼Œä¸ç»„åˆä¸‰ç±»ä¼¼ã€‚åŒæ—¶è¿˜æ˜¯å¢åŠ 3æŠŠGAPé”ï¼Œå°†å¯èƒ½æ’å…¥æ»¡è¶³æ¡ä»¶è®°å½•çš„3ä¸ªGAPç»™é”ä¸Šï¼Œä¿è¯åç»­çš„Insertä¸èƒ½æ’å…¥æ–°çš„id=10çš„è®°å½•ï¼Œä¹Ÿå°±æœç»äº†åŒä¸€äº‹åŠ¡çš„ç¬¬äºŒæ¬¡å½“å‰è¯»ï¼Œå‡ºç°å¹»è±¡çš„æƒ…å†µã€‚</p>
<p><strong>ç»“è®ºï¼šRepeatable Readéš”ç¦»çº§åˆ«ä¸‹ï¼Œidåˆ—ä¸Šæœ‰ä¸€ä¸ªéå”¯ä¸€ç´¢å¼•ï¼Œå¯¹åº”SQLï¼šdelete from t1 where id = 10; é¦–å…ˆï¼Œé€šè¿‡idç´¢å¼•å®šä½åˆ°ç¬¬ä¸€æ¡æ»¡è¶³æŸ¥è¯¢æ¡ä»¶çš„è®°å½•ï¼ŒåŠ è®°å½•ä¸Šçš„Xé”ï¼ŒåŠ GAPä¸Šçš„GAPé”ï¼Œç„¶ååŠ ä¸»é”®èšç°‡ç´¢å¼•ä¸Šçš„è®°å½•Xé”ï¼Œç„¶åè¿”å›ï¼›ç„¶åè¯»å–ä¸‹ä¸€æ¡ï¼Œé‡å¤è¿›è¡Œã€‚ç›´è‡³è¿›è¡Œåˆ°ç¬¬ä¸€æ¡ä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•[11,f]ï¼Œæ­¤æ—¶ï¼Œä¸éœ€è¦åŠ è®°å½•Xé”ï¼Œä½†æ˜¯ä»æ—§éœ€è¦åŠ GAPé”ï¼Œæœ€åè¿”å›ç»“æŸã€‚</strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[javaè°ƒè¯•-jstackå‘½ä»¤]]></title>
      <url>http://zsr.github.io/2016/08/18/java%E8%B0%83%E8%AF%95-jstack%E5%91%BD%E4%BB%A4/</url>
      <content type="html"><![CDATA[<h2 id="jstackå‘½ä»¤ä½¿ç”¨"><a href="#jstackå‘½ä»¤ä½¿ç”¨" class="headerlink" title="jstackå‘½ä»¤ä½¿ç”¨"></a>jstackå‘½ä»¤ä½¿ç”¨</h2><p>jstackå¯ç”¨äºå¯¼å‡ºjavaè¿ç”¨ç¨‹åºçš„çº¿ç¨‹å †æ ˆï¼Œå…¶åŸºæœ¬ä½¿ç”¨è¯­æ³•ä¸ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jstack [<span class="_">-l</span>] pid</div></pre></td></tr></table></figure>
<p>-l æ‰“å°å…³äºé”çš„é™„åŠ ä¿¡æ¯,ä¾‹å¦‚å±äºjava.util.concurrentçš„ownable synchronizersåˆ—è¡¨.</p>
<h3 id="å¸¸ç”¨ç”¨æ³•"><a href="#å¸¸ç”¨ç”¨æ³•" class="headerlink" title="å¸¸ç”¨ç”¨æ³•"></a>å¸¸ç”¨ç”¨æ³•</h3><p>ä¸‹é¢è¿™æ®µä»£ç è¿è¡Œä¹‹åä¼šå‡ºç°æ­»é”ç°è±¡(å› ä¸ºçº¿ç¨‹1æŒæœ‰lock1ï¼Œåœ¨ç­‰å¾…lock2ï¼Œçº¿ç¨‹2æŒæœ‰lock2åœ¨ç­‰å¾…lock1ï¼Œé€ æˆäº†å¾ªç¯ç­‰å¾…ï¼Œå½¢æˆæ­»é”)ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.lock;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * </div><div class="line"> * Created by david.zhang</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDeadLock</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object lock1 = <span class="keyword">new</span> Object();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object lock2 = <span class="keyword">new</span> Object();</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">synchronized</span> (lock1) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        Thread.sleep(<span class="number">1000</span>);</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">synchronized</span> (lock2) &#123;</div><div class="line">                        System.out.println(<span class="string">"çº¿ç¨‹1æ‰§è¡Œ...."</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">synchronized</span> (lock2) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        Thread.sleep(<span class="number">1000</span>);</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">synchronized</span> (lock1) &#123;</div><div class="line">                        System.out.println(<span class="string">"çº¿ç¨‹2æ‰§è¡Œ..."</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        t1.start();</div><div class="line">        t2.start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿è¡Œè¿™æ®µä»£ç ï¼Œç„¶åä½¿ç”¨jstackå‘½ä»¤å¯¼å‡ºè¿™ä¸ªç¨‹åºçš„çº¿ç¨‹å †æ ˆä¿¡æ¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:public nali$ jstack <span class="_">-l</span> 35072 &gt; /Users/nali/deadlock.txt</div></pre></td></tr></table></figure>
<p>æ‰“å¼€å¯¼å‡ºçš„çº¿ç¨‹å †æ ˆä¿¡æ¯æ–‡ä»¶ï¼Œæ–‡ä»¶æœ«å°¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Found one Java-level deadlock:</div><div class="line"></div><div class="line">=============================</div><div class="line">&quot;Thread-1&quot;:</div><div class="line">  waiting to lock monitor 0x00007fe6d48432b8 (object 0x00000007d558e9d8, a java.lang.Object),</div><div class="line">  which is held by &quot;Thread-0&quot;</div><div class="line">&quot;Thread-0&quot;:</div><div class="line">  waiting to lock monitor 0x00007fe6d4844758 (object 0x00000007d558e9e8, a java.lang.Object),</div><div class="line">  which is held by &quot;Thread-1&quot;</div><div class="line"></div><div class="line">Java stack information for the threads listed above:</div><div class="line"></div><div class="line">===================================================</div><div class="line">&quot;Thread-1&quot;:</div><div class="line">	at com.zsr.test.lock.TestDeadLock$2.run(TestDeadLock.java:39)</div><div class="line">	- waiting to lock &lt;0x00000007d558e9d8&gt; (a java.lang.Object)</div><div class="line">	- locked &lt;0x00000007d558e9e8&gt; (a java.lang.Object)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line">&quot;Thread-0&quot;:</div><div class="line">	at com.zsr.test.lock.TestDeadLock$1.run(TestDeadLock.java:23)</div><div class="line">	- waiting to lock &lt;0x00000007d558e9e8&gt; (a java.lang.Object)</div><div class="line">	- locked &lt;0x00000007d558e9d8&gt; (a java.lang.Object)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line"></div><div class="line">Found 1 deadlock.</div></pre></td></tr></table></figure>
<p>å¯¼å‡ºçš„çº¿ç¨‹å †æ ˆæ–‡ä»¶ä¸­æ˜ç¡®æç¤ºå‘ç°æ­»é”ï¼Œå¹¶ä¸”æŒ‡æ˜äº†æ­»é”çš„åŸå› ã€‚</p>
<p>jstackä¸ä»…èƒ½å¤Ÿå¯¼å‡ºçº¿ç¨‹å †æ ˆï¼Œè¿˜èƒ½è‡ªåŠ¨è¿›è¡Œæ­»é”æ£€æµ‹ï¼Œè¾“å‡ºçº¿ç¨‹æ­»é”åŸå› ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[javaè°ƒè¯•-jmapå‘½ä»¤]]></title>
      <url>http://zsr.github.io/2016/08/18/java%E8%B0%83%E8%AF%95-jmap%E5%91%BD%E4%BB%A4/</url>
      <content type="html"><![CDATA[<h2 id="jmapå‘½ä»¤ä½¿ç”¨"><a href="#jmapå‘½ä»¤ä½¿ç”¨" class="headerlink" title="jmapå‘½ä»¤ä½¿ç”¨"></a>jmapå‘½ä»¤ä½¿ç”¨</h2><p>jmapæ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½çš„å‘½ä»¤ã€‚å®ƒå¯ä»¥ç”Ÿæˆjavaç¨‹åºçš„å †dumpæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹å †å†…å¯¹è±¡å®ä¾‹çš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒæŸ¥çœ‹ClassLoaderçš„ä¿¡æ¯ä»¥åŠFinalizeré˜Ÿåˆ—ã€‚</p>
<h3 id="å¸¸ç”¨ç”¨æ³•"><a href="#å¸¸ç”¨ç”¨æ³•" class="headerlink" title="å¸¸ç”¨ç”¨æ³•"></a>å¸¸ç”¨ç”¨æ³•</h3><ul>
<li>å¯¼å‡ºå¯¹è±¡ç»Ÿè®¡ä¿¡æ¯</li>
</ul>
<p>ä¸‹é¢çš„å‘½ä»¤ç”ŸæˆPIDä¸º24205çš„javaæˆç²—çš„å¯¹è±¡çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¹¶è¾“å‡ºåˆ°out.txtæ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jmap -histo 24205 &gt; /Users/nali/out.txt</div></pre></td></tr></table></figure>
<p>ç”Ÿæˆçš„æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"> num     #instances         #bytes  class name</div><div class="line">----------------------------------------------</div><div class="line">   1:        962520       23100480  java.lang.Long</div><div class="line">   2:        481260       19250400  com.ximalaya.test.Ip</div><div class="line">   3:        962779       15404464  java.lang.Integer</div><div class="line">   4:        481300       15401600  java.util.HashMap$Entry</div><div class="line">   5:          6362        9556232  [I</div><div class="line">   6:            19        7341744  [Ljava.util.HashMap$Entry;</div><div class="line">   7:           319        2174856  [Ljava.lang.Object;</div><div class="line">   8:          6060         781024  &lt;methodKlass&gt;</div><div class="line">   9:          6060         692032  &lt;constMethodKlass&gt;</div><div class="line">  10:           415         486208  &lt;constantPoolKlass&gt;</div><div class="line">  11:           378         296288  &lt;constantPoolCacheKlass&gt;</div><div class="line">  12:           415         285880  &lt;instanceKlassKlass&gt;</div><div class="line">  13:          1358         156272  [C</div><div class="line">  14:           573          94240  [B</div><div class="line">  15:           125          52928  &lt;methodDataKlass&gt;</div><div class="line">  16:           478          46680  java.lang.Class</div><div class="line">  17:           704          45152  [[I</div><div class="line">  18:           631          38168  [S</div><div class="line">  19:          1334          32016  java.lang.String</div><div class="line">  20:            46          25024  &lt;objArrayKlassKlass&gt;</div><div class="line">  21:           101           6464  java.net.URL</div><div class="line">  22:            79           5688  java.lang.reflect.Field</div><div class="line">  23:             8           4352  &lt;typeArrayKlassKlass&gt;</div><div class="line">  24:            96           3840  java.util.LinkedHashMap$Entry</div><div class="line">  25:           119           3808  java.util.Hashtable$Entry</div><div class="line">  26:            94           3760  java.lang.ref.SoftReference</div><div class="line">  27:            91           2912  java.util.concurrent.ConcurrentHashMap$HashEntry</div><div class="line">  28:            61           2432  [Ljava.lang.String;</div></pre></td></tr></table></figure>
<p>ä»æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºäº†å†…å­˜ä¸­å®ä¾‹çš„æ•°é‡å’Œåˆè®¡ã€‚</p>
<ul>
<li>å¯¼å‡ºç¨‹åºå †å¿«ç…§</li>
</ul>
<p>ä¸‹é¢çš„å‘½ä»¤å¯¼å‡ºPIDä¸º24205çš„javaç¨‹åºå½“å‰çš„å †å¿«ç…§ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jmap -dump:format=b,file=dump.bin 24205</div><div class="line">Dumping heap to /Users/nali/dump.bin ...</div><div class="line">Heap dump file created</div></pre></td></tr></table></figure>
<p>è¯¥å‘½ä»¤æˆåŠŸåœ°å°†è¿ç”¨ç¨‹åºçš„å½“å‰çš„å †å¿«ç…§å¯¼å‡ºåˆ°äº†dump.binæ–‡ä»¶ï¼Œä¹‹åå¯ä»¥ä½¿ç”¨Visual VMï¼ŒMATç­‰å·¥å…·åˆ†æå¯¹å¿«ç…§æ–‡ä»¶ã€‚</p>
<ul>
<li>æŸ¥çœ‹java å †ï¼ˆheapï¼‰ä½¿ç”¨æƒ…å†µ</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jmap -heap 30192</div><div class="line">Attaching to process ID 30192, please wait...</div><div class="line">Debugger attached successfully.</div><div class="line">Server compiler detected.</div><div class="line">JVM version is 24.79-b02</div><div class="line"></div><div class="line">using thread-local object allocation.</div><div class="line">Parallel GC with 4 thread(s)</div><div class="line"></div><div class="line">Heap Configuration: //å †å†…å­˜åˆå§‹åŒ–é…ç½®</div><div class="line">   //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:M<span class="keyword">in</span>HeapFreeRatioè®¾ç½®JVMå †æœ€å°ç©ºé—²æ¯”ç‡</div><div class="line">   M<span class="keyword">in</span>HeapFreeRatio = 0 </div><div class="line">   //å¯¹åº”jvmå¯åŠ¨å‚æ•° -XX:MaxHeapFreeRatioè®¾ç½®JVMå †æœ€å¤§ç©ºé—²æ¯”ç‡</div><div class="line">   MaxHeapFreeRatio = 100 </div><div class="line">   //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:MaxHeapSize=è®¾ç½®JVMå †çš„æœ€å¤§å¤§å°</div><div class="line">   MaxHeapSize      = 2147483648 (2048.0MB)</div><div class="line">   //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:NewSize=è®¾ç½®JVMå †çš„â€˜æ–°ç”Ÿä»£â€™çš„é»˜è®¤å¤§å°</div><div class="line">   NewSize          = 1310720 (1.25MB)</div><div class="line">   //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:MaxNewSize=è®¾ç½®JVMå †çš„â€˜æ–°ç”Ÿä»£â€™çš„æœ€å¤§å¤§å°</div><div class="line">   MaxNewSize       = 17592186044415 MB</div><div class="line">   //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:OldSize=&lt;value&gt;:è®¾ç½®JVMå †çš„â€˜è€ç”Ÿä»£â€™çš„å¤§å°</div><div class="line">   OldSize          = 5439488 (5.1875MB)</div><div class="line">   //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:NewRatio=:â€˜æ–°ç”Ÿä»£â€™å’Œâ€˜è€ç”Ÿä»£â€™çš„å¤§å°æ¯”ç‡</div><div class="line">   NewRatio         = 2</div><div class="line">   //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:SurvivorRatio=è®¾ç½®å¹´è½»ä»£ä¸­EdenåŒºä¸SurvivoråŒºçš„å¤§å°æ¯”å€¼ </div><div class="line">   SurvivorRatio    = 8</div><div class="line">   //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:PermSize=&lt;value&gt;:è®¾ç½®JVMå †çš„â€˜æ°¸ç”Ÿä»£â€™çš„åˆå§‹å¤§å°</div><div class="line">   PermSize         = 21757952 (20.75MB)</div><div class="line">   //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:MaxPermSize=&lt;value&gt;:è®¾ç½®JVMå †çš„â€˜æ°¸ç”Ÿä»£â€™çš„æœ€å¤§å¤§å°</div><div class="line">   MaxPermSize      = 85983232 (82.0MB)</div><div class="line">   G1HeapRegionSize = 0 (0.0MB)</div><div class="line"></div><div class="line">Heap Usage:</div><div class="line">PS Young Generation</div><div class="line">Eden Space: //EdenåŒºå†…å­˜åˆ†å¸ƒ</div><div class="line">   //EdenåŒºæ€»å®¹é‡</div><div class="line">   capacity = 136839168 (130.5MB)</div><div class="line">   //EdenåŒºå·²ä½¿ç”¨</div><div class="line">   used     = 62349088 (59.460723876953125MB)</div><div class="line">   //EdenåŒºå‰©ä½™å®¹é‡</div><div class="line">   free     = 74490080 (71.03927612304688MB)</div><div class="line">   //EdenåŒºä½¿ç”¨æ¯”ç‡</div><div class="line">   45.56377308578784% used</div><div class="line">From Space: //å…¶ä¸­ä¸€ä¸ªSurvivoråŒºçš„å†…å­˜åˆ†å¸ƒ</div><div class="line">   capacity = 17301504 (16.5MB)</div><div class="line">   used     = 17299704 (16.49828338623047MB)</div><div class="line">   free     = 1800 (0.00171661376953125MB)</div><div class="line">   99.98959628018466% used</div><div class="line">To Space: //å¦ä¸€ä¸ªSurvivoråŒºçš„å†…å­˜åˆ†å¸ƒ</div><div class="line">   capacity = 27262976 (26.0MB)</div><div class="line">   used     = 0 (0.0MB)</div><div class="line">   free     = 27262976 (26.0MB)</div><div class="line">   0.0% used</div><div class="line">PS Old Generation //å½“å‰çš„OldåŒºå†…å­˜åˆ†å¸ƒ</div><div class="line">   capacity = 89128960 (85.0MB)</div><div class="line">   used     = 35824408 (34.164817810058594MB)</div><div class="line">   free     = 53304552 (50.835182189941406MB)</div><div class="line">   40.19390330595129% used</div><div class="line">PS Perm Generation //å½“å‰çš„ â€œæ°¸ç”Ÿä»£â€ å†…å­˜åˆ†å¸ƒ</div><div class="line">   capacity = 22020096 (21.0MB)</div><div class="line">   used     = 2801672 (2.6718826293945312MB)</div><div class="line">   free     = 19218424 (18.32811737060547MB)</div><div class="line">   12.723250616164435% used</div><div class="line"></div><div class="line">734 interned Strings occupying 47744 bytes.</div></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[javaè°ƒè¯•-jstatå‘½ä»¤]]></title>
      <url>http://zsr.github.io/2016/08/18/java%E8%B0%83%E8%AF%95-jstat%E5%91%BD%E4%BB%A4/</url>
      <content type="html"><![CDATA[<h2 id="jstatå‘½ä»¤ä½¿ç”¨"><a href="#jstatå‘½ä»¤ä½¿ç”¨" class="headerlink" title="jstatå‘½ä»¤ä½¿ç”¨"></a>jstatå‘½ä»¤ä½¿ç”¨</h2><p>jstatæ˜¯ä¸€ä¸ªå¯ä»¥ç”¨äºè§‚å¯Ÿjavaåº”ç”¨ç¨‹åºè¿è¡Œæ—¶ç›¸å…³ä¿¡æ¯çš„å·¥å…·ï¼ŒåŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œå¯ä»¥é€šè¿‡å®ƒ<strong>æŸ¥çœ‹å †ä¿¡æ¯çš„è¯¦ç»†æƒ…å†µã€‚</strong></p>
<h3 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h3><p>jstatå‘½ä»¤çš„åŸºæœ¬ä½¿ç”¨è¯­æ³•å¦‚ä¸‹ï¼š</p>
<p><strong>jstat -option [-t] [-h] pid [interval] [count]</strong></p>
<ul>
<li>é€‰é¡¹optionå¯ä»¥ç”±ä»¥ä¸‹å€¼æ„æˆã€‚<ul>
<li>-classï¼šæ˜¾ç¤ºClassLoaderçš„ç›¸å…³ä¿¡æ¯ã€‚</li>
<li>-compilerï¼šæ˜¾ç¤ºJITç¼–è¯‘çš„ç›¸å…³ä¿¡æ¯ã€‚</li>
<li><strong>-gcï¼šæ˜¾ç¤ºä¸gcç›¸å…³çš„å †ä¿¡æ¯ã€‚</strong></li>
<li>-gccapacityï¼šæ˜¾ç¤ºå„ä¸ªä»£çš„å®¹é‡åŠä½¿ç”¨æƒ…å†µã€‚</li>
<li>-gccauseï¼šæ˜¾ç¤ºåƒåœ¾å›æ”¶çš„ç›¸å…³ä¿¡æ¯ï¼ˆåŒ-gcutilï¼‰ï¼ŒåŒæ—¶æ˜¾ç¤ºæœ€åä¸€æ¬¡æˆ–å½“å‰æ­£åœ¨å‘ç”Ÿçš„åƒåœ¾å›æ”¶çš„è¯±å› ã€‚</li>
<li>-gcnewï¼šæ˜¾ç¤ºæ–°ç”Ÿä»£ä¿¡æ¯ã€‚</li>
<li>-gcnewcapacityï¼šæ˜¾ç¤ºæ–°ç”Ÿä»£å¤§å°ä¸ä½¿ç”¨æƒ…å†µã€‚</li>
<li>-gcoldï¼šæ˜¾ç¤ºè€ç”Ÿä»£å’Œæ°¸ä¹…ä»£çš„ä¿¡æ¯ã€‚</li>
<li>-gcoldcapacityï¼šæ˜¾ç¤ºè€å¹´ä»£çš„å¤§å°ã€‚</li>
<li>-gcpermcapacityï¼šæ˜¾ç¤ºæ°¸ä¹…ä»£çš„å¤§å°ã€‚</li>
<li>-gcutilï¼šæ˜¾ç¤ºåƒåœ¾æ”¶é›†ä¿¡æ¯ã€‚</li>
<li>-printcompilationï¼šè¾“å‡ºJITç¼–è¯‘çš„æ–¹æ³•ä¿¡æ¯ã€‚</li>
</ul>
</li>
<li>-tå‚æ•°å¯ä»¥åœ¨è¾“å‡ºä¿¡æ¯å‰é¢åŠ ä¸Šä¸€ä¸ªTimestampåˆ—ï¼Œæ˜¾ç¤ºç¨‹åºè¿è¡Œçš„æ—¶é—´ã€‚</li>
<li>-hå‚æ•°å¯ä»¥åœ¨å‘¨æœŸæ€§çš„æ•°æ®è¾“å‡ºæ—¶ï¼Œè¾“å‡ºå¤šå°‘è¡Œæ•°æ®åï¼Œè·Ÿç€è¾“å‡ºä¸€ä¸ªè¡¨å¤´ä¿¡æ¯ã€‚</li>
<li>intervalå‚æ•°ç”¨äºæŒ‡å®šè¾“å‡ºç»Ÿè®¡æ•°æ®çš„å‘¨æœŸï¼Œå•ä½ä¸ºæ¯«ç§’(ms)ã€‚</li>
<li>countå‚æ•°ç”¨äºæŒ‡å®šä¸€å…±è¾“å‡ºå¤šå°‘æ¬¡æ•°æ®ã€‚</li>
</ul>
<h3 id="è¯¦ç»†ä½¿ç”¨"><a href="#è¯¦ç»†ä½¿ç”¨" class="headerlink" title="è¯¦ç»†ä½¿ç”¨"></a>è¯¦ç»†ä½¿ç”¨</h3><h5 id="classä½¿ç”¨"><a href="#classä½¿ç”¨" class="headerlink" title="-classä½¿ç”¨"></a>-classä½¿ç”¨</h5><p>ä¸‹é¢å‘½ä»¤è¾“å‡ºpidä¸º2500è¿™ä¸ªè¿›ç¨‹çš„ClassLoaderç›¸å…³ä¿¡æ¯ï¼Œæ¯ç§’ç»Ÿè®¡ä¸€æ¬¡ä¿¡æ¯ï¼Œä¸€å…±è¾“å‡º3æ¬¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jstat -class -t 13640 1000 3</div><div class="line">Timestamp       Loaded  Bytes  Unloaded  Bytes     Time</div><div class="line">1522.7          414     827.5      0     0.0       0.13</div><div class="line">1523.7          414     827.5      0     0.0       0.13</div><div class="line">1524.7          414     827.5      0     0.0       0.13</div></pre></td></tr></table></figure>
<p>Loadedè¡¨ç¤ºè½½å…¥çš„ç±»çš„æ•°é‡ï¼Œç¬¬ä¸€ä¸ªBytesè¡¨ç¤ºè½½å…¥çš„ç±»çš„åˆè®¡å¤§å°ï¼ŒUnloadedè¡¨ç¤ºå¸è½½çš„ç±»æ•°é‡ï¼Œç¬¬äºŒä¸ªBytesè¡¨ç¤ºå¸è½½çš„ç±»çš„åˆè®¡å¤§å°ï¼ŒTimeè¡¨ç¤ºåŠ è½½å’Œå¸è½½ç±»èŠ±çš„æ€»çš„æ—¶é—´ã€‚</p>
<h5 id="compilerä½¿ç”¨"><a href="#compilerä½¿ç”¨" class="headerlink" title="-compilerä½¿ç”¨"></a>-compilerä½¿ç”¨</h5><p>ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹JITç¼–è¯‘çš„ä¿¡æ¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jstat -compiler -t 13640</div><div class="line">Timestamp       Compiled Failed Invalid   Time   FailedType FailedMethod</div><div class="line">         1814.8       99      0       0     0.51          0</div></pre></td></tr></table></figure>
<p>Compiledè¡¨ç¤ºç¼–è¯‘ä»»åŠ¡æ‰§è¡Œçš„æ¬¡æ•°ï¼ŒFailedè¡¨ç¤ºç¼–è¯‘å¤±è´¥çš„æ¬¡æ•°ï¼ŒInvalidè¡¨ç¤ºç¼–è¯‘ä¸å¯ç”¨çš„æ¬¡æ•°ï¼ŒTimeè¡¨ç¤ºç¼–è¯‘çš„æ€»è€—æ—¶ï¼ŒFailedTypeè¡¨ç¤ºæœ€åä¸€æ¬¡ç¼–è¯‘çš„ç±»å‹ï¼ŒFailedMethodè¡¨ç¤ºæœ€åä¸€æ¬¡ç¼–è¯‘å¤±è´¥çš„ç±»åå’Œæ–¹æ³•åã€‚</p>
<h5 id="gcä½¿ç”¨"><a href="#gcä½¿ç”¨" class="headerlink" title="-gcä½¿ç”¨"></a>-gcä½¿ç”¨</h5><p>ä¸‹é¢çš„å‘½ä»¤æ˜¾ç¤ºä¸gcç›¸å…³çš„å †ä¿¡æ¯çš„è¾“å‡ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jstat -gc 16309</div><div class="line">S0C     S1C     S0U      S1U   EC       EU        OC         OU          MC     MU </div><div class="line">45056.0 55296.0 44588.0  0.0   336896.0 222238.4  171520.0   86902.0     -      - </div><div class="line">CCSC CCSU YGC YGCT   FGC     FGCT      GCT</div><div class="line">-     -    8  0.312   1      1.328    1.640</div></pre></td></tr></table></figure>
<ul>
<li>S0Cï¼šs0(from)çš„å¤§å°(KB)</li>
<li>S1Cï¼šs1(from)çš„å¤§å°(KB)</li>
<li>S0Uï¼šs0(from)å·²ä½¿ç”¨çš„ç©ºé—´(KB)</li>
<li>S1Uï¼šs1(from)å·²ç»ä½¿ç”¨çš„ç©ºé—´(KB)</li>
<li>ECï¼šedenåŒºçš„å¤§å°(KB)</li>
<li>EUï¼šedenåŒºå·²ç»ä½¿ç”¨çš„ç©ºé—´(KB)</li>
<li>OCï¼šè€å¹´ä»£å¤§å°(KB)</li>
<li>OUï¼šè€å¹´ä»£å·²ç»ä½¿ç”¨çš„ç©ºé—´(KB)</li>
<li>MCï¼šæ–¹æ³•åŒºå¤§å°(KB)</li>
<li>MUï¼šæ–¹æ³•åŒºä½¿ç”¨å¤§å°(KB)</li>
<li>CCSC:å‹ç¼©ç±»ç©ºé—´å¤§å°(KB)</li>
<li>CCSU:å‹ç¼©ç±»ç©ºé—´ä½¿ç”¨å¤§å°(KB)</li>
<li>YGCï¼šæ–°ç”Ÿä»£gcæ¬¡æ•°</li>
<li>YGCTï¼šæ–°ç”Ÿä»£gcè€—æ—¶</li>
<li>FGCï¼šFull gcæ¬¡æ•°</li>
<li>FGCTï¼šFull gcè€—æ—¶</li>
<li>GCTï¼šgcæ€»è€—æ—¶</li>
</ul>
<h5 id="gccapacityä½¿ç”¨"><a href="#gccapacityä½¿ç”¨" class="headerlink" title="-gccapacityä½¿ç”¨"></a>-gccapacityä½¿ç”¨</h5><p>ä¸‹é¢çš„å‘½ä»¤æ˜¾ç¤ºäº†å„ä¸ªä»£çš„ä¿¡æ¯ï¼Œä¸-gcç›¸æ¯”ï¼Œå®ƒä¸ä»…è¾“å‡ºäº†å„ä¸ªä»£çš„å½“å‰å¤§å°ï¼Œè¿˜è¾“å‡ºäº†å„ä¸ªä»£çš„æœ€å¤§å€¼ä¸æœ€å°å€¼ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jstat -gccapacity 16309</div><div class="line"> NGCMN    NGCMX     NGC     S0C     S1C       EC        OGCMN      OGCMX   </div><div class="line">44032.0 699392.0 626176.0 45056.0 55296.0 336896.0    87040.0    1397760.0    </div><div class="line"> OGC       OC       MCMN    MCMX     MC       CCSMN    CCSMX     CCSC    YGC    FGC</div><div class="line">171520.0  171520.0    -       -      -        -        -        -      8        1</div><div class="line">nalideMacBook-Pro-4:~ nali$</div></pre></td></tr></table></figure>
<ul>
<li>NGCMNï¼šæ–°ç”Ÿä»£æœ€å°å€¼(KB)</li>
<li>NGCMXï¼šæ–°ç”Ÿä»£æœ€å¤§å€¼(KB)</li>
<li>NGCï¼šå½“å‰æ–°ç”Ÿä»£å¤§å°(KB)</li>
<li>OGCMNï¼šè€å¹´å¤§æœ€å°å€¼(KB)</li>
<li>OGCMXï¼šè€å¹´ä»£æœ€å¤§å€¼(KB)</li>
<li>OGCï¼šå½“å‰è€å¹´ä»£å¤§å°(KB)</li>
<li>MCMNï¼šæ–¹æ³•åŒºæœ€å°å€¼(KB)</li>
<li>MCMXï¼šæ–¹æ³•åŒºæœ€å¤§å€¼(KB)</li>
<li>CCSMNï¼šå‹ç¼©ç±»ç©ºé—´æœ€å°å€¼(KB)</li>
<li>CCSMXï¼šå‹ç¼©ç±»ç©ºé—´æœ€å¤§å€¼(KB)</li>
</ul>
<h5 id="gccauseä½¿ç”¨"><a href="#gccauseä½¿ç”¨" class="headerlink" title="-gccauseä½¿ç”¨"></a>-gccauseä½¿ç”¨</h5><p>ä¸‹é¢å‘½ä»¤æ˜¾ç¤ºæœ€è¿‘ä¸€æ¬¡gcçš„åŸå› ï¼Œä»¥åŠå½“å‰gcçš„åŸå› ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jstat -gccause 16309</div><div class="line">S0     S1     E      O      M     CCS    YGC    YGCT    FGC    FGCT     GCT   </div><div class="line">98.96  0.00  65.97  50.67   -      -      8      0.312    1    1.328    1.640</div><div class="line">LGCC                  GCC        </div><div class="line">Allocation Failure   No GC</div></pre></td></tr></table></figure>
<ul>
<li>LGCCï¼šä¸Šæ¬¡gcçš„åŸå› ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šæ¬¡gcçš„åŸå› æ˜¯Allocation Failure</li>
<li>GCCï¼šå½“å‰gcçš„åŸå› ï¼Œå½“å‰æ²¡æœ‰gc</li>
</ul>
<h5 id="gcnewä½¿ç”¨"><a href="#gcnewä½¿ç”¨" class="headerlink" title="-gcnewä½¿ç”¨"></a>-gcnewä½¿ç”¨</h5><p>ä¸‹é¢çš„å‘½ä»¤æ˜¾ç¤ºæ–°ç”Ÿä»£çš„è¯¦ç»†ä¿¡æ¯:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jstat -gcnew 16309</div><div class="line"> S0C    S1C     S0U        S1U  TT MTT  DSS      EC       EU        YGC   YGCT</div><div class="line">45056.0 55296.0 44588.0    0.0  5  15   55296.0  336896.0 222238.4  8     0.312</div></pre></td></tr></table></figure>
<ul>
<li>TTï¼šæ–°ç”Ÿä»£å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£å¯¹è±¡çš„å¹´é¾„ã€‚</li>
<li>MTTï¼šæ–°ç”Ÿä»£å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£å¯¹è±¡çš„å¹´é¾„çš„æœ€å¤§å€¼ã€‚</li>
<li>DSSï¼šæ‰€éœ€çš„SurvivoråŒºçš„å¤§å°ã€‚</li>
</ul>
<h5 id="gcnewcapacityä½¿ç”¨"><a href="#gcnewcapacityä½¿ç”¨" class="headerlink" title="-gcnewcapacityä½¿ç”¨"></a>-gcnewcapacityä½¿ç”¨</h5><p>ä¸‹é¢çš„å‘½ä»¤è¯¦ç»†è¾“å‡ºäº†æ–°ç”Ÿä»£å„ä¸ªåŒºçš„å¤§å°ä¿¡æ¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jstat -gcnewcapacity 16309</div><div class="line">NGCMN    NGCMX    NGC      S0CMX     S0C     S1CMX     S1C       ECMX        EC      </div><div class="line">44032.0  699392.0 626176.0 232960.0  45056.0 232960.0  55296.0   698368.0  336896.0     </div><div class="line">YGC   FGC</div><div class="line">8     1</div><div class="line">```   </div><div class="line"></div><div class="line">- S0CMXï¼šs0åŒºçš„æœ€å¤§å€¼(KB)</div><div class="line">- S1CMXï¼šs1åŒºçš„æœ€å¤§å€¼(KB)</div><div class="line">- ECMXï¼šedenåŒºçš„æœ€å¤§å€¼(KB)</div><div class="line"></div><div class="line"><span class="comment">##### -gcoldä½¿ç”¨</span></div><div class="line"></div><div class="line">ä¸‹é¢çš„å‘½ä»¤æ˜¾ç¤ºè€å¹´ä»£gcæ¦‚å†µï¼š</div><div class="line"></div><div class="line"></div><div class="line">``` bash</div><div class="line">nalideMacBook-Pro-4:~ nali$ jstat -gcold 16309</div><div class="line">MC   MU      CCSC     CCSU       OC          OU       YGC    FGC    FGCT     GCT</div><div class="line">-    -        -        -     171520.0      86902.0     8     1      1.328    1.640</div></pre></td></tr></table></figure>
<h5 id="gcoldcapacityä½¿ç”¨"><a href="#gcoldcapacityä½¿ç”¨" class="headerlink" title="-gcoldcapacityä½¿ç”¨"></a>-gcoldcapacityä½¿ç”¨</h5><p>ä¸‹é¢çš„å‘½ä»¤ç”¨äºæ˜¾ç¤ºè€å¹´ä»£çš„å®¹é‡ä¿¡æ¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jstat -gcoldcapacity 16309</div><div class="line">OGCMN       OGCMX        OGC         OC       YGC   FGC    FGCT     GCT</div><div class="line">87040.0   1397760.0    171520.0    171520.0     8     1    1.328    1.640</div></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[javaè°ƒè¯•-jpså‘½ä»¤]]></title>
      <url>http://zsr.github.io/2016/08/18/java%E8%B0%83%E8%AF%95-jps%E5%91%BD%E4%BB%A4/</url>
      <content type="html"><![CDATA[<h2 id="jpså‘½ä»¤ä½¿ç”¨"><a href="#jpså‘½ä»¤ä½¿ç”¨" class="headerlink" title="jpså‘½ä»¤ä½¿ç”¨"></a>jpså‘½ä»¤ä½¿ç”¨</h2><p>jpså‘½ä»¤ç±»ä¼¼äºlinuxä¸‹çš„pså‘½ä»¤ï¼Œç”¨äºåˆ—å‡ºå½“å‰æ­£åœ¨è¿è¡Œçš„æ‰€æœ‰javaè¿›ç¨‹ã€‚</p>
<h3 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h3><p>ç›´æ¥è¿è¡Œä¸åŠ ä»»ä½•å‚æ•°å°±èƒ½åˆ—å‡ºæ‰€æœ‰javaè¿›ç¨‹çš„pidå’Œç±»çš„çŸ­åç§°ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jps</div><div class="line">13698 Jps</div><div class="line">13640 TestJava</div><div class="line">50360</div></pre></td></tr></table></figure>
<h3 id="å¸¸ç”¨å‚æ•°"><a href="#å¸¸ç”¨å‚æ•°" class="headerlink" title="å¸¸ç”¨å‚æ•°"></a>å¸¸ç”¨å‚æ•°</h3><ul>
<li>-qå‚æ•°</li>
</ul>
<p>-qå¯ä»¥æŒ‡å®šjpsåªåˆ—å‡ºpid,è€Œä¸è¾“å‡ºç±»çš„çŸ­åç§°ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jps -q</div><div class="line">13959</div><div class="line">13640</div><div class="line">50360</div></pre></td></tr></table></figure>
<ul>
<li>-må‚æ•°</li>
</ul>
<p>-må‚æ•°å¯ä»¥ç”¨äºåˆ—å‡ºä¼ é€’ç»™javaè¿›ç¨‹ä¸»å‡½æ•°çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jps -m</div><div class="line">13640 TestJava</div><div class="line">50360</div><div class="line">14029 Jps -m</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä¼ é€’ç»™jpsï¼ˆjpsæœ¬èº«ä¹Ÿæ˜¯javaè¿›ç¨‹ï¼‰è¿›ç¨‹çš„å‚æ•°å°±æ˜¯-m</p>
<ul>
<li>-lå‚æ•°</li>
</ul>
<p>-lå‚æ•°ç”¨äºè¾“å‡ºä¸»ç±»çš„å®Œæ•´è·¯å¾„ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jps -l</div><div class="line">14198 sun.tools.jps.Jps</div><div class="line">13640 com.david.test.TestJava</div><div class="line">50360</div></pre></td></tr></table></figure>
<ul>
<li>-vå‚æ•°</li>
</ul>
<p>-vå‚æ•°å¯ä»¥åˆ—å‡ºä¼ é€’ç»™javaè™šæ‹Ÿæœºçš„å‚æ•°ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">nalideMacBook-Pro-4:~ nali$ jps -v</div><div class="line">14290 Jps -Dapplication.home=/Library/Java/JavaVirtualMachines/jdk1.8.0_91.jdk/Contents/Home -Xms8m</div><div class="line">13640 TestJava -agentlib:jdwp=transport=dt_socket,suspend=y,address=localhost:56353 -Dfile.encoding=UTF-8</div><div class="line">50360  -Dosgi.requiredJavaVersion=1.7 -XstartOnFirstThread -Dorg.eclipse.swt.internal.carbon.smallFonts -XX:MaxPermSize=256m -Xms256m -Xmx2048m -Xdock:icon=../Resources/Eclipse.icns -XstartOnFirstThread -Dorg.eclipse.swt.internal.carbon.smallFonts</div></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hashtable]]></title>
      <url>http://zsr.github.io/2016/08/17/HashTable/</url>
      <content type="html"><![CDATA[<h1 id="OpenJDK-æºä»£ç é˜…è¯»ä¹‹-Hashtable"><a href="#OpenJDK-æºä»£ç é˜…è¯»ä¹‹-Hashtable" class="headerlink" title="OpenJDK æºä»£ç é˜…è¯»ä¹‹ Hashtable"></a>OpenJDK æºä»£ç é˜…è¯»ä¹‹ Hashtable</h1><hr>
<h2 id="æ¦‚è¦"><a href="#æ¦‚è¦" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h2><ul>
<li>ç±»ç»§æ‰¿å…³ç³»</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">java.lang.Object</div><div class="line">    java.util.Dictionary&lt;K,V&gt;</div><div class="line">        java.util.Hashtable&lt;K,V&gt;</div></pre></td></tr></table></figure>
<ul>
<li>å®šä¹‰ </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public class Hashtable&lt;K,V&gt;</div><div class="line">    extends Dictionary&lt;K,V&gt;</div><div class="line">    implements Map&lt;K,V&gt;, Cloneable, java.io.Serializable</div></pre></td></tr></table></figure>
<ul>
<li>hashtable put()æ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">        <span class="comment">// Make sure the value is not null</span></div><div class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Makes sure the key is not already in the hashtable.</span></div><div class="line">        Entry tab[] = table;</div><div class="line">        <span class="comment">//åœ¨æ­¤å¤„è®¡ç®—keyçš„hashå€¼ï¼Œå¦‚æœæ­¤å¤„keyä¸ºnullï¼Œåˆ™ç›´æ¥æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</span></div><div class="line">        <span class="keyword">int</span> hash = hash(key);</div><div class="line">        <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</div><div class="line">        <span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</div><div class="line">            <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</div><div class="line">                V old = e.value;</div><div class="line">                e.value = value;</div><div class="line">                <span class="keyword">return</span> old;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        modCount++;</div><div class="line">        <span class="keyword">if</span> (count &gt;= threshold) &#123;</div><div class="line">            <span class="comment">// Rehash the table if the threshold is exceeded</span></div><div class="line">            rehash();</div><div class="line"></div><div class="line">            tab = table;</div><div class="line">            hash = hash(key);</div><div class="line">            index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Creates the new entry.</span></div><div class="line">        Entry&lt;K,V&gt; e = tab[index];</div><div class="line">        tab[index] = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, e);</div><div class="line">        count++;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li>hashtable get()æ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">        Entry tab[] = table;</div><div class="line">        <span class="keyword">int</span> hash = hash(key);</div><div class="line">        <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</div><div class="line">        <span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</div><div class="line">            <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</div><div class="line">                <span class="keyword">return</span> e.value;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>get()å’Œput()éƒ½ä½¿ç”¨äº†<code>synchronized</code>åŠ é”ï¼Œå®¹æ˜“é˜»å¡ï¼Œæ•ˆç‡ä½ã€‚<strong>hashtableä¸å…è®¸valueä¸ºnull</strong></p>
<ul>
<li>hashMap put()æ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (table == EMPTY_TABLE) &#123;</div><div class="line">            inflateTable(threshold);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> putForNullKey(value);</div><div class="line">        <span class="keyword">int</span> hash = hash(key);</div><div class="line">        <span class="keyword">int</span> i = indexFor(hash, table.length);</div><div class="line">        <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</div><div class="line">            Object k;</div><div class="line">            <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</div><div class="line">                V oldValue = e.value;</div><div class="line">                e.value = value;</div><div class="line">                e.recordAccess(<span class="keyword">this</span>);</div><div class="line">                <span class="keyword">return</span> oldValue;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        modCount++;</div><div class="line">        addEntry(hash, key, value, i);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li>hashMap get()æ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (key == <span class="keyword">null</span>)</div><div class="line">           <span class="keyword">return</span> getForNullKey();</div><div class="line">       Entry&lt;K,V&gt; entry = getEntry(key);</div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span> == entry ? <span class="keyword">null</span> : entry.getValue();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p><strong>hashMapå¤šçº¿ç¨‹ç¯å¢ƒä¸å®‰å…¨ã€‚</strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ConcurrentHashMap]]></title>
      <url>http://zsr.github.io/2016/08/17/ConcurrentHashMap/</url>
      <content type="html"><![CDATA[<h1 id="OpenJDK-æºä»£ç é˜…è¯»ä¹‹-ConcurrentHashMap"><a href="#OpenJDK-æºä»£ç é˜…è¯»ä¹‹-ConcurrentHashMap" class="headerlink" title="OpenJDK æºä»£ç é˜…è¯»ä¹‹ ConcurrentHashMap"></a>OpenJDK æºä»£ç é˜…è¯»ä¹‹ ConcurrentHashMap</h1><hr>
<h3 id="ConcurrentHashMap-ä½œç”¨"><a href="#ConcurrentHashMap-ä½œç”¨" class="headerlink" title="ConcurrentHashMap ä½œç”¨"></a>ConcurrentHashMap ä½œç”¨</h3><p>å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨<code>Hashmap</code>è¿›è¡Œputæ“ä½œä¼šå¼•èµ·æ­»å¾ªç¯ï¼Œå¯¼è‡´CPUåˆ©ç”¨ç‡æ¥è¿‘100%ï¼Œæ‰€ä»¥åœ¨å¹¶å‘æƒ…å†µä¸‹ä¸èƒ½ä½¿ç”¨HashMapã€‚è™½ç„¶å·²ç»æœ‰ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„<code>HashTable</code>ï¼Œä½†æ˜¯HashTableå®¹å™¨ä½¿ç”¨synchronizedï¼ˆä»–çš„getå’Œputæ–¹æ³•çš„å®ç°ä»£ç å¦‚ä¸‹ï¼‰æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œåœ¨çº¿ç¨‹ç«äº‰æ¿€çƒˆçš„æƒ…å†µä¸‹HashTableçš„æ•ˆç‡éå¸¸ä½ä¸‹ã€‚å› ä¸ºå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®HashTableçš„åŒæ­¥æ–¹æ³•æ—¶ï¼Œè®¿é—®å…¶ä»–åŒæ­¥æ–¹æ³•çš„çº¿ç¨‹å°±å¯èƒ½ä¼šè¿›å…¥é˜»å¡æˆ–è€…è½®è®­çŠ¶æ€ã€‚å¦‚çº¿ç¨‹1ä½¿ç”¨putè¿›è¡Œæ·»åŠ å…ƒç´ ï¼Œçº¿ç¨‹2ä¸ä½†ä¸èƒ½ä½¿ç”¨putæ–¹æ³•æ·»åŠ å…ƒç´ ï¼Œå¹¶ä¸”ä¹Ÿä¸èƒ½ä½¿ç”¨getæ–¹æ³•æ¥è·å–å…ƒç´ ï¼Œæ‰€ä»¥ç«äº‰è¶Šæ¿€çƒˆæ•ˆç‡è¶Šä½ã€‚</p>
<p>Hashtable get()æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">    Entry&lt;?,?&gt; tab[] = table;</div><div class="line">    <span class="keyword">int</span> hash = key.hashCode();</div><div class="line">    <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</div><div class="line">    <span class="keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</div><div class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</div><div class="line">            <span class="keyword">return</span> (V)e.value;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Hashtable put()æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">    <span class="comment">// Make sure the value is not null</span></div><div class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Makes sure the key is not already in the hashtable.</span></div><div class="line">    Entry&lt;?,?&gt; tab[] = table;</div><div class="line">    <span class="keyword">int</span> hash = key.hashCode();</div><div class="line">    <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    Entry&lt;K,V&gt; entry = (Entry&lt;K,V&gt;)tab[index];</div><div class="line">    <span class="keyword">for</span>(; entry != <span class="keyword">null</span> ; entry = entry.next) &#123;</div><div class="line">        <span class="keyword">if</span> ((entry.hash == hash) &amp;&amp; entry.key.equals(key)) &#123;</div><div class="line">            V old = entry.value;</div><div class="line">            entry.value = value;</div><div class="line">            <span class="keyword">return</span> old;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    addEntry(hash, key, value, index);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h3><p>ConcurrentHashMapä½¿ç”¨åˆ†æ®µé”æŠ€æœ¯ï¼Œå°†æ•°æ®åˆ†æˆä¸€æ®µä¸€æ®µçš„å­˜å‚¨ï¼Œç„¶åç»™æ¯ä¸€æ®µæ•°æ®é…ä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®å…¶ä¸­ä¸€ä¸ªæ®µæ•°æ®çš„æ—¶å€™ï¼Œå…¶ä»–æ®µçš„æ•°æ®ä¹Ÿèƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ï¼Œèƒ½å¤Ÿå®ç°çœŸæ­£çš„å¹¶å‘è®¿é—®ã€‚å¦‚ä¸‹å›¾æ˜¯ConcurrentHashMapçš„å†…éƒ¨ç»“æ„å›¾ï¼š</p>
<p><img src="/images/ConcurrentHashMap.png"></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒConcurrentHashMapå†…éƒ¨åˆ†ä¸ºå¾ˆå¤šä¸ªSegmentï¼Œæ¯ä¸€ä¸ªSegmentæ‹¥æœ‰ä¸€æŠŠé”ï¼Œç„¶åæ¯ä¸ªSegmentï¼ˆç»§æ‰¿ReentrantLockï¼‰ä¸‹é¢åŒ…å«å¾ˆå¤šä¸ªHashEntryåˆ—è¡¨æ•°ç»„ã€‚å¯¹äºä¸€ä¸ªkeyï¼Œéœ€è¦ç»è¿‡ä¸‰æ¬¡ï¼ˆä¸ºä»€ä¹ˆè¦hashä¸‰æ¬¡ä¸‹æ–‡ä¼šè¯¦ç»†è®²è§£ï¼‰hashæ“ä½œï¼Œæ‰èƒ½æœ€ç»ˆå®šä½è¿™ä¸ªå…ƒç´ çš„ä½ç½®ï¼Œè¿™ä¸‰æ¬¡hashåˆ†åˆ«ä¸ºï¼š</p>
<ul>
<li>å¯¹äºä¸€ä¸ªkeyï¼Œå…ˆè¿›è¡Œä¸€æ¬¡hashæ“ä½œï¼Œå¾—åˆ°hashå€¼h1ï¼Œä¹Ÿå³h1 = hash1(key)ï¼›</li>
<li>å°†å¾—åˆ°çš„h1çš„é«˜å‡ ä½è¿›è¡Œç¬¬äºŒæ¬¡hashï¼Œå¾—åˆ°hashå€¼h2ï¼Œä¹Ÿå³h2 = hash2(h1é«˜å‡ ä½)ï¼Œé€šè¿‡h2èƒ½å¤Ÿç¡®å®šè¯¥å…ƒç´ çš„æ”¾åœ¨å“ªä¸ªSegmentï¼›</li>
<li>å°†å¾—åˆ°çš„h1è¿›è¡Œç¬¬ä¸‰æ¬¡hashï¼Œå¾—åˆ°hashå€¼h3ï¼Œä¹Ÿå³h3 = hash3(h1)ï¼Œé€šè¿‡h3èƒ½å¤Ÿç¡®å®šè¯¥å…ƒç´ æ”¾ç½®åœ¨å“ªä¸ªHashEntryã€‚</li>
</ul>
<a id="more"></a>
<h4 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><p>æ„é€ å‡½æ•°çš„æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></div><div class="line">                         <span class="keyword">float</span> loadFactor, <span class="keyword">int</span> concurrencyLevel) &#123;</div><div class="line">        <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</div><div class="line">        <span class="keyword">if</span> (concurrencyLevel &gt; MAX_SEGMENTS)</div><div class="line">            concurrencyLevel = MAX_SEGMENTS;</div><div class="line">        <span class="comment">// Find power-of-two sizes best matching arguments</span></div><div class="line">        <span class="keyword">int</span> sshift = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> ssize = <span class="number">1</span>;</div><div class="line">        <span class="keyword">while</span> (ssize &lt; concurrencyLevel) &#123;</div><div class="line">            ++sshift;</div><div class="line">            ssize &lt;&lt;= <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.segmentShift = <span class="number">32</span> - sshift;</div><div class="line">        <span class="keyword">this</span>.segmentMask = ssize - <span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</div><div class="line">            initialCapacity = MAXIMUM_CAPACITY;</div><div class="line">        <span class="keyword">int</span> c = initialCapacity / ssize;</div><div class="line">        <span class="keyword">if</span> (c * ssize &lt; initialCapacity)</div><div class="line">            ++c;</div><div class="line">        <span class="keyword">int</span> cap = MIN_SEGMENT_TABLE_CAPACITY;</div><div class="line">        <span class="keyword">while</span> (cap &lt; c)</div><div class="line">            cap &lt;&lt;= <span class="number">1</span>;</div><div class="line">        <span class="comment">// create segments and segments[0]</span></div><div class="line">        Segment&lt;K,V&gt; s0 =</div><div class="line">            <span class="keyword">new</span> Segment&lt;K,V&gt;(loadFactor, (<span class="keyword">int</span>)(cap * loadFactor),</div><div class="line">                             (HashEntry&lt;K,V&gt;[])<span class="keyword">new</span> HashEntry[cap]);</div><div class="line">        Segment&lt;K,V&gt;[] ss = (Segment&lt;K,V&gt;[])<span class="keyword">new</span> Segment[ssize];</div><div class="line">        UNSAFE.putOrderedObject(ss, SBASE, s0); <span class="comment">// ordered write of segments[0]</span></div><div class="line">        <span class="keyword">this</span>.segments = ss;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><strong>ä¼ å…¥çš„å‚æ•°æœ‰initialCapacityï¼ŒloadFactorï¼ŒconcurrencyLevelè¿™ä¸‰ä¸ªã€‚</strong></p>
<ul>
<li>initialCapacityè¡¨ç¤ºæ–°åˆ›å»ºçš„è¿™ä¸ªConcurrentHashMapçš„åˆå§‹å®¹é‡ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ç»“æ„å›¾ä¸­çš„Entryæ•°é‡ã€‚é»˜è®¤å€¼ä¸ºstatic final int DEFAULT_INITIAL_CAPACITY = 16;</li>
<li>loadFactorè¡¨ç¤ºè´Ÿè½½å› å­ï¼Œå°±æ˜¯å½“ConcurrentHashMapä¸­çš„å…ƒç´ ä¸ªæ•°å¤§äºloadFactor * æœ€å¤§å®¹é‡æ—¶å°±éœ€è¦rehashï¼Œæ‰©å®¹ã€‚é»˜è®¤å€¼ä¸ºstatic final float DEFAULT_LOAD_FACTOR = 0.75f;</li>
<li>concurrencyLevelè¡¨ç¤ºå¹¶å‘çº§åˆ«ï¼Œè¿™ä¸ªå€¼ç”¨æ¥ç¡®å®šSegmentçš„ä¸ªæ•°ï¼ŒSegmentçš„ä¸ªæ•°æ˜¯å¤§äºç­‰äºconcurrencyLevelçš„ç¬¬ä¸€ä¸ª2çš„næ¬¡æ–¹çš„æ•°ã€‚æ¯”å¦‚ï¼Œå¦‚æœconcurrencyLevelä¸º12ï¼Œ13ï¼Œ14ï¼Œ15ï¼Œ16è¿™äº›æ•°ï¼Œåˆ™Segmentçš„æ•°ç›®ä¸º16(2çš„4æ¬¡æ–¹)ã€‚é»˜è®¤å€¼ä¸ºstatic final int DEFAULT_CONCURRENCY_LEVEL = 16;ã€‚ç†æƒ³æƒ…å†µä¸‹ConcurrentHashMapçš„çœŸæ­£çš„å¹¶å‘è®¿é—®é‡èƒ½å¤Ÿè¾¾åˆ°concurrencyLevelï¼Œå› ä¸ºæœ‰concurrencyLevelä¸ªSegmentï¼Œå‡å¦‚æœ‰concurrencyLevelä¸ªçº¿ç¨‹éœ€è¦è®¿é—®Mapï¼Œå¹¶ä¸”éœ€è¦è®¿é—®çš„æ•°æ®éƒ½æ°å¥½åˆ†åˆ«è½åœ¨ä¸åŒçš„Segmentä¸­ï¼Œåˆ™è¿™äº›çº¿ç¨‹èƒ½å¤Ÿæ— ç«äº‰åœ°è‡ªç”±è®¿é—®ï¼ˆå› ä¸ºä»–ä»¬ä¸éœ€è¦ç«äº‰åŒä¸€æŠŠé”ï¼‰ï¼Œè¾¾åˆ°åŒæ—¶è®¿é—®çš„æ•ˆæœã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿™ä¸ªå‚æ•°èµ·åä¸ºâ€œå¹¶å‘çº§åˆ«â€çš„åŸå› ã€‚</li>
</ul>
<p><strong>åˆå§‹åŒ–çš„ä¸€äº›åŠ¨ä½œï¼š</strong></p>
<ul>
<li>éªŒè¯å‚æ•°çš„åˆæ³•æ€§ï¼Œå¦‚æœä¸åˆæ³•ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>concurrencyLevelä¹Ÿå°±æ˜¯Segmentçš„ä¸ªæ•°ä¸èƒ½è¶…è¿‡è§„å®šçš„æœ€å¤§Segmentçš„ä¸ªæ•°ï¼Œé»˜è®¤å€¼ä¸ºstatic final int MAX_SEGMENTS = 1 &lt;&lt; 16;ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªå€¼ï¼Œè®¾ç½®ä¸ºè¿™ä¸ªå€¼ã€‚</li>
<li>ç„¶åä½¿ç”¨å¾ªç¯æ‰¾åˆ°å¤§äºç­‰äºconcurrencyLevelçš„ç¬¬ä¸€ä¸ª2çš„næ¬¡æ–¹çš„æ•°ssizeï¼Œè¿™ä¸ªæ•°å°±æ˜¯Segmentæ•°ç»„çš„å¤§å°ï¼Œå¹¶è®°å½•ä¸€å…±å‘å·¦æŒ‰ä½ç§»åŠ¨çš„æ¬¡æ•°sshiftï¼Œå¹¶ä»¤segmentShift = 32 - sshiftï¼Œå¹¶ä¸”segmentMaskçš„å€¼ç­‰äºssize - 1ï¼ŒsegmentMaskçš„å„ä¸ªäºŒè¿›åˆ¶ä½éƒ½ä¸º1ï¼Œç›®çš„æ˜¯ä¹‹åå¯ä»¥é€šè¿‡keyçš„hashå€¼ä¸è¿™ä¸ªå€¼åš&amp;è¿ç®—ç¡®å®šSegmentçš„ç´¢å¼•ã€‚</li>
<li>æ£€æŸ¥ç»™çš„å®¹é‡å€¼æ˜¯å¦å¤§äºå…è®¸çš„æœ€å¤§å®¹é‡å€¼ï¼Œå¦‚æœå¤§äºè¯¥å€¼ï¼Œè®¾ç½®ä¸ºè¯¥å€¼ã€‚æœ€å¤§å®¹é‡å€¼ä¸ºstatic final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30;ã€‚</li>
<li>ç„¶åè®¡ç®—æ¯ä¸ªSegmentå¹³å‡åº”è¯¥æ”¾ç½®å¤šå°‘ä¸ªå…ƒç´ ï¼Œè¿™ä¸ªå€¼cæ˜¯å‘ä¸Šå–æ•´çš„å€¼ã€‚æ¯”å¦‚åˆå§‹å®¹é‡ä¸º15ï¼ŒSegmentä¸ªæ•°ä¸º4ï¼Œåˆ™æ¯ä¸ªSegmentå¹³å‡éœ€è¦æ”¾ç½®4ä¸ªå…ƒç´ ã€‚</li>
<li>æœ€ååˆ›å»ºä¸€ä¸ªSegmentå®ä¾‹ï¼Œå°†å…¶å½“åšSegmentæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</li>
</ul>
<h4 id="putæ“ä½œ"><a href="#putæ“ä½œ" class="headerlink" title="putæ“ä½œ"></a>putæ“ä½œ</h4><p>putæ“ä½œçš„æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">      Segment&lt;K,V&gt; s;</div><div class="line">      <span class="keyword">if</span> (value == <span class="keyword">null</span>)</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">      <span class="keyword">int</span> hash = hash(key);</div><div class="line">      <span class="keyword">int</span> j = (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;</div><div class="line">      <span class="keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObject          <span class="comment">// nonvolatile; recheck</span></div><div class="line">           (segments, (j &lt;&lt; SSHIFT) + SBASE)) == <span class="keyword">null</span>) <span class="comment">//  in ensureSegment</span></div><div class="line">          s = ensureSegment(j);</div><div class="line">      <span class="keyword">return</span> s.put(key, hash, value, <span class="keyword">false</span>);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p><strong>æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li>åˆ¤æ–­valueæ˜¯å¦ä¸ºnullï¼Œå¦‚æœä¸ºnullï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>keyé€šè¿‡ä¸€æ¬¡hashè¿ç®—å¾—åˆ°ä¸€ä¸ªhashå€¼ã€‚(è¿™ä¸ªhashè¿ç®—ä¸‹æ–‡è¯¦è¯´)</li>
<li>å°†å¾—åˆ°hashå€¼å‘å³æŒ‰ä½ç§»åŠ¨segmentShiftä½ï¼Œç„¶åå†ä¸segmentMaskåš&amp;è¿ç®—å¾—åˆ°segmentçš„ç´¢å¼•jã€‚<br>åœ¨åˆå§‹åŒ–çš„æ—¶å€™æˆ‘ä»¬è¯´è¿‡segmentShiftçš„å€¼ç­‰äº32-sshiftï¼Œä¾‹å¦‚concurrencyLevelç­‰äº16ï¼Œåˆ™sshiftç­‰äº4ï¼Œåˆ™segmentShiftä¸º28ã€‚hashå€¼æ˜¯ä¸€ä¸ª32ä½çš„æ•´æ•°ï¼Œå°†å…¶å‘å³ç§»åŠ¨28ä½å°±å˜æˆè¿™ä¸ªæ ·å­ï¼š<br>0000 0000 0000 0000 0000 0000 0000 xxxxï¼Œç„¶åå†ç”¨è¿™ä¸ªå€¼ä¸segmentMaskåš&amp;è¿ç®—ï¼Œä¹Ÿå°±æ˜¯å–æœ€åå››ä½çš„å€¼ã€‚è¿™ä¸ªå€¼ç¡®å®šSegmentçš„ç´¢å¼•ã€‚</li>
<li>ä½¿ç”¨Unsafeçš„æ–¹å¼ä»Segmentæ•°ç»„ä¸­è·å–è¯¥ç´¢å¼•å¯¹åº”çš„Segmentå¯¹è±¡ã€‚</li>
<li>å‘è¿™ä¸ªSegmentå¯¹è±¡ä¸­putå€¼ï¼Œè¿™ä¸ªputæ“ä½œä¹ŸåŸºæœ¬æ˜¯ä¸€æ ·çš„æ­¥éª¤ï¼ˆé€šè¿‡&amp;è¿ç®—è·å–HashEntryçš„ç´¢å¼•ï¼Œç„¶åsetï¼‰ã€‚</li>
</ul>
<h4 id="getæ“ä½œ"><a href="#getæ“ä½œ" class="headerlink" title="getæ“ä½œ"></a>getæ“ä½œ</h4><p>getæ“ä½œçš„æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">        Segment&lt;K,V&gt; s; <span class="comment">// manually integrate access methods to reduce overhead</span></div><div class="line">        HashEntry&lt;K,V&gt;[] tab;</div><div class="line">        <span class="keyword">int</span> h = hash(key);</div><div class="line">        <span class="keyword">long</span> u = (((h &gt;&gt;&gt; segmentShift) &amp; segmentMask) &lt;&lt; SSHIFT) + SBASE;</div><div class="line">        <span class="keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(segments, u)) != <span class="keyword">null</span> &amp;&amp;</div><div class="line">            (tab = s.table) != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (HashEntry&lt;K,V&gt; e = (HashEntry&lt;K,V&gt;) UNSAFE.getObjectVolatile</div><div class="line">                     (tab, ((<span class="keyword">long</span>)(((tab.length - <span class="number">1</span>) &amp; h)) &lt;&lt; TSHIFT) + TBASE);</div><div class="line">                 e != <span class="keyword">null</span>; e = e.next) &#123;</div><div class="line">                K k;</div><div class="line">                <span class="keyword">if</span> ((k = e.key) == key || (e.hash == h &amp;&amp; key.equals(k)))</div><div class="line">                    <span class="keyword">return</span> e.value;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><strong>æ“ä½œæ­¥éª¤ä¸ºï¼š</strong></p>
<ul>
<li>å’Œputæ“ä½œä¸€æ ·ï¼Œå…ˆé€šè¿‡keyè¿›è¡Œä¸¤æ¬¡hashç¡®å®šåº”è¯¥å»å“ªä¸ªSegmentä¸­å–æ•°æ®ã€‚</li>
<li>ä½¿ç”¨Unsafeè·å–å¯¹åº”çš„Segmentï¼Œç„¶åå†è¿›è¡Œä¸€æ¬¡&amp;è¿ç®—å¾—åˆ°HashEntryé“¾è¡¨çš„ä½ç½®ï¼Œç„¶åä»é“¾è¡¨å¤´å¼€å§‹éå†æ•´ä¸ªé“¾è¡¨ï¼ˆå› ä¸ºHashå¯èƒ½ä¼šæœ‰ç¢°æ’ï¼Œæ‰€ä»¥ç”¨ä¸€ä¸ªé“¾è¡¨ä¿å­˜ï¼‰ï¼Œå¦‚æœæ‰¾åˆ°å¯¹åº”çš„keyï¼Œåˆ™è¿”å›å¯¹åº”çš„valueå€¼ï¼Œå¦‚æœé“¾è¡¨éå†å®Œéƒ½æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„keyï¼Œåˆ™è¯´æ˜Mapä¸­ä¸åŒ…å«è¯¥keyï¼Œè¿”å›nullã€‚</li>
</ul>
<h4 id="sizeæ“ä½œ"><a href="#sizeæ“ä½œ" class="headerlink" title="sizeæ“ä½œ"></a>sizeæ“ä½œ</h4><p>sizeæ“ä½œä¸putå’Œgetæ“ä½œæœ€å¤§çš„åŒºåˆ«åœ¨äºï¼Œsizeæ“ä½œéœ€è¦éå†æ‰€æœ‰çš„Segmentæ‰èƒ½ç®—å‡ºæ•´ä¸ªMapçš„å¤§å°ï¼Œè€Œputå’Œgetéƒ½åªå…³å¿ƒä¸€ä¸ªSegmentã€‚å‡è®¾æˆ‘ä»¬å½“å‰éå†çš„Segmentä¸ºSAï¼Œé‚£ä¹ˆåœ¨éå†SAè¿‡ç¨‹ä¸­å…¶ä»–çš„Segmentæ¯”å¦‚SBå¯èƒ½ä¼šè¢«ä¿®æ”¹ï¼Œäºæ˜¯è¿™ä¸€æ¬¡è¿ç®—å‡ºæ¥çš„sizeå€¼å¯èƒ½å¹¶ä¸æ˜¯Mapå½“å‰çš„çœŸæ­£å¤§å°ã€‚æ‰€ä»¥ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„åŠæ³•å°±æ˜¯è®¡ç®—Mapå¤§å°çš„æ—¶å€™æ‰€æœ‰çš„Segmentéƒ½Lockä½ï¼Œä¸èƒ½æ›´æ–°(åŒ…å«putï¼Œremoveç­‰ç­‰)æ•°æ®ï¼Œè®¡ç®—å®Œä¹‹åå†Unlockã€‚è¿™æ˜¯æ™®é€šäººèƒ½å¤Ÿæƒ³åˆ°çš„æ–¹æ¡ˆï¼Œä½†æ˜¯ç‰›é€¼çš„ä½œè€…è¿˜æœ‰ä¸€ä¸ªæ›´å¥½çš„Ideaï¼š<strong>å…ˆç»™3æ¬¡æœºä¼šï¼Œä¸lockæ‰€æœ‰çš„Segmentï¼Œéå†æ‰€æœ‰Segmentï¼Œç´¯åŠ å„ä¸ªSegmentçš„å¤§å°å¾—åˆ°æ•´ä¸ªMapçš„å¤§å°ï¼Œå¦‚æœæŸç›¸é‚»çš„ä¸¤æ¬¡è®¡ç®—è·å–çš„æ‰€æœ‰Segmentçš„æ›´æ–°çš„æ¬¡æ•°ï¼ˆæ¯ä¸ªSegmentéƒ½æœ‰ä¸€ä¸ªmodCountå˜é‡ï¼Œè¿™ä¸ªå˜é‡åœ¨Segmentä¸­çš„Entryè¢«ä¿®æ”¹æ—¶ä¼šåŠ ä¸€ï¼Œé€šè¿‡è¿™ä¸ªå€¼å¯ä»¥å¾—åˆ°æ¯ä¸ªSegmentçš„æ›´æ–°æ“ä½œçš„æ¬¡æ•°ï¼‰æ˜¯ä¸€æ ·çš„ï¼Œè¯´æ˜è®¡ç®—è¿‡ç¨‹ä¸­æ²¡æœ‰æ›´æ–°æ“ä½œï¼Œåˆ™ç›´æ¥è¿”å›è¿™ä¸ªå€¼ã€‚å¦‚æœè¿™ä¸‰æ¬¡ä¸åŠ é”çš„è®¡ç®—è¿‡ç¨‹ä¸­Mapçš„æ›´æ–°æ¬¡æ•°æœ‰å˜åŒ–ï¼Œåˆ™ä¹‹åçš„è®¡ç®—å…ˆå¯¹æ‰€æœ‰çš„SegmentåŠ é”ï¼Œå†éå†æ‰€æœ‰Segmentè®¡ç®—Mapå¤§å°ï¼Œæœ€åå†è§£é”æ‰€æœ‰Segmentã€‚</strong>æºä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Try a few times to get accurate count. On failure due to</span></div><div class="line">        <span class="comment">// continuous async changes in table, resort to locking.</span></div><div class="line">        <span class="keyword">final</span> Segment&lt;K,V&gt;[] segments = <span class="keyword">this</span>.segments;</div><div class="line">        <span class="keyword">int</span> size;</div><div class="line">        <span class="keyword">boolean</span> overflow; <span class="comment">// true if size overflows 32 bits</span></div><div class="line">        <span class="keyword">long</span> sum;         <span class="comment">// sum of modCounts</span></div><div class="line">        <span class="keyword">long</span> last = <span class="number">0L</span>;   <span class="comment">// previous sum</span></div><div class="line">        <span class="keyword">int</span> retries = -<span class="number">1</span>; <span class="comment">// first iteration isn't retry</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">for</span> (;;) &#123;</div><div class="line">                <span class="keyword">if</span> (retries++ == RETRIES_BEFORE_LOCK) &#123;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; segments.length; ++j)</div><div class="line">                        ensureSegment(j).lock(); <span class="comment">// force creation</span></div><div class="line">                &#125;</div><div class="line">                sum = <span class="number">0L</span>;</div><div class="line">                size = <span class="number">0</span>;</div><div class="line">                overflow = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; segments.length; ++j) &#123;</div><div class="line">                    Segment&lt;K,V&gt; seg = segmentAt(segments, j);</div><div class="line">                    <span class="keyword">if</span> (seg != <span class="keyword">null</span>) &#123;</div><div class="line">                        sum += seg.modCount;</div><div class="line">                        <span class="keyword">int</span> c = seg.count;</div><div class="line">                        <span class="keyword">if</span> (c &lt; <span class="number">0</span> || (size += c) &lt; <span class="number">0</span>)</div><div class="line">                            overflow = <span class="keyword">true</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (sum == last)</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                last = sum;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (retries &gt; RETRIES_BEFORE_LOCK) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; segments.length; ++j)</div><div class="line">                    segmentAt(segments, j).unlock();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> overflow ? Integer.MAX_VALUE : size;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<p><code>ä¸€ä¸ªMapæœ‰4ä¸ªSegmentï¼Œæ ‡è®°ä¸ºS1ï¼ŒS2ï¼ŒS3ï¼ŒS4ï¼Œç°åœ¨æˆ‘ä»¬è¦è·å–Mapçš„sizeã€‚è®¡ç®—è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šç¬¬ä¸€æ¬¡è®¡ç®—ï¼Œä¸å¯¹S1ï¼ŒS2ï¼ŒS3ï¼ŒS4åŠ é”ï¼Œéå†æ‰€æœ‰çš„Segmentï¼Œå‡è®¾æ¯ä¸ªSegmentçš„å¤§å°åˆ†åˆ«ä¸º1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œæ›´æ–°æ“ä½œæ¬¡æ•°åˆ†åˆ«ä¸ºï¼š2ï¼Œ2ï¼Œ3ï¼Œ1ï¼Œåˆ™è¿™æ¬¡è®¡ç®—å¯ä»¥å¾—åˆ°Mapçš„æ€»å¤§å°ä¸º1+2+3+4=10ï¼Œæ€»å…±æ›´æ–°æ“ä½œæ¬¡æ•°ä¸º2+2+3+1=8ï¼›ç¬¬äºŒæ¬¡è®¡ç®—ï¼Œä¸å¯¹S1,S2,S3,S4åŠ é”ï¼Œéå†æ‰€æœ‰Segmentï¼Œå‡è®¾è¿™æ¬¡æ¯ä¸ªSegmentçš„å¤§å°å˜æˆäº†2ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œæ›´æ–°æ¬¡æ•°åˆ†åˆ«ä¸º3ï¼Œ2ï¼Œ3ï¼Œ1ï¼Œå› ä¸ºä¸¤æ¬¡è®¡ç®—å¾—åˆ°çš„Mapæ›´æ–°æ¬¡æ•°ä¸ä¸€è‡´(ç¬¬ä¸€æ¬¡æ˜¯8ï¼Œç¬¬äºŒæ¬¡æ˜¯9)åˆ™å¯ä»¥æ–­å®šè¿™æ®µæ—¶é—´Mapæ•°æ®è¢«æ›´æ–°ï¼Œåˆ™æ­¤æ—¶åº”è¯¥å†è¯•ä¸€æ¬¡ï¼›ç¬¬ä¸‰æ¬¡è®¡ç®—ï¼Œä¸å¯¹S1ï¼ŒS2ï¼ŒS3ï¼ŒS4åŠ é”ï¼Œéå†æ‰€æœ‰Segmentï¼Œå‡è®¾æ¯ä¸ªSegmentçš„æ›´æ–°æ“ä½œæ¬¡æ•°è¿˜æ˜¯ä¸º3ï¼Œ2ï¼Œ3ï¼Œ1ï¼Œåˆ™å› ä¸ºç¬¬äºŒæ¬¡è®¡ç®—å’Œç¬¬ä¸‰æ¬¡è®¡ç®—å¾—åˆ°çš„Mapçš„æ›´æ–°æ“ä½œçš„æ¬¡æ•°æ˜¯ä¸€è‡´çš„ï¼Œå°±èƒ½è¯´æ˜ç¬¬äºŒæ¬¡è®¡ç®—å’Œç¬¬ä¸‰æ¬¡è®¡ç®—è¿™æ®µæ—¶é—´å†…Mapæ•°æ®æ²¡æœ‰è¢«æ›´æ–°ï¼Œæ­¤æ—¶å¯ä»¥ç›´æ¥è¿”å›ç¬¬ä¸‰æ¬¡è®¡ç®—å¾—åˆ°çš„Mapçš„å¤§å°ã€‚æœ€åçš„æƒ…å†µï¼šç¬¬ä¸‰æ¬¡è®¡ç®—å¾—åˆ°çš„æ•°æ®æ›´æ–°æ¬¡æ•°å’Œç¬¬äºŒæ¬¡ä¹Ÿä¸ä¸€æ ·ï¼Œåˆ™åªèƒ½å…ˆå¯¹æ‰€æœ‰SegmentåŠ é”å†è®¡ç®—æœ€åè§£é”ã€‚</code></p>
<h3 id="å…³äºhash"><a href="#å…³äºhash" class="headerlink" title="å…³äºhash"></a>å…³äºhash</h3><table>
<thead>
<tr>
<th style="text-align:center">æœ¯è¯­</th>
<th style="text-align:center">è‹±æ–‡</th>
<th style="text-align:center">è§£é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">å“ˆå¸Œç®—æ³•</td>
<td style="text-align:center">hash algorithm</td>
<td style="text-align:center">æ˜¯ä¸€ç§å°†ä»»æ„å†…å®¹çš„è¾“å…¥è½¬æ¢æˆç›¸åŒé•¿åº¦è¾“å‡ºçš„åŠ å¯†æ–¹å¼ï¼Œå…¶è¾“å‡ºè¢«ç§°ä¸ºå“ˆå¸Œå€¼ã€‚</td>
</tr>
<tr>
<td style="text-align:center">å“ˆå¸Œè¡¨</td>
<td style="text-align:center">hash table</td>
<td style="text-align:center">æ ¹æ®è®¾å®šçš„å“ˆå¸Œå‡½æ•°H(key)å’Œå¤„ç†å†²çªæ–¹æ³•å°†ä¸€ç»„å…³é”®å­—æ˜ è±¡åˆ°ä¸€ä¸ªæœ‰é™çš„åœ°å€åŒºé—´ä¸Šï¼Œå¹¶ä»¥å…³é”®å­—åœ¨åœ°å€åŒºé—´ä¸­çš„è±¡ä½œä¸ºè®°å½•åœ¨è¡¨ä¸­çš„å­˜å‚¨ä½ç½®ï¼Œè¿™ç§è¡¨ç§°ä¸ºå“ˆå¸Œè¡¨æˆ–æ•£åˆ—ï¼Œæ‰€å¾—å­˜å‚¨ä½ç½®ç§°ä¸ºå“ˆå¸Œåœ°å€æˆ–æ•£åˆ—åœ°å€ã€‚</td>
</tr>
</tbody>
</table>
<p>hashçš„æºä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object k)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> h = hashSeed;</div><div class="line">        <span class="keyword">if</span> ((<span class="number">0</span> != h) &amp;&amp; (k <span class="keyword">instanceof</span> String)) &#123;</div><div class="line">            <span class="keyword">return</span> sun.misc.Hashing.stringHash32((String) k);</div><div class="line">        &#125;</div><div class="line">        h ^= k.hashCode();</div><div class="line">        <span class="comment">// Spread bits to regularize both segment and index locations,</span></div><div class="line">        <span class="comment">// using variant of single-word Wang/Jenkins hash.</span></div><div class="line">        h += (h &lt;&lt;  <span class="number">15</span>) ^ <span class="number">0xffffcd7d</span>;</div><div class="line">        h ^= (h &gt;&gt;&gt; <span class="number">10</span>);</div><div class="line">        h += (h &lt;&lt;   <span class="number">3</span>);</div><div class="line">        h ^= (h &gt;&gt;&gt;  <span class="number">6</span>);</div><div class="line">        h += (h &lt;&lt;   <span class="number">2</span>) + (h &lt;&lt; <span class="number">14</span>);</div><div class="line">        <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">16</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œç”¨åˆ°äº†Wang/Jenkins hashç®—æ³•çš„å˜ç§ï¼Œä¸»è¦çš„ç›®çš„æ˜¯ä¸ºäº†å‡å°‘å“ˆå¸Œå†²çªï¼Œä½¿å…ƒç´ èƒ½å¤Ÿå‡åŒ€çš„åˆ†å¸ƒåœ¨ä¸åŒçš„Segmentä¸Šï¼Œä»è€Œæé«˜å®¹å™¨çš„å­˜å–æ•ˆç‡ã€‚å‡å¦‚å“ˆå¸Œçš„è´¨é‡å·®åˆ°æç‚¹ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„å…ƒç´ éƒ½åœ¨ä¸€ä¸ªSegmentä¸­ï¼Œä¸ä»…å­˜å–å…ƒç´ ç¼“æ…¢ï¼Œåˆ†æ®µé”ä¹Ÿä¼šå¤±å»æ„ä¹‰ã€‚</p>
<p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">System.out.println(Integer.parseInt(<span class="string">"0001111"</span>, <span class="number">2</span>) &amp; <span class="number">15</span>);</div><div class="line">System.out.println(Integer.parseInt(<span class="string">"0011111"</span>, <span class="number">2</span>) &amp; <span class="number">15</span>);</div><div class="line">System.out.println(Integer.parseInt(<span class="string">"0111111"</span>, <span class="number">2</span>) &amp; <span class="number">15</span>);</div><div class="line">System.out.println(Integer.parseInt(<span class="string">"1111111"</span>, <span class="number">2</span>) &amp; <span class="number">15</span>);</div></pre></td></tr></table></figure>
<p>è¿™äº›æ•°å­—å¾—åˆ°çš„hashå€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå…¨æ˜¯15ï¼Œæ‰€ä»¥å¦‚æœä¸è¿›è¡Œç¬¬ä¸€æ¬¡é¢„hashï¼Œå‘ç”Ÿå†²çªçš„å‡ ç‡è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬å…ˆæŠŠä¸Šä¾‹ä¸­çš„äºŒè¿›åˆ¶æ•°å­—ä½¿ç”¨hash()å‡½æ•°å…ˆè¿›è¡Œä¸€æ¬¡é¢„hashï¼Œå¾—åˆ°çš„ç»“æœæ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">0100ï½œ0111ï½œ0110ï½œ0111ï½œ1101ï½œ1010ï½œ0100ï½œ1110</div><div class="line">1111ï½œ0111ï½œ0100ï½œ0011ï½œ0000ï½œ0001ï½œ1011ï½œ1000</div><div class="line">0111ï½œ0111ï½œ0110ï½œ1001ï½œ0100ï½œ0110ï½œ0011ï½œ1110</div><div class="line">1000ï½œ0011ï½œ0000ï½œ0000ï½œ1100ï½œ1000ï½œ0001ï½œ1010</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ¯ä¸€ä½çš„æ•°æ®éƒ½æ•£å¼€äº†ï¼Œå¹¶ä¸”ConcurrentHashMapä¸­æ˜¯ä½¿ç”¨é¢„hashå€¼çš„é«˜ä½å‚ä¸è¿ç®—çš„ã€‚æ¯”å¦‚ä¹‹å‰è¯´çš„å…ˆå°†hashå€¼å‘å³æŒ‰ä½ç§»åŠ¨28ä½ï¼Œå†ä¸15åš&amp;è¿ç®—ï¼Œå¾—åˆ°çš„ç»“æœéƒ½åˆ«ä¸ºï¼š4ï¼Œ15ï¼Œ7ï¼Œ8ï¼Œæ²¡æœ‰å†²çªï¼</p>
<h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><p>ConcurrentHashMapä¸­çš„keyå’Œvalueå€¼éƒ½ä¸èƒ½ä¸ºnullã€‚<br>ConcurrentHashMapçš„æ•´ä¸ªæ“ä½œè¿‡ç¨‹ä¸­å¤§é‡ä½¿ç”¨äº†Unsafeç±»æ¥è·å–Segment/HashEntryï¼Œè¿™é‡ŒUnsafeçš„ä¸»è¦ä½œç”¨æ˜¯æä¾›åŸå­æ“ä½œã€‚Unsafeè¿™ä¸ªç±»æ¯”è¾ƒææ€–ï¼Œç ´ååŠ›æå¼ºï¼Œä¸€èˆ¬åœºæ™¯ä¸å»ºè®®ä½¿ç”¨ï¼Œå¦‚æœæœ‰å…´è¶£å¯ä»¥åˆ°è¿™é‡Œåšè¯¦ç»†çš„äº†è§£Javaä¸­é²œä¸ºäººçŸ¥çš„ç‰¹æ€§<br>ConcurrentHashMapæ˜¯çº¿ç¨‹å®‰å…¨çš„ç±»å¹¶ä¸èƒ½ä¿è¯ä½¿ç”¨äº†ConcurrentHashMapçš„æ“ä½œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.infoq.com/cn/articles/ConcurrentHashMap/" target="_blank" rel="external">æ·±å…¥åˆ†æConcurrentHashMap</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[BlockingQueue]]></title>
      <url>http://zsr.github.io/2016/08/16/BlockingQueue/</url>
      <content type="html"><![CDATA[<h1 id="OpenJDK-æºç é˜…è¯»ä¹‹-BlockingQueue"><a href="#OpenJDK-æºç é˜…è¯»ä¹‹-BlockingQueue" class="headerlink" title="OpenJDK æºç é˜…è¯»ä¹‹ BlockingQueue"></a>OpenJDK æºç é˜…è¯»ä¹‹ BlockingQueue</h1><h4 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h4><p>åœ¨java.util.ConcurrentåŒ…ä¸­ï¼ŒBlockingQueueå¾ˆå¥½çš„è§£å†³äº†åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œå¦‚ä½•é«˜æ•ˆå®‰å…¨â€œä¼ è¾“â€æ•°æ®çš„é—®é¢˜ã€‚é€šè¿‡è¿™äº›é«˜æ•ˆå¹¶ä¸”çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ç±»ï¼Œä¸ºæˆ‘ä»¬å¿«é€Ÿæ­å»ºé«˜è´¨é‡çš„å¤šçº¿ç¨‹ç¨‹åºå¸¦æ¥æå¤§çš„ä¾¿åˆ©ã€‚åŒæ—¶ï¼ŒBlockingQueueä¹Ÿç”¨äºjavaè‡ªå¸¦çº¿ç¨‹æ± çš„ç¼“å†²é˜Ÿåˆ—ä¸­ï¼Œäº†è§£BlockingQueueä¹Ÿæœ‰åŠ©äºç†è§£çº¿ç¨‹æ± çš„å·¥ä½œæ¨¡å‹ã€‚</p>
<h4 id="BlockingQueueæ¥å£"><a href="#BlockingQueueæ¥å£" class="headerlink" title="BlockingQueueæ¥å£"></a>BlockingQueueæ¥å£</h4><p>è¯¥æ¥å£å±äºé˜Ÿåˆ—ï¼Œæ‰€ä»¥ç»§æ‰¿äº†Queueæ¥å£ï¼Œè¯¥æ¥å£æœ€é‡è¦çš„äº”ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯offeræ–¹æ³•ï¼Œpollæ–¹æ³•ï¼Œputæ–¹æ³•ï¼Œtakeæ–¹æ³•å’ŒdrainToæ–¹æ³•ã€‚</p>
<p>offeræ–¹æ³•å’Œpollæ–¹æ³•åˆ†åˆ«æœ‰ä¸€ä¸ªé™æ€é‡è½½æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯offer(E e, long timeout, TimeUnit unit)å’Œpoll(long timeout, TimeUnit unit)æ–¹æ³•ã€‚å…¶æ„ä¹‰æ˜¯åœ¨é™å®šæ—¶é—´å†…å­˜å…¥æˆ–å–å‡ºå¯¹è±¡ï¼Œå¦‚æœä¸èƒ½å­˜å…¥å–å‡ºåˆ™è¿”å›falseã€‚</p>
<p>putæ–¹æ³•ä¼šåœ¨å½“é˜Ÿåˆ—å­˜å‚¨å¯¹è±¡è¾¾åˆ°é™å®šå€¼æ—¶é˜»å¡çº¿ç¨‹ï¼Œè€Œåœ¨é˜Ÿåˆ—ä¸ä¸ºç©ºæ—¶å”¤é†’è¢«takeæ–¹æ³•æ‰€é˜»å¡çš„çº¿ç¨‹ã€‚takeæ–¹æ³•æ˜¯ç›¸åçš„ã€‚</p>
<p>drainToæ–¹æ³•å¯æ‰¹é‡è·å–é˜Ÿåˆ—ä¸­çš„å…ƒç´ ã€‚</p>
<h4 id="å¸¸è§çš„BlockingQueueå®ç°"><a href="#å¸¸è§çš„BlockingQueueå®ç°" class="headerlink" title="å¸¸è§çš„BlockingQueueå®ç°"></a>å¸¸è§çš„BlockingQueueå®ç°</h4><ul>
<li>LinkedBlockingQueue</li>
</ul>
<p>LinkedBlockingQueueæ˜¯æ¯”è¾ƒå¸¸è§çš„BlockingQueueçš„å®ç°ï¼Œä»–æ˜¯åŸºäºé“¾è¡¨çš„é˜»å¡é˜Ÿåˆ—ã€‚åœ¨åˆ›å»ºè¯¥å¯¹è±¡æ—¶å¦‚æœä¸æŒ‡å®šå¯å­˜å‚¨å¯¹è±¡ä¸ªæ•°å¤§å°æ—¶ï¼Œé»˜è®¤ä¸ºInteger.MAX_VALUEã€‚å½“ç”Ÿäº§è€…å¾€é˜Ÿåˆ—ä¸­æ”¾å…¥ä¸€ä¸ªæ•°æ®æ—¶ï¼Œé˜Ÿåˆ—ä¼šä»ç”Ÿäº§è€…æ‰‹ä¸­è·å–æ•°æ®ï¼Œå¹¶ç¼“å­˜åœ¨é˜Ÿåˆ—å†…éƒ¨ï¼Œè€Œç”Ÿäº§è€…ç«‹å³è¿”å›ï¼›åªæœ‰å½“é˜Ÿåˆ—ç¼“å†²åŒºè¾¾åˆ°æœ€å¤§å€¼ç¼“å­˜å®¹é‡æ—¶ï¼Œæ‰ä¼šé˜»å¡ç”Ÿäº§è€…é˜Ÿåˆ—ï¼Œç›´åˆ°æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ‰ä¸€ä»½æ•°æ®ï¼Œç”Ÿäº§è€…çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œåä¹‹å¯¹äºæ¶ˆè´¹è€…è¿™ç«¯çš„å¤„ç†ä¹ŸåŸºäºåŒæ ·çš„åŸç†ã€‚</p>
<p>LinkedBlockingQueueå†…éƒ¨ä½¿ç”¨äº†ç‹¬ç«‹çš„ä¸¤æŠŠé”æ¥æ§åˆ¶æ•°æ®åŒæ­¥ï¼Œè¿™ä¹Ÿæ„å‘³ç€åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¯ä»¥å¹¶è¡Œåœ°æ“ä½œé˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œä»¥æ­¤æ¥æé«˜æ•´ä¸ªé˜Ÿåˆ—çš„å¹¶å‘æ€§èƒ½ã€‚</p>
<p>putæ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public void put(E e) throws InterruptedException &#123;</div><div class="line">        if (e == null) throw new NullPointerException();</div><div class="line">        int c = -1;</div><div class="line">        Node&lt;E&gt; node = new Node(e);</div><div class="line">        final ReentrantLock putLock = this.putLock;</div><div class="line">        final AtomicInteger count = this.count;</div><div class="line">        putLock.lockInterruptibly();</div><div class="line">        try &#123;</div><div class="line">            while (count.get() == capacity) &#123;</div><div class="line">                notFull.await();</div><div class="line">            &#125;</div><div class="line">            enqueue(node);</div><div class="line">            c = count.getAndIncrement();</div><div class="line">            if (c + 1 &lt; capacity)</div><div class="line">                notFull.signal();</div><div class="line">        &#125; finally &#123;</div><div class="line">            putLock.unlock();</div><div class="line">        &#125;</div><div class="line">        if (c == 0)</div><div class="line">            signalNotEmpty();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>offeræ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">    public boolean offer(E e) &#123;</div><div class="line">        if (e == null) throw new NullPointerException();</div><div class="line">        final AtomicInteger count = this.count;</div><div class="line">        if (count.get() == capacity)</div><div class="line">            return false;</div><div class="line">        int c = -1;</div><div class="line">        Node&lt;E&gt; node = new Node(e);</div><div class="line">        final ReentrantLock putLock = this.putLock;</div><div class="line">        putLock.lock();</div><div class="line">        try &#123;</div><div class="line">            if (count.get() &lt; capacity) &#123;</div><div class="line">                enqueue(node);</div><div class="line">                c = count.getAndIncrement();</div><div class="line">                if (c + 1 &lt; capacity)</div><div class="line">                    notFull.signal();</div><div class="line">            &#125;</div><div class="line">        &#125; finally &#123;</div><div class="line">            putLock.unlock();</div><div class="line">        &#125;</div><div class="line">        if (c == 0)</div><div class="line">            signalNotEmpty();</div><div class="line">        return c &gt;= 0;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸¤ä¸ªæ–¹æ³•çš„åŒºåˆ«æ˜¯putæ–¹æ³•åœ¨å®¹é‡è¾¾åˆ°ä¸Šé™æ—¶ä¼šé˜»å¡ï¼Œè€Œofferæ–¹æ³•åˆ™ä¼šç›´æ¥è¿”å›falseã€‚</p>
<a id="more"></a>
<ul>
<li>ArrayBlockingQueue</li>
</ul>
<p>ArrayBlockingQueueæ˜¯åŸºäºæ•°ç»„çš„é˜»å¡é˜Ÿåˆ—ï¼Œé™¤äº†æœ‰ä¸€ä¸ªå®šé•¿æ•°ç»„å¤–ï¼ŒArrayBlockingQueueå†…éƒ¨è¿˜ä¿å­˜ç€ä¸¤ä¸ªæ•´å½¢å˜é‡ï¼Œåˆ†åˆ«æ ‡è¯†ç€é˜Ÿåˆ—çš„å¤´éƒ¨å’Œå°¾éƒ¨åœ¨æ•°ç»„ä¸­çš„ä½ç½®ã€‚ArrayBlockingQueueåœ¨ç”Ÿäº§è€…æ”¾å…¥æ•°æ®å’Œæ¶ˆè´¹è€…è·å–æ•°æ®ï¼Œéƒ½æ˜¯å…±ç”¨åŒä¸€ä¸ªé”å¯¹è±¡ï¼Œç”±æ­¤ä¹Ÿæ„å‘³ç€ä¸¤è€…æ— æ³•çœŸæ­£å¹¶è¡Œè¿è¡Œï¼Œè¿™ç‚¹å°¤å…¶ä¸åŒäºLinkedBlockingQueueã€‚<br>ArrayBlockingQueueå’ŒLinkedBlockingQueueé—´è¿˜æœ‰ä¸€ä¸ªæ˜æ˜¾çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå‰è€…åœ¨æ’å…¥æˆ–åˆ é™¤å…ƒç´ æ—¶ä¸ä¼šäº§ç”Ÿæˆ–é”€æ¯ä»»ä½•é¢å¤–çš„å¯¹è±¡å®ä¾‹ï¼Œè€Œåè€…åˆ™ä¼šç”Ÿæˆä¸€ä¸ªé¢å¤–çš„Nodeå¯¹è±¡ã€‚</p>
<ul>
<li>SynchronousQueue</li>
</ul>
<p>æ˜¯ä¸€ç§æ²¡æœ‰ç¼“å†²çš„é˜»å¡é˜Ÿåˆ—ï¼Œåœ¨ç”Ÿäº§è€…putçš„åŒæ—¶å¿…é¡»è¦æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…è¿›è¡Œtakeï¼Œå¦åˆ™å°±ä¼šé˜»å¡ã€‚å£°æ˜ä¸€ä¸ªSynchronousQueueæœ‰ä¸¤ç§ä¸åŒçš„æ–¹å¼ã€‚å…¬å¹³æ¨¡å¼å’Œéå…¬å¹³æ¨¡å¼çš„åŒºåˆ«:å¦‚æœé‡‡ç”¨å…¬å¹³æ¨¡å¼ï¼šSynchronousQueueä¼šé‡‡ç”¨å…¬å¹³é”ï¼Œå¹¶é…åˆä¸€ä¸ªFIFOé˜Ÿåˆ—æ¥é˜»å¡å¤šä½™çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œä»è€Œä½“ç³»æ•´ä½“çš„å…¬å¹³ç­–ç•¥ï¼›ä½†å¦‚æœæ˜¯éå…¬å¹³æ¨¡å¼ï¼ˆSynchronousQueueé»˜è®¤ï¼‰ï¼šSynchronousQueueé‡‡ç”¨éå…¬å¹³é”ï¼ŒåŒæ—¶é…åˆä¸€ä¸ªLIFOé˜Ÿåˆ—æ¥ç®¡ç†å¤šä½™çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œè€Œåä¸€ç§æ¨¡å¼ï¼Œå¦‚æœç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å¤„ç†é€Ÿåº¦æœ‰å·®è·ï¼Œåˆ™å¾ˆå®¹æ˜“å‡ºç°é¥¥æ¸´çš„æƒ…å†µï¼Œå³å¯èƒ½æœ‰æŸäº›ç”Ÿäº§è€…æˆ–è€…æ˜¯æ¶ˆè´¹è€…çš„æ•°æ®æ°¸è¿œéƒ½å¾—ä¸åˆ°å¤„ç†ã€‚</p>
<ul>
<li>PriorityBlockingQueueå’ŒDelayQueue</li>
</ul>
<p>PriorityBlockingQueueæ˜¯åŸºäºä¼˜å…ˆçº§çš„é˜»å¡é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—ä¸ä¼šé˜»å¡ç”Ÿäº§è€…ï¼Œåªä¼šé˜»å¡æ¶ˆè´¹è€…ã€‚<br>DelayQueueé˜Ÿåˆ—å­˜å‚¨çš„å¯¹è±¡åªæœ‰æŒ‡å®šçš„å»¶è¿Ÿæ—¶é—´åˆ°äº†æ‰èƒ½è¢«å–å‡ºï¼Œè¯¥é˜Ÿåˆ—ä¹Ÿä¸ä¼šé˜»å¡ç”Ÿäº§è€…ã€‚</p>
<h4 id="BlockingQueueçš„ä½¿ç”¨"><a href="#BlockingQueueçš„ä½¿ç”¨" class="headerlink" title="BlockingQueueçš„ä½¿ç”¨"></a>BlockingQueueçš„ä½¿ç”¨</h4><p>åœ¨å¤„ç†å¤šçº¿ç¨‹ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜æ—¶çš„æ¼”ç¤ºä»£ç ï¼š</p>
<p>main()æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">import java.util.concurrent.ArrayBlockingQueue;</div><div class="line">import java.util.concurrent.BlockingQueue;</div><div class="line"> </div><div class="line">public class BlockingQueueTest &#123;</div><div class="line"> </div><div class="line">    public static void main(String[] args)</div><div class="line">    &#123;</div><div class="line">        BlockingQueue&lt;String&gt; queue = new ArrayBlockingQueue&lt;String&gt;(1000);</div><div class="line">        Thread p1 = new Thread(new Producer(queue),&quot;producer1&quot;);</div><div class="line">        Thread p2 = new Thread(new Producer(queue),&quot;producer2&quot;);</div><div class="line">        Thread c1 = new Thread(new Consumer(queue),&quot;consumer1&quot;);</div><div class="line">        Thread c2 = new Thread(new Consumer(queue),&quot;consumer2&quot;);</div><div class="line"> </div><div class="line">        p1.start();</div><div class="line">        p2.start();</div><div class="line">        c1.start();</div><div class="line">        c2.start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”Ÿäº§è€…ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">class Producer implements Runnable&#123;</div><div class="line">    private BlockingQueue&lt;String&gt; queue;</div><div class="line"> </div><div class="line">    public Producer(BlockingQueue&lt;String&gt; queue) &#123;</div><div class="line">        this.queue = queue;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    public void run() &#123;</div><div class="line">        int i = 0;</div><div class="line">        while (!Thread.currentThread().isInterrupted())</div><div class="line">        &#123;</div><div class="line">            try &#123;</div><div class="line">                queue.put(Thread.currentThread().getName()+&quot; product &quot;+i);</div><div class="line">            &#125; catch (InterruptedException e) &#123;</div><div class="line">                System.err.println(Thread.currentThread().getName() + &quot; error&quot;);</div><div class="line">            &#125;</div><div class="line">            i++;</div><div class="line">            try &#123;</div><div class="line">                Thread.sleep(1000);</div><div class="line">            &#125; catch (InterruptedException e) &#123;</div><div class="line"> </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ¶ˆè´¹è€…ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">class Consumer implements Runnable&#123;</div><div class="line">    private BlockingQueue&lt;String&gt; queue;</div><div class="line"> </div><div class="line">    public Consumer(BlockingQueue&lt;String&gt; queue) &#123;</div><div class="line">        this.queue = queue;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    public void run() &#123;</div><div class="line">        int i = 0;</div><div class="line">        while (!Thread.currentThread().isInterrupted())</div><div class="line">        &#123;</div><div class="line">            try &#123;</div><div class="line">                String str = queue.take();</div><div class="line">                System.out.println(str);</div><div class="line">            &#125; catch (InterruptedException e) &#123;</div><div class="line"> </div><div class="line">            &#125;</div><div class="line">            try &#123;</div><div class="line">                Thread.sleep(300);</div><div class="line">            &#125; catch (InterruptedException e) &#123;</div><div class="line"> </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>BlockingQueueåœ¨å¹¶å‘ç¼–ç¨‹ä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ï¼Œæ—¢å¯ä»¥è‡ªå·±ç”¨æ¥è§£å†³ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼Œä¹Ÿç”¨äºjavaè‡ªå¸¦çº¿ç¨‹æ± çš„ç¼“å†²é˜Ÿåˆ—ã€‚</p>
<p>å‚è€ƒï¼š</p>
<p><a href="http://wsmajunfeng.iteye.com/blog/1629354" target="_blank" rel="external">BlockingQueue</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[HashSet]]></title>
      <url>http://zsr.github.io/2016/08/16/HashSet/</url>
      <content type="html"><![CDATA[<h1 id="OpenJDK-æºä»£ç é˜…è¯»ä¹‹-HashSet"><a href="#OpenJDK-æºä»£ç é˜…è¯»ä¹‹-HashSet" class="headerlink" title="OpenJDK æºä»£ç é˜…è¯»ä¹‹ HashSet"></a>OpenJDK æºä»£ç é˜…è¯»ä¹‹ HashSet</h1><hr>
<h2 id="æ¦‚è¦"><a href="#æ¦‚è¦" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h2><ul>
<li>ç±»ç»§æ‰¿å…³ç³»</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">java.lang.Object</div><div class="line">    java.util.AbstractCollection&lt;E&gt;</div><div class="line">        java.util.AbstractSet&lt;E&gt;</div><div class="line">            java.util.HashSet&lt;E&gt;</div></pre></td></tr></table></figure>
<ul>
<li>å®šä¹‰</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public class HashSet&lt;E&gt;</div><div class="line">extends AbstractSet&lt;E&gt;</div><div class="line">implements Set&lt;E&gt;, Cloneable, Serializable</div></pre></td></tr></table></figure>
<ul>
<li>è¦ç‚¹</li>
</ul>
<ol>
<li>ä¸ä¿è¯å…ƒç´ æ¬¡åºï¼Œç”šè‡³ä¸ä¿è¯æ¬¡åºä¸éšæ—¶é—´å˜åŒ–</li>
<li>åŸºæœ¬æ“ä½œ(add, remove, contains, size)å¸¸é‡æ—¶é—´</li>
<li>è¿­ä»£æ“ä½œä¸å½“å‰å…ƒç´ ä¸ªæ•°åŠ åº•å±‚å®¹é‡å¤§å°æˆæ­£æ¯”</li>
<li>ä¸ä¿è¯åŒæ­¥</li>
</ol>
<h2 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h2><ul>
<li>æ€»ä½“å®ç°</li>
</ul>
<p>åº•å±‚æ˜¯ç”¨ <code>HashMap</code> å®ç°çš„ï¼Œ<code>Set</code> ä¸­çš„æ•°æ®æ˜¯ <code>HashMap</code> çš„ <code>key</code>ï¼Œæ‰€æœ‰çš„ <code>key</code> æŒ‡å‘åŒä¸€ä¸ª <code>value</code>, æ­¤ <code>value</code> å®šä¹‰ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Dummy value to associate with an Object in the backing Map</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object PRESENT = <span class="keyword">new</span> Object();</div></pre></td></tr></table></figure>
<p>å†çœ‹ä¸€ä¸‹ <code>add</code>ï¼Œå¤§æ¦‚å°±èƒ½æ˜ç™½äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Adds the specified element to this set if it is not already present.</div><div class="line"> * More formally, adds the specified element &lt;tt&gt;e&lt;/tt&gt; to this set if</div><div class="line"> * this set contains no element &lt;tt&gt;e2&lt;/tt&gt; such that</div><div class="line"> * &lt;tt&gt;(e==null&amp;nbsp;?&amp;nbsp;e2==null&amp;nbsp;:&amp;nbsp;e.equals(e2))&lt;/tt&gt;.</div><div class="line"> * If this set already contains the element, the call leaves the set</div><div class="line"> * unchanged and returns &lt;tt&gt;false&lt;/tt&gt;.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> e element to be added to this set</div><div class="line"> * <span class="doctag">@return</span> &lt;tt&gt;true&lt;/tt&gt; if this set did not already contain the specified</div><div class="line"> * element</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> map.put(e, PRESENT)==<span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>load factor</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</div><div class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;(Math.max((<span class="keyword">int</span>) (c.size()/.<span class="number">75f</span>) + <span class="number">1</span>, <span class="number">16</span>));</div><div class="line">    addAll(c);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–ä¸­ï¼Œæ³¨æ„ä½¿ç”¨çš„ <code>HashMap</code> çš„ load factor è®¾ç½®ä¸º 0.75ï¼Œå¦‚æœå¤ªå°ï¼Œå°±è®¾ç½®æˆ 16. </p>
<p><code>HashSet</code> å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ï¼Œå‡ ä¹æ²¡æœ‰è‡ªå·±ç‰¹æœ‰çš„å®ç°ï¼Œéƒ½æ˜¯è°ƒç”¨ <code>HashMap</code> çš„æ–¹æ³•å®ç°ç›¸åº”çš„åŠŸèƒ½ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Spring MVC ApplicationContext]]></title>
      <url>http://zsr.github.io/2016/08/16/ApplicationContext/</url>
      <content type="html"><![CDATA[<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>ä»¥åªæœ‰1ä¸ªServletçš„ç®€å•æƒ…å†µä¸ºä¾‹ï¼Œä¸€èˆ¬æ¶‰åŠåˆ°3ä¸ªé…ç½®æ–‡ä»¶ï¼šweb.xmlï¼ŒapplicationContext.xmlï¼Œxxx-servlet.xmlã€‚</p>
<h3 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;context-param&gt;  </div><div class="line">         &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;  </div><div class="line">         &lt;param-value&gt;classpath:/applicationContext.xml&lt;/param-value&gt;  </div><div class="line">&lt;/context-param&gt;  </div><div class="line">&lt;listener&gt;  </div><div class="line">         &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;  </div><div class="line">&lt;/listener&gt;  </div><div class="line">&lt;servlet&gt;  </div><div class="line">         &lt;servlet-name&gt;xxx&lt;/servlet-name&gt;  </div><div class="line">         &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;  </div><div class="line">         &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;  </div><div class="line">&lt;/servlet&gt;  </div><div class="line">&lt;servlet-mapping&gt;  </div><div class="line">         &lt;servlet-name&gt;xxx&lt;/servlet-name&gt;  </div><div class="line">         &lt;url-pattern&gt;*.html&lt;/url-pattern&gt;  </div><div class="line">&lt;/servlet-mapping&gt;</div></pre></td></tr></table></figure>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šç”Ÿæˆ2ä¸ªApplicationContextï¼Œç¡®åˆ‡çš„è¯´æ˜¯2ä¸ªWebApplicationContext.</p>
<h3 id="ROOT-ApplicationContext"><a href="#ROOT-ApplicationContext" class="headerlink" title="ROOT ApplicationContext"></a>ROOT ApplicationContext</h3><p>åœ¨Tomcatå¯åŠ¨æ—¶ï¼Œé€šè¿‡æ³¨å†Œçš„ç›‘å¬å™¨ContextLoaderListenerï¼ŒSpringåˆå§‹åŒ–WebApplicationContextå¹¶ä¿å­˜åˆ°ServletContextä¸­ï¼Œåˆå§‹åŒ–ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ä½ç½®ç”±contextConfigLocationå‚æ•°ç¡®å®šã€‚è¯¥Contextä¸ºæ•´ä¸ªæ¡†æ¶ä¸­çš„ROOT Contextï¼Œå…¶ä»–çš„Contextéƒ½ä¼šä½œä¸ºå…¶å­èŠ‚ç‚¹æˆ–å­å­™èŠ‚ç‚¹è¿›è¡Œå…³è”ã€‚</p>
<p>WebApplicationContextå’ŒServletContextäº’ç›¸ä¿å­˜å¯¹æ–¹çš„å¼•ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//ä¿å­˜åˆ°ServletContextä¸­  </div><div class="line">servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE,this.context);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//ä¿å­˜ServletContext  </div><div class="line">wac.setServletContext(sc);</div></pre></td></tr></table></figure>
<h3 id="xxx-ApplicationContext"><a href="#xxx-ApplicationContext" class="headerlink" title="xxx ApplicationContext"></a>xxx ApplicationContext</h3><p>Tomcatç”Ÿæˆxxx Servletæ—¶ï¼ŒDispatcherServletä¼šä½¿ç”¨xxx-servlet.xmlï¼ˆé™¤éæ˜¾ç¤ºæŒ‡å®šå…¶ä»–æ–‡ä»¶ï¼‰åˆå§‹åŒ–WebApplicationContextï¼Œå°†å…¶çˆ¶èŠ‚ç‚¹è®¾ä¸ºROOT Contextï¼Œå¹¶ä¿å­˜åˆ°ServletContextä¸­ã€‚</p>
<p>åœ¨createWebApplicationContext()æ–¹æ³•ä¸­ï¼Œè®¾ç½®çˆ¶èŠ‚ç‚¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wac.setParent(parent);</div></pre></td></tr></table></figure>
<p>åœ¨configureAndRefreshWebApplicationContext()æ–¹æ³•ä¸­ä¿å­˜ServletContextï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wac.setServletContext(getServletContext());  </div><div class="line">wac.setServletConfig(getServletConfig());</div></pre></td></tr></table></figure>
<p>åœ¨initWebApplicationContext()æ–¹æ³•ä¸­å°†è‡ªå·±ä¿å­˜åˆ°ServletContextä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">// Publish the context as a servlet context attribute.  </div><div class="line">String attrName = getServletContextAttributeName();  </div><div class="line">getServletContext().setAttribute(attrName, wac);</div></pre></td></tr></table></figure>
<p>ServletContextã€ROOT Contextå’Œxxx Contextä¸‰è€…å¼•ç”¨ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹ï¼š</p>
<p><img src="/images/Applicationå…³ç³».jpg"></p>
<p>è·å–çš„æ–¹æ³•ï¼š</p>
<ul>
<li>ServletContextï¼š</li>
</ul>
<p>æ— è®ºæ˜¯åœ¨ROOTè¿˜æ˜¯xxx Contextä¸­ï¼Œå¯ä»¥é€šè¿‡:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">WebApplicationContext. getServletContext();</div></pre></td></tr></table></figure>
<ul>
<li>ROOT Contextï¼š</li>
</ul>
<p>è¯¥Contextæ˜¯â€ org.springframework.web.context. WebApplicationContext. ROOTâ€ä¸ºKeyä¿å­˜åœ¨ServletContextä¸­ã€‚å¯ä»¥ä½¿ç”¨Springæä¾›çš„å·¥å…·ç±»æ–¹æ³•è·å–ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">WebApplicationContextUtils.getWebApplicationContext(ServletContextsc)</div></pre></td></tr></table></figure>
<p>åœ¨xxx Contextä¸­å¯ä»¥é€šè¿‡getParentå¾—åˆ°ROOT Contextã€‚</p>
<ul>
<li>xxx Contextï¼š</li>
</ul>
<p>è¯¥Contextæ˜¯ä»¥â€ org.springframework.web.servlet.FrameworkServlet.CONTEXT.xxxâ€ä¸ºKEY(xxxä¸ºweb.xmlä¸­å®šä¹‰çš„Servletåç§°)ï¼Œä¿å­˜åœ¨ServletContextä¸­ã€‚å¯ä»¥ä½¿ç”¨Springæä¾›çš„å·¥å…·ç±»æ–¹æ³•è·å–ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">WebApplicationContextUtils.getWebApplicationContext(ServletContextsc, String attrName)</div></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[DispatchServlet åˆå§‹åŒ–]]></title>
      <url>http://zsr.github.io/2016/08/15/DispatchServlet-%E5%88%9D%E5%A7%8B%E5%8C%96/</url>
      <content type="html"><![CDATA[<h3 id="è®¾è®¡æ¨¡å‹"><a href="#è®¾è®¡æ¨¡å‹" class="headerlink" title="è®¾è®¡æ¨¡å‹"></a>è®¾è®¡æ¨¡å‹</h3><ul>
<li><p>Spring MVC è¯·æ±‚å¤„ç†æµç¨‹</p>
<p><img src="/images/springmvc_1.png"></p>
</li>
</ul>
<ul>
<li><p>Spring MVC æ¶æ„å›¾</p>
<p><img src="/images/springmvc_2.png"></p>
</li>
</ul>
<h3 id="ä»£ç ç®€è¦"><a href="#ä»£ç ç®€è¦" class="headerlink" title="ä»£ç ç®€è¦"></a>ä»£ç ç®€è¦</h3><ul>
<li>Servlet:</li>
</ul>
<p>æ‰€æœ‰çš„Servletéƒ½æ˜¯å®ç°äº†Servletæ¥å£ï¼Œè¯¥æ¥å£æä¾›äº†servletç”Ÿå‘½å‘¨æœŸçš„ä¸€äº›æ–¹æ³•ï¼Œå¦‚: init(), destroy(),service()&lt;æ¯æ¬¡æ¥æ”¶åˆ°è¯·æ±‚éƒ½ç”±è¯¥æ–¹æ³•æ¥å¤„ç†&gt;ç­‰ï¼Œæ²¡æœ‰å…·ä½“å®ç°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public void init(ServletConfig config) throws ServletException;</div></pre></td></tr></table></figure>
<ul>
<li>GenericServlet:<br>è¯¥ç±»å®ç°äº†Servletçš„init()æ–¹æ³•ä»¥åŠæä¾›äº†è·å–åˆå§‹åŒ–å‚æ•°çš„æ–¹æ³•ã€‚initæ–¹æ³•çš„å®ç°æœ€åéœ€è¦ç”±å­ç±»å®ç°</li>
</ul>
<p>è·å–åˆå§‹åŒ–å‚æ•°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ServletConfig sc = getServletConfig();</div><div class="line">        if (sc == null) &#123;</div><div class="line">            throw new IllegalStateException(</div><div class="line">                lStrings.getString(&quot;err.servlet_config_not_initialized&quot;));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return sc.getInitParameter(name);</div></pre></td></tr></table></figure>
<p>init()åˆå§‹åŒ–ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public void init(ServletConfig config) throws ServletException &#123;</div><div class="line">this.config = config;</div><div class="line">this.init();//è°ƒç”¨ä¸‹é¢çš„init()æ–¹æ³•ï¼ˆæ²¡æœ‰å…·ä½“å®ç°ï¼‰</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public void init() throws ServletException &#123;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li>HttpServlet<br>å®ç°äº†servletçš„service()æ–¹æ³•ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½ç”±è¯¥æ–¹æ³•æ¥å¤„ç†ï¼Œåˆ¤æ–­èµ°doGet()è¿˜æ˜¯doPost()ç­‰ç­‰ã€‚<br>è¯¥æ–¹æ³•æ˜¯æœ‰Tomcatå®¹å™¨æ¥è°ƒç”¨çš„(init()æ–¹æ³•ä¹Ÿæ˜¯)ã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public void service(ServletRequest req, ServletResponse res)</div><div class="line">        throws ServletException, IOException</div><div class="line">    &#123;</div><div class="line">        HttpServletRequest  request;</div><div class="line">        HttpServletResponse response;</div><div class="line">        </div><div class="line">        if (!(req instanceof HttpServletRequest &amp;&amp;</div><div class="line">                res instanceof HttpServletResponse)) &#123;</div><div class="line">            throw new ServletException(&quot;non-HTTP request or response&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        request = (HttpServletRequest) req;</div><div class="line">        response = (HttpServletResponse) res;</div><div class="line"></div><div class="line">        service(request, response);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">protected void service(HttpServletRequest req, HttpServletResponse resp)</div><div class="line">        throws ServletException, IOException</div><div class="line">    &#123;</div><div class="line">        String method = req.getMethod();</div><div class="line"></div><div class="line">        if (method.equals(METHOD_GET)) &#123;</div><div class="line">            long lastModified = getLastModified(req);</div><div class="line">            if (lastModified == -1) &#123;</div><div class="line">                // servlet doesn&apos;t support if-modified-since, no reason</div><div class="line">                // to go through further expensive logic</div><div class="line">                doGet(req, resp);</div><div class="line">            &#125; else &#123;</div><div class="line">                long ifModifiedSince = req.getDateHeader(HEADER_IFMODSINCE);</div><div class="line">                if (ifModifiedSince &lt; lastModified) &#123;</div><div class="line">                    // If the servlet mod time is later, call doGet()</div><div class="line">                    // Round down to the nearest second for a proper compare</div><div class="line">                    // A ifModifiedSince of -1 will always be less</div><div class="line">                    maybeSetLastModified(resp, lastModified);</div><div class="line">                    doGet(req, resp);</div><div class="line">                &#125; else &#123;</div><div class="line">                    resp.setStatus(HttpServletResponse.SC_NOT_MODIFIED);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125; else if (method.equals(METHOD_HEAD)) &#123;</div><div class="line">            long lastModified = getLastModified(req);</div><div class="line">            maybeSetLastModified(resp, lastModified);</div><div class="line">            doHead(req, resp);</div><div class="line"></div><div class="line">        &#125; else if (method.equals(METHOD_POST)) &#123;</div><div class="line">            doPost(req, resp);</div><div class="line">            </div><div class="line">        &#125; else if (method.equals(METHOD_PUT)) &#123;</div><div class="line">            doPut(req, resp);</div><div class="line">            </div><div class="line">        &#125; else if (method.equals(METHOD_DELETE)) &#123;</div><div class="line">            doDelete(req, resp);</div><div class="line">            </div><div class="line">        &#125; else if (method.equals(METHOD_OPTIONS)) &#123;</div><div class="line">            doOptions(req,resp);</div><div class="line">            </div><div class="line">        &#125; else if (method.equals(METHOD_TRACE)) &#123;</div><div class="line">            doTrace(req,resp);</div><div class="line">            </div><div class="line">        &#125; else &#123;</div><div class="line">            //</div><div class="line">            // Note that this means NO servlet supports whatever</div><div class="line">            // method was requested, anywhere on this server.</div><div class="line">            //</div><div class="line"></div><div class="line">            String errMsg = lStrings.getString(&quot;http.method_not_implemented&quot;);</div><div class="line">            Object[] errArgs = new Object[1];</div><div class="line">            errArgs[0] = method;</div><div class="line">            errMsg = MessageFormat.format(errMsg, errArgs);</div><div class="line">            </div><div class="line">            resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, errMsg);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå‡ ä¸ªç±»éƒ½æ˜¯ä¸éœ€è¦Springæ¡†æ¶çš„å‚ä¸ã€‚</p>
<a id="more"></a>
<ul>
<li>HttpServletBean</li>
</ul>
<p>è¯¥ç±»æœ€ç»ˆé‡è½½å®ç°äº†GenericServletç±»çš„init()æ–¹æ³•ã€‚æ³¨æ„: æ–¹æ³•æ˜¯finalç±»å‹ï¼Œä¸å¯ä»¥è¢«ç»§æ‰¿ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">	public final void init() throws ServletException &#123;</div><div class="line">		if (logger.isDebugEnabled()) &#123;</div><div class="line">			logger.debug(&quot;Initializing servlet &apos;&quot; + getServletName() + &quot;&apos;&quot;);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		// Set bean properties from init parameters.</div><div class="line">		try &#123;</div><div class="line">			PropertyValues pvs = new ServletConfigPropertyValues(getServletConfig(), this.requiredProperties);</div><div class="line">			BeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(this);</div><div class="line">			ResourceLoader resourceLoader = new ServletContextResourceLoader(getServletContext());</div><div class="line">			bw.registerCustomEditor(Resource.class, new ResourceEditor(resourceLoader, getEnvironment()));</div><div class="line">			initBeanWrapper(bw);</div><div class="line">			bw.setPropertyValues(pvs, true);</div><div class="line">		&#125;</div><div class="line">		catch (BeansException ex) &#123;</div><div class="line">			logger.error(&quot;Failed to set bean properties on servlet &apos;&quot; + getServletName() + &quot;&apos;&quot;, ex);</div><div class="line">			throw ex;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		// Let subclasses do whatever initialization they like.</div><div class="line">		initServletBean();</div><div class="line"></div><div class="line">		if (logger.isDebugEnabled()) &#123;</div><div class="line">			logger.debug(&quot;Servlet &apos;&quot; + getServletName() + &quot;&apos; configured successfully&quot;);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ç±»éœ€è¦è°ƒç”¨initServletBean()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨HttpServletBeanç±»ä¸­æ²¡æœ‰å…·ä½“å®ç°ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">protected void initServletBean() throws ServletException &#123;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<ul>
<li>FrameworkServlet<br>å®ç°äº†HttpServletBeanç±»çš„initServletBean()æ–¹æ³•ï¼Œåˆå§‹åŒ–WebApplicationContextã€‚å¹¶ä¸”é‡è½½äº†HttpServletç±»çš„service()æ–¹æ³•ï¼Œä»¥åŠæ‰€æœ‰çš„doGet(),doPost()æ–¹æ³•, è¿™äº›æ–¹æ³•æœ€åéƒ½è°ƒç”¨äº†doService()æ–¹æ³•(è¯¥ç±»æ²¡æœ‰å®ç°doService(),ç”±DispatchServletç±»å…·ä½“å®ç°)ã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">	protected final void initServletBean() throws ServletException &#123;</div><div class="line">		getServletContext().log(&quot;Initializing Spring FrameworkServlet &apos;&quot; + getServletName() + &quot;&apos;&quot;);</div><div class="line">		if (this.logger.isInfoEnabled()) &#123;</div><div class="line">			this.logger.info(&quot;FrameworkServlet &apos;&quot; + getServletName() + &quot;&apos;: initialization started&quot;);</div><div class="line">		&#125;</div><div class="line">		long startTime = System.currentTimeMillis();</div><div class="line"></div><div class="line">		try &#123;</div><div class="line">		    //åˆå§‹åŒ–WebApplicationContext</div><div class="line">			this.webApplicationContext = initWebApplicationContext();</div><div class="line">			initFrameworkServlet();</div><div class="line">		&#125;</div><div class="line">		catch (ServletException ex) &#123;</div><div class="line">			this.logger.error(&quot;Context initialization failed&quot;, ex);</div><div class="line">			throw ex;</div><div class="line">		&#125;</div><div class="line">		catch (RuntimeException ex) &#123;</div><div class="line">			this.logger.error(&quot;Context initialization failed&quot;, ex);</div><div class="line">			throw ex;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		if (this.logger.isInfoEnabled()) &#123;</div><div class="line">			long elapsedTime = System.currentTimeMillis() - startTime;</div><div class="line">			this.logger.info(&quot;FrameworkServlet &apos;&quot; + getServletName() + &quot;&apos;: initialization completed in &quot; +</div><div class="line">					elapsedTime + &quot; ms&quot;);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">protected WebApplicationContext initWebApplicationContext() &#123;</div><div class="line">		WebApplicationContext rootContext =</div><div class="line">				WebApplicationContextUtils.getWebApplicationContext(getServletContext());</div><div class="line">		WebApplicationContext wac = null;</div><div class="line"></div><div class="line">		if (this.webApplicationContext != null) &#123;</div><div class="line">			// A context instance was injected at construction time -&gt; use it</div><div class="line">			wac = this.webApplicationContext;</div><div class="line">			if (wac instanceof ConfigurableWebApplicationContext) &#123;</div><div class="line">				ConfigurableWebApplicationContext cwac = (ConfigurableWebApplicationContext) wac;</div><div class="line">				if (!cwac.isActive()) &#123;</div><div class="line">					// The context has not yet been refreshed -&gt; provide services such as</div><div class="line">					// setting the parent context, setting the application context id, etc</div><div class="line">					if (cwac.getParent() == null) &#123;</div><div class="line">						// The context instance was injected without an explicit parent -&gt; set</div><div class="line">						// the root application context (if any; may be null) as the parent</div><div class="line">						cwac.setParent(rootContext);</div><div class="line">					&#125;</div><div class="line">					configureAndRefreshWebApplicationContext(cwac);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		if (wac == null) &#123;</div><div class="line">			// No context instance was injected at construction time -&gt; see if one</div><div class="line">			// has been registered in the servlet context. If one exists, it is assumed</div><div class="line">			// that the parent context (if any) has already been set and that the</div><div class="line">			// user has performed any initialization such as setting the context id</div><div class="line">			wac = findWebApplicationContext();</div><div class="line">		&#125;</div><div class="line">		if (wac == null) &#123;</div><div class="line">			// No context instance is defined for this servlet -&gt; create a local one</div><div class="line">			wac = createWebApplicationContext(rootContext);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		if (!this.refreshEventReceived) &#123;</div><div class="line">			// Either the context is not a ConfigurableApplicationContext with refresh</div><div class="line">			// support or the context injected at construction time had already been</div><div class="line">			// refreshed -&gt; trigger initial onRefresh manually here.</div><div class="line">			onRefresh(wac);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		if (this.publishContext) &#123;</div><div class="line">			// Publish the context as a servlet context attribute.</div><div class="line">			String attrName = getServletContextAttributeName();</div><div class="line">			getServletContext().setAttribute(attrName, wac);</div><div class="line">			if (this.logger.isDebugEnabled()) &#123;</div><div class="line">				this.logger.debug(&quot;Published WebApplicationContext of servlet &apos;&quot; + getServletName() +</div><div class="line">						&quot;&apos; as ServletContext attribute with name [&quot; + attrName + &quot;]&quot;);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		return wac;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„æ–¹æ³•åˆå§‹åŒ–ä¸€ä¸ªWebApplicationContext.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">protected void onRefresh(ApplicationContext context) &#123;</div><div class="line">		// For subclasses: do nothing by default.</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<ul>
<li>DispatcherServlet</li>
</ul>
<p>å®ç°FrameworkServletç±»çš„onRefresh()æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å…·ä½“åˆå§‹åŒ–Spring MVCéœ€è¦çš„ä¸€äº›ç­–ç•¥å¯¹è±¡ã€‚å¦‚HandlerMappingsï¼ŒHandlerAdaptersç­‰ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">	 * This implementation calls &#123;@link #initStrategies&#125;.</div><div class="line">	 */</div><div class="line">	@Override</div><div class="line">	protected void onRefresh(ApplicationContext context) &#123;</div><div class="line">		initStrategies(context);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Initialize the strategy objects that this servlet uses.</div><div class="line">	 * &lt;p&gt;May be overridden in subclasses in order to initialize further strategy objects.</div><div class="line">	 */</div><div class="line">	protected void initStrategies(ApplicationContext context) &#123;</div><div class="line">		initMultipartResolver(context);</div><div class="line">		initLocaleResolver(context);</div><div class="line">		initThemeResolver(context);</div><div class="line">		initHandlerMappings(context);</div><div class="line">		initHandlerAdapters(context);</div><div class="line">		initHandlerExceptionResolvers(context);</div><div class="line">		initRequestToViewNameTranslator(context);</div><div class="line">		initViewResolvers(context);</div><div class="line">		initFlashMapManager(context);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼ŒDispatchServletå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[servlet ç”Ÿå‘½å‘¨æœŸ]]></title>
      <url>http://zsr.github.io/2016/08/15/servlet-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</url>
      <content type="html"><![CDATA[<h1 id="Servletç”Ÿå‘½å‘¨æœŸä¸å·¥ä½œåŸç†"><a href="#Servletç”Ÿå‘½å‘¨æœŸä¸å·¥ä½œåŸç†" class="headerlink" title="Servletç”Ÿå‘½å‘¨æœŸä¸å·¥ä½œåŸç†"></a>Servletç”Ÿå‘½å‘¨æœŸä¸å·¥ä½œåŸç†</h1><p><strong>Servletç”Ÿå‘½å‘¨æœŸåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</strong></p>
<p>ã€€ã€€1. åˆå§‹åŒ–é˜¶æ®µ  : è°ƒç”¨init()æ–¹æ³•</p>
<p>ã€€ã€€2. å“åº”å®¢æˆ·è¯·æ±‚é˜¶æ®µã€€:ã€€è°ƒç”¨service()æ–¹æ³•</p>
<p>ã€€ã€€3. ç»ˆæ­¢é˜¶æ®µã€€:ã€€è°ƒç”¨destroy()æ–¹æ³•
ã€€ã€€</p>
<h3 id="Servletåˆå§‹åŒ–é˜¶æ®µï¼š"><a href="#Servletåˆå§‹åŒ–é˜¶æ®µï¼š" class="headerlink" title="Servletåˆå§‹åŒ–é˜¶æ®µï¼š"></a>Servletåˆå§‹åŒ–é˜¶æ®µï¼š</h3><p>åœ¨ä¸‹åˆ—æ—¶åˆ»Servletå®¹å™¨è£…è½½Servlet:</p>
<ul>
<li>Servletå®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨è£…è½½æŸäº›Servletï¼Œå®ç°å®ƒåªéœ€è¦åœ¨web.XMLæ–‡ä»¶ä¸­çš„<servlet></servlet>ä¹‹é—´æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;loadon-startup&gt;1&lt;/loadon-startup&gt;</div></pre></td></tr></table></figure>
<ul>
<li>åœ¨Servletå®¹å™¨å¯åŠ¨åï¼Œå®¢æˆ·é¦–æ¬¡å‘Servletå‘é€è¯·æ±‚</li>
<li>Servletç±»æ–‡ä»¶è¢«æ›´æ–°åï¼Œé‡æ–°è£…è½½Servlet</li>
</ul>
<p>Servletè¢«è£…è½½åï¼ŒServletå®¹å™¨åˆ›å»ºä¸€ä¸ªServletå®ä¾‹å¹¶ä¸”è°ƒç”¨Servletçš„init()æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚åœ¨Servletçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…ï¼Œinit()æ–¹æ³•åªè¢«è°ƒç”¨ä¸€æ¬¡ã€‚</p>
<h3 id="Servletå·¥ä½œåŸç†ï¼š"><a href="#Servletå·¥ä½œåŸç†ï¼š" class="headerlink" title="Servletå·¥ä½œåŸç†ï¼š"></a>Servletå·¥ä½œåŸç†ï¼š</h3><p>   é¦–å…ˆç®€å•è§£é‡Šä¸€ä¸‹Servletæ¥æ”¶å’Œå“åº”å®¢æˆ·è¯·æ±‚çš„è¿‡ç¨‹ï¼Œé¦–å…ˆå®¢æˆ·å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ŒServletæ˜¯è°ƒç”¨service()æ–¹æ³•å¯¹è¯·æ±‚è¿›è¡Œå“åº”çš„ï¼Œé€šè¿‡æºä»£ç å¯è§ï¼Œservice()æ–¹æ³•ä¸­å¯¹è¯·æ±‚çš„æ–¹å¼è¿›è¡Œäº†åŒ¹é…ï¼Œé€‰æ‹©è°ƒç”¨doGet,doPostç­‰è¿™äº›æ–¹æ³•ï¼Œç„¶åå†è¿›å…¥å¯¹åº”çš„æ–¹æ³•ä¸­è°ƒç”¨é€»è¾‘å±‚çš„æ–¹æ³•ï¼Œå®ç°å¯¹å®¢æˆ·çš„å“åº”ã€‚åœ¨Servletæ¥å£å’ŒGenericServletä¸­æ˜¯æ²¡æœ‰doGet,doPostç­‰ç­‰è¿™äº›æ–¹æ³•çš„ï¼ŒHttpServletä¸­å®šä¹‰äº†è¿™äº›æ–¹æ³•ï¼Œä½†æ˜¯éƒ½æ˜¯è¿”å›errorä¿¡æ¯ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬æ¯æ¬¡å®šä¹‰ä¸€ä¸ªServletçš„æ—¶å€™ï¼Œéƒ½å¿…é¡»å®ç°doGetæˆ–doPostç­‰è¿™äº›æ–¹æ³•ã€‚</p>
<p>   æ¯ä¸€ä¸ªè‡ªå®šä¹‰çš„Servletéƒ½å¿…é¡»å®ç°Servletçš„æ¥å£ï¼ŒServletæ¥å£ä¸­å®šä¹‰äº†äº”ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„ä¸‰ä¸ªæ–¹æ³•æ¶‰åŠåˆ°Servletçš„ç”Ÿå‘½å‘¨æœŸï¼Œåˆ†åˆ«æ˜¯ä¸Šæ–‡æåˆ°çš„init(),service(),destroy()æ–¹æ³•ã€‚GenericServletæ˜¯ä¸€ä¸ªé€šç”¨çš„ï¼Œä¸ç‰¹å®šäºä»»ä½•åè®®çš„Servlet,å®ƒå®ç°äº†Servletæ¥å£ã€‚è€ŒHttpServletç»§æ‰¿äºGenericServletï¼Œå› æ­¤HttpServletä¹Ÿå®ç°äº†Servletæ¥å£ã€‚æ‰€ä»¥æˆ‘ä»¬å®šä¹‰Servletçš„æ—¶å€™åªéœ€è¦ç»§æ‰¿HttpServletå³å¯ã€‚</p>
<p>ã€€ã€€Servletæ¥å£å’ŒGenericServletæ˜¯ä¸ç‰¹å®šäºä»»ä½•åè®®çš„ï¼Œè€ŒHttpServletæ˜¯ç‰¹å®šäºHTTPåè®®çš„ç±»ï¼Œæ‰€ä»¥HttpServletä¸­å®ç°äº†service()æ–¹æ³•ï¼Œå¹¶å°†è¯·æ±‚ServletRequest,ServletResponseå¼ºè½¬ä¸ºHttpRequestå’ŒHttpResponseã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public void service(ServletRequest req,ServletResponse res) </div><div class="line">  throws ServletException,IOException</div><div class="line">&#123;</div><div class="line">      HttpRequest request;</div><div class="line">      HttpResponse response;</div><div class="line"> </div><div class="line">     try</div><div class="line">     &#123;</div><div class="line">         req = (HttpRequest)request;</div><div class="line">         res = (HttpResponse)response;</div><div class="line">      &#125;catch(ClassCastException e)</div><div class="line">      &#123;</div><div class="line">         throw new ServletException(&quot;non-HTTP request response&quot;); </div><div class="line">      &#125;</div><div class="line">      service(request,response);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>   ä»£ç çš„æœ€åè°ƒç”¨äº†HTTPServletè‡ªå·±çš„service(request,response)æ–¹æ³•ï¼Œç„¶åæ ¹æ®è¯·æ±‚å»è°ƒç”¨å¯¹åº”çš„doXXXæ–¹æ³•ï¼Œå› ä¸ºHttpServletä¸­çš„doXXXæ–¹æ³•éƒ½æ˜¯è¿”å›é”™è¯¯ä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">protected void doGet(HttpServletRequest res,HttpServletResponse resp)</div><div class="line">  throws ServletException,IOException</div><div class="line">&#123;</div><div class="line">   String protocol = req.getProtocol();</div><div class="line">   String msg = IStrings.getString(&quot;http.method_get_not_supported&quot;);</div><div class="line">   if(protocol.equals(&quot;1.1&quot;))</div><div class="line">   &#123;</div><div class="line">      resp.sendError(HttpServletResponse.SC.METHOD.NOT.ALLOWED,msg);</div><div class="line">    &#125;</div><div class="line">   esle</div><div class="line">    &#123;</div><div class="line">      resp.sendError(HttpServletResponse.SC_BAD_REQUEST,msg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥éœ€è¦æˆ‘ä»¬åœ¨è‡ªå®šä¹‰çš„Servletä¸­overrideè¿™äº›æ–¹æ³•ï¼</p>
<h3 id="Servletå“åº”è¯·æ±‚é˜¶æ®µï¼š"><a href="#Servletå“åº”è¯·æ±‚é˜¶æ®µï¼š" class="headerlink" title="Servletå“åº”è¯·æ±‚é˜¶æ®µï¼š"></a>Servletå“åº”è¯·æ±‚é˜¶æ®µï¼š</h3><p>å¯¹äºç”¨æˆ·åˆ°è¾¾Servletçš„è¯·æ±‚ï¼ŒServletå®¹å™¨ä¼šåˆ›å»ºç‰¹å®šäºè¿™ä¸ªè¯·æ±‚çš„ServletRequestå¯¹è±¡å’ŒServletResponseå¯¹è±¡ï¼Œç„¶åè°ƒç”¨Servletçš„serviceæ–¹æ³•ã€‚serviceæ–¹æ³•ä»ServletRequestå¯¹è±¡è·å¾—å®¢æˆ·è¯·æ±‚ä¿¡æ¯ï¼Œå¤„ç†è¯¥è¯·æ±‚ï¼Œå¹¶é€šè¿‡ServletResponseå¯¹è±¡å‘å®¢æˆ·è¿”å›å“åº”ä¿¡æ¯ã€‚</p>
<p>å¯¹äºTomcatæ¥è¯´ï¼Œå®ƒä¼šå°†ä¼ é€’è¿‡æ¥çš„å‚æ•°æ”¾åœ¨ä¸€ä¸ªHashtableä¸­ï¼Œè¯¥Hashtableçš„å®šä¹‰æ˜¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">private Hashtable&lt;String String[]&gt; paramHashStringArray = new Hashtable&lt;String String[]&gt;();</div></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªStringâ€“&gt;String[]çš„é”®å€¼æ˜ å°„ã€‚<br>HashMapçº¿ç¨‹ä¸å®‰å…¨çš„ï¼ŒHashtableçº¿ç¨‹å®‰å…¨ã€‚</p>
<h3 id="Servletç»ˆæ­¢é˜¶æ®µï¼š"><a href="#Servletç»ˆæ­¢é˜¶æ®µï¼š" class="headerlink" title="Servletç»ˆæ­¢é˜¶æ®µï¼š"></a>Servletç»ˆæ­¢é˜¶æ®µï¼š</h3><p>å½“WEBåº”ç”¨è¢«ç»ˆæ­¢ï¼Œæˆ–Servletå®¹å™¨ç»ˆæ­¢è¿è¡Œï¼Œæˆ–Servletå®¹å™¨é‡æ–°è£…è½½Servletæ–°å®ä¾‹æ—¶ï¼ŒServletå®¹å™¨ä¼šå…ˆè°ƒç”¨Servletçš„destroy()æ–¹æ³•ï¼Œåœ¨destroy()æ–¹æ³•ä¸­å¯ä»¥é‡Šæ”¾æ‰Servletæ‰€å ç”¨çš„èµ„æºã€‚</p>
<h3 id="Servletä½•æ—¶è¢«åˆ›å»ºï¼š"><a href="#Servletä½•æ—¶è¢«åˆ›å»ºï¼š" class="headerlink" title="Servletä½•æ—¶è¢«åˆ›å»ºï¼š"></a>Servletä½•æ—¶è¢«åˆ›å»ºï¼š</h3><ul>
<li><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“WEBå®¢æˆ·ç¬¬ä¸€æ¬¡è¯·æ±‚è®¿é—®æŸä¸ªServletçš„æ—¶å€™ï¼ŒWEBå®¹å™¨å°†åˆ›å»ºè¿™ä¸ªServletçš„å®ä¾‹ã€‚</p>
</li>
<li><p>å½“web.xmlæ–‡ä»¶ä¸­å¦‚æœ<servlet>å…ƒç´ ä¸­æŒ‡å®šäº†<load-on-startup>å­å…ƒç´ æ—¶ï¼ŒServletå®¹å™¨åœ¨å¯åŠ¨webæœåŠ¡å™¨æ—¶ï¼Œå°†æŒ‰ç…§é¡ºåºåˆ›å»ºå¹¶åˆå§‹åŒ–Servletå¯¹è±¡ã€‚</load-on-startup></servlet></p>
</li>
</ul>
<p><strong>æ³¨æ„ï¼šåœ¨web.xmlæ–‡ä»¶ä¸­ï¼ŒæŸäº›Servletåªæœ‰<serlvet>å…ƒç´ ï¼Œæ²¡æœ‰<servlet-mapping>å…ƒç´ ï¼Œè¿™æ ·æˆ‘ä»¬æ— æ³•é€šè¿‡urlçš„æ–¹å¼è®¿é—®è¿™äº›Servletï¼Œè¿™ç§Servleté€šå¸¸ä¼šåœ¨<servlet>å…ƒç´ ä¸­é…ç½®ä¸€ä¸ª<load-on-startup>å­å…ƒç´ ï¼Œè®©å®¹å™¨åœ¨å¯åŠ¨çš„æ—¶å€™è‡ªåŠ¨åŠ è½½è¿™äº›Servletå¹¶è°ƒç”¨init()æ–¹æ³•ï¼Œå®Œæˆä¸€äº›å…¨å±€æ€§çš„åˆå§‹åŒ–å·¥ä½œã€‚</load-on-startup></servlet></servlet-mapping></serlvet></strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Spring MVC è¯·æ±‚æ–¹æ³•å¤„ç†]]></title>
      <url>http://zsr.github.io/2016/08/15/Spring-MVC-%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95%E5%A4%84%E7%90%86/</url>
      <content type="html"><![CDATA[<p>åœ¨å‰é¢çš„æ–‡ç« ä¸­æœ‰è¯´æ˜ï¼š<code>&lt;mvc:annotation-driven /&gt;</code>åœ¨<code>spring 3.1</code>ä¹‹åä¼šæ³¨å†Œäº†<code>RequestMappingHandlerMapping</code>å’Œ<code>RequestMappingHandlerAdapter</code>ï¼Œæœ¬æ–‡è¯¦ç»†ä»‹ç»å…·ä½“çš„å®ç°ã€‚</p>
<p>åœ¨<code>xml</code>æ–‡ä»¶ä¸­é…ç½®<code>mvc:annotation-driven</code>ï¼Œæœ‰ä¸€ä¸ªä¸“é—¨çš„ç±»<code>BeanDefinitionParser</code>æ¥è§£æå¤„ç†è¿™ä¸ªä¸œè¥¿ã€‚ å®ƒåªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanDefinitionParser</span> </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="comment">/** </span></div><div class="line">     * Parse the specified &#123;<span class="doctag">@link</span> Element&#125; and register the resulting </div><div class="line">     * &#123;<span class="doctag">@link</span> BeanDefinition BeanDefinition(s)&#125; with the </div><div class="line">     * &#123;<span class="doctag">@link</span> org.springframework.beans.factory.xml.ParserContext#getRegistry() BeanDefinitionRegistry&#125; </div><div class="line">     * embedded in the supplied &#123;<span class="doctag">@link</span> ParserContext&#125;. </div><div class="line">     * &lt;p&gt;Implementations must return the primary &#123;<span class="doctag">@link</span> BeanDefinition&#125; that results </div><div class="line">     * from the parse if they will ever be used in a nested fashion (for example as </div><div class="line">     * an inner tag in a &#123;<span class="doctag">@code</span> &lt;property/&gt;&#125; tag). Implementations may return </div><div class="line">     * &#123;<span class="doctag">@code</span> null&#125; if they will &lt;strong&gt;not&lt;/strong&gt; be used in a nested fashion. </div><div class="line">     * <span class="doctag">@param</span> element the element that is to be parsed into one or more &#123;<span class="doctag">@link</span> BeanDefinition BeanDefinitions&#125; </div><div class="line">     * <span class="doctag">@param</span> parserContext the object encapsulating the current state of the parsing process; </div><div class="line">     * provides access to a &#123;<span class="doctag">@link</span> org.springframework.beans.factory.support.BeanDefinitionRegistry&#125; </div><div class="line">     * <span class="doctag">@return</span> the primary &#123;<span class="doctag">@link</span> BeanDefinition&#125; </div><div class="line">     */  </div><div class="line">    <span class="function">BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span></span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>ç”¨æ¥ä¸“é—¨å¤„ç†<code>&lt;beans&gt;&lt;/beans&gt;</code>é‡Œé¢çš„é…ç½®å…ƒç´ ã€‚ç„¶åæ‰¾åˆ°è¿™æ ·çš„ä¸€ä¸ªå®ç°ç±»<code>AnnotationDrivenBeanDefinitionParser</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * è¿™é‡Œæ¸…æ¸…æ¥šæ¥šå†™ç€è¯¥ç±»æ˜¯ä¸“é—¨å¤„ç† &lt;mvc:annotation-driven/&gt;æ ‡ç­¾çš„ </div><div class="line"> * A &#123;<span class="doctag">@link</span> BeanDefinitionParser&#125; that provides the configuration for the </div><div class="line"> * &#123;<span class="doctag">@code</span> &lt;annotation-driven/&gt;&#125; MVC namespace  element. </div><div class="line"> * </div><div class="line"> * è¿™é‡Œè¯´æ˜äº†æ³¨å†Œçš„HandlerMapping </div><div class="line"> * &lt;p&gt;This class registers the following &#123;<span class="doctag">@link</span> HandlerMapping&#125;s:&lt;/p&gt; </div><div class="line"> * &lt;ul&gt; </div><div class="line"> *  &lt;li&gt;&#123;<span class="doctag">@link</span> RequestMappingHandlerMapping&#125; </div><div class="line"> *  ordered at 0 for mapping requests to annotated controller methods. </div><div class="line"> *  &lt;li&gt;&#123;<span class="doctag">@link</span> BeanNameUrlHandlerMapping&#125; </div><div class="line"> *  ordered at 2 to map URL paths to controller bean names. </div><div class="line"> * &lt;/ul&gt; </div><div class="line"> * </div><div class="line"> * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; Additional HandlerMappings may be registered </div><div class="line"> * as a result of using the &#123;<span class="doctag">@code</span> &lt;view-controller&gt;&#125; or the </div><div class="line"> * &#123;<span class="doctag">@code</span> &lt;resources&gt;&#125; MVC namespace elements. </div><div class="line"> * </div><div class="line"> * è¿™é‡Œè¯´æ˜äº†æ³¨å†Œçš„HandlerAdapter </div><div class="line"> * &lt;p&gt;This class registers the following &#123;<span class="doctag">@link</span> HandlerAdapter&#125;s: </div><div class="line"> * &lt;ul&gt; </div><div class="line"> *  &lt;li&gt;&#123;<span class="doctag">@link</span> RequestMappingHandlerAdapter&#125; </div><div class="line"> *  for processing requests with annotated controller methods. </div><div class="line"> *  &lt;li&gt;&#123;<span class="doctag">@link</span> HttpRequestHandlerAdapter&#125; </div><div class="line"> *  for processing requests with &#123;<span class="doctag">@link</span> HttpRequestHandler&#125;s. </div><div class="line"> *  &lt;li&gt;&#123;<span class="doctag">@link</span> SimpleControllerHandlerAdapter&#125; </div><div class="line"> *  for processing requests with interface-based &#123;<span class="doctag">@link</span> Controller&#125;s. </div><div class="line"> * &lt;/ul&gt; </div><div class="line"> * </div><div class="line"> * &lt;p&gt;This class registers the following &#123;<span class="doctag">@link</span> HandlerExceptionResolver&#125;s: </div><div class="line"> * &lt;ul&gt; </div><div class="line"> *  &lt;li&gt;&#123;<span class="doctag">@link</span> ExceptionHandlerExceptionResolver&#125; for handling exceptions </div><div class="line"> *  through @&#123;<span class="doctag">@link</span> ExceptionHandler&#125; methods. </div><div class="line"> *  &lt;li&gt;&#123;<span class="doctag">@link</span> ResponseStatusExceptionResolver&#125; for exceptions annotated </div><div class="line"> *  with @&#123;<span class="doctag">@link</span> ResponseStatus&#125;. </div><div class="line"> *  &lt;li&gt;&#123;<span class="doctag">@link</span> DefaultHandlerExceptionResolver&#125; for resolving known Spring </div><div class="line"> *  exception types </div><div class="line"> * &lt;/ul&gt; </div><div class="line"> * </div><div class="line"> * &lt;p&gt;Both the &#123;<span class="doctag">@link</span> RequestMappingHandlerAdapter&#125; and the </div><div class="line"> * &#123;<span class="doctag">@link</span> ExceptionHandlerExceptionResolver&#125; are configured with instances of </div><div class="line"> * the following by default: </div><div class="line"> * &lt;ul&gt; </div><div class="line"> *  &lt;li&gt;A &#123;<span class="doctag">@link</span> ContentNegotiationManager&#125; </div><div class="line"> *  &lt;li&gt;A &#123;<span class="doctag">@link</span> DefaultFormattingConversionService&#125; </div><div class="line"> *  &lt;li&gt;A &#123;<span class="doctag">@link</span> org.springframework.validation.beanvalidation.LocalValidatorFactoryBean&#125; </div><div class="line"> *  if a JSR-303 implementation is available on the classpath </div><div class="line"> *  &lt;li&gt;A range of &#123;<span class="doctag">@link</span> HttpMessageConverter&#125;s depending on what 3rd party </div><div class="line"> *  libraries are available on the classpath. </div><div class="line"> * &lt;/ul&gt; </div><div class="line"> * </div><div class="line"> * <span class="doctag">@author</span> Keith Donald </div><div class="line"> * <span class="doctag">@author</span> Juergen Hoeller </div><div class="line"> * <span class="doctag">@author</span> Arjen Poutsma </div><div class="line"> * <span class="doctag">@author</span> Rossen Stoyanchev </div><div class="line"> * <span class="doctag">@author</span> Brian Clozel </div><div class="line"> * <span class="doctag">@since</span> 3.0 </div><div class="line"> */  </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnnotationDrivenBeanDefinitionParser</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionParser</span> </span>&#123;  </div><div class="line">          <span class="comment">//å…ˆçœç•¥ï¼Œè¯·è¯¦ç»†çœ‹ä¸‹æ–‡</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è§£æè¿‡ç¨‹çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;  </div><div class="line">        Object source = parserContext.extractSource(element);  </div><div class="line">  </div><div class="line">        <span class="comment">//çœç•¥... </span></div><div class="line">       </div><div class="line">        RootBeanDefinition handlerMappingDef = <span class="keyword">new</span> RootBeanDefinition(RequestMappingHandlerMapping.class);  </div><div class="line">          </div><div class="line">        RootBeanDefinition handlerAdapterDef = <span class="keyword">new</span> RootBeanDefinition(RequestMappingHandlerAdapter.class);  </div><div class="line">          </div><div class="line">        <span class="comment">//çœç•¥...</span></div><div class="line">      </div><div class="line">        <span class="comment">// æ³¨å†Œäº†RequestMappingHandlerMapping</span></div><div class="line">        parserContext.registerComponent(<span class="keyword">new</span> BeanComponentDefinition(handlerMappingDef, methodMappingName));</div><div class="line">        <span class="comment">// æ³¨å†Œäº†RequestMappingHandlerAdapter</span></div><div class="line">		parserContext.registerComponent(<span class="keyword">new</span> BeanComponentDefinition(handlerAdapterDef, handlerAdapterName));</div><div class="line">      </div><div class="line">        <span class="comment">// Ensure BeanNameUrlHandlerMapping (SPR-8289) and default HandlerAdapters are not "turned off"  </span></div><div class="line">        MvcNamespaceUtils.registerDefaultComponents(parserContext, source);  </div><div class="line">  </div><div class="line">        parserContext.popAndRegisterContainingComponent();  </div><div class="line">  </div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>é»˜è®¤æ³¨å†Œç»„ä»¶<code>MvcNamespaceUtils.registerDefaultComponents</code>çš„å¦‚ä¸‹ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerDefaultComponents</span><span class="params">(ParserContext parserContext, Object source)</span> </span>&#123;  </div><div class="line">        registerBeanNameUrlHandlerMapping(parserContext, source);  </div><div class="line">        registerHttpRequestHandlerAdapter(parserContext, source);  </div><div class="line">        registerSimpleControllerHandlerAdapter(parserContext, source);  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è‡³æ­¤æ‰€æ³¨å†Œçš„<code>HandlerMapping</code>å’Œ<code>HandlerAdapter</code>éƒ½æ‰¾åˆ°äº†ã€‚ </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;  </div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span> <span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span>  </span></div><div class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans  </span></div><div class="line">    http://www.springframework.org/schema/beans/spring-beans-3.1.xsd  </div><div class="line">    http://www.springframework.org/schema/mvc  </div><div class="line">    http://www.springframework.org/schema/mvc/spring-mvc-3.1.xsd  </div><div class="line">    http://www.springframework.org/schema/util  </div><div class="line">    http://www.springframework.org/schema/util/spring-util-2.0.xsd  </div><div class="line">    http://www.springframework.org/schema/context   </div><div class="line">    http://www.springframework.org/schema/context/spring-context-3.2.xsd"&gt;  </div><div class="line">          </div><div class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span>  </div><div class="line">  </div><div class="line">  <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>å¼€å¯äº†<code>&lt;mvc:annotation-driven/&gt;</code>ï¼ŒåŒæ—¶æ³¨å†Œäº†ä¸¤ä¸ªbeanã€‚æœ‰<code>RequestMappingHandlerMapping</code>å’Œ<code>RequestMappingHandlerAdapter</code>ä½œä¸ºæ”¯æŒï¼Œè¿™é‡Œç®€å•è¯´æ˜ä¸‹ï¼š<code>RequestMappingHandlerMapping</code>å®ƒä¼šåˆ¤æ–­ä¸€ä¸ªbeanæ˜¯å¦å«æœ‰<code>@Controller</code>æ ‡ç­¾æˆ–è€…<code>@RequestMapping</code>ï¼Œå¦‚æœæœ‰å…¶ä¸€åˆ™ä¼šå°†è¯¥beançº³å…¥ä½œä¸ºå®ƒçš„å¤„ç†å¯¹è±¡ï¼Œä¹‹åä¼šè¿›ä¸€æ­¥å¤„ç†è¯¥ç±»ä¸Šå«æœ‰<code>@RequestMapping</code>æ³¨è§£çš„æ–¹æ³•ã€‚è¿™æ ·åšä¸»è¦æ˜¯ç”±äº<code>@RequestMapping</code>å¯ä»¥é…ç½®åœ¨ç±»ä¸Šï¼ˆä½œä¸ºåŸºç¡€åœ°å€ï¼‰ï¼Œä¹Ÿå¯ä»¥é…ç½®åœ¨æ–¹æ³•ä¸Šï¼Œæˆ‘ä»¬æœ‰æ—¶å€™ä¼šåœ¨ç±»ä¸Šé…ç½®<code>@RequestMapping</code>ï¼Œæœ‰æ—¶å€™åˆä¸ä¼šï¼Œ<strong>æ‰€ä»¥åªè¦ç±»æ³¨è§£å«æœ‰<code>@Controller</code>æˆ–è€…å«æœ‰<code>@RequestMapping</code>ï¼Œ<code>RequestMappingHandlerMapping</code>éƒ½ä¼šå°†ä»–ä»¬çº³å…¥è‡ªå·±çš„handlerç®¡è¾–èŒƒå›´</strong>ã€‚æ‰€ä»¥ä»…ä»…åœ¨æ–¹æ³•ä¸­å«æœ‰<code>@RequestMapping</code>æ³¨è§£æ˜¯ä¸è¢«å¤„ç†çš„ï¼Œå¿…é¡»åœ¨ç±»ä¸ŠåŠ å…¥<code>@RequestMapping</code>æˆ–è€…<code>@Controller</code>ï¼Œæ‰€ä»¥<code>@Controller</code>åˆä¸æ˜¯å¿…é¡»çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span>  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringAction</span> </span>&#123;  </div><div class="line">      </div><div class="line">    <span class="meta">@ResponseBody</span>  </div><div class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/string"</span>,method=RequestMethod.GET)  </div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testMessageConverter</span><span class="params">(String name)</span> <span class="keyword">throws</span> UnsupportedEncodingException</span>&#123;  </div><div class="line">        System.out.println(name);  </div><div class="line">        <span class="keyword">return</span> name;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>@Controller</code>ä½¿å¾—<code>StringAction</code>è¿™ä¸ªhandlerçº³å…¥<code>RequestMappingHandlerMapping</code>ç®¡ç†ï¼Œ<code>RequestMappingHandlerMapping</code>ä¼šå°†è¿™ä¸ªhandlerå’Œhandlerä¸­çš„æ¯ä¸€ä¸ªå«æœ‰<code>@RequestMapping</code>çš„æ–¹æ³•éƒ½ä¼šæ„å»ºæˆä¸€ä¸ª<code>HandlerMethod</code>å¯¹è±¡ï¼Œè¯¥ç±»çš„æ„é€ å‡½æ•°ä¸º<code>HandlerMethod(Object bean, Method method)</code>ï¼Œç»è¿‡è¿™æ ·çš„åŒ…è£…ä¹‹åå°†æ„é€ çš„<code>HandlerMethod</code>å¯¹è±¡ä½œä¸ºæ–°çš„handlerï¼Œç„¶åè¿›è¡Œé€‰æ‹©é€‚é…å™¨ï¼Œè¿›è¡Œæ–¹æ³•è°ƒç”¨ï¼Œå½“<code>RequestMappingHandlerAdapter</code>åˆ¤æ–­æ˜¯å¦supportä¸€ä¸ªç±»æ—¶ï¼Œå°±æ˜¯ä¾æ®å½“å‰çš„handleæ˜¯å¦æ˜¯<code>HandlerMethod</code>ç±»å‹ã€‚è‹¥æ˜¯åˆ™ç”±<code>RequestMappingHandlerAdapter</code>æ¥è°ƒåº¦æ‰§è¡Œè¯¥handlerï¼ˆhandlerä¸º<code>HandlerMethod</code>ç±»å‹ï¼‰çš„ä¸­çš„methodæ–¹æ³•ã€‚ä»¥ä¸Šå°±æ˜¯æ•´ä¸ªå¤§ä½“çš„æµç¨‹ã€‚</p>
<ol>
<li>ç¬¬ä¸€æ­¥è¦å¼„æ¸…<code>RequestMappingHandlerMapping</code>åœ¨åˆå§‹åŒ–æ—¶æ˜¯å¦‚ä½•å¯»æ‰¾å®ƒæ‰€ç®¡è¾–çš„beanã€‚</li>
</ol>
<p><code>RequestMappingHandlerMapping</code>çš„çˆ¶ç±»<code>AbstractHandlerMethodMapping</code>åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨è¿™æ ·çš„ä¸€ä¸ªæ–¹æ³•<code>initHandlerMethods</code>ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œéå†æ‰€æœ‰çš„beanç„¶ååˆ¤æ–­ä»–ä»¬æ˜¯ä¸æ˜¯å«æœ‰<code>@Controller</code>æˆ–è€…<code>@RequestMapping</code>æ³¨è§£ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line"> * Detects handler methods at initialization.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</div><div class="line">	initHandlerMethods();</div><div class="line">&#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"> * Scan beans in the ApplicationContext, detect and register handler methods.</div><div class="line"> * <span class="doctag">@see</span> #isHandler(Class)</div><div class="line"> * <span class="doctag">@see</span> #getMappingForMethod(Method, Class)</div><div class="line"> * <span class="doctag">@see</span> #handlerMethodsInitialized(Map)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initHandlerMethods</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">		logger.debug(<span class="string">"Looking for request mappings in application context: "</span> + getApplicationContext());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	String[] beanNames = (<span class="keyword">this</span>.detectHandlerMethodsInAncestorContexts ?</div><div class="line">			BeanFactoryUtils.beanNamesForTypeIncludingAncestors(getApplicationContext(), Object.class) :</div><div class="line">			getApplicationContext().getBeanNamesForType(Object.class));</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (String beanName : beanNames) &#123;</div><div class="line">		<span class="keyword">if</span> (isHandler(getApplicationContext().getType(beanName)))&#123;</div><div class="line">			detectHandlerMethods(beanName);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	handlerMethodsInitialized(getHandlerMethods());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„<code>isHandler</code>(ç”±å­ç±»<code>RequestMappingHandlerMapping</code>å®ç°)çš„åˆ¤æ–­æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isHandler</span><span class="params">(Class&lt;?&gt; beanType)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> ((AnnotationUtils.findAnnotation(beanType, Controller.class) != <span class="keyword">null</span>) ||</div><div class="line">				(AnnotationUtils.findAnnotation(beanType, RequestMapping.class) != <span class="keyword">null</span>));</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœhandlerå«æœ‰äº†ä¸Šè¿°æ³¨è§£çš„å…¶ä¸­ä¹‹ä¸€ï¼Œå°±ä¼šè¿›ä¸€æ­¥å¤„ç†è¯¥handlerçš„æ–¹æ³•ä¸­å«æœ‰<code>@RequestMapping</code>çš„æ–¹æ³•ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line">    * æ‰¾åˆ°Controllerä¸­æœ‰<span class="doctag">@RequestMapping</span>æ³¨è§£çš„æ–¹æ³•</div><div class="line"> * Look for handler methods in a handler.</div><div class="line"> * <span class="doctag">@param</span> handler the bean name of a handler or a handler instance</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">detectHandlerMethods</span><span class="params">(<span class="keyword">final</span> Object handler)</span> </span>&#123;</div><div class="line">	Class&lt;?&gt; handlerType =</div><div class="line">			(handler <span class="keyword">instanceof</span> String ? getApplicationContext().getType((String) handler) : handler.getClass());</div><div class="line"></div><div class="line">	<span class="comment">// Avoid repeated calls to getMappingForMethod which would rebuild RequestMatchingInfo instances</span></div><div class="line">	<span class="keyword">final</span> Map&lt;Method, T&gt; mappings = <span class="keyword">new</span> IdentityHashMap&lt;Method, T&gt;();</div><div class="line">	<span class="keyword">final</span> Class&lt;?&gt; userType = ClassUtils.getUserClass(handlerType);</div><div class="line"></div><div class="line">	Set&lt;Method&gt; methods = HandlerMethodSelector.selectMethods(userType, <span class="keyword">new</span> MethodFilter() &#123;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Method method)</span> </span>&#123;</div><div class="line">			T mapping = getMappingForMethod(method, userType);</div><div class="line">			<span class="keyword">if</span> (mapping != <span class="keyword">null</span>) &#123;</div><div class="line">				mappings.put(method, mapping);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;);</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (Method method : methods) &#123;</div><div class="line">		registerHandlerMethod(handler, method, mappings.get(method));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>éå†è¿™ä¸ªhandlerç±»çš„æ‰€æœ‰æ–¹æ³•ï¼Œè¿‡æ»¤æ¡ä»¶å°±æ˜¯è¿™ä¸ªå†…éƒ¨ç±»<code>MethodFilter</code>ï¼Œå…¶ä¸­çš„<code>getMappingForMethod</code>æ–¹æ³•ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line"> * Uses method and type-level @&#123;<span class="doctag">@link</span> RequestMapping&#125; annotations to create</div><div class="line"> * the RequestMappingInfo.</div><div class="line"> * <span class="doctag">@return</span> the created RequestMappingInfo, or &#123;<span class="doctag">@code</span> null&#125; if the method</div><div class="line"> * does not have a &#123;<span class="doctag">@code</span> <span class="doctag">@RequestMapping</span>&#125; annotation.</div><div class="line"> * <span class="doctag">@see</span> #getCustomMethodCondition(Method)</div><div class="line"> * <span class="doctag">@see</span> #getCustomTypeCondition(Class)</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> RequestMappingInfo <span class="title">getMappingForMethod</span><span class="params">(Method method, Class&lt;?&gt; handlerType)</span> </span>&#123;</div><div class="line">	RequestMappingInfo info = <span class="keyword">null</span>;</div><div class="line">	RequestMapping methodAnnotation = AnnotationUtils.findAnnotation(method, RequestMapping.class);</div><div class="line">	<span class="keyword">if</span> (methodAnnotation != <span class="keyword">null</span>) &#123;</div><div class="line">		RequestCondition&lt;?&gt; methodCondition = getCustomMethodCondition(method);</div><div class="line">		info = createRequestMappingInfo(methodAnnotation, methodCondition);</div><div class="line">		RequestMapping typeAnnotation = AnnotationUtils.findAnnotation(handlerType, RequestMapping.class);</div><div class="line">		<span class="keyword">if</span> (typeAnnotation != <span class="keyword">null</span>) &#123;</div><div class="line">			RequestCondition&lt;?&gt; typeCondition = getCustomTypeCondition(handlerType);</div><div class="line">			info = createRequestMappingInfo(typeAnnotation, typeCondition).combine(info);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> info;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æ‰¾åˆ°äº†å«æœ‰<code>RequestMapping</code>æ³¨é‡Šçš„æ–¹æ³•ï¼Œåˆ™ç”±è¿™ä¸ªæ³¨é‡Šçš„å†…å®¹æ„å»ºä¸€ä¸ª<code>RequestMappingInfo</code>å¯¹è±¡ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line"> * Created a RequestMappingInfo from a RequestMapping annotation.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> RequestMappingInfo <span class="title">createRequestMappingInfo</span><span class="params">(RequestMapping annotation, RequestCondition&lt;?&gt; customCondition)</span> </span>&#123;</div><div class="line">	String[] patterns = resolveEmbeddedValuesInPatterns(annotation.value());</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> RequestMappingInfo(</div><div class="line">			<span class="keyword">new</span> PatternsRequestCondition(patterns, getUrlPathHelper(), getPathMatcher(),</div><div class="line">					<span class="keyword">this</span>.useSuffixPatternMatch, <span class="keyword">this</span>.useTrailingSlashMatch, <span class="keyword">this</span>.fileExtensions),</div><div class="line">			<span class="keyword">new</span> RequestMethodsRequestCondition(annotation.method()),</div><div class="line">			<span class="keyword">new</span> ParamsRequestCondition(annotation.params()),</div><div class="line">			<span class="keyword">new</span> HeadersRequestCondition(annotation.headers()),</div><div class="line">			<span class="keyword">new</span> ConsumesRequestCondition(annotation.consumes(), annotation.headers()),</div><div class="line">			<span class="keyword">new</span> ProducesRequestCondition(annotation.produces(), annotation.headers(), getContentNegotiationManager()),</div><div class="line">			customCondition);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å°±æ˜¯æ‹¿<code>RequestMapping</code>æ³¨é‡Šçš„å†…å®¹è¿›ä¸€æ­¥å°è£…è¿›<code>RequestMappingInfo</code>å¯¹è±¡ä¸­ã€‚å¯¹handlerçš„æ‰€æœ‰æ–¹æ³•è¿‡æ»¤å®Œæˆä¹‹åï¼Œå°±è¦éå†è¿™äº›æ–¹æ³•ï¼Œä»¥ä¸€å®šçš„æ–¹å¼å­˜å‚¨èµ·æ¥ã€‚ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">	 * Register a handler method and its unique mapping.</div><div class="line">	 * <span class="doctag">@param</span> handler the bean name of the handler or the handler instance</div><div class="line">	 * <span class="doctag">@param</span> method the method to register</div><div class="line">	 * <span class="doctag">@param</span> mapping the mapping conditions associated with the handler method</div><div class="line">	 * <span class="doctag">@throws</span> IllegalStateException if another method was already registered</div><div class="line">	 * under the same mapping</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerHandlerMethod</span><span class="params">(Object handler, Method method, T mapping)</span> </span>&#123;</div><div class="line">		HandlerMethod newHandlerMethod = createHandlerMethod(handler, method);</div><div class="line">		HandlerMethod oldHandlerMethod = <span class="keyword">this</span>.handlerMethods.get(mapping);</div><div class="line">		<span class="keyword">if</span> (oldHandlerMethod != <span class="keyword">null</span> &amp;&amp; !oldHandlerMethod.equals(newHandlerMethod)) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Ambiguous mapping found. Cannot map '"</span> + newHandlerMethod.getBean() +</div><div class="line">					<span class="string">"' bean method \n"</span> + newHandlerMethod + <span class="string">"\nto "</span> + mapping + <span class="string">": There is already '"</span> +</div><div class="line">					oldHandlerMethod.getBean() + <span class="string">"' bean method\n"</span> + oldHandlerMethod + <span class="string">" mapped."</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">this</span>.handlerMethods.put(mapping, newHandlerMethod);</div><div class="line">		<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line">			logger.info(<span class="string">"Mapped \""</span> + mapping + <span class="string">"\" onto "</span> + newHandlerMethod);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Set&lt;String&gt; patterns = getMappingPathPatterns(mapping);</div><div class="line">		<span class="keyword">for</span> (String pattern : patterns) &#123;</div><div class="line">			<span class="keyword">if</span> (!getPathMatcher().isPattern(pattern)) &#123;</div><div class="line">				<span class="keyword">this</span>.urlMap.add(pattern, mapping);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>this.handlerMethods</code>å°±åŒ…å«äº†æ‰€æœ‰ç®¡è¾–çš„beanï¼Œ<strong>keyä¸º<code>RequestMappingInfo</code>å¯¹è±¡ï¼Œvalueä¸ºhandlerå’Œå®ƒä¸­å«æœ‰<code>@RequestMapping</code>æ³¨é‡Šçš„æ–¹æ³•methodæ„å»ºçš„HandlerMethod</strong>ã€‚ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line">     * Create the HandlerMethod instance. </div><div class="line">     * <span class="doctag">@param</span> handler either a bean name or an actual handler instance </div><div class="line">     * <span class="doctag">@param</span> method the target method </div><div class="line">     * <span class="doctag">@return</span> the created HandlerMethod </div><div class="line">     */  </div><div class="line">    <span class="function"><span class="keyword">protected</span> HandlerMethod <span class="title">createHandlerMethod</span><span class="params">(Object handler, Method method)</span> </span>&#123;  </div><div class="line">        HandlerMethod handlerMethod;  </div><div class="line">        <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> String) &#123;  </div><div class="line">            String beanName = (String) handler;  </div><div class="line">            handlerMethod = <span class="keyword">new</span> HandlerMethod(beanName, getApplicationContext(), method);  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">else</span> &#123;  </div><div class="line">            handlerMethod = <span class="keyword">new</span> HandlerMethod(handler, method);  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">return</span> handlerMethod;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œ<code>RequestMappingHandlerMapping</code>çš„åˆå§‹åŒ–æ³¨å†Œå·¥ä½œå°±å®Œæˆäº†ã€‚</p>
<p>è¯·æ±‚<a href="http://localhost:8080/string?name=a`,RequestMappingHandlerMapping`ä¼šåŒ¹é…åˆ°ç”±`StringAction`å¯¹è±¡å’Œå®ƒçš„åŒ…å«æ³¨é‡Šçš„æ–¹æ³•`testMessageConverter`æ„å»ºçš„`HandlerMethod`å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å°†ä½œä¸ºhandlerï¼Œç„¶åå†éå†`HandlerAdapter`åˆ¤æ–­å®ƒä»¬æ˜¯å¦æ”¯æŒè¿™ä¸ªhandlerï¼Œ`RequestMappingHandlerAdapter`çš„åˆ¤æ–­ä¾æ®ä¸ºæ˜¯å¦æ˜¯`HandlerMethod`" target="_blank" rel="external">http://localhost:8080/string?name=a`,RequestMappingHandlerMapping`ä¼šåŒ¹é…åˆ°ç”±`StringAction`å¯¹è±¡å’Œå®ƒçš„åŒ…å«æ³¨é‡Šçš„æ–¹æ³•`testMessageConverter`æ„å»ºçš„`HandlerMethod`å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å°†ä½œä¸ºhandlerï¼Œç„¶åå†éå†`HandlerAdapter`åˆ¤æ–­å®ƒä»¬æ˜¯å¦æ”¯æŒè¿™ä¸ªhandlerï¼Œ`RequestMappingHandlerAdapter`çš„åˆ¤æ–­ä¾æ®ä¸ºæ˜¯å¦æ˜¯`HandlerMethod`</a> ç±»å‹ï¼ˆåœ¨<code>AbstractHandlerMethodAdapter</code>ç±»ä¸­ï¼‰ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">/**</span></div><div class="line">	 * This implementation expects the handler to be an &#123;<span class="doctag">@link</span> HandlerMethod&#125;.</div><div class="line">	 * <span class="doctag">@param</span> handler the handler instance to check</div><div class="line">	 * <span class="doctag">@return</span> whether or not this adapter can adapt the given handler</div><div class="line">	 */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Object handler)</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> handler <span class="keyword">instanceof</span> HandlerMethod &amp;&amp; supportsInternal((HandlerMethod) handler);  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ç„¶åå°†å¾—åˆ°åŒ¹é…ï¼Œæœ‰äº†è¿™ä¸ª<code>HandlerMethod</code>å¯¹è±¡ï¼Œä¾¿å¯ä»¥é€šè¿‡<code>RequestMappingHandlerAdapter</code>æ¥è°ƒåº¦æ‰§è¡Œ<code>HandlerMethod</code>å…¶ä¸­çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">  ......çœç•¥</div><div class="line">  	<span class="comment">// Determine handler for the current request.</span></div><div class="line">    mappedHandler = getHandler(processedRequest, <span class="keyword">false</span>);</div><div class="line">				<span class="keyword">if</span> (mappedHandler == <span class="keyword">null</span> || mappedHandler.getHandler() == <span class="keyword">null</span>) &#123;</div><div class="line">					noHandlerFound(processedRequest, response);</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">   <span class="comment">// Determine handler adapter for the current request.</span></div><div class="line">   HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</div><div class="line">  ......çœç•¥</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>mappedHandler</code>åŒ…å«handle(è¿™é‡Œæ˜¯<code>HandlerMethod</code>)å’Œä¸€äº›<code>HandlerInterceptor</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line"> * Return the HandlerAdapter for this handler object.</div><div class="line"> * <span class="doctag">@param</span> handler the handler object to find an adapter for</div><div class="line"> * <span class="doctag">@throws</span> ServletException if no HandlerAdapter can be found for the handler. This is a fatal error.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> HandlerAdapter <span class="title">getHandlerAdapter</span><span class="params">(Object handler)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">	<span class="keyword">for</span> (HandlerAdapter ha : <span class="keyword">this</span>.handlerAdapters) &#123;</div><div class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</div><div class="line">			logger.trace(<span class="string">"Testing handler adapter ["</span> + ha + <span class="string">"]"</span>);</div><div class="line">		&#125;</div><div class="line">           <span class="comment">// é‡ç‚¹ã€‚ã€‚ã€‚ã€‚ã€‚</span></div><div class="line">		<span class="keyword">if</span> (ha.supports(handler)) &#123;</div><div class="line">			<span class="keyword">return</span> ha;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"No adapter for handler ["</span> + handler +</div><div class="line">			<span class="string">"]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[rabbitmq exchangeæ¨¡å¼]]></title>
      <url>http://zsr.github.io/2016/08/12/rabbitmq-exchange%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<h1 id="rabbitmq-exchange"><a href="#rabbitmq-exchange" class="headerlink" title="rabbitmq exchange"></a>rabbitmq exchange</h1><p><strong>ä¸»è¦ä»‹ç»rabbitmqå¸¸ç”¨çš„ä¸‰ç§exchangeæ¨¡å¼ï¼šdirect, fanout, topic.</strong></p>
<h3 id="Virtual-Host"><a href="#Virtual-Host" class="headerlink" title="Virtual Host"></a>Virtual Host</h3><p>ä¸ºäº†åœ¨ä¸€ä¸ªå•ç‹¬çš„ä»£ç†ä¸Šå®ç°å¤šä¸ªéš”ç¦»çš„ç¯å¢ƒï¼ˆç”¨æˆ·ã€ç”¨æˆ·ç»„ã€äº¤æ¢æœºã€é˜Ÿåˆ— ç­‰ï¼‰ï¼ŒAMQPæä¾›äº†ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼ˆvirtual hosts - vhostsï¼‰çš„æ¦‚å¿µ,<strong>é»˜è®¤çš„virtual hostä¸º â€œ/â€œ.</strong></p>
<h3 id="Default-exchange-é»˜è®¤äº¤æ¢æœº"><a href="#Default-exchange-é»˜è®¤äº¤æ¢æœº" class="headerlink" title="Default exchange (é»˜è®¤äº¤æ¢æœº)"></a>Default exchange (é»˜è®¤äº¤æ¢æœº)</h3><p>é»˜è®¤äº¤æ¢æœºï¼ˆdefault exchangeï¼‰å®é™…ä¸Šæ˜¯ä¸€ä¸ªç”±æ¶ˆæ¯ä»£ç†é¢„å…ˆå£°æ˜å¥½çš„æ²¡æœ‰åå­—ï¼ˆåå­—ä¸ºç©ºå­—ç¬¦ä¸²ï¼‰çš„ç›´è¿äº¤æ¢æœºï¼ˆdirect exchangeï¼‰ã€‚å®ƒæœ‰ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§ä½¿å¾—å®ƒå¯¹äºç®€å•åº”ç”¨ç‰¹åˆ«æœ‰ç”¨å¤„ï¼šé‚£å°±æ˜¯æ¯ä¸ªæ–°å»ºé˜Ÿåˆ—ï¼ˆqueueï¼‰éƒ½ä¼šè‡ªåŠ¨ç»‘å®šåˆ°é»˜è®¤äº¤æ¢æœºä¸Šï¼Œ<strong>ç»‘å®šçš„è·¯ç”±é”®ï¼ˆrouting keyï¼‰åç§°ä¸é˜Ÿåˆ—åç§°ç›¸åŒã€‚</strong></p>
<h3 id="Direct-Exchange"><a href="#Direct-Exchange" class="headerlink" title="Direct Exchange"></a>Direct Exchange</h3><p><img src="/images/rabbitmq-exchange-1.png"></p>
<p><strong>ä»»ä½•å‘é€åˆ°Direct Exchangeçš„æ¶ˆæ¯éƒ½ä¼šè¢«è½¬å‘åˆ°RouteKeyä¸­æŒ‡å®šçš„Queueã€‚</strong></p>
<ul>
<li><p>ä¸€èˆ¬æƒ…å†µå¯ä»¥ä½¿ç”¨rabbitMQè‡ªå¸¦çš„Exchangeï¼šâ€â€(è¯¥Exchangeçš„åå­—ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œä¸‹æ–‡ç§°å…¶ä¸ºdefault Exchange)ã€‚</p>
</li>
<li><p>è¿™ç§æ¨¡å¼ä¸‹ä¸éœ€è¦å°†Exchangeè¿›è¡Œä»»ä½•ç»‘å®š(binding)æ“ä½œ</p>
</li>
<li><p>æ¶ˆæ¯ä¼ é€’æ—¶éœ€è¦ä¸€ä¸ªâ€œRouteKeyâ€ï¼Œå¯ä»¥ç®€å•çš„ç†è§£ä¸ºè¦å‘é€åˆ°çš„é˜Ÿåˆ—åå­—ã€‚</p>
</li>
<li><p>å¦‚æœvhostä¸­ä¸å­˜åœ¨RouteKeyä¸­æŒ‡å®šçš„é˜Ÿåˆ—åï¼Œåˆ™è¯¥æ¶ˆæ¯ä¼šè¢«æŠ›å¼ƒã€‚</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Channel channel = connection.createChannel();  </div><div class="line">channel.exchangeDeclare(&quot;exchangeName&quot;, &quot;direct&quot;); //direct fanout topic  </div><div class="line">channel.queueDeclare(&quot;queueName&quot;);  </div><div class="line">channel.queueBind(&quot;queueName&quot;, &quot;exchangeName&quot;, &quot;routingKey&quot;);  </div><div class="line">  </div><div class="line">byte[] messageBodyBytes = &quot;hello world&quot;.getBytes();  </div><div class="line">//éœ€è¦ç»‘å®šè·¯ç”±é”®  </div><div class="line">channel.basicPublish(&quot;exchangeName&quot;, &quot;routingKey&quot;, MessageProperties.PERSISTENT_TEXT_PLAIN, messageBodyBytes);</div></pre></td></tr></table></figure>
<h3 id="Fanout-Exchange"><a href="#Fanout-Exchange" class="headerlink" title="Fanout Exchange"></a>Fanout Exchange</h3><p><img src="/images/rabbitmq-exchange-2.png"></p>
<p><strong>ä»»ä½•å‘é€åˆ°Fanout Exchangeçš„æ¶ˆæ¯éƒ½ä¼šè¢«è½¬å‘åˆ°ä¸è¯¥Exchangeç»‘å®š(Binding)çš„æ‰€æœ‰Queueä¸Šã€‚</strong></p>
<ul>
<li><p>å¯ä»¥ç†è§£ä¸ºè·¯ç”±è¡¨çš„æ¨¡å¼</p>
</li>
<li><p>è¿™ç§æ¨¡å¼ä¸éœ€è¦RouteKey</p>
</li>
<li><p>è¿™ç§æ¨¡å¼éœ€è¦æå‰å°†Exchangeä¸Queueè¿›è¡Œç»‘å®šï¼Œä¸€ä¸ªExchangeå¯ä»¥ç»‘å®šå¤šä¸ªQueueï¼Œä¸€ä¸ªQueueå¯ä»¥åŒå¤šä¸ªExchangeè¿›è¡Œç»‘å®šã€‚</p>
</li>
<li><p>å¦‚æœæ¥å—åˆ°æ¶ˆæ¯çš„Exchangeæ²¡æœ‰ä¸ä»»ä½•Queueç»‘å®šï¼Œåˆ™æ¶ˆæ¯ä¼šè¢«æŠ›å¼ƒã€‚</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Channel channel = connection.createChannel();  </div><div class="line">channel.exchangeDeclare(&quot;exchangeName&quot;, &quot;fanout&quot;); //direct fanout topic  </div><div class="line">channel.queueDeclare(&quot;queueName&quot;);  </div><div class="line">channel.queueBind(&quot;queueName&quot;, &quot;exchangeName&quot;, &quot;routingKey&quot;);  </div><div class="line">  </div><div class="line">channel.queueDeclare(&quot;queueName1&quot;);  </div><div class="line">channel.queueBind(&quot;queueName1&quot;, &quot;exchangeName&quot;, &quot;routingKey1&quot;);  </div><div class="line">  </div><div class="line">byte[] messageBodyBytes = &quot;hello world&quot;.getBytes();  </div><div class="line">//è·¯ç”±é”®éœ€è¦è®¾ç½®ä¸ºç©º  </div><div class="line">channel.basicPublish(&quot;exchangeName&quot;, &quot;&quot;, MessageProperties.PERSISTENT_TEXT_PLAIN, messageBodyBytes);</div></pre></td></tr></table></figure>
<h3 id="Topic-Exchange"><a href="#Topic-Exchange" class="headerlink" title="Topic Exchange"></a>Topic Exchange</h3><p><img src="/images/rabbitmq-exchange-3.png"></p>
<p><strong>ä»»ä½•å‘é€åˆ°Topic Exchangeçš„æ¶ˆæ¯éƒ½ä¼šè¢«è½¬å‘åˆ°æ‰€æœ‰å…³å¿ƒRouteKeyä¸­æŒ‡å®šè¯é¢˜çš„Queueä¸Š.</strong></p>
<ul>
<li><p>è¿™ç§æ¨¡å¼è¾ƒä¸ºå¤æ‚ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ¯ä¸ªé˜Ÿåˆ—éƒ½æœ‰å…¶å…³å¿ƒçš„ä¸»é¢˜ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯éƒ½å¸¦æœ‰ä¸€ä¸ªâ€œæ ‡é¢˜â€(RouteKey)ï¼ŒExchangeä¼šå°†æ¶ˆæ¯è½¬å‘åˆ°æ‰€æœ‰å…³æ³¨ä¸»é¢˜èƒ½ä¸RouteKeyæ¨¡ç³ŠåŒ¹é…çš„é˜Ÿåˆ—ã€‚</p>
</li>
<li><p>è¿™ç§æ¨¡å¼éœ€è¦RouteKeyï¼Œä¹Ÿè®¸è¦æå‰ç»‘å®šExchangeä¸Queueã€‚</p>
</li>
<li><p>åœ¨è¿›è¡Œç»‘å®šæ—¶ï¼Œè¦æä¾›ä¸€ä¸ªè¯¥é˜Ÿåˆ—å…³å¿ƒçš„ä¸»é¢˜ï¼Œå¦‚â€œ#.log.#â€è¡¨ç¤ºè¯¥é˜Ÿåˆ—å…³å¿ƒæ‰€æœ‰æ¶‰åŠlogçš„æ¶ˆæ¯(ä¸€ä¸ªRouteKeyä¸ºâ€MQ.log.errorâ€çš„æ¶ˆæ¯ä¼šè¢«è½¬å‘åˆ°è¯¥é˜Ÿåˆ—)ã€‚</p>
</li>
<li><p>â€œ#â€è¡¨ç¤º0ä¸ªæˆ–è‹¥å¹²ä¸ªå…³é”®å­—ï¼Œâ€œ<em>â€è¡¨ç¤ºä¸€ä¸ªå…³é”®å­—ã€‚å¦‚â€œlog.</em>â€èƒ½ä¸â€œlog.warnâ€åŒ¹é…ï¼Œæ— æ³•ä¸â€œlog.warn.timeoutâ€åŒ¹é…ï¼›ä½†æ˜¯â€œlog.#â€èƒ½ä¸ä¸Šè¿°ä¸¤è€…åŒ¹é…ã€‚</p>
</li>
<li><p>åŒæ ·ï¼Œå¦‚æœExchangeæ²¡æœ‰å‘ç°èƒ½å¤Ÿä¸RouteKeyåŒ¹é…çš„Queueï¼Œåˆ™ä¼šæŠ›å¼ƒæ­¤æ¶ˆæ¯ã€‚</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Channel channel = connection.createChannel();  </div><div class="line">channel.exchangeDeclare(&quot;exchangeName&quot;, &quot;topic&quot;); //direct fanout topic  </div><div class="line">channel.queueDeclare(&quot;queueName&quot;);  </div><div class="line">channel.queueBind(&quot;queueName&quot;, &quot;exchangeName&quot;, &quot;routingKey.*&quot;);  </div><div class="line">  </div><div class="line">byte[] messageBodyBytes = &quot;hello world&quot;.getBytes();  </div><div class="line">channel.basicPublish(&quot;exchangeName&quot;, &quot;routingKey.one&quot;, MessageProperties.PERSISTENT_TEXT_PLAIN, messageBodyBytes);</div></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[SpringMVC å‚æ•°æ ¡éªŒ]]></title>
      <url>http://zsr.github.io/2016/08/11/SpringMVC-%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C/</url>
      <content type="html"><![CDATA[<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>éœ€è¦å¯¹Postè¯·æ±‚çš„è¡¨å•æ•°æ®è¿›è¡Œç®€å•æ ¡éªŒã€‚</p>
<h3 id="Maven-é…ç½®"><a href="#Maven-é…ç½®" class="headerlink" title="Maven é…ç½®"></a>Maven é…ç½®</h3><ul>
<li>Bean Validation API 1.1: </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;javax.validation&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;validation-api&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;1.1.0.Final&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<ul>
<li>Hibernate Validator 5.0.1.Final: </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.hibernate&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;hibernate-validator&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;5.0.1.Final&lt;/version&gt;</div><div class="line"> &lt;/dependency&gt;</div></pre></td></tr></table></figure>
<h3 id="Spring-MVC"><a href="#Spring-MVC" class="headerlink" title="Spring MVC"></a>Spring MVC</h3><h5 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h5><p>åœ¨application-context.xmlæ–‡ä»¶ä¸­åŠ å…¥ä¸‹é¢ä¸€è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;mvc:annotation-driven /&gt;</div></pre></td></tr></table></figure>
<h5 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h5><ol>
<li>åœ¨éœ€è¦æ ¡éªŒçš„modelå¯¹è±¡å‰é¢åŠ ä¸Š@Validæ³¨è§£(javax.validation.Valid):</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@RequestMapping(</div><div class="line">      value = &quot;/v1/live/send/gift&quot;, method = RequestMethod.POST)</div><div class="line">  @Response</div><div class="line">public WebResult requestSendGift(HttpServletRequest request, @Valid @ModelAttribute SendGiftForm sendGiftForm, BindingResult bindingResult) &#123;</div><div class="line"></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>åœ¨controlleræ–¹æ³•é‡Œé¢åŠ ä¸Šå‚æ•°åˆ¤æ–­ï¼š</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">if (bindingResult.hasErrors()) &#123;</div><div class="line">        throw new IllegalArgumentException(&quot;request params must be not null.&quot;);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h5 id="Validator-Model"><a href="#Validator-Model" class="headerlink" title="Validator Model"></a>Validator Model</h5><p>åœ¨éœ€è¦æ ¡éªŒçš„modelå­—æ®µå‰é¢åŠ ä¸Šæ³¨è§£(hibernate validator):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public class SendGiftForm &#123;</div><div class="line">  @NotNull</div><div class="line">  private Long roomId; </div><div class="line">  @NotNull</div><div class="line">  private Long liveId; </div><div class="line">  </div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="å‚è€ƒé“¾æ¥ï¼š"><a href="#å‚è€ƒé“¾æ¥ï¼š" class="headerlink" title="å‚è€ƒé“¾æ¥ï¼š"></a>å‚è€ƒé“¾æ¥ï¼š</h3><p><a href="http://www.codejava.net/frameworks/spring/spring-mvc-form-validation-example-with-bean-validation-api" target="_blank" rel="external">Spring Form Validation</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[rabbitmqå»¶æ—¶é˜Ÿåˆ—]]></title>
      <url>http://zsr.github.io/2016/08/10/rabbitmq%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97/</url>
      <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>rabbitmq æ˜¯ç›®å‰ä½¿ç”¨æœ€ä¸ºæ™®åŠçš„æ¶ˆæ¯é˜Ÿåˆ—ç»„ä»¶ï¼ŒåŸºäº AMQP çš„ rabbitmq åœ¨å„æ–¹é¢è®¾è®¡éƒ½æ¯”è¾ƒå®Œå–„ï¼ŒåŒæ—¶ï¼Œå®ƒå…·æœ‰éå¸¸ä¸°å¯Œçš„åŠŸèƒ½ä¸ç‰¹æ€§ï¼Œå¯ä»¥æ”¯æŒå„ç§å®é™…çš„é€‚ç”¨åœºæ™¯ã€‚</p>
<p>ä½†æ˜¯<strong>rabbitmqå¹¶ä¸ç›´æ¥æ”¯æŒå»¶æ—¶é˜Ÿåˆ—</strong>çš„åŠŸèƒ½ï¼Œæœ¬æ–‡æˆ‘ä»¬å°±æ¥ä»‹ç»ä¸€ä¸‹ï¼Œå¦‚ä½•ä½¿ç”¨ rabbitmq å®ç°ä¸€ä¸ªå»¶æ—¶é˜Ÿåˆ—ã€‚</p>
<h1 id="å»¶æ—¶é˜Ÿåˆ—çš„ç®€æ˜“å®ç°"><a href="#å»¶æ—¶é˜Ÿåˆ—çš„ç®€æ˜“å®ç°" class="headerlink" title="å»¶æ—¶é˜Ÿåˆ—çš„ç®€æ˜“å®ç°"></a>å»¶æ—¶é˜Ÿåˆ—çš„ç®€æ˜“å®ç°</h1><p>ä½¿ç”¨redisé›†ç¾¤æ¥å®ç°äº†è¿™ä¸ªåŠŸèƒ½ï¼Œredisä¸­å­˜å‚¨äº†ä¸‹å•æ—¶é—´ï¼Œä»¥åˆ†é’Ÿä¸ºç²’åº¦æ‰«æç›¸åº”çš„keyï¼Œå³å¯æ‰«å‡ºæ‰€æœ‰ä¸‹å•æ—¶é—´è¶…è¿‡æŒ‡å®šæ—¶é—´é—´éš”çš„æ•°æ®.</p>
<h1 id="rabbitmq-ä¸æ¶ˆæ¯è¿‡æœŸæ—¶é—´-â€“-TTL"><a href="#rabbitmq-ä¸æ¶ˆæ¯è¿‡æœŸæ—¶é—´-â€“-TTL" class="headerlink" title="rabbitmq ä¸æ¶ˆæ¯è¿‡æœŸæ—¶é—´ â€“ TTL"></a>rabbitmq ä¸æ¶ˆæ¯è¿‡æœŸæ—¶é—´ â€“ TTL</h1><h3 id="ä¸ºé˜Ÿåˆ—è®¾ç½®æ¶ˆæ¯è¿‡æœŸæ—¶é—´"><a href="#ä¸ºé˜Ÿåˆ—è®¾ç½®æ¶ˆæ¯è¿‡æœŸæ—¶é—´" class="headerlink" title="ä¸ºé˜Ÿåˆ—è®¾ç½®æ¶ˆæ¯è¿‡æœŸæ—¶é—´"></a>ä¸ºé˜Ÿåˆ—è®¾ç½®æ¶ˆæ¯è¿‡æœŸæ—¶é—´</h3><p>rabbitmq æ”¯æŒåœ¨åˆ›å»ºé˜Ÿåˆ—æ—¶å¯¹é˜Ÿåˆ—è®¾ç½®æ¶ˆæ¯è¿‡æœŸæ—¶é—´ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Map&lt;String, Object&gt; args = new HashMap&lt;String, Object&gt;();</div><div class="line">args.put(&quot;x-message-ttl&quot;, 60000);</div><div class="line">channel.queueDeclare(&quot;myqueue&quot;, false, false, false, args);</div></pre></td></tr></table></figure>
<h1 id="å¤±æ•ˆæ¶ˆæ¯è½¬å‘é˜Ÿåˆ—-â€“-DLX"><a href="#å¤±æ•ˆæ¶ˆæ¯è½¬å‘é˜Ÿåˆ—-â€“-DLX" class="headerlink" title="å¤±æ•ˆæ¶ˆæ¯è½¬å‘é˜Ÿåˆ— â€“ DLX"></a>å¤±æ•ˆæ¶ˆæ¯è½¬å‘é˜Ÿåˆ— â€“ DLX</h1><p>ä¸€æ—¦ä¸Šè¿°æ¶ˆæ¯è¿‡æœŸæ—¶é—´è®¾ç½®ç”Ÿæ•ˆï¼ŒæŸæ¡æ¶ˆæ¯è¾¾åˆ°æ¶ˆæ¯è¿‡æœŸæ—¶é—´ï¼Œé‚£ä¹ˆä»–å°†ä¼šæˆä¸ºä¸€æ¡â€œdead-letteredâ€ï¼Œæ­¤å¤–ï¼Œè¢«æ‹’ç»çš„æ¶ˆæ¯å¦‚æœrequeueå±æ€§ä¸º falseï¼Œæˆ–è€…æ¶ˆæ¯æ‰€åœ¨é˜Ÿåˆ—å·²è¾¾åˆ°æœ€å¤§é•¿åº¦ï¼Œé‚£ä¹ˆä»–ä¹Ÿå°†æˆä¸ºâ€œdead-letteredâ€.</p>
<p>å¦‚æœè®¾ç½®äº†DLXè§„åˆ™ï¼Œå³å¤±æ•ˆæ¶ˆæ¯è½¬å‘è§„åˆ™ï¼Œé‚£ä¹ˆå¤±æ•ˆçš„æ¶ˆæ¯å°±ä¼šè¢«è½¬å‘åˆ°ç›¸åº”çš„exchangeå’Œqueue.</p>
<h3 id="é€šè¿‡ä»£ç è®¾ç½®å¤±æ•ˆæ¶ˆæ¯è½¬å‘é˜Ÿåˆ—"><a href="#é€šè¿‡ä»£ç è®¾ç½®å¤±æ•ˆæ¶ˆæ¯è½¬å‘é˜Ÿåˆ—" class="headerlink" title="é€šè¿‡ä»£ç è®¾ç½®å¤±æ•ˆæ¶ˆæ¯è½¬å‘é˜Ÿåˆ—"></a>é€šè¿‡ä»£ç è®¾ç½®å¤±æ•ˆæ¶ˆæ¯è½¬å‘é˜Ÿåˆ—</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">channel.exchangeDeclare(&quot;some.exchange.name&quot;, &quot;direct&quot;);</div><div class="line"></div><div class="line">Map&lt;String, Object&gt; args = new HashMap&lt;String, Object&gt;();</div><div class="line">args.put(&quot;x-dead-letter-exchange&quot;, &quot;some.exchange.name&quot;);</div><div class="line">channel.queueDeclare(&quot;myqueue&quot;, false, false, false, args);</div></pre></td></tr></table></figure>
<p>è¿™æ ·ï¼Œä¸€æ—¦æ¶ˆæ¯å¤±æ•ˆï¼Œåˆ™æ¶ˆæ¯ä¼šè¢«è‡ªåŠ¨è½¬å‘åˆ°ä½ è®¾ç½®çš„x-dead-letter-exchangeä¸Šçš„åŒåé˜Ÿåˆ—.</p>
<p>ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç æŒ‡å®šå…·ä½“è½¬å‘çš„ç›®æ ‡ routing-keyï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">args.put(&quot;x-dead-letter-routing-key&quot;, &quot;some-routing-key&quot;);</div></pre></td></tr></table></figure>
<h3 id="spring-rabbit-é…ç½®"><a href="#spring-rabbit-é…ç½®" class="headerlink" title="spring-rabbit é…ç½®"></a>spring-rabbit é…ç½®</h3><p>å¯ä»¥ä½¿ç”¨spring-rabbité…ç½®æ›¿ä»£ä»£ç æ–¹å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;rabbit:queue name=&quot;q.with.dlx&quot;&gt;</div><div class="line">    &lt;rabbit:queue-arguments&gt; </div><div class="line">        &lt;entry key=&quot;x-dead-letter-exchange&quot; value=&quot;dlx&quot;/&gt;</div><div class="line">        &lt;entry key=&quot;x-message-ttl&quot; value=&quot;10000&quot; value-type=&quot;java.lang.Long&quot;/&gt;</div><div class="line">    &lt;/rabbit:queue-arguments&gt;</div><div class="line">&lt;/rabbit:queue&gt;</div><div class="line"></div><div class="line">&lt;rabbit:queue name=&quot;dlq&quot;/&gt;</div><div class="line"></div><div class="line">&lt;rabbit:direct-exchange name=&quot;dlx&quot;&gt;</div><div class="line">    &lt;rabbit:bindings&gt;</div><div class="line">        &lt;rabbit:binding key=&quot;q.with.dlx&quot; queue=&quot;dlq&quot;/&gt;</div><div class="line">    &lt;/rabbit:bindings&gt;</div><div class="line">&lt;/rabbit:direct-exchange&gt;</div></pre></td></tr></table></figure>
<p>This assumes you routed the original message using the default direct exchange (routing by queue name). Hence the dead letter routing uses the same routing key (queue name). If you route using an explicit routing key, you would use that.</p>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="http://www.rabbitmq.com/ttl.html" target="_blank" rel="external">RabbitMQ TTL</a></p>
<p><a href="http://www.rabbitmq.com/dlx.html" target="_blank" rel="external">RabbitMQ DLX</a></p>
<p><a href="http://docs.spring.io/spring-amqp/docs/1.3.9.RELEASE/reference/html/amqp.html" target="_blank" rel="external">Spring AMQP</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[æ·±å…¥ç†è§£Javaå†…å­˜æ¨¡å‹]]></title>
      <url>http://zsr.github.io/2016/08/08/java%E8%99%9A%E6%8B%9F%E6%9C%BA/</url>
      <content type="html"><![CDATA[<h1 id="æ·±å…¥ç†è§£Javaå†…å­˜æ¨¡å‹ï¼ˆä¸€ï¼‰"><a href="#æ·±å…¥ç†è§£Javaå†…å­˜æ¨¡å‹ï¼ˆä¸€ï¼‰" class="headerlink" title="æ·±å…¥ç†è§£Javaå†…å­˜æ¨¡å‹ï¼ˆä¸€ï¼‰"></a>æ·±å…¥ç†è§£Javaå†…å­˜æ¨¡å‹ï¼ˆä¸€ï¼‰</h1><p>åŸæ–‡å‘è¡¨äºInfoQï¼š<a href="http://www.infoq.com/cn/articles/java-memory-model-1" target="_blank" rel="external">http://www.infoq.com/cn/articles/java-memory-model-1</a></p>
<h3 id="å¹¶å‘ç¼–ç¨‹æ¨¡å‹çš„åˆ†ç±»"><a href="#å¹¶å‘ç¼–ç¨‹æ¨¡å‹çš„åˆ†ç±»" class="headerlink" title="å¹¶å‘ç¼–ç¨‹æ¨¡å‹çš„åˆ†ç±»"></a>å¹¶å‘ç¼–ç¨‹æ¨¡å‹çš„åˆ†ç±»</h3><p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼šçº¿ç¨‹ä¹‹é—´å¦‚ä½•é€šä¿¡åŠçº¿ç¨‹ä¹‹é—´å¦‚ä½•åŒæ­¥ï¼ˆè¿™é‡Œçš„çº¿ç¨‹æ˜¯æŒ‡å¹¶å‘æ‰§è¡Œçš„æ´»åŠ¨å®ä½“ï¼‰ã€‚é€šä¿¡æ˜¯æŒ‡çº¿ç¨‹ä¹‹é—´ä»¥ä½•ç§æœºåˆ¶æ¥äº¤æ¢ä¿¡æ¯ã€‚åœ¨å‘½ä»¤å¼ç¼–ç¨‹ä¸­ï¼Œçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æœºåˆ¶æœ‰ä¸¤ç§ï¼šå…±äº«å†…å­˜å’Œæ¶ˆæ¯ä¼ é€’ã€‚<br>åœ¨å…±äº«å†…å­˜çš„å¹¶å‘æ¨¡å‹é‡Œï¼Œçº¿ç¨‹ä¹‹é—´å…±äº«ç¨‹åºçš„å…¬å…±çŠ¶æ€ï¼Œçº¿ç¨‹ä¹‹é—´é€šè¿‡å†™-è¯»å†…å­˜ä¸­çš„å…¬å…±çŠ¶æ€æ¥éšå¼è¿›è¡Œé€šä¿¡ã€‚åœ¨æ¶ˆæ¯ä¼ é€’çš„å¹¶å‘æ¨¡å‹é‡Œï¼Œçº¿ç¨‹ä¹‹é—´æ²¡æœ‰å…¬å…±çŠ¶æ€ï¼Œçº¿ç¨‹ä¹‹é—´å¿…é¡»é€šè¿‡æ˜ç¡®çš„å‘é€æ¶ˆæ¯æ¥æ˜¾å¼è¿›è¡Œé€šä¿¡ã€‚<br>åŒæ­¥æ˜¯æŒ‡ç¨‹åºç”¨äºæ§åˆ¶ä¸åŒçº¿ç¨‹ä¹‹é—´æ“ä½œå‘ç”Ÿç›¸å¯¹é¡ºåºçš„æœºåˆ¶ã€‚åœ¨å…±äº«å†…å­˜å¹¶å‘æ¨¡å‹é‡Œï¼ŒåŒæ­¥æ˜¯æ˜¾å¼è¿›è¡Œçš„ã€‚ç¨‹åºå‘˜å¿…é¡»æ˜¾å¼æŒ‡å®šæŸä¸ªæ–¹æ³•æˆ–æŸæ®µä»£ç éœ€è¦åœ¨çº¿ç¨‹ä¹‹é—´äº’æ–¥æ‰§è¡Œã€‚åœ¨æ¶ˆæ¯ä¼ é€’çš„å¹¶å‘æ¨¡å‹é‡Œï¼Œç”±äºæ¶ˆæ¯çš„å‘é€å¿…é¡»åœ¨æ¶ˆæ¯çš„æ¥æ”¶ä¹‹å‰ï¼Œå› æ­¤åŒæ­¥æ˜¯éšå¼è¿›è¡Œçš„ã€‚<br><strong>Javaçš„å¹¶å‘é‡‡ç”¨çš„æ˜¯å…±äº«å†…å­˜æ¨¡å‹</strong>ï¼ŒJavaçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æ€»æ˜¯éšå¼è¿›è¡Œï¼Œæ•´ä¸ªé€šä¿¡è¿‡ç¨‹å¯¹ç¨‹åºå‘˜å®Œå…¨é€æ˜ã€‚å¦‚æœç¼–å†™å¤šçº¿ç¨‹ç¨‹åºçš„Javaç¨‹åºå‘˜ä¸ç†è§£éšå¼è¿›è¡Œçš„çº¿ç¨‹ä¹‹é—´é€šä¿¡çš„å·¥ä½œæœºåˆ¶ï¼Œå¾ˆå¯èƒ½ä¼šé‡åˆ°å„ç§å¥‡æ€ªçš„å†…å­˜å¯è§æ€§é—®é¢˜ã€‚</p>
<h3 id="Javaå†…å­˜æ¨¡å‹çš„æŠ½è±¡"><a href="#Javaå†…å­˜æ¨¡å‹çš„æŠ½è±¡" class="headerlink" title="Javaå†…å­˜æ¨¡å‹çš„æŠ½è±¡"></a>Javaå†…å­˜æ¨¡å‹çš„æŠ½è±¡</h3><p>åœ¨javaä¸­ï¼Œæ‰€æœ‰å®ä¾‹åŸŸã€é™æ€åŸŸå’Œæ•°ç»„å…ƒç´ å­˜å‚¨åœ¨å †å†…å­˜ä¸­ï¼Œå †å†…å­˜åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ï¼ˆæœ¬æ–‡ä½¿ç”¨â€œå…±äº«å˜é‡â€è¿™ä¸ªæœ¯è¯­ä»£æŒ‡å®ä¾‹åŸŸï¼Œé™æ€åŸŸå’Œæ•°ç»„å…ƒç´ ï¼‰ã€‚å±€éƒ¨å˜é‡ï¼ˆLocal variablesï¼‰ï¼Œæ–¹æ³•å®šä¹‰å‚æ•°ï¼ˆjavaè¯­è¨€è§„èŒƒç§°ä¹‹ä¸ºformal method parametersï¼‰å’Œå¼‚å¸¸å¤„ç†å™¨å‚æ•°ï¼ˆexception handler parametersï¼‰ä¸ä¼šåœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ï¼Œå®ƒä»¬ä¸ä¼šæœ‰å†…å­˜å¯è§æ€§é—®é¢˜ï¼Œä¹Ÿä¸å—å†…å­˜æ¨¡å‹çš„å½±å“ã€‚<br>Javaçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ç”±Javaå†…å­˜æ¨¡å‹ï¼ˆæœ¬æ–‡ç®€ç§°ä¸ºJMMï¼‰æ§åˆ¶ï¼ŒJMMå†³å®šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™å…¥ä½•æ—¶å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ã€‚ä»æŠ½è±¡çš„è§’åº¦æ¥çœ‹ï¼ŒJMMå®šä¹‰äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„æŠ½è±¡å…³ç³»ï¼š<strong>çº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å­˜å‚¨åœ¨ä¸»å†…å­˜ï¼ˆmain memoryï¼‰ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜ï¼ˆlocal memoryï¼‰ï¼Œæœ¬åœ°å†…å­˜ä¸­å­˜å‚¨äº†è¯¥çº¿ç¨‹ä»¥è¯»/å†™å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚</strong>æœ¬åœ°å†…å­˜æ˜¯JMMçš„ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œå¹¶ä¸çœŸå®å­˜åœ¨ã€‚å®ƒæ¶µç›–äº†ç¼“å­˜ï¼Œå†™ç¼“å†²åŒºï¼Œå¯„å­˜å™¨ä»¥åŠå…¶ä»–çš„ç¡¬ä»¶å’Œç¼–è¯‘å™¨ä¼˜åŒ–ã€‚Javaå†…å­˜æ¨¡å‹çš„æŠ½è±¡ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="/images/javaè™šæ‹Ÿæœº1-1.png"></p>
<p>ä»ä¸Šå›¾æ¥çœ‹ï¼Œçº¿ç¨‹Aä¸çº¿ç¨‹Bä¹‹é—´å¦‚è¦é€šä¿¡çš„è¯ï¼Œå¿…é¡»è¦ç»å†ä¸‹é¢2ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>é¦–å…ˆï¼Œçº¿ç¨‹AæŠŠæœ¬åœ°å†…å­˜Aä¸­æ›´æ–°è¿‡çš„å…±äº«å˜é‡åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­å»ã€‚</li>
<li>ç„¶åï¼Œçº¿ç¨‹Båˆ°ä¸»å†…å­˜ä¸­å»è¯»å–çº¿ç¨‹Aä¹‹å‰å·²æ›´æ–°è¿‡çš„å…±äº«å˜é‡ã€‚</li>
</ol>
<p>ä¸‹é¢é€šè¿‡ç¤ºæ„å›¾æ¥è¯´æ˜è¿™ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<p><img src="/images/javaè™šæ‹Ÿæœº1-2.png"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæœ¬åœ°å†…å­˜Aå’ŒBæœ‰ä¸»å†…å­˜ä¸­å…±äº«å˜é‡xçš„å‰¯æœ¬ã€‚å‡è®¾åˆå§‹æ—¶ï¼Œè¿™ä¸‰ä¸ªå†…å­˜ä¸­çš„xå€¼éƒ½ä¸º0ã€‚çº¿ç¨‹Aåœ¨æ‰§è¡Œæ—¶ï¼ŒæŠŠæ›´æ–°åçš„xå€¼ï¼ˆå‡è®¾å€¼ä¸º1ï¼‰ä¸´æ—¶å­˜æ”¾åœ¨è‡ªå·±çš„æœ¬åœ°å†…å­˜Aä¸­ã€‚å½“çº¿ç¨‹Aå’Œçº¿ç¨‹Béœ€è¦é€šä¿¡æ—¶ï¼Œçº¿ç¨‹Aé¦–å…ˆä¼šæŠŠè‡ªå·±æœ¬åœ°å†…å­˜ä¸­ä¿®æ”¹åçš„xå€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼Œæ­¤æ—¶ä¸»å†…å­˜ä¸­çš„xå€¼å˜ä¸ºäº†1ã€‚éšåï¼Œçº¿ç¨‹Båˆ°ä¸»å†…å­˜ä¸­å»è¯»å–çº¿ç¨‹Aæ›´æ–°åçš„xå€¼ï¼Œæ­¤æ—¶çº¿ç¨‹Bçš„æœ¬åœ°å†…å­˜çš„xå€¼ä¹Ÿå˜ä¸ºäº†1ã€‚<br>ä»æ•´ä½“æ¥çœ‹ï¼Œè¿™ä¸¤ä¸ªæ­¥éª¤å®è´¨ä¸Šæ˜¯çº¿ç¨‹Aåœ¨å‘çº¿ç¨‹Bå‘é€æ¶ˆæ¯ï¼Œè€Œä¸”è¿™ä¸ªé€šä¿¡è¿‡ç¨‹å¿…é¡»è¦ç»è¿‡ä¸»å†…å­˜ã€‚JMMé€šè¿‡æ§åˆ¶ä¸»å†…å­˜ä¸æ¯ä¸ªçº¿ç¨‹çš„æœ¬åœ°å†…å­˜ä¹‹é—´çš„äº¤äº’ï¼Œæ¥ä¸ºjavaç¨‹åºå‘˜æä¾›å†…å­˜å¯è§æ€§ä¿è¯ã€‚</p>
<a id="more"></a> 
<h3 id="é‡æ’åº"><a href="#é‡æ’åº" class="headerlink" title="é‡æ’åº"></a>é‡æ’åº</h3><p>åœ¨æ‰§è¡Œç¨‹åºæ—¶ä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤åšé‡æ’åºã€‚é‡æ’åºåˆ†ä¸‰ç§ç±»å‹ï¼š</p>
<ol>
<li>ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’åºã€‚ç¼–è¯‘å™¨åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œå¯ä»¥é‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚</li>
<li>æŒ‡ä»¤çº§å¹¶è¡Œçš„é‡æ’åºã€‚ç°ä»£å¤„ç†å™¨é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯ï¼ˆInstruction-Level Parallelismï¼Œ ILPï¼‰æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚</li>
<li>å†…å­˜ç³»ç»Ÿçš„é‡æ’åºã€‚ç”±äºå¤„ç†å™¨ä½¿ç”¨ç¼“å­˜å’Œè¯»/å†™ç¼“å†²åŒºï¼Œè¿™ä½¿å¾—åŠ è½½å’Œå­˜å‚¨æ“ä½œçœ‹ä¸Šå»å¯èƒ½æ˜¯åœ¨ä¹±åºæ‰§è¡Œã€‚<br>ä»javaæºä»£ç åˆ°æœ€ç»ˆå®é™…æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ï¼Œä¼šåˆ†åˆ«ç»å†ä¸‹é¢ä¸‰ç§é‡æ’åºï¼š</li>
</ol>
<p><img src="/images/javaè™šæ‹Ÿæœº1-3.png"></p>
<p>ä¸Šè¿°çš„1å±äºç¼–è¯‘å™¨é‡æ’åºï¼Œ2å’Œ3å±äºå¤„ç†å™¨é‡æ’åºã€‚è¿™äº›é‡æ’åºéƒ½å¯èƒ½ä¼šå¯¼è‡´å¤šçº¿ç¨‹ç¨‹åºå‡ºç°å†…å­˜å¯è§æ€§é—®é¢˜ã€‚å¯¹äºç¼–è¯‘å™¨ï¼ŒJMMçš„ç¼–è¯‘å™¨é‡æ’åºè§„åˆ™ä¼šç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºï¼ˆä¸æ˜¯æ‰€æœ‰çš„ç¼–è¯‘å™¨é‡æ’åºéƒ½è¦ç¦æ­¢ï¼‰ã€‚å¯¹äºå¤„ç†å™¨é‡æ’åºï¼ŒJMMçš„å¤„ç†å™¨é‡æ’åºè§„åˆ™ä¼šè¦æ±‚javaç¼–è¯‘å™¨åœ¨ç”ŸæˆæŒ‡ä»¤åºåˆ—æ—¶ï¼Œæ’å…¥ç‰¹å®šç±»å‹çš„å†…å­˜å±éšœï¼ˆmemory barriersï¼Œintelç§°ä¹‹ä¸ºmemory fenceï¼‰æŒ‡ä»¤ï¼Œé€šè¿‡å†…å­˜å±éšœæŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºï¼ˆä¸æ˜¯æ‰€æœ‰çš„å¤„ç†å™¨é‡æ’åºéƒ½è¦ç¦æ­¢ï¼‰ã€‚<br>JMMå±äºè¯­è¨€çº§çš„å†…å­˜æ¨¡å‹ï¼Œå®ƒç¡®ä¿åœ¨ä¸åŒçš„ç¼–è¯‘å™¨å’Œä¸åŒçš„å¤„ç†å™¨å¹³å°ä¹‹ä¸Šï¼Œé€šè¿‡ç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºå’Œå¤„ç†å™¨é‡æ’åºï¼Œä¸ºç¨‹åºå‘˜æä¾›ä¸€è‡´çš„å†…å­˜å¯è§æ€§ä¿è¯ã€‚</p>
<h3 id="å¤„ç†å™¨é‡æ’åºä¸å†…å­˜å±éšœæŒ‡ä»¤"><a href="#å¤„ç†å™¨é‡æ’åºä¸å†…å­˜å±éšœæŒ‡ä»¤" class="headerlink" title="å¤„ç†å™¨é‡æ’åºä¸å†…å­˜å±éšœæŒ‡ä»¤"></a>å¤„ç†å™¨é‡æ’åºä¸å†…å­˜å±éšœæŒ‡ä»¤</h3><p>ç°ä»£çš„å¤„ç†å™¨ä½¿ç”¨å†™ç¼“å†²åŒºæ¥ä¸´æ—¶ä¿å­˜å‘å†…å­˜å†™å…¥çš„æ•°æ®ã€‚å†™ç¼“å†²åŒºå¯ä»¥ä¿è¯æŒ‡ä»¤æµæ°´çº¿æŒç»­è¿è¡Œï¼Œå®ƒå¯ä»¥é¿å…ç”±äºå¤„ç†å™¨åœé¡¿ä¸‹æ¥ç­‰å¾…å‘å†…å­˜å†™å…¥æ•°æ®è€Œäº§ç”Ÿçš„å»¶è¿Ÿã€‚åŒæ—¶ï¼Œé€šè¿‡ä»¥æ‰¹å¤„ç†çš„æ–¹å¼åˆ·æ–°å†™ç¼“å†²åŒºï¼Œä»¥åŠåˆå¹¶å†™ç¼“å†²åŒºä¸­å¯¹åŒä¸€å†…å­˜åœ°å€çš„å¤šæ¬¡å†™ï¼Œå¯ä»¥å‡å°‘å¯¹å†…å­˜æ€»çº¿çš„å ç”¨ã€‚è™½ç„¶å†™ç¼“å†²åŒºæœ‰è¿™ä¹ˆå¤šå¥½å¤„ï¼Œä½†æ¯ä¸ªå¤„ç†å™¨ä¸Šçš„å†™ç¼“å†²åŒºï¼Œä»…ä»…å¯¹å®ƒæ‰€åœ¨çš„å¤„ç†å™¨å¯è§ã€‚è¿™ä¸ªç‰¹æ€§ä¼šå¯¹å†…å­˜æ“ä½œçš„æ‰§è¡Œé¡ºåºäº§ç”Ÿé‡è¦çš„å½±å“ï¼šå¤„ç†å™¨å¯¹å†…å­˜çš„è¯»/å†™æ“ä½œçš„æ‰§è¡Œé¡ºåºï¼Œä¸ä¸€å®šä¸å†…å­˜å®é™…å‘ç”Ÿçš„è¯»/å†™æ“ä½œé¡ºåºä¸€è‡´ï¼ä¸ºäº†å…·ä½“è¯´æ˜ï¼Œè¯·çœ‹ä¸‹é¢ç¤ºä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Processor A</div><div class="line"></div><div class="line">a = 1; //A1</div><div class="line">x = b; //A2</div><div class="line"></div><div class="line">Processor B</div><div class="line"></div><div class="line">b = 2; //B1</div><div class="line">y = a; //B2</div><div class="line"></div><div class="line">åˆå§‹çŠ¶æ€ï¼ša = b = 0</div><div class="line">å¤„ç†å™¨å…è®¸æ‰§è¡Œåå¾—åˆ°ç»“æœï¼šx = y = 0</div></pre></td></tr></table></figure>
<p>å‡è®¾å¤„ç†å™¨Aå’Œå¤„ç†å™¨BæŒ‰ç¨‹åºçš„é¡ºåºå¹¶è¡Œæ‰§è¡Œå†…å­˜è®¿é—®ï¼Œæœ€ç»ˆå´å¯èƒ½å¾—åˆ°x = y = 0çš„ç»“æœã€‚å…·ä½“çš„åŸå› å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/images/Javaè™šæ‹Ÿæœº1-4.png"></p>
<p>è¿™é‡Œå¤„ç†å™¨Aå’Œå¤„ç†å™¨Bå¯ä»¥åŒæ—¶æŠŠå…±äº«å˜é‡å†™å…¥è‡ªå·±çš„å†™ç¼“å†²åŒºï¼ˆA1ï¼ŒB1ï¼‰ï¼Œç„¶åä»å†…å­˜ä¸­è¯»å–å¦ä¸€ä¸ªå…±äº«å˜é‡ï¼ˆA2ï¼ŒB2ï¼‰ï¼Œæœ€åæ‰æŠŠè‡ªå·±å†™ç¼“å­˜åŒºä¸­ä¿å­˜çš„è„æ•°æ®åˆ·æ–°åˆ°å†…å­˜ä¸­ï¼ˆA3ï¼ŒB3ï¼‰ã€‚å½“ä»¥è¿™ç§æ—¶åºæ‰§è¡Œæ—¶ï¼Œç¨‹åºå°±å¯ä»¥å¾—åˆ°x = y = 0çš„ç»“æœã€‚<br>ä»å†…å­˜æ“ä½œå®é™…å‘ç”Ÿçš„é¡ºåºæ¥çœ‹ï¼Œç›´åˆ°å¤„ç†å™¨Aæ‰§è¡ŒA3æ¥åˆ·æ–°è‡ªå·±çš„å†™ç¼“å­˜åŒºï¼Œå†™æ“ä½œA1æ‰ç®—çœŸæ­£æ‰§è¡Œäº†ã€‚è™½ç„¶å¤„ç†å™¨Aæ‰§è¡Œå†…å­˜æ“ä½œçš„é¡ºåºä¸ºï¼šA1-&gt;A2ï¼Œä½†å†…å­˜æ“ä½œå®é™…å‘ç”Ÿçš„é¡ºåºå´æ˜¯ï¼šA2-&gt;A1ã€‚æ­¤æ—¶ï¼Œå¤„ç†å™¨Açš„å†…å­˜æ“ä½œé¡ºåºè¢«é‡æ’åºäº†ï¼ˆå¤„ç†å™¨Bçš„æƒ…å†µå’Œå¤„ç†å™¨Aä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼‰ã€‚<br>è¿™é‡Œçš„å…³é”®æ˜¯ï¼Œç”±äºå†™ç¼“å†²åŒºä»…å¯¹è‡ªå·±çš„å¤„ç†å™¨å¯è§ï¼Œå®ƒä¼šå¯¼è‡´å¤„ç†å™¨æ‰§è¡Œå†…å­˜æ“ä½œçš„é¡ºåºå¯èƒ½ä¼šä¸å†…å­˜å®é™…çš„æ“ä½œæ‰§è¡Œé¡ºåºä¸ä¸€è‡´ã€‚ç”±äºç°ä»£çš„å¤„ç†å™¨éƒ½ä¼šä½¿ç”¨å†™ç¼“å†²åŒºï¼Œå› æ­¤ç°ä»£çš„å¤„ç†å™¨éƒ½ä¼šå…è®¸å¯¹å†™-è¯»æ“ä½œé‡æ’åºã€‚</p>
<p><strong>ä¸ºäº†ä¿è¯å†…å­˜å¯è§æ€§ï¼Œjavaç¼–è¯‘å™¨åœ¨ç”ŸæˆæŒ‡ä»¤åºåˆ—çš„é€‚å½“ä½ç½®ä¼šæ’å…¥å†…å­˜å±éšœæŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚</strong>JMMæŠŠå†…å­˜å±éšœæŒ‡ä»¤åˆ†ä¸ºä¸‹åˆ—å››ç±»ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">å±éšœç±»å‹</th>
<th style="text-align:center">æŒ‡ä»¤ç¤ºä¾‹</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">LoadLoad Barriers</td>
<td style="text-align:center">Load1; LoadLoad; Load2</td>
<td style="text-align:center">ç¡®ä¿Load1æ•°æ®çš„è£…è½½ï¼Œä¹‹å‰äºLoad2åŠæ‰€æœ‰åç»­è£…è½½æŒ‡ä»¤çš„è£…è½½ã€‚</td>
</tr>
<tr>
<td style="text-align:center">StoreStore Barriers</td>
<td style="text-align:center">Store1; StoreStore; Store2</td>
<td style="text-align:center">ç¡®ä¿Store1æ•°æ®å¯¹å…¶ä»–å¤„ç†å™¨å¯è§ï¼ˆåˆ·æ–°åˆ°å†…å­˜ï¼‰ï¼Œä¹‹å‰äºStore2åŠæ‰€æœ‰åç»­å­˜å‚¨æŒ‡ä»¤çš„å­˜å‚¨ã€‚</td>
</tr>
<tr>
<td style="text-align:center">LoadStore Barriers</td>
<td style="text-align:center">Load1; LoadStore; Store2</td>
<td style="text-align:center">ç¡®ä¿Load1æ•°æ®è£…è½½ï¼Œä¹‹å‰äºStore2åŠæ‰€æœ‰åç»­çš„å­˜å‚¨æŒ‡ä»¤åˆ·æ–°åˆ°å†…å­˜ã€‚</td>
</tr>
<tr>
<td style="text-align:center">StoreLoad Barriers</td>
<td style="text-align:center">Store1; StoreLoad; Load2</td>
<td style="text-align:center">ç¡®ä¿Store1æ•°æ®å¯¹å…¶ä»–å¤„ç†å™¨å˜å¾—å¯è§ï¼ˆæŒ‡åˆ·æ–°åˆ°å†…å­˜ï¼‰ï¼Œä¹‹å‰äºLoad2åŠæ‰€æœ‰åç»­è£…è½½æŒ‡ä»¤çš„è£…è½½ã€‚StoreLoad Barriersä¼šä½¿è¯¥å±éšœä¹‹å‰çš„æ‰€æœ‰å†…å­˜è®¿é—®æŒ‡ä»¤ï¼ˆå­˜å‚¨å’Œè£…è½½æŒ‡ä»¤ï¼‰å®Œæˆä¹‹åï¼Œæ‰æ‰§è¡Œè¯¥å±éšœä¹‹åçš„å†…å­˜è®¿é—®æŒ‡ä»¤ã€‚</td>
</tr>
</tbody>
</table>
<p>StoreLoad Barriersæ˜¯ä¸€ä¸ªâ€œå…¨èƒ½å‹â€çš„å±éšœï¼Œå®ƒåŒæ—¶å…·æœ‰å…¶ä»–ä¸‰ä¸ªå±éšœçš„æ•ˆæœã€‚ç°ä»£çš„å¤šå¤„ç†å™¨å¤§éƒ½æ”¯æŒè¯¥å±éšœï¼ˆå…¶ä»–ç±»å‹çš„å±éšœä¸ä¸€å®šè¢«æ‰€æœ‰å¤„ç†å™¨æ”¯æŒï¼‰ã€‚æ‰§è¡Œè¯¥å±éšœå¼€é”€ä¼šå¾ˆæ˜‚è´µï¼Œå› ä¸ºå½“å‰å¤„ç†å™¨é€šå¸¸è¦æŠŠå†™ç¼“å†²åŒºä¸­çš„æ•°æ®å…¨éƒ¨åˆ·æ–°åˆ°å†…å­˜ä¸­ï¼ˆbuffer fully flushï¼‰ã€‚</p>
<h3 id="happens-before"><a href="#happens-before" class="headerlink" title="happens-before"></a>happens-before</h3><p>ä»JDK5å¼€å§‹ï¼Œjavaä½¿ç”¨æ–°çš„JSR -133å†…å­˜æ¨¡å‹ï¼ˆæœ¬æ–‡é™¤éç‰¹åˆ«è¯´æ˜ï¼Œé’ˆå¯¹çš„éƒ½æ˜¯JSR- 133å†…å­˜æ¨¡å‹ï¼‰ã€‚JSR-133ä½¿ç”¨happens-beforeçš„æ¦‚å¿µæ¥é˜è¿°æ“ä½œä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚<strong>åœ¨JMMä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œæ‰§è¡Œçš„ç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å¿…é¡»è¦å­˜åœ¨happens-beforeå…³ç³»ã€‚</strong>è¿™é‡Œæåˆ°çš„ä¸¤ä¸ªæ“ä½œæ—¢å¯ä»¥æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¹‹å†…ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨ä¸åŒçº¿ç¨‹ä¹‹é—´ã€‚<br>ä¸ç¨‹åºå‘˜å¯†åˆ‡ç›¸å…³çš„happens-beforeè§„åˆ™å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens- before äºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚</p>
</li>
<li><p>ç›‘è§†å™¨é”è§„åˆ™ï¼šå¯¹ä¸€ä¸ªç›‘è§†å™¨é”çš„è§£é”ï¼Œhappens- before äºéšåå¯¹è¿™ä¸ªç›‘è§†å™¨é”çš„åŠ é”ã€‚</p>
</li>
<li><p>volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileåŸŸçš„å†™ï¼Œhappens- before äºä»»æ„åç»­å¯¹è¿™ä¸ªvolatileåŸŸçš„è¯»ã€‚</p>
</li>
<li><p>ä¼ é€’æ€§ï¼šå¦‚æœA happens- before Bï¼Œä¸”B happens- before Cï¼Œé‚£ä¹ˆA happens- before Cã€‚</p>
</li>
</ul>
<p><strong>æ³¨æ„ï¼Œä¸¤ä¸ªæ“ä½œä¹‹é—´å…·æœ‰happens-beforeå…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€å‰ä¸€ä¸ªæ“ä½œå¿…é¡»è¦åœ¨åä¸€ä¸ªæ“ä½œä¹‹å‰æ‰§è¡Œï¼happens-beforeä»…ä»…è¦æ±‚å‰ä¸€ä¸ªæ“ä½œï¼ˆæ‰§è¡Œçš„ç»“æœï¼‰å¯¹åä¸€ä¸ªæ“ä½œå¯è§ï¼Œä¸”å‰ä¸€ä¸ªæ“ä½œæŒ‰é¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ï¼ˆthe first is visible to and ordered before the secondï¼‰ã€‚</strong></p>
<p>happens-beforeä¸JMMçš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/images/Javaè™šæ‹Ÿæœº1-5.png"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸€ä¸ªhappens-beforeè§„åˆ™é€šå¸¸å¯¹åº”äºå¤šä¸ªç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡æ’åºè§„åˆ™ã€‚å¯¹äºjavaç¨‹åºå‘˜æ¥è¯´ï¼Œhappens-beforeè§„åˆ™ç®€å•æ˜“æ‡‚ï¼Œå®ƒé¿å…javaç¨‹åºå‘˜ä¸ºäº†ç†è§£JMMæä¾›çš„å†…å­˜å¯è§æ€§ä¿è¯è€Œå»å­¦ä¹ å¤æ‚çš„é‡æ’åºè§„åˆ™ä»¥åŠè¿™äº›è§„åˆ™çš„å…·ä½“å®ç°ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ClassLoader]]></title>
      <url>http://zsr.github.io/2016/08/05/ClassLoader/</url>
      <content type="html"><![CDATA[<h1 id="Java-ç±»åŠ è½½å™¨"><a href="#Java-ç±»åŠ è½½å™¨" class="headerlink" title="Java ç±»åŠ è½½å™¨"></a>Java ç±»åŠ è½½å™¨</h1><hr>
<h3 id="ç±»åŠ è½½å™¨åŸºæœ¬æ¦‚å¿µ"><a href="#ç±»åŠ è½½å™¨åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="ç±»åŠ è½½å™¨åŸºæœ¬æ¦‚å¿µ"></a>ç±»åŠ è½½å™¨åŸºæœ¬æ¦‚å¿µ</h3><p><strong>ç±»åŠ è½½å™¨ï¼ˆclass loaderï¼‰ç”¨æ¥åŠ è½½ Java ç±»åˆ° Java è™šæ‹Ÿæœºä¸­ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒJava è™šæ‹Ÿæœºä½¿ç”¨ Java ç±»çš„æ–¹å¼å¦‚ä¸‹ï¼šJava æºç¨‹åºï¼ˆ.java æ–‡ä»¶ï¼‰åœ¨ç»è¿‡ Java ç¼–è¯‘å™¨ç¼–è¯‘ä¹‹åå°±è¢«è½¬æ¢æˆ Java å­—èŠ‚ä»£ç ï¼ˆ.class æ–‡ä»¶ï¼‰ã€‚ç±»åŠ è½½å™¨è´Ÿè´£è¯»å– Java å­—èŠ‚ä»£ç ï¼Œå¹¶è½¬æ¢æˆ java.lang.Classç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚æ¯ä¸ªè¿™æ ·çš„å®ä¾‹ç”¨æ¥è¡¨ç¤ºä¸€ä¸ª Java ç±»ã€‚é€šè¿‡æ­¤å®ä¾‹çš„ newInstance()æ–¹æ³•å°±å¯ä»¥åˆ›å»ºå‡ºè¯¥ç±»çš„ä¸€ä¸ªå¯¹è±¡ã€‚å®é™…çš„æƒ…å†µå¯èƒ½æ›´åŠ å¤æ‚ï¼Œæ¯”å¦‚ Java å­—èŠ‚ä»£ç å¯èƒ½æ˜¯é€šè¿‡å·¥å…·åŠ¨æ€ç”Ÿæˆçš„ï¼Œä¹Ÿå¯èƒ½æ˜¯é€šè¿‡ç½‘ç»œä¸‹è½½çš„ã€‚</strong></p>
<h3 id="java-lang-ClassLoaderç±»ä»‹ç»"><a href="#java-lang-ClassLoaderç±»ä»‹ç»" class="headerlink" title="java.lang.ClassLoaderç±»ä»‹ç»"></a>java.lang.ClassLoaderç±»ä»‹ç»</h3><p>java.lang.ClassLoaderç±»çš„åŸºæœ¬èŒè´£å°±æ˜¯æ ¹æ®ä¸€ä¸ªæŒ‡å®šçš„ç±»çš„åç§°ï¼Œæ‰¾åˆ°æˆ–è€…ç”Ÿæˆå…¶å¯¹åº”çš„å­—èŠ‚ä»£ç ï¼Œç„¶åä»è¿™äº›å­—èŠ‚ä»£ç ä¸­å®šä¹‰å‡ºä¸€ä¸ª Java ç±»ï¼Œå³ java.lang.Classç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒClassLoaderè¿˜è´Ÿè´£åŠ è½½ Java åº”ç”¨æ‰€éœ€çš„èµ„æºï¼Œå¦‚å›¾åƒæ–‡ä»¶å’Œé…ç½®æ–‡ä»¶ç­‰ã€‚ä¸ºäº†å®ŒæˆåŠ è½½ç±»çš„è¿™ä¸ªèŒè´£ï¼ŒClassLoaderæä¾›äº†ä¸€ç³»åˆ—çš„æ–¹æ³•ï¼Œæ¯”è¾ƒé‡è¦çš„æ–¹æ³•å¦‚è¡¨ 1æ‰€ç¤ºã€‚</p>
<h5 id="è¡¨-1-ClassLoader-ä¸­ä¸åŠ è½½ç±»ç›¸å…³çš„æ–¹æ³•"><a href="#è¡¨-1-ClassLoader-ä¸­ä¸åŠ è½½ç±»ç›¸å…³çš„æ–¹æ³•" class="headerlink" title="è¡¨ 1. ClassLoader ä¸­ä¸åŠ è½½ç±»ç›¸å…³çš„æ–¹æ³•"></a>è¡¨ 1. ClassLoader ä¸­ä¸åŠ è½½ç±»ç›¸å…³çš„æ–¹æ³•</h5><table>
<thead>
<tr>
<th style="text-align:center">æ–¹æ³•</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">getParent()</td>
<td style="text-align:center">è¿”å›è¯¥ç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨</td>
</tr>
<tr>
<td style="text-align:center">loadClass(String name)</td>
<td style="text-align:center">åŠ è½½åç§°ä¸º nameçš„ç±»ï¼Œè¿”å›çš„ç»“æœæ˜¯ java.lang.Classç±»çš„å®ä¾‹</td>
</tr>
<tr>
<td style="text-align:center">findClass(String name)</td>
<td style="text-align:center">æŸ¥æ‰¾åç§°ä¸º nameçš„ç±»ï¼Œè¿”å›çš„ç»“æœæ˜¯ java.lang.Classç±»çš„å®ä¾‹</td>
</tr>
<tr>
<td style="text-align:center">findLoadedClass(String name)</td>
<td style="text-align:center">æŸ¥æ‰¾åç§°ä¸º nameçš„å·²ç»è¢«åŠ è½½è¿‡çš„ç±»ï¼Œè¿”å›çš„ç»“æœæ˜¯java.lang.Classç±»çš„å®ä¾‹ã€‚</td>
</tr>
<tr>
<td style="text-align:center">defineClass(String name, byte[] b, int off, int len)</td>
<td style="text-align:center">æŠŠå­—èŠ‚æ•°ç»„ bä¸­çš„å†…å®¹è½¬æ¢æˆ Java ç±»ï¼Œè¿”å›çš„ç»“æœæ˜¯ java.lang.Classç±»çš„å®ä¾‹ã€‚è¿™ä¸ªæ–¹æ³•è¢«å£°æ˜ä¸º finalçš„</td>
</tr>
<tr>
<td style="text-align:center">resolveClass(Class&lt;?&gt; c)</td>
<td style="text-align:center">é“¾æ¥æŒ‡å®šçš„ Java ç±»</td>
</tr>
</tbody>
</table>
<p>ç±»åŠ è½½å™¨çš„æ ‘çŠ¶ç»„ç»‡ç»“æ„<br>Java ä¸­çš„ç±»åŠ è½½å™¨å¤§è‡´å¯ä»¥åˆ†æˆä¸¤ç±»ï¼Œä¸€ç±»æ˜¯ç³»ç»Ÿæä¾›çš„ï¼Œå¦å¤–ä¸€ç±»åˆ™æ˜¯ç”± Java åº”ç”¨å¼€å‘äººå‘˜ç¼–å†™çš„ã€‚ç³»ç»Ÿæä¾›çš„ç±»åŠ è½½å™¨ä¸»è¦æœ‰ä¸‹é¢ä¸‰ä¸ªï¼š</p>
<ul>
<li><p>å¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆbootstrap class loaderï¼‰ï¼šå®ƒç”¨æ¥åŠ è½½ Java çš„æ ¸å¿ƒåº“ï¼Œæ˜¯ç”¨åŸç”Ÿä»£ç æ¥å®ç°çš„ï¼Œå¹¶ä¸ç»§æ‰¿è‡ª java.lang.ClassLoaderã€‚</p>
</li>
<li><p>æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆextensions class loaderï¼‰ï¼šå®ƒç”¨æ¥åŠ è½½ Java çš„æ‰©å±•åº“ã€‚Java è™šæ‹Ÿæœºçš„å®ç°ä¼šæä¾›ä¸€ä¸ªæ‰©å±•åº“ç›®å½•ã€‚è¯¥ç±»åŠ è½½å™¨åœ¨æ­¤ç›®å½•é‡Œé¢æŸ¥æ‰¾å¹¶åŠ è½½ Java ç±»ã€‚</p>
</li>
<li><p>ç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆsystem class loaderï¼‰ï¼šå®ƒæ ¹æ® Java åº”ç”¨çš„ç±»è·¯å¾„ï¼ˆCLASSPATHï¼‰æ¥åŠ è½½ Java ç±»ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒJava åº”ç”¨çš„ç±»éƒ½æ˜¯ç”±å®ƒæ¥å®ŒæˆåŠ è½½çš„ã€‚å¯ä»¥é€šè¿‡ ClassLoader.getSystemClassLoader()æ¥è·å–å®ƒã€‚</p>
</li>
</ul>
<p>é™¤äº†ç³»ç»Ÿæä¾›çš„ç±»åŠ è½½å™¨ä»¥å¤–ï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡ç»§æ‰¿ java.lang.ClassLoaderç±»çš„æ–¹å¼å®ç°è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä»¥æ»¡è¶³ä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚(å¦‚tomcat)ã€‚<br>é™¤äº†å¼•å¯¼ç±»åŠ è½½å™¨ä¹‹å¤–ï¼Œæ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½æœ‰ä¸€ä¸ªçˆ¶ç±»åŠ è½½å™¨ã€‚é€šè¿‡ è¡¨ 1ä¸­ç»™å‡ºçš„ getParent()æ–¹æ³•å¯ä»¥å¾—åˆ°ã€‚å¯¹äºç³»ç»Ÿæä¾›çš„ç±»åŠ è½½å™¨æ¥è¯´ï¼Œç³»ç»Ÿç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨æ˜¯æ‰©å±•ç±»åŠ è½½å™¨ï¼Œè€Œæ‰©å±•ç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨æ˜¯å¼•å¯¼ç±»åŠ è½½å™¨ï¼›å¯¹äºå¼€å‘äººå‘˜ç¼–å†™çš„ç±»åŠ è½½å™¨æ¥è¯´ï¼Œå…¶çˆ¶ç±»åŠ è½½å™¨æ˜¯åŠ è½½æ­¤ç±»åŠ è½½å™¨ Java ç±»çš„ç±»åŠ è½½å™¨ã€‚å› ä¸ºç±»åŠ è½½å™¨ Java ç±»å¦‚åŒå…¶å®ƒçš„ Java ç±»ä¸€æ ·ï¼Œä¹Ÿæ˜¯è¦ç”±ç±»åŠ è½½å™¨æ¥åŠ è½½çš„ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¼€å‘äººå‘˜ç¼–å†™çš„ç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚ç±»åŠ è½½å™¨é€šè¿‡è¿™ç§æ–¹å¼ç»„ç»‡èµ·æ¥ï¼Œå½¢æˆæ ‘çŠ¶ç»“æ„ã€‚æ ‘çš„æ ¹èŠ‚ç‚¹å°±æ˜¯å¼•å¯¼ç±»åŠ è½½å™¨ã€‚å›¾ 1ä¸­ç»™å‡ºäº†ä¸€ä¸ªå…¸å‹çš„ç±»åŠ è½½å™¨æ ‘çŠ¶ç»„ç»‡ç»“æ„ç¤ºæ„å›¾ï¼Œå…¶ä¸­çš„ç®­å¤´æŒ‡å‘çš„æ˜¯çˆ¶ç±»åŠ è½½å™¨ã€‚</p>
<a id="more"></a>
<h5 id="å›¾-1-ç±»åŠ è½½å™¨æ ‘çŠ¶ç»„ç»‡ç»“æ„ç¤ºæ„å›¾"><a href="#å›¾-1-ç±»åŠ è½½å™¨æ ‘çŠ¶ç»„ç»‡ç»“æ„ç¤ºæ„å›¾" class="headerlink" title="å›¾ 1. ç±»åŠ è½½å™¨æ ‘çŠ¶ç»„ç»‡ç»“æ„ç¤ºæ„å›¾"></a>å›¾ 1. ç±»åŠ è½½å™¨æ ‘çŠ¶ç»„ç»‡ç»“æ„ç¤ºæ„å›¾</h5><p><img src="/images/ClassLoader_1.jpg"></p>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public class ClassLoaderTree &#123; </div><div class="line"></div><div class="line">    public static void main(String[] args) &#123; </div><div class="line">        ClassLoader loader = ClassLoaderTree.class.getClassLoader(); </div><div class="line">        while (loader != null) &#123; </div><div class="line">            System.out.println(loader.toString()); </div><div class="line">            loader = loader.getParent(); </div><div class="line">        &#125; </div><div class="line">    &#125; </div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>æ¯ä¸ª Java ç±»éƒ½ç»´æŠ¤ç€ä¸€ä¸ªæŒ‡å‘å®šä¹‰å®ƒçš„ç±»åŠ è½½å™¨çš„å¼•ç”¨ï¼Œé€šè¿‡ getClassLoader()æ–¹æ³•å°±å¯ä»¥è·å–åˆ°æ­¤å¼•ç”¨ã€‚</p>
<p><strong>è¿è¡Œç»“æœï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sun.misc.Launcher$AppClassLoader@9304b1</div><div class="line"></div><div class="line">sun.misc.Launcher$ExtClassLoader@190d11</div></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ä¸ªè¾“å‡ºçš„æ˜¯ ClassLoaderTreeç±»çš„ç±»åŠ è½½å™¨ï¼Œå³ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚å®ƒæ˜¯ sun.misc.Launcher$AppClassLoaderç±»çš„å®ä¾‹ï¼›ç¬¬äºŒä¸ªè¾“å‡ºçš„æ˜¯æ‰©å±•ç±»åŠ è½½å™¨ï¼Œæ˜¯ sun.misc.Launcher$ExtClassLoaderç±»çš„å®ä¾‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰è¾“å‡ºå¼•å¯¼ç±»åŠ è½½å™¨ï¼Œè¿™æ˜¯ç”±äºæœ‰äº› JDK çš„å®ç°å¯¹äºçˆ¶ç±»åŠ è½½å™¨æ˜¯å¼•å¯¼ç±»åŠ è½½å™¨çš„æƒ…å†µï¼ŒgetParent()æ–¹æ³•è¿”å› nullã€‚</p>
<h3 id="ç±»åŠ è½½å™¨çš„ä»£ç†æ¨¡å¼"><a href="#ç±»åŠ è½½å™¨çš„ä»£ç†æ¨¡å¼" class="headerlink" title="ç±»åŠ è½½å™¨çš„ä»£ç†æ¨¡å¼"></a>ç±»åŠ è½½å™¨çš„ä»£ç†æ¨¡å¼</h3><p><strong>ç±»åŠ è½½å™¨åœ¨å°è¯•è‡ªå·±å»æŸ¥æ‰¾æŸä¸ªç±»çš„å­—èŠ‚ä»£ç å¹¶å®šä¹‰å®ƒæ—¶ï¼Œä¼šå…ˆä»£ç†ç»™å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œç”±çˆ¶ç±»åŠ è½½å™¨å…ˆå»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œä¾æ¬¡ç±»æ¨ã€‚åœ¨ä»‹ç»ä»£ç†æ¨¡å¼èƒŒåçš„åŠ¨æœºä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦è¯´æ˜ä¸€ä¸‹ Java è™šæ‹Ÿæœºæ˜¯å¦‚ä½•åˆ¤å®šä¸¤ä¸ª Java ç±»æ˜¯ç›¸åŒçš„ã€‚Java è™šæ‹Ÿæœºä¸ä»…è¦çœ‹ç±»çš„å…¨åæ˜¯å¦ç›¸åŒï¼Œè¿˜è¦çœ‹åŠ è½½æ­¤ç±»çš„ç±»åŠ è½½å™¨æ˜¯å¦ä¸€æ ·ã€‚åªæœ‰ä¸¤è€…éƒ½ç›¸åŒçš„æƒ…å†µï¼Œæ‰è®¤ä¸ºä¸¤ä¸ªç±»æ˜¯ç›¸åŒçš„ã€‚å³ä¾¿æ˜¯åŒæ ·çš„å­—èŠ‚ä»£ç ï¼Œè¢«ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½ä¹‹åæ‰€å¾—åˆ°çš„ç±»ï¼Œä¹Ÿæ˜¯ä¸åŒçš„ã€‚æ¯”å¦‚ä¸€ä¸ª Java ç±» com.example.Sampleï¼Œç¼–è¯‘ä¹‹åç”Ÿæˆäº†å­—èŠ‚ä»£ç æ–‡ä»¶ Sample.classã€‚ä¸¤ä¸ªä¸åŒçš„ç±»åŠ è½½å™¨ ClassLoaderAå’Œ ClassLoaderBåˆ†åˆ«è¯»å–äº†è¿™ä¸ª Sample.classæ–‡ä»¶ï¼Œå¹¶å®šä¹‰å‡ºä¸¤ä¸ª java.lang.Classç±»çš„å®ä¾‹æ¥è¡¨ç¤ºè¿™ä¸ªç±»ã€‚è¿™ä¸¤ä¸ªå®ä¾‹æ˜¯ä¸ç›¸åŒçš„ã€‚å¯¹äº Java è™šæ‹Ÿæœºæ¥è¯´ï¼Œå®ƒä»¬æ˜¯ä¸åŒçš„ç±»ã€‚è¯•å›¾å¯¹è¿™ä¸¤ä¸ªç±»çš„å¯¹è±¡è¿›è¡Œç›¸äº’èµ‹å€¼ï¼Œä¼šæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ ClassCastExceptionã€‚</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">package com.example; </div><div class="line"></div><div class="line"> public class Sample &#123; </div><div class="line">    private Sample instance; </div><div class="line"></div><div class="line">    public void setSample(Object instance) &#123; </div><div class="line">        this.instance = (Sample) instance; </div><div class="line">    &#125; </div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>com.example.Sampleç±»çš„æ–¹æ³• setSampleæ¥å—ä¸€ä¸ª java.lang.Objectç±»å‹çš„å‚æ•°ï¼Œå¹¶ä¸”ä¼šæŠŠè¯¥å‚æ•°å¼ºåˆ¶è½¬æ¢æˆ com.example.Sampleç±»å‹ã€‚</p>
<p><strong>æµ‹è¯•javaç±»ï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public void testClassIdentity() &#123; </div><div class="line">    String classDataRootPath = &quot;C:\\workspace\\Classloader\\classData&quot;; </div><div class="line">    FileSystemClassLoader fscl1 = new FileSystemClassLoader(classDataRootPath); </div><div class="line">    FileSystemClassLoader fscl2 = new FileSystemClassLoader(classDataRootPath); </div><div class="line">    String className = &quot;com.example.Sample&quot;; 	</div><div class="line">    try &#123; </div><div class="line">        Class&lt;?&gt; class1 = fscl1.loadClass(className); </div><div class="line">        Object obj1 = class1.newInstance(); </div><div class="line">        Class&lt;?&gt; class2 = fscl2.loadClass(className); </div><div class="line">        Object obj2 = class2.newInstance(); </div><div class="line">        Method setSampleMethod = class1.getMethod(&quot;setSample&quot;, java.lang.Object.class); </div><div class="line">        setSampleMethod.invoke(obj1, obj2); </div><div class="line">    &#125; catch (Exception e) &#123; </div><div class="line">        e.printStackTrace(); </div><div class="line">    &#125; </div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>ç”¨äº†ç±» FileSystemClassLoaderçš„ä¸¤ä¸ªä¸åŒå®ä¾‹æ¥åˆ†åˆ«åŠ è½½ç±» com.example.Sampleï¼Œå¾—åˆ°äº†ä¸¤ä¸ªä¸åŒçš„ java.lang.Classçš„å®ä¾‹ï¼Œæ¥ç€é€šè¿‡ newInstance()æ–¹æ³•åˆ†åˆ«ç”Ÿæˆäº†ä¸¤ä¸ªç±»çš„å¯¹è±¡obj1å’Œobj2ï¼Œæœ€åé€šè¿‡ Javaçš„åå°„APIåœ¨å¯¹è±¡obj1ä¸Šè°ƒç”¨æ–¹æ³•setSampleï¼Œè¯•å›¾æŠŠå¯¹è±¡obj2èµ‹å€¼ç»™obj1å†…éƒ¨çš„instanceå¯¹è±¡ã€‚</p>
<p><strong>è¿è¡Œç»“æœï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">java.lang.reflect.InvocationTargetException </div><div class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) </div><div class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39) </div><div class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)</div><div class="line">at java.lang.reflect.Method.invoke(Method.java:597) </div><div class="line">at classloader.ClassIdentity.testClassIdentity(ClassIdentity.java:26) </div><div class="line">at classloader.ClassIdentity.main(ClassIdentity.java:9) </div><div class="line">Caused by: java.lang.ClassCastException: com.example.Sample </div><div class="line">cannot be cast to com.example.Sample </div><div class="line">at com.example.Sample.setSample(Sample.java:7) </div><div class="line">... 6 more</div></pre></td></tr></table></figure>
<p>ä»è¿è¡Œç»“æœå¯ä»¥çœ‹åˆ°ï¼Œè¿è¡Œæ—¶æŠ›å‡ºäº† java.lang.ClassCastExceptionå¼‚å¸¸ã€‚è™½ç„¶ä¸¤ä¸ªå¯¹è±¡ obj1å’Œ obj2çš„ç±»çš„åå­—ç›¸åŒï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªç±»æ˜¯ç”±ä¸åŒçš„ç±»åŠ è½½å™¨å®ä¾‹æ¥åŠ è½½çš„ï¼Œå› æ­¤ä¸è¢« Java è™šæ‹Ÿæœºè®¤ä¸ºæ˜¯ç›¸åŒçš„ã€‚</p>
<p>äº†è§£äº†è¿™ä¸€ç‚¹ä¹‹åï¼Œå°±å¯ä»¥ç†è§£ä»£ç†æ¨¡å¼çš„è®¾è®¡åŠ¨æœºäº†ã€‚ä»£ç†æ¨¡å¼æ˜¯ä¸ºäº†ä¿è¯ Java æ ¸å¿ƒåº“çš„ç±»å‹å®‰å…¨ã€‚æ‰€æœ‰ Java åº”ç”¨éƒ½è‡³å°‘éœ€è¦å¼•ç”¨ java.lang.Objectç±»ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¿è¡Œçš„æ—¶å€™ï¼Œjava.lang.Objectè¿™ä¸ªç±»éœ€è¦è¢«åŠ è½½åˆ° Java è™šæ‹Ÿæœºä¸­ã€‚å¦‚æœè¿™ä¸ªåŠ è½½è¿‡ç¨‹ç”± Java åº”ç”¨è‡ªå·±çš„ç±»åŠ è½½å™¨æ¥å®Œæˆçš„è¯ï¼Œå¾ˆå¯èƒ½å°±å­˜åœ¨å¤šä¸ªç‰ˆæœ¬çš„ java.lang.Objectç±»ï¼Œè€Œä¸”è¿™äº›ç±»ä¹‹é—´æ˜¯ä¸å…¼å®¹çš„ã€‚é€šè¿‡ä»£ç†æ¨¡å¼ï¼Œå¯¹äº Java æ ¸å¿ƒåº“çš„ç±»çš„åŠ è½½å·¥ä½œç”±å¼•å¯¼ç±»åŠ è½½å™¨æ¥ç»Ÿä¸€å®Œæˆï¼Œä¿è¯äº† Java åº”ç”¨æ‰€ä½¿ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªç‰ˆæœ¬çš„ Java æ ¸å¿ƒåº“çš„ç±»ï¼Œæ˜¯äº’ç›¸å…¼å®¹çš„ã€‚<br>ä¸åŒçš„ç±»åŠ è½½å™¨ä¸ºç›¸åŒåç§°çš„ç±»åˆ›å»ºäº†é¢å¤–çš„åç§°ç©ºé—´ã€‚ç›¸åŒåç§°çš„ç±»å¯ä»¥å¹¶å­˜åœ¨ Java è™šæ‹Ÿæœºä¸­ï¼Œåªéœ€è¦ç”¨ä¸åŒçš„ç±»åŠ è½½å™¨æ¥åŠ è½½å®ƒä»¬å³å¯ã€‚ä¸åŒç±»åŠ è½½å™¨åŠ è½½çš„ç±»ä¹‹é—´æ˜¯ä¸å…¼å®¹çš„ï¼Œè¿™å°±ç›¸å½“äºåœ¨ Java è™šæ‹Ÿæœºå†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ªä¸ªç›¸äº’éš”ç¦»çš„ Java ç±»ç©ºé—´ã€‚</p>
<p>ä¸‹é¢å…·ä½“ä»‹ç»ç±»åŠ è½½å™¨åŠ è½½ç±»çš„è¯¦ç»†è¿‡ç¨‹ã€‚</p>
<h3 id="åŠ è½½ç±»çš„è¿‡ç¨‹"><a href="#åŠ è½½ç±»çš„è¿‡ç¨‹" class="headerlink" title="åŠ è½½ç±»çš„è¿‡ç¨‹"></a>åŠ è½½ç±»çš„è¿‡ç¨‹</h3><p>åœ¨å‰é¢ä»‹ç»ç±»åŠ è½½å™¨çš„ä»£ç†æ¨¡å¼çš„æ—¶å€™ï¼Œæåˆ°è¿‡ç±»åŠ è½½å™¨ä¼šé¦–å…ˆä»£ç†ç»™å…¶å®ƒç±»åŠ è½½å™¨æ¥å°è¯•åŠ è½½æŸä¸ªç±»ã€‚è¿™å°±æ„å‘³ç€çœŸæ­£å®Œæˆç±»çš„åŠ è½½å·¥ä½œçš„ç±»åŠ è½½å™¨å’Œå¯åŠ¨è¿™ä¸ªåŠ è½½è¿‡ç¨‹çš„ç±»åŠ è½½å™¨ï¼Œæœ‰å¯èƒ½ä¸æ˜¯åŒä¸€ä¸ªã€‚çœŸæ­£å®Œæˆç±»çš„åŠ è½½å·¥ä½œæ˜¯é€šè¿‡è°ƒç”¨ defineClassæ¥å®ç°çš„ï¼›è€Œå¯åŠ¨ç±»çš„åŠ è½½è¿‡ç¨‹æ˜¯é€šè¿‡è°ƒç”¨ loadClassæ¥å®ç°çš„ã€‚å‰è€…ç§°ä¸ºä¸€ä¸ªç±»çš„å®šä¹‰åŠ è½½å™¨ï¼ˆdefining loaderï¼‰ï¼Œåè€…ç§°ä¸ºåˆå§‹åŠ è½½å™¨ï¼ˆinitiating loaderï¼‰ã€‚åœ¨ Java è™šæ‹Ÿæœºåˆ¤æ–­ä¸¤ä¸ªç±»æ˜¯å¦ç›¸åŒçš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯ç±»çš„å®šä¹‰åŠ è½½å™¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå“ªä¸ªç±»åŠ è½½å™¨å¯åŠ¨ç±»çš„åŠ è½½è¿‡ç¨‹å¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯æœ€ç»ˆå®šä¹‰è¿™ä¸ªç±»çš„åŠ è½½å™¨ã€‚ä¸¤ç§ç±»åŠ è½½å™¨çš„å…³è”ä¹‹å¤„åœ¨äºï¼šä¸€ä¸ªç±»çš„å®šä¹‰åŠ è½½å™¨æ˜¯å®ƒå¼•ç”¨çš„å…¶å®ƒç±»çš„åˆå§‹åŠ è½½å™¨ã€‚å¦‚ç±» com.example.Outerå¼•ç”¨äº†ç±» com.example.Innerï¼Œåˆ™ç”±ç±» com.example.Outerçš„å®šä¹‰åŠ è½½å™¨è´Ÿè´£å¯åŠ¨ç±» com.example.Innerçš„åŠ è½½è¿‡ç¨‹ã€‚<br>æ–¹æ³• loadClass()æŠ›å‡ºçš„æ˜¯ java.lang.ClassNotFoundExceptionå¼‚å¸¸ï¼›æ–¹æ³• defineClass()æŠ›å‡ºçš„æ˜¯ java.lang.NoClassDefFoundErrorå¼‚å¸¸ã€‚<br>ç±»åŠ è½½å™¨åœ¨æˆåŠŸåŠ è½½æŸä¸ªç±»ä¹‹åï¼Œä¼šæŠŠå¾—åˆ°çš„ java.lang.Classç±»çš„å®ä¾‹ç¼“å­˜èµ·æ¥ã€‚ä¸‹æ¬¡å†è¯·æ±‚åŠ è½½è¯¥ç±»çš„æ—¶å€™ï¼Œç±»åŠ è½½å™¨ä¼šç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ç±»çš„å®ä¾‹ï¼Œè€Œä¸ä¼šå°è¯•å†æ¬¡åŠ è½½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºä¸€ä¸ªç±»åŠ è½½å™¨å®ä¾‹æ¥è¯´ï¼Œç›¸åŒå…¨åçš„ç±»åªåŠ è½½ä¸€æ¬¡ï¼Œå³ loadClassæ–¹æ³•ä¸ä¼šè¢«é‡å¤è°ƒç”¨ã€‚</p>
<p>ä¸‹é¢è®¨è®ºå¦å¤–ä¸€ç§ç±»åŠ è½½å™¨ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€‚</p>
<h4 id="çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨"><a href="#çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨" class="headerlink" title="çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨"></a>çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨</h4><p>çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆcontext class loaderï¼‰æ˜¯ä» JDK 1.2 å¼€å§‹å¼•å…¥çš„ã€‚ç±» java.lang.Threadä¸­çš„æ–¹æ³• getContextClassLoader()å’Œ setContextClassLoader(ClassLoader cl)ç”¨æ¥è·å–å’Œè®¾ç½®çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€‚å¦‚æœæ²¡æœ‰é€šè¿‡ setContextClassLoader(ClassLoader cl)æ–¹æ³•è¿›è¡Œè®¾ç½®çš„è¯ï¼Œçº¿ç¨‹å°†ç»§æ‰¿å…¶çˆ¶çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€‚Java åº”ç”¨è¿è¡Œçš„åˆå§‹çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚åœ¨çº¿ç¨‹ä¸­è¿è¡Œçš„ä»£ç å¯ä»¥é€šè¿‡æ­¤ç±»åŠ è½½å™¨æ¥åŠ è½½ç±»å’Œèµ„æºã€‚<br>å‰é¢æåˆ°çš„ç±»åŠ è½½å™¨çš„ä»£ç†æ¨¡å¼å¹¶ä¸èƒ½è§£å†³ Java åº”ç”¨å¼€å‘ä¸­ä¼šé‡åˆ°çš„ç±»åŠ è½½å™¨çš„å…¨éƒ¨é—®é¢˜ã€‚Java æä¾›äº†å¾ˆå¤šæœåŠ¡æä¾›è€…æ¥å£ï¼ˆService Provider Interfaceï¼ŒSPIï¼‰ï¼Œå…è®¸ç¬¬ä¸‰æ–¹ä¸ºè¿™äº›æ¥å£æä¾›å®ç°ã€‚å¸¸è§çš„ SPI æœ‰ JDBCã€JCEã€JNDIã€JAXP å’Œ JBI ç­‰ã€‚è¿™äº› SPI çš„æ¥å£ç”± Java æ ¸å¿ƒåº“æ¥æä¾›ï¼Œå¦‚ JAXP çš„ SPI æ¥å£å®šä¹‰åŒ…å«åœ¨ javax.xml.parsersåŒ…ä¸­ã€‚è¿™äº› SPI çš„å®ç°ä»£ç å¾ˆå¯èƒ½æ˜¯ä½œä¸º Java åº”ç”¨æ‰€ä¾èµ–çš„ jar åŒ…è¢«åŒ…å«è¿›æ¥ï¼Œå¯ä»¥é€šè¿‡ç±»è·¯å¾„ï¼ˆCLASSPATHï¼‰æ¥æ‰¾åˆ°ï¼Œå¦‚å®ç°äº† JAXP SPI çš„ Apache Xercesæ‰€åŒ…å«çš„ jar åŒ…ã€‚SPI æ¥å£ä¸­çš„ä»£ç ç»å¸¸éœ€è¦åŠ è½½å…·ä½“çš„å®ç°ç±»ã€‚å¦‚ JAXP ä¸­çš„ javax.xml.parsers.DocumentBuilderFactoryç±»ä¸­çš„ newInstance()æ–¹æ³•ç”¨æ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ DocumentBuilderFactoryçš„å®ä¾‹ã€‚è¿™é‡Œçš„å®ä¾‹çš„çœŸæ­£çš„ç±»æ˜¯ç»§æ‰¿è‡ª javax.xml.parsers.DocumentBuilderFactoryï¼Œç”± SPI çš„å®ç°æ‰€æä¾›çš„ã€‚å¦‚åœ¨ Apache Xerces ä¸­ï¼Œå®ç°çš„ç±»æ˜¯ org.apache.xerces.jaxp.DocumentBuilderFactoryImplã€‚è€Œé—®é¢˜åœ¨äºï¼ŒSPI çš„æ¥å£æ˜¯ Java æ ¸å¿ƒåº“çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯ç”±å¼•å¯¼ç±»åŠ è½½å™¨æ¥åŠ è½½çš„ï¼›SPI å®ç°çš„ Java ç±»ä¸€èˆ¬æ˜¯ç”±ç³»ç»Ÿç±»åŠ è½½å™¨æ¥åŠ è½½çš„ã€‚å¼•å¯¼ç±»åŠ è½½å™¨æ˜¯æ— æ³•æ‰¾åˆ° SPI çš„å®ç°ç±»çš„ï¼Œå› ä¸ºå®ƒåªåŠ è½½ Java çš„æ ¸å¿ƒåº“ã€‚å®ƒä¹Ÿä¸èƒ½ä»£ç†ç»™ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œå› ä¸ºå®ƒæ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨çš„ç¥–å…ˆç±»åŠ è½½å™¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç±»åŠ è½½å™¨çš„ä»£ç†æ¨¡å¼æ— æ³•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚<br>çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨æ­£å¥½è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœä¸åšä»»ä½•çš„è®¾ç½®ï¼ŒJava åº”ç”¨çš„çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨é»˜è®¤å°±æ˜¯ç³»ç»Ÿä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€‚åœ¨ SPI æ¥å£çš„ä»£ç ä¸­ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œå°±å¯ä»¥æˆåŠŸçš„åŠ è½½åˆ° SPI å®ç°çš„ç±»ã€‚çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨åœ¨å¾ˆå¤š SPI çš„å®ç°ä¸­éƒ½ä¼šç”¨åˆ°ã€‚</p>
<p>ä¸‹é¢ä»‹ç»å¦å¤–ä¸€ç§åŠ è½½ç±»çš„æ–¹æ³•ï¼šClass.forNameã€‚</p>
<h4 id="Class-forName"><a href="#Class-forName" class="headerlink" title="Class.forName"></a>Class.forName</h4><p>Class.forNameæ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼ŒåŒæ ·å¯ä»¥ç”¨æ¥åŠ è½½ç±»ã€‚è¯¥æ–¹æ³•æœ‰ä¸¤ç§å½¢å¼ï¼šClass.forName(String name, boolean initialize, ClassLoader loader)å’Œ Class.forName(String className)ã€‚ç¬¬ä¸€ç§å½¢å¼çš„å‚æ•° nameè¡¨ç¤ºçš„æ˜¯ç±»çš„å…¨åï¼›initializeè¡¨ç¤ºæ˜¯å¦åˆå§‹åŒ–ç±»ï¼›loaderè¡¨ç¤ºåŠ è½½æ—¶ä½¿ç”¨çš„ç±»åŠ è½½å™¨ã€‚ç¬¬äºŒç§å½¢å¼åˆ™ç›¸å½“äºè®¾ç½®äº†å‚æ•° initializeçš„å€¼ä¸º trueï¼Œloaderçš„å€¼ä¸ºå½“å‰ç±»çš„ç±»åŠ è½½å™¨ã€‚Class.forNameçš„ä¸€ä¸ªå¾ˆå¸¸è§çš„ç”¨æ³•æ˜¯åœ¨åŠ è½½æ•°æ®åº“é©±åŠ¨çš„æ—¶å€™ã€‚å¦‚ Class.forName(â€œorg.apache.derby.jdbc.EmbeddedDriverâ€).newInstance()ç”¨æ¥åŠ è½½ Apache Derby æ•°æ®åº“çš„é©±åŠ¨ã€‚</p>
<h3 id="å¼€å‘è‡ªå·±çš„ç±»åŠ è½½å™¨"><a href="#å¼€å‘è‡ªå·±çš„ç±»åŠ è½½å™¨" class="headerlink" title="å¼€å‘è‡ªå·±çš„ç±»åŠ è½½å™¨"></a>å¼€å‘è‡ªå·±çš„ç±»åŠ è½½å™¨</h3><p>ç”¨æ¥åŠ è½½å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ Java å­—èŠ‚ä»£ç ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">public class FileSystemClassLoader extends ClassLoader &#123; </div><div class="line"></div><div class="line">    private String rootDir; </div><div class="line"></div><div class="line">    public FileSystemClassLoader(String rootDir) &#123; </div><div class="line">        this.rootDir = rootDir; </div><div class="line">    &#125; </div><div class="line"></div><div class="line">    protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123; </div><div class="line">        byte[] classData = getClassData(name); </div><div class="line">        if (classData == null) &#123; </div><div class="line">            throw new ClassNotFoundException(); </div><div class="line">        &#125; </div><div class="line">        else &#123; </div><div class="line">            return defineClass(name, classData, 0, classData.length); </div><div class="line">        &#125; </div><div class="line">    &#125; </div><div class="line"></div><div class="line">    private byte[] getClassData(String className) &#123; </div><div class="line">        String path = classNameToPath(className); </div><div class="line">        try &#123; </div><div class="line">            InputStream ins = new FileInputStream(path); </div><div class="line">            ByteArrayOutputStream baos = new ByteArrayOutputStream(); </div><div class="line">            int bufferSize = 4096; </div><div class="line">            byte[] buffer = new byte[bufferSize]; </div><div class="line">            int bytesNumRead = 0; </div><div class="line">            while ((bytesNumRead = ins.read(buffer)) != -1) &#123; </div><div class="line">                baos.write(buffer, 0, bytesNumRead); </div><div class="line">            &#125; </div><div class="line">            return baos.toByteArray(); </div><div class="line">        &#125; catch (IOException e) &#123; </div><div class="line">            e.printStackTrace(); </div><div class="line">        &#125; </div><div class="line">        return null; </div><div class="line">    &#125; </div><div class="line"></div><div class="line">    private String classNameToPath(String className) &#123; </div><div class="line">        return rootDir + File.separatorChar </div><div class="line">                + className.replace(&apos;.&apos;, File.separatorChar) + &quot;.class&quot;; </div><div class="line">    &#125; </div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>ç±» FileSystemClassLoaderç»§æ‰¿è‡ªç±» java.lang.ClassLoaderã€‚åœ¨ è¡¨ 1ä¸­åˆ—å‡ºçš„ java.lang.ClassLoaderç±»çš„å¸¸ç”¨æ–¹æ³•ä¸­ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè‡ªå·±å¼€å‘çš„ç±»åŠ è½½å™¨åªéœ€è¦è¦†å†™ findClass(String name)æ–¹æ³•å³å¯ã€‚java.lang.ClassLoaderç±»çš„æ–¹æ³• loadClass()å°è£…äº†å‰é¢æåˆ°çš„ä»£ç†æ¨¡å¼çš„å®ç°ã€‚è¯¥æ–¹æ³•ä¼šé¦–å…ˆè°ƒç”¨ findLoadedClass()æ–¹æ³•æ¥æ£€æŸ¥è¯¥ç±»æ˜¯å¦å·²ç»è¢«åŠ è½½è¿‡ï¼›å¦‚æœæ²¡æœ‰åŠ è½½è¿‡çš„è¯ï¼Œä¼šè°ƒç”¨çˆ¶ç±»åŠ è½½å™¨çš„ loadClass()æ–¹æ³•æ¥å°è¯•åŠ è½½è¯¥ç±»ï¼›å¦‚æœçˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½è¯¥ç±»çš„è¯ï¼Œå°±è°ƒç”¨ findClass()æ–¹æ³•æ¥æŸ¥æ‰¾è¯¥ç±»ã€‚å› æ­¤ï¼Œä¸ºäº†ä¿è¯ç±»åŠ è½½å™¨éƒ½æ­£ç¡®å®ç°ä»£ç†æ¨¡å¼ï¼Œåœ¨å¼€å‘è‡ªå·±çš„ç±»åŠ è½½å™¨æ—¶ï¼Œæœ€å¥½ä¸è¦è¦†å†™ loadClass()æ–¹æ³•ï¼Œè€Œæ˜¯è¦†å†™ findClass()æ–¹æ³•ã€‚</p>
<p>ç±» FileSystemClassLoaderçš„ findClass()æ–¹æ³•é¦–å…ˆæ ¹æ®ç±»çš„å…¨ååœ¨ç¡¬ç›˜ä¸ŠæŸ¥æ‰¾ç±»çš„å­—èŠ‚ä»£ç æ–‡ä»¶ï¼ˆ.class æ–‡ä»¶ï¼‰ï¼Œç„¶åè¯»å–è¯¥æ–‡ä»¶å†…å®¹ï¼Œæœ€åé€šè¿‡ defineClass()æ–¹æ³•æ¥æŠŠè¿™äº›å­—èŠ‚ä»£ç è½¬æ¢æˆ java.lang.Classç±»çš„å®ä¾‹ã€‚</p>
<h3 id="ç±»åŠ è½½å™¨ä¸-Web-å®¹å™¨"><a href="#ç±»åŠ è½½å™¨ä¸-Web-å®¹å™¨" class="headerlink" title="ç±»åŠ è½½å™¨ä¸ Web å®¹å™¨"></a>ç±»åŠ è½½å™¨ä¸ Web å®¹å™¨</h3><p>å¯¹äºè¿è¡Œåœ¨ Java EEâ„¢å®¹å™¨ä¸­çš„ Web åº”ç”¨æ¥è¯´ï¼Œç±»åŠ è½½å™¨çš„å®ç°æ–¹å¼ä¸ä¸€èˆ¬çš„ Java åº”ç”¨æœ‰æ‰€ä¸åŒã€‚ä¸åŒçš„ Web å®¹å™¨çš„å®ç°æ–¹å¼ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚ä»¥ Apache Tomcat æ¥è¯´ï¼Œæ¯ä¸ª Web åº”ç”¨éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ç±»åŠ è½½å™¨å®ä¾‹ã€‚è¯¥ç±»åŠ è½½å™¨ä¹Ÿä½¿ç”¨ä»£ç†æ¨¡å¼ï¼Œæ‰€ä¸åŒçš„æ˜¯å®ƒæ˜¯é¦–å…ˆå°è¯•å»åŠ è½½æŸä¸ªç±»ï¼Œå¦‚æœæ‰¾ä¸åˆ°å†ä»£ç†ç»™çˆ¶ç±»åŠ è½½å™¨ã€‚è¿™ä¸ä¸€èˆ¬ç±»åŠ è½½å™¨çš„é¡ºåºæ˜¯ç›¸åçš„ã€‚è¿™æ˜¯ Java Servlet è§„èŒƒä¸­çš„æ¨èåšæ³•ï¼Œå…¶ç›®çš„æ˜¯ä½¿å¾— Web åº”ç”¨è‡ªå·±çš„ç±»çš„ä¼˜å…ˆçº§é«˜äº Web å®¹å™¨æä¾›çš„ç±»ã€‚è¿™ç§ä»£ç†æ¨¡å¼çš„ä¸€ä¸ªä¾‹å¤–æ˜¯ï¼šJava æ ¸å¿ƒåº“çš„ç±»æ˜¯ä¸åœ¨æŸ¥æ‰¾èŒƒå›´ä¹‹å†…çš„ã€‚è¿™ä¹Ÿæ˜¯ä¸ºäº†ä¿è¯ Java æ ¸å¿ƒåº“çš„ç±»å‹å®‰å…¨ã€‚<br>ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒWeb åº”ç”¨çš„å¼€å‘äººå‘˜ä¸éœ€è¦è€ƒè™‘ä¸ç±»åŠ è½½å™¨ç›¸å…³çš„ç»†èŠ‚ã€‚ä¸‹é¢ç»™å‡ºå‡ æ¡ç®€å•çš„åŸåˆ™ï¼š</p>
<ul>
<li>æ¯ä¸ª Web åº”ç”¨è‡ªå·±çš„ Java ç±»æ–‡ä»¶å’Œä½¿ç”¨çš„åº“çš„ jar åŒ…ï¼Œåˆ†åˆ«æ”¾åœ¨ WEB-INF/classeså’Œ WEB-INF/libç›®å½•ä¸‹é¢ã€‚</li>
<li>å¤šä¸ªåº”ç”¨å…±äº«çš„ Java ç±»æ–‡ä»¶å’Œ jar åŒ…ï¼Œåˆ†åˆ«æ”¾åœ¨ Web å®¹å™¨æŒ‡å®šçš„ç”±æ‰€æœ‰ Web åº”ç”¨å…±äº«çš„ç›®å½•ä¸‹é¢ã€‚</li>
<li>å½“å‡ºç°æ‰¾ä¸åˆ°ç±»çš„é”™è¯¯æ—¶ï¼Œæ£€æŸ¥å½“å‰ç±»çš„ç±»åŠ è½½å™¨å’Œå½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨æ˜¯å¦æ­£ç¡®ã€‚</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[String]]></title>
      <url>http://zsr.github.io/2016/08/03/String/</url>
      <content type="html"><![CDATA[<h1 id="OpenJDK-æºä»£ç é˜…è¯»ä¹‹-String"><a href="#OpenJDK-æºä»£ç é˜…è¯»ä¹‹-String" class="headerlink" title="OpenJDK æºä»£ç é˜…è¯»ä¹‹ String"></a>OpenJDK æºä»£ç é˜…è¯»ä¹‹ String</h1><hr>
<h2 id="æ¦‚è¦"><a href="#æ¦‚è¦" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h2><ul>
<li>ç±»ç»§æ‰¿å…³ç³»</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">java.lang.Object</div><div class="line">    java.lang.String</div></pre></td></tr></table></figure>
<ul>
<li>å®šä¹‰</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">String</span></span></div><div class="line"><span class="keyword">extends</span> <span class="title">Object</span></div><div class="line"><span class="keyword">implements</span> <span class="title">Serializable</span>, <span class="title">Comparable</span>&lt;<span class="title">String</span>&gt;, <span class="title">CharSequence</span></div></pre></td></tr></table></figure>
<ul>
<li>è¦ç‚¹</li>
</ul>
<p>ä¸€æ—¦åˆ›å»ºå°±ä¸å¯æ”¹å˜</p>
<a id="more"></a>
<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><ul>
<li>storage</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** The value is used for character storage. */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">char</span> value[];</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡º <code>String</code> ä¸­çš„æ•°æ®æ˜¯å¦‚ä½•å­˜å‚¨çš„ã€‚</p>
<ul>
<li>åˆå§‹åŒ–</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(String original)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.value = original.value;</div><div class="line">    <span class="keyword">this</span>.hash = original.hash;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºä½¿ç”¨ <code>String</code> ç±»å‹åˆå§‹åŒ–ï¼Œæ–° <code>String</code> å®é™…ä¸Šä¸åŸæ¥çš„ <code>String</code> æŒ‡å‘åŒä¸€å—å†…å­˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(<span class="keyword">char</span> value[])</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.value = Arrays.copyOf(value, value.length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœç”¨ <code>char[]</code> åˆå§‹åŒ–ï¼Œå¯ä»¥çœ‹å‡ºï¼Œæ–°åˆ†é…äº†å†…å­˜ï¼Œå¹¶å¤åˆ¶ï¼Œä¿è¯äº†ä¸¤è€…ç›¸äº’ç‹¬ç«‹ï¼Œåªæ˜¯å†…å®¹ç›¸åŒã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(StringBuffer buffer)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span>(buffer) &#123;</div><div class="line">        <span class="keyword">this</span>.value = Arrays.copyOf(buffer.getValue(), buffer.length());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ç”¨ <code>StringBuffer</code> åˆå§‹åŒ–æ—¶ï¼Œå¯¹åŒä¸€ <code>buffer</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå³åˆå§‹åŒ– <code>String</code> çš„è¿‡ç¨‹ä¸­ï¼Œå…¶å®ƒçº¿ç¨‹ä¸ä¼šæ”¹å˜ <code>buffer</code> çš„å†…å®¹ã€‚</p>
<p>å¦å¤–ï¼Œèƒ½å‘Šè¯‰æˆ‘ä¸‹é¢è¿™æ®µä»£ç æ˜¯æ€ä¹ˆå›äº‹ä¹ˆï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(StringBuilder builder)</span> </span>&#123;</div><div class="line">     <span class="keyword">this</span>.value = Arrays.copyOf(builder.getValue(), builder.length());</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>ä¸ºå•¥è¿™æ¬¡ä¸åŒæ­¥äº†å‘¢ï¼Ÿ</p>
<ul>
<li>equals </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object anObject)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> == anObject) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (anObject <span class="keyword">instanceof</span> String) &#123;</div><div class="line">        String anotherString = (String) anObject;</div><div class="line">        <span class="keyword">int</span> n = value.length;</div><div class="line">        <span class="keyword">if</span> (n == anotherString.value.length) &#123;</div><div class="line">            <span class="keyword">char</span> v1[] = value;</div><div class="line">            <span class="keyword">char</span> v2[] = anotherString.value;</div><div class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span> (n-- != <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (v1[i] != v2[i])</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                i++;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼š</p>
<p>1) æ£€æŸ¥ç±»å‹<br>2) <code>value</code> ç›´æ¥é€šè¿‡ç‚¹è®¿é—®äº†ï¼Œ<code>value</code> æ˜¯ <code>private</code> çš„å•Šï¼Œæ€ä¹ˆèƒ½è¿™æ ·ï¼Ÿ</p>
<ul>
<li>hashCode </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> h = hash;</div><div class="line">    <span class="keyword">if</span> (h == <span class="number">0</span> &amp;&amp; value.length &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">char</span> val[] = value;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; value.length; i++) &#123;</div><div class="line">            h = <span class="number">31</span> * h + val[i];</div><div class="line">        &#125;</div><div class="line">        hash = h;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> h;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>String</code> çš„ <code>hashCode</code> å…¬å¼ï¼š</p>
<blockquote>
<p>s[0]*31^(n-1) + s[1]*31^(n-2) + â€¦ + s[n-1]</p>
</blockquote>
<ul>
<li>replace</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">replace</span><span class="params">(<span class="keyword">char</span> oldChar, <span class="keyword">char</span> newChar)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (oldChar != newChar) &#123;</div><div class="line">        <span class="keyword">int</span> len = value.length;</div><div class="line">        <span class="keyword">int</span> i = -<span class="number">1</span>;</div><div class="line">        <span class="keyword">char</span>[] val = value; <span class="comment">/* avoid getfield opcode */</span></div><div class="line"></div><div class="line">        <span class="keyword">while</span> (++i &lt; len) &#123;</div><div class="line">            <span class="keyword">if</span> (val[i] == oldChar) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (i &lt; len) &#123;</div><div class="line">            <span class="keyword">char</span> buf[] = <span class="keyword">new</span> <span class="keyword">char</span>[len];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++) &#123;</div><div class="line">                buf[j] = val[j];</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">while</span> (i &lt; len) &#123;</div><div class="line">                <span class="keyword">char</span> c = val[i];</div><div class="line">                buf[i] = (c == oldChar) ? newChar : c;</div><div class="line">                i++;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(buf, <span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸­å¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶è¯´æ˜¯ <code>replace</code>ï¼Œä½†æ˜¯å®é™…ä¸Šè¿˜æ˜¯æ–°ç”Ÿæˆäº† <code>buf</code> ï¼Œç„¶åå†ç”Ÿæˆæ–°çš„ <code>String</code>ï¼Œè€Œä¸æ˜¯åœ¨åŸæ¥çš„ <code>value</code> ä¸Šä¿®æ”¹ã€‚å¦‚æœæœ‰å¤§é‡çš„æ›¿æ¢ï¼Œè¿˜æ˜¯è‡ªå·±å®ç°æ¯”è¾ƒå¥½è¯¶ï½</p>
<ul>
<li>indexOf</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Code shared by String and StringBuffer to do searches. The</div><div class="line"> * source is the character array being searched, and the target</div><div class="line"> * is the string being searched for.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span>   source       the characters being searched.</div><div class="line"> * <span class="doctag">@param</span>   sourceOffset offset of the source string.</div><div class="line"> * <span class="doctag">@param</span>   sourceCount  count of the source string.</div><div class="line"> * <span class="doctag">@param</span>   target       the characters being searched for.</div><div class="line"> * <span class="doctag">@param</span>   targetOffset offset of the target string.</div><div class="line"> * <span class="doctag">@param</span>   targetCount  count of the target string.</div><div class="line"> * <span class="doctag">@param</span>   fromIndex    the index to begin searching from.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">indexOf</span><span class="params">(<span class="keyword">char</span>[] source, <span class="keyword">int</span> sourceOffset, <span class="keyword">int</span> sourceCount,</span></span></div><div class="line">        <span class="keyword">char</span>[] target, <span class="keyword">int</span> targetOffset, <span class="keyword">int</span> targetCount,</div><div class="line">        <span class="keyword">int</span> fromIndex) &#123;</div><div class="line">    <span class="keyword">if</span> (fromIndex &gt;= sourceCount) &#123;</div><div class="line">        <span class="keyword">return</span> (targetCount == <span class="number">0</span> ? sourceCount : -<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (fromIndex &lt; <span class="number">0</span>) &#123;</div><div class="line">        fromIndex = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (targetCount == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> fromIndex;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">char</span> first = target[targetOffset];</div><div class="line">    <span class="keyword">int</span> max = sourceOffset + (sourceCount - targetCount);</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = sourceOffset + fromIndex; i &lt;= max; i++) &#123;</div><div class="line">        <span class="comment">/* Look for first character. */</span></div><div class="line">        <span class="keyword">if</span> (source[i] != first) &#123;</div><div class="line">            <span class="keyword">while</span> (++i &lt;= max &amp;&amp; source[i] != first);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/* Found first character, now look at the rest of v2 */</span></div><div class="line">        <span class="keyword">if</span> (i &lt;= max) &#123;</div><div class="line">            <span class="keyword">int</span> j = i + <span class="number">1</span>;</div><div class="line">            <span class="keyword">int</span> end = j + targetCount - <span class="number">1</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = targetOffset + <span class="number">1</span>; j &lt; end &amp;&amp; source[j]</div><div class="line">                    == target[k]; j++, k++);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (j == end) &#123;</div><div class="line">                <span class="comment">/* Found whole string. */</span></div><div class="line">                <span class="keyword">return</span> i - sourceOffset;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ä» <code>source</code> ä¸­å¯»æ‰¾ <code>target</code> ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®ï¼Œ<code>for</code> å¾ªç¯æ¯æ¬¡éƒ½å…ˆè®© <code>i</code> åœç•™åœ¨ä¸€ä¸ªä½ç½®ï¼Œæ­¤ä½ç½®ä¸Šå†…å®¹ä¸ <code>target</code> é¦–å­—ç¬¦ç›¸åŒï¼Œç„¶åå¼€å§‹éå†ã€‚å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ª <code>O(n^2)</code> çš„ç®—æ³•ï¼Œæ‰€ä»¥ï¼Œæ ‡å‡†åº“ä¹Ÿä¸ä¸€å®šæ˜¯æœ€é«˜æ•ˆçš„ï¼Œè¦æ˜¯è¦é«˜æ•ˆï¼Œè¿˜æ˜¯éœ€è¦è‡ªå·±å®ç°ï¼Œæˆ–è€…æ‰¾å…¶å®ƒåº“çš„ã€‚</p>
<ul>
<li>matches</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(String regex)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Pattern.matches(regex, <span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å‡½æ•°ã€‚å¯ä»¥çœ‹å‡ºï¼Œæ˜¯ç›´æ¥è°ƒç”¨äº† <code>Pattern</code> ä¸­çš„ç›¸åº”å‡½æ•°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> String[] split(String regex, <span class="keyword">int</span> limit) &#123;</div><div class="line">    <span class="comment">/* fastpath if the regex is a</span></div><div class="line">     (1)one-char String and this character is not one of the</div><div class="line">        RegEx's meta characters ".$|()[&#123;^?*+\\", or</div><div class="line">     (2)two-char String and the first char is the backslash and</div><div class="line">        the second is not the ascii digit or ascii letter.</div><div class="line">     */</div><div class="line">    <span class="keyword">char</span> ch = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (((regex.value.length == <span class="number">1</span> &amp;&amp;</div><div class="line">         <span class="string">".$|()[&#123;^?*+\\"</span>.indexOf(ch = regex.charAt(<span class="number">0</span>)) == -<span class="number">1</span>) ||</div><div class="line">         (regex.length() == <span class="number">2</span> &amp;&amp;</div><div class="line">          regex.charAt(<span class="number">0</span>) == <span class="string">'\\'</span> &amp;&amp;</div><div class="line">          (((ch = regex.charAt(<span class="number">1</span>))-<span class="string">'0'</span>)|(<span class="string">'9'</span>-ch)) &lt; <span class="number">0</span> &amp;&amp;</div><div class="line">          ((ch-<span class="string">'a'</span>)|(<span class="string">'z'</span>-ch)) &lt; <span class="number">0</span> &amp;&amp;</div><div class="line">          ((ch-<span class="string">'A'</span>)|(<span class="string">'Z'</span>-ch)) &lt; <span class="number">0</span>)) &amp;&amp;</div><div class="line">        (ch &lt; Character.MIN_HIGH_SURROGATE ||</div><div class="line">         ch &gt; Character.MAX_LOW_SURROGATE))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">int</span> off = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> next = <span class="number">0</span>;</div><div class="line">        <span class="keyword">boolean</span> limited = limit &gt; <span class="number">0</span>;</div><div class="line">        ArrayList&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">while</span> ((next = indexOf(ch, off)) != -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (!limited || list.size() &lt; limit - <span class="number">1</span>) &#123;</div><div class="line">                list.add(substring(off, next));</div><div class="line">                off = next + <span class="number">1</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;    <span class="comment">// last one</span></div><div class="line">                <span class="comment">//assert (list.size() == limit - 1);</span></div><div class="line">                list.add(substring(off, value.length));</div><div class="line">                off = value.length;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// If no match was found, return this</span></div><div class="line">        <span class="keyword">if</span> (off == <span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;<span class="keyword">this</span>&#125;;</div><div class="line"></div><div class="line">        <span class="comment">// Add remaining segment</span></div><div class="line">        <span class="keyword">if</span> (!limited || list.size() &lt; limit)</div><div class="line">            list.add(substring(off, value.length));</div><div class="line"></div><div class="line">        <span class="comment">// Construct result</span></div><div class="line">        <span class="keyword">int</span> resultSize = list.size();</div><div class="line">        <span class="keyword">if</span> (limit == <span class="number">0</span>)</div><div class="line">            <span class="keyword">while</span> (resultSize &gt; <span class="number">0</span> &amp;&amp; list.get(resultSize - <span class="number">1</span>).length() == <span class="number">0</span>)</div><div class="line">                resultSize--;</div><div class="line">        String[] result = <span class="keyword">new</span> String[resultSize];</div><div class="line">        <span class="keyword">return</span> list.subList(<span class="number">0</span>, resultSize).toArray(result);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> Pattern.compile(regex).split(<span class="keyword">this</span>, limit);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æŒ‰ <code>regex</code> å°†å­—ç¬¦ä¸²åˆ†å‰²ï¼Œæ€è·¯æ˜¯å¦‚æœæ˜¯å•ä¸ªå­—ç¬¦ï¼Œæˆ–è€…è½¬ä¹‰å­—ç¬¦ï¼Œå°±æ‰‹å·¥åˆ†å‰²ï¼Œå¦åˆ™å°±ç›´æ¥è°ƒç”¨ <code>Pattern.comile(regex).split</code> å‡½æ•°ã€‚æ‰‹å·¥åˆ†å‰²æ—¶æ¯æ¬¡éƒ½å°† <code>[off, next]</code> ä¹‹é—´çš„å†…å®¹åŠ å…¥ <code>list</code>ï¼Œæœ€åå°† å‰©ä½™çš„ <code>[off, ]</code>  åŠ å…¥ã€‚å¦å¤–æ³¨æ„ <code>limit</code> å¯¹åˆ†å‰²æ¬¡æ•°çš„é™åˆ¶ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[JAVA NIO Demo]]></title>
      <url>http://zsr.github.io/2016/08/02/Java-Nio-demo/</url>
      <content type="html"><![CDATA[<h1 id="JAVA-NIO-Demo"><a href="#JAVA-NIO-Demo" class="headerlink" title="JAVA NIO Demo"></a>JAVA NIO Demo</h1><hr>
<h3 id="Nio-æœåŠ¡ç«¯"><a href="#Nio-æœåŠ¡ç«¯" class="headerlink" title="Nio æœåŠ¡ç«¯"></a>Nio æœåŠ¡ç«¯</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line">package com.zsr.test.nio;</div><div class="line"></div><div class="line">import java.io.IOException;</div><div class="line">import java.net.InetSocketAddress;</div><div class="line">import java.nio.ByteBuffer;</div><div class="line">import java.nio.channels.SelectionKey;</div><div class="line">import java.nio.channels.Selector;</div><div class="line">import java.nio.channels.ServerSocketChannel;</div><div class="line">import java.nio.channels.SocketChannel;</div><div class="line">import java.util.Iterator;</div><div class="line"></div><div class="line">/**</div><div class="line"> * nio æœåŠ¡ç«¯ Created by david.zhang</div><div class="line"> */</div><div class="line">public class NIOServer &#123;</div><div class="line"></div><div class="line">  // é€šé“ç®¡ç†å™¨</div><div class="line">  private Selector selector;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * è·å¾—ä¸€ä¸ªServerSocketé€šé“ï¼Œå¹¶å¯¹è¯¥é€šé“åšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œ</div><div class="line">   * </div><div class="line">   * @param port ç»‘å®šçš„ç«¯å£å·</div><div class="line">   * @throws IOException</div><div class="line">   */</div><div class="line">  public void initServer(int port) throws IOException &#123;</div><div class="line">    // è·å¾—ä¸€ä¸ªServerSocketé€šé“</div><div class="line">    ServerSocketChannel serverChannel = ServerSocketChannel.open();</div><div class="line">    // è®¾ç½®é€šé“ä¸ºéé˜»å¡</div><div class="line">    serverChannel.configureBlocking(false);</div><div class="line">    // å°†è¯¥é€šé“å¯¹åº”çš„ServerSocketç»‘å®šåˆ°æŒ‡å®šç«¯å£</div><div class="line">    serverChannel.socket().bind(new InetSocketAddress(port));</div><div class="line">    // è·å¾—ä¸€ä¸ªé€šé“ç®¡ç†å™¨</div><div class="line">    this.selector = Selector.open();</div><div class="line">    // å°†é€šé“ç®¡ç†å™¨å’Œè¯¥é€šé“ç»‘å®šï¼Œå¹¶ä¸ºè¯¥é€šé“æ³¨å†ŒSelectionKey.OP_ACCEPTäº‹ä»¶,æ³¨å†Œè¯¥äº‹ä»¶åï¼Œ</div><div class="line">    // å½“è¯¥äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œselector.select()ä¼šè¿”å›ï¼Œå¦‚æœè¯¥äº‹ä»¶æ²¡åˆ°è¾¾selector.select()ä¼šä¸€ç›´é˜»å¡ã€‚</div><div class="line">    serverChannel.register(selector, SelectionKey.OP_ACCEPT);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * é‡‡ç”¨è½®è¯¢çš„æ–¹å¼ç›‘å¬selectorä¸Šæ˜¯å¦æœ‰éœ€è¦å¤„ç†çš„äº‹ä»¶ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è¿›è¡Œå¤„ç†</div><div class="line">   * </div><div class="line">   * @throws IOException</div><div class="line">   */</div><div class="line">  public void listen() throws IOException &#123;</div><div class="line">    System.out.println(&quot;nio server listen start.&quot;);</div><div class="line">    // è½®è¯¢è®¿é—®selector</div><div class="line">    while (true) &#123;</div><div class="line">      // å½“æ³¨å†Œçš„äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œæ–¹æ³•è¿”å›ï¼›å¦åˆ™,è¯¥æ–¹æ³•ä¼šä¸€ç›´é˜»å¡</div><div class="line">      selector.select();</div><div class="line">      // è·å¾—selectorä¸­é€‰ä¸­çš„é¡¹çš„è¿­ä»£å™¨ï¼Œé€‰ä¸­çš„é¡¹ä¸ºæ³¨å†Œçš„äº‹ä»¶</div><div class="line">      Iterator&lt;SelectionKey&gt; it = selector.selectedKeys().iterator();</div><div class="line">      while (it.hasNext()) &#123;</div><div class="line">        SelectionKey key = it.next();</div><div class="line">        // åˆ é™¤å·²é€‰çš„key,ä»¥é˜²é‡å¤å¤„ç†</div><div class="line">        it.remove();</div><div class="line">        // å®¢æˆ·ç«¯è¯·æ±‚è¿æ¥äº‹ä»¶</div><div class="line">        if (key.isAcceptable()) &#123;</div><div class="line">          ServerSocketChannel server = (ServerSocketChannel) key.channel();</div><div class="line">          // è·å¾—å’Œå®¢æˆ·ç«¯è¿æ¥çš„é€šé“</div><div class="line">          SocketChannel channel = server.accept();</div><div class="line">          // è®¾ç½®æˆéé˜»å¡</div><div class="line">          channel.configureBlocking(false);</div><div class="line"></div><div class="line">          // åœ¨è¿™é‡Œå¯ä»¥ç»™å®¢æˆ·ç«¯å‘é€ä¿¡æ¯</div><div class="line">          channel.write(ByteBuffer.wrap(new String(&quot;æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚.&quot;).getBytes()));</div><div class="line"></div><div class="line">          // åœ¨å’Œå®¢æˆ·ç«¯è¿æ¥æˆåŠŸä¹‹åï¼Œä¸ºäº†å¯ä»¥æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼Œéœ€è¦ç»™é€šé“è®¾ç½®è¯»çš„æƒé™ã€‚</div><div class="line">          channel.register(selector, SelectionKey.OP_READ);</div><div class="line">          // è·å¾—äº†å¯è¯»äº‹ä»¶</div><div class="line">        &#125; else if (key.isReadable()) &#123;</div><div class="line">          read(key);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * å¤„ç†è¯»å–å®¢æˆ·ç«¯å‘æ¥çš„ä¿¡æ¯ çš„äº‹ä»¶</div><div class="line">   * </div><div class="line">   * @param key</div><div class="line">   * @throws IOException</div><div class="line">   */</div><div class="line">  public void read(SelectionKey key) throws IOException &#123;</div><div class="line"></div><div class="line">    // æœåŠ¡å™¨å¯è¯»å–æ¶ˆæ¯:å¾—åˆ°äº‹ä»¶å‘ç”Ÿçš„Socketé€šé“</div><div class="line">    SocketChannel channel = (SocketChannel) key.channel();</div><div class="line">    // åˆ›å»ºè¯»å–çš„ç¼“å†²åŒº</div><div class="line">    ByteBuffer buffer = ByteBuffer.allocate(1024);</div><div class="line">    channel.read(buffer);</div><div class="line">    byte[] data = buffer.array();</div><div class="line">    String msg = new String(data);</div><div class="line">    System.out.println(&quot;æœåŠ¡å™¨ç«¯æ”¶åˆ°å®¢æˆ·ç«¯ä¿¡æ¯:&quot; + msg);</div><div class="line">    // å°†æ¶ˆæ¯å›é€ç»™å®¢æˆ·ç«¯</div><div class="line">    ByteBuffer outBuffer = ByteBuffer.wrap(new String(&quot;æœåŠ¡å™¨ç«¯å‘é€å®¢æˆ·ç«¯æ¶ˆæ¯: world.&quot;).getBytes());</div><div class="line">    channel.write(outBuffer);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // æœåŠ¡å™¨ç«¯æµ‹è¯•</div><div class="line">  public static void main(String[] args) throws IOException &#123;</div><div class="line">    NIOServer nioServer = new NIOServer();</div><div class="line">    nioServer.initServer(8000);</div><div class="line">    nioServer.listen();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="Nio-å®¢æˆ·ç«¯"><a href="#Nio-å®¢æˆ·ç«¯" class="headerlink" title="Nio å®¢æˆ·ç«¯"></a>Nio å®¢æˆ·ç«¯</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line">package com.zsr.test.nio;</div><div class="line"></div><div class="line">import java.io.IOException;</div><div class="line">import java.net.InetSocketAddress;</div><div class="line">import java.nio.ByteBuffer;</div><div class="line">import java.nio.channels.SelectionKey;</div><div class="line">import java.nio.channels.Selector;</div><div class="line">import java.nio.channels.SocketChannel;</div><div class="line">import java.util.Iterator;</div><div class="line"></div><div class="line">/**</div><div class="line"> * nio å®¢æˆ·ç«¯ Created by david.zhang</div><div class="line"> */</div><div class="line">public class NIOClient &#123;</div><div class="line"></div><div class="line">  // é€šé“ç®¡ç†å™¨</div><div class="line">  private Selector selector;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * è·å¾—ä¸€ä¸ªSocketé€šé“ï¼Œå¹¶å¯¹è¯¥é€šé“åšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œ</div><div class="line">   * </div><div class="line">   * @param ip è¿æ¥çš„æœåŠ¡å™¨çš„ip</div><div class="line">   * @param port è¿æ¥çš„æœåŠ¡å™¨çš„ç«¯å£å·</div><div class="line">   * @throws IOException</div><div class="line">   */</div><div class="line">  public void initClient(String ip, int port) throws IOException &#123;</div><div class="line">    // è·å¾—ä¸€ä¸ªSocketé€šé“</div><div class="line">    SocketChannel channel = SocketChannel.open();</div><div class="line">    // è®¾ç½®é€šé“ä¸ºéé˜»å¡</div><div class="line">    channel.configureBlocking(false);</div><div class="line">    // è·å¾—ä¸€ä¸ªé€šé“ç®¡ç†å™¨</div><div class="line">    this.selector = Selector.open();</div><div class="line"></div><div class="line">    // å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨,å…¶å®æ–¹æ³•æ‰§è¡Œå¹¶æ²¡æœ‰å®ç°è¿æ¥ï¼Œéœ€è¦åœ¨listenï¼ˆï¼‰æ–¹æ³•ä¸­è°ƒ</div><div class="line">    // ç”¨channel.finishConnect();æ‰èƒ½å®Œæˆè¿æ¥</div><div class="line">    channel.connect(new InetSocketAddress(ip, port));</div><div class="line">    // å°†é€šé“ç®¡ç†å™¨å’Œè¯¥é€šé“ç»‘å®šï¼Œå¹¶ä¸ºè¯¥é€šé“æ³¨å†ŒSelectionKey.OP_CONNECTäº‹ä»¶ã€‚</div><div class="line">    channel.register(selector, SelectionKey.OP_CONNECT);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * é‡‡ç”¨è½®è¯¢çš„æ–¹å¼ç›‘å¬selectorä¸Šæ˜¯å¦æœ‰éœ€è¦å¤„ç†çš„äº‹ä»¶ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è¿›è¡Œå¤„ç†</div><div class="line">   * </div><div class="line">   * @throws IOException</div><div class="line">   */</div><div class="line">  public void listen() throws IOException &#123;</div><div class="line">    System.out.println(&quot;nio client liesten start.&quot;);</div><div class="line">    // è½®è¯¢è®¿é—®selector</div><div class="line">    while (true) &#123;</div><div class="line">      // å½“æ³¨å†Œçš„äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œæ–¹æ³•è¿”å›ï¼›å¦åˆ™,è¯¥æ–¹æ³•ä¼šä¸€ç›´é˜»å¡</div><div class="line">      selector.select();</div><div class="line">      // è·å¾—selectorä¸­é€‰ä¸­çš„é¡¹çš„è¿­ä»£å™¨ï¼Œé€‰ä¸­çš„é¡¹ä¸ºæ³¨å†Œçš„äº‹ä»¶</div><div class="line">      Iterator&lt;SelectionKey&gt; it = selector.selectedKeys().iterator();</div><div class="line">      while (it.hasNext()) &#123;</div><div class="line">        SelectionKey key = it.next();</div><div class="line">        // åˆ é™¤å·²é€‰çš„key,ä»¥é˜²é‡å¤å¤„ç†</div><div class="line">        it.remove();</div><div class="line">        // è¿æ¥äº‹ä»¶å‘ç”Ÿ</div><div class="line">        if (key.isConnectable()) &#123;</div><div class="line">          SocketChannel channel = (SocketChannel) key.channel();</div><div class="line">          // å¦‚æœæ­£åœ¨è¿æ¥ï¼Œåˆ™å®Œæˆè¿æ¥</div><div class="line">          if (channel.isConnectionPending()) &#123;</div><div class="line">            channel.finishConnect();</div><div class="line">          &#125;</div><div class="line">          // è®¾ç½®éé˜»å¡</div><div class="line">          channel.configureBlocking(false);</div><div class="line"></div><div class="line">          // å‘æœåŠ¡å™¨ç«¯å‘é€ä¿¡æ¯</div><div class="line">          channel.write(ByteBuffer.wrap(new String(&quot;å®¢æˆ·ç«¯è¯·æ±‚è¿æ¥æœåŠ¡å™¨ç«¯.&quot;).getBytes()));</div><div class="line">          // åœ¨å’ŒæœåŠ¡ç«¯è¿æ¥æˆåŠŸä¹‹åï¼Œä¸ºäº†å¯ä»¥æ¥æ”¶åˆ°æœåŠ¡ç«¯çš„ä¿¡æ¯ï¼Œéœ€è¦ç»™é€šé“è®¾ç½®è¯»çš„æƒé™ã€‚</div><div class="line">          channel.register(selector, SelectionKey.OP_READ);</div><div class="line"></div><div class="line">          // è·å¾—äº†å¯è¯»çš„äº‹ä»¶</div><div class="line">        &#125; else if (key.isReadable()) &#123;</div><div class="line">          read(key);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * å¤„ç†è¯»å–æœåŠ¡å™¨ç«¯å‘æ¥çš„ä¿¡æ¯ çš„äº‹ä»¶</div><div class="line">   * </div><div class="line">   * @param key</div><div class="line">   * @throws IOException</div><div class="line">   */</div><div class="line">  public void read(SelectionKey key) throws IOException &#123;</div><div class="line">    // æœåŠ¡å™¨å¯è¯»å–æ¶ˆæ¯:å¾—åˆ°äº‹ä»¶å‘ç”Ÿçš„Socketé€šé“</div><div class="line">    SocketChannel channel = (SocketChannel) key.channel();</div><div class="line">    // åˆ›å»ºè¯»å–çš„ç¼“å†²åŒº</div><div class="line">    ByteBuffer buffer = ByteBuffer.allocate(1024);</div><div class="line">    channel.read(buffer);</div><div class="line">    byte[] data = buffer.array();</div><div class="line">    String msg = new String(data);</div><div class="line">    System.out.println(&quot;å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨ä¿¡æ¯:&quot; + msg);</div><div class="line">    ByteBuffer outBuffer = ByteBuffer.wrap(new String(&quot;å®¢æˆ·ç«¯å‘é€æœåŠ¡å™¨æ¶ˆæ¯: hello&quot;).getBytes());</div><div class="line">    channel.write(outBuffer);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // å®¢æˆ·ç«¯æµ‹è¯•</div><div class="line">  public static void main(String[] args) throws IOException &#123;</div><div class="line">    NIOClient nioClient = new NIOClient();</div><div class="line">    nioClient.initClient(&quot;127.0.0.1&quot;, 8000);</div><div class="line">    nioClient.listen();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MapReducer]]></title>
      <url>http://zsr.github.io/2016/08/02/MapReducer/</url>
      <content type="html"><![CDATA[<h1 id="MapReducerç¬”è®°"><a href="#MapReducerç¬”è®°" class="headerlink" title="MapReducerç¬”è®°"></a>MapReducerç¬”è®°</h1><h3 id="å‚å…¥mapreduceä½œä¸šæ‰§è¡Œæ¶‰åŠ4ä¸ªç‹¬ç«‹çš„å®ä½“ï¼š"><a href="#å‚å…¥mapreduceä½œä¸šæ‰§è¡Œæ¶‰åŠ4ä¸ªç‹¬ç«‹çš„å®ä½“ï¼š" class="headerlink" title="å‚å…¥mapreduceä½œä¸šæ‰§è¡Œæ¶‰åŠ4ä¸ªç‹¬ç«‹çš„å®ä½“ï¼š"></a>å‚å…¥mapreduceä½œä¸šæ‰§è¡Œæ¶‰åŠ4ä¸ªç‹¬ç«‹çš„å®ä½“ï¼š</h3><ul>
<li><p>å®¢æˆ·ç«¯ï¼ˆclientï¼‰ï¼šç¼–å†™mapreduceç¨‹åºï¼Œé…ç½®ä½œä¸šï¼Œæäº¤ä½œä¸šï¼Œè¿™å°±æ˜¯ç¨‹åºå‘˜å®Œæˆçš„å·¥ä½œï¼›</p>
</li>
<li><p>JobTrackerï¼šåˆå§‹åŒ–ä½œä¸šï¼Œåˆ†é…ä½œä¸šï¼Œä¸TaskTrackeré€šä¿¡ï¼Œåè°ƒæ•´ä¸ªä½œä¸šçš„æ‰§è¡Œï¼›</p>
</li>
<li><p>TaskTrackerï¼šä¿æŒä¸JobTrackerçš„é€šä¿¡ï¼Œåœ¨åˆ†é…çš„æ•°æ®ç‰‡æ®µä¸Šæ‰§è¡ŒMapæˆ–Reduceä»»åŠ¡ï¼ŒTaskTrackerå’ŒJobTrackerçš„ä¸åŒæœ‰ä¸ªå¾ˆé‡è¦çš„æ–¹é¢ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œä»»åŠ¡æ—¶å€™TaskTrackerå¯ä»¥æœ‰nå¤šä¸ªï¼ŒJobTrackeråˆ™åªä¼šæœ‰ä¸€ä¸ª</p>
</li>
<li><p>Hdfsï¼šä¿å­˜ä½œä¸šçš„æ•°æ®ã€é…ç½®ä¿¡æ¯ç­‰ç­‰ï¼Œæœ€åçš„ç»“æœä¹Ÿæ˜¯ä¿å­˜åœ¨hdfsä¸Šé¢</p>
</li>
</ul>
<p><img src="/images/MapReducer.jpg"></p>
<a id="more"></a>
<h3 id="mapreduceè¿è¡Œè¿‡ç¨‹"><a href="#mapreduceè¿è¡Œè¿‡ç¨‹" class="headerlink" title="mapreduceè¿è¡Œè¿‡ç¨‹"></a>mapreduceè¿è¡Œè¿‡ç¨‹</h3><ul>
<li><p>é¦–å…ˆæ˜¯å®¢æˆ·ç«¯è¦ç¼–å†™å¥½mapreduceç¨‹åºï¼Œé…ç½®å¥½mapreduceçš„ä½œä¸šä¹Ÿå°±æ˜¯jobï¼Œæ¥ä¸‹æ¥å°±æ˜¯æäº¤jobäº†ï¼Œæäº¤jobæ˜¯æäº¤åˆ°JobTrackerä¸Šçš„ï¼Œè¿™ä¸ªæ—¶å€™JobTrackerå°±ä¼šæ„å»ºè¿™ä¸ªjobï¼Œå…·ä½“å°±æ˜¯åˆ†é…ä¸€ä¸ªæ–°çš„jobä»»åŠ¡çš„IDå€¼ï¼Œæ¥ä¸‹æ¥å®ƒä¼šåšæ£€æŸ¥æ“ä½œï¼Œè¿™ä¸ªæ£€æŸ¥å°±æ˜¯ç¡®å®šè¾“å‡ºç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨é‚£ä¹ˆjobå°±ä¸èƒ½æ­£å¸¸è¿è¡Œä¸‹å»ï¼ŒJobTrackerä¼šæŠ›å‡ºé”™è¯¯ç»™å®¢æˆ·ç«¯ï¼Œæ¥ä¸‹æ¥è¿˜è¦æ£€æŸ¥è¾“å…¥ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åŒæ ·æŠ›å‡ºé”™è¯¯ï¼Œå¦‚æœå­˜åœ¨JobTrackerä¼šæ ¹æ®è¾“å…¥è®¡ç®—è¾“å…¥åˆ†ç‰‡ï¼ˆInput Splitï¼‰ï¼Œå¦‚æœåˆ†ç‰‡è®¡ç®—ä¸å‡ºæ¥ä¹Ÿä¼šæŠ›å‡ºé”™è¯¯ï¼Œè‡³äºè¾“å…¥åˆ†ç‰‡æˆ‘åé¢ä¼šåšè®²è§£çš„ï¼Œè¿™äº›éƒ½åšå¥½äº†JobTrackerå°±ä¼šé…ç½®Jobéœ€è¦çš„èµ„æºäº†ã€‚åˆ†é…å¥½èµ„æºåï¼ŒJobTrackerå°±ä¼šåˆå§‹åŒ–ä½œä¸šï¼Œåˆå§‹åŒ–ä¸»è¦åšçš„æ˜¯å°†Jobæ”¾å…¥ä¸€ä¸ªå†…éƒ¨çš„é˜Ÿåˆ—ï¼Œè®©é…ç½®å¥½çš„ä½œä¸šè°ƒåº¦å™¨èƒ½è°ƒåº¦åˆ°è¿™ä¸ªä½œä¸šï¼Œä½œä¸šè°ƒåº¦å™¨ä¼šåˆå§‹åŒ–è¿™ä¸ªjobï¼Œåˆå§‹åŒ–å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„jobå¯¹è±¡ï¼ˆå°è£…ä»»åŠ¡å’Œè®°å½•ä¿¡æ¯ï¼‰ï¼Œä»¥ä¾¿JobTrackerè·Ÿè¸ªjobçš„çŠ¶æ€å’Œè¿›ç¨‹ã€‚</p>
</li>
<li><p>åˆå§‹åŒ–å®Œæ¯•åï¼Œä½œä¸šè°ƒåº¦å™¨ä¼šè·å–è¾“å…¥åˆ†ç‰‡ä¿¡æ¯ï¼ˆinput splitï¼‰ï¼Œæ¯ä¸ªåˆ†ç‰‡åˆ›å»ºä¸€ä¸ªmapä»»åŠ¡ã€‚æ¥ä¸‹æ¥å°±æ˜¯ä»»åŠ¡åˆ†é…äº†ï¼Œè¿™ä¸ªæ—¶å€™tasktrackerä¼šè¿è¡Œä¸€ä¸ªç®€å•çš„å¾ªç¯æœºåˆ¶å®šæœŸå‘é€å¿ƒè·³ç»™jobtrackerï¼Œå¿ƒè·³é—´éš”æ˜¯5ç§’ï¼Œç¨‹åºå‘˜å¯ä»¥é…ç½®è¿™ä¸ªæ—¶é—´ï¼Œå¿ƒè·³å°±æ˜¯jobtrackerå’Œtasktrackeræ²Ÿé€šçš„æ¡¥æ¢ï¼Œé€šè¿‡å¿ƒè·³ï¼Œjobtrackerå¯ä»¥ç›‘æ§tasktrackeræ˜¯å¦å­˜æ´»ï¼Œä¹Ÿå¯ä»¥è·å–tasktrackerå¤„ç†çš„çŠ¶æ€å’Œé—®é¢˜ï¼ŒåŒæ—¶tasktrackerä¹Ÿå¯ä»¥é€šè¿‡å¿ƒè·³é‡Œçš„è¿”å›å€¼è·å–jobtrackerç»™å®ƒçš„æ“ä½œæŒ‡ä»¤ã€‚ä»»åŠ¡åˆ†é…å¥½åå°±æ˜¯æ‰§è¡Œä»»åŠ¡äº†ã€‚åœ¨ä»»åŠ¡æ‰§è¡Œæ—¶å€™jobtrackerå¯ä»¥é€šè¿‡å¿ƒè·³æœºåˆ¶ç›‘æ§tasktrackerçš„çŠ¶æ€å’Œè¿›åº¦ï¼ŒåŒæ—¶ä¹Ÿèƒ½è®¡ç®—å‡ºæ•´ä¸ªjobçš„çŠ¶æ€å’Œè¿›åº¦ï¼Œè€Œtasktrackerä¹Ÿå¯ä»¥æœ¬åœ°ç›‘æ§è‡ªå·±çš„çŠ¶æ€å’Œè¿›åº¦ã€‚å½“jobtrackerè·å¾—äº†æœ€åä¸€ä¸ªå®ŒæˆæŒ‡å®šä»»åŠ¡çš„tasktrackeræ“ä½œæˆåŠŸçš„é€šçŸ¥æ—¶å€™ï¼Œjobtrackerä¼šæŠŠæ•´ä¸ªjobçŠ¶æ€ç½®ä¸ºæˆåŠŸï¼Œç„¶åå½“å®¢æˆ·ç«¯æŸ¥è¯¢jobè¿è¡ŒçŠ¶æ€æ—¶å€™ï¼ˆæ³¨æ„ï¼šè¿™ä¸ªæ˜¯å¼‚æ­¥æ“ä½œï¼‰ï¼Œå®¢æˆ·ç«¯ä¼šæŸ¥åˆ°jobå®Œæˆçš„é€šçŸ¥çš„ã€‚å¦‚æœjobä¸­é€”å¤±è´¥ï¼Œmapreduceä¹Ÿä¼šæœ‰ç›¸åº”æœºåˆ¶å¤„ç†ï¼Œä¸€èˆ¬è€Œè¨€å¦‚æœä¸æ˜¯ç¨‹åºå‘˜ç¨‹åºæœ¬èº«æœ‰bugï¼Œmapreduceé”™è¯¯å¤„ç†æœºåˆ¶éƒ½èƒ½ä¿è¯æäº¤çš„jobèƒ½æ­£å¸¸å®Œæˆã€‚</p>
</li>
</ul>
<h5 id="ä»é€»è¾‘å®ä½“çš„è§’åº¦è®²è§£mapreduceè¿è¡Œæœºåˆ¶ï¼Œè¿™äº›æŒ‰ç…§æ—¶é—´é¡ºåºåŒ…æ‹¬ï¼šè¾“å…¥åˆ†ç‰‡ï¼ˆinput-splitï¼‰ã€mapé˜¶æ®µã€combineré˜¶æ®µã€shuffleé˜¶æ®µå’Œreduceé˜¶æ®µã€‚"><a href="#ä»é€»è¾‘å®ä½“çš„è§’åº¦è®²è§£mapreduceè¿è¡Œæœºåˆ¶ï¼Œè¿™äº›æŒ‰ç…§æ—¶é—´é¡ºåºåŒ…æ‹¬ï¼šè¾“å…¥åˆ†ç‰‡ï¼ˆinput-splitï¼‰ã€mapé˜¶æ®µã€combineré˜¶æ®µã€shuffleé˜¶æ®µå’Œreduceé˜¶æ®µã€‚" class="headerlink" title="ä»é€»è¾‘å®ä½“çš„è§’åº¦è®²è§£mapreduceè¿è¡Œæœºåˆ¶ï¼Œè¿™äº›æŒ‰ç…§æ—¶é—´é¡ºåºåŒ…æ‹¬ï¼šè¾“å…¥åˆ†ç‰‡ï¼ˆinput splitï¼‰ã€mapé˜¶æ®µã€combineré˜¶æ®µã€shuffleé˜¶æ®µå’Œreduceé˜¶æ®µã€‚"></a>ä»é€»è¾‘å®ä½“çš„è§’åº¦è®²è§£mapreduceè¿è¡Œæœºåˆ¶ï¼Œè¿™äº›æŒ‰ç…§æ—¶é—´é¡ºåºåŒ…æ‹¬ï¼šè¾“å…¥åˆ†ç‰‡ï¼ˆinput splitï¼‰ã€mapé˜¶æ®µã€combineré˜¶æ®µã€shuffleé˜¶æ®µå’Œreduceé˜¶æ®µã€‚</h5><ol>
<li>è¾“å…¥åˆ†ç‰‡ï¼ˆinput splitï¼‰ï¼šåœ¨è¿›è¡Œmapè®¡ç®—ä¹‹å‰ï¼Œmapreduceä¼šæ ¹æ®è¾“å…¥æ–‡ä»¶è®¡ç®—è¾“å…¥åˆ†ç‰‡ï¼ˆinput splitï¼‰ï¼Œæ¯ä¸ªè¾“å…¥åˆ†ç‰‡ï¼ˆinput splitï¼‰é’ˆå¯¹ä¸€ä¸ªmapä»»åŠ¡ï¼Œè¾“å…¥åˆ†ç‰‡ï¼ˆinput splitï¼‰å­˜å‚¨çš„å¹¶éæ•°æ®æœ¬èº«ï¼Œè€Œæ˜¯ä¸€ä¸ªåˆ†ç‰‡é•¿åº¦å’Œä¸€ä¸ªè®°å½•æ•°æ®çš„ä½ç½®çš„æ•°ç»„ï¼Œè¾“å…¥åˆ†ç‰‡ï¼ˆinput splitï¼‰å¾€å¾€å’Œhdfsçš„blockï¼ˆå—ï¼‰å…³ç³»å¾ˆå¯†åˆ‡ï¼Œå‡å¦‚æˆ‘ä»¬è®¾å®šhdfsçš„å—çš„å¤§å°æ˜¯64mbï¼Œå¦‚æœæˆ‘ä»¬è¾“å…¥æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼Œå¤§å°åˆ†åˆ«æ˜¯3mbã€65mbå’Œ127mbï¼Œé‚£ä¹ˆmapreduceä¼šæŠŠ3mbæ–‡ä»¶åˆ†ä¸ºä¸€ä¸ªè¾“å…¥åˆ†ç‰‡ï¼ˆinput splitï¼‰ï¼Œ65mbåˆ™æ˜¯ä¸¤ä¸ªè¾“å…¥åˆ†ç‰‡ï¼ˆinput splitï¼‰è€Œ127mbä¹Ÿæ˜¯ä¸¤ä¸ªè¾“å…¥åˆ†ç‰‡ï¼ˆinput splitï¼‰ï¼Œæ¢å¥è¯è¯´æˆ‘ä»¬å¦‚æœåœ¨mapè®¡ç®—å‰åšè¾“å…¥åˆ†ç‰‡è°ƒæ•´ï¼Œä¾‹å¦‚åˆå¹¶å°æ–‡ä»¶ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰5ä¸ªmapä»»åŠ¡å°†æ‰§è¡Œï¼Œè€Œä¸”æ¯ä¸ªmapæ‰§è¡Œçš„æ•°æ®å¤§å°ä¸å‡ï¼Œè¿™ä¸ªä¹Ÿæ˜¯mapreduceä¼˜åŒ–è®¡ç®—çš„ä¸€ä¸ªå…³é”®ç‚¹ã€‚</li>
</ol>
<ol>
<li><p>mapé˜¶æ®µï¼šå°±æ˜¯ç¨‹åºå‘˜ç¼–å†™å¥½çš„mapå‡½æ•°äº†ï¼Œå› æ­¤mapå‡½æ•°æ•ˆç‡ç›¸å¯¹å¥½æ§åˆ¶ï¼Œè€Œä¸”ä¸€èˆ¬mapæ“ä½œéƒ½æ˜¯æœ¬åœ°åŒ–æ“ä½œä¹Ÿå°±æ˜¯åœ¨æ•°æ®å­˜å‚¨èŠ‚ç‚¹ä¸Šè¿›è¡Œï¼›</p>
</li>
<li><p>combineré˜¶æ®µï¼šcombineré˜¶æ®µæ˜¯ç¨‹åºå‘˜å¯ä»¥é€‰æ‹©çš„ï¼Œcombinerå…¶å®ä¹Ÿæ˜¯ä¸€ç§reduceæ“ä½œï¼Œå› æ­¤æˆ‘ä»¬çœ‹è§WordCountç±»é‡Œæ˜¯ç”¨reduceè¿›è¡ŒåŠ è½½çš„ã€‚Combineræ˜¯ä¸€ä¸ªæœ¬åœ°åŒ–çš„reduceæ“ä½œï¼Œå®ƒæ˜¯mapè¿ç®—çš„åç»­æ“ä½œï¼Œä¸»è¦æ˜¯åœ¨mapè®¡ç®—å‡ºä¸­é—´æ–‡ä»¶å‰åšä¸€ä¸ªç®€å•çš„åˆå¹¶é‡å¤keyå€¼çš„æ“ä½œï¼Œä¾‹å¦‚æˆ‘ä»¬å¯¹æ–‡ä»¶é‡Œçš„å•è¯é¢‘ç‡åšç»Ÿè®¡ï¼Œmapè®¡ç®—æ—¶å€™å¦‚æœç¢°åˆ°ä¸€ä¸ªhadoopçš„å•è¯å°±ä¼šè®°å½•ä¸º1ï¼Œä½†æ˜¯è¿™ç¯‡æ–‡ç« é‡Œhadoopå¯èƒ½ä¼šå‡ºç°nå¤šæ¬¡ï¼Œé‚£ä¹ˆmapè¾“å‡ºæ–‡ä»¶å†—ä½™å°±ä¼šå¾ˆå¤šï¼Œå› æ­¤åœ¨reduceè®¡ç®—å‰å¯¹ç›¸åŒçš„keyåšä¸€ä¸ªåˆå¹¶æ“ä½œï¼Œé‚£ä¹ˆæ–‡ä»¶ä¼šå˜å°ï¼Œè¿™æ ·å°±æé«˜äº†å®½å¸¦çš„ä¼ è¾“æ•ˆç‡ï¼Œæ¯•ç«Ÿhadoopè®¡ç®—åŠ›å®½å¸¦èµ„æºå¾€å¾€æ˜¯è®¡ç®—çš„ç“¶é¢ˆä¹Ÿæ˜¯æœ€ä¸ºå®è´µçš„èµ„æºï¼Œä½†æ˜¯combineræ“ä½œæ˜¯æœ‰é£é™©çš„ï¼Œä½¿ç”¨å®ƒçš„åŸåˆ™æ˜¯combinerçš„è¾“å…¥ä¸ä¼šå½±å“åˆ°reduceè®¡ç®—çš„æœ€ç»ˆè¾“å…¥ï¼Œä¾‹å¦‚ï¼šå¦‚æœè®¡ç®—åªæ˜¯æ±‚æ€»æ•°ï¼Œæœ€å¤§å€¼ï¼Œæœ€å°å€¼å¯ä»¥ä½¿ç”¨combinerï¼Œä½†æ˜¯åšå¹³å‡å€¼è®¡ç®—ä½¿ç”¨combinerçš„è¯ï¼Œæœ€ç»ˆçš„reduceè®¡ç®—ç»“æœå°±ä¼šå‡ºé”™ã€‚</p>
</li>
<li><p>shuffleé˜¶æ®µï¼šå°†mapçš„è¾“å‡ºä½œä¸ºreduceçš„è¾“å…¥çš„è¿‡ç¨‹å°±æ˜¯shuffleäº†ï¼Œè¿™ä¸ªæ˜¯mapreduceä¼˜åŒ–çš„é‡ç‚¹åœ°æ–¹ã€‚è¿™é‡Œæˆ‘ä¸è®²æ€ä¹ˆä¼˜åŒ–shuffleé˜¶æ®µï¼Œè®²è®²shuffleé˜¶æ®µçš„åŸç†ï¼Œå› ä¸ºå¤§éƒ¨åˆ†çš„ä¹¦ç±é‡Œéƒ½æ²¡è®²æ¸…æ¥šshuffleé˜¶æ®µã€‚Shuffleä¸€å¼€å§‹å°±æ˜¯mapé˜¶æ®µåšè¾“å‡ºæ“ä½œï¼Œä¸€èˆ¬mapreduceè®¡ç®—çš„éƒ½æ˜¯æµ·é‡æ•°æ®ï¼Œmapè¾“å‡ºæ—¶å€™ä¸å¯èƒ½æŠŠæ‰€æœ‰æ–‡ä»¶éƒ½æ”¾åˆ°å†…å­˜æ“ä½œï¼Œå› æ­¤mapå†™å…¥ç£ç›˜çš„è¿‡ç¨‹ååˆ†çš„å¤æ‚ï¼Œæ›´ä½•å†µmapè¾“å‡ºæ—¶å€™è¦å¯¹ç»“æœè¿›è¡Œæ’åºï¼Œå†…å­˜å¼€é”€æ˜¯å¾ˆå¤§çš„ï¼Œmapåœ¨åšè¾“å‡ºæ—¶å€™ä¼šåœ¨å†…å­˜é‡Œå¼€å¯ä¸€ä¸ªç¯å½¢å†…å­˜ç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºä¸“é—¨ç”¨æ¥è¾“å‡ºçš„ï¼Œé»˜è®¤å¤§å°æ˜¯100mbï¼Œå¹¶ä¸”åœ¨é…ç½®æ–‡ä»¶é‡Œä¸ºè¿™ä¸ªç¼“å†²åŒºè®¾å®šäº†ä¸€ä¸ªé˜€å€¼ï¼Œé»˜è®¤æ˜¯0.80ï¼ˆè¿™ä¸ªå¤§å°å’Œé˜€å€¼éƒ½æ˜¯å¯ä»¥åœ¨é…ç½®æ–‡ä»¶é‡Œè¿›è¡Œé…ç½®çš„ï¼‰ï¼ŒåŒæ—¶mapè¿˜ä¼šä¸ºè¾“å‡ºæ“ä½œå¯åŠ¨ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼Œå¦‚æœç¼“å†²åŒºçš„å†…å­˜è¾¾åˆ°äº†é˜€å€¼çš„80%æ—¶å€™ï¼Œè¿™ä¸ªå®ˆæŠ¤çº¿ç¨‹å°±ä¼šæŠŠå†…å®¹å†™åˆ°ç£ç›˜ä¸Šï¼Œè¿™ä¸ªè¿‡ç¨‹å«spillï¼Œå¦å¤–çš„20%å†…å­˜å¯ä»¥ç»§ç»­å†™å…¥è¦å†™è¿›ç£ç›˜çš„æ•°æ®ï¼Œå†™å…¥ç£ç›˜å’Œå†™å…¥å†…å­˜æ“ä½œæ˜¯äº’ä¸å¹²æ‰°çš„ï¼Œå¦‚æœç¼“å­˜åŒºè¢«æ’‘æ»¡äº†ï¼Œé‚£ä¹ˆmapå°±ä¼šé˜»å¡å†™å…¥å†…å­˜çš„æ“ä½œï¼Œè®©å†™å…¥ç£ç›˜æ“ä½œå®Œæˆåå†ç»§ç»­æ‰§è¡Œå†™å…¥å†…å­˜æ“ä½œï¼Œå‰é¢æˆ‘è®²åˆ°å†™å…¥ç£ç›˜å‰ä¼šæœ‰ä¸ªæ’åºæ“ä½œï¼Œè¿™ä¸ªæ˜¯åœ¨å†™å…¥ç£ç›˜æ“ä½œæ—¶å€™è¿›è¡Œï¼Œä¸æ˜¯åœ¨å†™å…¥å†…å­˜æ—¶å€™è¿›è¡Œçš„ï¼Œå¦‚æœæˆ‘ä»¬å®šä¹‰äº†combinerå‡½æ•°ï¼Œé‚£ä¹ˆæ’åºå‰è¿˜ä¼šæ‰§è¡Œcombineræ“ä½œã€‚<br>æ¯æ¬¡spillæ“ä½œä¹Ÿå°±æ˜¯å†™å…¥ç£ç›˜æ“ä½œæ—¶å€™å°±ä¼šå†™ä¸€ä¸ªæº¢å‡ºæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨åšmapè¾“å‡ºæœ‰å‡ æ¬¡spillå°±ä¼šäº§ç”Ÿå¤šå°‘ä¸ªæº¢å‡ºæ–‡ä»¶ï¼Œç­‰mapè¾“å‡ºå…¨éƒ¨åšå®Œåï¼Œmapä¼šåˆå¹¶è¿™äº›è¾“å‡ºæ–‡ä»¶ã€‚è¿™ä¸ªè¿‡ç¨‹é‡Œè¿˜ä¼šæœ‰ä¸€ä¸ªPartitioneræ“ä½œï¼Œå¯¹äºè¿™ä¸ªæ“ä½œå¾ˆå¤šäººéƒ½å¾ˆè¿·ç³Šï¼Œå…¶å®Partitioneræ“ä½œå’Œmapé˜¶æ®µçš„è¾“å…¥åˆ†ç‰‡ï¼ˆInput splitï¼‰å¾ˆåƒï¼Œä¸€ä¸ªPartitionerå¯¹åº”ä¸€ä¸ªreduceä½œä¸šï¼Œå¦‚æœæˆ‘ä»¬mapreduceæ“ä½œåªæœ‰ä¸€ä¸ªreduceæ“ä½œï¼Œé‚£ä¹ˆPartitionerå°±åªæœ‰ä¸€ä¸ªï¼Œå¦‚æœæˆ‘ä»¬æœ‰å¤šä¸ªreduceæ“ä½œï¼Œé‚£ä¹ˆPartitionerå¯¹åº”çš„å°±ä¼šæœ‰å¤šä¸ªï¼ŒPartitionerå› æ­¤å°±æ˜¯reduceçš„è¾“å…¥åˆ†ç‰‡ï¼Œè¿™ä¸ªç¨‹åºå‘˜å¯ä»¥ç¼–ç¨‹æ§åˆ¶ï¼Œä¸»è¦æ˜¯æ ¹æ®å®é™…keyå’Œvalueçš„å€¼ï¼Œæ ¹æ®å®é™…ä¸šåŠ¡ç±»å‹æˆ–è€…ä¸ºäº†æ›´å¥½çš„reduceè´Ÿè½½å‡è¡¡è¦æ±‚è¿›è¡Œï¼Œè¿™æ˜¯æé«˜reduceæ•ˆç‡çš„ä¸€ä¸ªå…³é”®æ‰€åœ¨ã€‚åˆ°äº†reduceé˜¶æ®µå°±æ˜¯åˆå¹¶mapè¾“å‡ºæ–‡ä»¶äº†ï¼ŒPartitionerä¼šæ‰¾åˆ°å¯¹åº”çš„mapè¾“å‡ºæ–‡ä»¶ï¼Œç„¶åè¿›è¡Œå¤åˆ¶æ“ä½œï¼Œå¤åˆ¶æ“ä½œæ—¶reduceä¼šå¼€å¯å‡ ä¸ªå¤åˆ¶çº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹é»˜è®¤ä¸ªæ•°æ˜¯5ä¸ªï¼Œç¨‹åºå‘˜ä¹Ÿå¯ä»¥åœ¨é…ç½®æ–‡ä»¶æ›´æ”¹å¤åˆ¶çº¿ç¨‹çš„ä¸ªæ•°ï¼Œè¿™ä¸ªå¤åˆ¶è¿‡ç¨‹å’Œmapå†™å…¥ç£ç›˜è¿‡ç¨‹ç±»ä¼¼ï¼Œä¹Ÿæœ‰é˜€å€¼å’Œå†…å­˜å¤§å°ï¼Œé˜€å€¼ä¸€æ ·å¯ä»¥åœ¨é…ç½®æ–‡ä»¶é‡Œé…ç½®ï¼Œè€Œå†…å­˜å¤§å°æ˜¯ç›´æ¥ä½¿ç”¨reduceçš„tasktrackerçš„å†…å­˜å¤§å°ï¼Œå¤åˆ¶æ—¶å€™reduceè¿˜ä¼šè¿›è¡Œæ’åºæ“ä½œå’Œåˆå¹¶æ–‡ä»¶æ“ä½œï¼Œè¿™äº›æ“ä½œå®Œäº†å°±ä¼šè¿›è¡Œreduceè®¡ç®—äº†ã€‚</p>
</li>
<li><p>reduceé˜¶æ®µï¼šå’Œmapå‡½æ•°ä¸€æ ·ä¹Ÿæ˜¯ç¨‹åºå‘˜ç¼–å†™çš„ï¼Œæœ€ç»ˆç»“æœæ˜¯å­˜å‚¨åœ¨hdfsä¸Šçš„ã€‚</p>
</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[JavaåŠ¨æ€ä»£ç†]]></title>
      <url>http://zsr.github.io/2016/08/01/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/</url>
      <content type="html"><![CDATA[<h1 id="JavaåŠ¨æ€ä»£ç†"><a href="#JavaåŠ¨æ€ä»£ç†" class="headerlink" title="JavaåŠ¨æ€ä»£ç†"></a>JavaåŠ¨æ€ä»£ç†</h1><hr>
<h6 id="Spring-AOPä½¿ç”¨åŠ¨æ€ä»£ç†æŠ€æœ¯åœ¨è¿è¡ŒæœŸç»‡å…¥å¢å¼ºçš„ä»£ç ï¼Œä¸ºäº†æ­ç¤ºSpring-AOPåº•å±‚çš„å·¥ä½œæœºç†ï¼Œæœ‰å¿…è¦å¯¹æ¶‰åŠåˆ°çš„JavaçŸ¥è¯†è¿›è¡Œå­¦ä¹ ã€‚Spring-AOPä½¿ç”¨äº†ä¸¤ç§ä»£ç†æœºåˆ¶ï¼šä¸€ç§æ˜¯åŸºäºJDKçš„åŠ¨æ€ä»£ç†ï¼›å¦ä¸€ç§æ˜¯åŸºäºCGLibçš„åŠ¨æ€ä»£ç†ã€‚ä¹‹æ‰€ä»¥éœ€è¦ä¸¤ç§ä»£ç†æœºåˆ¶ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯å› ä¸ºJDKæœ¬èº«åªæä¾›æ¥å£çš„ä»£ç†ï¼Œè€Œä¸æ”¯æŒç±»çš„ä»£ç†ã€‚"><a href="#Spring-AOPä½¿ç”¨åŠ¨æ€ä»£ç†æŠ€æœ¯åœ¨è¿è¡ŒæœŸç»‡å…¥å¢å¼ºçš„ä»£ç ï¼Œä¸ºäº†æ­ç¤ºSpring-AOPåº•å±‚çš„å·¥ä½œæœºç†ï¼Œæœ‰å¿…è¦å¯¹æ¶‰åŠåˆ°çš„JavaçŸ¥è¯†è¿›è¡Œå­¦ä¹ ã€‚Spring-AOPä½¿ç”¨äº†ä¸¤ç§ä»£ç†æœºåˆ¶ï¼šä¸€ç§æ˜¯åŸºäºJDKçš„åŠ¨æ€ä»£ç†ï¼›å¦ä¸€ç§æ˜¯åŸºäºCGLibçš„åŠ¨æ€ä»£ç†ã€‚ä¹‹æ‰€ä»¥éœ€è¦ä¸¤ç§ä»£ç†æœºåˆ¶ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯å› ä¸ºJDKæœ¬èº«åªæä¾›æ¥å£çš„ä»£ç†ï¼Œè€Œä¸æ”¯æŒç±»çš„ä»£ç†ã€‚" class="headerlink" title="Spring AOPä½¿ç”¨åŠ¨æ€ä»£ç†æŠ€æœ¯åœ¨è¿è¡ŒæœŸç»‡å…¥å¢å¼ºçš„ä»£ç ï¼Œä¸ºäº†æ­ç¤ºSpring AOPåº•å±‚çš„å·¥ä½œæœºç†ï¼Œæœ‰å¿…è¦å¯¹æ¶‰åŠåˆ°çš„JavaçŸ¥è¯†è¿›è¡Œå­¦ä¹ ã€‚Spring AOPä½¿ç”¨äº†ä¸¤ç§ä»£ç†æœºåˆ¶ï¼šä¸€ç§æ˜¯åŸºäºJDKçš„åŠ¨æ€ä»£ç†ï¼›å¦ä¸€ç§æ˜¯åŸºäºCGLibçš„åŠ¨æ€ä»£ç†ã€‚ä¹‹æ‰€ä»¥éœ€è¦ä¸¤ç§ä»£ç†æœºåˆ¶ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯å› ä¸ºJDKæœ¬èº«åªæä¾›æ¥å£çš„ä»£ç†ï¼Œè€Œä¸æ”¯æŒç±»çš„ä»£ç†ã€‚"></a>Spring AOPä½¿ç”¨åŠ¨æ€ä»£ç†æŠ€æœ¯åœ¨è¿è¡ŒæœŸç»‡å…¥å¢å¼ºçš„ä»£ç ï¼Œä¸ºäº†æ­ç¤ºSpring AOPåº•å±‚çš„å·¥ä½œæœºç†ï¼Œæœ‰å¿…è¦å¯¹æ¶‰åŠåˆ°çš„JavaçŸ¥è¯†è¿›è¡Œå­¦ä¹ ã€‚Spring AOPä½¿ç”¨äº†ä¸¤ç§ä»£ç†æœºåˆ¶ï¼šä¸€ç§æ˜¯åŸºäºJDKçš„åŠ¨æ€ä»£ç†ï¼›å¦ä¸€ç§æ˜¯åŸºäºCGLibçš„åŠ¨æ€ä»£ç†ã€‚ä¹‹æ‰€ä»¥éœ€è¦ä¸¤ç§ä»£ç†æœºåˆ¶ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯å› ä¸ºJDKæœ¬èº«åªæä¾›æ¥å£çš„ä»£ç†ï¼Œè€Œä¸æ”¯æŒç±»çš„ä»£ç†ã€‚</h6><h5 id="å¸¦æœ‰æ¨ªåˆ‡é€»è¾‘çš„å®ä¾‹"><a href="#å¸¦æœ‰æ¨ªåˆ‡é€»è¾‘çš„å®ä¾‹" class="headerlink" title="å¸¦æœ‰æ¨ªåˆ‡é€»è¾‘çš„å®ä¾‹"></a>å¸¦æœ‰æ¨ªåˆ‡é€»è¾‘çš„å®ä¾‹</h5><p>æˆ‘ä»¬é€šè¿‡å…·ä½“åŒ–ä»£ç å®ç°ä¸Šä¸€èŠ‚æ‰€ä»‹ç»ä¾‹å­çš„æ€§èƒ½ç›‘è§†æ¨ªåˆ‡é€»è¾‘ï¼Œå¹¶é€šè¿‡åŠ¨æ€ä»£ç†æŠ€æœ¯å¯¹æ­¤è¿›è¡Œæ”¹é€ ã€‚åœ¨è°ƒç”¨æ¯ä¸€ä¸ªç›®æ ‡ç±»æ–¹æ³•æ—¶å¯åŠ¨æ–¹æ³•çš„æ€§èƒ½ç›‘è§†ï¼Œåœ¨ç›®æ ‡ç±»æ–¹æ³•è°ƒç”¨å®Œæˆæ—¶è®°å½•æ–¹æ³•çš„èŠ±è´¹æ—¶é—´ã€‚ </p>
<p>ä»£ç æ¸…å•6-2  ForumServiceï¼šåŒ…å«æ€§èƒ½ç›‘è§†æ¨ªåˆ‡ä»£ç <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">package com.baobaotao.proxy;  </div><div class="line">public class ForumServiceImpl implements ForumService &#123;  </div><div class="line">    public void removeTopic(int topicId) &#123;          </div><div class="line">         //â‘ -1å¼€å§‹å¯¹è¯¥æ–¹æ³•è¿›è¡Œæ€§èƒ½ç›‘è§†  </div><div class="line">        PerformanceMonitor.begin(  </div><div class="line">                            &quot;com.baobaotao.proxy.ForumServiceImpl. removeTopic&quot;);  </div><div class="line">        System.out.println(&quot;æ¨¡æ‹Ÿåˆ é™¤Topicè®°å½•:&quot;+topicId);  </div><div class="line">        try &#123;  </div><div class="line">            Thread.currentThread().sleep(20);  </div><div class="line">        &#125; catch (Exception e) &#123;  </div><div class="line">            throw new RuntimeException(e);  </div><div class="line">        &#125;         </div><div class="line">         //â‘ -2ç»“æŸå¯¹è¯¥æ–¹æ³•è¿›è¡Œæ€§èƒ½ç›‘è§†  </div><div class="line">        PerformanceMonitor.end();  </div><div class="line">    &#125;  </div><div class="line">    public void removeForum(int forumId) &#123;  </div><div class="line">          //â‘¡-1å¼€å§‹å¯¹è¯¥æ–¹æ³•è¿›è¡Œæ€§èƒ½ç›‘è§†  </div><div class="line">        PerformanceMonitor.begin(  </div><div class="line">&quot;com.baobaotao.proxy.ForumServiceImpl. removeForum&quot;);  </div><div class="line">        System.out.println(&quot;æ¨¡æ‹Ÿåˆ é™¤Forumè®°å½•:&quot;+forumId);  </div><div class="line">        try &#123;  </div><div class="line">            Thread.currentThread().sleep(40);  </div><div class="line">        &#125; catch (Exception e) &#123;  </div><div class="line">            throw new RuntimeException(e);  </div><div class="line">        &#125;         </div><div class="line">         //â‘¡-2ç»“æŸå¯¹è¯¥æ–¹æ³•è¿›è¡Œæ€§èƒ½ç›‘è§†  </div><div class="line">        PerformanceMonitor.end();  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»£ç æ¸…å•6-2ä¸­ç²—ä½“è¡¨ç¤ºçš„ä»£ç å°±æ˜¯å…·æœ‰æ¨ªåˆ‡é€»è¾‘ç‰¹å¾çš„ä»£ç ï¼Œæ¯ä¸ªServiceç±»å’Œæ¯ä¸ªä¸šåŠ¡æ–¹æ³•ä½“çš„å‰åéƒ½æ‰§è¡Œç›¸åŒçš„ä»£ç é€»è¾‘ï¼šæ–¹æ³•è°ƒç”¨å‰å¯åŠ¨PerformanceMonitorï¼Œæ–¹æ³•è°ƒç”¨åé€šçŸ¥PerformanceMonitorç»“æŸæ€§èƒ½ç›‘è§†å¹¶ç»™è®°å½•æ€§èƒ½ç›‘è§†ç»“æœã€‚<br><a id="more"></a></p>
<p>PerformanceMonitoræ˜¯æ€§èƒ½ç›‘è§†çš„å®ç°ç±»ï¼Œæˆ‘ä»¬ç»™å‡ºä¸€ä¸ªéå¸¸ç®€å•çš„å®ç°ç‰ˆæœ¬ï¼Œå…¶ä»£ç å¦‚ä»£ç æ¸…å•6-3æ‰€ç¤ºï¼š </p>
<p>ä»£ç æ¸…å•6-3  PerformanceMonitor<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">package com.baobaotao.proxy;  </div><div class="line">public class PerformanceMonitor &#123;  </div><div class="line">     //â‘ é€šè¿‡ä¸€ä¸ªThreadLocalä¿å­˜è°ƒç”¨çº¿ç¨‹ç›¸å…³çš„æ€§èƒ½ç›‘è§†ä¿¡æ¯  </div><div class="line">    private static ThreadLocal&lt;MethodPerformace&gt; performanceRecord =          </div><div class="line">                                new ThreadLocal&lt;MethodPerformance&gt;();  </div><div class="line">    //â‘¡å¯åŠ¨å¯¹æŸä¸€ç›®æ ‡æ–¹æ³•çš„æ€§èƒ½ç›‘è§†  </div><div class="line">     public static void begin(String method) &#123;  </div><div class="line">        System.out.println(&quot;begin monitor...&quot;);  </div><div class="line">        MethodPerformance mp = new MethodPerformance(method);  </div><div class="line">        performanceRecord.set(mp);  </div><div class="line">    &#125;  </div><div class="line">    public static void end() &#123;  </div><div class="line">        System.out.println(&quot;end monitor...&quot;);  </div><div class="line">        MethodPerformance mp = performanceRecord.get();  </div><div class="line">         //â‘¢æ‰“å°å‡ºæ–¹æ³•æ€§èƒ½ç›‘è§†çš„ç»“æœä¿¡æ¯ã€‚  </div><div class="line">        mp.printPerformance();  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ThreadLocalæ˜¯å°†éçº¿ç¨‹å®‰å…¨ç±»æ”¹é€ ä¸ºçº¿ç¨‹å®‰å…¨ç±»çš„æ³•å®ï¼Œåœ¨9.2èŠ‚ä¸­æˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»è¿™ä¸ªJavaåŸºç¡€çŸ¥è¯†ã€‚PerformanceMonitoræä¾›äº†ä¸¤ä¸ªæ–¹æ³•ï¼šé€šè¿‡è°ƒç”¨begin(String method)æ–¹æ³•å¼€å§‹å¯¹æŸä¸ªç›®æ ‡ç±»æ–¹æ³•çš„ç›‘è§†ï¼Œmethodä¸ºç›®æ ‡ç±»æ–¹æ³•çš„å…¨é™å®šåï¼›è€Œend()æ–¹æ³•ç»“æŸå¯¹ç›®æ ‡ç±»æ–¹æ³•çš„ç›‘è§†ï¼Œå¹¶ç»™å‡ºæ€§èƒ½ç›‘è§†çš„ä¿¡æ¯ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•å¿…é¡»é…å¥—ä½¿ç”¨ã€‚ </p>
<p>ç”¨äºè®°å½•æ€§èƒ½ç›‘è§†ä¿¡æ¯çš„MethodPerformanceç±»çš„ä»£ç å¦‚æ‰€ç¤ºï¼š </p>
<p>ä»£ç æ¸…å•6-4  MethodPerformance<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">package com.baobaotao.proxy;  </div><div class="line">public class MethodPerformance &#123;  </div><div class="line">    private long begin;  </div><div class="line">    private long end;  </div><div class="line">    private String serviceMethod;  </div><div class="line">    public MethodPerformance(String serviceMethod)&#123;  </div><div class="line">       this.serviceMethod = serviceMethod;  </div><div class="line">       //â‘ è®°å½•ç›®æ ‡ç±»æ–¹æ³•å¼€å§‹æ‰§è¡Œç‚¹çš„ç³»ç»Ÿæ—¶é—´    </div><div class="line">       this.begin = System.currentTimeMillis();    </div><div class="line">    &#125;  </div><div class="line">    public void printPerformance()&#123;  </div><div class="line">        //â‘¡è·å–ç›®æ ‡ç±»æ–¹æ³•æ‰§è¡Œå®Œæˆåçš„ç³»ç»Ÿæ—¶é—´ï¼Œå¹¶è¿›è€Œè®¡ç®—å‡ºç›®æ ‡ç±»æ–¹æ³•æ‰§è¡Œæ—¶é—´  </div><div class="line">        end = System.currentTimeMillis();   </div><div class="line">        long elapse = end - begin;  </div><div class="line">        //â‘¢æŠ¥å‘Šç›®æ ‡ç±»æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´  </div><div class="line">        System.out.println(serviceMethod+&quot;èŠ±è´¹&quot;+elapse+&quot;æ¯«ç§’ã€‚&quot;);    </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>é€šè¿‡ä¸‹é¢çš„ä»£ç æµ‹è¯•æ‹¥æœ‰æ€§èƒ½ç›‘è§†èƒ½åŠ›çš„ForumServiceImplä¸šåŠ¡æ–¹æ³•ï¼š </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">package com.baobaotao.proxy; </div><div class="line">public class TestForumService &#123;  </div><div class="line">    public static void main(String[] args) &#123;  </div><div class="line">        ForumService forumService = new ForumServiceImpl();  </div><div class="line">        forumService .removeForum(10);  </div><div class="line">       forumService .removeTopic(1012);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹è¾“å‡ºä¿¡æ¯ï¼š </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">begin monitor... â‘ removeForum(10)æ–¹æ³•çš„æ€§èƒ½ç›‘è§†æŠ¥å‘Š </div><div class="line">æ¨¡æ‹Ÿåˆ é™¤Forumè®°å½•:10 </div><div class="line">end monitor... </div><div class="line">com.baobaotao.proxy.ForumServiceImpl.removeForumèŠ±è´¹47æ¯«ç§’ã€‚ </div><div class="line">begin monitor... â‘ removeTopic(1012)æ–¹æ³•çš„æ€§èƒ½ç›‘è§†æŠ¥å‘Š </div><div class="line">æ¨¡æ‹Ÿåˆ é™¤Topicè®°å½•:1012 </div><div class="line">end monitor... </div><div class="line">com.baobaotao.proxy.ForumServiceImpl.removeTopicèŠ±è´¹26æ¯«ç§’ã€‚</div></pre></td></tr></table></figure>
<p>æ­£å¦‚ä»£ç æ¸…å•6 2å®ä¾‹æ‰€ç¤ºï¼Œå½“æŸä¸ªæ–¹æ³•éœ€è¦è¿›è¡Œæ€§èƒ½ç›‘è§†ï¼Œå°±å¿…é¡»è°ƒæ•´æ–¹æ³•ä»£ç ï¼Œåœ¨æ–¹æ³•ä½“å‰ååˆ†åˆ«æ·»åŠ ä¸Šå¼€å¯æ€§èƒ½ç›‘è§†å’Œç»“æŸæ€§èƒ½ç›‘è§†çš„ä»£ç ã€‚è¿™äº›éä¸šåŠ¡é€»è¾‘çš„æ€§èƒ½ç›‘è§†ä»£ç ç ´åäº†ForumServiceImplä¸šåŠ¡é€»è¾‘çš„çº¯ç²¹æ€§ã€‚æˆ‘ä»¬å¸Œæœ›é€šè¿‡ä»£ç†çš„æ–¹å¼ï¼Œå°†ä¸šåŠ¡ç±»æ–¹æ³•ä¸­å¼€å¯å’Œç»“æŸæ€§èƒ½ç›‘è§†çš„è¿™äº›æ¨ªåˆ‡ä»£ç ä»ä¸šåŠ¡ç±»ä¸­å®Œå…¨ç§»é™¤ã€‚å¹¶é€šè¿‡JDKåŠ¨æ€ä»£ç†æŠ€æœ¯æˆ–CGLibåŠ¨æ€ä»£ç†æŠ€æœ¯å°†æ¨ªåˆ‡ä»£ç åŠ¨æ€ç»‡å…¥åˆ°ç›®æ ‡æ–¹æ³•çš„ç›¸åº”ä½ç½®ã€‚ </p>
<h3 id="JDKåŠ¨æ€ä»£ç†"><a href="#JDKåŠ¨æ€ä»£ç†" class="headerlink" title="JDKåŠ¨æ€ä»£ç†"></a>JDKåŠ¨æ€ä»£ç†</h3><p>JDK 1.3ä»¥åï¼ŒJavaæä¾›äº†åŠ¨æ€ä»£ç†çš„æŠ€æœ¯ï¼Œå…è®¸å¼€å‘è€…åœ¨è¿è¡ŒæœŸåˆ›å»ºæ¥å£çš„ä»£ç†å®ä¾‹ã€‚åœ¨Sunåˆšæ¨å‡ºåŠ¨æ€ä»£ç†æ—¶ï¼Œè¿˜å¾ˆéš¾æƒ³è±¡å®ƒæœ‰å¤šå¤§çš„å®é™…ç”¨é€”ï¼Œç°åœ¨æˆ‘ä»¬ç»ˆäºå‘ç°åŠ¨æ€ä»£ç†æ˜¯å®ç°AOPçš„ç»å¥½åº•å±‚æŠ€æœ¯ã€‚ </p>
<p>JDKçš„åŠ¨æ€ä»£ç†ä¸»è¦æ¶‰åŠåˆ°java.lang.reflectåŒ…ä¸­çš„ä¸¤ä¸ªç±»ï¼šProxyå’ŒInvocationHandlerã€‚å…¶ä¸­InvocationHandleræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥é€šè¿‡å®ç°è¯¥æ¥å£å®šä¹‰æ¨ªåˆ‡é€»è¾‘ï¼Œå¹¶é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨ç›®æ ‡ç±»çš„ä»£ç ï¼ŒåŠ¨æ€å°†æ¨ªåˆ‡é€»è¾‘å’Œä¸šåŠ¡é€»è¾‘ç¼–ç»‡åœ¨ä¸€èµ·ã€‚ </p>
<p>è€ŒProxyåˆ©ç”¨InvocationHandleråŠ¨æ€åˆ›å»ºä¸€ä¸ªç¬¦åˆæŸä¸€æ¥å£çš„å®ä¾‹ï¼Œç”Ÿæˆç›®æ ‡ç±»çš„ä»£ç†å¯¹è±¡ã€‚è¿™æ ·è®²ä¸€å®šå¾ˆæŠ½è±¡ï¼Œæˆ‘ä»¬é©¬ä¸Šç€æ‰‹ä½¿ç”¨Proxyå’ŒInvocationHandlerè¿™ä¸¤ä¸ªé­”æ³•æˆ’å¯¹ä¸Šä¸€èŠ‚ä¸­çš„æ€§èƒ½ç›‘è§†ä»£ç è¿›è¡Œé©æ–°ã€‚ </p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ä»ä¸šåŠ¡ç±»ForumServiceImplä¸­åˆ é™¤æ€§èƒ½ç›‘è§†çš„æ¨ªåˆ‡ä»£ç ï¼Œä½¿ForumServiceImplåªè´Ÿè´£å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¦‚ä»£ç æ¸…å•6-5æ‰€ç¤ºï¼š </p>
<p>ä»£ç æ¸…å•6-5  ForumServiceImplï¼šç§»é™¤æ€§èƒ½ç›‘è§†æ¨ªåˆ‡ä»£ç <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">package com.baobaotao.proxy;   </div><div class="line">public class ForumServiceImpl implements ForumService &#123;  </div><div class="line">    public void removeTopic(int topicId) &#123;                                </div><div class="line">                             â‘   </div><div class="line">        System.out.println(&quot;æ¨¡æ‹Ÿåˆ é™¤Topicè®°å½•:&quot;+topicId);  </div><div class="line">        try &#123;  </div><div class="line">            Thread.currentThread().sleep(20);  </div><div class="line">        &#125; catch (Exception e) &#123;  </div><div class="line">            throw new RuntimeException(e);  </div><div class="line">        &#125;  </div><div class="line">                             â‘   </div><div class="line">    &#125;  </div><div class="line">    public void removeForum(int forumId) &#123;  </div><div class="line">                          â‘¡  </div><div class="line">        System.out.println(&quot;æ¨¡æ‹Ÿåˆ é™¤Forumè®°å½•:&quot;+forumId);  </div><div class="line">        try &#123;  </div><div class="line">            Thread.currentThread().sleep(40);  </div><div class="line">        &#125; catch (Exception e) &#123;  </div><div class="line">            throw new RuntimeException(e);  </div><div class="line">        &#125;  </div><div class="line">                          â‘¡  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨ä»£ç æ¸…å•6-5ä¸­çš„â‘ å’Œâ‘¡å¤„ï¼ŒåŸæ¥çš„æ€§èƒ½ç›‘è§†ä»£ç è¢«ç§»é™¤äº†ï¼Œæˆ‘ä»¬åªä¿ç•™äº†çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ã€‚ </p>
<p>ä»ä¸šåŠ¡ç±»ä¸­ç§»é™¤çš„æ€§èƒ½ç›‘è§†æ¨ªåˆ‡ä»£ç å½“ç„¶ä¸èƒ½æ¼‚æµ®åœ¨ç©ºæ°”ä¸­ï¼Œå®ƒè¿˜å¾—æ‰¾åˆ°ä¸€ä¸ªå®‰èº«ä¹‹æ‰€ï¼ŒInvocationHandlerå°±æ˜¯æ¨ªåˆ‡ä»£ç çš„å®‰å®¶ä¹å›­ï¼Œæˆ‘ä»¬å°†æ€§èƒ½ç›‘è§†çš„ä»£ç å®‰ç½®åœ¨PerformanceHandlerä¸­ï¼Œå¦‚ä»£ç æ¸…å•6-6æ‰€ç¤ºï¼š </p>
<p>ä»£ç æ¸…å•6-6  PerformanceHandler<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">package com.baobaotao.proxy;  </div><div class="line">import java.lang.reflect.InvocationHandler;  </div><div class="line">import java.lang.reflect.Method;  </div><div class="line">public class PerformanceHandler implements InvocationHandler &#123;//â‘ å®ç°InvocationHandler  </div><div class="line">    private Object target;  </div><div class="line">    public PerformanceHandler(Object target)&#123; //â‘¡targetä¸ºç›®æ ‡çš„ä¸šåŠ¡ç±»  </div><div class="line">        this.target = target;  </div><div class="line">    &#125;  </div><div class="line">    public Object invoke(Object proxy, Method method, Object[] args) â‘¢  </div><div class="line">            throws Throwable &#123;  </div><div class="line">        PerformanceMonitor.begin(target.getClass().getName()+&quot;.&quot;+ method. getName());â‘¢-1  </div><div class="line">        Object obj = method.invoke(target, args);// â‘¢-2é€šè¿‡åå°„æ–¹æ³•è°ƒç”¨ä¸šåŠ¡ç±»çš„ç›®æ ‡æ–¹æ³•  </div><div class="line">        PerformanceMonitor.end();â‘¢-1  </div><div class="line">        return obj;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>â‘¢å¤„invoke()æ–¹æ³•ä¸­ç²—ä½“æ‰€ç¤ºéƒ¨åˆ†çš„ä»£ç ä¸ºæ€§èƒ½ç›‘è§†çš„æ¨ªåˆ‡ä»£ç ï¼Œæˆ‘ä»¬å‘ç°ï¼Œæ¨ªåˆ‡ä»£ç åªå‡ºç°ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯åŸæ¥é‚£æ ·æ˜Ÿæ´’å„å¤„ã€‚â‘¢-2å¤„çš„method.invoke()è¯­å¥é€šè¿‡Javaåå°„æœºåˆ¶é—´æ¥è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ï¼Œè¿™æ ·InvocationHandlerçš„invoke()æ–¹æ³•å°±å°†æ¨ªåˆ‡é€»è¾‘ä»£ç ï¼ˆâ‘¢-1ï¼‰å’Œä¸šåŠ¡ç±»æ–¹æ³•çš„ä¸šåŠ¡é€»è¾‘ä»£ç ï¼ˆâ‘¢-2ï¼‰ç¼–ç»‡åˆ°ä¸€èµ·äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†InvocationHandlerçœ‹æˆæ˜¯ä¸€ä¸ªç¼–ç»‡å™¨ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å¯¹è¿™æ®µä»£ç åšè¿›ä¸€æ­¥çš„è¯´æ˜ã€‚ </p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å®ç°InvocationHandleræ¥å£ï¼Œè¯¥æ¥å£å®šä¹‰äº†ä¸€ä¸ª invoke(Object proxy, Method method, Object[] args)çš„æ–¹æ³•ï¼Œproxyæ˜¯æœ€ç»ˆç”Ÿæˆçš„ä»£ç†å®ä¾‹ï¼Œä¸€èˆ¬ä¸ä¼šç”¨åˆ°ï¼›methodæ˜¯è¢«ä»£ç†ç›®æ ‡å®ä¾‹çš„æŸä¸ªå…·ä½“æ–¹æ³•ï¼Œé€šè¿‡å®ƒå¯ä»¥å‘èµ·ç›®æ ‡å®ä¾‹æ–¹æ³•çš„åå°„è°ƒç”¨ï¼›argsæ˜¯é€šè¿‡è¢«ä»£ç†å®ä¾‹æŸä¸€ä¸ªæ–¹æ³•çš„å…¥å‚ï¼Œåœ¨æ–¹æ³•åå°„è°ƒç”¨æ—¶ä½¿ç”¨ã€‚ </p>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬åœ¨æ„é€ å‡½æ•°é‡Œé€šè¿‡targetä¼ å…¥å¸Œæœ›è¢«ä»£ç†çš„ç›®æ ‡å¯¹è±¡ï¼Œå¦‚â‘¡å¤„æ‰€ç¤ºï¼Œåœ¨InvocationHandleræ¥å£æ–¹æ³•invoke(Object proxy, Method method, Object[] args)é‡Œï¼Œå°†ç›®æ ‡å®ä¾‹ä¼ ç»™method.invoke()æ–¹æ³•ï¼Œè°ƒç”¨ç›®æ ‡å®ä¾‹çš„æ–¹æ³•ï¼Œå¦‚â‘¢æ‰€ç¤ºã€‚<br>ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡Proxyç»“åˆPerformanceHandleråˆ›å»ºForumServiceæ¥å£çš„ä»£ç†å®ä¾‹ï¼Œå¦‚ä»£ç æ¸…å•6-7æ‰€ç¤ºï¼š </p>
<p>ä»£ç æ¸…å•6-7  TestForumServiceï¼šåˆ›å»ºä»£ç†å®ä¾‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">package com.baobaotao.proxy;  </div><div class="line">import java.lang.reflect.Proxy;  </div><div class="line">public class TestForumService &#123;  </div><div class="line">    public static void main(String[] args) &#123;                 </div><div class="line">               //â‘ å¸Œæœ›è¢«ä»£ç†çš„ç›®æ ‡ä¸šåŠ¡ç±»  </div><div class="line">        ForumService target = new ForumServiceImpl();            </div><div class="line">               //â‘¡å°†ç›®æ ‡ä¸šåŠ¡ç±»å’Œæ¨ªåˆ‡ä»£ç ç¼–ç»‡åˆ°ä¸€èµ·  </div><div class="line">        PerformanceHandler handler = new PerformanceHandler(target);  </div><div class="line">               //â‘¢æ ¹æ®ç¼–ç»‡äº†ç›®æ ‡ä¸šåŠ¡ç±»é€»è¾‘å’Œæ€§èƒ½ç›‘è§†æ¨ªåˆ‡é€»è¾‘çš„InvocationHandlerå®ä¾‹åˆ›å»ºä»£ç†å®ä¾‹  </div><div class="line">        ForumService proxy = (ForumService) Proxy.newProxyInstance(    </div><div class="line">                target.getClass().getClassLoader(),  </div><div class="line">                target.getClass().getInterfaces(),  </div><div class="line">                handler);  </div><div class="line">               //â‘£è°ƒç”¨ä»£ç†å®ä¾‹  </div><div class="line">        proxy.removeForum(10);     </div><div class="line">        proxy.removeTopic(1012);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„ä»£ç å®Œæˆä¸šåŠ¡ç±»ä»£ç å’Œæ¨ªåˆ‡ä»£ç çš„ç¼–ç»‡å·¥ä½œå¹¶ç”Ÿæˆäº†ä»£ç†å®ä¾‹ã€‚åœ¨â‘¡å¤„ï¼Œæˆ‘ä»¬è®©PerformanceHandlerå°†æ€§èƒ½ç›‘è§†æ¨ªåˆ‡é€»è¾‘ç¼–ç»‡åˆ°ForumServiceå®ä¾‹ä¸­ï¼Œç„¶ååœ¨â‘¢å¤„ï¼Œé€šè¿‡Proxyçš„newProxyInstance()é™æ€æ–¹æ³•ä¸ºç¼–ç»‡äº†ä¸šåŠ¡ç±»é€»è¾‘å’Œæ€§èƒ½ç›‘è§†é€»è¾‘çš„handleråˆ›å»ºä¸€ä¸ªç¬¦åˆForumServiceæ¥å£çš„ä»£ç†å®ä¾‹ã€‚è¯¥æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå…¥å‚ä¸ºç±»åŠ è½½å™¨ï¼›ç¬¬äºŒä¸ªå…¥å‚ä¸ºåˆ›å»ºä»£ç†å®ä¾‹æ‰€éœ€è¦å®ç°çš„ä¸€ç»„æ¥å£ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ•´åˆäº†ä¸šåŠ¡é€»è¾‘å’Œæ¨ªåˆ‡é€»è¾‘çš„ç¼–ç»‡å™¨å¯¹è±¡ã€‚ </p>
<p>æŒ‰ç…§â‘¢å¤„çš„è®¾ç½®æ–¹å¼ï¼Œè¿™ä¸ªä»£ç†å®ä¾‹å®ç°äº†ç›®æ ‡ä¸šåŠ¡ç±»çš„æ‰€æœ‰æ¥å£ï¼Œå³Forum ServiceImplçš„ForumServiceæ¥å£ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŒ‰ç…§è°ƒç”¨ForumServiceæ¥å£å®ä¾‹ç›¸åŒçš„æ–¹å¼è°ƒç”¨ä»£ç†å®ä¾‹ï¼Œå¦‚â‘£æ‰€ç¤ºã€‚è¿è¡Œä»¥ä¸Šçš„ä»£ç ï¼Œè¾“å‡ºä»¥ä¸‹ä¿¡æ¯ï¼š </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">begin monitor... </div><div class="line">æ¨¡æ‹Ÿåˆ é™¤Forumè®°å½•:10 </div><div class="line">end monitor... </div><div class="line">com.baobaotao.proxy.ForumServiceImpl.removeForumèŠ±è´¹47æ¯«ç§’ã€‚ </div><div class="line">begin monitor... </div><div class="line">æ¨¡æ‹Ÿåˆ é™¤Topicè®°å½•:1012 </div><div class="line">end monitor... </div><div class="line">com.baobaotao.proxy.ForumServiceImpl.removeTopicèŠ±è´¹26æ¯«ç§’ã€‚</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°ï¼Œç¨‹åºçš„è¿è¡Œæ•ˆæœå’Œç›´æ¥åœ¨ä¸šåŠ¡ç±»ä¸­ç¼–å†™æ€§èƒ½ç›‘è§†é€»è¾‘çš„æ•ˆæœä¸€è‡´ï¼Œä½†æ˜¯åœ¨è¿™é‡Œï¼ŒåŸæ¥åˆ†æ•£çš„æ¨ªåˆ‡é€»è¾‘ä»£ç å·²ç»è¢«æˆ‘ä»¬æŠ½å–åˆ°PerformanceHandlerä¸­ã€‚å½“å…¶ä»–ä¸šåŠ¡ç±»ï¼ˆå¦‚UserServiceã€SystemServiceç­‰ï¼‰çš„ä¸šåŠ¡æ–¹æ³•ä¹Ÿéœ€è¦ä½¿ç”¨æ€§èƒ½ç›‘è§†æ—¶ï¼Œæˆ‘ä»¬åªè¦æŒ‰ç…§ä»£ç æ¸…å•6-7ç›¸ä¼¼çš„æ–¹å¼ï¼Œåˆ†åˆ«ä¸ºå®ƒä»¬åˆ›å»ºä»£ç†å¯¹è±¡å°±å¯ä»¥äº†ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡æ—¶åºå›¾æè¿°é€šè¿‡åˆ›å»ºä»£ç†å¯¹è±¡è¿›è¡Œä¸šåŠ¡æ–¹æ³•è°ƒç”¨çš„æ•´ä½“é€»è¾‘ï¼Œä»¥è¿›ä¸€æ­¥è®¤è¯†ä»£ç†å¯¹è±¡çš„æœ¬è´¨ï¼Œå¦‚å›¾6-3æ‰€ç¤ºã€‚ </p>
<p><img src="/images/å›¾6-3 åŠ¨æ€ä»£ç†.jpg"></p>
<p>æˆ‘ä»¬åœ¨ä¸Šå›¾ä¸­ä½¿ç”¨è™šçº¿çš„æ–¹å¼å¯¹é€šè¿‡Proxyåˆ›å»ºçš„ForumServiceä»£ç†å®ä¾‹åŠ ä»¥å‡¸æ˜¾ï¼ŒForumServiceä»£ç†å®ä¾‹å†…éƒ¨åˆ©ç”¨PerformaceHandleræ•´åˆæ¨ªåˆ‡é€»è¾‘å’Œä¸šåŠ¡é€»è¾‘ã€‚è°ƒç”¨è€…è°ƒç”¨ä»£ç†å¯¹è±¡çš„removeForum()å’ŒremoveTopic()æ–¹æ³•æ—¶ï¼Œä¸Šå›¾çš„å†…éƒ¨è°ƒç”¨æ—¶åºæ¸…æ™°åœ°å‘Šè¯‰æˆ‘ä»¬å®é™…ä¸Šæ‰€å‘ç”Ÿçš„ä¸€åˆ‡ã€‚ </p>
<h4 id="CGLibåŠ¨æ€ä»£ç†"><a href="#CGLibåŠ¨æ€ä»£ç†" class="headerlink" title="CGLibåŠ¨æ€ä»£ç†"></a>CGLibåŠ¨æ€ä»£ç†</h4><p>ä½¿ç”¨JDKåˆ›å»ºä»£ç†æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œå³å®ƒåªèƒ½ä¸ºæ¥å£åˆ›å»ºä»£ç†å®ä¾‹ï¼Œè¿™ä¸€ç‚¹æˆ‘ä»¬å¯ä»Proxyçš„æ¥å£newProxyInstance(ClassLoader loader, Class[] interfaces, InvocationHandler h)çš„æ–¹æ³•ç­¾åä¸­å°±çœ‹å¾—å¾ˆæ¸…æ¥šï¼šç¬¬äºŒä¸ªå…¥å‚interfaceså°±æ˜¯éœ€è¦ä»£ç†å®ä¾‹å®ç°çš„æ¥å£åˆ—è¡¨ã€‚è™½ç„¶é¢å‘æ¥å£ç¼–ç¨‹çš„æ€æƒ³è¢«å¾ˆå¤šå¤§å¸ˆçº§äººç‰©ï¼ˆåŒ…æ‹¬Rod Johnsonï¼‰æ¨å´‡ï¼Œä½†åœ¨å®é™…å¼€å‘ä¸­ï¼Œè®¸å¤šå¼€å‘è€…ä¹Ÿå¯¹æ­¤æ·±æ„Ÿå›°æƒ‘ï¼šéš¾é“å¯¹ä¸€ä¸ªç®€å•ä¸šåŠ¡è¡¨çš„æ“ä½œä¹Ÿéœ€è¦è€è€å®å®åœ°åˆ›å»º5ä¸ªç±»ï¼ˆé¢†åŸŸå¯¹è±¡ç±»ã€Daoæ¥å£ï¼ŒDaoå®ç°ç±»ï¼ŒServiceæ¥å£å’ŒServiceå®ç°ç±»ï¼‰å—ï¼Ÿéš¾é“ä¸èƒ½ç›´æ¥é€šè¿‡å®ç°ç±»æ„å»ºç¨‹åºå—ï¼Ÿå¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¾ˆéš¾ç»™å‡ºä¸€ä¸ªå­°å¥½å­°åŠ£çš„å‡†ç¡®åˆ¤æ–­ï¼Œä½†æˆ‘ä»¬ç¡®å®å‘ç°æœ‰å¾ˆå¤šä¸ä½¿ç”¨æ¥å£çš„é¡¹ç›®ä¹Ÿå–å¾—äº†éå¸¸å¥½çš„æ•ˆæœï¼ˆåŒ…æ‹¬å¤§å®¶æ‰€ç†Ÿæ‚‰çš„SpringSideå¼€æºé¡¹ç›®ï¼‰ã€‚ </p>
<p>å¯¹äºæ²¡æœ‰é€šè¿‡æ¥å£å®šä¹‰ä¸šåŠ¡æ–¹æ³•çš„ç±»ï¼Œå¦‚ä½•åŠ¨æ€åˆ›å»ºä»£ç†å®ä¾‹å‘¢ï¼ŸJDKçš„ä»£ç†æŠ€æœ¯æ˜¾ç„¶å·²ç»é»”é©´æŠ€ç©·ï¼ŒCGLibä½œä¸ºä¸€ä¸ªæ›¿ä»£è€…ï¼Œå¡«è¡¥äº†è¿™ä¸ªç©ºç¼ºã€‚ </p>
<p>CGLibé‡‡ç”¨éå¸¸åº•å±‚çš„å­—èŠ‚ç æŠ€æœ¯ï¼Œå¯ä»¥ä¸ºä¸€ä¸ªç±»åˆ›å»ºå­ç±»ï¼Œå¹¶åœ¨å­ç±»ä¸­é‡‡ç”¨æ–¹æ³•æ‹¦æˆªçš„æŠ€æœ¯æ‹¦æˆªæ‰€æœ‰çˆ¶ç±»æ–¹æ³•çš„è°ƒç”¨ï¼Œå¹¶é¡ºåŠ¿ç»‡å…¥æ¨ªåˆ‡é€»è¾‘ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬é‡‡ç”¨CGLibæŠ€æœ¯ï¼Œç¼–å†™ä¸€ä¸ªå¯ä»¥ä¸ºä»»ä½•ç±»åˆ›å»ºç»‡å…¥æ€§èƒ½ç›‘è§†æ¨ªåˆ‡é€»è¾‘ä»£ç†å¯¹è±¡çš„ä»£ç†åˆ›å»ºå™¨ï¼Œå¦‚ä»£ç æ¸…å• 6-8æ‰€ç¤ºï¼š </p>
<p>ä»£ç æ¸…å•6-8  CglibProxy<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">package com.baobaotao.proxy;  </div><div class="line">import java.lang.reflect.Method;  </div><div class="line">import net.sf.cglib.proxy.Enhancer;  </div><div class="line">import net.sf.cglib.proxy.MethodInterceptor;  </div><div class="line">import net.sf.cglib.proxy.MethodProxy;  </div><div class="line">public class CglibProxy implements MethodInterceptor &#123;  </div><div class="line">    private Enhancer enhancer = new Enhancer();  </div><div class="line">    public Object getProxy(Class clazz) &#123;  </div><div class="line">        enhancer.setSuperclass(clazz); //â‘  è®¾ç½®éœ€è¦åˆ›å»ºå­ç±»çš„ç±»  </div><div class="line">        enhancer.setCallback(this);   </div><div class="line">        return enhancer.create(); //â‘¡é€šè¿‡å­—èŠ‚ç æŠ€æœ¯åŠ¨æ€åˆ›å»ºå­ç±»å®ä¾‹  </div><div class="line">    &#125;  </div><div class="line">        //â‘¢æ‹¦æˆªçˆ¶ç±»æ‰€æœ‰æ–¹æ³•çš„è°ƒç”¨  </div><div class="line">    public Object intercept(Object obj, Method method, Object[] args,   </div><div class="line">            MethodProxy proxy) throws Throwable &#123;  </div><div class="line">        PerformanceMonitor.begin(obj.getClass().getName()+&quot;.&quot;+method. getName());//â‘¢-1  </div><div class="line">        Object result=proxy.invokeSuper(obj, args); â‘¢-2   </div><div class="line">        PerformanceMonitor.end();//â‘¢-1é€šè¿‡ä»£ç†ç±»è°ƒç”¨çˆ¶ç±»ä¸­çš„æ–¹æ³•  </div><div class="line">        return result;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨ä¸Šé¢ä»£ç ä¸­ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡getProxy(Class clazz)ä¸ºä¸€ä¸ªç±»åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œè¯¥ä»£ç†å¯¹è±¡é€šè¿‡æ‰©å±•clazzåˆ›å»ºä»£ç†å¯¹è±¡ã€‚åœ¨è¿™ä¸ªä»£ç†å¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬ç»‡å…¥æ€§èƒ½ç›‘è§†çš„æ¨ªåˆ‡é€»è¾‘ï¼ˆâ‘¢-1ï¼‰ã€‚intercept(Object obj, Method method, Object[] args,MethodProxy proxy)æ˜¯CGLibå®šä¹‰çš„Interceptoræ¥å£çš„æ–¹æ³•ï¼Œå®ƒæ‹¦æˆªæ‰€æœ‰ç›®æ ‡ç±»æ–¹æ³•çš„è°ƒç”¨ï¼Œobjè¡¨ç¤ºç›®æ ‡ç±»çš„å®ä¾‹ï¼›methodä¸ºç›®æ ‡ç±»æ–¹æ³•çš„åå°„å¯¹è±¡ï¼›argsä¸ºæ–¹æ³•çš„åŠ¨æ€å…¥å‚ï¼›è€Œproxyä¸ºä»£ç†ç±»å®ä¾‹ã€‚ </p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡CglibProxyä¸ºForumServiceImplç±»åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå¹¶æµ‹è¯•ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œå¦‚ä»£ç æ¸…å•6-9æ‰€ç¤ºï¼š </p>
<p>ä»£ç æ¸…å•6-9  TestForumServiceï¼šæµ‹è¯•Cglibåˆ›å»ºçš„ä»£ç†ç±»<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">package com.baobaotao.proxy;  </div><div class="line">import java.lang.reflect.Proxy;  </div><div class="line">public class TestForumService &#123;  </div><div class="line">    public static void main(String[] args) &#123;  </div><div class="line">      CglibProxy proxy = new CglibProxy();  </div><div class="line">      ForumServiceImpl forumService = â‘    </div><div class="line">                (ForumServiceImpl )proxy.getProxy(ForumServiceImpl.class);  </div><div class="line">      forumService.removeForum(10);  </div><div class="line">      forumService.removeTopic(1023);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨â‘ ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡CglibProxyä¸ºForumServiceImplåŠ¨æ€åˆ›å»ºäº†ä¸€ä¸ªç»‡å…¥æ€§èƒ½ç›‘è§†é€»è¾‘çš„ä»£ç†å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ä»£ç†ç±»çš„ä¸šåŠ¡æ–¹æ³•ã€‚è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œè¾“å…¥ä»¥ä¸‹ä¿¡æ¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">begin monitor... </div><div class="line">æ¨¡æ‹Ÿåˆ é™¤Forumè®°å½•:10 </div><div class="line">end monitor... </div><div class="line">com.baobaotao.proxy.ForumServiceImpl$$EnhancerByCGLIB$$2a9199c0.removeForumèŠ±è´¹47æ¯«ç§’ã€‚ </div><div class="line">begin monitor... </div><div class="line">æ¨¡æ‹Ÿåˆ é™¤Topicè®°å½•:1023 </div><div class="line">end monitor... </div><div class="line">com.baobaotao.proxy.ForumServiceImpl$$EnhancerByCGLIB$$2a9199c0.removeTopicèŠ±è´¹16æ¯«ç§’ã€‚</div></pre></td></tr></table></figure></p>
<p>è§‚å¯Ÿä»¥ä¸Šçš„è¾“å‡ºï¼Œé™¤äº†å‘ç°ä¸¤ä¸ªä¸šåŠ¡æ–¹æ³•ä¸­éƒ½ç»‡å…¥äº†æ€§èƒ½ç›‘æ§çš„é€»è¾‘å¤–ï¼Œæˆ‘ä»¬è¿˜å‘ç°ä»£ç†ç±»çš„åå­—æ˜¯com.baobaotao.proxy.ForumServiceImpl$$EnhancerByCGLIB$$2a9199c0ï¼Œè¿™ä¸ªç‰¹æ®Šçš„ç±»å°±æ˜¯CGLibä¸ºForumServiceImplåŠ¨æ€åˆ›å»ºçš„å­ç±»ã€‚ </p>
<h3 id="ä»£ç†çŸ¥è¯†å°ç»“"><a href="#ä»£ç†çŸ¥è¯†å°ç»“" class="headerlink" title="ä»£ç†çŸ¥è¯†å°ç»“"></a>ä»£ç†çŸ¥è¯†å°ç»“</h3><p>Spring AOPçš„åº•å±‚å°±æ˜¯é€šè¿‡ä½¿ç”¨JDKåŠ¨æ€ä»£ç†æˆ–CGLibåŠ¨æ€ä»£ç†æŠ€æœ¯ä¸ºç›®æ ‡Beanç»‡å…¥æ¨ªåˆ‡é€»è¾‘ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹å‰é¢ä¸¤èŠ‚åŠ¨æ€åˆ›å»ºä»£ç†å¯¹è±¡ä½œä¸€ä¸ªå°ç»“ã€‚ </p>
<p>æˆ‘ä»¬è™½ç„¶é€šè¿‡PerformanceHandleræˆ–CglibProxyå®ç°äº†æ€§èƒ½ç›‘è§†æ¨ªåˆ‡é€»è¾‘çš„åŠ¨æ€ç»‡å…¥ï¼Œä½†è¿™ç§å®ç°æ–¹å¼å­˜åœ¨ä¸‰ä¸ªæ˜æ˜¾éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼š </p>
<ul>
<li>ç›®æ ‡ç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½æ·»åŠ äº†æ€§èƒ½ç›‘è§†æ¨ªåˆ‡é€»è¾‘ï¼Œè€Œæœ‰æ—¶ï¼Œè¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„ï¼Œæˆ‘ä»¬å¯èƒ½åªå¸Œæœ›å¯¹ä¸šåŠ¡ç±»ä¸­çš„æŸäº›ç‰¹å®šæ–¹æ³•æ·»åŠ æ¨ªåˆ‡é€»è¾‘ï¼› </li>
<li>æˆ‘ä»¬é€šè¿‡ç¡¬ç¼–ç çš„æ–¹å¼æŒ‡å®šäº†ç»‡å…¥æ¨ªåˆ‡é€»è¾‘çš„ç»‡å…¥ç‚¹ï¼Œå³åœ¨ç›®æ ‡ç±»ä¸šåŠ¡æ–¹æ³•çš„å¼€å§‹å’Œç»“æŸå‰ç»‡å…¥ä»£ç ï¼› </li>
<li>æˆ‘ä»¬æ‰‹å·¥ç¼–å†™ä»£ç†å®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹ï¼Œä¸ºä¸åŒç±»åˆ›å»ºä»£ç†æ—¶ï¼Œéœ€è¦åˆ†åˆ«ç¼–å†™ç›¸åº”çš„åˆ›å»ºä»£ç ï¼Œæ— æ³•åšåˆ°é€šç”¨ã€‚ </li>
</ul>
<p>ä»¥ä¸Šä¸‰ä¸ªé—®é¢˜ï¼Œåœ¨AOPä¸­å ç”¨é‡è¦çš„åœ°ä½ï¼Œå› ä¸ºSpring AOPçš„ä¸»è¦å·¥ä½œå°±æ˜¯å›´ç»•ä»¥ä¸Šä¸‰ç‚¹å±•å¼€ï¼šSpring AOPé€šè¿‡Pointcutï¼ˆåˆ‡ç‚¹ï¼‰æŒ‡å®šåœ¨å“ªäº›ç±»çš„å“ªäº›æ–¹æ³•ä¸Šç»‡å…¥æ¨ªåˆ‡é€»è¾‘ï¼Œé€šè¿‡Adviceï¼ˆå¢å¼ºï¼‰æè¿°æ¨ªåˆ‡é€»è¾‘å’Œæ–¹æ³•çš„å…·ä½“ç»‡å…¥ç‚¹ï¼ˆæ–¹æ³•å‰ã€æ–¹æ³•åã€æ–¹æ³•çš„ä¸¤ç«¯ç­‰ï¼‰ã€‚æ­¤å¤–ï¼ŒSpringé€šè¿‡Advisorï¼ˆåˆ‡é¢ï¼‰å°†Pointcutå’ŒAdviceä¸¤è€…ç»„è£…èµ·æ¥ã€‚æœ‰äº†Advisorçš„ä¿¡æ¯ï¼ŒSpringå°±å¯ä»¥åˆ©ç”¨JDKæˆ–CGLibçš„åŠ¨æ€ä»£ç†æŠ€æœ¯é‡‡ç”¨ç»Ÿä¸€çš„æ–¹å¼ä¸ºç›®æ ‡Beanåˆ›å»ºç»‡å…¥åˆ‡é¢çš„ä»£ç†å¯¹è±¡äº†ã€‚ </p>
<p>JDKåŠ¨æ€ä»£ç†æ‰€åˆ›å»ºçš„ä»£ç†å¯¹è±¡ï¼Œåœ¨JDK 1.3ä¸‹ï¼Œæ€§èƒ½å¼ºå·®äººæ„ã€‚è™½ç„¶åœ¨é«˜ç‰ˆæœ¬çš„JDKä¸­ï¼ŒåŠ¨æ€ä»£ç†å¯¹è±¡çš„æ€§èƒ½å¾—åˆ°äº†å¾ˆå¤§çš„æé«˜ï¼Œä½†æ˜¯æœ‰ç ”ç©¶è¡¨æ˜ï¼ŒCGLibæ‰€åˆ›å»ºçš„åŠ¨æ€ä»£ç†å¯¹è±¡çš„æ€§èƒ½ä¾æ—§æ¯”JDKçš„æ‰€åˆ›å»ºçš„ä»£ç†å¯¹è±¡çš„æ€§èƒ½é«˜ä¸å°‘ï¼ˆå¤§æ¦‚10å€ï¼‰ã€‚ä½†CGLibåœ¨åˆ›å»ºä»£ç†å¯¹è±¡æ—¶æ‰€èŠ±è´¹çš„æ—¶é—´å´æ¯”JDKåŠ¨æ€ä»£ç†å¤šï¼ˆå¤§æ¦‚8å€ï¼‰ï¼Œæ‰€ä»¥å¯¹äºsingletonçš„ä»£ç†å¯¹è±¡æˆ–è€…å…·æœ‰å®ä¾‹æ± çš„ä»£ç†ï¼Œå› ä¸ºæ— é¡»é¢‘ç¹åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥æ¯”è¾ƒé€‚åˆç”¨CGLibåŠ¨æ€ä»£ç†æŠ€æœ¯ï¼Œåä¹‹é€‚åˆç”¨JDKåŠ¨æ€ä»£ç†æŠ€æœ¯ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œç”±äºCGLibé‡‡ç”¨åŠ¨æ€åˆ›å»ºå­ç±»çš„æ–¹å¼ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥ä¸èƒ½å¯¹ç›®æ ‡ç±»ä¸­çš„finalæ–¹æ³•è¿›è¡Œä»£ç†ã€‚ </p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Javaåå°„]]></title>
      <url>http://zsr.github.io/2016/08/01/Java%E5%8F%8D%E5%B0%84/</url>
      <content type="html"><![CDATA[<h1 id="Javaåå°„"><a href="#Javaåå°„" class="headerlink" title="Javaåå°„"></a>Javaåå°„</h1><hr>
<h6 id="Javaè¯­è¨€å…è®¸é€šè¿‡ç¨‹åºåŒ–çš„æ–¹å¼é—´æ¥å¯¹Classè¿›è¡Œæ“ä½œï¼ŒClassæ–‡ä»¶ç”±ç±»è£…è½½å™¨è£…è½½åï¼Œåœ¨JVMä¸­å°†å½¢æˆä¸€ä»½æè¿°Classç»“æ„çš„å…ƒä¿¡æ¯å¯¹è±¡ï¼Œé€šè¿‡è¯¥å…ƒä¿¡æ¯å¯¹è±¡å¯ä»¥è·çŸ¥Classçš„ç»“æ„ä¿¡æ¯ï¼šå¦‚æ„é€ å‡½æ•°ã€å±æ€§å’Œæ–¹æ³•ç­‰ã€‚Javaå…è®¸ç”¨æˆ·å€Ÿç”±è¿™ä¸ªClassç›¸å…³çš„å…ƒä¿¡æ¯å¯¹è±¡é—´æ¥è°ƒç”¨Classå¯¹è±¡çš„åŠŸèƒ½ï¼Œè¿™å°±ä¸ºä½¿ç”¨ç¨‹åºåŒ–æ–¹å¼æ“ä½œClasså¯¹è±¡å¼€è¾Ÿäº†é€”å¾„ã€‚"><a href="#Javaè¯­è¨€å…è®¸é€šè¿‡ç¨‹åºåŒ–çš„æ–¹å¼é—´æ¥å¯¹Classè¿›è¡Œæ“ä½œï¼ŒClassæ–‡ä»¶ç”±ç±»è£…è½½å™¨è£…è½½åï¼Œåœ¨JVMä¸­å°†å½¢æˆä¸€ä»½æè¿°Classç»“æ„çš„å…ƒä¿¡æ¯å¯¹è±¡ï¼Œé€šè¿‡è¯¥å…ƒä¿¡æ¯å¯¹è±¡å¯ä»¥è·çŸ¥Classçš„ç»“æ„ä¿¡æ¯ï¼šå¦‚æ„é€ å‡½æ•°ã€å±æ€§å’Œæ–¹æ³•ç­‰ã€‚Javaå…è®¸ç”¨æˆ·å€Ÿç”±è¿™ä¸ªClassç›¸å…³çš„å…ƒä¿¡æ¯å¯¹è±¡é—´æ¥è°ƒç”¨Classå¯¹è±¡çš„åŠŸèƒ½ï¼Œè¿™å°±ä¸ºä½¿ç”¨ç¨‹åºåŒ–æ–¹å¼æ“ä½œClasså¯¹è±¡å¼€è¾Ÿäº†é€”å¾„ã€‚" class="headerlink" title="Javaè¯­è¨€å…è®¸é€šè¿‡ç¨‹åºåŒ–çš„æ–¹å¼é—´æ¥å¯¹Classè¿›è¡Œæ“ä½œï¼ŒClassæ–‡ä»¶ç”±ç±»è£…è½½å™¨è£…è½½åï¼Œåœ¨JVMä¸­å°†å½¢æˆä¸€ä»½æè¿°Classç»“æ„çš„å…ƒä¿¡æ¯å¯¹è±¡ï¼Œé€šè¿‡è¯¥å…ƒä¿¡æ¯å¯¹è±¡å¯ä»¥è·çŸ¥Classçš„ç»“æ„ä¿¡æ¯ï¼šå¦‚æ„é€ å‡½æ•°ã€å±æ€§å’Œæ–¹æ³•ç­‰ã€‚Javaå…è®¸ç”¨æˆ·å€Ÿç”±è¿™ä¸ªClassç›¸å…³çš„å…ƒä¿¡æ¯å¯¹è±¡é—´æ¥è°ƒç”¨Classå¯¹è±¡çš„åŠŸèƒ½ï¼Œè¿™å°±ä¸ºä½¿ç”¨ç¨‹åºåŒ–æ–¹å¼æ“ä½œClasså¯¹è±¡å¼€è¾Ÿäº†é€”å¾„ã€‚"></a>Javaè¯­è¨€å…è®¸é€šè¿‡ç¨‹åºåŒ–çš„æ–¹å¼é—´æ¥å¯¹Classè¿›è¡Œæ“ä½œï¼ŒClassæ–‡ä»¶ç”±ç±»è£…è½½å™¨è£…è½½åï¼Œåœ¨JVMä¸­å°†å½¢æˆä¸€ä»½æè¿°Classç»“æ„çš„å…ƒä¿¡æ¯å¯¹è±¡ï¼Œé€šè¿‡è¯¥å…ƒä¿¡æ¯å¯¹è±¡å¯ä»¥è·çŸ¥Classçš„ç»“æ„ä¿¡æ¯ï¼šå¦‚æ„é€ å‡½æ•°ã€å±æ€§å’Œæ–¹æ³•ç­‰ã€‚Javaå…è®¸ç”¨æˆ·å€Ÿç”±è¿™ä¸ªClassç›¸å…³çš„å…ƒä¿¡æ¯å¯¹è±¡é—´æ¥è°ƒç”¨Classå¯¹è±¡çš„åŠŸèƒ½ï¼Œè¿™å°±ä¸ºä½¿ç”¨ç¨‹åºåŒ–æ–¹å¼æ“ä½œClasså¯¹è±¡å¼€è¾Ÿäº†é€”å¾„ã€‚</h6><h3 id="ç®€å•å®ä¾‹"><a href="#ç®€å•å®ä¾‹" class="headerlink" title="ç®€å•å®ä¾‹"></a>ç®€å•å®ä¾‹</h3><p>æˆ‘ä»¬å°†ä»ä¸€ä¸ªç®€å•ä¾‹å­å¼€å§‹æ¢è®¿Javaåå°„æœºåˆ¶çš„å¾ç¨‹ï¼Œä¸‹é¢çš„Carç±»æ‹¥æœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ã€ä¸¤ä¸ªæ–¹æ³•ä»¥åŠä¸‰ä¸ªå±æ€§ï¼Œå¦‚ä»£ç æ¸…å•3-9æ‰€ç¤ºï¼š </p>
<p>ä»£ç æ¸…å•3-9  Car<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.baobaotao.reflect;  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;  </div><div class="line">    <span class="keyword">private</span> String brand;  </div><div class="line">    <span class="keyword">private</span> String color;  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxSpeed; </div><div class="line">    <span class="comment">//â‘ é»˜è®¤æ„é€ å‡½æ•°  </span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Car</span><span class="params">()</span></span>&#123;&#125;  </div><div class="line">     <span class="comment">//â‘¡å¸¦å‚æ„é€ å‡½æ•°  </span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Car</span><span class="params">(String brand,String color,<span class="keyword">int</span> maxSpeed)</span></span>&#123;   </div><div class="line">        <span class="keyword">this</span>.brand = brand;  </div><div class="line">        <span class="keyword">this</span>.color = color;  </div><div class="line">        <span class="keyword">this</span>.maxSpeed = maxSpeed;  </div><div class="line">    &#125;  </div><div class="line">     <span class="comment">//â‘¢æœªå¸¦å‚çš„æ–¹æ³•  </span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">introduce</span><span class="params">()</span> </span>&#123;   </div><div class="line">       System.out.println(<span class="string">"brand:"</span>+brand+<span class="string">";color:"</span>+color+<span class="string">";maxSpeed:"</span> +maxSpeed);  </div><div class="line">    &#125;  </div><div class="line">     <span class="comment">//çœç•¥å‚æ•°çš„getter/Setteræ–¹æ³•  </span></div><div class="line">     â€¦  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨å¦‚ä¸‹çš„ä»£ç åˆ›å»ºCarçš„å®ä¾‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Car car = <span class="keyword">new</span> Car();  </div><div class="line">car.setBrand(<span class="string">"çº¢æ——CA72"</span>);</div></pre></td></tr></table></figure></p>
<p>æˆ–è€…ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Car car = new Car(&quot;çº¢æ——CA72&quot;,&quot;é»‘è‰²&quot;);</div></pre></td></tr></table></figure></p>
<p>ä»¥ä¸Šä¸¤ç§æ–¹æ³•éƒ½é‡‡ç”¨ä¼ ç»Ÿæ–¹å¼çš„ç›´æ¥è°ƒç”¨ç›®æ ‡ç±»çš„æ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡Javaåå°„æœºåˆ¶ä»¥ä¸€ç§æ›´åŠ é€šç”¨çš„æ–¹å¼é—´æ¥åœ°æ“ä½œç›®æ ‡ç±»ï¼š<br><a id="more"></a></p>
<p>ä»£ç æ¸…å•3-10  ReflectTest<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.baobaotao. reflect;  </div><div class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </div><div class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectTest</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Car  <span class="title">initByDefaultConst</span><span class="params">()</span> <span class="keyword">throws</span> Throwable  </span></div><div class="line">    &#123;  </div><div class="line">        <span class="comment">//â‘ é€šè¿‡ç±»è£…è½½å™¨è·å–Carç±»å¯¹è±¡  </span></div><div class="line">        ClassLoader loader = Thread.currentThread().getContextClassLoader();   </div><div class="line">        Class clazz = loader.loadClass(<span class="string">"com.baobaotao.reflect.Car"</span>); </div><div class="line">        <span class="comment">//â‘¡è·å–ç±»çš„é»˜è®¤æ„é€ å™¨å¯¹è±¡å¹¶é€šè¿‡å®ƒå®ä¾‹åŒ–Car  </span></div><div class="line">        Constructor cons = clazz.getDeclaredConstructor((Class[])<span class="keyword">null</span>);   </div><div class="line">        Car car = (Car)cons.newInstance();  </div><div class="line">        <span class="comment">//â‘¢é€šè¿‡åå°„æ–¹æ³•è®¾ç½®å±æ€§  </span></div><div class="line">        Method setBrand = clazz.getMethod(<span class="string">"setBrand"</span>,String.class);          </div><div class="line">        setBrand.invoke(car,<span class="string">"çº¢æ——CA72"</span>);        </div><div class="line">        Method setColor = clazz.getMethod(<span class="string">"setColor"</span>,String.class);  </div><div class="line">        setColor.invoke(car,<span class="string">"é»‘è‰²"</span>);        </div><div class="line">        Method setMaxSpeed = clazz.getMethod(<span class="string">"setMaxSpeed"</span>,<span class="keyword">int</span>.class);  </div><div class="line">        setMaxSpeed.invoke(car,<span class="number">200</span>);          </div><div class="line">        <span class="keyword">return</span> car;  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;  </div><div class="line">        Car car = initByDefaultConst();  </div><div class="line">        car.introduce();  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿è¡Œä»¥ä¸Šç¨‹åºï¼Œåœ¨æ§åˆ¶å°ä¸Šå°†æ‰“å°å‡ºä»¥ä¸‹ä¿¡æ¯ï¼š<br>å¼•ç”¨<br>brand:çº¢æ——CA72;color:é»‘è‰²;maxSpeed:200</p>
<p>è¿™è¯´æ˜æˆ‘ä»¬å®Œå…¨å¯ä»¥é€šè¿‡ç¼–ç¨‹æ–¹å¼è°ƒç”¨Classçš„å„é¡¹åŠŸèƒ½ï¼Œè¿™å’Œç›´æ¥é€šè¿‡æ„é€ å‡½æ•°å’Œæ–¹æ³•è°ƒç”¨ç±»åŠŸèƒ½çš„æ•ˆæœæ˜¯ä¸€è‡´çš„ï¼Œåªä¸è¿‡å‰è€…æ˜¯é—´æ¥è°ƒç”¨ï¼Œåè€…æ˜¯ç›´æ¥è°ƒç”¨ç½¢äº†ã€‚ </p>
<p>åœ¨ReflectTestä¸­ï¼Œä½¿ç”¨äº†å‡ ä¸ªé‡è¦çš„åå°„ç±»ï¼Œåˆ†åˆ«æ˜¯ClassLoaderã€Classã€Constructorå’ŒMethodï¼Œé€šè¿‡è¿™äº›åå°„ç±»å°±å¯ä»¥é—´æ¥è°ƒç”¨ç›®æ ‡Classçš„å„é¡¹åŠŸèƒ½äº†ã€‚åœ¨â‘ å¤„ï¼Œæˆ‘ä»¬è·å–å½“å‰çº¿ç¨‹çš„ClassLoaderï¼Œç„¶åé€šè¿‡æŒ‡å®šçš„å…¨é™å®šç±»â€œcom.baobaotao.beans.Carâ€è£…è½½Carç±»å¯¹åº”çš„åå°„å®ä¾‹ã€‚åœ¨â‘¡å¤„ï¼Œæˆ‘ä»¬é€šè¿‡Carçš„åå°„ç±»å¯¹è±¡è·å–Carçš„æ„é€ å‡½æ•°å¯¹è±¡consï¼Œé€šè¿‡æ„é€ å‡½æ•°å¯¹è±¡çš„newInstrance()æ–¹æ³•å®ä¾‹åŒ–Carå¯¹è±¡ï¼Œå…¶æ•ˆæœç­‰åŒäºnew Car()ã€‚åœ¨â‘¢å¤„ï¼Œæˆ‘ä»¬åˆé€šè¿‡Carçš„åå°„ç±»å¯¹è±¡çš„getMethodï¼ˆString methodName,Class paramClassï¼‰è·å–å±æ€§çš„Setteræ–¹æ³•å¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç›®æ ‡Classçš„æ–¹æ³•åï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ–¹æ³•å…¥å‚çš„å¯¹è±¡ç±»å‹ã€‚è·å–æ–¹æ³•åå°„å¯¹è±¡åï¼Œå³å¯é€šè¿‡invokeï¼ˆObject obj,Object paramï¼‰æ–¹æ³•è°ƒç”¨ç›®æ ‡ç±»çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ“ä½œçš„ç›®æ ‡ç±»å¯¹è±¡å®ä¾‹ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç›®æ ‡æ–¹æ³•çš„å…¥å‚ã€‚ </p>
<p>åœ¨ä»£ç æ¸…å•3 10ä¸­ï¼Œç²—ä½“æ‰€ç¤ºéƒ¨åˆ†çš„ä¿¡æ¯å³æ˜¯é€šè¿‡åå°„æ–¹æ³•æ“æ§ç›®æ ‡ç±»çš„å…ƒä¿¡æ¯ï¼Œå¦‚æœæˆ‘ä»¬å°†è¿™äº›ä¿¡æ¯ä»¥ä¸€ä¸ªé…ç½®æ–‡ä»¶çš„æ–¹å¼æä¾›ï¼Œå°±å¯ä»¥ä½¿ç”¨Javaè¯­è¨€çš„åå°„åŠŸèƒ½ç¼–å†™ä¸€æ®µé€šç”¨çš„ä»£ç å¯¹ç±»ä¼¼äºCarçš„ç±»è¿›è¡Œå®ä¾‹åŒ–åŠåŠŸèƒ½è°ƒç”¨æ“ä½œäº†ã€‚ </p>
<h3 id="ç±»è£…è½½å™¨ClassLoader"><a href="#ç±»è£…è½½å™¨ClassLoader" class="headerlink" title="ç±»è£…è½½å™¨ClassLoader"></a>ç±»è£…è½½å™¨ClassLoader</h3><h4 id="ç±»è£…è½½å™¨å·¥ä½œæœºåˆ¶"><a href="#ç±»è£…è½½å™¨å·¥ä½œæœºåˆ¶" class="headerlink" title="ç±»è£…è½½å™¨å·¥ä½œæœºåˆ¶"></a>ç±»è£…è½½å™¨å·¥ä½œæœºåˆ¶</h4><p>ç±»è£…è½½å™¨å°±æ˜¯å¯»æ‰¾ç±»çš„èŠ‚ç æ–‡ä»¶å¹¶æ„é€ å‡ºç±»åœ¨JVMå†…éƒ¨è¡¨ç¤ºå¯¹è±¡çš„ç»„ä»¶ã€‚åœ¨Javaä¸­ï¼Œç±»è£…è½½å™¨æŠŠä¸€ä¸ªç±»è£…å…¥JVMä¸­ï¼Œè¦ç»è¿‡ä»¥ä¸‹æ­¥éª¤ï¼š </p>
<ul>
<li>è£…è½½ï¼šæŸ¥æ‰¾å’Œå¯¼å…¥Classæ–‡ä»¶ï¼› </li>
<li>é“¾æ¥ï¼šæ‰§è¡Œæ ¡éªŒã€å‡†å¤‡å’Œè§£ææ­¥éª¤ï¼Œå…¶ä¸­è§£ææ­¥éª¤æ˜¯å¯ä»¥é€‰æ‹©çš„ï¼š <ul>
<li>æ ¡éªŒï¼šæ£€æŸ¥è½½å…¥Classæ–‡ä»¶æ•°æ®çš„æ­£ç¡®æ€§ï¼› </li>
<li>å‡†å¤‡ï¼šç»™ç±»çš„é™æ€å˜é‡åˆ†é…å­˜å‚¨ç©ºé—´ï¼› </li>
<li>è§£æï¼šå°†ç¬¦å·å¼•ç”¨è½¬æˆç›´æ¥å¼•ç”¨ï¼› </li>
</ul>
</li>
<li>åˆå§‹åŒ–ï¼šå¯¹ç±»çš„é™æ€å˜é‡ã€é™æ€ä»£ç å—æ‰§è¡Œåˆå§‹åŒ–å·¥ä½œã€‚ </li>
</ul>
<p>ç±»è£…è½½å·¥ä½œç”±ClassLoaderåŠå…¶å­ç±»è´Ÿè´£ï¼ŒClassLoaderæ˜¯ä¸€ä¸ªé‡è¦çš„Javaè¿è¡Œæ—¶ç³»ç»Ÿç»„ä»¶ï¼Œå®ƒè´Ÿè´£åœ¨è¿è¡Œæ—¶æŸ¥æ‰¾å’Œè£…å…¥Classå­—èŠ‚ç æ–‡ä»¶ã€‚JVMåœ¨è¿è¡Œæ—¶ä¼šäº§ç”Ÿä¸‰ä¸ªClassLoaderï¼šæ ¹è£…è½½å™¨ã€ExtClassLoaderï¼ˆæ‰©å±•ç±»è£…è½½å™¨ï¼‰å’ŒAppClassLoaderï¼ˆç³»ç»Ÿç±»è£…è½½å™¨ï¼‰ã€‚å…¶ä¸­ï¼Œæ ¹è£…è½½å™¨ä¸æ˜¯ClassLoaderçš„å­ç±»ï¼Œå®ƒä½¿ç”¨C++ç¼–å†™ï¼Œå› æ­¤æˆ‘ä»¬åœ¨Javaä¸­çœ‹ä¸åˆ°å®ƒï¼Œæ ¹è£…è½½å™¨è´Ÿè´£è£…è½½JREçš„æ ¸å¿ƒç±»åº“ï¼Œå¦‚JREç›®æ ‡ä¸‹çš„rt.jarã€charsets.jarç­‰ã€‚ExtClassLoaderå’ŒAppClassLoaderéƒ½æ˜¯ClassLoaderçš„å­ç±»ã€‚å…¶ä¸­ExtClassLoaderè´Ÿè´£è£…è½½JREæ‰©å±•ç›®å½•extä¸­çš„JARç±»åŒ…ï¼›AppClassLoaderè´Ÿè´£è£…è½½Classpathè·¯å¾„ä¸‹çš„ç±»åŒ…ã€‚ </p>
<p>è¿™ä¸‰ä¸ªç±»è£…è½½å™¨ä¹‹é—´å­˜åœ¨çˆ¶å­å±‚çº§å…³ç³»ï¼Œå³æ ¹è£…è½½å™¨æ˜¯ExtClassLoaderçš„çˆ¶è£…è½½å™¨ï¼ŒExtClassLoaderæ˜¯AppClassLoaderçš„çˆ¶è£…è½½å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨AppClassLoaderè£…è½½åº”ç”¨ç¨‹åºçš„ç±»ï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€ä¸ªå®éªŒï¼š </p>
<p>ä»£ç æ¸…å•3-11  ClassLoaderTest<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class ClassLoaderTest &#123;  </div><div class="line">    public static void main(String[] args) &#123;  </div><div class="line">        ClassLoader loader = Thread.currentThread().getContextClassLoader();  </div><div class="line">        System.out.println(&quot;current loader:&quot;+loader);  </div><div class="line">        System.out.println(&quot;parent loader:&quot;+loader.getParent());  </div><div class="line">        System.out.println(&quot;grandparent loader:&quot;+loader.getParent(). getParent());  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿è¡Œä»¥ä¸Šä»£ç ï¼Œåœ¨æ§åˆ¶å°ä¸Šå°†æ‰“å‡ºä»¥ä¸‹ä¿¡æ¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">current loader:sun.misc.Launcher$AppClassLoader@131f71a </div><div class="line">parent loader:sun.misc.Launcher$ExtClassLoader@15601ea </div><div class="line"> //â‘ æ ¹è£…è½½å™¨åœ¨Javaä¸­è®¿é—®ä¸åˆ°ï¼Œæ‰€ä»¥è¿”å›null </div><div class="line">grandparent loader:null</div></pre></td></tr></table></figure></p>
<p>é€šè¿‡ä»¥ä¸Šçš„è¾“å‡ºä¿¡æ¯ï¼Œæˆ‘ä»¬çŸ¥é“å½“å‰çš„ClassLoaderæ˜¯AppClassLoaderï¼Œçˆ¶ClassLoaderæ˜¯ExtClassLoaderï¼Œç¥–çˆ¶ClassLoaderæ˜¯æ ¹ç±»è£…è½½å™¨ï¼Œå› ä¸ºåœ¨Javaä¸­æ— æ³•è·å¾—å®ƒçš„å¥æŸ„ï¼Œæ‰€ä»¥ä»…è¿”å›nullã€‚ </p>
<p>JVMè£…è½½ç±»æ—¶ä½¿ç”¨â€œå…¨ç›˜è´Ÿè´£å§”æ‰˜æœºåˆ¶â€ï¼Œâ€œå…¨ç›˜è´Ÿè´£â€æ˜¯æŒ‡å½“ä¸€ä¸ªClassLoaderè£…è½½ä¸€ä¸ªç±»çš„æ—¶ï¼Œé™¤éæ˜¾å¼åœ°ä½¿ç”¨å¦ä¸€ä¸ªClassLoaderï¼Œè¯¥ç±»æ‰€ä¾èµ–åŠå¼•ç”¨çš„ç±»ä¹Ÿç”±è¿™ä¸ªClassLoaderè½½å…¥ï¼›â€œå§”æ‰˜æœºåˆ¶â€æ˜¯æŒ‡å…ˆå§”æ‰˜çˆ¶è£…è½½å™¨å¯»æ‰¾ç›®æ ‡ç±»ï¼Œåªæœ‰åœ¨æ‰¾ä¸åˆ°çš„æƒ…å†µä¸‹æ‰ä»è‡ªå·±çš„ç±»è·¯å¾„ä¸­æŸ¥æ‰¾å¹¶è£…è½½ç›®æ ‡ç±»ã€‚è¿™ä¸€ç‚¹æ˜¯ä»å®‰å…¨è§’åº¦è€ƒè™‘çš„ï¼Œè¯•æƒ³å¦‚æœæœ‰äººç¼–å†™äº†ä¸€ä¸ªæ¶æ„çš„åŸºç¡€ç±»ï¼ˆå¦‚java.lang.Stringï¼‰å¹¶è£…è½½åˆ°JVMä¸­å°†ä¼šå¼•èµ·å¤šä¹ˆå¯æ€•çš„åæœã€‚ä½†æ˜¯ç”±äºæœ‰äº†â€œå…¨ç›˜è´Ÿè´£å§”æ‰˜æœºåˆ¶â€ï¼Œjava.lang.Stringæ°¸è¿œæ˜¯ç”±æ ¹è£…è½½å™¨æ¥è£…è½½çš„ï¼Œè¿™æ ·å°±é¿å…äº†ä¸Šè¿°äº‹ä»¶çš„å‘ç”Ÿã€‚ </p>
<h4 id="ClassLoaderé‡è¦æ–¹æ³•"><a href="#ClassLoaderé‡è¦æ–¹æ³•" class="headerlink" title="ClassLoaderé‡è¦æ–¹æ³•"></a>ClassLoaderé‡è¦æ–¹æ³•</h4><p>åœ¨Javaä¸­ï¼ŒClassLoaderæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä½äºjava.langåŒ…ä¸­ã€‚ä¸‹é¢å¯¹è¯¥ç±»çš„ä¸€äº›é‡è¦æ¥å£æ–¹æ³•è¿›è¡Œä»‹ç»ï¼š </p>
<ul>
<li><p>Class loadClass(String name)<br>  nameå‚æ•°æŒ‡å®šç±»è£…è½½å™¨éœ€è¦è£…è½½ç±»çš„åå­—ï¼Œå¿…é¡»ä½¿ç”¨å…¨é™å®šç±»åï¼Œå¦‚com.baobaotao. beans.Carã€‚è¯¥æ–¹æ³•æœ‰ä¸€ä¸ªé‡è½½æ–¹æ³•loadClass(String name ,boolean resolve)ï¼Œresolveå‚æ•°å‘Šè¯‰ç±»è£…è½½å™¨æ˜¯å¦éœ€è¦è§£æè¯¥ç±»ã€‚åœ¨åˆå§‹åŒ–ç±»ä¹‹å‰ï¼Œåº”è€ƒè™‘è¿›è¡Œç±»è§£æçš„å·¥ä½œï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„ç±»éƒ½éœ€è¦è§£æï¼Œå¦‚æœJVMåªéœ€è¦çŸ¥é“è¯¥ç±»æ˜¯å¦å­˜åœ¨æˆ–æ‰¾å‡ºè¯¥ç±»çš„è¶…ç±»ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦è¿›è¡Œè§£æã€‚ </p>
</li>
<li><p>Class defineClass(String name, byte[] b, int off, int len)<br> å°†ç±»æ–‡ä»¶çš„å­—èŠ‚æ•°ç»„è½¬æ¢æˆJVMå†…éƒ¨çš„java.lang.Classå¯¹è±¡ã€‚å­—èŠ‚æ•°ç»„å¯ä»¥ä»æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€è¿œç¨‹ç½‘ç»œè·å–ã€‚nameä¸ºå­—èŠ‚æ•°ç»„å¯¹åº”çš„å…¨é™å®šç±»åã€‚</p>
</li>
<li><p>Class findSystemClass(String name)<br> ä»æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿè½½å…¥Classæ–‡ä»¶ï¼Œå¦‚æœæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸å­˜åœ¨è¯¥Classæ–‡ä»¶ï¼Œå°†æŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸ã€‚è¯¥æ–¹æ³•æ˜¯JVMé»˜è®¤ä½¿ç”¨çš„è£…è½½æœºåˆ¶ã€‚ </p>
</li>
<li><p>Class findLoadedClass(String name)<br>è°ƒç”¨è¯¥æ–¹æ³•æ¥æŸ¥çœ‹ClassLoaderæ˜¯å¦å·²è£…å…¥æŸä¸ªç±»ã€‚å¦‚æœå·²è£…å…¥ï¼Œé‚£ä¹ˆè¿”å›java.lang.Classå¯¹è±¡ï¼Œå¦åˆ™è¿”å›nullã€‚å¦‚æœå¼ºè¡Œè£…è½½å·²å­˜åœ¨çš„ç±»ï¼Œå°†ä¼šæŠ›å‡ºé“¾æ¥é”™è¯¯ã€‚ </p>
</li>
<li><p>ClassLoader getParent()<br> è·å–ç±»è£…è½½å™¨çš„çˆ¶è£…è½½å™¨ï¼Œé™¤æ ¹è£…è½½å™¨å¤–ï¼Œæ‰€æœ‰çš„ç±»è£…è½½å™¨éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªçˆ¶è£…è½½å™¨ï¼ŒExtClassLoaderçš„çˆ¶è£…è½½å™¨æ˜¯æ ¹è£…è½½å™¨ï¼Œå› ä¸ºæ ¹è£…è½½å™¨éJavaç¼–å†™ï¼Œæ‰€ä»¥æ— æ³•è·å¾—ï¼Œå°†è¿”å›nullã€‚ </p>
</li>
</ul>
<p>é™¤JVMé»˜è®¤çš„ä¸‰ä¸ªClassLoaderä»¥å¤–ï¼Œå¯ä»¥ç¼–å†™è‡ªå·±çš„ç¬¬ä¸‰æ–¹ç±»è£…è½½å™¨ï¼Œä»¥å®ç°ä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚ã€‚ç±»æ–‡ä»¶è¢«è£…è½½å¹¶è§£æåï¼Œåœ¨JVMå†…å°†æ‹¥æœ‰ä¸€ä¸ªå¯¹åº”çš„java.lang.Classç±»æè¿°å¯¹è±¡ï¼Œè¯¥ç±»çš„å®ä¾‹éƒ½æ‹¥æœ‰æŒ‡å‘è¿™ä¸ªç±»æè¿°å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œç±»æè¿°å¯¹è±¡åˆæ‹¥æœ‰æŒ‡å‘å…³è”ClassLoaderçš„å¼•ç”¨ï¼Œå¦‚å›¾3-4æ‰€ç¤ºã€‚ </p>
<p><img src="/images/å›¾3-4 ç±»åŠ è½½.jpg"></p>
<p>æ¯ä¸€ä¸ªç±»åœ¨JVMä¸­éƒ½æ‹¥æœ‰ä¸€ä¸ªå¯¹åº”çš„java.lang.Classå¯¹è±¡ï¼Œå®ƒæä¾›äº†ç±»ç»“æ„ä¿¡æ¯çš„æè¿°ã€‚æ•°ç»„ã€æšä¸¾ã€æ³¨è§£ä»¥åŠåŸºæœ¬Javaç±»å‹ï¼ˆå¦‚intã€doubleç­‰ï¼‰ï¼Œç”šè‡³voidéƒ½æ‹¥æœ‰å¯¹åº”çš„Classå¯¹è±¡ã€‚Classæ²¡æœ‰publicçš„æ„é€ æ–¹æ³•ã€‚Classå¯¹è±¡æ˜¯åœ¨è£…è½½ç±»æ—¶ç”±JVMé€šè¿‡è°ƒç”¨ç±»è£…è½½å™¨ä¸­çš„defineClass()æ–¹æ³•è‡ªåŠ¨æ„é€ çš„ã€‚ </p>
<h3 id="Javaåå°„æœºåˆ¶"><a href="#Javaåå°„æœºåˆ¶" class="headerlink" title="Javaåå°„æœºåˆ¶"></a>Javaåå°„æœºåˆ¶</h3><p>Classåå°„å¯¹è±¡æè¿°ç±»è¯­ä¹‰ç»“æ„ï¼Œå¯ä»¥ä»Classå¯¹è±¡ä¸­è·å–æ„é€ å‡½æ•°ã€æˆå‘˜å˜é‡ã€æ–¹æ³•ç±»ç­‰ç±»å…ƒç´ çš„åå°„å¯¹è±¡ï¼Œå¹¶ä»¥ç¼–ç¨‹çš„æ–¹å¼é€šè¿‡è¿™äº›åå°„å¯¹è±¡å¯¹ç›®æ ‡ç±»å¯¹è±¡è¿›è¡Œæ“ä½œã€‚è¿™äº›åå°„å¯¹è±¡ç±»åœ¨java.reflectåŒ…ä¸­å®šä¹‰ï¼Œä¸‹é¢æ˜¯æœ€ä¸»è¦çš„ä¸‰ä¸ªåå°„ç±»ï¼š </p>
<ul>
<li><p>Constructorï¼šç±»çš„æ„é€ å‡½æ•°åå°„ç±»ï¼Œé€šè¿‡Class#getConstructors()æ–¹æ³•å¯ä»¥è·å¾—ç±»çš„æ‰€æœ‰æ„é€ å‡½æ•°åå°„å¯¹è±¡æ•°ç»„ã€‚åœ¨JDK5.0ä¸­ï¼Œè¿˜å¯ä»¥é€šè¿‡getConstructor(Classâ€¦ parameterTypes)è·å–æ‹¥æœ‰ç‰¹å®šå…¥å‚çš„æ„é€ å‡½æ•°åå°„å¯¹è±¡ã€‚Constructorçš„ä¸€ä¸ªä¸»è¦æ–¹æ³•æ˜¯newInstance(Object[] initargs)ï¼Œé€šè¿‡è¯¥æ–¹æ³•å¯ä»¥åˆ›å»ºä¸€ä¸ªå¯¹è±¡ç±»çš„å®ä¾‹ï¼Œç›¸å½“äºnewå…³é”®å­—ã€‚åœ¨JDK5.0ä¸­è¯¥æ–¹æ³•æ¼”åŒ–ä¸ºæ›´ä¸ºçµæ´»çš„å½¢å¼ï¼šnewInstance (Objectâ€¦ initargs)ã€‚</p>
</li>
<li><p>Methodï¼šç±»æ–¹æ³•çš„åå°„ç±»ï¼Œé€šè¿‡Class#getDeclaredMethods()æ–¹æ³•å¯ä»¥è·å–ç±»çš„æ‰€æœ‰æ–¹æ³•åå°„ç±»å¯¹è±¡æ•°ç»„Method[]ã€‚åœ¨JDK5.0ä¸­å¯ä»¥é€šè¿‡getDeclaredMethod(String name, Classâ€¦ parameterTypes)è·å–ç‰¹å®šç­¾åçš„æ–¹æ³•ï¼Œnameä¸ºæ–¹æ³•åï¼›Classâ€¦ä¸ºæ–¹æ³•å…¥å‚ç±»å‹åˆ—è¡¨ã€‚Methodæœ€ä¸»è¦çš„æ–¹æ³•æ˜¯invoke(Object obj, Object[] args)ï¼Œobjè¡¨ç¤ºæ“ä½œçš„ç›®æ ‡å¯¹è±¡ï¼›argsä¸ºæ–¹æ³•å…¥å‚ï¼Œä»£ç æ¸…å•3 10â‘¢å¤„æ¼”ç¤ºäº†è¿™ä¸ªåå°„ç±»çš„ä½¿ç”¨æ–¹æ³•ã€‚åœ¨JDK 5.0ä¸­ï¼Œè¯¥æ–¹æ³•çš„å½¢å¼è°ƒæ•´ä¸ºinvoke(Object obj, Objectâ€¦ args)ã€‚æ­¤å¤–ï¼ŒMethodè¿˜æœ‰å¾ˆå¤šç”¨äºè·å–ç±»æ–¹æ³•æ›´å¤šä¿¡æ¯çš„æ–¹æ³•ï¼š</p>
<pre><code>- Class getReturnType()ï¼šè·å–æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼› 
- Class[] getParameterTypes()ï¼šè·å–æ–¹æ³•çš„å…¥å‚ç±»å‹æ•°ç»„ï¼› 
- Class[] getExceptionTypes()ï¼šè·å–æ–¹æ³•çš„å¼‚å¸¸ç±»å‹æ•°ç»„ï¼› 
- Annotation[][] getParameterAnnotations()ï¼šè·å–æ–¹æ³•çš„æ³¨è§£ä¿¡æ¯ï¼ŒJDK 5.0ä¸­çš„æ–°æ–¹æ³•ï¼›
</code></pre></li>
<li><p>Fieldï¼šç±»çš„æˆå‘˜å˜é‡çš„åå°„ç±»ï¼Œé€šè¿‡Class#getDeclaredFields()æ–¹æ³•å¯ä»¥è·å–ç±»çš„æˆå‘˜å˜é‡åå°„å¯¹è±¡æ•°ç»„ï¼Œé€šè¿‡Class#getDeclaredField(String name)åˆ™å¯è·å–æŸä¸ªç‰¹å®šåç§°çš„æˆå‘˜å˜é‡åå°„å¯¹è±¡ã€‚Fieldç±»æœ€ä¸»è¦çš„æ–¹æ³•æ˜¯set(Object obj, Object value)ï¼Œobjè¡¨ç¤ºæ“ä½œçš„ç›®æ ‡å¯¹è±¡ï¼Œé€šè¿‡valueä¸ºç›®æ ‡å¯¹è±¡çš„æˆå‘˜å˜é‡è®¾ç½®å€¼ã€‚å¦‚æœæˆå‘˜å˜é‡ä¸ºåŸºç¡€ç±»å‹ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨Fieldç±»ä¸­æä¾›çš„å¸¦ç±»å‹åçš„å€¼è®¾ç½®æ–¹æ³•ï¼Œå¦‚setBoolean(Object obj, boolean value)ã€setInt(Object obj, int value)ç­‰ã€‚</p>
</li>
</ul>
<p>æ­¤å¤–ï¼ŒJavaè¿˜ä¸ºåŒ…æä¾›äº†Packageåå°„ç±»ï¼Œåœ¨JDK 5.0ä¸­è¿˜ä¸ºæ³¨è§£æä¾›äº†AnnotatedElementåå°„ç±»ã€‚æ€»ä¹‹ï¼ŒJavaçš„åå°„ä½“ç³»ä¿è¯äº†å¯ä»¥é€šè¿‡ç¨‹åºåŒ–çš„æ–¹å¼è®¿é—®ç›®æ ‡ç±»ä¸­æ‰€æœ‰çš„å…ƒç´ ï¼Œå¯¹äºprivateæˆ–protectedçš„æˆå‘˜å˜é‡å’Œæ–¹æ³•ï¼Œåªè¦JVMçš„å®‰å…¨æœºåˆ¶å…è®¸ï¼Œä¹Ÿå¯ä»¥é€šè¿‡åå°„è¿›è¡Œè°ƒç”¨ï¼Œè¯·çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š </p>
<p>ä»£ç æ¸…å•3-12  PrivateCarReflect<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">package com.baobaotao.reflect;  </div><div class="line">public class PrivateCar &#123;  </div><div class="line">   //â‘ privateæˆå‘˜å˜é‡ï¼šä½¿ç”¨ä¼ ç»Ÿçš„ç±»å®ä¾‹è°ƒç”¨æ–¹å¼ï¼Œåªèƒ½åœ¨æœ¬ç±»ä¸­è®¿é—®  </div><div class="line">   private String color;   </div><div class="line">   //â‘¡protectedæ–¹æ³•ï¼šä½¿ç”¨ä¼ ç»Ÿçš„ç±»å®ä¾‹è°ƒç”¨æ–¹å¼ï¼Œåªèƒ½åœ¨å­ç±»å’Œæœ¬åŒ…ä¸­è®¿é—®  </div><div class="line">   protected void drive()&#123;       </div><div class="line">		System.out.println(&quot;drive private car! the color is:&quot;+color);  </div><div class="line">   &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>colorå˜é‡å’Œdrive()æ–¹æ³•éƒ½æ˜¯ç§æœ‰çš„ï¼Œé€šè¿‡ç±»å®ä¾‹å˜é‡æ— æ³•åœ¨å¤–éƒ¨è®¿é—®ç§æœ‰å˜é‡ã€è°ƒç”¨ç§æœ‰æ–¹æ³•çš„ï¼Œä½†é€šè¿‡åå°„æœºåˆ¶å´å¯ä»¥ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼š </p>
<p>ä»£ç æ¸…å•3-13  PrivateCarReflect<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">â€¦  </div><div class="line">public class PrivateCarReflect &#123;  </div><div class="line">   public static void main(String[] args) throws Throwable&#123;  </div><div class="line">       ClassLoader loader = Thread.currentThread().getContextClassLoader();  </div><div class="line">       Class clazz = loader.loadClass(&quot;com.baobaotao.reflect.PrivateCar&quot;);  </div><div class="line">       PrivateCar pcar = (PrivateCar)clazz.newInstance();   </div><div class="line">       Field colorFld = clazz.getDeclaredField(&quot;color&quot;);  </div><div class="line">        //â‘ å–æ¶ˆJavaè¯­è¨€è®¿é—®æ£€æŸ¥ä»¥è®¿é—®privateå˜é‡  </div><div class="line">       colorFld.setAccessible(true);   </div><div class="line">       colorFld.set(pcar,&quot;çº¢è‰²&quot;);  </div><div class="line">       Method driveMtd = clazz.getDeclaredMethod(&quot;drive&quot;,(Class[])null);  </div><div class="line">        //Method driveMtd = clazz.getDeclaredMethod(&quot;drive&quot;); JDK5.0ä¸‹ä½¿ç”¨  </div><div class="line">        //â‘¡å–æ¶ˆJavaè¯­è¨€è®¿é—®æ£€æŸ¥ä»¥è®¿é—®protectedæ–¹æ³•  </div><div class="line">       driveMtd.setAccessible(true);   </div><div class="line">       driveMtd.invoke(pcar,(Object[])null);  </div><div class="line">  &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿è¡Œè¯¥ç±»ï¼Œæ‰“å°å‡ºä»¥ä¸‹ä¿¡æ¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">drive private car! the color is:çº¢è‰²</div></pre></td></tr></table></figure></p>
<p>åœ¨è®¿é—®privateã€protectedæˆå‘˜å˜é‡å’Œæ–¹æ³•æ—¶å¿…é¡»é€šè¿‡setAccessible(boolean access)æ–¹æ³•å–æ¶ˆJavaè¯­è¨€æ£€æŸ¥ï¼Œå¦åˆ™å°†æŠ›å‡ºIllegalAccessExceptionã€‚å¦‚æœJVMçš„å®‰å…¨ç®¡ç†å™¨è®¾ç½®äº†ç›¸åº”çš„å®‰å…¨æœºåˆ¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•å°†æŠ›å‡ºSecurityExceptionã€‚ </p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[HashMap]]></title>
      <url>http://zsr.github.io/2016/08/01/HashMap/</url>
      <content type="html"><![CDATA[<h1 id="OpenJDK-æºä»£ç é˜…è¯»ä¹‹-HashMap"><a href="#OpenJDK-æºä»£ç é˜…è¯»ä¹‹-HashMap" class="headerlink" title="OpenJDK æºä»£ç é˜…è¯»ä¹‹ HashMap"></a>OpenJDK æºä»£ç é˜…è¯»ä¹‹ HashMap</h1><hr>
<h2 id="æ¦‚è¦"><a href="#æ¦‚è¦" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h2><ul>
<li>ç±»ç»§æ‰¿å…³ç³»</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">java.lang.Object</div><div class="line">    java.util.AbstractMap&lt;K,V&gt;</div><div class="line">        java.util.HashMap&lt;K,V&gt;</div></pre></td></tr></table></figure>
<ul>
<li>å®šä¹‰ </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public class HashMap&lt;K,V&gt;</div><div class="line">extends AbstractMap&lt;K,V&gt;</div><div class="line">implements Map&lt;K,V&gt;, Cloneable, Serializable</div></pre></td></tr></table></figure>
<ul>
<li>æ ¸å¿ƒæˆå‘˜å˜é‡</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;  <span class="comment">//é»˜è®¤è£…è½½å› å­</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">float</span> loadFactor;    <span class="comment">//è£…è½½å› å­</span></div><div class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;   <span class="comment">//æ•°ç»„ï¼Œä½œä¸ºHashæ¡¶</span></div></pre></td></tr></table></figure>
<ul>
<li>å†…éƒ¨èŠ‚ç‚¹</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> hash;   <span class="comment">//hashå€¼</span></div><div class="line">       <span class="keyword">final</span> K key;      <span class="comment">//é”®</span></div><div class="line">       V value;          <span class="comment">//å€¼</span></div><div class="line">       Node&lt;K,V&gt; next;   <span class="comment">//æŒ‡å‘hashå€¼ç›¸åŒçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></div><div class="line"></div><div class="line">       Node(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</div><div class="line">           <span class="keyword">this</span>.hash = hash;</div><div class="line">           <span class="keyword">this</span>.key = key;</div><div class="line">           <span class="keyword">this</span>.value = value;</div><div class="line">           <span class="keyword">this</span>.next = next;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>        </span>&#123; <span class="keyword">return</span> key; &#125;</div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>      </span>&#123; <span class="keyword">return</span> value; &#125;</div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> key + <span class="string">"="</span> + value; &#125;</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">setValue</span><span class="params">(V newValue)</span> </span>&#123;</div><div class="line">           V oldValue = value;</div><div class="line">           value = newValue;</div><div class="line">           <span class="keyword">return</span> oldValue;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<ul>
<li>è¦ç‚¹</li>
</ul>
<p>1) ä¸ Hashtable åŒºåˆ«åœ¨äºï¼šéåŒæ­¥ï¼Œå…è®¸ <code>null</code><br>2) ä¸ä¿è¯æ¬¡åºï¼Œç”šè‡³ä¸ä¿è¯æ¬¡åºéšæ—¶é—´ä¸å˜<br>3) åŸºæœ¬æ“ä½œ put, get å¸¸é‡æ—¶é—´<br>4) éå†æ“ä½œ ä¸ capacity+size æˆæ­£æ¯”<br>5) HashMap æ€§èƒ½ä¸ <code>capacity</code> å’Œ <code>load factor</code> ç›¸å…³ï¼Œ<code>load factor</code> æ˜¯å½“å‰å…ƒç´ ä¸ªæ•°ä¸ <code>capacity</code> çš„æ¯”å€¼ï¼Œé€šå¸¸è®¾å®šä¸º <code>0.75</code>ï¼Œå¦‚æœæ­¤å€¼è¿‡å¤§ï¼Œç©ºé—´åˆ©ç”¨ç‡é«˜ï¼Œä½†æ˜¯å†²çªçš„å¯èƒ½æ€§å¢åŠ ï¼Œå› è€Œå¯èƒ½å¯¼è‡´æŸ¥æ‰¾æ—¶é—´å¢åŠ ï¼Œå¦‚æœè¿‡å°ï¼Œåä¹‹ã€‚å½“å…ƒç´ ä¸ªæ•°å¤§äº <code>capacity * load_factor</code> æ—¶ï¼Œ<code>HashMap</code> ä¼šé‡æ–°å®‰æ’ Hash è¡¨ã€‚å› æ­¤é«˜æ•ˆåœ°ä½¿ç”¨ <code>HashMap</code> éœ€è¦é¢„ä¼°å…ƒç´ ä¸ªæ•°ï¼Œè®¾ç½®æœ€ä½³çš„ <code>capacity</code> å’Œ <code>load factor</code> ï¼Œä½¿å¾—é‡æ–°å®‰æ’ Hash è¡¨çš„æ¬¡æ•°ä¸‹é™ã€‚</p>
<a id="more"></a>
<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><ul>
<li>capacity</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> +</div><div class="line">                                           initialCapacity);</div><div class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</div><div class="line">        initialCapacity = MAXIMUM_CAPACITY;</div><div class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> +</div><div class="line">                                           loadFactor);</div><div class="line"></div><div class="line">    <span class="comment">// Find a power of 2 &gt;= initialCapacity</span></div><div class="line">    <span class="keyword">int</span> capacity = <span class="number">1</span>;</div><div class="line">    <span class="keyword">while</span> (capacity &lt; initialCapacity)</div><div class="line">        capacity &lt;&lt;= <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.loadFactor = loadFactor;</div><div class="line">    threshold = (<span class="keyword">int</span>)Math.min(capacity * loadFactor, MAXIMUM_CAPACITY + <span class="number">1</span>);</div><div class="line">    table = <span class="keyword">new</span> Entry[capacity];</div><div class="line">    useAltHashing = sun.misc.VM.isBooted() &amp;&amp;</div><div class="line">            (capacity &gt;= Holder.ALTERNATIVE_HASHING_THRESHOLD);</div><div class="line">    init();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œ<code>HashMap</code> å¹¶ä¸ä¼šæŒ‰ç…§ä½ æŒ‡å®šçš„ <code>initialCapacity</code> æ¥ç¡®å®š <code>capacity</code> å¤§å°ï¼Œè€Œæ˜¯ä¼šæ‰¾åˆ°ä¸€ä¸ªæ¯”å®ƒå¤§çš„æ•°ï¼Œå¹¶ä¸”æ˜¯ <code>2çš„næ¬¡æ–¹</code>ï¼ˆåŸå› è§æœ«å°¾ï¼‰ã€‚</p>
<ul>
<li>hash </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Retrieve object hash code and applies a supplemental hash function to the</div><div class="line"> * result hash, which defends against poor quality hash functions.  This is</div><div class="line"> * critical because HashMap uses power-of-two length hash tables, that</div><div class="line"> * otherwise encounter collisions for hashCodes that do not differ</div><div class="line"> * in lower bits. Note: Null keys always map to hash 0, thus index 0.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object k)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> h = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (useAltHashing) &#123;</div><div class="line">        <span class="keyword">if</span> (k <span class="keyword">instanceof</span> String) &#123;</div><div class="line">            <span class="keyword">return</span> sun.misc.Hashing.stringHash32((String) k);</div><div class="line">        &#125;</div><div class="line">        h = hashSeed;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    h ^= k.hashCode();</div><div class="line"></div><div class="line">    <span class="comment">// This function ensures that hashCodes that differ only by</span></div><div class="line">    <span class="comment">// constant multiples at each bit position have a bounded</span></div><div class="line">    <span class="comment">// number of collisions (approximately 8 at default load factor).</span></div><div class="line">    h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</div><div class="line">    <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœ <code>k</code> æ˜¯ <code>String</code> ç±»å‹ï¼Œä½¿ç”¨äº†ç‰¹åˆ«çš„ <code>hash</code> å‡½æ•°ï¼Œå¦åˆ™é¦–å…ˆå¾—åˆ° <code>hashCode</code>ï¼Œç„¶ååˆå¯¹ <code>h</code> ä½œäº†ç§»ä½ï¼Œå¼‚æˆ–æ“ä½œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">at 22: </div><div class="line">h = abcdefgh</div><div class="line">h1 = h &gt;&gt;&gt; 20 = 00000abc</div><div class="line">h2 = h &gt;&gt;&gt; 12 = 000abcde</div><div class="line">h3 = h1 ^ h2 = [0][0][0][a][b][a^c][b^d][c^e]</div><div class="line">h4 = h ^ h3 = [a][b][c][a^d][b^e][a^c^f][b^d^g][c^e^h]</div><div class="line">h5 = h4 &gt;&gt;&gt; 4 = [0][a][b][c][a^d][b^e][a^c^f][b^d^g]</div><div class="line">h6 = h4 &gt;&gt;&gt; 7 = ([0][:3])[0][0][a][b][c][a^d][b^e][a^c^f]([a^c^f][0])</div></pre></td></tr></table></figure>
<ul>
<li>put</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Associates the specified value with the specified key in this map.</div><div class="line"> * If the map previously contained a mapping for the key, the old</div><div class="line"> * value is replaced.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key key with which the specified value is to be associated</div><div class="line"> * <span class="doctag">@param</span> value value to be associated with the specified key</div><div class="line"> * <span class="doctag">@return</span> the previous value associated with &lt;tt&gt;key&lt;/tt&gt;, or</div><div class="line"> *         &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for &lt;tt&gt;key&lt;/tt&gt;.</div><div class="line"> *         (A &lt;tt&gt;null&lt;/tt&gt; return can also indicate that the map</div><div class="line"> *         previously associated &lt;tt&gt;null&lt;/tt&gt; with &lt;tt&gt;key&lt;/tt&gt;.)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> putForNullKey(value);</div><div class="line">    <span class="keyword">int</span> hash = hash(key);</div><div class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</div><div class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</div><div class="line">        Object k;</div><div class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</div><div class="line">            V oldValue = e.value;</div><div class="line">            e.value = value;</div><div class="line">            e.recordAccess(<span class="keyword">this</span>);</div><div class="line">            <span class="keyword">return</span> oldValue;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    modCount++;</div><div class="line">    addEntry(hash, key, value, i);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä» <code>put</code> å…¶å®å¯ä»¥çœ‹å‡ºå„ä¸ª <code>hash</code> è¡¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Œé¦–å…ˆå–å¾— <code>hash</code> å€¼ï¼Œç„¶åç”± <code>indexFor</code> æ‰¾åˆ°é“¾è¡¨å¤´çš„ <code>index</code>ï¼Œç„¶åå¼€å§‹éå†é“¾è¡¨ï¼Œå¦‚æœé“¾è¡¨é‡Œçš„ä¸€ä¸ªå…ƒç´  <code>hash</code> å€¼ä¸å½“å‰ <code>key</code> çš„ <code>hash</code> å€¼ç›¸åŒï¼Œæˆ–è€…å…ƒç´  <code>key</code> çš„å¼•ç”¨ä¸å½“å‰ <code>key</code> ç›¸åŒï¼Œæˆ–è€… <code>equals</code> ç›¸åŒï¼Œå°±è¯´æ˜å½“å‰ <code>key</code> å·²ç»åœ¨ <code>hash</code> è¡¨é‡Œäº†ï¼Œé‚£ä¹ˆä¿®æ”¹å®ƒçš„å€¼ï¼Œè¿”å›æ—§å€¼ã€‚</p>
<p>å¦‚æœä¸åœ¨è¡¨é‡Œï¼Œä¼šè°ƒç”¨ <code>addEntry</code>ï¼Œå°†è¿™ä¸€ <code>(key, value)</code> å¯¹æ·»åŠ è¿›å»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Adds a new entry with the specified key, value and hash code to</div><div class="line"> * the specified bucket.  It is the responsibility of this</div><div class="line"> * method to resize the table if appropriate.</div><div class="line"> *</div><div class="line"> * Subclass overrides this to alter the behavior of put method.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> ((size &gt;= threshold) &amp;&amp; (<span class="keyword">null</span> != table[bucketIndex])) &#123;</div><div class="line">        resize(<span class="number">2</span> * table.length);</div><div class="line">        hash = (<span class="keyword">null</span> != key) ? hash(key) : <span class="number">0</span>;</div><div class="line">        bucketIndex = indexFor(hash, table.length);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    createEntry(hash, key, value, bucketIndex);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Like addEntry except that this version is used when creating entries</div><div class="line"> * as part of Map construction or "pseudo-construction" (cloning,</div><div class="line"> * deserialization).  This version needn't worry about resizing the table.</div><div class="line"> *</div><div class="line"> * Subclass overrides this to alter the behavior of HashMap(Map),</div><div class="line"> * clone, and readObject.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">createEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</div><div class="line">    Entry&lt;K,V&gt; e = table[bucketIndex];</div><div class="line">    table[bucketIndex] = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, e);</div><div class="line">    size++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œæ–°å¢åŠ å…ƒç´ æ—¶ï¼Œå¯èƒ½ä¼šè°ƒæ•´ <code>hash</code> è¡¨çš„å¤§å°ï¼ŒåŸå› ä¹‹å‰å·²ç»è®¨è®ºè¿‡ã€‚ç›´æ¥çš„æ·»åŠ åœ¨ <code>createEntry</code> ä¸­å®Œæˆï¼Œä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰ä½“ç°å‡ºå¦‚ä½•å¤„ç†å†²çªã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Entry(<span class="keyword">int</span> h, K k, V v, Entry&lt;K,V&gt; n) &#123;</div><div class="line">    value = v;</div><div class="line">    next = n;</div><div class="line">    key = k;</div><div class="line">    hash = h;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„è¿™é‡Œï¼Œå°† <code>n</code> èµ‹å€¼ç»™äº† <code>next</code>ï¼Œè¿™å…¶å®å°±æ˜¯å°†æ–°æ·»åŠ çš„é¡¹æŒ‡å‘äº†å½“å‰é“¾è¡¨å¤´ã€‚è¿™ä¸€æ“ä½œåœ¨ <code>Entry</code> çš„æ„é€ å‡½æ•°ä¸­å®Œæˆã€‚</p>
<p><code>put</code> æ“ä½œçš„åŸºæœ¬æ€è·¯åœ¨åˆ°è¿™é‡Œå·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œæœ‰äº†è¿™ä¸ªæ€è·¯ï¼Œä¸éš¾æƒ³è±¡ <code>get</code> æ˜¯å¦‚ä½•åŠ¨ä½œçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> getForNullKey();</div><div class="line">    Entry&lt;K,V&gt; entry = getEntry(key);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span> == entry ? <span class="keyword">null</span> : entry.getValue();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">getEntry</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> hash = (key == <span class="keyword">null</span>) ? <span class="number">0</span> : hash(key);</div><div class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[indexFor(hash, table.length)];</div><div class="line">         e != <span class="keyword">null</span>;</div><div class="line">         e = e.next) &#123;</div><div class="line">        Object k;</div><div class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp;</div><div class="line">            ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">            <span class="keyword">return</span> e;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å’Œ <code>put</code> å·®ä¸å¤šï¼Œåªæ˜¯æ‰¾åˆ°äº†å°±ä¼šè¿”å›ç›¸åº”çš„ <code>value</code> ï¼Œæ‰¾ä¸åˆ°å°±è¿”å› <code>null</code>ã€‚</p>
<ul>
<li>HashMapçš„åº•å±‚æ•°ç»„é•¿åº¦æ€»æ˜¯2çš„næ¬¡æ–¹ åŸå› :</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * Returns index for hash code h.</div><div class="line">    */</div><div class="line">   static int indexFor(int h, int length) &#123;</div><div class="line">   // assert Integer.bitCount(length) == 1 : &quot;length must be a non-zero power of 2&quot;;</div><div class="line">      return h &amp; (length-1);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>å½“lengthä¸º2çš„næ¬¡æ–¹æ—¶ï¼Œh&amp;(length - 1)å°±ç›¸å½“äºå¯¹lengthå–æ¨¡ï¼Œè€Œä¸”é€Ÿåº¦æ¯”ç›´æ¥å–æ¨¡å¿«å¾—å¤šï¼Œè¿™æ˜¯HashMapåœ¨é€Ÿåº¦ä¸Šçš„ä¸€ä¸ªä¼˜åŒ–</p>
<p>indexForæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä»…æœ‰ä¸€æ¡è¯­å¥ï¼šh&amp;(length - 1)ï¼Œè¿™å¥è¯é™¤äº†å–æ¨¡è¿ç®—å¤–è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„è´£ä»»ï¼šå‡åŒ€åˆ†å¸ƒtableæ•°æ®å’Œå……åˆ†åˆ©ç”¨ç©ºé—´ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬å‡è®¾lengthä¸º16(2^n)å’Œ15ï¼Œhä¸º5ã€6ã€7ã€‚</p>
<p><img src="/images/hashmap1-1.jpg"></p>
<p> å½“n=15æ—¶ï¼Œ6å’Œ7çš„ç»“æœä¸€æ ·ï¼Œè¿™æ ·è¡¨ç¤ºä»–ä»¬åœ¨tableå­˜å‚¨çš„ä½ç½®æ˜¯ç›¸åŒçš„ï¼Œä¹Ÿå°±æ˜¯äº§ç”Ÿäº†ç¢°æ’ï¼Œ6ã€7å°±ä¼šåœ¨ä¸€ä¸ªä½ç½®å½¢æˆé“¾è¡¨ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´æŸ¥è¯¢é€Ÿåº¦é™ä½ã€‚è¯šç„¶è¿™é‡Œåªåˆ†æä¸‰ä¸ªæ•°å­—ä¸æ˜¯å¾ˆå¤šï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±çœ‹0-15ã€‚</p>
<p><img src="/images/hashmap1-2.jpg"></p>
<p> ä»ä¸Šé¢çš„å›¾è¡¨ä¸­çœ‹åˆ°æ€»å…±å‘ç”Ÿäº†8æ­¤ç¢°æ’ï¼ŒåŒæ—¶å‘ç°æµªè´¹çš„ç©ºé—´éå¸¸å¤§ï¼Œæœ‰1ã€3ã€5ã€7ã€9ã€11ã€13ã€15å¤„æ²¡æœ‰è®°å½•ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰å­˜æ”¾æ•°æ®ã€‚è¿™æ˜¯å› ä¸ºä»–ä»¬åœ¨ä¸14è¿›è¡Œ&amp;è¿ç®—æ—¶ï¼Œå¾—åˆ°çš„ç»“æœæœ€åä¸€ä½æ°¸è¿œéƒ½æ˜¯0ï¼Œå³0001ã€0011ã€0101ã€0111ã€1001ã€1011ã€1101ã€1111ä½ç½®å¤„æ˜¯ä¸å¯èƒ½å­˜å‚¨æ•°æ®çš„ï¼Œç©ºé—´å‡å°‘ï¼Œè¿›ä¸€æ­¥å¢åŠ ç¢°æ’å‡ ç‡ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´æŸ¥è¯¢é€Ÿåº¦æ…¢ã€‚è€Œå½“length = 16æ—¶ï¼Œlength â€“ 1 = 15 å³1111ï¼Œé‚£ä¹ˆè¿›è¡Œä½ä½&amp;è¿ç®—æ—¶ï¼Œå€¼æ€»æ˜¯ä¸åŸæ¥hashå€¼ç›¸åŒï¼Œè€Œè¿›è¡Œé«˜ä½è¿ç®—æ—¶ï¼Œå…¶å€¼ç­‰äºå…¶ä½ä½å€¼ã€‚æ‰€ä»¥è¯´å½“length = 2^næ—¶ï¼Œä¸åŒçš„hashå€¼å‘ç”Ÿç¢°æ’çš„æ¦‚ç‡æ¯”è¾ƒå°ï¼Œè¿™æ ·å°±ä¼šä½¿å¾—æ•°æ®åœ¨tableæ•°ç»„ä¸­åˆ†å¸ƒè¾ƒå‡åŒ€ï¼ŒæŸ¥è¯¢é€Ÿåº¦ä¹Ÿè¾ƒå¿«ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[gitä½¿ç”¨å°è®°]]></title>
      <url>http://zsr.github.io/2016/08/01/git%E4%BD%BF%E7%94%A8%E5%B0%8F%E8%AE%B0/</url>
      <content type="html"><![CDATA[<h1 id="Gitä½¿ç”¨å°è®°"><a href="#Gitä½¿ç”¨å°è®°" class="headerlink" title="Gitä½¿ç”¨å°è®°"></a>Gitä½¿ç”¨å°è®°</h1><h2 id="å‰è¨€ï¼š"><a href="#å‰è¨€ï¼š" class="headerlink" title="å‰è¨€ï¼š"></a>å‰è¨€ï¼š</h2><p>æˆ‘ä»¬å†™ä»£ç å†™å®Œåæ€»è¦è¿›è¡Œç®¡ç†ï¼Œä»¥å‰å†™çš„å¾ˆå¤šä»£ç è™½ç„¶å†™çš„ä¸æ˜¯å¾ˆå¥½ï¼Œä½†å› ä¸ºæ²¡æœ‰ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ä»£ç ç®¡ç†ä¹ æƒ¯ï¼Œæ‰€ä»¥å¾ˆå¤šéƒ½é—å¤±æ‰äº†ï¼Œä¸ºæ­¤ç°åœ¨éƒ½è¿˜è§‰å¾—å¾ˆå¯æƒœï¼Œè¿‘æ¥åœ¨å­¦ä¹ ä½¿ç”¨gitæ¥è¿›è¡Œä»£ç ç®¡ç†ï¼Œgitæ˜¯ä¸€ä¸ªå¾ˆå¼ºå¤§çš„åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿã€‚</p>
<!--![git](gitæµç¨‹.png)-->
<p><img src="/images/gitæµç¨‹.png"></p>
<h2 id="git"><a href="#git" class="headerlink" title="git"></a>git</h2><h3 id="gitå·¥ä½œæµç¨‹"><a href="#gitå·¥ä½œæµç¨‹" class="headerlink" title="gitå·¥ä½œæµç¨‹"></a>gitå·¥ä½œæµç¨‹</h3><p>äº†è§£gitï¼Œé¦–å…ˆè¦å¼„æ¸…æ¥šå¯¹è±¡åœ¨è¢«gitç®¡ç†è¿‡ç¨‹ä¸­æ‰€å¤„çš„4ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯ï¼šå·¥ä½œç›®å½•ã€index(åˆç§°ä¸ºæš‚å­˜åŒº)ã€æœ¬åœ°ä»“åº“å’Œè¿œç¨‹ä»“åº“ã€‚</p>
<p>ä»æ—¶é—´å…ˆåæ¥è®²ï¼Œå·¥ä½œç›®å½•çš„å†…å®¹æ˜¯ä½ å½“å‰çœ‹åˆ°çš„ï¼Œä¹Ÿæ˜¯æœ€æ–°çš„ï¼›indexåŒºæ ‡è®°äº†ä½ å½“å‰å·¥ä½œç›®å½•ä¸­ï¼Œå“ªäº›å†…å®¹æ˜¯è¢«gitç®¡ç†çš„ï¼›è€Œæœ¬åœ°ä»“åº“ä¿å­˜äº†å¯¹è±¡è¢«æäº¤è¿‡çš„å„ä¸ªç‰ˆæœ¬ï¼Œæ¯”èµ·å·¥ä½œç›®å½•å’Œæš‚å­˜åŒºçš„å†…å®¹ï¼Œå®ƒè¦æ›´æ—§ä¸€äº›ï¼›è¿œç¨‹ä»“åº“æ˜¯æœ¬åœ°ä»“åº“çš„å¼‚åœ°å¤‡ä»½ï¼Œè¿œç¨‹ä»“åº“çš„å†…å®¹å¯èƒ½è¢«åˆ†å¸ƒåœ¨å¤šä¸ªåœ°ç‚¹çš„å¤„äºåä½œå…³ç³»çš„æœ¬åœ°ä»“åº“ä¿®æ”¹ï¼Œå› æ­¤å®ƒå¯èƒ½ä¸æœ¬åœ°ä»“åº“åŒæ­¥ï¼Œä¹Ÿå¯èƒ½ä¸åŒæ­¥ï¼Œä½†æ˜¯å®ƒçš„å†…å®¹æ˜¯æœ€æ—§çš„ã€‚</p>
<p>ä»»ä½•å¯¹è±¡éƒ½æ˜¯åœ¨å·¥ä½œç›®å½•ä¸­è¯ç”Ÿå’Œè¢«ä¿®æ”¹ï¼›ä»»ä½•ä¿®æ”¹éƒ½æ˜¯ä»è¿›å…¥indexåŒºæ‰å¼€å§‹è¢«ç‰ˆæœ¬æ§åˆ¶ï¼›åªæœ‰æŠŠä¿®æ”¹æäº¤åˆ°æœ¬åœ°ä»“åº“ï¼Œè¯¥ä¿®æ”¹æ‰èƒ½åœ¨ä»“åº“ä¸­ç•™ä¸‹ç—•è¿¹ï¼›è€Œè¦ä¸åä½œè€…åˆ†äº«æœ¬åœ°çš„ä¿®æ”¹ï¼Œå¯ä»¥æŠŠå®ƒä»¬pushåˆ°è¿œç¨‹ä»“åº“æ¥å…±äº«ã€‚å›¾æœ€ä¸Šæ–¹çš„addã€commitã€pushç­‰ï¼Œå±•ç¤ºäº†gitä»“åº“çš„äº§ç”Ÿè¿‡ç¨‹ã€‚åè¿‡æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿œç¨‹å†å²ä»“åº“ä¸­è·å¾—æœ¬åœ°ä»“åº“çš„æœ€åä¸€ä¸ªç‰ˆæœ¬ï¼Œcloneåˆ°æœ¬åœ°ï¼Œä»æœ¬åœ°æ£€å‡ºå¯¹è±¡çš„å„ä¸ªç‰ˆæœ¬åˆ°indexæš‚å­˜åŒºæˆ–å·¥ä½œç›®å½•ä¸­ï¼Œä»è€Œå®ç°ä»»ä½•å¯¹è±¡æˆ–æ•´ä¸ªä»“åº“çš„ä»»æ„é˜¶æ®µçŠ¶æ€çš„â€å›æ»šâ€ã€‚å½“æ­£å‘å’Œåå‘éƒ½èƒ½è‡ªç”±åˆ‡æ¢åï¼Œgitå°±å¼ºå¤§åˆ°æ— æ‰€ä¸èƒ½äº†ã€‚<br><a id="more"></a></p>
<h3 id="è¿œç¨‹ä»“åº“æ“ä½œå‘½ä»¤"><a href="#è¿œç¨‹ä»“åº“æ“ä½œå‘½ä»¤" class="headerlink" title="è¿œç¨‹ä»“åº“æ“ä½œå‘½ä»¤"></a>è¿œç¨‹ä»“åº“æ“ä½œå‘½ä»¤</h3><ul>
<li><p>ä»è¿œç¨‹ä»“åº“å…‹éš†ä»“åº“åˆ°æœ¬åœ°ï¼š$ git clone git://github.com/**.git</p>
</li>
<li><p>æŸ¥çœ‹è¿œç¨‹ä»“åº“åˆ«åä»¥åŠåœ°å€ï¼š$ git remote -v</p>
</li>
<li><p>æ·»åŠ è¿œç¨‹ä»“åº“ï¼š$ git remote add [name] [url]</p>
</li>
<li><p>åˆ é™¤è¿œç¨‹ä»“åº“ï¼š$ git remote rm [name]</p>
</li>
<li><p>ä¿®æ”¹è¿œç¨‹ä»“åº“ï¼š$ git remote set-url â€“push [name] [newUrl]</p>
</li>
<li><p>æ‹‰å–è¿œç¨‹ä»“åº“ï¼š$ git pull [remoteName] [localBranchName]</p>
</li>
<li><p>æ¨é€è¿œç¨‹ä»“åº“ï¼š$ git push [remoteName] [localBranchName]</p>
</li>
<li><p>æäº¤æœ¬åœ°teståˆ†æ”¯ä½œä¸ºè¿œç¨‹çš„masteråˆ†æ”¯ï¼š$git push origin test:master</p>
</li>
<li><p>æäº¤æœ¬åœ°teståˆ†æ”¯ä½œä¸ºè¿œç¨‹çš„teståˆ†æ”¯ï¼š$git push origin test:test</p>
</li>
</ul>
<h3 id="åˆ†æ”¯æ“ä½œå‘½ä»¤â€“branch"><a href="#åˆ†æ”¯æ“ä½œå‘½ä»¤â€“branch" class="headerlink" title="åˆ†æ”¯æ“ä½œå‘½ä»¤â€“branch"></a>åˆ†æ”¯æ“ä½œå‘½ä»¤â€“branch</h3><ul>
<li><p>æŸ¥çœ‹è¿œç¨‹å’Œæœ¬åœ°æ‰€æœ‰åˆ†æ”¯ï¼š$ git branch -a</p>
</li>
<li><p>åˆ›å»ºæœ¬åœ°åˆ†æ”¯ï¼š$ git branch [name]</p>
</li>
<li><p>åˆ‡æ¢åˆ†æ”¯ï¼š$ git checkout [name]</p>
</li>
<li><p>åˆ›å»ºæ–°åˆ†æ”¯å¹¶ä¸”åˆ‡æ¢åˆ°æ–°çš„åˆ†æ”¯ï¼š$ git check -b [name]</p>
</li>
<li><p>å¤åˆ¶è¿œç¨‹çš„åˆ†æ”¯å¹¶ä¸”ä»¥æ­¤æ¥åˆ›å»ºæ–°åˆ†æ”¯ï¼š$ git check -t /remotes/origin/branch1 //è¿™æ ·å°±èƒ½åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªå¤åˆ¶æ¥è‡ªè¿œç¨‹branch1åˆ†æ”¯</p>
</li>
<li><p>åˆ é™¤åˆ†æ”¯ï¼š$ git branch -d [name] //-dé€‰é¡¹åªèƒ½åˆ é™¤å·²ç»å‚ä¸äº†åˆå¹¶çš„åˆ†æ”¯ï¼Œå¯¹äºæœªæœ‰åˆå¹¶çš„åˆ†æ”¯æ˜¯æ— æ³•åˆ é™¤çš„ã€‚å¦‚æœæƒ³å¼ºåˆ¶åˆ é™¤ä¸€ä¸ªåˆ†æ”¯ï¼Œå¯ä»¥ä½¿ç”¨-Dé€‰é¡¹</p>
</li>
<li><p>åˆå¹¶åˆ†æ”¯ï¼š$git merge [name] //å°†åç§°ä¸º[name]çš„åˆ†æ”¯ä¸å½“å‰çš„åˆ†æ”¯åˆå¹¶</p>
</li>
<li><p>åˆ›å»ºè¿œç¨‹åˆ†æ”¯ï¼š(æœ¬åœ°åˆ†æ”¯pushåˆ°è¿œç¨‹)ï¼š$ git push origin [name]</p>
</li>
<li><p>åˆ é™¤è¿œç¨‹åˆ†æ”¯ï¼š$ git push origin :heads/[name] æˆ– $ git push origin :[name]</p>
</li>
</ul>
<h3 id="ç‰ˆæœ¬-tag-æ“ä½œç›¸å…³å‘½ä»¤"><a href="#ç‰ˆæœ¬-tag-æ“ä½œç›¸å…³å‘½ä»¤" class="headerlink" title="ç‰ˆæœ¬(tag)æ“ä½œç›¸å…³å‘½ä»¤"></a>ç‰ˆæœ¬(tag)æ“ä½œç›¸å…³å‘½ä»¤</h3><ul>
<li><p>æŸ¥çœ‹ç‰ˆæœ¬ï¼š$ git tag</p>
</li>
<li><p>åˆ›å»ºç‰ˆæœ¬ï¼š$ git tag [name]</p>
</li>
<li><p>åˆ é™¤ç‰ˆæœ¬ï¼š$ git tag -d [name]</p>
</li>
<li><p>æŸ¥çœ‹è¿œç¨‹ç‰ˆæœ¬ï¼š$ git tag -r</p>
</li>
<li><p>åˆ›å»ºè¿œç¨‹ç‰ˆæœ¬(æœ¬åœ°ç‰ˆæœ¬pushåˆ°è¿œç¨‹)ï¼š$ git push origin [name]</p>
</li>
<li><p>åˆ é™¤è¿œç¨‹ç‰ˆæœ¬ï¼š$ git push origin :refs/tags/[name]</p>
</li>
<li><p>åˆå¹¶è¿œç¨‹ä»“åº“çš„tagåˆ°æœ¬åœ°ï¼š$ git pull origin â€“tags</p>
</li>
<li><p>ä¸Šä¼ æœ¬åœ°tagåˆ°è¿œç¨‹ä»“åº“ï¼š$ git push origin â€“tags</p>
</li>
<li><p>åˆ›å»ºå¸¦æ³¨é‡Šçš„tagï¼š$ git tag -a [name] -m â€˜yourMessageâ€™</p>
</li>
</ul>
<h3 id="å­æ¨¡å—-submodule-ç›¸å…³æ“ä½œå‘½ä»¤"><a href="#å­æ¨¡å—-submodule-ç›¸å…³æ“ä½œå‘½ä»¤" class="headerlink" title="å­æ¨¡å—(submodule)ç›¸å…³æ“ä½œå‘½ä»¤"></a>å­æ¨¡å—(submodule)ç›¸å…³æ“ä½œå‘½ä»¤</h3><ul>
<li><p>æ·»åŠ å­æ¨¡å—ï¼š$ git submodule add [url] [path]</p>
</li>
<li><p>åˆå§‹åŒ–å­æ¨¡å—ï¼š$ git submodule init â€”-åªåœ¨é¦–æ¬¡æ£€å‡ºä»“åº“æ—¶è¿è¡Œä¸€æ¬¡å°±è¡Œ</p>
</li>
<li><p>æ›´æ–°å­æ¨¡å—ï¼š$ git submodule update â€”-æ¯æ¬¡æ›´æ–°æˆ–åˆ‡æ¢åˆ†æ”¯åéƒ½éœ€è¦è¿è¡Œä¸€ä¸‹</p>
</li>
<li><p>åˆ é™¤å­æ¨¡å—ï¼šï¼ˆåˆ†4æ­¥èµ°å“¦ï¼‰</p>
<ul>
<li><p>$ git rm â€“cached [path]</p>
</li>
<li><p>ç¼–è¾‘â€œ.gitmodulesâ€æ–‡ä»¶ï¼Œå°†å­æ¨¡å—çš„ç›¸å…³é…ç½®èŠ‚ç‚¹åˆ é™¤æ‰</p>
</li>
<li><p>ç¼–è¾‘â€œ .git/configâ€æ–‡ä»¶ï¼Œå°†å­æ¨¡å—çš„ç›¸å…³é…ç½®èŠ‚ç‚¹åˆ é™¤æ‰</p>
</li>
<li><p>æ‰‹åŠ¨åˆ é™¤å­æ¨¡å—æ®‹ç•™çš„ç›®å½•</p>
</li>
</ul>
</li>
<li><p>å¿½ç•¥ä¸€äº›æ–‡ä»¶ã€æ–‡ä»¶å¤¹ä¸æäº¤</p>
<ul>
<li>åœ¨ä»“åº“æ ¹ç›®å½•ä¸‹åˆ›å»ºåç§°ä¸ºâ€œ.gitignoreâ€çš„æ–‡ä»¶ï¼Œå†™å…¥ä¸éœ€è¦çš„æ–‡ä»¶å¤¹åæˆ–æ–‡ä»¶ï¼Œæ¯ä¸ªå…ƒç´ å ä¸€è¡Œå³å¯ï¼Œå¦‚</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">target</div><div class="line">bin</div><div class="line">*.db</div></pre></td></tr></table></figure>
<ul>
<li><p>åˆ é™¤ç¼“å­˜åŒºçš„æ–‡ä»¶</p>
<ul>
<li>ä¸æ€ä¹ˆè¿›è¡Œåˆ é™¤æ“ä½œï¼Œæ‰€ä»¥å°±å¸¸ç”¨è¿™ä¸€ä¸ªå‘½ä»¤ï¼š$ git rm -r â€“cached .</li>
</ul>
</li>
</ul>
<h3 id="gitæ’¤é”€æ“ä½œ"><a href="#gitæ’¤é”€æ“ä½œ" class="headerlink" title="gitæ’¤é”€æ“ä½œ"></a>gitæ’¤é”€æ“ä½œ</h3><h5 id="æ’¤é”€å·²æš‚å­˜çš„æ“ä½œ"><a href="#æ’¤é”€å·²æš‚å­˜çš„æ“ä½œ" class="headerlink" title="æ’¤é”€å·²æš‚å­˜çš„æ“ä½œ"></a>æ’¤é”€å·²æš‚å­˜çš„æ“ä½œ</h5><p>å¯¹äºä¸€äº›å·²ç»è¢«git addåçš„æ–‡ä»¶ï¼Œå¦‚æœæƒ³è¦æ’¤é”€åˆšåˆšçš„æ“ä½œï¼Œå°±è¦è¿›è¡Œå¦‚ä¸‹æ“ä½œ:</p>
<ul>
<li>é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹æœ¬åœ°æœ‰å“ªäº›å·²ç»è¢«addä½†æ˜¯è¿˜æœªcommitçš„æ•°æ®ï¼Œ</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git status</div></pre></td></tr></table></figure>
<ul>
<li>ç„¶åæ‰¾åˆ°ä½ è¦è¿›è¡Œåˆ æ‰çš„æ–‡ä»¶åï¼Œæ‰§è¡Œï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git reset HEAD filename</div></pre></td></tr></table></figure>
<h5 id="æ’¤é”€commit"><a href="#æ’¤é”€commit" class="headerlink" title="æ’¤é”€commit"></a>æ’¤é”€commit</h5><p>å¯¹äºå·²ç»commitçš„æ•°æ®ï¼Œè¦å›é€€çš„æ­¥éª¤ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git rm -r --cached</div></pre></td></tr></table></figure>
<h3 id="git-ç‰ˆæœ¬å›é€€"><a href="#git-ç‰ˆæœ¬å›é€€" class="headerlink" title="git ç‰ˆæœ¬å›é€€"></a>git ç‰ˆæœ¬å›é€€</h3><h5 id="å…³äºç‰ˆæœ¬å›é€€ç•¥å¾®æœ‰ç‚¹å°å¤æ‚ï¼Œå› ä¸ºå›é€€çš„ç‰ˆæœ¬æ¶‰åŠåˆ°ä¸¤ç§æƒ…å†µï¼Œä¸€ç§å°±æ˜¯æœ¬åœ°çš„ç‰ˆæœ¬å›é€€ï¼Œå¦ä¸€ç§åˆ™æ˜¯æœ¬åœ°å’Œè¿œç¨‹ä»“åº“éƒ½æäº¤åçš„ç‰ˆæœ¬å›é€€"><a href="#å…³äºç‰ˆæœ¬å›é€€ç•¥å¾®æœ‰ç‚¹å°å¤æ‚ï¼Œå› ä¸ºå›é€€çš„ç‰ˆæœ¬æ¶‰åŠåˆ°ä¸¤ç§æƒ…å†µï¼Œä¸€ç§å°±æ˜¯æœ¬åœ°çš„ç‰ˆæœ¬å›é€€ï¼Œå¦ä¸€ç§åˆ™æ˜¯æœ¬åœ°å’Œè¿œç¨‹ä»“åº“éƒ½æäº¤åçš„ç‰ˆæœ¬å›é€€" class="headerlink" title="å…³äºç‰ˆæœ¬å›é€€ç•¥å¾®æœ‰ç‚¹å°å¤æ‚ï¼Œå› ä¸ºå›é€€çš„ç‰ˆæœ¬æ¶‰åŠåˆ°ä¸¤ç§æƒ…å†µï¼Œä¸€ç§å°±æ˜¯æœ¬åœ°çš„ç‰ˆæœ¬å›é€€ï¼Œå¦ä¸€ç§åˆ™æ˜¯æœ¬åœ°å’Œè¿œç¨‹ä»“åº“éƒ½æäº¤åçš„ç‰ˆæœ¬å›é€€"></a>å…³äºç‰ˆæœ¬å›é€€ç•¥å¾®æœ‰ç‚¹å°å¤æ‚ï¼Œå› ä¸ºå›é€€çš„ç‰ˆæœ¬æ¶‰åŠåˆ°ä¸¤ç§æƒ…å†µï¼Œä¸€ç§å°±æ˜¯æœ¬åœ°çš„ç‰ˆæœ¬å›é€€ï¼Œå¦ä¸€ç§åˆ™æ˜¯æœ¬åœ°å’Œè¿œç¨‹ä»“åº“éƒ½æäº¤åçš„ç‰ˆæœ¬å›é€€</h5><p>1.å…ˆæ¥è¯´è¯´æœ¬åœ°çš„å¥½äº†ï¼Œæœ¬åœ°çš„è¯å°±ä¾æ¬¡æ‰§è¡Œä¸€ä¸‹æ“ä½œå³å¯ã€‚</p>
<p>æ ¹æ®-soft,-mixed,-hardï¼Œä¼šå¯¹working treeå’Œindexå’ŒHEADè¿›è¡Œé‡ç½®ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1.git reset -mixedï¼šè¿™ç§ä¸ºé»˜è®¤æ–¹å¼ï¼Œä¸å¸¦ä»»ä½•å‚æ•°çš„git resetï¼Œå®ƒå›é€€åˆ°æŸä¸ªç‰ˆæœ¬ï¼Œåªä¿ç•™æºç ï¼Œå›é€€commitå’Œindexä¿¡æ¯</div><div class="line">2.git reset -soft: å›é€€åˆ°æŸä¸ªç‰ˆæœ¬ï¼Œåªå›é€€äº†commitä¿¡æ¯ï¼Œä¸ä¼šæ¢å¤åˆ°index fileä¸€çº§ã€‚å¦‚æœè¿˜è¦æäº¤çš„è¯ï¼Œç›´æ¥commitå³å¯ã€‚</div><div class="line">3.git reset -hard:å½»åº•å›é€€åˆ°æŸä¸ªç‰ˆæœ¬ï¼Œæœ¬åœ°çš„æºç ä¹Ÿä¼šå˜æˆä¸Šä¸€ä¸ªç‰ˆæœ¬çš„å†…å®¹ï¼Œæ“ä½œéœ€è¦è°¨æ…ï¼ï¼</div><div class="line">ç¤ºä¾‹ï¼š</div><div class="line">* HEADæ˜¯æŒ‡å‘æœ€æ–°çš„æäº¤çš„ï¼Œä¸Šä¸€æ¬¡çš„æäº¤æ˜¯HEAD^,ä¸Šä¸Šæ¬¡æ˜¯HEAD^^,ä¹Ÿå¯ä»¥å†™æˆHEAD~2,å…¶ä¸­çš„--hardè¡¨ç¤ºæ”¾å¼ƒæ‰€æœ‰æœ¬åœ°æ”¹åŠ¨</div><div class="line">git reset --hard HEAD^</div></pre></td></tr></table></figure></p>
<p>æˆ–è€…ä¹Ÿå¯ä»¥å›é€€å€’æŒ‡å®šçš„ç‰ˆæœ¬</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git reset --hard &lt;å“ˆå¸Œå€¼&gt;</div></pre></td></tr></table></figure>
<p>2.å…³äºè¿œç¨‹çš„è¯ä¹Ÿå¾—åˆ†æƒ…å†µäº†ï¼Œå¦‚æœè¿œç¨‹ä»“åº“èƒ½å¤Ÿè¿œç¨‹sshä¸Šå»çš„è¯é‚£å°±æ¯”è¾ƒç®€å•äº†ï¼Œæ–¹æ³•å’Œåœ¨æœ¬åœ°ä¸€æ ·äº†ï¼Œä½†æ˜¯å¦‚æœsshä¸Šä¸ä¸Šå»å°±ä¸è¡Œäº†ï¼Œè¿™é‡Œæˆ‘çœ‹åˆ°æ‰¾åˆ°äº†ä¸¤ç§æ–¹æ³•ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§å°±æ˜¯æ¯”è¾ƒæš´åŠ›çš„æ–¹æ³•ï¼Œå°±æ˜¯ç›´æ¥å¼ºåˆ¶æäº¤ï¼Œgit push -f,ä½†æ˜¯è¿™ä¸ªéå¸¸ä¸æ¨èï¼Œé™¤éä½ æ˜¯è‡ªå·±ä¸€ä¸ªäººå¼€å‘çš„å°é¡¹ç›®ã€‚</li>
<li>ç¬¬äºŒç§å°±æ˜¯å…ˆå°†è¿œç¨‹åˆ†æ”¯å¤‡ä»½å¥½ä»¥åç›´æ¥åˆ é™¤ï¼Œç„¶åå†å°†æœ¬åœ°çš„å›æ»šåçš„ç‰ˆæœ¬çš„pushåˆ°è¿œç¨‹åˆ†æ”¯ä¸Šï¼Œè¿™æ ·å°±ç­‰äºå›é€€äº†ç‰ˆæœ¬ã€‚</li>
</ul>
<h3 id="git-mergeè§£å†²çª"><a href="#git-mergeè§£å†²çª" class="headerlink" title="git mergeè§£å†²çª"></a>git mergeè§£å†²çª</h3><h5 id="åœ¨è¿›è¡Œgitç®¡ç†æ—¶åœ¨å¯¹ä¸¤ä¸ªåˆ†æ”¯è¿›è¡Œmergeæ—¶éš¾å…ä¼šäº§ç”Ÿå†²çªï¼Œè¿™æ—¶å€™å°±è¦å¯¹ä¸¤ä¸ªåˆ†æ”¯è¿›è¡Œè§£å†²çªã€‚"><a href="#åœ¨è¿›è¡Œgitç®¡ç†æ—¶åœ¨å¯¹ä¸¤ä¸ªåˆ†æ”¯è¿›è¡Œmergeæ—¶éš¾å…ä¼šäº§ç”Ÿå†²çªï¼Œè¿™æ—¶å€™å°±è¦å¯¹ä¸¤ä¸ªåˆ†æ”¯è¿›è¡Œè§£å†²çªã€‚" class="headerlink" title="åœ¨è¿›è¡Œgitç®¡ç†æ—¶åœ¨å¯¹ä¸¤ä¸ªåˆ†æ”¯è¿›è¡Œmergeæ—¶éš¾å…ä¼šäº§ç”Ÿå†²çªï¼Œè¿™æ—¶å€™å°±è¦å¯¹ä¸¤ä¸ªåˆ†æ”¯è¿›è¡Œè§£å†²çªã€‚"></a>åœ¨è¿›è¡Œgitç®¡ç†æ—¶åœ¨å¯¹ä¸¤ä¸ªåˆ†æ”¯è¿›è¡Œmergeæ—¶éš¾å…ä¼šäº§ç”Ÿå†²çªï¼Œè¿™æ—¶å€™å°±è¦å¯¹ä¸¤ä¸ªåˆ†æ”¯è¿›è¡Œè§£å†²çªã€‚</h5><p>è¿™é‡Œå‡è®¾æœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸€ä¸ªæ˜¯developåˆ†æ”¯ï¼Œä¸€ä¸ªæ˜¯developbyåˆ†æ”¯ï¼Œdevelopåˆ†æ”¯æ˜¯ä¸»è¦åˆ†æ”¯ï¼Œè¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ åœ¨developbyåˆ†æ”¯é‡Œé¢è¿è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git merge develop</div></pre></td></tr></table></figure>
<p>è¿™æ ·çš„è¯å°±å°†å°†developä¸­çš„å†…å®¹mergeåˆ°äº†developbyåˆ†æ”¯ä¸­ï¼Œå¦‚æœæ²¡æœ‰å†²çªçš„è¯ï¼Œmergeå®Œæˆï¼Œå¦‚æœæœ‰å†²çªçš„è¯ï¼Œè¿è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git diff</div></pre></td></tr></table></figure>
<p>è¿™æ ·çš„è¯gitä¼šåˆ—å‡ºæœ‰å†²çªçš„æ–‡ä»¶ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</div><div class="line">printf (â€œtest1â€³);</div><div class="line">=======</div><div class="line">printf (â€œtest2â€³);</div><div class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt; develop</div></pre></td></tr></table></figure>
<h5 id="æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è®²è§£ä¸€ä¸‹é‡Œé¢çš„ç¬¦å·å„ä»£è¡¨ä»€ä¹ˆæ„æ€ã€‚"><a href="#æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è®²è§£ä¸€ä¸‹é‡Œé¢çš„ç¬¦å·å„ä»£è¡¨ä»€ä¹ˆæ„æ€ã€‚" class="headerlink" title="æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è®²è§£ä¸€ä¸‹é‡Œé¢çš„ç¬¦å·å„ä»£è¡¨ä»€ä¹ˆæ„æ€ã€‚"></a>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è®²è§£ä¸€ä¸‹é‡Œé¢çš„ç¬¦å·å„ä»£è¡¨ä»€ä¹ˆæ„æ€ã€‚</h5><p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; æ ‡è®°å†²çªçš„å¼€å§‹ï¼Œåé¢çš„å†…åŒæ˜¯å½“å‰åˆ†æ”¯ä¸­çš„å†…å®¹ã€‚</p>
<p>HEAD æŒ‡å‘å½“å‰åˆ†æ”¯æœ«æ¢¢çš„æäº¤ã€‚</p>
<p>=======ä¹‹åï¼Œ&gt;&gt;&gt;&gt;&gt;&gt;&gt;ä¹‹å‰ æ˜¯ä»developåˆ†æ”¯ä¸Šé¢mergeè¿‡æ¥çš„ä»£ç ã€‚&gt;&gt;&gt;&gt;&gt;&gt;&gt;ä¹‹åè·Ÿçš„æ˜¯è¦åˆå¹¶è¿‡æ¥çš„åˆ†æ”¯çš„åç§°ã€‚</p>
<h5 id="ç„¶åæˆ‘ä»¬å°±å¼€å§‹æ‰‹åŠ¨è§£å†²çªäº†"><a href="#ç„¶åæˆ‘ä»¬å°±å¼€å§‹æ‰‹åŠ¨è§£å†²çªäº†" class="headerlink" title="ç„¶åæˆ‘ä»¬å°±å¼€å§‹æ‰‹åŠ¨è§£å†²çªäº†"></a>ç„¶åæˆ‘ä»¬å°±å¼€å§‹æ‰‹åŠ¨è§£å†²çªäº†</h5><p>è¿™æ—¶å€™æ ¹æ®ä½ çš„éœ€è¦é€‰æ‹©ä½ è¦ä¿ç•™çš„æ˜¯å“ªä¸ªåˆ†æ”¯ä¸Šçš„ä»£ç ï¼Œä½ è¦åˆ é™¤å“ªä¸ªåˆ†æ”¯ä¸Šçš„ä»£ç ï¼Œæƒ³è¦åˆ é™¤çš„ä»£ç å°±ç›´æ¥åˆ æ‰å°±å¯ä»¥äº†ï¼Œæœ€åå°†å¤šä½™ç¬¦å·åˆ æ‰ä¿å­˜å°±å¯ä»¥äº†ã€‚</p>
<h3 id="ä¸€èˆ¬çš„ä»£ç ç®¡ç†æµç¨‹ï¼š"><a href="#ä¸€èˆ¬çš„ä»£ç ç®¡ç†æµç¨‹ï¼š" class="headerlink" title="ä¸€èˆ¬çš„ä»£ç ç®¡ç†æµç¨‹ï¼š"></a>ä¸€èˆ¬çš„ä»£ç ç®¡ç†æµç¨‹ï¼š</h3><ul>
<li><p>è¿œç¨‹å·²ç»å»ºå®Œä»“åº“åç›´æ¥å…‹éš†åˆ°æœ¬åœ°ï¼š $ git clone [ä»“åº“åœ°å€]</p>
</li>
<li><p>æŸ¥çœ‹æœ¬åœ°å’Œè¿œç¨‹çš„branchï¼š$ git branch -a</p>
</li>
<li><p>å¦‚æœè¿œç¨‹çš„branchæ›´æ–°äº†çš„è¯è¿è¡Œï¼š$ git fetch -p //è¿™æ ·ä¼šå°†è¿œç¨‹çš„åˆ†æ”¯åˆ—è¡¨é‡æ–°æ‹‰å–</p>
</li>
<li><p>å°†è¿œç¨‹çš„branchå¤åˆ¶åˆ°æœ¬åœ°å¹¶ä¸”åˆ‡æ¢åˆ°è¿™ä¸ªåˆ†æ”¯ä¸‹é¢ï¼š$ git checkout -t [è¿œç¨‹åˆ†æ”¯åå­—]</p>
</li>
<li><p>è¿™æ˜¯çœ‹åˆ°è‡ªå·±å·²ç»åœ¨æ–°å»ºçš„branchä¸‹é¢äº†ï¼Œç„¶åçœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰æ–‡ä»¶ã€‚</p>
</li>
<li><p>è‹¥æ²¡æœ‰çš„è¯è¯•ä¸€ä¸‹ï¼š$ git pull</p>
</li>
<li><p>åšå®Œä¿®æ”¹ä»¥åçš„è¯å…ˆaddï¼š$ git add . //è¿™æ ·ä¼šå°†é™¤äº†åœ¨.gitignoreä¸­å†™å…¥çš„æ–‡ä»¶éƒ½åŠ å…¥è¿›è¦æäº¤çš„æ–‡ä»¶å†…</p>
</li>
<li><p>ç„¶åè¿›è¡Œæäº¤åˆ°æœ¬åœ°ä»“åº“ï¼š$ git commit - m â€œæäº¤â€</p>
</li>
<li><p>å¯ä»¥æŸ¥çœ‹çŠ¶æ€ï¼š$ git status æˆ–è€… $git diff</p>
</li>
<li><p>å¦‚æœæ²¡ä»€ä¹ˆé—®é¢˜çš„è¯å°±è¿›è¡Œæäº¤åˆ°è¿œç¨‹åº“ï¼š $ git push //å¦‚æœåŠ å…¥-fçš„è¯æ˜¯å¼ºåˆ¶æäº¤ã€‚</p>
</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ArrayList]]></title>
      <url>http://zsr.github.io/2016/07/29/ArrayList/</url>
      <content type="html"><![CDATA[<h1 id="OpenJDK-æºç é˜…è¯»ä¹‹-ArrayList"><a href="#OpenJDK-æºç é˜…è¯»ä¹‹-ArrayList" class="headerlink" title="OpenJDK æºç é˜…è¯»ä¹‹ ArrayList"></a>OpenJDK æºç é˜…è¯»ä¹‹ ArrayList</h1><hr>
<h2 id="æ¦‚è¦"><a href="#æ¦‚è¦" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h2><ul>
<li>ç±»ç»§æ‰¿å…³ç³» </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">java.lang.Object</div><div class="line">    java.util.AbstractCollection&lt;E&gt;</div><div class="line">        java.util.AbstractList&lt;E&gt;</div><div class="line">            java.util.ArrayList&lt;E&gt;</div></pre></td></tr></table></figure>
<ul>
<li>å®šä¹‰</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractList</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">        <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt;, <span class="title">RandomAccess</span>, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></div><div class="line">&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><ul>
<li>transient</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Object[] elementData;</div></pre></td></tr></table></figure>
<p>å£°æ˜ä¸º <code>transient</code>åï¼Œè¿™ä¸ªå­—æ®µä¸ä¼šè¢«åºåˆ—åŒ–ã€‚</p>
<ul>
<li>toArray</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Constructs a list containing the elements of the specified</div><div class="line"> * collection, in the order they are returned by the collection's</div><div class="line"> * iterator.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> c the collection whose elements are to be placed into this list</div><div class="line"> * <span class="doctag">@throws</span> NullPointerException if the specified collection is null</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</div><div class="line">    elementData = c.toArray();</div><div class="line">    size = elementData.length;</div><div class="line">    <span class="comment">// c.toArray might (incorrectly) not return Object[] (see 6260652)</span></div><div class="line">    <span class="keyword">if</span> (elementData.getClass() != Object[].class)</div><div class="line">        elementData = Arrays.copyOf(elementData, size, Object[].class);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„å¯¹ <code>elementData</code> çš„æ£€æŸ¥ï¼Œ<a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=6260652" target="_blank" rel="external">Bug 6260652</a>ä¸­å¯¹æ­¤æœ‰è¯¦ç»†æè¿°ã€‚ä¸»è¦åŸå› æ˜¯ <code>c.toArray()</code> ä¸ä¸€å®šä¼šè¿”å›ã€€<code>Object[]</code> ç±»å‹çš„å€¼ã€‚</p>
<a id="more"></a>
<ul>
<li>SuppressWarnings</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">               ArrayList&lt;E&gt; v = (ArrayList&lt;E&gt;) <span class="keyword">super</span>.clone();</div></pre></td></tr></table></figure>
<p>å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œå¯¹ç‰¹å®šç±»å‹çš„ <code>warning</code> ä¿æŒé™é»˜ã€‚</p>
<ul>
<li>å‚æ•°æ£€æŸ¥</li>
</ul>
<p>å¯ä»¥çœ‹å‡ºæ ‡å‡†åº“ä¸­çš„ç¨‹åºï¼Œåœ¨å¾ˆå¤šåœ°æ–¹éƒ½éœ€è¦å¯¹å‚æ•°è¿›è¡Œæ£€æŸ¥ï¼Œä»¥ä¿è¯ç¨‹åºçš„å¥å£®æ€§ã€‚</p>
<p>æ£€æŸ¥ <code>null</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">indexOf</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (o == <span class="keyword">null</span>) &#123;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</div></pre></td></tr></table></figure>
<p>æ£€æŸ¥å‚æ•°ä¸Šç•Œï¼Œä¸‹ç•Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</div><div class="line">       <span class="comment">// overflow-conscious code</span></div><div class="line">       <span class="keyword">int</span> oldCapacity = elementData.length;</div><div class="line">       <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</div><div class="line">       <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</div><div class="line">           newCapacity = minCapacity;</div><div class="line">       <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</div><div class="line">           newCapacity = hugeCapacity(minCapacity);</div><div class="line">       <span class="comment">// minCapacity is usually close to size, so this is a win:</span></div><div class="line">       elementData = Arrays.copyOf(elementData, newCapacity);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ul>
<li>ArrayList çš„ index æ£€æŸ¥</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">   <span class="function">E <span class="title">elementData</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> (E) elementData[index];</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">       rangeCheck(index);</div><div class="line"></div><div class="line">       <span class="keyword">return</span> elementData(index);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rangeCheck</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (index &gt;= size)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(outOfBoundsMsg(index));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ã€€<code>rangeCheck</code> åªæ£€æŸ¥äº†ä¸Šç•Œï¼Œä½†æ˜¯å¦‚æœå°†ã€€<code>index</code> è®¾ç½®æˆè´Ÿæ•°ï¼Œä¹Ÿä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¼‚å¸¸æ˜¯åœ¨ <code>elementData[index]</code> ä¸­æŠ›å‡ºçš„ï¼ŒçŒœæƒ³æ˜¯åœ¨æ•°ç»„çš„å®ç°ä¸­ï¼Œå¯¹è´Ÿæ•°è¿›è¡Œæ£€æŸ¥ï¼Œå› ä¸ºä»»ä½•ä¸€ä¸ªæ•°ç»„ï¼Œ<code>index</code> éƒ½ä¸å¯èƒ½ä¸ºè´Ÿæ•°ï¼Œä½†æ˜¯åœ¨å®ç°æ•°ç»„æ—¶ï¼Œä¸çŸ¥é“æ•°ç»„çš„å…ƒç´ ä¸ªæ•°ï¼Œæ‰€ä»¥ä¸Šç•Œæ£€æŸ¥åœ¨æ­¤æ—¶å‘ç”Ÿã€‚</p>
<ul>
<li>å…ƒç´ è®¿é—®</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">   <span class="function">E <span class="title">elementData</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> (E) elementData[index];</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>ä¸“é—¨å†™äº†ä¸€ä¸ªå‡½æ•°ç”¨æ¥è®¿é—®å…ƒç´ ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ <code>elementData[index]</code>ï¼Œåªå› ä¸ºéœ€è¦å‘ä¸Šè½¬å‹ä¹ˆï¼Ÿè¿˜æ˜¯ <code>SuppressWarning</code>ã€€ä¼šé‡å¤ã€‚</p>
<ul>
<li>private</li>
</ul>
<p>å¯¹äºä»…ä»…åœ¨ç±»å†…éƒ¨ä½¿ç”¨çš„å‡½æ•°ï¼Œè¦å£°æ˜ä¸º <code>private</code>ã€‚</p>
<ul>
<li>add å‚æ•°æ£€æŸ¥</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</div><div class="line">     rangeCheckForAdd(index);</div><div class="line"></div><div class="line">     ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></div><div class="line">     System.arraycopy(elementData, index, elementData, index + <span class="number">1</span>,</div><div class="line">                      size - index);</div><div class="line">     elementData[index] = element;</div><div class="line">     size++;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rangeCheckForAdd</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (index &gt; size || index &lt; <span class="number">0</span>)</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(outOfBoundsMsg(index));</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºè¿™é‡Œå¯¹ã€€<code>index</code> çš„ä¸Šç•Œå’Œä¸‹ç•Œéƒ½æ£€æŸ¥äº†ï¼Œè™½ç„¶ã€€<code>add</code> çš„<code>7</code> è¡Œä¼šè¿›è¡Œæ£€æŸ¥ï¼Œä½†åœ¨ <code>add</code>ã€€çš„ <code>4</code>, <code>5</code> è¡Œä¸­å°±å·²ç»å¯èƒ½å‡ºé”™ã€‚</p>
<ul>
<li>å¼ºåˆ¶åƒåœ¾å›æ”¶</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">    rangeCheck(index);</div><div class="line"></div><div class="line">    modCount++;</div><div class="line">    E oldValue = elementData(index);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> numMoved = size - index - <span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</div><div class="line">        System.arraycopy(elementData, index+<span class="number">1</span>, elementData, index,</div><div class="line">                         numMoved);</div><div class="line">    elementData[--size] = <span class="keyword">null</span>; <span class="comment">// Let gc do its work</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> oldValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ç¬¬ <code>11</code>è¡ŒæŠŠæœ€åä¸€ä¸ªå…ƒç´ è®¾ç½®ä¸º<code>null</code>ï¼Œè¿™å¯ä»¥ä½¿å¾—<code>gc</code>å·¥ä½œã€‚å¥½å¥‡å¦‚ä½•ç”¨å®éªŒéªŒè¯è¿™ä¸€ç‚¹ã€‚</p>
<ul>
<li>remove(Object o)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (o == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; size; index++)</div><div class="line">            <span class="keyword">if</span> (elementData[index] == <span class="keyword">null</span>) &#123;</div><div class="line">                fastRemove(index);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; size; index++)</div><div class="line">            <span class="keyword">if</span> (o.equals(elementData[index])) &#123;</div><div class="line">                fastRemove(index);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ•´ä¸ªæ¡†æ¶ä¸ <code>indexOf</code> å‡½æ•°æ˜¯ç›¸ä¼¼çš„ï¼Œæ³¨æ„é‚£ä¸ª <code>fastRemove</code> å‡½æ•°ï¼Œå®ƒä¸ <code>remove(index)</code> çš„ä¸åŒåœ¨äºå®ƒï¼š</p>
<ol>
<li>æ˜¯ <code>private</code></li>
<li>æ— å‚æ•°æ£€æŸ¥ï¼Œå› ä¸ºä¼ ç»™å®ƒçš„å‚æ•°ä¸€å®šæ˜¯åˆæ³•çš„</li>
<li>ä¸è¿”å›å€¼</li>
</ol>
<p>ç”±æ­¤ç»†èŠ‚å¯è§ï¼Œæ ‡å‡†åº“ä¸­å‡½æ•°çš„ç²¾ç›Šæ±‚ç²¾ã€‚(ä¸çŸ¥é“æ˜¯ä¸æ˜¯æˆ‘è¿‡åº¦æ£æµ‹äº†ï¼Œæœ‰ç»è¿‡æ€§èƒ½æµ‹è¯•ä¹ˆï¼Ÿ)</p>
<ul>
<li>batchRemove</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">batchRemove</span><span class="params">(Collection&lt;?&gt; c, <span class="keyword">boolean</span> complement)</span> </span>&#123;</div><div class="line">     <span class="keyword">final</span> Object[] elementData = <span class="keyword">this</span>.elementData;</div><div class="line">     <span class="keyword">int</span> r = <span class="number">0</span>, w = <span class="number">0</span>;</div><div class="line">     <span class="keyword">boolean</span> modified = <span class="keyword">false</span>;</div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">         <span class="keyword">for</span> (; r &lt; size; r++)</div><div class="line">             <span class="keyword">if</span> (c.contains(elementData[r]) == complement)</div><div class="line">                 elementData[w++] = elementData[r];</div><div class="line">     &#125; <span class="keyword">finally</span> &#123;</div><div class="line">         <span class="comment">// Preserve behavioral compatibility with AbstractCollection,</span></div><div class="line">         <span class="comment">// even if c.contains() throws.</span></div><div class="line">         <span class="keyword">if</span> (r != size) &#123;</div><div class="line">             System.arraycopy(elementData, r,</div><div class="line">                              elementData, w,</div><div class="line">                              size - r);</div><div class="line">             w += size - r;</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">if</span> (w != size) &#123;</div><div class="line">             <span class="keyword">for</span> (<span class="keyword">int</span> i = w; i &lt; size; i++)</div><div class="line">                 elementData[i] = <span class="keyword">null</span>;</div><div class="line">             modCount += size - w;</div><div class="line">             size = w;</div><div class="line">             modified = <span class="keyword">true</span>;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">return</span> modified;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ <code>finally</code> é‡Œçš„ä»£ç ï¼Œè¿™æ®µä»£ç ä¿è¯ï¼Œå³ä½¿ <code>try</code> ä¸­çš„ä»£ç å‡ºäº†é—®é¢˜ï¼Œä¹Ÿä¼šæœ€å¤§ç¨‹åº¦ä¸Šä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚å¦‚æœ <code>r</code> æ²¡æœ‰éå†å®Œï¼Œé‚£ä¹ˆåé¢æ²¡æœ‰æ£€æŸ¥è¿‡çš„æ•°æ®éƒ½è¦ä¿ç•™ä¸‹æ¥ã€‚</p>
<ul>
<li>çº¿ç¨‹å®‰å…¨</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span></div><div class="line">    <span class="keyword">throws</span> java.io.IOException&#123;</div><div class="line">    <span class="comment">// Write out element count, and any hidden stuff</span></div><div class="line">    <span class="keyword">int</span> expectedModCount = modCount;</div><div class="line">    s.defaultWriteObject();</div><div class="line"></div><div class="line">    <span class="comment">// Write out array length</span></div><div class="line">    s.writeInt(elementData.length);</div><div class="line"></div><div class="line">    <span class="comment">// Write out all elements in the proper order.</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;size; i++)</div><div class="line">        s.writeObject(elementData[i]);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (modCount != expectedModCount) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„é‚£ä¸ªã€€<code>modCount</code> çš„æ£€æŸ¥ï¼Œè¿™æ˜¯ä¸ºäº†ç¡®å®šåœ¨ <code>5-12</code>ã€€è¡Œä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ<code>List</code> æ²¡æœ‰æ”¹å˜ã€‚æ”¹å˜çš„åŸå› å¯èƒ½æ˜¯ç”±äºå¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œåœ¨è¿™æœŸé—´å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œæ”¹å˜äº† <code>List</code> çš„çŠ¶æ€ã€‚</p>
<ul>
<li>å®¹é‡æ‰©å……</li>
</ul>
<p>å®¹é‡æ‰©å……ä¼šåœ¨ä»»ä½•å¯èƒ½å¼•èµ·ã€€<code>ArrayList</code> å¤§å°æ”¹å˜çš„æƒ…å†µä¸‹å‘ç”Ÿï¼Œå¦‚ä½•æ‰©å……å‘¢ï¼Œä»£ç åœ¨ <code>grow</code> å‡½æ•°ä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</div><div class="line">     <span class="comment">// overflow-conscious code</span></div><div class="line">     <span class="keyword">int</span> oldCapacity = elementData.length;</div><div class="line">     <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</div><div class="line">     <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</div><div class="line">         newCapacity = minCapacity;</div><div class="line">     <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</div><div class="line">         newCapacity = hugeCapacity(minCapacity);</div><div class="line">     <span class="comment">// minCapacity is usually close to size, so this is a win:</span></div><div class="line">     elementData = Arrays.copyOf(elementData, newCapacity);</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hugeCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>) <span class="comment">// overflow</span></div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</div><div class="line">     <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ?</div><div class="line">         Integer.MAX_VALUE :</div><div class="line">         MAX_ARRAY_SIZE;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œ<code>oldCapacity</code> æ–°å¢çš„å®¹é‡æ˜¯å®ƒçš„ä¸€åŠã€‚å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª <code>hugeCapacity</code>ï¼Œå¦‚æœéœ€è¦æ‰©å……çš„å®¹é‡æ¯”ã€€<code>MAX_ARRAY_SIZE</code> è¿˜å¤§ï¼Œä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œé‡æ–°è°ƒæ•´å¤§å°ã€‚ä½†å†å¤§ä¹Ÿå¤§ä¸è¿‡ã€€<code>Integer.MAX_VALUE</code>ã€‚</p>
<ul>
<li>å…ƒç´ ä½ç½®è°ƒæ•´</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</div><div class="line">    rangeCheckForAdd(index);</div><div class="line"></div><div class="line">    ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></div><div class="line">    System.arraycopy(elementData, index, elementData, index + <span class="number">1</span>,</div><div class="line">                     size - index);</div><div class="line">    elementData[index] = element;</div><div class="line">    size++;</div><div class="line">&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">    rangeCheck(index);</div><div class="line"></div><div class="line">    modCount++;</div><div class="line">    E oldValue = elementData(index);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> numMoved = size - index - <span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</div><div class="line">        System.arraycopy(elementData, index+<span class="number">1</span>, elementData, index,</div><div class="line">                         numMoved);</div><div class="line">    elementData[--size] = <span class="keyword">null</span>; <span class="comment">// Let gc do its work</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> oldValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ— è®ºæ˜¯å¢åŠ å…ƒç´ è¿˜æ˜¯åˆ é™¤å…ƒç´ ï¼Œéƒ½å¯èƒ½ä½¿å¾—å¾ˆå¤šå…ƒç´ çš„ä½ç½®å‘ç”Ÿæ”¹å˜ï¼Œè¿™é‡Œå°±æ˜¯ç”¨ <code>System.arraycopy</code> æ¥æŠŠå¤§é‡å…ƒç´ æ”¾åœ¨å…¶å®ƒä½ç½®ï¼Œå¦‚æœå…ƒç´ å¾ˆå¤šï¼Œç»å¸¸éœ€è¦è°ƒæ•´ï¼Œæ˜¯å¾ˆæµªè´¹æ—¶é—´çš„ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[java-coding-style]]></title>
      <url>http://zsr.github.io/2016/07/29/java-coding-style/</url>
      <content type="html"><![CDATA[<h1 id="Javaç¼–ç é£æ ¼"><a href="#Javaç¼–ç é£æ ¼" class="headerlink" title="Javaç¼–ç é£æ ¼"></a>Javaç¼–ç é£æ ¼</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™ä»½æ–‡æ¡£æºè‡ªGoogle Javaç¼–ç¨‹é£æ ¼è§„èŒƒï¼Œå¹¶æ ¹æ®æˆ‘çš„æƒ³æ³•ï¼Œåšäº†ä¸€äº›è°ƒæ•´ï¼Œå½“ä¸”ä»…å½“ä¸€ä¸ªJavaæºæ–‡ä»¶ç¬¦åˆæ­¤æ–‡æ¡£ä¸­çš„è§„åˆ™ï¼Œ æˆ‘ä»¬æ‰è®¤ä¸ºå®ƒç¬¦åˆXimalayaç›´æ’­teamçš„Javaç¼–ç¨‹é£æ ¼ã€‚</p>
<p>ä¸å…¶å®ƒçš„ç¼–ç¨‹é£æ ¼æŒ‡å—ä¸€æ ·ï¼Œè¿™é‡Œæ‰€è®¨è®ºçš„ä¸ä»…ä»…æ˜¯ç¼–ç æ ¼å¼ç¾ä¸ç¾è§‚çš„é—®é¢˜ï¼Œ åŒæ—¶ä¹Ÿè®¨è®ºä¸€äº›çº¦å®šåŠç¼–ç æ ‡å‡†ã€‚ç„¶è€Œï¼Œè¿™ä»½æ–‡æ¡£ä¸»è¦ä¾§é‡äºæˆ‘ä»¬æ‰€æ™®ééµå¾ªçš„è§„åˆ™ï¼Œå¯¹äºé‚£äº›ä¸æ˜¯å¼ºåˆ¶è¦æ±‚çš„ï¼Œæˆ‘ä»¬å°½é‡ä¸æä¾›æ„è§ã€‚</p>
<h3 id="1-1-æœ¯è¯­è¯´æ˜"><a href="#1-1-æœ¯è¯­è¯´æ˜" class="headerlink" title="1.1 æœ¯è¯­è¯´æ˜"></a>1.1 æœ¯è¯­è¯´æ˜</h3><p>åœ¨æœ¬æ–‡æ¡£ä¸­ï¼Œé™¤éå¦æœ‰è¯´æ˜ï¼š</p>
<p>æœ¯è¯­<code>class</code>å¯è¡¨ç¤ºä¸€ä¸ªæ™®é€šç±»ï¼Œæšä¸¾ç±»ï¼Œæ¥å£æˆ–æ˜¯annotationç±»å‹(@interface)<br>æœ¯è¯­<code>comment</code>åªç”¨æ¥æŒ‡ä»£å®ç°çš„æ³¨é‡Š(implementation comments)ï¼Œæˆ‘ä»¬ä¸ä½¿ç”¨â€œdocumentation commentsâ€ä¸€è¯ï¼Œè€Œæ˜¯ç”¨Javadocã€‚<br>å…¶ä»–çš„æœ¯è¯­è¯´æ˜ä¼šå¶å°”åœ¨åé¢çš„æ–‡æ¡£å‡ºç°ã€‚</p>
<h3 id="1-2-æŒ‡å—è¯´æ˜"><a href="#1-2-æŒ‡å—è¯´æ˜" class="headerlink" title="1.2 æŒ‡å—è¯´æ˜"></a>1.2 æŒ‡å—è¯´æ˜</h3><p>æœ¬æ–‡æ¡£ä¸­çš„ç¤ºä¾‹ä»£ç å¹¶ä¸ä½œä¸ºè§„èŒƒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶ç¤ºä¾‹ä»£ç æ˜¯éµå¾ªXimalayaç¼–ç¨‹é£æ ¼ï¼Œä½†å¹¶ä¸æ„å‘³ç€è¿™æ˜¯å±•ç°è¿™äº›ä»£ç çš„å”¯ä¸€æ–¹å¼ã€‚ ç¤ºä¾‹ä¸­çš„æ ¼å¼é€‰æ‹©ä¸åº”è¯¥è¢«å¼ºåˆ¶å®šä¸ºè§„åˆ™ã€‚</p>
<a id="more"></a>
<h2 id="æºæ–‡ä»¶åŸºç¡€"><a href="#æºæ–‡ä»¶åŸºç¡€" class="headerlink" title="æºæ–‡ä»¶åŸºç¡€"></a>æºæ–‡ä»¶åŸºç¡€</h2><h3 id="2-1-æ–‡ä»¶å"><a href="#2-1-æ–‡ä»¶å" class="headerlink" title="2.1 æ–‡ä»¶å"></a>2.1 æ–‡ä»¶å</h3><p>æºæ–‡ä»¶ä»¥å…¶æœ€é¡¶å±‚çš„ç±»åæ¥å‘½åï¼Œå¤§å°å†™æ•æ„Ÿï¼Œæ–‡ä»¶æ‰©å±•åä¸º<code>.java</code>ã€‚</p>
<h3 id="2-2-ç¼–ç "><a href="#2-2-ç¼–ç " class="headerlink" title="2.2 ç¼–ç "></a>2.2 ç¼–ç </h3><p>æºæ–‡ä»¶ç¼–ç æ ¼å¼ä¸º<code>UTF-8</code>ã€‚</p>
<h3 id="2-3-ç‰¹æ®Šå­—ç¬¦"><a href="#2-3-ç‰¹æ®Šå­—ç¬¦" class="headerlink" title="2.3 ç‰¹æ®Šå­—ç¬¦"></a>2.3 ç‰¹æ®Šå­—ç¬¦</h3><p>ä¸è¦ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦ã€‚</p>
<h2 id="æºæ–‡ä»¶ç»“æ„"><a href="#æºæ–‡ä»¶ç»“æ„" class="headerlink" title="æºæ–‡ä»¶ç»“æ„"></a>æºæ–‡ä»¶ç»“æ„</h2><p>ä¸€ä¸ªæºæ–‡ä»¶åŒ…å«(æŒ‰é¡ºåºåœ°)ï¼š</p>
<ul>
<li>è®¸å¯è¯æˆ–ç‰ˆæƒä¿¡æ¯</li>
<li>packageè¯­å¥</li>
<li>importè¯­å¥</li>
<li>ä¸€ä¸ªé¡¶çº§ç±»(åªæœ‰ä¸€ä¸ª)</li>
</ul>
<blockquote>
<p>ä»¥ä¸Šæ¯ä¸ªéƒ¨åˆ†ä¹‹é—´ç”¨ä¸€ä¸ªç©ºè¡Œéš”å¼€ã€‚</p>
</blockquote>
<h3 id="3-1-è®¸å¯è¯æˆ–ç‰ˆæƒä¿¡æ¯"><a href="#3-1-è®¸å¯è¯æˆ–ç‰ˆæƒä¿¡æ¯" class="headerlink" title="3.1 è®¸å¯è¯æˆ–ç‰ˆæƒä¿¡æ¯"></a>3.1 è®¸å¯è¯æˆ–ç‰ˆæƒä¿¡æ¯</h3><p>å¦‚æœä¸€ä¸ªæ–‡ä»¶åŒ…å«è®¸å¯è¯æˆ–ç‰ˆæƒä¿¡æ¯ï¼Œé‚£ä¹ˆå®ƒåº”å½“è¢«æ”¾åœ¨æ–‡ä»¶æœ€å‰é¢ã€‚<br>å…¬å¸ç‰ˆæƒä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * æ–‡ä»¶åç§°: $&#123;filename&#125; Copyright 2011-2014 Ximalaya All right reserved.</div><div class="line"> */</div></pre></td></tr></table></figure>
<h3 id="3-2-packageè¯­å¥"><a href="#3-2-packageè¯­å¥" class="headerlink" title="3.2 packageè¯­å¥"></a>3.2 packageè¯­å¥</h3><p>packageè¯­å¥ä¸æ¢è¡Œï¼Œå³packageè¯­å¥å†™åœ¨ä¸€è¡Œé‡Œã€‚</p>
<h3 id="3-3-importè¯­å¥"><a href="#3-3-importè¯­å¥" class="headerlink" title="3.3 importè¯­å¥"></a>3.3 importè¯­å¥</h3><h4 id="3-3-1-importä¸è¦ä½¿ç”¨é€šé…ç¬¦"><a href="#3-3-1-importä¸è¦ä½¿ç”¨é€šé…ç¬¦" class="headerlink" title="3.3.1 importä¸è¦ä½¿ç”¨é€šé…ç¬¦"></a>3.3.1 importä¸è¦ä½¿ç”¨é€šé…ç¬¦</h4><p>å³ï¼Œä¸è¦å‡ºç°ç±»ä¼¼è¿™æ ·çš„importè¯­å¥ï¼š<code>import java.util.*;</code></p>
<h4 id="3-3-2-ä¸è¦importé™æ€å˜é‡å’Œæ–¹æ³•"><a href="#3-3-2-ä¸è¦importé™æ€å˜é‡å’Œæ–¹æ³•" class="headerlink" title="3.3.2 ä¸è¦importé™æ€å˜é‡å’Œæ–¹æ³•"></a>3.3.2 ä¸è¦importé™æ€å˜é‡å’Œæ–¹æ³•</h4><p>å³ï¼Œä¸è¦å‡ºç°ç±»ä¼¼è¿™æ ·çš„importè¯­å¥ï¼š<code>import static org.junit.Assert.fail;</code></p>
<h4 id="3-3-3-ä¸è¦æ¢è¡Œ"><a href="#3-3-3-ä¸è¦æ¢è¡Œ" class="headerlink" title="3.3.3 ä¸è¦æ¢è¡Œ"></a>3.3.3 ä¸è¦æ¢è¡Œ</h4><p>importè¯­å¥ä¸æ¢è¡Œï¼Œå³æ¯ä¸ªimportè¯­å¥ç‹¬ç«‹æˆè¡Œã€‚</p>
<h4 id="3-3-4-é¡ºåºå’Œé—´è·"><a href="#3-3-4-é¡ºåºå’Œé—´è·" class="headerlink" title="3.3.4 é¡ºåºå’Œé—´è·"></a>3.3.4 é¡ºåºå’Œé—´è·</h4><p>importè¯­å¥å¯åˆ†ä¸ºä»¥ä¸‹å‡ ç»„ï¼ŒæŒ‰ç…§è¿™ä¸ªé¡ºåºï¼Œæ¯ç»„ç”±ä¸€ä¸ªç©ºè¡Œåˆ†éš”ï¼š</p>
<p>æ¯ä¸ªé¡¶çº§åŒ…ä¸ºä¸€ç»„ï¼Œå­—å…¸åºï¼Œç»„å†…ä¸ç©ºè¡Œï¼ŒæŒ‰å­—å…¸åºæ’åˆ—ã€‚</p>
<h3 id="3-4-ç±»å£°æ˜"><a href="#3-4-ç±»å£°æ˜" class="headerlink" title="3.4 ç±»å£°æ˜"></a>3.4 ç±»å£°æ˜</h3><h4 id="3-4-1-åªæœ‰ä¸€ä¸ªé¡¶çº§ç±»å£°æ˜"><a href="#3-4-1-åªæœ‰ä¸€ä¸ªé¡¶çº§ç±»å£°æ˜" class="headerlink" title="3.4.1 åªæœ‰ä¸€ä¸ªé¡¶çº§ç±»å£°æ˜"></a>3.4.1 åªæœ‰ä¸€ä¸ªé¡¶çº§ç±»å£°æ˜</h4><p>æ¯ä¸ªé¡¶çº§ç±»éƒ½åœ¨ä¸€ä¸ªä¸å®ƒåŒåçš„æºæ–‡ä»¶ä¸­(å½“ç„¶ï¼Œè¿˜åŒ…å«.javaåç¼€)ã€‚</p>
<p>ä¾‹å¤–ï¼špackage-info.javaï¼Œè¯¥æ–‡ä»¶ä¸­å¯æ²¡æœ‰package-infoç±»ã€‚</p>
<h4 id="3-4-2-ç±»æˆå‘˜é¡ºåº"><a href="#3-4-2-ç±»æˆå‘˜é¡ºåº" class="headerlink" title="3.4.2 ç±»æˆå‘˜é¡ºåº"></a>3.4.2 ç±»æˆå‘˜é¡ºåº</h4><p>ç±»çš„æˆå‘˜é¡ºåºå¯¹æ˜“å­¦æ€§æœ‰å¾ˆå¤§çš„å½±å“ï¼Œä½†è¿™ä¹Ÿä¸å­˜åœ¨å”¯ä¸€çš„é€šç”¨æ³•åˆ™ã€‚ä¸åŒçš„ç±»å¯¹æˆå‘˜çš„æ’åºå¯èƒ½æ˜¯ä¸åŒçš„ã€‚ æœ€é‡è¦çš„ä¸€ç‚¹ï¼Œæ¯ä¸ªç±»åº”è¯¥ä»¥æŸç§é€»è¾‘å»æ’åºå®ƒçš„æˆå‘˜ï¼Œç»´æŠ¤è€…åº”è¯¥è¦èƒ½è§£é‡Šè¿™ç§æ’åºé€»è¾‘ã€‚æ¯”å¦‚ï¼Œ æ–°çš„æ–¹æ³•ä¸èƒ½æ€»æ˜¯ä¹ æƒ¯æ€§åœ°æ·»åŠ åˆ°ç±»çš„ç»“å°¾ï¼Œå› ä¸ºè¿™æ ·å°±æ˜¯æŒ‰æ—¶é—´é¡ºåºè€ŒéæŸç§é€»è¾‘æ¥æ’åºçš„ã€‚</p>
<p>æ€»çš„æ¥è¯´ï¼ŒæŒ‰ç…§<code>static</code>ã€<code>private</code>ã€<code>protected</code>ç­‰ä¿®é¥°ç¬¦å½’ç±»ã€‚</p>
<h5 id="3-4-2-1-é‡è½½ï¼šæ°¸ä¸åˆ†ç¦»"><a href="#3-4-2-1-é‡è½½ï¼šæ°¸ä¸åˆ†ç¦»" class="headerlink" title="3.4.2.1 é‡è½½ï¼šæ°¸ä¸åˆ†ç¦»"></a>3.4.2.1 é‡è½½ï¼šæ°¸ä¸åˆ†ç¦»</h5><p>å½“ä¸€ä¸ªç±»æœ‰å¤šä¸ªæ„é€ å‡½æ•°ï¼Œæˆ–æ˜¯å¤šä¸ªåŒåæ–¹æ³•ï¼Œè¿™äº›å‡½æ•°/æ–¹æ³•åº”è¯¥æŒ‰é¡ºåºå‡ºç°åœ¨ä¸€èµ·ï¼Œä¸­é—´ä¸è¦æ”¾è¿›å…¶å®ƒå‡½æ•°/æ–¹æ³•ã€‚</p>
<h2 id="æ ¼å¼"><a href="#æ ¼å¼" class="headerlink" title="æ ¼å¼"></a>æ ¼å¼</h2><p>æœ¯è¯­è¯´æ˜ï¼šå—çŠ¶ç»“æ„(block-like construct)æŒ‡çš„æ˜¯ä¸€ä¸ªç±»ï¼Œæ–¹æ³•æˆ–æ„é€ å‡½æ•°çš„ä¸»ä½“ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ•°ç»„åˆå§‹åŒ–ä¸­çš„åˆå§‹å€¼å¯è¢«é€‰æ‹©æ€§åœ°è§†ä¸ºå—çŠ¶ç»“æ„(4.8.3.1èŠ‚)ã€‚</p>
<h3 id="4-1-å¤§æ‹¬å·"><a href="#4-1-å¤§æ‹¬å·" class="headerlink" title="4.1 å¤§æ‹¬å·"></a>4.1 å¤§æ‹¬å·</h3><h4 id="4-1-1-ä½¿ç”¨å¤§æ‹¬å·-å³ä½¿æ˜¯å¯é€‰çš„"><a href="#4-1-1-ä½¿ç”¨å¤§æ‹¬å·-å³ä½¿æ˜¯å¯é€‰çš„" class="headerlink" title="4.1.1 ä½¿ç”¨å¤§æ‹¬å·(å³ä½¿æ˜¯å¯é€‰çš„)"></a>4.1.1 ä½¿ç”¨å¤§æ‹¬å·(å³ä½¿æ˜¯å¯é€‰çš„)</h4><p>å¤§æ‹¬å·ä¸if, else, for, do, whileè¯­å¥ä¸€èµ·ä½¿ç”¨ï¼Œå³ä½¿åªæœ‰ä¸€æ¡è¯­å¥(æˆ–æ˜¯ç©º)ï¼Œä¹Ÿåº”è¯¥æŠŠå¤§æ‹¬å·å†™ä¸Šã€‚</p>
<h4 id="4-1-2-éç©ºå—ï¼šK-amp-R-é£æ ¼"><a href="#4-1-2-éç©ºå—ï¼šK-amp-R-é£æ ¼" class="headerlink" title="4.1.2 éç©ºå—ï¼šK &amp; R é£æ ¼"></a>4.1.2 éç©ºå—ï¼šK &amp; R é£æ ¼</h4><p>å¯¹äºéç©ºå—å’Œå—çŠ¶ç»“æ„ï¼Œå¤§æ‹¬å·éµå¾ªKernighanå’ŒRitchieé£æ ¼ (Egyptian brackets):</p>
<p>å·¦å¤§æ‹¬å·å‰ä¸æ¢è¡Œ<br>å·¦å¤§æ‹¬å·åæ¢è¡Œ<br>å³å¤§æ‹¬å·å‰æ¢è¡Œ<br>å¦‚æœå³å¤§æ‹¬å·æ˜¯ä¸€ä¸ªè¯­å¥ã€å‡½æ•°ä½“æˆ–ç±»çš„ç»ˆæ­¢ï¼Œåˆ™å³å¤§æ‹¬å·åæ¢è¡Œ; å¦åˆ™ä¸æ¢è¡Œã€‚ä¾‹å¦‚ï¼Œå¦‚æœå³å¤§æ‹¬å·åé¢æ˜¯elseæˆ–é€—å·ï¼Œåˆ™ä¸æ¢è¡Œã€‚<br>ç¤ºä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">return new MyClass() &#123;</div><div class="line">  @Override public void method() &#123;</div><div class="line">    if (condition()) &#123;</div><div class="line">      try &#123;</div><div class="line">        something();</div><div class="line">      &#125; catch (ProblemException e) &#123;</div><div class="line">        recover();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<blockquote>
<p>4.8.1èŠ‚ç»™å‡ºäº†enumç±»çš„ä¸€äº›ä¾‹å¤–ã€‚</p>
</blockquote>
<h4 id="4-1-3-ç©ºå—ï¼šå¯ä»¥ç”¨ç®€æ´ç‰ˆæœ¬"><a href="#4-1-3-ç©ºå—ï¼šå¯ä»¥ç”¨ç®€æ´ç‰ˆæœ¬" class="headerlink" title="4.1.3 ç©ºå—ï¼šå¯ä»¥ç”¨ç®€æ´ç‰ˆæœ¬"></a>4.1.3 ç©ºå—ï¼šå¯ä»¥ç”¨ç®€æ´ç‰ˆæœ¬</h4><p>ä¸€ä¸ªç©ºçš„å—çŠ¶ç»“æ„é‡Œä»€ä¹ˆä¹Ÿä¸åŒ…å«ï¼Œå¤§æ‹¬å·å¯ä»¥ç®€æ´åœ°å†™æˆ{}ï¼Œä¸éœ€è¦æ¢è¡Œã€‚ä¾‹å¤–ï¼šå¦‚æœå®ƒæ˜¯ä¸€ä¸ªå¤šå—è¯­å¥çš„ä¸€éƒ¨åˆ†(if/else æˆ– try/catch/finally) ï¼Œå³ä½¿å¤§æ‹¬å·å†…æ²¡å†…å®¹ï¼Œå³å¤§æ‹¬å·ä¹Ÿè¦æ¢è¡Œã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void doNothing() &#123;&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>ä¸è¿‡ç†è®ºä¸Šä¸åº”è¯¥å‡ºç°è¿™æ ·ä»€ä¹ˆéƒ½ä¸åšçš„æ–¹æ³•æˆ–if/elseç­‰ã€‚</p>
</blockquote>
<h3 id="4-2-å—ç¼©è¿›ï¼š2ä¸ªç©ºæ ¼"><a href="#4-2-å—ç¼©è¿›ï¼š2ä¸ªç©ºæ ¼" class="headerlink" title="4.2 å—ç¼©è¿›ï¼š2ä¸ªç©ºæ ¼"></a>4.2 å—ç¼©è¿›ï¼š2ä¸ªç©ºæ ¼</h3><p>æ¯å½“å¼€å§‹ä¸€ä¸ªæ–°çš„å—ï¼Œç¼©è¿›å¢åŠ 2ä¸ªç©ºæ ¼ï¼Œå½“å—ç»“æŸæ—¶ï¼Œç¼©è¿›è¿”å›å…ˆå‰çš„ç¼©è¿›çº§åˆ«ã€‚ç¼©è¿›çº§åˆ«é€‚ç”¨äºä»£ç å’Œæ³¨é‡Šã€‚(è§4.1.2èŠ‚ä¸­çš„ä»£ç ç¤ºä¾‹)</p>
<h3 id="4-3-ä¸€è¡Œä¸€ä¸ªè¯­å¥"><a href="#4-3-ä¸€è¡Œä¸€ä¸ªè¯­å¥" class="headerlink" title="4.3 ä¸€è¡Œä¸€ä¸ªè¯­å¥"></a>4.3 ä¸€è¡Œä¸€ä¸ªè¯­å¥</h3><p>æ¯ä¸ªè¯­å¥åè¦æ¢è¡Œã€‚</p>
<h3 id="4-4-åˆ—é™åˆ¶ï¼š100"><a href="#4-4-åˆ—é™åˆ¶ï¼š100" class="headerlink" title="4.4 åˆ—é™åˆ¶ï¼š100"></a>4.4 åˆ—é™åˆ¶ï¼š100</h3><p>ä¸€ä¸ªé¡¹ç›®å¯ä»¥é€‰æ‹©ä¸€è¡Œ100ä¸ªå­—ç¬¦çš„åˆ—é™åˆ¶ï¼Œé™¤äº†ä¸‹è¿°ä¾‹å¤–ï¼Œä»»ä½•ä¸€è¡Œå¦‚æœè¶…è¿‡è¿™ä¸ªå­—ç¬¦æ•°é™åˆ¶ï¼Œå¿…é¡»è‡ªåŠ¨æ¢è¡Œã€‚</p>
<p>ä¾‹å¤–ï¼š</p>
<p>ä¸å¯èƒ½æ»¡è¶³åˆ—é™åˆ¶çš„è¡Œ(ä¾‹å¦‚ï¼ŒJavadocä¸­çš„ä¸€ä¸ªé•¿URLï¼Œæˆ–æ˜¯ä¸€ä¸ªé•¿çš„JSNIæ–¹æ³•å‚è€ƒ)ã€‚<br>packageå’Œimportè¯­å¥(è§3.2èŠ‚å’Œ3.3èŠ‚)ã€‚<br>æ³¨é‡Šä¸­é‚£äº›å¯èƒ½è¢«å‰ªåˆ‡å¹¶ç²˜è´´åˆ°shellä¸­çš„å‘½ä»¤è¡Œã€‚</p>
<h3 id="4-5-è‡ªåŠ¨æ¢è¡Œ"><a href="#4-5-è‡ªåŠ¨æ¢è¡Œ" class="headerlink" title="4.5 è‡ªåŠ¨æ¢è¡Œ"></a>4.5 è‡ªåŠ¨æ¢è¡Œ</h3><p>æœ¯è¯­è¯´æ˜ï¼šä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€è¡Œé•¿ä»£ç ä¸ºäº†é¿å…è¶…å‡ºåˆ—é™åˆ¶(80æˆ–100ä¸ªå­—ç¬¦)è€Œè¢«åˆ†ä¸ºå¤šè¡Œï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºè‡ªåŠ¨æ¢è¡Œ(line-wrapping)ã€‚</p>
<p>æˆ‘ä»¬å¹¶æ²¡æœ‰å…¨é¢ï¼Œç¡®å®šæ€§çš„å‡†åˆ™æ¥å†³å®šåœ¨æ¯ä¸€ç§æƒ…å†µä¸‹å¦‚ä½•è‡ªåŠ¨æ¢è¡Œï¼Œæˆ‘ä»¬é€šå¸¸é€šè¿‡ä½¿ç”¨ç»Ÿä¸€çš„eclipse formatteræ¥ä¿è¯å¤§å®¶çš„æ¢è¡Œæ ¼å¼ç»Ÿä¸€ï¼Œæ ¼å¼ä¼˜ç¾æ˜¯é¦–å…ˆè¦è€ƒè™‘çš„ã€‚</p>
<blockquote>
<p>Tip: æå–æ–¹æ³•æˆ–å±€éƒ¨å˜é‡å¯ä»¥åœ¨ä¸æ¢è¡Œçš„æƒ…å†µä¸‹è§£å†³ä»£ç è¿‡é•¿çš„é—®é¢˜ï¼Œæˆ–è€…åˆç†ç¼©çŸ­å‘½åé•¿åº¦ã€‚</p>
</blockquote>
<h3 id="4-6-ç©ºç™½"><a href="#4-6-ç©ºç™½" class="headerlink" title="4.6 ç©ºç™½"></a>4.6 ç©ºç™½</h3><h4 id="4-6-1-å‚ç›´ç©ºç™½"><a href="#4-6-1-å‚ç›´ç©ºç™½" class="headerlink" title="4.6.1 å‚ç›´ç©ºç™½"></a>4.6.1 å‚ç›´ç©ºç™½</h4><p>ä»¥ä¸‹æƒ…å†µéœ€è¦ä½¿ç”¨ä¸€ä¸ªç©ºè¡Œï¼š</p>
<p>ç±»å†…è¿ç»­çš„æˆå‘˜ä¹‹é—´ï¼š</p>
<ul>
<li>å­—æ®µ</li>
<li>æ„é€ å‡½æ•°</li>
<li>æ–¹æ³•</li>
<li>åµŒå¥—ç±»</li>
<li>é™æ€åˆå§‹åŒ–å—</li>
<li>å®ä¾‹åˆå§‹åŒ–å—</li>
</ul>
<p>ä¾‹å¤–ï¼š</p>
<ul>
<li><code>ä¸¤ä¸ªè¿ç»­å­—æ®µä¹‹é—´çš„ç©ºè¡Œæ˜¯å¯é€‰çš„</code>ï¼Œç”¨äºå­—æ®µçš„ç©ºè¡Œä¸»è¦ç”¨æ¥å¯¹å­—æ®µè¿›è¡Œé€»è¾‘åˆ†ç»„ã€‚</li>
<li>åœ¨å‡½æ•°ä½“å†…ï¼Œè¯­å¥æ ¹æ®ä¸šåŠ¡é€»è¾‘åˆ†ç»„ã€‚</li>
<li>ç±»å†…çš„ç¬¬ä¸€ä¸ªæˆå‘˜å‰æˆ–æœ€åä¸€ä¸ªæˆå‘˜åçš„ç©ºè¡Œæ˜¯å¯é€‰çš„(æ—¢ä¸é¼“åŠ±ä¹Ÿä¸åå¯¹è¿™æ ·åšï¼Œè§†ä¸ªäººå–œå¥½è€Œå®š)ã€‚</li>
<li>è¦æ»¡è¶³æœ¬æ–‡æ¡£ä¸­å…¶ä»–èŠ‚çš„ç©ºè¡Œè¦æ±‚(æ¯”å¦‚3.3èŠ‚ï¼šimportè¯­å¥)</li>
<li>å¤šä¸ªè¿ç»­çš„ç©ºè¡Œæ˜¯å…è®¸çš„ï¼Œä½†æ²¡æœ‰å¿…è¦è¿™æ ·åš(æˆ‘ä»¬ä¹Ÿä¸é¼“åŠ±è¿™æ ·åš)ã€‚</li>
</ul>
<h4 id="4-6-2-æ°´å¹³ç©ºç™½"><a href="#4-6-2-æ°´å¹³ç©ºç™½" class="headerlink" title="4.6.2 æ°´å¹³ç©ºç™½"></a>4.6.2 æ°´å¹³ç©ºç™½</h4><p>é™¤äº†è¯­è¨€éœ€æ±‚å’Œå…¶å®ƒè§„åˆ™ï¼Œå¹¶ä¸”é™¤äº†æ–‡å­—ï¼Œæ³¨é‡Šå’ŒJavadocç”¨åˆ°å•ä¸ªç©ºæ ¼ï¼Œå•ä¸ªASCIIç©ºæ ¼ä¹Ÿå‡ºç°åœ¨ä»¥ä¸‹å‡ ä¸ªåœ°æ–¹ï¼š</p>
<ul>
<li>åˆ†éš”ä»»ä½•ä¿ç•™å­—ä¸ç´§éšå…¶åçš„å·¦æ‹¬å·(()(å¦‚if, for catchç­‰)ã€‚</li>
<li>åˆ†éš”ä»»ä½•ä¿ç•™å­—ä¸å…¶å‰é¢çš„å³å¤§æ‹¬å·(})(å¦‚else, catch)ã€‚</li>
<li>åœ¨ä»»ä½•å·¦å¤§æ‹¬å·å‰({)ï¼Œä¸¤ä¸ªä¾‹å¤–ï¼š<ul>
<li>@SomeAnnotation({a, b})(ä¸ä½¿ç”¨ç©ºæ ¼)ã€‚</li>
<li>String[][] x = foo;(å¤§æ‹¬å·é—´æ²¡æœ‰ç©ºæ ¼ï¼Œè§ä¸‹é¢çš„Note)ã€‚</li>
</ul>
</li>
<li>åœ¨ä»»ä½•äºŒå…ƒæˆ–ä¸‰å…ƒè¿ç®—ç¬¦çš„ä¸¤ä¾§ã€‚è¿™ä¹Ÿé€‚ç”¨äºä»¥ä¸‹â€œç±»è¿ç®—ç¬¦â€ç¬¦å·ï¼š<ul>
<li>ç±»å‹ç•Œé™ä¸­çš„&amp;(<t extends="" foo="" &="" bar="">)ã€‚</t></li>
</ul>
</li>
<li>catchå—ä¸­çš„ç®¡é“ç¬¦å·(catch (FooException | BarException e)ã€‚</li>
<li>foreachè¯­å¥ä¸­çš„åˆ†å·ã€‚</li>
<li>åœ¨, : ;åŠå³æ‹¬å·())å</li>
<li>å¦‚æœåœ¨ä¸€æ¡è¯­å¥ååšæ³¨é‡Šï¼Œåˆ™åŒæ–œæ (//)ä¸¤è¾¹éƒ½è¦ç©ºæ ¼ã€‚è¿™é‡Œå¯ä»¥å…è®¸å¤šä¸ªç©ºæ ¼ï¼Œä½†æ²¡æœ‰å¿…è¦ã€‚</li>
<li>ç±»å‹å’Œå˜é‡ä¹‹é—´ï¼šList listã€‚</li>
<li>æ•°ç»„åˆå§‹åŒ–ä¸­ï¼Œå¤§æ‹¬å·å†…çš„ç©ºæ ¼æ˜¯å¯é€‰çš„ï¼Œå³new int[] {5, 6}å’Œnew int[] { 5, 6 }éƒ½æ˜¯å¯ä»¥çš„ã€‚</li>
</ul>
<blockquote>
<p>Noteï¼šè¿™ä¸ªè§„åˆ™å¹¶ä¸è¦æ±‚æˆ–ç¦æ­¢ä¸€è¡Œçš„å¼€å…³æˆ–ç»“å°¾éœ€è¦é¢å¤–çš„ç©ºæ ¼ï¼Œåªå¯¹å†…éƒ¨ç©ºæ ¼åšè¦æ±‚ã€‚</p>
</blockquote>
<h4 id="4-6-3-æ°´å¹³å¯¹é½ï¼šä¸å»ºè®®"><a href="#4-6-3-æ°´å¹³å¯¹é½ï¼šä¸å»ºè®®" class="headerlink" title="4.6.3 æ°´å¹³å¯¹é½ï¼šä¸å»ºè®®"></a>4.6.3 æ°´å¹³å¯¹é½ï¼šä¸å»ºè®®</h4><p>æœ¯è¯­è¯´æ˜ï¼šæ°´å¹³å¯¹é½æŒ‡çš„æ˜¯é€šè¿‡å¢åŠ å¯å˜æ•°é‡çš„ç©ºæ ¼æ¥ä½¿æŸä¸€è¡Œçš„å­—ç¬¦ä¸ä¸Šä¸€è¡Œçš„ç›¸åº”å­—ç¬¦å¯¹é½ã€‚</p>
<p>è¿™æ˜¯å…è®¸çš„(è€Œä¸”åœ¨ä¸å°‘åœ°æ–¹å¯ä»¥çœ‹åˆ°è¿™æ ·çš„ä»£ç )ï¼Œä½†Googleç¼–ç¨‹é£æ ¼å¯¹æ­¤ä¸åšè¦æ±‚ã€‚å³ä½¿å¯¹äºå·²ç»ä½¿ç”¨æ°´å¹³å¯¹é½çš„ä»£ç ï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦å»ä¿æŒè¿™ç§é£æ ¼ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹å…ˆå±•ç¤ºæœªå¯¹é½çš„ä»£ç ï¼Œç„¶åæ˜¯å¯¹é½çš„ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">private int x; // this is fine</div><div class="line">private Color color; // this too</div><div class="line"></div><div class="line">private int   x;      // ä¸å»ºè®®</div><div class="line">private Color color;  // ä¸å»ºè®®</div></pre></td></tr></table></figure>
<blockquote>
<p>Tipï¼šå¯¹é½å¯å¢åŠ ä»£ç å¯è¯»æ€§ï¼Œä½†å®ƒä¸ºæ—¥åçš„ç»´æŠ¤å¸¦æ¥é—®é¢˜ã€‚è€ƒè™‘æœªæ¥æŸä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€å †å¯¹é½çš„ä»£ç ä¸­çš„ä¸€è¡Œã€‚ è¿™å¯èƒ½å¯¼è‡´åŸæœ¬å¾ˆæ¼‚äº®çš„å¯¹é½ä»£ç å˜å¾—é”™ä½ã€‚å¾ˆå¯èƒ½å®ƒä¼šæç¤ºä½ è°ƒæ•´å‘¨å›´ä»£ç çš„ç©ºç™½æ¥ä½¿è¿™ä¸€å †ä»£ç é‡æ–°æ°´å¹³å¯¹é½(æ¯”å¦‚ç¨‹åºå‘˜æƒ³ä¿æŒè¿™ç§æ°´å¹³å¯¹é½çš„é£æ ¼)ï¼Œ è¿™å°±ä¼šè®©ä½ åšè®¸å¤šçš„æ— ç”¨åŠŸï¼Œå¢åŠ äº†reviewerçš„å·¥ä½œå¹¶ä¸”å¯èƒ½å¯¼è‡´æ›´å¤šçš„åˆå¹¶å†²çªã€‚</p>
</blockquote>
<h3 id="4-7-ç”¨å°æ‹¬å·æ¥é™å®šç»„ï¼šæ¨è"><a href="#4-7-ç”¨å°æ‹¬å·æ¥é™å®šç»„ï¼šæ¨è" class="headerlink" title="4.7 ç”¨å°æ‹¬å·æ¥é™å®šç»„ï¼šæ¨è"></a>4.7 ç”¨å°æ‹¬å·æ¥é™å®šç»„ï¼šæ¨è</h3><p>é™¤éä½œè€…å’Œrevieweréƒ½è®¤ä¸ºå»æ‰å°æ‹¬å·ä¹Ÿä¸ä¼šä½¿ä»£ç è¢«è¯¯è§£ï¼Œæˆ–æ˜¯å»æ‰å°æ‹¬å·èƒ½è®©ä»£ç æ›´æ˜“äºé˜…è¯»ï¼Œå¦åˆ™æˆ‘ä»¬ä¸åº”è¯¥å»æ‰å°æ‹¬å·ã€‚ æˆ‘ä»¬æ²¡æœ‰ç†ç”±å‡è®¾è¯»è€…èƒ½è®°ä½æ•´ä¸ªJavaè¿ç®—ç¬¦ä¼˜å…ˆçº§è¡¨ã€‚</p>
<h3 id="4-8-å…·ä½“ç»“æ„"><a href="#4-8-å…·ä½“ç»“æ„" class="headerlink" title="4.8 å…·ä½“ç»“æ„"></a>4.8 å…·ä½“ç»“æ„</h3><h4 id="4-8-1-æšä¸¾ç±»"><a href="#4-8-1-æšä¸¾ç±»" class="headerlink" title="4.8.1 æšä¸¾ç±»"></a>4.8.1 æšä¸¾ç±»</h4><p>æšä¸¾å¸¸é‡é—´ç”¨é€—å·éš”å¼€ï¼Œæ¢è¡Œå¯é€‰ã€‚</p>
<p>æ²¡æœ‰æ–¹æ³•å’Œæ–‡æ¡£çš„æšä¸¾ç±»å¯å†™æˆæ•°ç»„åˆå§‹åŒ–çš„æ ¼å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">private enum Suit &#123; CLUBS, HEARTS, SPADES, DIAMONDS &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>ç”±äºæšä¸¾ç±»ä¹Ÿæ˜¯ä¸€ä¸ªç±»ï¼Œå› æ­¤æ‰€æœ‰é€‚ç”¨äºå…¶å®ƒç±»çš„æ ¼å¼è§„åˆ™ä¹Ÿé€‚ç”¨äºæšä¸¾ç±»ã€‚</p>
</blockquote>
<h4 id="4-8-2-å˜é‡å£°æ˜"><a href="#4-8-2-å˜é‡å£°æ˜" class="headerlink" title="4.8.2 å˜é‡å£°æ˜"></a>4.8.2 å˜é‡å£°æ˜</h4><h5 id="4-8-2-1-æ¯æ¬¡åªå£°æ˜ä¸€ä¸ªå˜é‡"><a href="#4-8-2-1-æ¯æ¬¡åªå£°æ˜ä¸€ä¸ªå˜é‡" class="headerlink" title="4.8.2.1 æ¯æ¬¡åªå£°æ˜ä¸€ä¸ªå˜é‡"></a>4.8.2.1 æ¯æ¬¡åªå£°æ˜ä¸€ä¸ªå˜é‡</h5><p>ä¸è¦ä½¿ç”¨ç»„åˆå£°æ˜ï¼Œæ¯”å¦‚<code>int a, b;</code>ã€‚</p>
<h5 id="4-8-2-2-éœ€è¦æ—¶æ‰å£°æ˜ï¼Œå¹¶å°½å¿«è¿›è¡Œåˆå§‹åŒ–"><a href="#4-8-2-2-éœ€è¦æ—¶æ‰å£°æ˜ï¼Œå¹¶å°½å¿«è¿›è¡Œåˆå§‹åŒ–" class="headerlink" title="4.8.2.2 éœ€è¦æ—¶æ‰å£°æ˜ï¼Œå¹¶å°½å¿«è¿›è¡Œåˆå§‹åŒ–"></a>4.8.2.2 éœ€è¦æ—¶æ‰å£°æ˜ï¼Œå¹¶å°½å¿«è¿›è¡Œåˆå§‹åŒ–</h5><p>ä¸è¦åœ¨ä¸€ä¸ªä»£ç å—çš„å¼€å¤´æŠŠå±€éƒ¨å˜é‡ä¸€æ¬¡æ€§éƒ½å£°æ˜äº†(è¿™æ˜¯cè¯­è¨€çš„åšæ³•)ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡éœ€è¦ä½¿ç”¨å®ƒæ—¶æ‰å£°æ˜ã€‚ å±€éƒ¨å˜é‡åœ¨å£°æ˜æ—¶æœ€å¥½å°±è¿›è¡Œåˆå§‹åŒ–ï¼Œæˆ–è€…å£°æ˜åå°½å¿«è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<h4 id="4-8-3-æ•°ç»„"><a href="#4-8-3-æ•°ç»„" class="headerlink" title="4.8.3 æ•°ç»„"></a>4.8.3 æ•°ç»„</h4><h5 id="4-8-3-1-æ•°ç»„åˆå§‹åŒ–ï¼šå¯å†™æˆå—çŠ¶ç»“æ„"><a href="#4-8-3-1-æ•°ç»„åˆå§‹åŒ–ï¼šå¯å†™æˆå—çŠ¶ç»“æ„" class="headerlink" title="4.8.3.1 æ•°ç»„åˆå§‹åŒ–ï¼šå¯å†™æˆå—çŠ¶ç»“æ„"></a>4.8.3.1 æ•°ç»„åˆå§‹åŒ–ï¼šå¯å†™æˆå—çŠ¶ç»“æ„</h5><p>æ•°ç»„åˆå§‹åŒ–å¯ä»¥å†™æˆå—çŠ¶ç»“æ„ï¼Œæ¯”å¦‚ï¼Œä¸‹é¢çš„å†™æ³•éƒ½æ˜¯OKçš„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">new int[] &#123;</div><div class="line">  0, 1, 2, 3 </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">new int[] &#123;</div><div class="line">  0,</div><div class="line">  1,</div><div class="line">  2,</div><div class="line">  3</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">new int[] &#123;</div><div class="line">  0, 1,</div><div class="line">  2, 3</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">new int[]</div><div class="line">    &#123;0, 1, 2, 3&#125;</div></pre></td></tr></table></figure>
<h5 id="4-8-3-2-éCé£æ ¼çš„æ•°ç»„å£°æ˜"><a href="#4-8-3-2-éCé£æ ¼çš„æ•°ç»„å£°æ˜" class="headerlink" title="4.8.3.2 éCé£æ ¼çš„æ•°ç»„å£°æ˜"></a>4.8.3.2 éCé£æ ¼çš„æ•°ç»„å£°æ˜</h5><p>ä¸­æ‹¬å·æ˜¯ç±»å‹çš„ä¸€éƒ¨åˆ†ï¼šString[] argsï¼Œ è€ŒéString args[]ã€‚</p>
<h4 id="4-8-4-switchè¯­å¥"><a href="#4-8-4-switchè¯­å¥" class="headerlink" title="4.8.4 switchè¯­å¥"></a>4.8.4 switchè¯­å¥</h4><p>æœ¯è¯­è¯´æ˜ï¼šswitchå—çš„å¤§æ‹¬å·å†…æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªè¯­å¥ç»„ã€‚æ¯ä¸ªè¯­å¥ç»„åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªswitchæ ‡ç­¾(case FOO:æˆ–default:)ï¼Œåé¢è·Ÿç€ä¸€æ¡æˆ–å¤šæ¡è¯­å¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">switch (input) &#123;</div><div class="line">  case 1:</div><div class="line">  case 2:</div><div class="line">    handleOneTwoOr();</div><div class="line">    break;</div><div class="line">  case 3:</div><div class="line">    handleThree();</div><div class="line">    break;</div><div class="line">  default:</div><div class="line">    handleLargeNumber(input);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="4-8-4-1-ç¼©è¿›"><a href="#4-8-4-1-ç¼©è¿›" class="headerlink" title="4.8.4.1 ç¼©è¿›"></a>4.8.4.1 ç¼©è¿›</h5><p>ä¸å…¶å®ƒå—çŠ¶ç»“æ„ä¸€è‡´ï¼Œswitchå—ä¸­çš„å†…å®¹ç¼©è¿›ä¸º2ä¸ªç©ºæ ¼ã€‚</p>
<p>æ¯ä¸ªswitchæ ‡ç­¾åæ–°èµ·ä¸€è¡Œï¼Œå†ç¼©è¿›2ä¸ªç©ºæ ¼ï¼Œå†™ä¸‹ä¸€æ¡æˆ–å¤šæ¡è¯­å¥ã€‚</p>
<h5 id="4-8-4-2-defaultçš„æƒ…å†µè¦å†™å‡ºæ¥"><a href="#4-8-4-2-defaultçš„æƒ…å†µè¦å†™å‡ºæ¥" class="headerlink" title="4.8.4.2 defaultçš„æƒ…å†µè¦å†™å‡ºæ¥"></a>4.8.4.2 defaultçš„æƒ…å†µè¦å†™å‡ºæ¥</h5><p>æ¯ä¸ªswitchè¯­å¥éƒ½åŒ…å«ä¸€ä¸ªdefaultè¯­å¥ç»„ï¼Œå³ä½¿å®ƒä»€ä¹ˆä»£ç ä¹Ÿä¸åŒ…å«ã€‚</p>
<h4 id="4-8-5-æ³¨è§£-Annotations"><a href="#4-8-5-æ³¨è§£-Annotations" class="headerlink" title="4.8.5 æ³¨è§£(Annotations)"></a>4.8.5 æ³¨è§£(Annotations)</h4><p>æ³¨è§£ç´§è·Ÿåœ¨æ–‡æ¡£å—åé¢ï¼Œåº”ç”¨äºç±»ã€æ–¹æ³•å’Œæ„é€ å‡½æ•°ï¼Œä¸€ä¸ªæ³¨è§£ç‹¬å ä¸€è¡Œã€‚è¿™äº›æ¢è¡Œä¸å±äºè‡ªåŠ¨æ¢è¡Œ(ç¬¬4.5èŠ‚ï¼Œè‡ªåŠ¨æ¢è¡Œ)ï¼Œå› æ­¤ç¼©è¿›çº§åˆ«ä¸å˜ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">@Nullable</div><div class="line">public String getNameIfPresent() &#123; ... &#125;</div></pre></td></tr></table></figure>
<p>åº”ç”¨äºå­—æ®µçš„å¤šä¸ªæ³¨è§£ä¸å…è®¸ä¸å­—æ®µå‡ºç°åœ¨åŒä¸€è¡Œï¼Œå¹¶ä¸”ä¸€ä¸ªæ³¨è§£ç‹¬å ä¸€è¡Œã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@Partial </div><div class="line">@Mock </div><div class="line">DataLoader loader;</div></pre></td></tr></table></figure>
<p>å‚æ•°å’Œå±€éƒ¨å˜é‡æ³¨è§£æ²¡æœ‰ç‰¹å®šè§„åˆ™ã€‚</p>
<p>ä¾‹å¤–ï¼šåº”ç”¨äºæ–¹æ³•å‚æ•°çš„æ³¨è§£<code>ä¸ç”¨æ¢è¡Œ</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public String getNameIfPresent(@RequestParam String param) &#123; ... &#125;</div></pre></td></tr></table></figure>
<h4 id="4-8-6-æ³¨é‡Š"><a href="#4-8-6-æ³¨é‡Š" class="headerlink" title="4.8.6 æ³¨é‡Š"></a>4.8.6 æ³¨é‡Š</h4><h5 id="4-8-6-1-å—æ³¨é‡Šé£æ ¼"><a href="#4-8-6-1-å—æ³¨é‡Šé£æ ¼" class="headerlink" title="4.8.6.1 å—æ³¨é‡Šé£æ ¼"></a>4.8.6.1 å—æ³¨é‡Šé£æ ¼</h5><p>å—æ³¨é‡Šä¸å…¶å‘¨å›´çš„ä»£ç åœ¨åŒä¸€ç¼©è¿›çº§åˆ«ã€‚å®ƒä»¬å¯ä»¥æ˜¯/<em> â€¦ </em>/é£æ ¼ï¼Œä¹Ÿå¯ä»¥æ˜¯// â€¦é£æ ¼ã€‚å¯¹äºå¤šè¡Œçš„/<em> â€¦ </em>/æ³¨é‡Šï¼Œåç»­è¡Œå¿…é¡»ä»<em>å¼€å§‹ï¼Œ å¹¶ä¸”ä¸å‰ä¸€è¡Œçš„</em>å¯¹é½ã€‚ä»¥ä¸‹ç¤ºä¾‹æ³¨é‡Šéƒ½æ˜¯OKçš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * This is          // And so           /**  </div><div class="line"> * okay.            // is this.          * Or you can even do this.</div><div class="line"> */                                      */</div><div class="line">æ³¨é‡Šä¸è¦å°é—­åœ¨ç”±æ˜Ÿå·æˆ–å…¶å®ƒå­—ç¬¦ç»˜åˆ¶çš„æ¡†æ¶é‡Œã€‚</div></pre></td></tr></table></figure>
<blockquote>
<p>Tipï¼šåœ¨å†™å¤šè¡Œæ³¨é‡Šæ—¶ï¼Œå¦‚æœä½ å¸Œæœ›åœ¨å¿…è¦æ—¶èƒ½é‡æ–°æ¢è¡Œ(å³æ³¨é‡Šåƒæ®µè½é£æ ¼ä¸€æ ·)ï¼Œé‚£ä¹ˆä½¿ç”¨/<em> â€¦ </em>/ã€‚</p>
</blockquote>
<h5 id="4-8-6-2-è¢«æ³¨é‡Šçš„ä»£ç "><a href="#4-8-6-2-è¢«æ³¨é‡Šçš„ä»£ç " class="headerlink" title="4.8.6.2 è¢«æ³¨é‡Šçš„ä»£ç "></a>4.8.6.2 è¢«æ³¨é‡Šçš„ä»£ç </h5><p>æœ‰æ—¶å¯èƒ½å‡ºäºæŸç§åŸå› æŸæ®µä»£ç è¢«æ³¨é‡Šï¼Œé‚£ä¹ˆåœ¨ä¹‹åçš„10ä¸ªcommitå†…ï¼Œå»ºè®®ç§»é™¤ã€‚</p>
<h4 id="4-8-7-Modifiers"><a href="#4-8-7-Modifiers" class="headerlink" title="4.8.7 Modifiers"></a>4.8.7 Modifiers</h4><p>ç±»å’Œæˆå‘˜çš„modifierså¦‚æœå­˜åœ¨ï¼Œåˆ™æŒ‰Javaè¯­è¨€è§„èŒƒä¸­æ¨èçš„é¡ºåºå‡ºç°ã€‚</p>
<ul>
<li>public </li>
<li>protected </li>
<li>private </li>
<li>abstract </li>
<li>static </li>
<li>final </li>
<li>transient </li>
<li>volatile </li>
<li>synchronized </li>
<li>native </li>
<li>strictfp</li>
</ul>
<h2 id="å‘½åçº¦å®š"><a href="#å‘½åçº¦å®š" class="headerlink" title="å‘½åçº¦å®š"></a>å‘½åçº¦å®š</h2><h3 id="5-1-å¯¹æ‰€æœ‰æ ‡è¯†ç¬¦éƒ½é€šç”¨çš„è§„åˆ™"><a href="#5-1-å¯¹æ‰€æœ‰æ ‡è¯†ç¬¦éƒ½é€šç”¨çš„è§„åˆ™" class="headerlink" title="5.1 å¯¹æ‰€æœ‰æ ‡è¯†ç¬¦éƒ½é€šç”¨çš„è§„åˆ™"></a>5.1 å¯¹æ‰€æœ‰æ ‡è¯†ç¬¦éƒ½é€šç”¨çš„è§„åˆ™</h3><p>æ ‡è¯†ç¬¦åªèƒ½ä½¿ç”¨ASCIIå­—æ¯å’Œæ•°å­—ï¼Œå› æ­¤æ¯ä¸ªæœ‰æ•ˆçš„æ ‡è¯†ç¬¦åç§°éƒ½èƒ½åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼\w+ã€‚</p>
<p>åœ¨Googleå…¶å®ƒç¼–ç¨‹è¯­è¨€é£æ ¼ä¸­ä½¿ç”¨çš„ç‰¹æ®Šå‰ç¼€æˆ–åç¼€ï¼Œå¦‚name_, mName, s_nameå’ŒkNameï¼Œåœ¨Javaç¼–ç¨‹é£æ ¼ä¸­éƒ½ä¸å†ä½¿ç”¨ã€‚</p>
<h3 id="5-2-æ ‡è¯†ç¬¦ç±»å‹çš„è§„åˆ™"><a href="#5-2-æ ‡è¯†ç¬¦ç±»å‹çš„è§„åˆ™" class="headerlink" title="5.2 æ ‡è¯†ç¬¦ç±»å‹çš„è§„åˆ™"></a>5.2 æ ‡è¯†ç¬¦ç±»å‹çš„è§„åˆ™</h3><h4 id="5-2-1-åŒ…å"><a href="#5-2-1-åŒ…å" class="headerlink" title="5.2.1 åŒ…å"></a>5.2.1 åŒ…å</h4><p>åŒ…åå…¨éƒ¨å°å†™ï¼Œè¿ç»­çš„å•è¯åªæ˜¯ç®€å•åœ°è¿æ¥èµ·æ¥ï¼Œä¸ä½¿ç”¨ä¸‹åˆ’çº¿ã€‚</p>
<h4 id="5-2-2-ç±»å"><a href="#5-2-2-ç±»å" class="headerlink" title="5.2.2 ç±»å"></a>5.2.2 ç±»å</h4><p>ç±»åéƒ½ä»¥UpperCamelCaseé£æ ¼ç¼–å†™ã€‚</p>
<p>ç±»åé€šå¸¸æ˜¯åè¯æˆ–åè¯çŸ­è¯­ï¼Œæ¥å£åç§°æœ‰æ—¶å¯èƒ½æ˜¯å½¢å®¹è¯æˆ–å½¢å®¹è¯çŸ­è¯­ã€‚ç°åœ¨è¿˜æ²¡æœ‰ç‰¹å®šçš„è§„åˆ™æˆ–è¡Œä¹‹æœ‰æ•ˆçš„çº¦å®šæ¥å‘½åæ³¨è§£ç±»å‹ã€‚</p>
<p>æµ‹è¯•ç±»çš„å‘½åä»¥å®ƒè¦æµ‹è¯•çš„ç±»çš„åç§°å¼€å§‹ï¼Œä»¥Testç»“æŸã€‚ä¾‹å¦‚ï¼ŒHashTestæˆ–HashIntegrationTestã€‚</p>
<h4 id="5-2-3-æ–¹æ³•å"><a href="#5-2-3-æ–¹æ³•å" class="headerlink" title="5.2.3 æ–¹æ³•å"></a>5.2.3 æ–¹æ³•å</h4><p>æ–¹æ³•åéƒ½ä»¥lowerCamelCaseé£æ ¼ç¼–å†™ã€‚</p>
<p>æ–¹æ³•åé€šå¸¸æ˜¯åŠ¨è¯æˆ–åŠ¨è¯çŸ­è¯­ã€‚</p>
<h4 id="5-2-4-å¸¸é‡å"><a href="#5-2-4-å¸¸é‡å" class="headerlink" title="5.2.4 å¸¸é‡å"></a>5.2.4 å¸¸é‡å</h4><p>å¸¸é‡åå‘½åæ¨¡å¼ä¸ºCONSTANT_CASEï¼Œå…¨éƒ¨å­—æ¯å¤§å†™ï¼Œç”¨ä¸‹åˆ’çº¿åˆ†éš”å•è¯ã€‚é‚£ï¼Œåˆ°åº•ä»€ä¹ˆç®—æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Ÿ</p>
<p>æ¯ä¸ªå¸¸é‡éƒ½æ˜¯ä¸€ä¸ªé™æ€finalå­—æ®µï¼Œä½†ä¸æ˜¯æ‰€æœ‰é™æ€finalå­—æ®µéƒ½æ˜¯å¸¸é‡ã€‚åœ¨å†³å®šä¸€ä¸ªå­—æ®µæ˜¯å¦æ˜¯ä¸€ä¸ªå¸¸é‡æ—¶ï¼Œ è€ƒè™‘å®ƒæ˜¯å¦çœŸçš„æ„Ÿè§‰åƒæ˜¯ä¸€ä¸ªå¸¸é‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä»»ä½•ä¸€ä¸ªè¯¥å®ä¾‹çš„è§‚æµ‹çŠ¶æ€æ˜¯å¯å˜çš„ï¼Œåˆ™å®ƒå‡ ä¹è‚¯å®šä¸ä¼šæ˜¯ä¸€ä¸ªå¸¸é‡ã€‚ åªæ˜¯æ°¸è¿œä¸æ‰“ç®—æ”¹å˜å¯¹è±¡ä¸€èˆ¬æ˜¯ä¸å¤Ÿçš„ï¼Œå®ƒè¦çœŸçš„ä¸€ç›´ä¸å˜æ‰èƒ½å°†å®ƒç¤ºä¸ºå¸¸é‡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">// Constants</div><div class="line">static final int NUMBER = 5;</div><div class="line">static final ImmutableList&lt;String&gt; NAMES = ImmutableList.of(&quot;Ed&quot;, &quot;Ann&quot;);</div><div class="line">static final Joiner COMMA_JOINER = Joiner.on(&apos;,&apos;);  // because Joiner is immutable</div><div class="line">static final SomeMutableType[] EMPTY_ARRAY = &#123;&#125;;</div><div class="line">enum SomeEnum &#123; ENUM_CONSTANT &#125;</div><div class="line"></div><div class="line">// Not constants</div><div class="line">static String nonFinal = &quot;non-final&quot;;</div><div class="line">final String nonStatic = &quot;non-static&quot;;</div><div class="line">static final Set&lt;String&gt; mutableCollection = new HashSet&lt;String&gt;();</div><div class="line">static final ImmutableSet&lt;SomeMutableType&gt; mutableElements = ImmutableSet.of(mutable);</div><div class="line">static final Logger logger = Logger.getLogger(MyClass.getName());</div><div class="line">static final String[] nonEmptyArray = &#123;&quot;these&quot;, &quot;can&quot;, &quot;change&quot;&#125;;</div></pre></td></tr></table></figure>
<p>è¿™äº›åå­—é€šå¸¸æ˜¯åè¯æˆ–åè¯çŸ­è¯­ã€‚</p>
<h4 id="5-2-5-éå¸¸é‡å­—æ®µå"><a href="#5-2-5-éå¸¸é‡å­—æ®µå" class="headerlink" title="5.2.5 éå¸¸é‡å­—æ®µå"></a>5.2.5 éå¸¸é‡å­—æ®µå</h4><p>éå¸¸é‡å­—æ®µåä»¥lowerCamelCaseé£æ ¼ç¼–å†™ã€‚</p>
<p>è¿™äº›åå­—é€šå¸¸æ˜¯åè¯æˆ–åè¯çŸ­è¯­ã€‚</p>
<h4 id="5-2-6-å‚æ•°å"><a href="#5-2-6-å‚æ•°å" class="headerlink" title="5.2.6 å‚æ•°å"></a>5.2.6 å‚æ•°å</h4><p>å‚æ•°åä»¥lowerCamelCaseé£æ ¼ç¼–å†™ã€‚</p>
<p>å‚æ•°åº”è¯¥é¿å…ç”¨å•ä¸ªå­—ç¬¦å‘½åï¼Œå¹¶ä¸”è¦å°½é‡å®¹æ˜“ç†è§£ã€‚</p>
<h4 id="5-2-7-å±€éƒ¨å˜é‡å"><a href="#5-2-7-å±€éƒ¨å˜é‡å" class="headerlink" title="5.2.7 å±€éƒ¨å˜é‡å"></a>5.2.7 å±€éƒ¨å˜é‡å</h4><p>å±€éƒ¨å˜é‡åä»¥lowerCamelCaseé£æ ¼ç¼–å†™ï¼Œæ¯”èµ·å…¶å®ƒç±»å‹çš„åç§°ï¼Œå±€éƒ¨å˜é‡åå¯ä»¥æœ‰æ›´ä¸ºå®½æ¾çš„ç¼©å†™ã€‚</p>
<p>è™½ç„¶ç¼©å†™æ›´å®½æ¾ï¼Œä½†è¿˜æ˜¯è¦é¿å…ç”¨å•å­—ç¬¦è¿›è¡Œå‘½åï¼Œé™¤äº†ä¸´æ—¶å˜é‡å’Œå¾ªç¯å˜é‡ã€‚</p>
<p>å³ä½¿å±€éƒ¨å˜é‡æ˜¯finalå’Œä¸å¯æ”¹å˜çš„ï¼Œä¹Ÿä¸åº”è¯¥æŠŠå®ƒç¤ºä¸ºå¸¸é‡ï¼Œè‡ªç„¶ä¹Ÿä¸èƒ½ç”¨å¸¸é‡çš„è§„åˆ™å»å‘½åå®ƒã€‚</p>
<h4 id="5-2-8-ç±»å‹å˜é‡å"><a href="#5-2-8-ç±»å‹å˜é‡å" class="headerlink" title="5.2.8 ç±»å‹å˜é‡å"></a>5.2.8 ç±»å‹å˜é‡å</h4><p>ç±»å‹å˜é‡å¯ç”¨ä»¥ä¸‹ä¸¤ç§é£æ ¼ä¹‹ä¸€è¿›è¡Œå‘½åï¼š</p>
<p>å•ä¸ªæˆ–è€…å¤šä¸ªçš„å¤§å†™å­—æ¯ï¼Œåé¢å¯ä»¥è·Ÿä¸€ä¸ªæ•°å­—(å¦‚ï¼šE, T, X, IN, OUT)ã€‚</p>
<h3 id="5-3-é©¼å³°å¼å‘½åæ³•-CamelCase"><a href="#5-3-é©¼å³°å¼å‘½åæ³•-CamelCase" class="headerlink" title="5.3 é©¼å³°å¼å‘½åæ³•(CamelCase)"></a>5.3 é©¼å³°å¼å‘½åæ³•(CamelCase)</h3><p>é©¼å³°å¼å‘½åæ³•åˆ†å¤§é©¼å³°å¼å‘½åæ³•(UpperCamelCase)å’Œå°é©¼å³°å¼å‘½åæ³•(lowerCamelCase)ã€‚ æœ‰æ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸åªä¸€ç§åˆç†çš„æ–¹å¼å°†ä¸€ä¸ªè‹±è¯­è¯ç»„è½¬æ¢æˆé©¼å³°å½¢å¼ï¼Œå¦‚ç¼©ç•¥è¯­æˆ–ä¸å¯»å¸¸çš„ç»“æ„(ä¾‹å¦‚â€IPv6â€æˆ–â€iOSâ€)ã€‚GoogleæŒ‡å®šäº†ä»¥ä¸‹çš„è½¬æ¢æ–¹æ¡ˆã€‚</p>
<p>åå­—ä»æ•£æ–‡å½¢å¼(prose form)å¼€å§‹:</p>
<ul>
<li>æŠŠçŸ­è¯­è½¬æ¢ä¸ºçº¯ASCIIç ï¼Œå¹¶ä¸”ç§»é™¤ä»»ä½•å•å¼•å·ã€‚ä¾‹å¦‚ï¼šâ€MÃ¼llerâ€™s algorithmâ€å°†å˜æˆâ€Muellers algorithmâ€ã€‚</li>
<li>æŠŠè¿™ä¸ªç»“æœåˆ‡åˆ†æˆå•è¯ï¼Œåœ¨ç©ºæ ¼æˆ–å…¶å®ƒæ ‡ç‚¹ç¬¦å·(é€šå¸¸æ˜¯è¿å­—ç¬¦)å¤„åˆ†å‰²å¼€ã€‚<ul>
<li>æ¨èï¼šå¦‚æœæŸä¸ªå•è¯å·²ç»æœ‰äº†å¸¸ç”¨çš„é©¼å³°è¡¨ç¤ºå½¢å¼ï¼ŒæŒ‰å®ƒçš„ç»„æˆå°†å®ƒåˆ†å‰²å¼€(å¦‚â€AdWordsâ€å°†åˆ†å‰²æˆâ€ad wordsâ€)ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯â€iOSâ€å¹¶ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„é©¼å³°è¡¨ç¤ºå½¢å¼ï¼Œå› æ­¤è¯¥æ¨èå¯¹å®ƒå¹¶ä¸é€‚ç”¨ã€‚</li>
</ul>
</li>
<li>ç°åœ¨å°†æ‰€æœ‰å­—æ¯éƒ½å°å†™(åŒ…æ‹¬ç¼©å†™)ï¼Œç„¶åå°†å•è¯çš„ç¬¬ä¸€ä¸ªå­—æ¯å¤§å†™ï¼š<ul>
<li>æ¯ä¸ªå•è¯çš„ç¬¬ä¸€ä¸ªå­—æ¯éƒ½å¤§å†™ï¼Œæ¥å¾—åˆ°å¤§é©¼å³°å¼å‘½åã€‚</li>
<li>é™¤äº†ç¬¬ä¸€ä¸ªå•è¯ï¼Œæ¯ä¸ªå•è¯çš„ç¬¬ä¸€ä¸ªå­—æ¯éƒ½å¤§å†™ï¼Œæ¥å¾—åˆ°å°é©¼å³°å¼å‘½åã€‚</li>
</ul>
</li>
<li>æœ€åå°†æ‰€æœ‰çš„å•è¯è¿æ¥èµ·æ¥å¾—åˆ°ä¸€ä¸ªæ ‡è¯†ç¬¦ã€‚<br>ç¤ºä¾‹ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Prose form                Correct               Incorrect</div><div class="line">------------------------------------------------------------------</div><div class="line">&quot;XML HTTP request&quot;        XmlHttpRequest        XMLHTTPRequest</div><div class="line">&quot;new customer ID&quot;         newCustomerId         newCustomerID</div><div class="line">&quot;inner stopwatch&quot;         innerStopwatch        innerStopWatch</div><div class="line">&quot;supports IPv6 on iOS?&quot;   supportsIpv6OnIos     supportsIPv6OnIOS</div><div class="line">&quot;YouTube importer&quot;        YouTubeImporter</div><div class="line">                          YoutubeImporter*</div></pre></td></tr></table></figure>
<p>åŠ æ˜Ÿå·å¤„è¡¨ç¤ºå¯ä»¥ï¼Œä½†ä¸æ¨èã€‚</p>
<blockquote>
<p>Noteï¼šåœ¨è‹±è¯­ä¸­ï¼ŒæŸäº›å¸¦æœ‰è¿å­—ç¬¦çš„å•è¯å½¢å¼ä¸å”¯ä¸€ã€‚ä¾‹å¦‚ï¼šâ€nonemptyâ€å’Œâ€non-emptyâ€éƒ½æ˜¯æ­£ç¡®çš„ï¼Œå› æ­¤æ–¹æ³•åcheckNonemptyå’ŒcheckNonEmptyä¹Ÿéƒ½æ˜¯æ­£ç¡®çš„ã€‚</p>
</blockquote>
<h2 id="ç¼–ç¨‹å®è·µ"><a href="#ç¼–ç¨‹å®è·µ" class="headerlink" title="ç¼–ç¨‹å®è·µ"></a>ç¼–ç¨‹å®è·µ</h2><h3 id="6-1-Overrideï¼šèƒ½ç”¨åˆ™ç”¨"><a href="#6-1-Overrideï¼šèƒ½ç”¨åˆ™ç”¨" class="headerlink" title="6.1 @Overrideï¼šèƒ½ç”¨åˆ™ç”¨"></a>6.1 @Overrideï¼šèƒ½ç”¨åˆ™ç”¨</h3><p>åªè¦æ˜¯åˆæ³•çš„ï¼Œå°±æŠŠ@Overrideæ³¨è§£ç»™ç”¨ä¸Šã€‚</p>
<h3 id="6-2-æ•è·çš„å¼‚å¸¸ï¼šä¸èƒ½å¿½è§†"><a href="#6-2-æ•è·çš„å¼‚å¸¸ï¼šä¸èƒ½å¿½è§†" class="headerlink" title="6.2 æ•è·çš„å¼‚å¸¸ï¼šä¸èƒ½å¿½è§†"></a>6.2 æ•è·çš„å¼‚å¸¸ï¼šä¸èƒ½å¿½è§†</h3><p>é™¤äº†ä¸‹é¢çš„ä¾‹å­ï¼Œå¯¹æ•è·çš„å¼‚å¸¸ä¸åšå“åº”æ˜¯æå°‘æ­£ç¡®çš„ã€‚(å…¸å‹çš„å“åº”æ–¹å¼æ˜¯æ‰“å°æ—¥å¿—ï¼Œæˆ–è€…å¦‚æœå®ƒè¢«è®¤ä¸ºæ˜¯ä¸å¯èƒ½çš„ï¼Œåˆ™æŠŠå®ƒå½“ä½œä¸€ä¸ªAssertionErroré‡æ–°æŠ›å‡ºã€‚)</p>
<p>å¦‚æœå®ƒç¡®å®æ˜¯ä¸éœ€è¦åœ¨catchå—ä¸­åšä»»ä½•å“åº”ï¼Œéœ€è¦åšæ³¨é‡ŠåŠ ä»¥è¯´æ˜(å¦‚ä¸‹é¢çš„ä¾‹å­)ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">try &#123;</div><div class="line">  int i = Integer.parseInt(response);</div><div class="line">  return handleNumericResponse(i);</div><div class="line">&#125; catch (NumberFormatException ok) &#123;</div><div class="line">  // it&apos;s not numeric; that&apos;s fine, just continue</div><div class="line">&#125;</div><div class="line">return handleTextResponse(response);</div></pre></td></tr></table></figure>
<p>ä¾‹å¤–ï¼šåœ¨æµ‹è¯•ä¸­ï¼Œå¦‚æœä¸€ä¸ªæ•è·çš„å¼‚å¸¸è¢«å‘½åä¸ºexpectedï¼Œåˆ™å®ƒå¯ä»¥è¢«ä¸åŠ æ³¨é‡Šåœ°å¿½ç•¥ã€‚ä¸‹é¢æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„æƒ…å½¢ï¼Œç”¨ä»¥ç¡®ä¿æ‰€æµ‹è¯•çš„æ–¹æ³•ä¼šæŠ›å‡ºä¸€ä¸ªæœŸæœ›ä¸­çš„å¼‚å¸¸ï¼Œ å› æ­¤åœ¨è¿™é‡Œå°±æ²¡æœ‰å¿…è¦åŠ æ³¨é‡Šã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">try &#123;</div><div class="line">  emptyStack.pop();</div><div class="line">  fail();</div><div class="line">&#125; catch (NoSuchElementException expected) &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6-3-é™æ€æˆå‘˜ï¼šä½¿ç”¨ç±»è¿›è¡Œè°ƒç”¨"><a href="#6-3-é™æ€æˆå‘˜ï¼šä½¿ç”¨ç±»è¿›è¡Œè°ƒç”¨" class="headerlink" title="6.3 é™æ€æˆå‘˜ï¼šä½¿ç”¨ç±»è¿›è¡Œè°ƒç”¨"></a>6.3 é™æ€æˆå‘˜ï¼šä½¿ç”¨ç±»è¿›è¡Œè°ƒç”¨</h3><p>ä½¿ç”¨ç±»åè°ƒç”¨é™æ€çš„ç±»æˆå‘˜ï¼Œè€Œä¸æ˜¯å…·ä½“æŸä¸ªå¯¹è±¡æˆ–è¡¨è¾¾å¼ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Foo aFoo = ...;</div><div class="line">Foo.aStaticMethod(); // good</div><div class="line">aFoo.aStaticMethod(); // bad</div><div class="line">somethingThatYieldsAFoo().aStaticMethod(); // very bad</div></pre></td></tr></table></figure>
<h3 id="6-4-Finalizers-ç¦ç”¨"><a href="#6-4-Finalizers-ç¦ç”¨" class="headerlink" title="6.4 Finalizers: ç¦ç”¨"></a>6.4 Finalizers: ç¦ç”¨</h3><p>æå°‘ä¼šå»é‡è½½Object.finalizeã€‚</p>
<blockquote>
<p>Tipï¼šä¸è¦ä½¿ç”¨finalizeã€‚å¦‚æœä½ éè¦ä½¿ç”¨å®ƒï¼Œè¯·å…ˆä»”ç»†é˜…è¯»å’Œç†è§£Effective Java ç¬¬7æ¡æ¬¾ï¼šâ€œAvoid Finalizersâ€ï¼Œç„¶åä¸è¦ä½¿ç”¨å®ƒã€‚</p>
</blockquote>
<h2 id="Javadoc"><a href="#Javadoc" class="headerlink" title="Javadoc"></a>Javadoc</h2><h3 id="7-1-æ ¼å¼"><a href="#7-1-æ ¼å¼" class="headerlink" title="7.1 æ ¼å¼"></a>7.1 æ ¼å¼</h3><h4 id="7-1-1-ä¸€èˆ¬å½¢å¼"><a href="#7-1-1-ä¸€èˆ¬å½¢å¼" class="headerlink" title="7.1.1 ä¸€èˆ¬å½¢å¼"></a>7.1.1 ä¸€èˆ¬å½¢å¼</h4><p>Javadocå—çš„åŸºæœ¬æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Multiple lines of Javadoc text are written here,</div><div class="line"> * wrapped normally...</div><div class="line"> */</div><div class="line">public int method(String p1) &#123; ... &#125;</div></pre></td></tr></table></figure>
<p>æˆ–è€…æ˜¯ä»¥ä¸‹å•è¡Œå½¢å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/** An especially short bit of Javadoc. */</div></pre></td></tr></table></figure>
<p>åŸºæœ¬æ ¼å¼æ€»æ˜¯OKçš„ã€‚å½“æ•´ä¸ªJavadocå—èƒ½å®¹çº³äºä¸€è¡Œæ—¶(ä¸”æ²¡æœ‰Javadocæ ‡è®°@XXX)ï¼Œå¯ä»¥ä½¿ç”¨å•è¡Œå½¢å¼ã€‚</p>
<h4 id="7-1-2-æ®µè½"><a href="#7-1-2-æ®µè½" class="headerlink" title="7.1.2 æ®µè½"></a>7.1.2 æ®µè½</h4><p>ç©ºè¡Œ(å³ï¼ŒåªåŒ…å«æœ€å·¦ä¾§æ˜Ÿå·çš„è¡Œ)ä¼šå‡ºç°åœ¨æ®µè½ä¹‹é—´å’ŒJavadocæ ‡è®°(@XXX)ä¹‹å‰(å¦‚æœæœ‰çš„è¯)ã€‚ é™¤äº†ç¬¬ä¸€ä¸ªæ®µè½ï¼Œæ¯ä¸ªæ®µè½ç¬¬ä¸€ä¸ªå•è¯å‰éƒ½æœ‰æ ‡ç­¾</p><p>ï¼Œå¹¶ä¸”å®ƒå’Œç¬¬ä¸€ä¸ªå•è¯é—´æ²¡æœ‰ç©ºæ ¼ã€‚</p>
<h4 id="7-1-3-Javadocæ ‡è®°"><a href="#7-1-3-Javadocæ ‡è®°" class="headerlink" title="7.1.3 Javadocæ ‡è®°"></a>7.1.3 Javadocæ ‡è®°</h4><p>æ ‡å‡†çš„Javadocæ ‡è®°æŒ‰ä»¥ä¸‹é¡ºåºå‡ºç°ï¼š<code>@param</code>, <code>@return</code>, <code>@throws</code>, <code>@deprecated</code>, å‰é¢è¿™4ç§æ ‡è®°å¦‚æœå‡ºç°ï¼Œæè¿°éƒ½ä¸èƒ½ä¸ºç©ºã€‚ å½“æè¿°æ— æ³•åœ¨ä¸€è¡Œä¸­å®¹çº³ï¼Œè¿ç»­è¡Œéœ€è¦è‡³å°‘å†ç¼©è¿›4ä¸ªç©ºæ ¼ã€‚</p>
<h3 id="7-2-æ‘˜è¦ç‰‡æ®µ"><a href="#7-2-æ‘˜è¦ç‰‡æ®µ" class="headerlink" title="7.2 æ‘˜è¦ç‰‡æ®µ"></a>7.2 æ‘˜è¦ç‰‡æ®µ</h3><p>æ¯ä¸ªç±»æˆ–æˆå‘˜çš„Javadocä»¥ä¸€ä¸ªç®€çŸ­çš„æ‘˜è¦ç‰‡æ®µå¼€å§‹ã€‚è¿™ä¸ªç‰‡æ®µæ˜¯éå¸¸é‡è¦çš„ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯å”¯ä¸€å‡ºç°çš„æ–‡æœ¬ï¼Œæ¯”å¦‚åœ¨ç±»å’Œæ–¹æ³•ç´¢å¼•ä¸­ã€‚</p>
<p>è¿™åªæ˜¯ä¸€ä¸ªå°ç‰‡æ®µï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªåè¯çŸ­è¯­æˆ–åŠ¨è¯çŸ­è¯­ï¼Œä½†ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¥å­ã€‚å®ƒä¸ä¼šä»¥<code>A {@code Foo} is a...</code>æˆ–<code>This method returns...</code>å¼€å¤´, å®ƒä¹Ÿä¸ä¼šæ˜¯ä¸€ä¸ªå®Œæ•´çš„ç¥ˆä½¿å¥ï¼Œå¦‚<code>Save the record...</code>ã€‚ç„¶è€Œï¼Œç”±äºå¼€å¤´å¤§å†™åŠè¢«åŠ äº†æ ‡ç‚¹ï¼Œå®ƒçœ‹èµ·æ¥å°±åƒæ˜¯ä¸ªå®Œæ•´çš„å¥å­ã€‚</p>
<blockquote>
<p>Tipï¼šä¸€ä¸ªå¸¸è§çš„é”™è¯¯æ˜¯æŠŠç®€å•çš„Javadocå†™æˆ<code>/** @return the customer ID */</code>ï¼Œè¿™æ˜¯ä¸æ­£ç¡®çš„ã€‚<br>å®ƒåº”è¯¥å†™æˆ<code>/** Returns the customer ID. */</code>ã€‚</p>
</blockquote>
<h3 id="7-3-å“ªé‡Œéœ€è¦ä½¿ç”¨Javadoc"><a href="#7-3-å“ªé‡Œéœ€è¦ä½¿ç”¨Javadoc" class="headerlink" title="7.3 å“ªé‡Œéœ€è¦ä½¿ç”¨Javadoc"></a>7.3 å“ªé‡Œéœ€è¦ä½¿ç”¨Javadoc</h3><p>è‡³å°‘åœ¨æ¯ä¸ªpublicçš„<code>class</code>åŠå®ƒçš„æ¯ä¸ªpublicå’Œprotectedæˆå‘˜å¤„ä½¿ç”¨Javadocï¼Œä»¥ä¸‹æ˜¯ä¸€äº›ä¾‹å¤–ï¼š</p>
<h4 id="7-3-1-ä¾‹å¤–ï¼šä¸è¨€è‡ªæ˜çš„æ–¹æ³•"><a href="#7-3-1-ä¾‹å¤–ï¼šä¸è¨€è‡ªæ˜çš„æ–¹æ³•" class="headerlink" title="7.3.1 ä¾‹å¤–ï¼šä¸è¨€è‡ªæ˜çš„æ–¹æ³•"></a>7.3.1 ä¾‹å¤–ï¼šä¸è¨€è‡ªæ˜çš„æ–¹æ³•</h4><p>å¯¹äºç®€å•æ˜æ˜¾çš„æ–¹æ³•å¦‚<code>getFoo</code>ï¼ŒJavadocæ˜¯å¯é€‰çš„(å³ï¼Œæ˜¯å¯ä»¥ä¸å†™çš„)ã€‚è¿™ç§æƒ…å†µä¸‹é™¤äº†å†™â€œReturns the fooâ€ï¼Œç¡®å®ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå€¼å¾—å†™äº†ã€‚</p>
<blockquote>
<p>Tipï¼šå¦‚æœæœ‰ä¸€äº›ç›¸å…³ä¿¡æ¯æ˜¯éœ€è¦è¯»è€…äº†è§£çš„ï¼Œé‚£ä¹ˆä»¥ä¸Šçš„ä¾‹å¤–ä¸åº”ä½œä¸ºå¿½è§†è¿™äº›ä¿¡æ¯çš„ç†ç”±ã€‚ä¾‹å¦‚ï¼Œå¯¹äºæ–¹æ³•å<code>getCanonicalName</code>ï¼Œ å°±ä¸åº”è¯¥å¿½è§†æ–‡æ¡£è¯´æ˜ï¼Œå› ä¸ºè¯»è€…å¾ˆå¯èƒ½ä¸çŸ¥é“è¯è¯­canonical nameæŒ‡çš„æ˜¯ä»€ä¹ˆã€‚</p>
</blockquote>
<h4 id="7-3-2-ä¾‹å¤–ï¼šé‡è½½"><a href="#7-3-2-ä¾‹å¤–ï¼šé‡è½½" class="headerlink" title="7.3.2 ä¾‹å¤–ï¼šé‡è½½"></a>7.3.2 ä¾‹å¤–ï¼šé‡è½½</h4><p>å¦‚æœä¸€ä¸ªæ–¹æ³•é‡è½½äº†è¶…ç±»ä¸­çš„æ–¹æ³•ï¼Œé‚£ä¹ˆJavadocå¹¶éå¿…éœ€çš„ã€‚</p>
<h4 id="7-3-3-å¯é€‰çš„Javadoc"><a href="#7-3-3-å¯é€‰çš„Javadoc" class="headerlink" title="7.3.3 å¯é€‰çš„Javadoc"></a>7.3.3 å¯é€‰çš„Javadoc</h4><p>å¯¹äºåŒ…å¤–ä¸å¯è§çš„ç±»å’Œæ–¹æ³•ï¼Œå¦‚æœ‰éœ€è¦ï¼Œä¹Ÿæ˜¯è¦ä½¿ç”¨Javadocçš„ã€‚å¦‚æœä¸€ä¸ªæ³¨é‡Šæ˜¯ç”¨æ¥å®šä¹‰ä¸€ä¸ªç±»ï¼Œæ–¹æ³•ï¼Œå­—æ®µçš„æ•´ä½“ç›®çš„æˆ–è¡Œä¸ºï¼Œ é‚£ä¹ˆè¿™ä¸ªæ³¨é‡Šåº”è¯¥å†™æˆJavadocï¼Œè¿™æ ·æ›´ç»Ÿä¸€æ›´å‹å¥½ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hello World]]></title>
      <url>http://zsr.github.io/2016/07/26/hello-world/</url>
      <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
    </entry>
    
  
  
</search>
